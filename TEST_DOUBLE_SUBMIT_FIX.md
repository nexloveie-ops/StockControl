# 测试双重提交修复

## 修复内容
已将订单提交按钮从内联 `onclick` 改为使用 `addEventListener`，这样可以更好地防止重复提交。

## 需要重启服务器
修改了 `merchant.html` 文件，需要重启服务器以加载新代码。

## 测试步骤

### 准备工作
1. **重启服务器**
   ```bash
   # 如果服务器正在运行，先停止
   # 然后重新启动
   node app.js
   ```

2. **清理旧订单**（可选）
   - 可以先取消或删除之前的重复订单
   - 或者使用新的测试产品

### 测试场景1：正常提交
1. 登录批发商账号
2. 进入"从仓库订货"标签
3. 选择产品：iPhone Clear Case (iPhone 12 Pro Max)
4. 添加2个到购物车
5. 点击"提交订单"
6. 填写配送信息
7. **正常点击**"确认提交"按钮（点击1次）
8. **验证**：
   - ✅ 生成1个订单
   - ✅ 库存从3变为1
   - ✅ 显示成功提示

### 测试场景2：快速连击（重点测试）
1. 再次添加2个产品到购物车
2. 点击"提交订单"
3. 填写配送信息
4. **快速连续点击**"确认提交"按钮（尽可能快地点击5-10次）
5. **观察**：
   - ✅ 按钮立即变为"提交中..."
   - ✅ 按钮变灰且不可点击
   - ✅ 只发送1个请求到服务器
6. **验证**：
   - ✅ 只生成1个订单（不是2个或更多）
   - ✅ 库存正确扣减
   - ✅ 没有重复订单

### 测试场景3：网络延迟模拟
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 设置网络限速（Throttling）为 "Slow 3G"
4. 添加产品到购物车并提交
5. 在网络请求完成前快速点击多次
6. **验证**：
   - ✅ 只生成1个订单
   - ✅ 按钮在整个请求期间保持禁用状态

## 预期结果

### 成功标志
- ✅ 无论点击多少次，只生成1个订单
- ✅ 按钮在提交期间显示"提交中..."
- ✅ 按钮在提交期间不可点击（灰色）
- ✅ 库存数量正确
- ✅ 控制台没有错误信息

### 失败标志
- ❌ 生成了2个或更多相同订单
- ❌ 按钮可以在提交期间继续点击
- ❌ 库存扣减不正确
- ❌ 控制台显示"订单正在提交中"的警告（说明防护被触发）

## 如果仍然出现重复订单

### 检查清单
1. **确认服务器已重启**
   - 检查服务器进程ID是否改变
   - 查看服务器启动时间

2. **确认浏览器已刷新**
   - 按 F5 刷新页面
   - 或者按 Ctrl+Shift+R 强制刷新（清除缓存）

3. **检查浏览器控制台**
   - 打开开发者工具（F12）
   - 查看 Console 标签
   - 看是否有"订单正在提交中"的日志
   - 查看 Network 标签，确认只发送了1个请求

4. **检查代码是否正确加载**
   - 在浏览器中按 Ctrl+U 查看页面源代码
   - 搜索 `confirmOrderSubmitBtn`
   - 确认按钮有 id 属性而不是 onclick 属性

## 调试信息

如果问题仍然存在，请提供以下信息：
1. 浏览器控制台的完整日志
2. Network 标签中的请求列表（特别是 /api/warehouse/orders 的请求）
3. 生成的订单号
4. 订单创建时间（是否在同一秒内）

## 技术细节

### 修改前
```html
<button onclick="confirmWarehouseOrderSubmit()">确认提交</button>
```

### 修改后
```html
<button id="confirmOrderSubmitBtn">确认提交</button>
```

```javascript
// 在页面初始化时绑定
const confirmBtn = document.getElementById('confirmOrderSubmitBtn');
if (confirmBtn) {
  confirmBtn.addEventListener('click', confirmWarehouseOrderSubmit);
}
```

### 为什么这样更好
1. `addEventListener` 由浏览器原生管理，更可靠
2. 避免了内联事件可能的重复触发问题
3. 更好的代码分离和维护性
4. 可以更容易地添加额外的事件选项（如 `once: true`）
