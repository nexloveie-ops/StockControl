# 供货商/客户管理和产品追溯功能实现

## 实现日期
2026-02-02

## 功能概述
将"库存操作"标签页改造为"供货商/客户管理"，实现供货商管理、客户管理和产品追溯三大功能模块。

## 已实现功能

### 1. 供货商管理 (📦 供货商管理)

#### 后端 API (app-new.js)
- ✅ `GET /api/admin/suppliers` - 获取所有供货商（支持搜索）
- ✅ `GET /api/admin/suppliers/:supplierId/invoices` - 获取供货商的所有采购发票
- ✅ `POST /api/admin/suppliers` - 添加新供货商
- ✅ `PUT /api/admin/suppliers/:id` - 更新供货商信息
- ✅ `DELETE /api/admin/suppliers/:id` - 删除供货商（软删除）

#### 前端功能 (prototype-working.html)
- ✅ 供货商列表展示（表格形式）
- ✅ 搜索供货商（按名称、代码、联系人、邮箱）
- ✅ 查看供货商的所有采购发票
- ✅ 删除供货商
- ⏳ 添加供货商（模态框待实现）
- ⏳ 编辑供货商（模态框待实现）

#### 显示字段
- 供货商代码
- 供货商名称
- 联系人
- 电话
- 邮箱
- 付款条件（现金、7天账期、15天账期、30天账期、60天账期、90天账期）

### 2. 客户管理 (🛒 客户管理)

#### 数据模型
- ✅ 创建 `Customer` 模型 (models/Customer.js)
  - 客户名称、代码、类型（个人/企业）
  - 联系信息（联系人、邮箱、电话、地址）
  - 税号、备注
  - 创建者、更新者、时间戳

#### 后端 API (app-new.js)
- ✅ `GET /api/admin/customers` - 获取所有客户（支持搜索）
- ✅ `GET /api/admin/customers/:customerId/invoices` - 获取客户的所有销售发票
- ✅ `POST /api/admin/customers` - 添加新客户
- ✅ `PUT /api/admin/customers/:id` - 更新客户信息
- ✅ `DELETE /api/admin/customers/:id` - 删除客户（软删除）

#### 前端功能 (prototype-working.html)
- ✅ 客户列表展示（表格形式）
- ✅ 搜索客户（按名称、代码、联系人、邮箱）
- ✅ 查看客户的所有销售发票
- ✅ 删除客户
- ⏳ 添加客户（模态框待实现）
- ⏳ 编辑客户（模态框待实现）

#### 显示字段
- 客户代码
- 客户名称
- 类型（个人/企业）
- 联系人
- 电话
- 邮箱

### 3. 产品追溯 (🔍 产品追溯)

#### 后端 API (app-new.js)
- ✅ `GET /api/admin/products/tracking?search=xxx` - 产品追溯查询
  - 支持按产品名称、SKU、条码、序列号搜索
  - 返回产品信息和完整历史记录
  - 包含采购记录（从哪个供货商、哪张发票进货）
  - 包含销售记录（卖给哪个客户、哪张发票）

#### 前端功能 (prototype-working.html)
- ✅ 搜索输入框（支持产品名称、条码、IMEI、SN号码）
- ✅ 产品信息卡片展示
  - 产品名称、SKU、条码、颜色
  - 当前库存数量
- ✅ 历史记录时间线展示
  - 采购入库记录（绿色标记）
  - 销售出库记录（橙色标记）
  - 显示日期时间、供货商/客户、发票编号
  - 显示数量、单价、总价、税率
  - 显示序列号（如果有）

#### 时间线特性
- 按时间倒序排列（最新记录在上）
- 视觉化时间线（左侧竖线和圆点）
- 采购和销售用不同颜色区分
- 完整的交易信息展示

## 数据模型更新

### SalesInvoice 模型更新
- ✅ 添加 `customer` 字段（关联 Customer 模型）
- ✅ 添加 `items.product` 字段（关联 ProductNew 模型）
- ✅ 添加 `items.vatRate` 和 `items.taxAmount` 字段

## 技术实现细节

### 价格处理
- 所有采购发票价格显示为含税价格
- 后端计算含税价格：不含税价格 × 税率系数
  - VAT 23%: × 1.23
  - VAT 13.5%: × 1.135
  - VAT 0%: × 1.0

### 搜索功能
- 使用 MongoDB 正则表达式搜索
- 不区分大小写
- 支持多字段搜索（$or 查询）

### 软删除
- 供货商和客户删除采用软删除方式
- 只将 `isActive` 字段设为 `false`
- 不从数据库中物理删除记录

## 待完成功能

### 供货商管理
- [ ] 添加供货商模态框
  - 表单字段：代码、名称、联系人、电话、邮箱、地址、付款条件等
- [ ] 编辑供货商模态框
  - 加载现有数据
  - 更新供货商信息

### 客户管理
- [ ] 添加客户模态框
  - 表单字段：代码、名称、类型、联系人、电话、邮箱、地址、税号等
- [ ] 编辑客户模态框
  - 加载现有数据
  - 更新客户信息

### 增强功能
- [ ] 发票详情查看（点击发票编号查看完整发票信息）
- [ ] 导出功能（导出供货商/客户列表、发票记录）
- [ ] 统计分析（供货商采购统计、客户销售统计）
- [ ] 批量操作（批量删除、批量导入）

## 文件修改清单

### 后端文件
1. `StockControl-main/app-new.js`
   - 添加 Customer 和 SalesInvoice 模型导入
   - 添加供货商管理 API（5个端点）
   - 添加客户管理 API（5个端点）
   - 添加产品追溯 API（1个端点）

### 前端文件
2. `StockControl-main/public/prototype-working.html`
   - 更新主标签页切换逻辑
   - 添加 `switchPartnerTab()` 函数
   - 添加供货商管理函数（7个）
   - 添加客户管理函数（7个）
   - 添加产品追溯函数（2个）
   - 添加辅助函数（状态标签转换等）

### 数据模型文件
3. `StockControl-main/models/Customer.js` - 已创建
4. `StockControl-main/models/SalesInvoice.js` - 已更新

## 使用说明

### 访问功能
1. 启动服务器：`npm start` 或 `node app-new.js`
2. 打开浏览器访问：`http://localhost:3000/prototype-working.html`
3. 点击"👥 供货商/客户管理"标签页

### 供货商管理
1. 默认显示供货商列表
2. 使用搜索框搜索供货商
3. 点击"📋 查看发票"查看供货商的所有采购发票
4. 点击"🗑️ 删除"删除供货商（需确认）

### 客户管理
1. 点击"🛒 客户管理"子标签
2. 使用搜索框搜索客户
3. 点击"📋 查看发票"查看客户的所有销售发票
4. 点击"🗑️ 删除"删除客户（需确认）

### 产品追溯
1. 点击"🔍 产品追溯"子标签
2. 输入产品名称、条码、IMEI或SN号码
3. 点击"🔍 查询追溯"按钮
4. 查看产品信息和完整历史记录时间线

## 测试建议

### 供货商管理测试
1. 测试搜索功能（按名称、代码、联系人搜索）
2. 测试查看发票功能
3. 测试删除功能

### 客户管理测试
1. 测试搜索功能
2. 测试查看发票功能
3. 测试删除功能

### 产品追溯测试
1. 按产品名称搜索
2. 按条码搜索
3. 按序列号搜索
4. 验证时间线显示正确
5. 验证采购和销售记录都显示

## 注意事项

1. **数据库连接**：确保 MongoDB 已连接，否则所有 API 将返回 503 错误
2. **用户认证**：当前使用默认用户（admin），生产环境需要实现完整的用户认证
3. **销售发票数据**：目前系统可能没有销售发票数据，客户发票列表可能为空
4. **模态框复用**：当前使用产品编辑模态框显示发票列表，后续可创建专用模态框
5. **性能优化**：大量数据时需要添加分页功能

## 下一步开发计划

1. 实现添加/编辑供货商和客户的模态框
2. 创建专用的发票详情模态框
3. 添加销售发票创建功能（与产品追溯配合）
4. 实现统计分析功能
5. 添加导出功能
6. 优化移动端显示
