# 快速测试：入库管理动态加载

## 测试目标
验证入库管理功能（发票识别和手动录入）中的分类和成色下拉框是否从数据库动态加载

## 前置条件
- 服务器运行中：http://localhost:3000
- 仓库管理员账号：warehouse_manager / 123456 或 warehouse1 / warehouse123
- 数据库中已有分类和成色数据

## 测试步骤

### 步骤 1：检查数据库中的分类和成色

打开浏览器控制台，执行以下命令查看当前数据：

```javascript
// 查看分类
fetch('/api/admin/categories')
  .then(r => r.json())
  .then(d => console.table(d.data));

// 查看成色
fetch('/api/admin/conditions')
  .then(r => r.json())
  .then(d => console.table(d.data));
```

### 步骤 2：登录仓库管理员账号

1. 访问：http://localhost:3000
2. 输入账号：`warehouse_manager` 或 `warehouse1`
3. 输入密码：`123456` 或 `warehouse123`
4. 点击"登录"

---

## 测试 A：发票识别功能

### 步骤 3A：进入发票识别页面

1. 点击左侧菜单"入库管理"
2. 确认"📤 发票上传入库"按钮已选中（默认模式）

### 步骤 4A：上传发票图片

1. 点击"选择发票图片"按钮
2. 选择一张发票图片
3. 等待识别完成

### 步骤 5A：检查下拉框选项

在识别结果的产品列表中，检查：

#### 分类下拉框
- 打开"分类"列的下拉框
- **预期结果**：显示数据库中的分类选项（不是硬编码的选项）
- 选项应该按 `sortOrder` 排序
- 只显示 `isActive: true` 的分类

#### 成色下拉框
- 打开"成色"列的下拉框
- **预期结果**：显示数据库中的成色选项（不是硬编码的选项）
- 选项应该按 `sortOrder` 排序
- 只显示 `isActive: true` 的成色

### 步骤 6A：查看调试日志

打开浏览器控制台（F12），查看日志：

```
✅ 应该看到：
🔄 开始加载产品分类数据
📥 分类API响应: 200 OK
📦 分类数据: {...}
✅ 分类数量: X 个分类

🔄 开始加载设备成色数据
📥 成色API响应: 200 OK
📦 成色数据: {...}
✅ 成色数量: X 个成色
```

---

## 测试 B：手动录入功能

### 步骤 3B：切换到手动录入模式

1. 点击左侧菜单"入库管理"
2. 点击"✏️ 手动录入入库"按钮
3. 等待页面切换

### 步骤 4B：添加产品行

1. 点击"➕ 添加产品"按钮
2. 系统会自动添加一行产品输入表单

### 步骤 5B：检查下拉框选项

在新增的产品行中，检查：

#### 分类下拉框
- 打开"分类"列的下拉框
- **预期结果**：
  - 第一个选项是"选择分类..."
  - 后续显示数据库中的分类选项
  - 选项按 `sortOrder` 排序
  - 只显示 `isActive: true` 的分类

#### 成色下拉框
- 打开"成色"列的下拉框
- **预期结果**：
  - 显示数据库中的成色选项
  - 默认选中第一个成色（通常是"Brand New"）
  - 选项按 `sortOrder` 排序
  - 只显示 `isActive: true` 的成色

### 步骤 6B：查看调试日志

打开浏览器控制台（F12），查看日志：

```
✅ 应该看到：
🔄 切换到手动录入模式
🔄 准备加载供应商列表...
🔄 加载产品分类数据...
✅ 分类数据已加载: X 个分类
🔄 加载设备成色数据...
✅ 成色数据已加载: X 个成色
➕ 添加第一个产品行
```

### 步骤 7B：测试多次添加产品

1. 点击"➕ 添加产品"按钮多次
2. 检查每一行的分类和成色下拉框
3. **预期结果**：所有行都显示相同的动态加载选项

---

## 高级测试：添加新分类和成色

### 测试新分类

1. 登录管理员账号：`admin` / `admin123`
2. 进入"系统设置" → "产品分类管理"
3. 添加新分类，例如：
   - 类型：`测试分类`
   - 描述：`用于测试动态加载`
   - 默认税率：`VAT 23%`
   - 激活状态：✅
4. 保存后，重新登录仓库管理员账号
5. 测试发票识别和手动录入
6. **预期结果**：新添加的"测试分类"出现在两个功能的下拉框中

### 测试新成色

1. 在管理员页面进入"系统设置" → "设备成色管理"
2. 添加新成色，例如：
   - 代码：`TEST_CONDITION`
   - 名称：`测试成色`
   - 描述：`用于测试动态加载`
   - 激活状态：✅
3. 保存后，重新登录仓库管理员账号
4. 测试发票识别和手动录入
5. **预期结果**：新添加的"测试成色"出现在两个功能的下拉框中

---

## 容错测试

### 测试回退机制

如果 API 调用失败，系统应该显示默认的硬编码选项：

**默认分类选项**：
- 手机配件
- 电脑配件
- 车载配件
- Audio
- 数据线
- Power Supply
- 全新设备
- 二手设备
- 维修

**默认成色选项**：
- 全新 (Brand New)
- 二手 (Pre-Owned)
- 翻新 (Refurbished)

---

## 常见问题

### Q1: 下拉框显示的还是硬编码选项？
**A**: 检查浏览器控制台是否有 API 错误。如果 API 调用失败，系统会自动回退到硬编码选项。

### Q2: 新添加的分类/成色没有显示？
**A**: 确认以下几点：
- 新数据的 `isActive` 字段是否为 `true`
- 刷新页面或重新切换入库模式
- 检查浏览器控制台的调试日志

### Q3: 手动录入模式下，第一次添加产品时没有显示动态选项？
**A**: 这可能是因为数据还在加载中。等待几秒后再添加产品，或者切换到发票识别模式再切换回来。

### Q4: 如何查看加载了哪些数据？
**A**: 打开浏览器控制台，查看全局变量：
```javascript
console.table(window.categoriesData);
console.table(window.conditionsData);
```

---

## 成功标准

### 发票识别功能
✅ 分类下拉框显示数据库中的分类选项  
✅ 成色下拉框显示数据库中的成色选项  
✅ 只显示激活状态的选项  
✅ 选项按 sortOrder 排序  
✅ 新添加的分类/成色能立即使用  
✅ API 失败时显示默认选项（容错）  
✅ 控制台有完整的调试日志  

### 手动录入功能
✅ 切换到手动录入模式时自动加载数据  
✅ 分类下拉框显示数据库中的分类选项  
✅ 成色下拉框显示数据库中的成色选项  
✅ 多次添加产品时，所有行都显示相同的选项  
✅ 只显示激活状态的选项  
✅ 选项按 sortOrder 排序  
✅ 新添加的分类/成色能立即使用  
✅ API 失败时显示默认选项（容错）  
✅ 控制台有完整的调试日志  

---

## 相关文档
- `ADMIN_INVOICE_RECOGNITION_COMPLETE.md` - 功能实现详情
- `ADMIN_CATEGORY_DYNAMIC_LOADING.md` - 分类管理功能
- `CONDITION_DYNAMIC_LOADING.md` - 成色管理功能
