# 商户仪表板统计改进

## 📅 日期
2026-02-02

## ✅ 状态
**完成度：100%**

商户仪表板统计卡片已全面改进，支持点击查看详细明细。

---

## 📋 改进内容

### 1. 统计卡片更新

#### 原有设计
- 我的库存（数量）
- 本月销售（金额）
- 本月维修（金额）
- 应缴税额（金额）

#### 新设计
- **我的库存**（数量）- 保持不变
- **本日销售** 💰（金额）- 可点击查看明细
- **本日维修** 🔧（金额）- 可点击查看明细
- **应缴税额** 📊（金额）- 可点击查看计算过程

### 2. 交互改进

#### 视觉提示
- 可点击的卡片添加悬停效果
- 悬停时卡片上移并增强阴影
- 显示"点击查看明细"提示文字

#### 点击功能
- 点击卡片弹出详细信息模态框
- 显示完整的数据明细
- 支持关闭返回主界面

---

## 🎯 功能详情

### 1. 本日销售明细

#### 显示内容
- **销售汇总**
  - 销售笔数
  - 销售总额
  - 利润总额

- **销售明细表格**
  - 时间（时:分）
  - 产品名称和序列号
  - 数量
  - 金额
  - 税额
  - 支付方式（现金/刷卡/混合）

- **合计行**
  - 总金额
  - 总税额

#### 数据来源
- 查询当日（00:00 - 23:59）的所有销售记录
- 状态为 'completed' 的订单
- 按时间顺序显示

#### 计算逻辑
```javascript
// 销售总额
totalAmount = sum(sale.totalAmount)

// 税额总额
totalTax = sum(sale.totalTax)

// 利润总额
totalProfit = sum((item.price - item.costPrice) * item.quantity)
```

### 2. 本日维修明细

#### 显示内容
- **维修汇总**
  - 订单数量
  - 维修成本
  - 预计收入
  - 预计利润
  - 状态分布

- **维修明细表格**
  - 时间（时:分）
  - 客户信息（电话、姓名）
  - 设备信息（名称、IMEI/SN）
  - 问题描述
  - 成本
  - 售价
  - 状态

#### 数据来源
- 查询当日创建的所有维修订单
- 包含所有状态的订单
- 按创建时间顺序显示

#### 计算逻辑
```javascript
// 维修成本
totalCost = sum(repair.repairCost)

// 预计收入
totalSalePrice = sum(repair.salePrice)

// 预计利润
totalProfit = totalSalePrice - totalCost

// 状态统计
statusCount = count by repair.status
```

#### 状态说明
- 待维修（pending）
- 已送出（sent_out）
- 已取回（retrieved）
- 已完成（completed）
- 等待销售（ready_for_sale）
- 已销售（sold）
- 已取消（cancelled）

### 3. 税额计算明细

#### 显示内容
- **税额汇总**
  - 销售总额（本月）
  - 应缴税额（本月）
  - 净收入

- **按税率分类**
  - 税率名称（VAT 23%、VAT 13.5%等）
  - 计算公式
  - 商品数量
  - 销售额
  - 税额
  - 净额

- **计算过程**
  - 详细的数学公式
  - 步骤说明
  - 结果验证

- **税额说明**
  - 各税率的适用范围
  - 计算方法说明

#### 数据来源
- 查询本月（1日 - 当前日期）的所有销售记录
- 按税务分类（taxClassification）分组统计
- 显示每个税率的详细计算

#### 税率类型
1. **VAT 23%** - 标准税率
   - 公式：销售额 × 23 / 123
   - 适用：大多数商品

2. **VAT 13.5%** - 降低税率
   - 公式：销售额 × 13.5 / 113.5
   - 适用：特定商品和服务

3. **SERVICE VAT 13.5%** - 服务税率
   - 公式：销售额 × 13.5 / 113.5
   - 适用：维修服务

4. **VAT 9%** - 超低税率
   - 公式：销售额 × 9 / 109
   - 适用：特殊商品

5. **VAT 0%** - 免税
   - 公式：免税
   - 适用：免税商品

6. **MARGIN VAT 0 (差价征税)** - 二手商品差价税
   - 公式：(销售价 - 成本价) × 23 / 123
   - 适用：二手商品、翻新商品
   - 说明：仅对利润部分征税

#### 计算示例
```
标准税率 VAT 23%：
销售额：€123.00
计算：€123.00 × 23 / 123 = €23.00
净额：€123.00 - €23.00 = €100.00

差价征税 MARGIN VAT 0：
销售价：€123.00
成本价：€50.00
利润：€73.00
计算：€73.00 × 23 / 123 = €13.65
净额：€123.00 - €13.65 = €109.35
```

---

## 🔧 技术实现

### 前端实现 (merchant.html)

#### 1. 统计卡片HTML更新
```html
<!-- 本日销售卡片 -->
<div class="stat-card" onclick="showDailySalesDetails()" style="cursor: pointer;">
  <h3>本日销售 💰</h3>
  <div class="value" id="dailySales">-</div>
  <small>点击查看明细</small>
</div>
```

#### 2. 明细模态框
- dailySalesModal - 本日销售明细
- dailyRepairsModal - 本日维修明细
- taxCalculationModal - 税额计算明细

#### 3. JavaScript 函数

**showDailySalesDetails()**
- 显示本日销售明细模态框
- 调用 API 获取当日销售数据
- 渲染销售明细表格
- 计算汇总数据

**showDailyRepairsDetails()**
- 显示本日维修明细模态框
- 调用 API 获取维修订单数据
- 筛选当日创建的订单
- 渲染维修明细表格
- 统计状态分布

**showTaxCalculationDetails()**
- 显示税额计算明细模态框
- 调用 API 获取本月销售数据
- 按税率分类统计
- 显示详细计算过程
- 渲染税额说明

**关闭函数**
- closeDailySalesModal()
- closeDailyRepairsModal()
- closeTaxCalculationModal()

### 后端实现 (app.js)

#### 更新 Stats API
```
GET /api/merchant/stats?merchantId=xxx
```

**返回数据结构：**
```json
{
  "success": true,
  "data": {
    "myInventory": 150,      // 库存产品数量（quantity > 0）
    "dailySales": 1250.50,   // 本日销售额
    "dailyRepairs": 450.00,  // 本日维修收入（已销售）
    "taxDue": 2850.75        // 本月应缴税额
  }
}
```

**查询逻辑：**

1. **我的库存**
```javascript
MerchantInventory.countDocuments({
  merchantId: merchantId,
  status: 'active',
  isActive: true,
  quantity: { $gt: 0 }
})
```

2. **本日销售**
```javascript
MerchantSale.aggregate([
  {
    $match: {
      merchantId: merchantId,
      saleDate: { $gte: today, $lt: tomorrow },
      status: 'completed'
    }
  },
  {
    $group: {
      _id: null,
      total: { $sum: '$totalAmount' }
    }
  }
])
```

3. **本日维修**
```javascript
RepairOrder.aggregate([
  {
    $match: {
      merchantId: merchantId,
      soldDate: { $gte: today, $lt: tomorrow },
      status: 'sold'
    }
  },
  {
    $group: {
      _id: null,
      total: { $sum: '$salePrice' }
    }
  }
])
```

4. **本月税额**
```javascript
MerchantSale.aggregate([
  {
    $match: {
      merchantId: merchantId,
      saleDate: { $gte: firstDayOfMonth, $lte: lastDayOfMonth },
      status: 'completed'
    }
  },
  {
    $group: {
      _id: null,
      total: { $sum: '$totalTax' }
    }
  }
])
```

---

## 📁 修改的文件

### 前端文件
1. `StockControl-main/public/merchant.html`
   - 更新统计卡片HTML（添加点击事件和悬停效果）
   - 添加三个明细模态框
   - 实现 showDailySalesDetails() 函数
   - 实现 showDailyRepairsDetails() 函数
   - 实现 showTaxCalculationDetails() 函数
   - 实现关闭函数

### 后端文件
1. `StockControl-main/app.js`
   - 更新 GET /api/merchant/stats 端点
   - 实现实际数据查询（替换模拟数据）
   - 添加日期范围计算
   - 使用 MongoDB 聚合查询

### 新增文档
1. `DASHBOARD_STATS_IMPROVEMENT.md` - 本文档

---

## 🎨 界面设计

### 统计卡片样式
- 悬停效果：上移 5px，阴影增强
- 光标：pointer（手型）
- 提示文字：灰色小字
- 图标：表情符号（💰 🔧 📊）

### 模态框样式
- 最大宽度：1000px
- 最大高度：90vh
- 滚动：overflow-y: auto
- 背景：半透明黑色遮罩
- 内容：白色圆角卡片

### 表格样式
- 表头：灰色背景
- 行：底部边框分隔
- 悬停：无（静态显示）
- 合计行：加粗，灰色背景

### 颜色方案
- 销售金额：绿色 (#10b981)
- 税额：橙色 (#f59e0b)
- 利润：紫色 (#8b5cf6)
- 成本：红色 (#dc3545)
- 信息：蓝色 (#3b82f6)

---

## 🚀 部署信息

### 服务器状态
- **状态**：✅ 运行中
- **进程 ID**：23
- **地址**：http://localhost:3000
- **启动命令**：npm start
- **数据库**：✅ MongoDB 连接成功

### 测试账号
- **商户账号**：merchant_001
- **密码**：merchant123

---

## ✅ 测试清单

### 基础功能
- [ ] 统计卡片正确显示数据
- [ ] 我的库存数量正确
- [ ] 本日销售金额正确
- [ ] 本日维修金额正确
- [ ] 应缴税额正确

### 交互功能
- [ ] 悬停效果正常
- [ ] 点击本日销售显示明细
- [ ] 点击本日维修显示明细
- [ ] 点击应缴税额显示计算过程
- [ ] 模态框正确显示
- [ ] 关闭按钮正常工作

### 本日销售明细
- [ ] 显示当日所有销售记录
- [ ] 销售汇总数据正确
- [ ] 表格数据完整
- [ ] 时间格式正确
- [ ] 支付方式显示正确
- [ ] 合计行计算正确

### 本日维修明细
- [ ] 显示当日所有维修订单
- [ ] 维修汇总数据正确
- [ ] 状态分布统计正确
- [ ] 表格数据完整
- [ ] 状态颜色正确
- [ ] 预计利润计算正确

### 税额计算明细
- [ ] 显示本月销售数据
- [ ] 税额汇总正确
- [ ] 按税率分类正确
- [ ] 计算公式显示正确
- [ ] 计算过程清晰
- [ ] 税额说明完整

---

## 🎯 快速测试

### 测试步骤

1. **访问系统**
   - 打开 http://localhost:3000
   - 登录：merchant_001 / merchant123

2. **查看统计卡片**
   - 确认四个卡片都显示数据
   - 悬停在可点击的卡片上
   - 验证悬停效果

3. **测试本日销售**
   - 点击"本日销售"卡片
   - 查看销售明细模态框
   - 验证数据正确性
   - 关闭模态框

4. **测试本日维修**
   - 点击"本日维修"卡片
   - 查看维修明细模态框
   - 验证数据正确性
   - 检查状态分布
   - 关闭模态框

5. **测试税额计算**
   - 点击"应缴税额"卡片
   - 查看税额计算模态框
   - 验证计算过程
   - 检查税率分类
   - 关闭模态框

---

## 💡 使用场景

### 1. 日常经营监控
- 快速查看当日销售情况
- 了解当日维修订单数量
- 监控库存水平

### 2. 财务管理
- 查看详细销售记录
- 计算当日利润
- 了解税务情况

### 3. 业务分析
- 分析销售趋势
- 评估维修业务
- 优化库存管理

### 4. 税务申报
- 查看税额计算过程
- 按税率分类统计
- 准备税务文件

---

## 📝 注意事项

### 1. 数据准确性
- 统计数据实时计算
- 基于数据库实际记录
- 确保数据库连接正常

### 2. 性能考虑
- 使用 MongoDB 聚合查询
- 添加适当的索引
- 限制查询范围（当日/本月）

### 3. 用户体验
- 加载状态提示
- 错误提示友好
- 模态框可滚动
- 关闭方式多样

### 4. 数据隐私
- 只显示当前商户数据
- 验证 merchantId
- 防止数据泄露

---

## 🔍 故障排查

### 问题1：统计数据显示为 0
**可能原因：**
- 数据库中没有数据
- 日期范围不正确
- merchantId 不匹配

**解决方法：**
1. 检查数据库中是否有销售/维修记录
2. 验证日期范围计算
3. 确认 merchantId 正确

### 问题2：点击卡片没有反应
**可能原因：**
- JavaScript 错误
- 函数未定义
- 模态框 ID 不匹配

**解决方法：**
1. 打开浏览器控制台查看错误
2. 检查函数名称拼写
3. 验证模态框 ID

### 问题3：明细数据不正确
**可能原因：**
- API 查询错误
- 日期计算错误
- 数据格式问题

**解决方法：**
1. 检查 API 响应数据
2. 验证日期范围
3. 查看服务器日志

---

## 🎉 总结

### 完成情况
- **功能实现**：100% ✅
- **文档完整性**：100% ✅
- **测试准备**：100% ✅
- **部署状态**：运行中 ✅

### 核心改进
1. ✅ 统计卡片从"本月"改为"本日"
2. ✅ 添加点击查看明细功能
3. ✅ 实现本日销售明细显示
4. ✅ 实现本日维修明细显示
5. ✅ 实现税额计算过程显示
6. ✅ 更新后端 API 返回实际数据
7. ✅ 优化用户交互体验

### 准备就绪
- ✅ 服务器运行正常
- ✅ 数据库连接成功
- ✅ 所有功能已部署
- ✅ 文档完整
- ✅ 可以开始测试

---

**商户仪表板统计改进已完成！** 🎊  
**开始测试：** http://localhost:3000  
**祝使用愉快！** 🚀
