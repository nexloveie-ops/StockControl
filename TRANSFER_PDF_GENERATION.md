# 调货单PDF生成功能 ✅

## 功能描述

为调货详情添加PDF生成功能，用户可以将调货单导出为PDF格式，方便打印和存档。

## 实现内容

### 1. 调货详情模态框增强

在调货详情模态框中添加"生成PDF"按钮。

**位置**: 调货详情模态框底部

**按钮**:
- 📄 生成PDF（绿色按钮）
- 关闭（蓝色按钮）

### 2. PDF生成功能

创建 `generateTransferPDF()` 函数，生成专业的调货单PDF文档。

**文件**: `merchant.html`

**功能**:
- 获取调货详情数据
- 在新窗口中生成格式化的HTML文档
- 支持浏览器打印功能（Ctrl+P 或 Cmd+P）
- 可保存为PDF文件

## PDF文档内容

### 1. 头部信息
```
┌─────────────────────────────────────────────────────┐
│ 📦 调货单                    TF-1738761234567-0001  │
│ 内部调拨                     状态: [已完成]         │
│                              创建时间: 2026-02-05   │
│                              完成时间: 2026-02-05   │
└─────────────────────────────────────────────────────┘
```

**包含信息**:
- 调货单类型图标（📦 内部调拨 / 💰 公司间销售）
- 调货单号
- 状态徽章（带颜色）
- 创建时间
- 完成时间（如果已完成）

### 2. 调货双方信息
```
┌─────────────────────────────────────────────────────┐
│ 调货双方                                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 调出方                    →              调入方     │
│ ┌─────────────────┐                ┌──────────────┐│
│ │ MurrayRanelagh  │                │MurrayDundrum ││
│ │ Murray Electronics Limited        │Murray Electronics Limited││
│ │ 123 Main Street │                │456 High St   ││
│ │ Dublin D01 ABC  │                │Dublin D02 XYZ││
│ │ Ireland         │                │Ireland       ││
│ │ VAT: IE1234567  │                │VAT: IE7654321││
│ └─────────────────┘                └──────────────┘│
│                                                     │
└─────────────────────────────────────────────────────┘
```

**包含信息**:
- 调出方和调入方用户名
- 公司名称
- 完整地址
- VAT号码

### 3. 产品清单
```
┌─────────────────────────────────────────────────────┐
│ 产品清单                                            │
├─────────────────────────────────────────────────────┤
│ 产品名称 │ 序列号 │ 成色 │ 数量 │ 单价 │ 小计    │
├─────────────────────────────────────────────────────┤
│ iPhone 14│ 222333 │ A级 │  1  │€600 │€600.00 │
│ iPhone 13│ 111222 │ B级 │  1  │€500 │€500.00 │
└─────────────────────────────────────────────────────┘
```

**表格列**:
- 产品名称
- 序列号/IMEI（等宽字体）
- 成色
- 数量
- 单价
- 小计

### 4. 总金额
```
┌─────────────────────────────────────────────────────┐
│                              总金额: €1,100.00      │
└─────────────────────────────────────────────────────┘
```

### 5. 备注信息
```
┌─────────────────────────────────────────────────────┐
│ 备注                                                │
├─────────────────────────────────────────────────────┤
│ 内部调拨，用于补充库存                              │
└─────────────────────────────────────────────────────┘
```

**显示条件**: 仅当有备注时显示

### 6. 拒绝原因
```
┌─────────────────────────────────────────────────────┐
│ 拒绝原因                                            │
├─────────────────────────────────────────────────────┤
│ 库存不足，无法完成调货                              │
└─────────────────────────────────────────────────────┘
```

**显示条件**: 仅当状态为"已拒绝"且有拒绝原因时显示

### 7. 操作按钮
```
┌─────────────────────────────────────────────────────┐
│              [🖨️ 打印调货单]  [关闭]               │
└─────────────────────────────────────────────────────┘
```

## 样式设计

### 状态徽章颜色

| 状态 | 背景色 | 文字色 | 说明 |
|------|--------|--------|------|
| **待审批** | #fef3c7 | #92400e | 黄色 |
| **已批准** | #dbeafe | #1e40af | 蓝色 |
| **已拒绝** | #fee2e2 | #dc2626 | 红色 |
| **已完成** | #d1fae5 | #065f46 | 绿色 |

### 布局特点

1. **专业的头部**
   - 左侧：调货单类型和图标
   - 右侧：调货单号和状态信息
   - 底部：2px 实线分隔

2. **清晰的双方信息**
   - 网格布局（1fr auto 1fr）
   - 灰色背景框
   - 箭头指示方向
   - 完整的公司信息

3. **规范的产品表格**
   - 边框表格
   - 灰色表头
   - 右对齐的数字
   - 居中对齐的序列号

4. **突出的总金额**
   - 右侧浮动
   - 大字体（18px）
   - 粗体显示
   - 顶部分隔线

5. **醒目的备注框**
   - 蓝色背景
   - 左侧蓝色边框
   - 圆角设计

## 使用流程

### 1. 打开调货详情
```
产品时间线 → 点击调货单号 → 调货详情模态框
或
调货管理 → 查看调货记录
```

### 2. 生成PDF
点击"📄 生成PDF"按钮

### 3. 打印或保存
在新窗口中：
- 点击"🖨️ 打印调货单"按钮
- 或使用浏览器打印功能（Ctrl+P / Cmd+P）
- 选择"保存为PDF"作为打印机
- 保存到本地

## 打印优化

### @media print 样式

```css
@media print {
  body { padding: 20px; }
  button { display: none; }
}
```

**优化内容**:
- 减少页边距
- 隐藏按钮
- 保持表格完整性
- 优化分页

## 代码实现

### 函数签名

```javascript
async function generateTransferPDF(transferId)
```

**参数**:
- `transferId`: 调货记录的ID

**流程**:
1. 调用API获取调货详情
2. 格式化数据
3. 生成HTML文档
4. 在新窗口中打开
5. 准备打印

### HTML模板

使用模板字符串生成完整的HTML文档：

```javascript
const html = `
  <!DOCTYPE html>
  <html>
  <head>
    <meta charset="UTF-8">
    <title>调货单 - ${transfer.transferNumber}</title>
    <style>
      /* CSS样式 */
    </style>
  </head>
  <body>
    <!-- 文档内容 -->
  </body>
  </html>
`;
```

### 新窗口打开

```javascript
const printWindow = window.open('', '_blank');
printWindow.document.write(html);
printWindow.document.close();
```

## 与销售发票的对比

| 特性 | 销售发票 | 调货单 |
|------|---------|--------|
| **文档类型** | Sales Invoice | Transfer Order |
| **双方信息** | 公司 → 客户 | 调出方 → 调入方 |
| **价格显示** | 含税价格 | 调货价格 |
| **VAT计算** | 显示VAT明细 | 不显示VAT |
| **付款信息** | 银行账户信息 | 无 |
| **状态** | Confirmed/Pending | 待审批/已批准/已拒绝/已完成 |

## 优势

### 1. 专业性
- ✅ 规范的文档格式
- ✅ 清晰的信息层次
- ✅ 专业的视觉设计

### 2. 完整性
- ✅ 包含所有调货信息
- ✅ 双方完整信息
- ✅ 详细的产品清单

### 3. 便捷性
- ✅ 一键生成PDF
- ✅ 直接打印
- ✅ 易于存档

### 4. 灵活性
- ✅ 支持内部调拨和公司间销售
- ✅ 适应不同状态
- ✅ 可选的备注和拒绝原因

## 应用场景

### 1. 内部调拨
```
场景: 同一公司内部门店之间调货
用途: 内部记录和存档
```

### 2. 公司间销售
```
场景: 不同公司之间的产品销售
用途: 正式的交易凭证
```

### 3. 审计追踪
```
场景: 财务审计和库存盘点
用途: 提供完整的调货记录
```

### 4. 纠纷解决
```
场景: 调货过程中出现问题
用途: 作为证据和参考
```

## 测试验证

### 测试步骤

1. **登录商户账号**
   ```
   http://localhost:3000/merchant.html
   用户名: MurrayDundrum
   密码: password123
   ```

2. **打开调货详情**
   - 方式1: 产品时间线 → 点击调货单号
   - 方式2: 调货管理 → 查看记录

3. **生成PDF**
   - 点击"📄 生成PDF"按钮
   - 新窗口应该打开

4. **验证内容**
   - 头部信息正确 ✅
   - 双方信息完整 ✅
   - 产品清单准确 ✅
   - 总金额正确 ✅
   - 备注显示（如果有）✅

5. **测试打印**
   - 点击"🖨️ 打印调货单"
   - 或按 Ctrl+P / Cmd+P
   - 选择"保存为PDF"
   - 保存到本地

6. **验证PDF**
   - 打开保存的PDF文件
   - 检查格式和内容
   - 确认可读性

### 预期结果

**新窗口**:
- 正确打开 ✅
- 显示完整内容 ✅
- 样式正确应用 ✅

**打印预览**:
- 布局合理 ✅
- 按钮隐藏 ✅
- 分页正确 ✅

**PDF文件**:
- 格式正确 ✅
- 内容完整 ✅
- 可读性好 ✅

## 注意事项

1. **浏览器兼容性**
   - 支持所有现代浏览器
   - Chrome、Firefox、Safari、Edge
   - 需要允许弹出窗口

2. **打印设置**
   - 建议使用A4纸张
   - 纵向打印
   - 边距：默认或最小

3. **数据完整性**
   - 确保调货记录存在
   - 公司信息可能为空
   - 备注和拒绝原因可选

4. **性能考虑**
   - 大量产品时可能需要分页
   - 新窗口加载需要时间
   - 打印大文档可能较慢

## 代码位置

**文件**: `StockControl-main/public/merchant.html`

**函数**: `generateTransferPDF()`（约 4790 行）

**调用位置**: 调货详情模态框的"生成PDF"按钮

## 相关功能

- 调货详情显示：显示完整的调货信息
- 产品时间线：追踪产品历史
- 调货管理：管理所有调货记录

## 相关文档

- `PRODUCT_TIMELINE_TRANSFER_LINK.md` - 调货单号可点击功能
- `TRANSFER_MANAGEMENT_COMPLETE.md` - 调货管理功能
- `SALES_INVOICE_DETAILS_FEATURE.md` - 销售发票功能（参考）

---
**完成日期**: 2026-02-05
**状态**: ✅ 已完成
**需要重启服务器**: 否（纯前端功能）
