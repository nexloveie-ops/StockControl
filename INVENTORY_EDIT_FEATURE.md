# 功能：库存产品编辑

## 功能描述
在"我的库存"页面，商户可以编辑产品的详细信息，包括价格、位置、备注等。

## 新增功能

### 1. 产品列表操作列
在产品列表中添加"操作"列，包含两个按钮：
- **✏️ 编辑**：打开编辑模态框
- **📊 时间线**：查看产品时间线（原有功能）

### 2. 编辑模态框
点击"编辑"按钮后，弹出编辑表单，包含以下字段：

#### 可编辑字段
- **产品名称**（必填）
- **品牌**
- **型号**
- **颜色**
- **成本价**（必填，€）
- **批发价**（必填，€）
- **零售价**（必填，€）
- **税务分类**（必填，下拉选择）
  - VAT 23%
  - VAT 13.5%
  - VAT 9%
  - VAT 0%
  - Margin VAT
- **成色**
- **位置**（新增字段，如"货架A-3"）
- **备注**

#### 不可编辑字段
- 序列号（serialNumber）
- IMEI
- 条码（barcode）
- 库存数量（quantity）
- 分类（category）

**原因**：这些字段是唯一标识符或系统管理字段，不应由用户直接修改。

### 3. 后端API
**端点**：`PUT /api/merchant/inventory/:id`

**权限**：使用 `applyDataIsolation` 中间件，确保商户只能编辑自己的库存。

**允许更新的字段**：
```javascript
[
  'productName',
  'brand',
  'model',
  'color',
  'costPrice',
  'wholesalePrice',
  'retailPrice',
  'taxClassification',
  'condition',
  'location',
  'notes'
]
```

## 使用流程

### 步骤 1: 进入我的库存
1. 登录商户账号
2. 点击"我的库存"标签
3. 选择一个分类或使用搜索

### 步骤 2: 编辑产品
1. 在产品列表中找到要编辑的产品
2. 点击"✏️ 编辑"按钮
3. 编辑表单自动填充当前产品信息

### 步骤 3: 修改信息
1. 修改需要更新的字段
2. 所有价格字段支持小数点后两位
3. 税务分类从下拉列表选择
4. 位置字段可以输入货架位置等信息

### 步骤 4: 保存
1. 点击"💾 保存修改"按钮
2. 系统验证数据并保存
3. 显示成功消息
4. 自动刷新库存列表

## 界面设计

### 编辑模态框布局
```
┌─────────────────────────────────────┐
│ ✏️ 编辑产品信息                  ×  │
├─────────────────────────────────────┤
│ [产品名称]        [品牌]            │
│ [型号]            [颜色]            │
│ [成本价] [批发价] [零售价]          │
│ [税务分类]        [成色]            │
│ [位置]                              │
│ [备注]                              │
│                                     │
│ ⚠️ 注意：序列号、IMEI等不可修改    │
│                                     │
│         [取消]  [💾 保存修改]       │
└─────────────────────────────────────┘
```

### 产品列表操作列
```
操作
─────────────────────
✏️ 编辑  📊 时间线
```

## 数据验证

### 前端验证
- 产品名称：必填
- 成本价、批发价、零售价：必填，数字，≥0
- 税务分类：必填，从预定义列表选择

### 后端验证
- 验证库存记录存在
- 验证用户权限（只能编辑自己的库存）
- 验证字段类型和范围
- 只更新允许的字段

## 安全性

### 权限控制
- 使用 `applyDataIsolation` 中间件
- 确保商户只能编辑自己的库存
- 查询时包含 `req.dataFilter`

### 字段保护
- 序列号、IMEI、条码等唯一标识符不可修改
- 库存数量不可直接修改（通过销售、调货等业务流程修改）
- 分类不可修改（避免数据混乱）

## 测试步骤

### 1. 基本编辑测试
1. 清除浏览器缓存（Ctrl+F5）
2. 登录 MurrayDundrum 账号
3. 进入"我的库存"
4. 选择一个分类
5. 点击任意产品的"✏️ 编辑"按钮
6. ✅ 验证：模态框打开，显示当前产品信息

### 2. 修改价格测试
1. 修改批发价：€10.00 → €12.00
2. 修改零售价：€15.00 → €18.00
3. 点击"保存修改"
4. ✅ 验证：显示成功消息，列表刷新，价格已更新

### 3. 修改位置测试
1. 编辑一个产品
2. 在"位置"字段输入：货架A-3
3. 保存
4. ✅ 验证：位置信息已保存（可在数据库中查看）

### 4. 税务分类测试
1. 编辑一个产品
2. 修改税务分类：VAT 23% → Margin VAT
3. 保存
4. ✅ 验证：税务分类已更新，列表中显示新的税务标签

### 5. 权限测试
1. 登录 MurrayRanelagh 账号
2. 尝试编辑 MurrayDundrum 的产品
3. ✅ 验证：无法访问或编辑其他商户的产品

### 6. 验证测试
1. 尝试将价格设置为负数
2. ✅ 验证：前端阻止提交
3. 尝试清空必填字段
4. ✅ 验证：前端显示验证错误

## 版本历史
- v2.1.8: 调货管理初始加载所有标签数量
- v2.2.0: 添加库存产品编辑功能 ✅

## 相关文件
- `StockControl-main/public/merchant.html` (v2.2.0)
  - 添加编辑模态框
  - 添加编辑按钮
  - 添加JavaScript函数
- `StockControl-main/app.js`
  - 添加 `PUT /api/merchant/inventory/:id` API

## 未来改进
1. 批量编辑功能
2. 编辑历史记录
3. 价格变动提醒
4. 库存数量调整功能（需要审计）
5. 图片上传功能

## 完成时间
2026年2月6日
