# 更新日志 - 2026年2月2日

## 概述
本次更新主要完成了以下功能：
1. Financial Reports资产列表功能
2. 供货商和客户编辑功能（包含税号）
3. 库存产品管理过滤已售产品
4. 产品搜索支持已售产品追溯

---

## 1. Financial Reports - 资产列表功能

### 后端修改 (app-new.js)
- **API**: `GET /api/admin/reports/financial`
- 添加了库存资产数据查询
- 按产品分类分组显示资产
- 计算总资产价值（按进货价）

### 前端修改 (prototype-working.html)
- 添加了"Inventory Assets"部分
- 显示总资产价值卡片（紫色渐变）
- 按分类展示资产列表（可折叠）
- 每个分类显示：产品数量、总价值、产品详细列表
- 添加了`toggleAssetCategory()`函数

### 功能特点
- 总资产价值统计
- 按产品类型分类显示
- 可折叠的分类详情
- 显示每个产品的库存数量和价值

---

## 2. 供货商和客户编辑功能

### 后端API添加
- `GET /api/admin/suppliers/:id` - 获取单个供货商详情
- `GET /api/admin/customers/:id` - 获取单个客户详情
- 修复了客户编辑时的404错误

### 前端功能实现 (prototype-working.html)

#### 供货商编辑
- `editSupplier(supplierId)` - 显示编辑表单
- `saveSupplierEdit(supplierId)` - 保存修改
- 表单字段：
  - Supplier Code（必填）
  - Supplier Name（必填）
  - Contact Person
  - Phone
  - Email
  - Address
  - Payment Terms（下拉选择）
  - **Tax Number (VAT Number)** - 新增
  - Notes

#### 客户编辑
- `editCustomer(customerId)` - 显示编辑表单
- `saveCustomerEdit(customerId)` - 保存修改
- 表单字段：
  - Customer Code（必填）
  - Customer Name（必填）
  - Contact Person
  - Phone
  - Email
  - Address
  - Payment Terms（下拉选择）
  - **Tax Number (VAT Number)** - 新增
  - Notes

### 数据模型
- 供货商税号：`financial.taxNumber`
- 客户税号：`taxNumber`（根级别）

---

## 3. 库存产品管理 - 过滤已售产品

### 问题
库存产品管理页面显示了已售产品（stockQuantity = 0），导致混淆。

### 解决方案

#### 后端API修改 (app-new.js)

**1. 产品分组API** (`/api/products/groups`)
```javascript
const products = await ProductNew.find({ 
  isActive: true,
  stockQuantity: { $gt: 0 } // 只查询有库存的产品
})
```

**2. 产品分组详情API** (`/api/products/group-details`)
```javascript
const rawProducts = await ProductNew.find({ 
  isActive: true,
  stockQuantity: { $gt: 0 }, // 只查询有库存的产品
  condition: category,
  ...(categoryDoc ? { category: categoryDoc._id } : {})
})
```

**3. 统计API** (`/api/stats`)
```javascript
const stats = {
  totalProducts: await ProductNew.countDocuments({ 
    isActive: true, 
    stockQuantity: { $gt: 0 } 
  }),
  // ... 其他统计也添加了 stockQuantity: { $gt: 0 }
}
```

**4. 产品查询API** (`/api/products`)
- 智能过滤逻辑：
  - **无搜索条件**：只显示有库存的产品
  - **有搜索条件**：显示所有产品（包括已售），支持追溯
  - **明确指定 `includeOutOfStock=true`**：显示所有产品

```javascript
// 如果有搜索条件，允许搜索已售产品（用于追溯）
// 如果没有搜索条件，默认不显示已售产品
if (!search && includeOutOfStock !== 'true') {
  query.stockQuantity = { $gt: 0 };
}
```

### 效果
- ✅ 库存管理页面不显示已售产品
- ✅ 分类卡片只显示有库存的分类
- ✅ 点击分类后只显示有库存的产品
- ✅ 顶部统计只统计有库存的产品
- ✅ 搜索barcode/IMEI/SN时可以找到已售产品（追溯功能）

---

## 4. Financial Reports计算逻辑修正

### 修改内容
- 修改了"Total"为"Total Profit"
- 计算公式：Total Profit = 销售金额 - 采购金额
- Net VAT Payable = 销售税额 - 采购税额 + (盈利部分 × 23/123)

---

## 技术细节

### 数据库查询优化
- 使用MongoDB的`$gt`操作符过滤库存
- 添加了详细的日志输出便于调试
- 保持了向后兼容性

### API设计原则
- 默认行为：不显示已售产品（用户友好）
- 搜索行为：显示所有产品（功能完整）
- 可选参数：`includeOutOfStock=true`（灵活性）

### 前端优化
- 使用模态框显示编辑表单
- 表单验证（必填字段检查）
- 自动刷新列表
- 错误处理和用户提示

---

## 文件修改清单

### 后端文件
- `StockControl-main/app-new.js`
  - 添加了获取单个供货商/客户的API
  - 修改了产品查询API的过滤逻辑
  - 修改了统计API
  - 修改了Financial Reports API
  - 添加了详细的日志输出

### 前端文件
- `StockControl-main/public/prototype-working.html`
  - 实现了供货商编辑功能
  - 实现了客户编辑功能
  - 添加了税号字段
  - 修改了Financial Reports显示
  - 添加了资产列表功能

---

## 测试建议

### 1. 库存管理测试
- [ ] 点击分类，确认只显示有库存的产品
- [ ] 搜索已售产品的序列号，确认可以找到
- [ ] 检查顶部统计数据是否正确

### 2. 编辑功能测试
- [ ] 编辑供货商，添加税号
- [ ] 编辑客户，添加税号
- [ ] 验证必填字段
- [ ] 确认保存后数据正确

### 3. Financial Reports测试
- [ ] 查看资产列表
- [ ] 展开/折叠分类
- [ ] 验证总资产价值计算
- [ ] 检查Total Profit计算

---

## 备份信息
- 备份时间：2026-02-02 02:43:36
- 备份目录：StockControl-main-backup-20260202-024336
- 服务器进程ID：75
- 服务器地址：http://localhost:3000

---

## 下一步建议

1. **采购发票付款功能**
   - 类似销售发票的付款功能
   - 支持混合支付

2. **数据导出功能**
   - Financial Reports导出为CSV
   - 库存报表导出

3. **性能优化**
   - 添加数据库索引
   - 实现分页功能

4. **用户体验改进**
   - 添加加载动画
   - 优化移动端显示
   - 添加快捷键支持

---

## 已知问题
- Mongoose索引重复警告（不影响功能）
- Git未配置（需要手动初始化仓库）

---

## 联系信息
如有问题，请查看：
- 服务器日志：查看控制台输出
- API文档：查看各API的注释
- 测试页面：http://localhost:3000/prototype-working.html
