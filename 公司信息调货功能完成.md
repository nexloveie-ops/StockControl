# 公司信息调货功能 - 实现完成

## 功能概述

根据用户所属公司自动判断调货类型：
- **同一公司** → 内部调拨（成本价，不开发票）
- **不同公司** → 公司间销售（批发价，自动开发票）

## ✅ 已完成的工作

### 1. 数据模型
- ✅ UserNew 模型添加公司信息字段
- ✅ InventoryTransfer 模型添加交易类型和公司信息
- ✅ 创建 InterCompanySalesInvoice 模型（公司间销售发票）

### 2. 管理界面
- ✅ admin.html 添加公司信息表单
- ✅ 支持编辑用户的公司信息
- ✅ 保存和加载公司信息

### 3. 后端逻辑
- ✅ 调货创建时自动判断交易类型
- ✅ 根据交易类型选择价格（成本价 vs 批发价）
- ✅ 完成调货时自动生成销售发票（公司间销售）
- ✅ 计算 VAT（23%）
- ✅ 关联发票到调货记录

## 业务逻辑

### 内部调拨（同一公司）
```
MurrayRanelagh (Murray Mobile Ltd) 
    ↓ 调货
MurrayDundrum (Murray Mobile Ltd)

结果：
- 使用成本价
- 不开发票
- 不计算 VAT
- 库存直接转移
```

### 公司间销售（不同公司）
```
MurrayRanelagh (Murray Mobile Ltd) 
    ↓ 销售
TechStore001 (Tech Store Ltd)

结果：
- 使用批发价
- 自动生成销售发票
- 计算 VAT（23%）
- 包含双方公司信息
- 库存转移
```

## 价格示例

以 iPhone 12 128GB 为例：
- **成本价**: €210
- **批发价**: €235
- **零售价**: €299

### 内部调拨
```
产品价格: €210（成本价）
数量: 1
小计: €210
VAT: €0（不计税）
总计: €210
```

### 公司间销售
```
产品价格: €235（批发价）
数量: 1
小计: €235
VAT: €54.05（23%）
总计: €289.05
```

## 如何测试

### 测试 1: 内部调拨（当前配置）

**当前状态**: 两个用户都属于 "Murray Electronics Limited"

1. 登录 MurrayDundrum (http://localhost:3000/merchant.html)
2. 点击"群组库存"
3. 选择一个产品，点击"调货"
4. 查看价格（应该是成本价）
5. 提交调货申请
6. 登录 MurrayRanelagh 审批
7. MurrayDundrum 确认收货
8. 验证：不生成发票

### 测试 2: 公司间销售

**需要先修改配置**:

1. 登录管理员 (http://localhost:3000/admin.html)
2. 用户管理 → 编辑 MurrayDundrum
3. 修改公司信息为 "Tech Store Limited"
4. 保存

然后按照测试 1 的步骤操作，验证：
- 使用批发价
- 自动生成发票
- 计算 VAT

## 测试脚本

运行测试脚本查看当前配置：
```bash
cd StockControl-main
node test-company-transfer.js
```

输出示例：
```
=== 1. 检查用户公司信息 ===
MurrayRanelagh 公司信息:
  公司名称: Murray Electronics Limited
  VAT号: IE3947563IH

MurrayDundrum 公司信息:
  公司名称: Murray Electronics Limited
  VAT号: IE3947563IH

=== 2. 判断交易类型 ===
✅ 同一公司 → 内部调拨
```

## API 响应示例

### 创建调货（内部调拨）
```json
{
  "success": true,
  "data": {
    "transferNumber": "TRF20260205001",
    "transferType": "INTERNAL_TRANSFER",
    "priceType": "cost",
    "fromCompany": "Murray Electronics Limited",
    "toCompany": "Murray Electronics Limited",
    "message": "内部调拨申请已提交，等待对方审批"
  }
}
```

### 完成调货（公司间销售）
```json
{
  "success": true,
  "data": {
    "transferType": "INTER_COMPANY_SALE",
    "salesInvoiceNumber": "SI-1738761234567-0001",
    "subtotal": 235,
    "vatAmount": 54.05,
    "totalAmount": 289.05,
    "message": "调货完成，销售发票已生成"
  }
}
```

## 数据库查询

### 查看调货记录
```javascript
db.inventorytransfers.find({}).sort({ createdAt: -1 }).limit(5)
```

### 查看销售发票
```javascript
db.intercompanysalesinvoices.find({}).sort({ createdAt: -1 }).limit(5)
```

### 查看用户公司信息
```javascript
db.usernews.find(
  { username: { $in: ['MurrayRanelagh', 'MurrayDundrum'] } },
  { username: 1, 'companyInfo.companyName': 1 }
)
```

## 文件清单

### 新增文件
- `models/InterCompanySalesInvoice.js` - 销售发票模型
- `test-company-transfer.js` - 测试脚本
- `QUICK_TEST_COMPANY_TRANSFER.md` - 测试指南
- `SESSION_SUMMARY_20260205_COMPANY_TRANSFER.md` - 详细总结
- `COMPANY_INFO_PHASE2_COMPLETE.md` - 完成报告

### 修改文件
- `app.js` - 调货 API（第 5792-5940 行，6070-6200 行）
- `PHASE3_TRANSFER_LOGIC_IMPLEMENTATION.md` - 更新状态

## 下一步

### 前端界面优化（待实现）
1. 调货确认对话框显示交易类型
2. 显示价格类型（成本价 vs 批发价）
3. 显示双方公司信息
4. 显示预计金额（含 VAT）
5. 完成后显示发票信息

### 发票功能（待实现）
1. 发票列表页面
2. 发票详情查看
3. 发票打印/导出
4. 付款状态管理

## 常见问题

**Q: 如何判断是内部调拨还是公司间销售？**
A: 系统自动比较双方的公司名称，相同则为内部调拨，不同则为公司间销售。

**Q: 如果用户没有设置公司信息会怎样？**
A: 默认为公司间销售（使用批发价，生成发票）。

**Q: 可以手动选择交易类型吗？**
A: 不可以，系统根据公司信息自动判断，确保准确性。

**Q: 内部调拨为什么不计算 VAT？**
A: 因为是同一公司内部的库存转移，不涉及销售交易，所以不需要计税。

**Q: 批发价和零售价有什么区别？**
A: 
- 批发价：用于公司间销售
- 零售价：用于对终端客户的销售
- 成本价：用于内部调拨

## 技术细节

### 交易类型判断
```javascript
const fromCompany = fromUser.companyInfo?.companyName;
const toCompany = toUser.companyInfo?.companyName;

if (fromCompany && toCompany && fromCompany === toCompany) {
  // 内部调拨
  transferType = 'INTERNAL_TRANSFER';
  price = costPrice;
} else {
  // 公司间销售
  transferType = 'INTER_COMPANY_SALE';
  price = wholesalePrice;
}
```

### VAT 计算
```javascript
const subtotal = 235;           // 小计
const vatRate = 0.23;           // 23%
const vatAmount = 54.05;        // VAT 金额
const totalAmount = 289.05;     // 总计
```

## 总结

✅ **已完成**
- 完整的后端逻辑
- 自动判断交易类型
- 自动生成销售发票
- 正确计算 VAT
- 数据模型完整

⏳ **待完成**
- 前端界面优化
- 发票查看功能

🎯 **业务价值**
- 符合财务规范
- 自动化流程
- 减少人工错误
- 清晰的交易记录

---
**完成日期**: 2026-02-05
**服务器**: http://localhost:3000
**测试状态**: 后端完成，可以开始测试
