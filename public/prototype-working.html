<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»“åº“ç®¡ç†ç³»ç»Ÿ - ä»“ç®¡å‘˜å·¥ä½œå°</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <!-- jsPDFåº“ç”¨äºç”ŸæˆPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #e8ecf0;
      color: #333;
      line-height: 1.6;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 0;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .header-buttons button {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .header-buttons button:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .stats-section {
      margin-bottom: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 4px 16px rgba(0,0,0,0.06);
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid #d1d5db;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
      line-height: 1;
    }
    
    .actions-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover {
      background: #38a169;
      transform: translateY(-1px);
    }
    
    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      padding: 6px;
      margin-bottom: 25px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e8ecf0;
    }
    
    .tab {
      flex: 1;
      padding: 12px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-radius: 8px;
      transition: all 0.3s;
      text-align: center;
    }
    
    .tab:hover {
      color: #667eea;
      background: #f7fafc;
    }
    
    .tab.active {
      color: white;
      background: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 4px 16px rgba(0,0,0,0.06);
      margin-bottom: 20px;
      border: 1px solid #d1d5db;
    }
    
    .card h2 {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .group-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #e8ecf0;
      position: relative;
      overflow: hidden;
    }
    
    .group-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transform: scaleX(0);
      transition: transform 0.3s;
    }
    
    .group-card:hover::before {
      transform: scaleX(1);
    }
    
    .group-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }
    
    .group-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2d3748;
    }
    
    .group-card-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    
    .group-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .stat-item {
      text-align: center;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .loading::before {
      content: 'â³';
      font-size: 24px;
      display: block;
      margin-bottom: 10px;
    }
    
    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #feb2b2;
    }
    
    .success {
      background: #c6f6d5;
      color: #2f855a;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #9ae6b4;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    th, td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      background: #f7fafc;
      transition: all 0.3s;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    
    .upload-text {
      margin-top: 16px;
      color: #6b7280;
      font-size: 14px;
    }
    
    /* Debug panel CSS removed */
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-received {
      background: #c6f6d5;
      color: #2f855a;
    }
    
    .status-pending {
      background: #fef5e7;
      color: #d69e2e;
    }
    
    .operation-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .operation-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }
    
    .operation-card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2d3748;
    }
    
    .operation-card p {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .products-grid {
        grid-template-columns: 1fr;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        text-align: left;
      }
      
      .actions-bar {
        flex-direction: column;
      }
      
      .btn {
        justify-content: center;
      }
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
    }
  </style>
</head>
<body>
  <!-- è°ƒè¯•é¢æ¿å·²ç§»é™¤ -->

  <div class="header">
    <div class="header-content">
      <div>
        <h1>ğŸ“¦ ä»“åº“ç®¡ç†ç³»ç»Ÿ</h1>
        <p>ä»“ç®¡å‘˜å·¥ä½œå° - åº“å­˜ç®¡ç†ä¸å…¥åº“æ“ä½œ</p>
      </div>
      <div class="header-buttons">
        <button onclick="toggleStatsDetails()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; gap: 6px;"
                onmouseover="this.style.background='rgba(255,255,255,0.3)';"
                onmouseout="this.style.background='rgba(255,255,255,0.2)';">
          <span id="toggleStatsIcon">ğŸ“Š</span>
          <span id="toggleStatsText">æŸ¥çœ‹ç»Ÿè®¡</span>
        </button>
        <button onclick="window.location.href='/admin.html'">
          ğŸ“„ ç®¡ç†åå°
        </button>
        <button onclick="logout()">
          ğŸšª é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-section" id="statsDetails" style="display: none;">
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>æ€»äº§å“æ•°</h3>
          <div class="value" id="totalProducts">-</div>
        </div>
        <div class="stat-card">
          <h3>å¯é”€å”®äº§å“</h3>
          <div class="value" id="availableProducts">-</div>
        </div>
        <div class="stat-card">
          <h3>é…ä»¶ç±»äº§å“</h3>
          <div class="value" id="accessories">-</div>
        </div>
        <div class="stat-card">
          <h3>å…¨æ–°è®¾å¤‡</h3>
          <div class="value" id="newDevices">-</div>
        </div>
        <div class="stat-card">
          <h3>äºŒæ‰‹è®¾å¤‡</h3>
          <div class="value" id="usedDevices">-</div>
        </div>
        <div class="stat-card">
          <h3>ä¾›åº”å•†æ•°é‡</h3>
          <div class="value" id="totalSuppliers">-</div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="actions-bar" style="display: none;">
      <!-- æŒ‰é’®å·²ç§»é™¤ï¼šğŸ”„ åˆ·æ–°æ•°æ®, ğŸ” æµ‹è¯•å›¾ç‰‡è¯†åˆ«, ğŸ› è°ƒè¯•é¢æ¿ -->
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('inventory')">
        ğŸ“¦ åº“å­˜ç®¡ç†
      </button>
      <button class="tab" onclick="switchTab('receiving')">
        ğŸ“¥ å…¥åº“ç®¡ç†
      </button>
      <button class="tab" onclick="switchTab('warehouse-orders')">
        ğŸ›’ è®¢å•ç®¡ç†
      </button>
      <button class="tab" onclick="switchTab('partners')">
        ğŸ‘¥ ä¾›è´§å•†/å®¢æˆ·ç®¡ç†
      </button>
      <button class="tab" onclick="switchTab('reports')">
        ğŸ“Š åº“å­˜æŠ¥è¡¨
      </button>
    </div>

    <!-- åº“å­˜ç®¡ç† -->
    <div id="inventory" class="tab-content active">
      <div class="card">
        <h2>ğŸ“¦ åº“å­˜äº§å“ç®¡ç†</h2>
        
        <!-- æœç´¢å’Œç­›é€‰ -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
          <input type="text" id="searchInput" placeholder="æœç´¢äº§å“åç§°ã€æ¡ç ã€IMEI..." 
                 style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
          <select id="categoryFilter" style="padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <option value="">æ‰€æœ‰åˆ†ç±»</option>
            <option value="æ‰‹æœºé…ä»¶">æ‰‹æœºé…ä»¶</option>
            <option value="ç”µè„‘é…ä»¶">ç”µè„‘é…ä»¶</option>
            <option value="è½¦è½½é…ä»¶">è½¦è½½é…ä»¶</option>
            <option value="audio">Audio</option>
            <option value="æ•°æ®çº¿">æ•°æ®çº¿</option>
            <option value="power supply">Power Supply</option>
            <option value="å…¨æ–°è®¾å¤‡">å…¨æ–°è®¾å¤‡</option>
            <option value="äºŒæ‰‹è®¾å¤‡">äºŒæ‰‹è®¾å¤‡</option>
            <option value="ç»´ä¿®">ç»´ä¿®</option>
          </select>
          <button onclick="searchProducts()" class="btn btn-primary">ğŸ” æœç´¢</button>
          <button onclick="loadCategoryCards()" class="btn btn-success">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div id="inventoryContainer">
          <div class="loading">æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...</div>
        </div>
      </div>
    </div>

    <!-- å…¥åº“ç®¡ç† -->
    <div id="receiving" class="tab-content">
      <div class="card">
        <h2>ğŸ“¥ å…¥åº“ç®¡ç†</h2>
        
        <!-- å…¥åº“æ–¹å¼é€‰æ‹© -->
        <div style="display: flex; gap: 15px; margin-bottom: 25px;">
          <button onclick="switchReceivingMode('upload')" id="uploadModeBtn" class="btn btn-primary">
            ğŸ“¤ å‘ç¥¨ä¸Šä¼ å…¥åº“
          </button>
          <button onclick="switchReceivingMode('manual')" id="manualModeBtn" class="btn" style="background: #48bb78; color: white;">
            âœï¸ æ‰‹åŠ¨å½•å…¥å…¥åº“
          </button>
        </div>
        
        <!-- å‘ç¥¨ä¸Šä¼ æ¨¡å¼ -->
        <div id="uploadMode" style="display: block;">
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“„</div>
            <div>
              <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">
                ğŸ“¤ ä¸Šä¼ å‘ç¥¨å›¾ç‰‡
              </button>
              <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
            </div>
            <div class="upload-text">
              æ”¯æŒæ ¼å¼ï¼šJPG, PNG, PDF<br>
              ä¸Šä¼ å‘ç¥¨å›¾ç‰‡è¿›è¡Œæ™ºèƒ½è¯†åˆ«å’Œè‡ªåŠ¨å…¥åº“
            </div>
          </div>
        </div>
        
        <!-- æ‰‹åŠ¨å½•å…¥æ¨¡å¼ -->
        <div id="manualMode" style="display: none;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3>ğŸ“ æ‰‹åŠ¨å½•å…¥äº§å“ä¿¡æ¯</h3>
            
            <!-- é…ä»¶äº§å“å˜ä½“è¯´æ˜ -->
            <div style="background: #e7f3ff; border-left: 4px solid #2196f3; padding: 12px; margin: 15px 0; border-radius: 4px;">
              <div style="display: flex; align-items: start; gap: 8px;">
                <span style="font-size: 18px;">ğŸ’¡</span>
                <div style="flex: 1;">
                  <strong style="color: #1976d2; font-size: 14px;">äº§å“å½•å…¥è¯´æ˜</strong>
                  <p style="margin: 6px 0 0 0; color: #555; font-size: 13px; line-height: 1.5;">
                    <strong>â€¢ è®¾å¤‡äº§å“ï¼ˆæ‰‹æœº/å¹³æ¿/æ‰‹è¡¨ï¼‰ï¼š</strong>é€‰æ‹©åŒ…å«"è®¾å¤‡"ã€"æ‰‹æœº"ã€"Phone"ç­‰å…³é”®å­—çš„åˆ†ç±»åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ˜¾ç¤ºIMEI/SNè¾“å…¥æ¡†<br>
                    <strong>â€¢ é…ä»¶äº§å“ï¼ˆæ‰‹æœºå£³/ä¿æŠ¤è†œ/æ•°æ®çº¿ï¼‰ï¼š</strong>å¡«å†™å“ç‰Œã€å‹å·/è§„æ ¼å’Œé¢œè‰²/ç±»å‹å­—æ®µï¼Œç”¨äºåŒºåˆ†ä¸åŒå˜ä½“
                  </p>
                </div>
              </div>
            </div>
            
            <!-- ä¾›åº”å•†ä¿¡æ¯ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä¾›åº”å•†</label>
                <select id="manualSupplier" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <option value="">é€‰æ‹©ä¾›åº”å•†...</option>
                </select>
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å‘ç¥¨å·ç </label>
                <input type="text" id="manualInvoiceNumber" placeholder="è¾“å…¥å‘ç¥¨å·ç " 
                       style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              </div>
            </div>
            
            <!-- äº§å“ä¿¡æ¯è¡¨å• -->
            <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
              <table style="width: 100%; margin: 0;">
                <thead style="background: #f7fafc;">
                  <tr>
                    <th style="padding: 12px; text-align: left;">äº§å“åç§°</th>
                    <th style="padding: 12px; text-align: left;">å“ç‰Œ</th>
                    <th style="padding: 12px; text-align: left;">å‹å·/è§„æ ¼</th>
                    <th style="padding: 12px; text-align: left;">é¢œè‰²/ç±»å‹</th>
                    <th style="padding: 12px; text-align: left;">åˆ†ç±»</th>
                    <th style="padding: 12px; text-align: left;">æ•°é‡</th>
                    <th style="padding: 12px; text-align: left;">è¿›è´§ä»·</th>
                    <th style="padding: 12px; text-align: left;">æ‰¹å‘ä»·</th>
                    <th style="padding: 12px; text-align: left;">é›¶å”®ä»·</th>
                    <th style="padding: 12px; text-align: left;">ç¨åŠ¡åˆ†ç±»</th>
                    <th style="padding: 12px; text-align: left;">æ¡ç /IMEI/SN</th>
                    <th style="padding: 12px; text-align: left;">æˆè‰²</th>
                    <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="manualProductsTable">
                  <!-- åŠ¨æ€ç”Ÿæˆçš„äº§å“è¡Œ -->
                </tbody>
              </table>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: space-between; margin-top: 20px;">
              <div style="display: flex; gap: 10px;">
                <button onclick="addManualProduct()" class="btn btn-success">
                  â• æ·»åŠ äº§å“
                </button>
                <button onclick="showBatchCreateVariantsModal()" class="btn" style="background: #9f7aea; color: white;">
                  ğŸ“¦ æ‰¹é‡åˆ›å»ºå˜ä½“
                </button>
              </div>
              <div>
                <button onclick="clearManualForm()" class="btn" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0;">
                  ğŸ—‘ï¸ æ¸…ç©º
                </button>
                <button onclick="confirmManualReceiving()" class="btn btn-success">
                  âœ… ç¡®è®¤å…¥åº“
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div id="recognitionResult" style="display: none;"></div>
      </div>
    </div>

    <!-- è®¢å•ç®¡ç† -->
    <div id="warehouse-orders" class="tab-content">
      <div class="card">
        <h2>ğŸ›’ ä»“åº“è®¢å•ç®¡ç†</h2>
        <p style="color: #666; margin-bottom: 20px;">ç®¡ç†å•†æˆ·çš„ä»“åº“è®¢è´§è®¢å•</p>
        
        <!-- ç­›é€‰æ  -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">è®¢å•çŠ¶æ€</label>
            <select id="warehouseOrderStatusFilter" onchange="loadWarehouseOrders()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; min-width: 150px;">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending" selected>å¾…ç¡®è®¤</option>
              <option value="confirmed">å·²ç¡®è®¤</option>
              <option value="shipped">å·²å‘è´§</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;">å•†æˆ·ç­›é€‰</label>
            <input type="text" id="warehouseOrderMerchantFilter" placeholder="è¾“å…¥å•†æˆ·åç§°" onchange="loadWarehouseOrders()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; min-width: 200px;">
          </div>
          
          <div style="display: flex; align-items: flex-end;">
            <button onclick="loadWarehouseOrders()" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              ğŸ”„ åˆ·æ–°
            </button>
          </div>
        </div>
        
        <!-- è®¢å•åˆ—è¡¨ -->
        <div id="warehouseOrdersList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…å¯¹è¯æ¡† -->
    <div id="warehouseOrderDetailModal" class="modal">
      <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeWarehouseOrderDetail()">&times;</span>
        <h2>ğŸ“‹ è®¢å•è¯¦æƒ…</h2>
        <div id="warehouseOrderDetailContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- å‘è´§å¯¹è¯æ¡† -->
    <div id="shipmentModal" class="modal">
      <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
        <span class="close" onclick="closeShipmentModal()">&times;</span>
        <h2>ğŸšš æ ‡è®°å‘è´§</h2>
        <p style="color: #6b7280; margin-bottom: 20px;">
          è¯·ä¸ºæ¯ä¸ªè®¢å•é¡¹ç›®é€‰æ‹©å…·ä½“çš„äº§å“æˆ–å¡«å†™å‘è´§æ•°é‡ã€‚
        </p>
        
        <div id="shipmentItemsList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
          <button onclick="closeShipmentModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            å–æ¶ˆ
          </button>
          <button onclick="confirmShipment()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            âœ… ç¡®è®¤å‘è´§
          </button>
        </div>
      </div>
    </div>

    <!-- ä¾›è´§å•†/å®¢æˆ·ç®¡ç† -->
    <div id="partners" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>ğŸ‘¥ ä¾›è´§å•†/å®¢æˆ·ç®¡ç†</h2>
          <button onclick="showCompanyInfoModal()" class="btn btn-info">
            ğŸ¢ å…¬å¸ä¿¡æ¯è®¾ç½®
          </button>
        </div>
        
        <!-- å­æ ‡ç­¾é¡µ -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">
          <button onclick="switchPartnerTab('suppliers')" id="supplierTabBtn" class="btn btn-primary" style="padding: 8px 16px;">
            ğŸ“¦ ä¾›è´§å•†ç®¡ç†
          </button>
          <button onclick="switchPartnerTab('customers')" id="customerTabBtn" class="btn" style="padding: 8px 16px; background: #f7fafc; color: #4a5568;">
            ğŸ›’ å®¢æˆ·ç®¡ç†
          </button>
          <button onclick="switchPartnerTab('tracking')" id="trackingTabBtn" class="btn" style="padding: 8px 16px; background: #f7fafc; color: #4a5568;">
            ğŸ” äº§å“è¿½æº¯
          </button>
        </div>
        
        <!-- ä¾›è´§å•†ç®¡ç† -->
        <div id="suppliersTab" style="display: block;">
          <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="supplierSearchInput" placeholder="æœç´¢ä¾›è´§å•†åç§°ã€è”ç³»äºº..." 
                   style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <button onclick="searchSuppliers()" class="btn btn-primary">ğŸ” æœç´¢</button>
            <button onclick="showAddSupplierModal()" class="btn btn-success">â• æ·»åŠ ä¾›è´§å•†</button>
          </div>
          
          <div id="suppliersContainer">
            <div class="loading">æ­£åœ¨åŠ è½½ä¾›è´§å•†æ•°æ®...</div>
          </div>
        </div>
        
        <!-- å®¢æˆ·ç®¡ç† -->
        <div id="customersTab" style="display: none;">
          <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="customerSearchInput" placeholder="æœç´¢å®¢æˆ·åç§°ã€è”ç³»äºº..." 
                   style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <button onclick="searchCustomers()" class="btn btn-primary">ğŸ” æœç´¢</button>
            <button onclick="showAddCustomerModal()" class="btn btn-success">â• æ·»åŠ å®¢æˆ·</button>
          </div>
          
          <div id="customersContainer">
            <div class="loading">æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...</div>
          </div>
        </div>
        
        <!-- äº§å“è¿½æº¯ -->
        <div id="trackingTab" style="display: none;">
          <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
            <h3 style="margin-bottom: 10px;">ğŸ” äº§å“è¿½æº¯æŸ¥è¯¢</h3>
            <p style="color: #6b7280; margin: 0;">è¾“å…¥äº§å“åç§°ã€æ¡ç ã€IMEIæˆ–SNå·ç ï¼ŒæŸ¥è¯¢äº§å“çš„å®Œæ•´å†å²è®°å½•</p>
          </div>
          
          <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="trackingSearchInput" placeholder="è¾“å…¥äº§å“åç§°ã€æ¡ç ã€IMEIã€SNå·ç ..." 
                   style="flex: 1; min-width: 300px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <button onclick="searchProductTracking()" class="btn btn-primary">ğŸ” æŸ¥è¯¢è¿½æº¯</button>
          </div>
          
          <div id="trackingContainer">
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ”</div>
              <h3>è¯·è¾“å…¥æŸ¥è¯¢æ¡ä»¶</h3>
              <p>è¾“å…¥äº§å“ä¿¡æ¯å¼€å§‹è¿½æº¯æŸ¥è¯¢</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº“å­˜æŠ¥è¡¨ -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>ğŸ“Š Financial Reports</h2>
        
        <!-- æŸ¥è¯¢æ¡ä»¶ -->
        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Start Date</label>
              <input type="date" id="reportStartDate" 
                     style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">End Date</label>
              <input type="date" id="reportEndDate" 
                     style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Type</label>
              <select id="reportType" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                <option value="all">All</option>
                <option value="sales">Sales Only</option>
                <option value="purchase">Purchase Only</option>
              </select>
            </div>
            <div>
              <button onclick="loadFinancialReport()" class="btn btn-primary" style="width: 100%; padding: 10px;">
                ğŸ” Query
              </button>
            </div>
          </div>
        </div>
        
        <div id="reportsContainer">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <h3>Select date range and click Query</h3>
            <p>Financial report will be generated based on your selection</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- é€šç”¨æ¨¡æ€æ¡† -->
  <div id="universalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; max-width: 90%; max-height: 90%; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="universalModalTitle" style="margin: 0; font-size: 20px;">æ ‡é¢˜</h3>
        <button onclick="closeUniversalModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 0; width: 30px; height: 30px;">&times;</button>
      </div>
      <div id="universalModalBody" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 100px);">
        å†…å®¹
      </div>
    </div>
  </div>

  <!-- æ‰¹é‡åˆ›å»ºå˜ä½“æ¨¡æ€æ¡† -->
  <div id="batchVariantsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; overflow-y: auto;">
    <div style="max-width: 800px; margin: 50px auto; background: white; border-radius: 12px; padding: 30px;">
      <h2 style="margin-bottom: 20px;">ğŸ“¦ æ‰¹é‡åˆ›å»ºäº§å“å˜ä½“</h2>
      <p style="color: #718096; margin-bottom: 25px;">é€‚ç”¨äºé…ä»¶ç±»äº§å“ï¼ˆæ‰‹æœºå£³ã€å±å¹•ä¿æŠ¤è†œã€æ•°æ®çº¿ç­‰ï¼‰ï¼Œæ”¯æŒå‹å·å’Œé¢œè‰²ä¸¤ä¸ªç»´åº¦çš„ç»„åˆ</p>
      
      <form id="batchVariantsForm" onsubmit="createBatchVariants(event)" style="margin-top: 25px;">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div style="margin-bottom: 25px;">
          <h3 style="font-size: 16px; margin-bottom: 15px; color: #4a5568;">åŸºæœ¬ä¿¡æ¯</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“åç§° *</label>
              <input type="text" id="batchProductName" required placeholder="ä¾‹å¦‚: iPhone Clear Case"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">å“ç‰Œ</label>
              <input type="text" id="batchBrand" placeholder="ä¾‹å¦‚: Generic"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">åˆ†ç±» *</label>
              <select id="batchCategory" required
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">è®¢å•å·ï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" id="batchInvoiceNumber" placeholder="ä¾‹å¦‚: INV-2024-001"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              <small style="color: #718096; font-size: 11px;">å¦‚æœè®¢å•å·²å­˜åœ¨ï¼Œå°†æ·»åŠ åˆ°è¯¥è®¢å•ï¼›å¦åˆ™åˆ›å»ºæ–°è®¢å•</small>
            </div>
          </div>
        </div>

        <!-- ç»´åº¦1 -->
        <div style="margin-bottom: 25px;">
          <h3 style="font-size: 16px; margin-bottom: 15px; color: #4a5568;">ç»´åº¦1ï¼ˆå‹å·/å°ºå¯¸/å®¹é‡/åŠŸç‡ç­‰ï¼‰</h3>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç»´åº¦æ ‡ç­¾</label>
            <select id="batchDimension1Label"
                    style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              <option value="Model">å‹å· (Model)</option>
              <option value="Size">å°ºå¯¸ (Size)</option>
              <option value="Capacity">å®¹é‡ (Capacity)</option>
              <option value="Power">åŠŸç‡ (Power)</option>
              <option value="Length">é•¿åº¦ (Length)</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">é€‰é¡¹åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰*</label>
            <textarea id="batchDimension1Values" required rows="4" placeholder="ä¾‹å¦‚:&#10;iPhone 13&#10;iPhone 14&#10;iPhone 14 Pro"
                      oninput="updateVariantPreview()"
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: monospace;"></textarea>
          </div>
        </div>

        <!-- ç»´åº¦2 -->
        <div style="margin-bottom: 25px;">
          <h3 style="font-size: 16px; margin-bottom: 15px; color: #4a5568;">ç»´åº¦2ï¼ˆé¢œè‰²/ç±»å‹/æè´¨ç­‰ï¼‰</h3>
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç»´åº¦æ ‡ç­¾</label>
            <select id="batchDimension2Label"
                    style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              <option value="Color">é¢œè‰² (Color)</option>
              <option value="Type">ç±»å‹ (Type)</option>
              <option value="Material">æè´¨ (Material)</option>
              <option value="Finish">è¡¨é¢å¤„ç† (Finish)</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">é€‰é¡¹åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰*</label>
            <textarea id="batchDimension2Values" required rows="4" placeholder="ä¾‹å¦‚:&#10;Clear&#10;Black&#10;Blue"
                      oninput="updateVariantPreview()"
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: monospace;"></textarea>
          </div>
        </div>

        <!-- ç»Ÿä¸€ä»·æ ¼ -->
        <div style="margin-bottom: 25px;">
          <h3 style="font-size: 16px; margin-bottom: 15px; color: #4a5568;">ç»Ÿä¸€ä»·æ ¼ï¼ˆæ‰€æœ‰å˜ä½“ä½¿ç”¨ç›¸åŒä»·æ ¼ï¼‰</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆæœ¬ä»· (â‚¬) *</label>
              <input type="number" id="batchCostPrice" required step="0.01" min="0" placeholder="5.00"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ‰¹å‘ä»· (â‚¬) *</label>
              <input type="number" id="batchWholesalePrice" required step="0.01" min="0" placeholder="8.00"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">é›¶å”®ä»· (â‚¬) *</label>
              <input type="number" id="batchRetailPrice" required step="0.01" min="0" placeholder="12.00"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
        </div>

        <!-- å…¶ä»–è®¾ç½® -->
        <div style="margin-bottom: 25px;">
          <h3 style="font-size: 16px; margin-bottom: 15px; color: #4a5568;">å…¶ä»–è®¾ç½®</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä¾›è´§å•† *</label>
              <select id="batchSupplier" required
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="">è¯·é€‰æ‹©ä¾›è´§å•†</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä½ç½® *</label>
              <input type="text" id="batchLocation" required placeholder="ä¾‹å¦‚: A1-01"
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç¨åŠ¡åˆ†ç±» *</label>
              <select id="batchTaxClassification" required
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="">è¯·é€‰æ‹©ç¨ç‡</option>
                <option value="VAT 23%">VAT 23%</option>
                <option value="VAT 13.5%">VAT 13.5%</option>
                <option value="VAT 0%">VAT 0%</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆè‰² *</label>
              <select id="batchCondition" required
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="">è¯·é€‰æ‹©æˆè‰²</option>
              </select>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">åˆå§‹åº“å­˜</label>
            <input type="number" id="batchInitialQuantity" value="0" min="0"
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            <small style="color: #718096;">é»˜è®¤ä¸º0ï¼Œåç»­é€šè¿‡å…¥åº“å¢åŠ åº“å­˜</small>
          </div>
          <div style="margin-top: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
            <textarea id="batchNotes" rows="2" placeholder="å¯é€‰"
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;"></textarea>
          </div>
        </div>

        <!-- é¢„è§ˆ -->
        <div id="variantPreview" style="margin-bottom: 25px; padding: 15px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
          <h3 style="font-size: 16px; margin-bottom: 10px; color: #4a5568;">ğŸ“Š é¢„è§ˆ</h3>
          <p id="variantPreviewText" style="color: #718096; font-size: 14px;">è¯·å¡«å†™ç»´åº¦é€‰é¡¹ä»¥æŸ¥çœ‹é¢„è§ˆ</p>
        </div>

        <!-- æŒ‰é’® -->
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
          <button type="button" onclick="closeBatchVariantsModal()" class="btn btn-secondary">
            å–æ¶ˆ
          </button>
          <button type="submit" class="btn" style="background: #9f7aea; color: white;">
            æ‰¹é‡åˆ›å»ºæ‰€æœ‰å˜ä½“
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    // debugVisible variable removed since debug panel is removed

    // è°ƒè¯•æ—¥å¿— - åªè¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆè°ƒè¯•é¢æ¿å·²ç§»é™¤ï¼‰
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
    }

    // å…³é—­é€šç”¨æ¨¡æ€æ¡†
    function closeUniversalModal() {
      document.getElementById('universalModal').style.display = 'none';
    }

    // æ˜¾ç¤ºé€šç”¨æ¨¡æ€æ¡†
    function showUniversalModal(title, content) {
      document.getElementById('universalModalTitle').textContent = title;
      document.getElementById('universalModalBody').innerHTML = content;
      document.getElementById('universalModal').style.display = 'flex';
    }

    // åˆ‡æ¢è°ƒè¯•é¢æ¿ - å·²ç§»é™¤
    /*
    function toggleDebugPanel() {
      const panel = document.getElementById('debugPanel');
      debugVisible = !debugVisible;
      panel.style.display = debugVisible ? 'block' : 'none';
    }
    */

    // å±•å¼€/æ”¶èµ·ç»Ÿè®¡è¯¦æƒ…
    function toggleStatsDetails() {
      const statsDetails = document.getElementById('statsDetails');
      const toggleIcon = document.getElementById('toggleStatsIcon');
      const toggleText = document.getElementById('toggleStatsText');
      
      if (statsDetails.style.display === 'none') {
        // å±•å¼€
        statsDetails.style.display = 'block';
        toggleIcon.textContent = 'ğŸ“ˆ';
        toggleText.textContent = 'æ”¶èµ·ç»Ÿè®¡';
      } else {
        // æ”¶èµ·
        statsDetails.style.display = 'none';
        toggleIcon.textContent = 'ğŸ“Š';
        toggleText.textContent = 'æŸ¥çœ‹ç»Ÿè®¡';
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      debugLog(`åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tabName}`);
      
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'inventory': loadCategoryCards(); break;
        case 'receiving': break;
        case 'warehouse-orders': loadWarehouseOrders(); break;
        case 'partners': switchPartnerTab('suppliers'); break;
        case 'reports': loadReports(); break;
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      debugLog('å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®');
      try {
        const response = await fetch('/api/stats');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`ç»Ÿè®¡APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success && result.data) {
          const stats = result.data;
          document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
          document.getElementById('availableProducts').textContent = stats.availableProducts || 0;
          document.getElementById('accessories').textContent = stats.productsByCategory?.accessories || 0;
          document.getElementById('newDevices').textContent = stats.productsByCategory?.newDevices || 0;
          document.getElementById('usedDevices').textContent = stats.productsByCategory?.usedDevices || 0;
          document.getElementById('totalSuppliers').textContent = stats.totalSuppliers || 0;
          
          debugLog('âœ… ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸ');
        } else {
          throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        debugLog(`âŒ ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
      }
    }

    // åŠ è½½åˆ†ç±»å¡ç‰‡
    async function loadCategoryCards() {
      debugLog('å¼€å§‹åŠ è½½åˆ†ç±»å¡ç‰‡');
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch('/api/products');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`äº§å“APIå“åº”: ${result.data?.length || 0} ä¸ªäº§å“`);
        
        if (result.success && result.data && result.data.length > 0) {
          renderCategoryCards(result.data);
          debugLog('âœ… åˆ†ç±»å¡ç‰‡åŠ è½½æˆåŠŸ');
        } else {
          container.innerHTML = '<div>æš‚æ— åº“å­˜äº§å“æ•°æ®</div>';
          debugLog('âš ï¸ æ²¡æœ‰åº“å­˜äº§å“æ•°æ®');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        debugLog(`âŒ åˆ†ç±»å¡ç‰‡åŠ è½½å¤±è´¥: ${error.message}`);
      }
    }

    // æ¸²æŸ“åˆ†ç±»å¡ç‰‡
    function renderCategoryCards(products) {
      const container = document.getElementById('inventoryContainer');
      
      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <h3>æš‚æ— åº“å­˜äº§å“</h3>
            <p>è¯·å…ˆè¿›è¡Œå…¥åº“æ“ä½œ</p>
          </div>
        `;
        return;
      }
      
      // æŒ‰åˆ†ç±»åˆ†ç»„äº§å“
      const categories = {};
      products.forEach(product => {
        const category = product.productType || 'æœªåˆ†ç±»';
        if (!categories[category]) {
          categories[category] = [];
        }
        categories[category].push(product);
      });
      
      // ç”Ÿæˆåˆ†ç±»å¡ç‰‡HTML
      const html = `
        <div class="products-grid">
          ${Object.entries(categories).map(([category, categoryProducts]) => {
            const totalQuantity = categoryProducts.reduce((sum, p) => sum + (p.stockQuantity || p.quantity || 0), 0);
            const totalValue = categoryProducts.reduce((sum, p) => sum + ((p.costPrice || p.purchasePrice || 0) * (p.stockQuantity || p.quantity || 0)), 0);
            const lowStockCount = categoryProducts.filter(p => (p.stockQuantity || p.quantity || 0) < 5).length;
            
            return `
              <div class="group-card" onclick="showCategoryProducts('${category}')">
                <div class="group-card-title">${getCategoryIcon(category)} ${category}</div>
                <div class="group-card-subtitle">${categoryProducts.length} ç§äº§å“</div>
                <div class="group-stats">
                  <div class="stat-item">
                    <div class="stat-label">æ€»åº“å­˜</div>
                    <div class="stat-value">${totalQuantity}</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">åº“å­˜ä»·å€¼</div>
                    <div class="stat-value">â‚¬${totalValue.toFixed(0)}</div>
                  </div>
                  <div class="stat-item" style="display: none;">
                    <div class="stat-label">ä½åº“å­˜</div>
                    <div class="stat-value" style="color: ${lowStockCount > 0 ? '#e53e3e' : '#48bb78'}">${lowStockCount}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    // è·å–åˆ†ç±»å›¾æ ‡
    function getCategoryIcon(category) {
      const icons = {
        'æ‰‹æœºé…ä»¶': 'ğŸ“±',
        'ç”µè„‘é…ä»¶': 'ğŸ’»',
        'è½¦è½½é…ä»¶': 'ğŸš—',
        'audio': 'ğŸµ',
        'æ•°æ®çº¿': 'ğŸ”Œ',
        'power supply': 'ğŸ”‹',
        'å…¨æ–°è®¾å¤‡': 'ğŸ“¦',
        'äºŒæ‰‹è®¾å¤‡': 'â™»ï¸',
        'ç»´ä¿®': 'ğŸ”§',
        'æœªåˆ†ç±»': 'ğŸ“‹'
      };
      return icons[category] || 'ğŸ“‹';
    }

    // å…¨å±€å˜é‡ï¼šå½“å‰æŸ¥çœ‹çš„åˆ†ç±»
    let currentViewingCategory = null;

    // æ˜¾ç¤ºåˆ†ç±»ä¸‹çš„äº§å“
    function showCategoryProducts(category) {
      debugLog(`æ˜¾ç¤ºåˆ†ç±»äº§å“: ${category}`);
      
      // ä¿å­˜å½“å‰åˆ†ç±»
      currentViewingCategory = category;
      
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 98vw; width: 1500px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>${getCategoryIcon(category)} ${category} - äº§å“ç®¡ç†</h3>
            <button onclick="closeCategoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          <div id="categoryProductsContainer">
            <div class="loading">æ­£åœ¨åŠ è½½äº§å“...</div>
          </div>
        </div>
      `;
      
      // ä½¿ç”¨createModalåˆ›å»ºæ¨¡æ€çª—å£ï¼Œç¡®ä¿æ­£ç¡®çš„z-index
      const modal = createModal(content, 9000); // ä½¿ç”¨è¾ƒä½çš„z-indexä½œä¸ºåŸºç¡€å±‚
      modal.id = 'categoryModal';
      
      // åŠ è½½è¯¥åˆ†ç±»çš„äº§å“
      loadCategoryProductDetails(category);
    }

    // å…³é—­åˆ†ç±»å¼¹çª—
    function closeCategoryModal() {
      const modal = document.getElementById('categoryModal');
      if (modal) {
        modal.remove();
        currentViewingCategory = null; // æ¸…é™¤å½“å‰åˆ†ç±»
        debugLog('åˆ†ç±»å¼¹çª—å·²å…³é—­');
      }
    }

    // åŠ è½½åˆ†ç±»äº§å“è¯¦æƒ…
    async function loadCategoryProductDetails(category) {
      debugLog(`åŠ è½½åˆ†ç±»äº§å“è¯¦æƒ…: ${category}`);
      
      try {
        const response = await fetch(`/api/products?category=${encodeURIComponent(category)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const products = result.data || [];
        
        debugLog(`åˆ†ç±» "${category}" çš„äº§å“æ•°é‡: ${products.length}`);
        
        const container = document.getElementById('categoryProductsContainer');
        if (products.length === 0) {
          container.innerHTML = '<div>è¯¥åˆ†ç±»ä¸‹æš‚æ— äº§å“</div>';
          return;
        }
        
        // æŒ‰äº§å“åç§°åˆ†ç»„ï¼ˆç”¨äºé…ä»¶å˜ä½“ï¼‰
        const productGroups = {};
        products.forEach(product => {
          const productName = product.name;
          const hasVariants = product.source === 'AdminInventory' && (product.model || product.color);
          
          if (hasVariants) {
            // é…ä»¶äº§å“ï¼šæŒ‰åç§°åˆ†ç»„
            if (!productGroups[productName]) {
              productGroups[productName] = {
                name: productName,
                variants: [],
                totalQuantity: 0,
                avgCostPrice: 0,
                avgWholesalePrice: 0,
                avgRetailPrice: 0,
                isVariantGroup: true
              };
            }
            productGroups[productName].variants.push(product);
            productGroups[productName].totalQuantity += (product.stockQuantity || product.quantity || 0);
          } else {
            // æ™®é€šäº§å“ï¼šå•ç‹¬æ˜¾ç¤º
            const key = `${productName}_${product._id}`;
            productGroups[key] = {
              name: productName,
              product: product,
              isVariantGroup: false
            };
          }
        });
        
        // è®¡ç®—å˜ä½“ç»„çš„å¹³å‡ä»·æ ¼
        Object.values(productGroups).forEach(group => {
          if (group.isVariantGroup && group.variants.length > 0) {
            group.avgCostPrice = group.variants.reduce((sum, v) => sum + (v.costPrice || 0), 0) / group.variants.length;
            group.avgWholesalePrice = group.variants.reduce((sum, v) => sum + (v.wholesalePrice || 0), 0) / group.variants.length;
            group.avgRetailPrice = group.variants.reduce((sum, v) => sum + (v.retailPrice || 0), 0) / group.variants.length;
          }
        });
        
        const html = `
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>æ•°é‡</th>
                  <th>è¿›è´§ä»·ï¼ˆå«ç¨ï¼‰</th>
                  <th>æ‰¹å‘ä»·</th>
                  <th>é›¶å”®ä»·</th>
                  <th>ä½ç½®</th>
                  <th>çŠ¶æ€</th>
                  <th>ç®¡ç†æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(productGroups).map(([key, group]) => {
                  if (group.isVariantGroup) {
                    // å˜ä½“ç»„ï¼šæ˜¾ç¤ºæ±‡æ€»è¡Œ + å¯å±•å¼€çš„å˜ä½“åˆ—è¡¨
                    const groupId = key.replace(/\s+/g, '-');
                    const statusBadge = group.totalQuantity > 0 ? 
                      '<span class="status-badge status-received">âœ… æœ‰åº“å­˜</span>' :
                      '<span class="status-badge status-pending">âŒ ç¼ºè´§</span>';
                    
                    return `
                      <tr style="background: #f8fafc; cursor: pointer;" onclick="toggleVariants('${groupId}')">
                        <td style="font-weight: 600;">
                          <span style="color: #667eea;">
                            â–¶ ${group.name}
                          </span>
                          <br>
                          <small style="color: #6b7280;">${group.variants.length} ä¸ªå˜ä½“</small>
                        </td>
                        <td style="text-align: center; font-weight: 600; color: #059669;">
                          ${group.totalQuantity}
                        </td>
                        <td style="color: #059669;">â‚¬${group.avgCostPrice.toFixed(2)}</td>
                        <td style="color: #d69e2e;">â‚¬${group.avgWholesalePrice.toFixed(2)}</td>
                        <td style="color: #7c3aed;">â‚¬${group.avgRetailPrice.toFixed(2)}</td>
                        <td>-</td>
                        <td>${statusBadge}</td>
                        <td>
                          <button onclick="event.stopPropagation(); toggleVariants('${groupId}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white;">
                            ğŸ“‹ æŸ¥çœ‹å˜ä½“
                          </button>
                        </td>
                      </tr>
                      <tr id="variants-${groupId}" style="display: none;">
                        <td colspan="8" style="padding: 0;">
                          <div style="background: #f1f5f9; padding: 15px;">
                            <table style="width: 100%; margin: 0;">
                              <thead>
                                <tr style="background: #e2e8f0;">
                                  <th>å‹å·</th>
                                  <th>é¢œè‰²</th>
                                  <th>æ•°é‡</th>
                                  <th>è¿›è´§ä»·</th>
                                  <th>æ‰¹å‘ä»·</th>
                                  <th>é›¶å”®ä»·</th>
                                  <th>æ“ä½œ</th>
                                </tr>
                              </thead>
                              <tbody>
                                ${group.variants.map(variant => {
                                  const stockQuantity = variant.stockQuantity || variant.quantity || 0;
                                  return `
                                    <tr>
                                      <td>${variant.model || '-'}</td>
                                      <td>${variant.color || '-'}</td>
                                      <td style="text-align: center; font-weight: 600; color: ${stockQuantity > 0 ? '#059669' : '#c53030'};">
                                        ${stockQuantity}
                                      </td>
                                      <td style="color: #059669;">â‚¬${(variant.costPrice || 0).toFixed(2)}</td>
                                      <td style="color: #d69e2e;">â‚¬${(variant.wholesalePrice || 0).toFixed(2)}</td>
                                      <td style="color: #7c3aed;">â‚¬${(variant.retailPrice || 0).toFixed(2)}</td>
                                      <td>
                                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                          <button onclick="adjustPrice('${variant._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white;">
                                            ğŸ’° è°ƒä»·
                                          </button>
                                          <button onclick="adjustQuantity('${variant._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #48bb78; color: white;">
                                            ğŸ“Š è°ƒé‡
                                          </button>
                                        </div>
                                      </td>
                                    </tr>
                                  `;
                                }).join('')}
                              </tbody>
                            </table>
                          </div>
                        </td>
                      </tr>
                    `;
                  } else {
                    // æ™®é€šäº§å“ï¼šåŸæœ‰æ˜¾ç¤ºé€»è¾‘
                    const product = group.product;
                    const stockQuantity = product.stockQuantity || product.quantity || 0;
                    const hasSerialNumbers = product.serialNumbers && product.serialNumbers.length > 0;
                    const statusBadge = stockQuantity > 0 ? 
                      '<span class="status-badge status-received">âœ… æœ‰åº“å­˜</span>' :
                      '<span class="status-badge status-pending">âŒ ç¼ºè´§</span>';
                    
                    const locationDisplay = product.location?.fullLocation || 'æœªè®¾ç½®';
                    
                    let serialInfo = '';
                    if (hasSerialNumbers) {
                      const availableSerialNumbers = product.serialNumbers
                        .filter(sn => sn.status === 'available')
                        .map(sn => sn.serialNumber);
                      const serialCount = availableSerialNumbers.length;
                      serialInfo = `
                        <br>
                        <small style="color: #6b7280; cursor: pointer;" onclick="toggleSerialNumbers('${product._id}')">
                          ğŸ“± å¯é”€å”®åºåˆ—å· (${serialCount}ä¸ª)${product.color ? ` - ${product.color}` : ''} 
                          <span style="color: #3b82f6;">ç‚¹å‡»æŸ¥çœ‹</span>
                        </small>
                        <div id="serial-${product._id}" style="display: none; margin-top: 5px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 11px;">
                          ${availableSerialNumbers.map((sn, index) => `
                            <div style="cursor: pointer; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; background: #e0f2fe;" 
                                 onclick="editProductBySerial('${product._id}', '${sn}', '${product.name.replace(/'/g, "\\'")}')">
                              ${index + 1}. ${sn}${product.color ? ` - ${product.color}` : ''} 
                              <span style="color: #0369a1; font-size: 10px;">ç‚¹å‡»ç¼–è¾‘</span>
                            </div>
                          `).join('')}
                        </div>
                      `;
                    } else if (product.barcode) {
                      serialInfo = `<br><small style="color: #6b7280;">æ¡ç : ${product.barcode}${product.color ? ` - ${product.color}` : ''}</small>`;
                    }
                    
                    return `
                      <tr>
                        <td style="font-weight: 600;">
                          <span style="color: #667eea; cursor: pointer; text-decoration: underline;" 
                                onclick="showProductInvoices('${product._id}', '${product.name.replace(/'/g, "\\'")}')">
                            ${product.name}
                          </span>
                          ${serialInfo}
                        </td>
                        <td style="text-align: center; font-weight: 600; color: ${stockQuantity > 0 ? '#059669' : '#c53030'};">
                          ${stockQuantity}
                        </td>
                        <td style="color: #059669;">â‚¬${(product.costPrice || product.purchasePrice || 0).toFixed(2)}</td>
                        <td style="color: #d69e2e;">â‚¬${(product.wholesalePrice || 0).toFixed(2)}</td>
                        <td style="color: #7c3aed;">â‚¬${(product.retailPrice || product.suggestedRetailPrice || 0).toFixed(2)}</td>
                        <td>${locationDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>
                          <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="adjustPrice('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white;">
                              ğŸ’° è°ƒä»·
                            </button>
                            ${!hasSerialNumbers ? `
                            <button onclick="adjustQuantity('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #48bb78; color: white;">
                              ğŸ“Š è°ƒé‡
                            </button>
                            ` : ''}
                            <button onclick="setLocation('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #ed8936; color: white;">
                              ğŸ“ ä½ç½®
                            </button>
                            <button onclick="changeStatus('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #9f7aea; color: white;">
                              ğŸ·ï¸ çŠ¶æ€
                            </button>
                          </div>
                        </td>
                      </tr>
                    `;
                  }
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      } catch (error) {
        debugLog(`âŒ åŠ è½½åˆ†ç±»äº§å“å¤±è´¥: ${error.message}`);
        document.getElementById('categoryProductsContainer').innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // åˆ‡æ¢å˜ä½“æ˜¾ç¤º
    function toggleVariants(groupId) {
      const variantsRow = document.getElementById(`variants-${groupId}`);
      const mainRow = variantsRow.previousElementSibling;
      const arrow = mainRow.querySelector('span');
      
      if (variantsRow.style.display === 'none') {
        variantsRow.style.display = 'table-row';
        arrow.textContent = arrow.textContent.replace('â–¶', 'â–¼');
      } else {
        variantsRow.style.display = 'none';
        arrow.textContent = arrow.textContent.replace('â–¼', 'â–¶');
      }
    }

    // åŠ è½½åº“å­˜äº§å“æ•°æ® (ä¿ç•™ç”¨äºå…¼å®¹)
    async function loadInventoryProducts() {
      await loadCategoryCards();
    }

    // æœç´¢äº§å“
    function searchProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      
      debugLog(`æœç´¢äº§å“: "${searchTerm}", åˆ†ç±»: "${categoryFilter}"`);
      
      // å¦‚æœæœ‰åˆ†ç±»ç­›é€‰ï¼Œç›´æ¥æ˜¾ç¤ºè¯¥åˆ†ç±»çš„äº§å“
      if (categoryFilter) {
        showCategoryProducts(categoryFilter);
        return;
      }
      
      // å¦‚æœæœ‰æœç´¢è¯ï¼Œæ‰§è¡Œæœç´¢
      if (searchTerm) {
        searchProductsByTerm(searchTerm);
        return;
      }
      
      // å¦åˆ™é‡æ–°åŠ è½½åˆ†ç±»å¡ç‰‡
      loadCategoryCards();
    }

    // æŒ‰æœç´¢è¯æœç´¢äº§å“
    async function searchProductsByTerm(searchTerm) {
      debugLog(`æŒ‰æœç´¢è¯æœç´¢: ${searchTerm}`);
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
      
      try {
        const response = await fetch(`/api/products?search=${encodeURIComponent(searchTerm)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const products = result.data || [];
        
        if (products.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ”</div>
              <h3>æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</h3>
              <p>è¯·å°è¯•å…¶ä»–æœç´¢è¯</p>
            </div>
          `;
          return;
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœè¡¨æ ¼
        const html = `
          <div style="margin-bottom: 15px;">
            <h3>ğŸ” æœç´¢ç»“æœ (${products.length} ä¸ªäº§å“)</h3>
            <button onclick="loadCategoryCards()" class="btn btn-primary" style="margin-left: 10px;">è¿”å›åˆ†ç±»è§†å›¾</button>
          </div>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>åˆ†ç±»</th>
                  <th>æ•°é‡</th>
                  <th>è¿›è´§ä»·ï¼ˆå«ç¨ï¼‰</th>
                  <th>æ‰¹å‘ä»·</th>
                  <th>é›¶å”®ä»·</th>
                  <th>ä½ç½®</th>
                  <th>çŠ¶æ€</th>
                  <th>ç®¡ç†æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${products.map(product => {
                  const stockQuantity = product.stockQuantity || product.quantity || 0;
                  const hasSerialNumbers = product.serialNumbers && product.serialNumbers.length > 0;
                  const statusBadge = stockQuantity > 0 ? 
                    '<span class="status-badge status-received">âœ… æœ‰åº“å­˜</span>' :
                    '<span class="status-badge status-pending">âŒ ç¼ºè´§</span>';
                  
                  // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                  const locationDisplay = product.location?.fullLocation || 'æœªè®¾ç½®';
                  
                  // æ˜¾ç¤ºåºåˆ—å·ä¿¡æ¯ï¼ˆéšè—ï¼Œç‚¹å‡»æ˜¾ç¤ºï¼‰- åªæ˜¾ç¤ºå¯é”€å”®çš„
                  let serialInfo = '';
                  if (hasSerialNumbers) {
                    // åªæ˜¾ç¤ºçŠ¶æ€ä¸º available çš„åºåˆ—å·
                    const availableSerialNumbers = product.serialNumbers
                      .filter(sn => sn.status === 'available')
                      .map(sn => sn.serialNumber);
                    const serialCount = availableSerialNumbers.length;
                    serialInfo = `
                      <br>
                      <small style="color: #6b7280; cursor: pointer;" onclick="toggleSerialNumbers('${product._id}')">
                        ğŸ“± å¯é”€å”®åºåˆ—å· (${serialCount}ä¸ª)${product.color ? ` - ${product.color}` : ''} 
                        <span style="color: #3b82f6;">ç‚¹å‡»æŸ¥çœ‹</span>
                      </small>
                      <div id="serial-${product._id}" style="display: none; margin-top: 5px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 11px;">
                        ${availableSerialNumbers.map((sn, index) => `<div>${index + 1}. ${sn}</div>`).join('')}
                      </div>
                    `;
                  } else if (product.barcode) {
                    serialInfo = `<br><small style="color: #6b7280;">æ¡ç : ${product.barcode}${product.color ? ` - ${product.color}` : ''}</small>`;
                  }
                  
                  return `
                    <tr>
                      <td style="font-weight: 600;">
                        <span style="color: #667eea; cursor: pointer; text-decoration: underline;" 
                              onclick="showProductInvoices('${product._id}', '${product.name.replace(/'/g, "\\'")}')">
                          ${product.name}
                        </span>
                        ${serialInfo}
                      </td>
                      <td>${product.productType || '-'}</td>
                      <td style="text-align: center; font-weight: 600; color: ${stockQuantity > 0 ? '#059669' : '#c53030'};">
                        ${stockQuantity}
                      </td>
                      <td style="color: #059669;">â‚¬${(product.costPrice || product.purchasePrice || 0).toFixed(2)}</td>
                      <td style="color: #d69e2e;">â‚¬${(product.wholesalePrice || 0).toFixed(2)}</td>
                      <td style="color: #7c3aed;">â‚¬${(product.retailPrice || product.suggestedRetailPrice || 0).toFixed(2)}</td>
                      <td>${locationDisplay}</td>
                      <td>${statusBadge}</td>
                      <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                          <button onclick="adjustPrice('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white;">
                            ğŸ’° è°ƒä»·
                          </button>
                          ${!hasSerialNumbers ? `
                          <button onclick="adjustQuantity('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #48bb78; color: white;">
                            ğŸ“Š è°ƒé‡
                          </button>
                          ` : ''}
                          <button onclick="setLocation('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #ed8936; color: white;">
                            ğŸ“ ä½ç½®
                          </button>
                          <button onclick="changeStatus('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #9f7aea; color: white;">
                            ğŸ·ï¸ çŠ¶æ€
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
      }
    }

    // å…³é—­æ¨¡æ€çª—å£ï¼ˆæ”¯æŒåµŒå¥—æ¨¡æ€çª—å£ï¼‰
    function closeModal() {
      // æ‰¾åˆ°æ‰€æœ‰æ¨¡æ€çª—å£ï¼ŒæŒ‰z-indexæ’åºï¼Œå…³é—­æœ€é¡¶å±‚çš„
      // åªæŸ¥æ‰¾çœŸæ­£çš„æ¨¡æ€çª—å£ï¼ˆæœ‰èƒŒæ™¯é®ç½©ä¸”z-index >= 9000ï¼‰
      const modals = Array.from(document.querySelectorAll('[style*="position: fixed"]')).filter(modal => {
        const zIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
        const hasOverlay = modal.style.background && modal.style.background.includes('rgba');
        return zIndex >= 9000 && hasOverlay;
      });
      
      if (modals.length === 0) return;
      
      // æŒ‰z-indexæ’åºï¼Œæ‰¾åˆ°æœ€é¡¶å±‚çš„æ¨¡æ€çª—å£
      const topModal = modals.reduce((top, current) => {
        const topZIndex = parseInt(window.getComputedStyle(top).zIndex) || 0;
        const currentZIndex = parseInt(window.getComputedStyle(current).zIndex) || 0;
        return currentZIndex > topZIndex ? current : top;
      });
      
      topModal.remove();
    }

    // åˆ›å»ºæ¨¡æ€çª—å£ï¼ˆå¸¦ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½å’Œæ­£ç¡®çš„z-indexï¼‰
    function createModal(content, zIndex = 10000) {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¨¡æ€çª—å£ï¼Œå¦‚æœæœ‰åˆ™å¢åŠ z-index
      // åªè€ƒè™‘çœŸæ­£çš„æ¨¡æ€çª—å£ï¼ˆz-index >= 9000ï¼‰
      const existingModals = Array.from(document.querySelectorAll('[style*="position: fixed"]')).filter(modal => {
        const modalZIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
        const hasOverlay = modal.style.background && modal.style.background.includes('rgba');
        return modalZIndex >= 9000 && hasOverlay;
      });
      
      if (existingModals.length > 0) {
        zIndex = Math.max(...existingModals.map(m => 
          parseInt(window.getComputedStyle(m).zIndex) || 0
        )) + 100;
      }
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: ${zIndex}; display: flex;
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€çª—å£
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      modal.innerHTML = content;
      document.body.appendChild(modal);
      return modal;
    }

    // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€çª—å£çš„æ”¯æŒ
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // åªæŸ¥æ‰¾çœŸæ­£çš„æ¨¡æ€çª—å£
        const modals = Array.from(document.querySelectorAll('[style*="position: fixed"]')).filter(modal => {
          const zIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
          const hasOverlay = modal.style.background && modal.style.background.includes('rgba');
          return zIndex >= 9000 && hasOverlay;
        });
        
        if (modals.length > 0) {
          closeModal();
        }
      }
    });

    // ä»·æ ¼è°ƒæ•´
    function adjustPrice(productId) {
      debugLog(`è°ƒæ•´äº§å“ä»·æ ¼: ${productId}`);
      
      // å…ˆè·å–äº§å“å½“å‰ä»·æ ¼
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            
            const content = `
              <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 100%;">
                <h3 style="margin-bottom: 20px;">ğŸ’° ä»·æ ¼è°ƒæ•´ - ${product.name}</h3>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">è¿›è´§ä»·ï¼ˆå«ç¨ï¼‰ (â‚¬)</label>
                  <input type="number" id="purchasePrice" step="0.01" value="${product.costPrice || 0}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <small style="color: #6b7280;">å½“å‰æ˜¾ç¤ºçš„æ˜¯å«ç¨ä»·æ ¼</small>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ‰¹å‘ä»· (â‚¬)</label>
                  <input type="number" id="wholesalePrice" step="0.01" value="${product.wholesalePrice || 0}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">é›¶å”®ä»· (â‚¬)</label>
                  <input type="number" id="retailPrice" step="0.01" value="${product.retailPrice || 0}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                  <button onclick="savePriceAdjustment('${productId}', '${product.vatRate || 'VAT 23%'}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                </div>
              </div>
            `;
            
            createModal(content);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // æ•°é‡è°ƒæ•´
    function adjustQuantity(productId) {
      debugLog(`è°ƒæ•´äº§å“æ•°é‡: ${productId}`);
      
      // å…ˆè·å–äº§å“ä¿¡æ¯ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰åºåˆ—å·
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åºåˆ—å·
            if (product.serialNumbers && product.serialNumbers.length > 0) {
              alert('æœ‰åºåˆ—å·/IMEIçš„äº§å“ä¸èƒ½è°ƒæ•´æ•°é‡');
              return;
            }
            
            const content = `
              <div style="background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 100%;">
                <h3 style="margin-bottom: 20px;">ğŸ“Š æ•°é‡è°ƒæ•´ - ${product.name}</h3>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰åº“å­˜: ${product.stockQuantity || 0}</label>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">è°ƒæ•´ç±»å‹</label>
                  <select id="adjustmentType" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="add">å¢åŠ åº“å­˜</option>
                    <option value="subtract">å‡å°‘åº“å­˜</option>
                    <option value="set">è®¾ç½®åº“å­˜</option>
                  </select>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ•°é‡</label>
                  <input type="number" id="quantityValue" min="0" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
                  <textarea id="adjustmentNote" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;" placeholder="è°ƒæ•´åŸå› ..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                  <button onclick="saveQuantityAdjustment('${productId}')" style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                </div>
              </div>
            `;
            
            createModal(content);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // è®¾ç½®ä½ç½®
    function setLocation(productId) {
      debugLog(`è®¾ç½®äº§å“ä½ç½®: ${productId}`);
      
      // å…ˆè·å–äº§å“å½“å‰ä½ç½®å’Œå­˜å‚¨ä½ç½®ç›®å½•
      Promise.all([
        fetch(`${API_BASE}/products/${productId}`).then(r => r.json()),
        fetch(`${API_BASE}/storage-locations`).then(r => r.json())
      ])
      .then(([productResult, locationsResult]) => {
        if (productResult.success && locationsResult.success) {
          const product = productResult.data;
          const locations = locationsResult.data;
          
          const content = `
            <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 100%;">
              <h3 style="margin-bottom: 20px;">ğŸ“ è®¾ç½®å­˜å‚¨ä½ç½® - ${product.name}</h3>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰ä½ç½®: ${product.location?.fullLocation || 'æœªè®¾ç½®'}</label>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä»“åº“åŒºåŸŸ</label>
                <select id="warehouseArea" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <option value="">é€‰æ‹©åŒºåŸŸ...</option>
                  ${locations.predefinedAreas.map(area => 
                    `<option value="${area.area}" ${product.location?.area === area.area ? 'selected' : ''}>${area.area} - ${area.description}</option>`
                  ).join('')}
                </select>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">è´§æ¶å·</label>
                <input type="text" id="shelfNumber" value="${product.location?.shelf || ''}" placeholder="å¦‚: A01, B15" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å…·ä½“ä½ç½®</label>
                <input type="text" id="specificLocation" value="${product.location?.position || ''}" placeholder="å¦‚: ç¬¬3å±‚å·¦ä¾§" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¸¸ç”¨ä½ç½®</label>
                <select onchange="fillLocationFromUsed(this.value)" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <option value="">é€‰æ‹©å¸¸ç”¨ä½ç½®...</option>
                  ${locations.usedLocations.map(loc => 
                    `<option value="${loc}">${loc}</option>`
                  ).join('')}
                </select>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                <button onclick="saveLocation('${productId}')" style="padding: 8px 16px; background: #ed8936; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
              </div>
            </div>
          `;
          
          createModal(content);
        } else {
          alert('è·å–äº§å“æˆ–ä½ç½®ä¿¡æ¯å¤±è´¥');
        }
      })
      .catch(error => {
        alert('è·å–ä¿¡æ¯å¤±è´¥: ' + error.message);
      });
    }

    // ä»å¸¸ç”¨ä½ç½®å¡«å……è¡¨å•
    function fillLocationFromUsed(locationString) {
      if (!locationString) return;
      
      const parts = locationString.split('-');
      if (parts.length >= 1) document.getElementById('warehouseArea').value = parts[0];
      if (parts.length >= 2) document.getElementById('shelfNumber').value = parts[1];
      if (parts.length >= 3) document.getElementById('specificLocation').value = parts.slice(2).join('-');
    }

    // ä¿å­˜ä»·æ ¼è°ƒæ•´
    async function savePriceAdjustment(productId, vatRate = 'VAT 23%') {
      const costPriceIncludingTax = parseFloat(document.getElementById('purchasePrice').value) || 0;
      const wholesalePrice = parseFloat(document.getElementById('wholesalePrice').value) || 0;
      const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
      
      // å°†å«ç¨è¿›è´§ä»·è½¬æ¢ä¸ºä¸å«ç¨ä»·æ ¼å­˜å‚¨åˆ°æ•°æ®åº“
      let taxMultiplier = 1.0;
      if (vatRate === 'VAT 23%') {
        taxMultiplier = 1.23;
      } else if (vatRate === 'VAT 13.5%') {
        taxMultiplier = 1.135;
      } else if (vatRate === 'VAT 0%') {
        taxMultiplier = 1.0;
      }
      
      const costPriceExcludingTax = costPriceIncludingTax / taxMultiplier;
      
      // éªŒè¯ä»·æ ¼é€»è¾‘ï¼ˆä½¿ç”¨å«ç¨è¿›è´§ä»·è¿›è¡Œæ¯”è¾ƒï¼‰
      if (costPriceIncludingTax >= wholesalePrice) {
        alert('æ‰¹å‘ä»·å¿…é¡»é«˜äºè¿›è´§ä»·ï¼ˆå«ç¨ï¼‰');
        return;
      }
      
      if (wholesalePrice >= retailPrice) {
        alert('é›¶å”®ä»·å¿…é¡»é«˜äºæ‰¹å‘ä»·');
        return;
      }
      
      debugLog(`ä¿å­˜ä»·æ ¼è°ƒæ•´: ${productId}, è¿›è´§ä»·ï¼ˆå«ç¨ï¼‰: ${costPriceIncludingTax}, è¿›è´§ä»·ï¼ˆä¸å«ç¨ï¼‰: ${costPriceExcludingTax}, æ‰¹å‘ä»·: ${wholesalePrice}, é›¶å”®ä»·: ${retailPrice}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/price`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            costPrice: costPriceExcludingTax, // å­˜å‚¨ä¸å«ç¨ä»·æ ¼
            wholesalePrice,
            retailPrice
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ä»·æ ¼è°ƒæ•´æˆåŠŸ');
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('ä»·æ ¼è°ƒæ•´å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('ä»·æ ¼è°ƒæ•´å¤±è´¥: ' + error.message);
      }
    }

    // ä¿å­˜æ•°é‡è°ƒæ•´
    async function saveQuantityAdjustment(productId) {
      const type = document.getElementById('adjustmentType').value;
      const quantity = parseInt(document.getElementById('quantityValue').value) || 0;
      const note = document.getElementById('adjustmentNote').value;
      
      if (quantity <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      debugLog(`ä¿å­˜æ•°é‡è°ƒæ•´: ${productId}, ç±»å‹: ${type}, æ•°é‡: ${quantity}, å¤‡æ³¨: ${note}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/quantity`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            type,
            quantity,
            note
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`æ•°é‡è°ƒæ•´æˆåŠŸ: ${result.data.oldQuantity} â†’ ${result.data.newQuantity}`);
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('æ•°é‡è°ƒæ•´å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('æ•°é‡è°ƒæ•´å¤±è´¥: ' + error.message);
      }
    }

    // ä¿å­˜ä½ç½®è®¾ç½®
    async function saveLocation(productId) {
      const area = document.getElementById('warehouseArea').value;
      const shelf = document.getElementById('shelfNumber').value;
      const position = document.getElementById('specificLocation').value;
      
      debugLog(`ä¿å­˜ä½ç½®è®¾ç½®: ${productId}, åŒºåŸŸ: ${area}, è´§æ¶: ${shelf}, ä½ç½®: ${position}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/location`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            area,
            shelf,
            position
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          const location = result.data.fullLocation || 'æœªè®¾ç½®';
          alert(`ä½ç½®è®¾ç½®æˆåŠŸ: ${location}`);
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('ä½ç½®è®¾ç½®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('ä½ç½®è®¾ç½®å¤±è´¥: ' + error.message);
      }
    }

    // çŠ¶æ€ç®¡ç†
    function changeStatus(productId) {
      debugLog(`æ›´æ”¹äº§å“çŠ¶æ€: ${productId}`);
      
      // å…ˆè·å–äº§å“å½“å‰çŠ¶æ€
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            
            const content = `
              <div style="background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 100%;">
                <h3 style="margin-bottom: 20px;">ğŸ·ï¸ çŠ¶æ€ç®¡ç† - ${product.name}</h3>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰çŠ¶æ€: ${getStatusText(product.status || 'available')}</label>
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰æˆè‰²: ${getConditionText(product.condition || 'Brand New')}</label>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“çŠ¶æ€</label>
                  <select id="productStatus" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="available" ${product.status === 'available' ? 'selected' : ''}>å¯é”€å”®</option>
                    <option value="reserved" ${product.status === 'reserved' ? 'selected' : ''}>å·²é¢„è®¢</option>
                    <option value="damaged" ${product.status === 'damaged' ? 'selected' : ''}>æŸå</option>
                    <option value="repair" ${product.status === 'repair' ? 'selected' : ''}>ç»´ä¿®ä¸­</option>
                    <option value="discontinued" ${product.status === 'discontinued' ? 'selected' : ''}>åœäº§</option>
                  </select>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆè‰²ç­‰çº§</label>
                  <select id="conditionGrade" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="Brand New" ${product.condition === 'Brand New' ? 'selected' : ''}>å…¨æ–°</option>
                    <option value="Pre-Owned" ${product.condition === 'Pre-Owned' ? 'selected' : ''}>äºŒæ‰‹</option>
                    <option value="Refurbished" ${product.condition === 'Refurbished' ? 'selected' : ''}>ç¿»æ–°</option>
                  </select>
                </div>
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
                  <textarea id="statusNote" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;" placeholder="çŠ¶æ€å˜æ›´åŸå› ..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                  <button onclick="saveStatusChange('${productId}')" style="padding: 8px 16px; background: #9f7aea; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                </div>
              </div>
            `;
            
            createModal(content);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'available': 'å¯é”€å”®',
        'reserved': 'å·²é¢„è®¢',
        'damaged': 'æŸå',
        'repair': 'ç»´ä¿®ä¸­',
        'discontinued': 'åœäº§'
      };
      return statusMap[status] || status;
    }

    // è·å–æˆè‰²æ–‡æœ¬
    function getConditionText(condition) {
      const conditionMap = {
        'Brand New': 'å…¨æ–°',
        'Pre-Owned': 'äºŒæ‰‹',
        'Refurbished': 'ç¿»æ–°'
      };
      return conditionMap[condition] || condition;
    }

    // ä¿å­˜çŠ¶æ€å˜æ›´
    async function saveStatusChange(productId) {
      const status = document.getElementById('productStatus').value;
      const condition = document.getElementById('conditionGrade').value;
      const note = document.getElementById('statusNote').value;
      
      debugLog(`ä¿å­˜çŠ¶æ€å˜æ›´: ${productId}, çŠ¶æ€: ${status}, æˆè‰²: ${condition}, å¤‡æ³¨: ${note}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status,
            condition,
            note
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`çŠ¶æ€æ›´æ–°æˆåŠŸ: ${getStatusText(result.data.status)} - ${getConditionText(result.data.condition)}`);
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // è·å–å½“å‰åˆ†ç±»ï¼ˆç”¨äºåˆ·æ–°ï¼‰
    function getCurrentCategory() {
      return currentViewingCategory;
    }

    // æ˜¾ç¤ºäº§å“çš„é‡‡è´­å‘ç¥¨
    async function showProductInvoices(productId, productName) {
      debugLog(`æ˜¾ç¤ºäº§å“é‡‡è´­å‘ç¥¨: ${productId} - ${productName}`);
      
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 98vw; width: 1400px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>ğŸ“„ ${productName} - é‡‡è´­å‘ç¥¨è®°å½•</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          <div id="productInvoicesContainer">
            <div class="loading">æ­£åœ¨åŠ è½½é‡‡è´­å‘ç¥¨...</div>
          </div>
        </div>
      `;
      
      createModal(content);
      
      try {
        debugLog(`æ­£åœ¨è¯·æ±‚API: ${API_BASE}/products/${productId}/purchase-invoices`);
        const response = await fetch(`${API_BASE}/products/${productId}/purchase-invoices`);
        debugLog(`APIå“åº”çŠ¶æ€: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`äº§å“é‡‡è´­å‘ç¥¨APIå“åº”: ${result.data?.length || 0} å¼ å‘ç¥¨`);
        
        const container = document.getElementById('productInvoicesContainer');
        
        if (result.success && result.data && result.data.length > 0) {
          const invoices = result.data;
          
          const html = `
            <div style="margin-bottom: 15px;">
              <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:</strong> å…±æ‰¾åˆ° ${invoices.length} å¼ é‡‡è´­å‘ç¥¨ï¼Œ
                æ€»é‡‡è´­æ•°é‡: ${invoices.reduce((sum, inv) => sum + inv.productItems.reduce((itemSum, item) => itemSum + item.quantity, 0), 0)} ä¸ª
              </div>
            </div>
            
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8fafc;">
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">å‘ç¥¨å·</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">ä¾›åº”å•†</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">å‘ç¥¨æ—¥æœŸ</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">é‡‡è´­æ•°é‡</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">å•ä»·ï¼ˆå«ç¨ï¼‰</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">æ€»ä»·ï¼ˆå«ç¨ï¼‰</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">æˆè‰²</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">åºåˆ—å·/æ¡ç </th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody>
                  ${invoices.map(invoice => {
                    return invoice.productItems.map(item => `
                      <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 10px; font-weight: 600; color: #1e40af;">
                          <span style="cursor: pointer; text-decoration: underline;" 
                                onclick="showInvoiceDetails('${invoice._id}', '${invoice.invoiceNumber}')">
                            ${invoice.invoiceNumber}
                          </span>
                          <br><small style="color: #6b7280; font-weight: normal;">
                            å‘ç¥¨æ€»é¢: ${invoice.currency} ${(invoice.totalAmount || 0).toFixed(2)}
                          </small>
                        </td>
                        <td style="padding: 10px;">
                          <div style="font-weight: 600;">${invoice.supplier.name}</div>
                          ${invoice.supplier.phone ? `<small style="color: #6b7280;">ğŸ“ ${invoice.supplier.phone}</small><br>` : ''}
                          ${invoice.supplier.email ? `<small style="color: #6b7280;">ğŸ“§ ${invoice.supplier.email}</small>` : ''}
                        </td>
                        <td style="padding: 10px;">
                          <div>${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</div>
                          ${invoice.dueDate ? `<small style="color: #6b7280;">åˆ°æœŸ: ${new Date(invoice.dueDate).toLocaleDateString('zh-CN')}</small>` : ''}
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #059669;">
                          ${item.quantity}
                        </td>
                        <td style="padding: 10px; color: #059669;">
                          ${invoice.currency} ${item.unitPrice?.toFixed(2) || '0.00'}
                        </td>
                        <td style="padding: 10px; font-weight: 600; color: #7c3aed;">
                          ${invoice.currency} ${item.totalPrice?.toFixed(2) || '0.00'}
                        </td>
                        <td style="padding: 10px;">
                          <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                       background: #dcfce7; color: #166534;">
                            å…¨æ–°
                          </span>
                        </td>
                        <td style="padding: 10px;">
                          ${item.serialNumbers && item.serialNumbers.length > 0 ? 
                            item.serialNumbers.map(sn => `<div style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px;">${sn}</div>`).join('') : ''}
                          ${item.barcode ? `<div style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${item.barcode}</div>` : ''}
                          ${!item.serialNumbers?.length && !item.barcode ? '<span style="color: #9ca3af;">-</span>' : ''}
                        </td>
                        <td style="padding: 10px;">
                          <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                       background: ${invoice.status === 'received' ? '#dcfce7' : '#fef3c7'}; 
                                       color: ${invoice.status === 'received' ? '#166534' : '#92400e'};">
                            ${invoice.status === 'received' ? 'âœ… å·²æ”¶è´§' : 'â³ å¾…å¤„ç†'}
                          </span>
                        </td>
                      </tr>
                    `).join('');
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            ${invoices.some(inv => inv.notes) ? `
              <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">ğŸ“ å¤‡æ³¨ä¿¡æ¯</h4>
                ${invoices.filter(inv => inv.notes).map(inv => `
                  <div style="background: #fffbeb; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #f59e0b;">
                    <strong>${inv.invoiceNumber}:</strong> ${inv.notes}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          `;
          
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“„</div>
              <h3>æš‚æ— é‡‡è´­è®°å½•</h3>
              <p>è¯¥äº§å“è¿˜æ²¡æœ‰é‡‡è´­å‘ç¥¨è®°å½•</p>
            </div>
          `;
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½äº§å“é‡‡è´­å‘ç¥¨å¤±è´¥: ${error.message}`);
        document.getElementById('productInvoicesContainer').innerHTML = `
          <div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // æ˜¾ç¤ºå‘ç¥¨è¯¦ç»†ä¿¡æ¯
    async function showInvoiceDetails(invoiceId, invoiceNumber) {
      debugLog(`æ˜¾ç¤ºå‘ç¥¨è¯¦ç»†ä¿¡æ¯: ${invoiceId} - ${invoiceNumber}`);
      
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 98vw; width: 1500px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>ğŸ“„ å‘ç¥¨è¯¦æƒ… - ${invoiceNumber}</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
              <button onclick="downloadPurchaseInvoicePDF('${invoiceId}', '${invoiceNumber}')" 
                      style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                ğŸ“¥ ä¸‹è½½PDF
              </button>
              <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
            </div>
          </div>
          <div id="invoiceDetailsContainer">
            <div class="loading">æ­£åœ¨åŠ è½½å‘ç¥¨è¯¦æƒ…...</div>
          </div>
        </div>
      `;
      
      createModal(content);
      
      try {
        const response = await fetch(`${API_BASE}/purchase-orders/${invoiceId}`);
        debugLog(`å‘ç¥¨è¯¦æƒ…APIå“åº”çŠ¶æ€: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`å‘ç¥¨è¯¦æƒ…æ•°æ®: ${JSON.stringify(result)}`);
        
        const container = document.getElementById('invoiceDetailsContainer');
        
        if (result.success && result.data) {
          const invoice = result.data;
          
          const html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
              <!-- å‘ç¥¨åŸºæœ¬ä¿¡æ¯ -->
              <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                <h4 style="margin-bottom: 15px; color: #1e40af;">ğŸ“‹ å‘ç¥¨ä¿¡æ¯</h4>
                <div style="display: grid; gap: 8px;">
                  <div><strong>å‘ç¥¨å·:</strong> ${invoice.invoiceNumber}</div>
                  <div><strong>å‘ç¥¨æ—¥æœŸ:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</div>
                  <div><strong>åˆ°æœŸæ—¥æœŸ:</strong> ${invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString('zh-CN') : 'æœªè®¾ç½®'}</div>
                  <div><strong>è´§å¸:</strong> ${invoice.currency}</div>
                  <div><strong>çŠ¶æ€:</strong> 
                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                 background: ${invoice.status === 'received' ? '#dcfce7' : invoice.status === 'confirmed' ? '#dbeafe' : '#fef3c7'}; 
                                 color: ${invoice.status === 'received' ? '#166534' : invoice.status === 'confirmed' ? '#1e40af' : '#92400e'};">
                      ${invoice.status === 'received' ? 'âœ… å·²æ”¶è´§' : invoice.status === 'confirmed' ? 'âœ“ å·²ç¡®è®¤' : 'â³ å¾…å¤„ç†'}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- ä¾›åº”å•†ä¿¡æ¯ -->
              <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <h4 style="margin-bottom: 15px; color: #166534;">ğŸ¢ ä¾›åº”å•†ä¿¡æ¯</h4>
                <div style="display: grid; gap: 8px;">
                  <div><strong>å…¬å¸åç§°:</strong> ${invoice.supplier?.name || 'æœªçŸ¥ä¾›åº”å•†'}</div>
                  <div><strong>è”ç³»ç”µè¯:</strong> ${invoice.supplier?.phone || 'æœªæä¾›'}</div>
                  <div><strong>ç”µå­é‚®ç®±:</strong> ${invoice.supplier?.email || 'æœªæä¾›'}</div>
                  <div><strong>åœ°å€:</strong> ${invoice.supplier?.address ? 
                    (typeof invoice.supplier.address === 'string' ? invoice.supplier.address : 
                     `${invoice.supplier.address.street || ''} ${invoice.supplier.address.city || ''} ${invoice.supplier.address.state || ''} ${invoice.supplier.address.postalCode || ''} ${invoice.supplier.address.country || ''}`.trim()) 
                    : 'æœªæä¾›'}</div>
                </div>
              </div>
            </div>
            
            <!-- é‡‘é¢ä¿¡æ¯ -->
            <div style="background: #fefce8; padding: 20px; border-radius: 12px; border-left: 4px solid #eab308; margin-bottom: 25px;">
              <h4 style="margin-bottom: 15px; color: #a16207;">ğŸ’° é‡‘é¢æ˜ç»†</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">å°è®¡ï¼ˆä¸å«ç¨ï¼‰</div>
                  <div style="font-size: 18px; font-weight: 600; color: #059669;">
                    ${invoice.currency} ${(invoice.subtotal || 0).toFixed(2)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ç¨é¢</div>
                  <div style="font-size: 18px; font-weight: 600; color: #dc2626;">
                    ${invoice.currency} ${(invoice.taxAmount || 0).toFixed(2)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰</div>
                  <div style="font-size: 20px; font-weight: 700; color: #7c3aed;">
                    ${invoice.currency} ${(invoice.totalAmount || 0).toFixed(2)}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- äº§å“æ˜ç»† -->
            <div style="margin-bottom: 25px;">
              <h4 style="margin-bottom: 15px;">ğŸ“¦ äº§å“æ˜ç»†</h4>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f8fafc;">
                      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">äº§å“æè¿°</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">æ•°é‡</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">å•ä»·ï¼ˆå«ç¨ï¼‰</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">æ€»ä»·ï¼ˆå«ç¨ï¼‰</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">ç¨é¢</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">åºåˆ—å·</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(invoice.items || []).map(item => `
                      <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 12px;">
                          <div style="font-weight: 600;">${item.description || item.productName || 'æœªçŸ¥äº§å“'}</div>
                          ${item.source === 'AdminInventory' && item.location ? `<small style="color: #059669;">ğŸ“ ä½ç½®: ${item.location}</small><br>` : ''}
                          ${item.source === 'AdminInventory' && item.condition ? `<small style="color: #6b7280;">çŠ¶æ€: ${item.condition}</small><br>` : ''}
                          ${item.vatRate ? `<small style="color: #7c3aed;">ç¨ç‡: ${item.vatRate}</small>` : ''}
                          ${item.source ? `<br><small style="background: ${item.source === 'AdminInventory' ? '#dcfce7' : '#dbeafe'}; color: ${item.source === 'AdminInventory' ? '#166534' : '#1e40af'}; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${item.source === 'AdminInventory' ? 'ğŸ“¦ åº“å­˜ç³»ç»Ÿ' : 'ğŸ“‹ é‡‡è´­è®¢å•'}</small>` : ''}
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #059669;">
                          ${item.quantity}
                        </td>
                        <td style="padding: 12px; text-align: right; color: #059669;">
                          â‚¬${(item.unitCost || 0).toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #7c3aed;">
                          â‚¬${(item.totalCost || 0).toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: right; color: #dc2626;">
                          â‚¬${(item.taxAmount || 0).toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                          ${item.serialNumbers && item.serialNumbers.length > 0 ? 
                            item.serialNumbers.map(sn => `<div style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px;">${sn}</div>`).join('') : 
                            '<span style="color: #9ca3af;">-</span>'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            ${invoice.notes ? `
              <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border-left: 3px solid #f59e0b;">
                <h4 style="margin-bottom: 10px; color: #92400e;">ğŸ“ å¤‡æ³¨</h4>
                <p style="margin: 0; color: #78350f;">${invoice.notes}</p>
              </div>
            ` : ''}
          `;
          
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div class="error">è·å–å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>
          `;
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${error.message}`);
        document.getElementById('invoiceDetailsContainer').innerHTML = `
          <div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // åˆ‡æ¢åºåˆ—å·æ˜¾ç¤º/éšè—
    function toggleSerialNumbers(productId) {
      const serialDiv = document.getElementById(`serial-${productId}`);
      const toggleText = document.querySelector(`[onclick="toggleSerialNumbers('${productId}')"] span`);
      
      if (serialDiv && toggleText) {
        if (serialDiv.style.display === 'none') {
          serialDiv.style.display = 'block';
          toggleText.textContent = 'ç‚¹å‡»éšè—';
          toggleText.style.color = '#ef4444';
        } else {
          serialDiv.style.display = 'none';
          toggleText.textContent = 'ç‚¹å‡»æŸ¥çœ‹';
          toggleText.style.color = '#3b82f6';
        }
      }
    }

    // ä¸‹è½½é‡‡è´­å‘ç¥¨PDF
    async function downloadPurchaseInvoicePDF(invoiceId, invoiceNumber) {
      try {
        debugLog(`ä¸‹è½½é‡‡è´­å‘ç¥¨PDF: ${invoiceId}`);
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 10001; font-size: 16px;';
        loadingMsg.textContent = 'Generating PDF...';
        document.body.appendChild(loadingMsg);
        
        // å¹¶è¡Œè·å–å‘ç¥¨è¯¦æƒ…å’Œå…¬å¸ä¿¡æ¯
        const [invoiceResponse, companyResponse] = await Promise.all([
          fetch(`${API_BASE}/purchase-orders/${invoiceId}`),
          fetch(`${API_BASE}/company-info`)
        ]);
        
        if (!invoiceResponse.ok) throw new Error(`HTTP ${invoiceResponse.status}`);
        if (!companyResponse.ok) throw new Error('Failed to get company info');
        
        const invoiceResult = await invoiceResponse.json();
        const companyResult = await companyResponse.json();
        
        if (!invoiceResult.success || !invoiceResult.data) {
          throw new Error('Failed to get invoice details');
        }
        
        const invoice = invoiceResult.data;
        const companyInfo = companyResult.success && companyResult.data ? companyResult.data : null;
        
        // ä½¿ç”¨jsPDFç”ŸæˆPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let yPos = 20;
        const leftMargin = 20;
        const rightMargin = 190;
        
        // æ ‡é¢˜
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text('PURCHASE INVOICE', 105, yPos, { align: 'center' });
        yPos += 10;
        
        doc.setFontSize(14);
        doc.text(invoice.invoiceNumber || invoiceNumber, 105, yPos, { align: 'center' });
        yPos += 15;
        
        // åŒæ–¹å…¬å¸ä¿¡æ¯ - å·¦å³å¸ƒå±€
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('FROM:', leftMargin, yPos);
        doc.text('TO:', 110, yPos);
        yPos += 6;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        // å·¦ä¾§ï¼šä¾›åº”å•†å…¬å¸ä¿¡æ¯
        let leftYPos = yPos;
        if (invoice.supplier) {
          doc.setFont(undefined, 'bold');
          doc.text(invoice.supplier.companyName || invoice.supplier.name || 'N/A', leftMargin, leftYPos);
          leftYPos += 5;
          doc.setFont(undefined, 'normal');
          
          if (invoice.supplier.address) {
            if (typeof invoice.supplier.address === 'string') {
              const lines = doc.splitTextToSize(invoice.supplier.address, 80);
              lines.forEach(line => {
                doc.text(line, leftMargin, leftYPos);
                leftYPos += 4;
              });
            } else {
              if (invoice.supplier.address.street) {
                doc.text(invoice.supplier.address.street, leftMargin, leftYPos);
                leftYPos += 4;
              }
              const cityLine = [
                invoice.supplier.address.city,
                invoice.supplier.address.state,
                invoice.supplier.address.postalCode
              ].filter(Boolean).join(', ');
              if (cityLine) {
                doc.text(cityLine, leftMargin, leftYPos);
                leftYPos += 4;
              }
              if (invoice.supplier.address.country) {
                doc.text(invoice.supplier.address.country, leftMargin, leftYPos);
                leftYPos += 4;
              }
            }
          }
          
          if (invoice.supplier.taxNumber || invoice.supplier.vatNumber) {
            doc.text(`VAT: ${invoice.supplier.taxNumber || invoice.supplier.vatNumber}`, leftMargin, leftYPos);
            leftYPos += 4;
          }
        } else {
          doc.text('Supplier information not available', leftMargin, leftYPos);
          leftYPos += 5;
        }
        
        // å³ä¾§ï¼šä¹°æ–¹å…¬å¸ä¿¡æ¯
        let rightYPos = yPos;
        if (companyInfo) {
          doc.setFont(undefined, 'bold');
          doc.text(companyInfo.companyName || 'N/A', 110, rightYPos);
          rightYPos += 5;
          doc.setFont(undefined, 'normal');
          
          if (companyInfo.address) {
            if (companyInfo.address.street) {
              doc.text(companyInfo.address.street, 110, rightYPos);
              rightYPos += 4;
            }
            const cityLine = [
              companyInfo.address.city,
              companyInfo.address.state,
              companyInfo.address.postalCode
            ].filter(Boolean).join(', ');
            if (cityLine) {
              doc.text(cityLine, 110, rightYPos);
              rightYPos += 4;
            }
            if (companyInfo.address.country) {
              doc.text(companyInfo.address.country, 110, rightYPos);
              rightYPos += 4;
            }
          }
          
          if (companyInfo.taxNumber) {
            doc.text(`VAT: ${companyInfo.taxNumber}`, 110, rightYPos);
            rightYPos += 4;
          }
          
          if (companyInfo.contact?.phone) {
            doc.text(`Tel: ${companyInfo.contact.phone}`, 110, rightYPos);
            rightYPos += 4;
          }
          
          if (companyInfo.contact?.email) {
            doc.text(`Email: ${companyInfo.contact.email}`, 110, rightYPos);
            rightYPos += 4;
          }
        } else {
          doc.text('Company information not available', 110, rightYPos);
          rightYPos += 5;
        }
        
        yPos = Math.max(leftYPos, rightYPos) + 10;
        
        // å‘ç¥¨ä¿¡æ¯
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Invoice Date: ${new Date(invoice.invoiceDate).toLocaleDateString('en-IE')}`, leftMargin, yPos);
        yPos += 5;
        if (invoice.dueDate) {
          doc.text(`Due Date: ${new Date(invoice.dueDate).toLocaleDateString('en-IE')}`, leftMargin, yPos);
          yPos += 5;
        }
        doc.text(`Currency: ${invoice.currency}`, leftMargin, yPos);
        yPos += 10;
        
        // äº§å“æ˜ç»†è¡¨å¤´
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(240, 240, 240);
        doc.rect(leftMargin, yPos - 4, 170, 7, 'F');
        doc.text('Product', leftMargin + 2, yPos);
        doc.text('Qty', 100, yPos, { align: 'center' });
        doc.text('Unit Price', 130, yPos, { align: 'right' });
        doc.text('VAT', 155, yPos, { align: 'center' });
        doc.text('Total', rightMargin - 2, yPos, { align: 'right' });
        yPos += 7;
        
        doc.setFont(undefined, 'normal');
        
        // äº§å“åˆ—è¡¨
        (invoice.items || []).forEach(item => {
          if (yPos > 265) {
            doc.addPage();
            yPos = 20;
          }
          
          let displayName = item.productName;
          if (item.description && item.description !== item.productName) {
            displayName = item.description;
          }
          
          const productLines = doc.splitTextToSize(displayName, 85);
          
          productLines.forEach((line, index) => {
            doc.text(line, leftMargin + 2, yPos);
            if (index === 0) {
              doc.text(String(item.quantity || 1), 100, yPos, { align: 'center' });
              doc.text(`â‚¬${(item.unitCost || 0).toFixed(2)}`, 130, yPos, { align: 'right' });
              doc.text(item.vatRate || 'N/A', 155, yPos, { align: 'center' });
              doc.text(`â‚¬${(item.totalCost || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
            }
            yPos += 5;
          });
        });
        
        yPos += 5;
        
        // åˆ†éš”çº¿
        doc.setDrawColor(200, 200, 200);
        doc.line(leftMargin, yPos, rightMargin, yPos);
        yPos += 7;
        
        // æ€»è®¡
        doc.setFont(undefined, 'normal');
        doc.text('Subtotal (excl. VAT):', 130, yPos, { align: 'right' });
        doc.text(`â‚¬${(invoice.subtotal || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
        yPos += 6;
        
        doc.text('VAT Amount:', 130, yPos, { align: 'right' });
        doc.text(`â‚¬${(invoice.taxAmount || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
        yPos += 8;
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(12);
        doc.text('Total (incl. VAT):', 130, yPos, { align: 'right' });
        doc.text(`â‚¬${(invoice.totalAmount || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
        
        // é“¶è¡Œä¿¡æ¯ï¼ˆä¾›åº”å•†çš„ï¼‰
        if (invoice.supplier && invoice.supplier.bankDetails && invoice.supplier.bankDetails.iban) {
          yPos += 15;
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.text('Payment Details:', leftMargin, yPos);
          yPos += 5;
          doc.setFont(undefined, 'normal');
          doc.text(`IBAN: ${invoice.supplier.bankDetails.iban}`, leftMargin, yPos);
          yPos += 4;
          if (invoice.supplier.bankDetails.bic) {
            doc.text(`BIC: ${invoice.supplier.bankDetails.bic}`, leftMargin, yPos);
            yPos += 4;
          }
          if (invoice.supplier.bankDetails.bankName) {
            doc.text(`Bank: ${invoice.supplier.bankDetails.bankName}`, leftMargin, yPos);
          }
        }
        
        // ä¿å­˜PDF
        doc.save(`purchase-invoice-${invoiceNumber || invoiceId}.pdf`);
        
        document.body.removeChild(loadingMsg);
        debugLog('âœ… PDF generated successfully');
        
      } catch (error) {
        debugLog(`âŒ Failed to generate PDF: ${error.message}`);
        alert(`Failed to generate PDF: ${error.message}`);
        const loadingMsg = document.querySelector('div[style*="Generating PDF"]');
        if (loadingMsg && loadingMsg.parentNode) document.body.removeChild(loadingMsg);
      }
    }

    // é€šè¿‡åºåˆ—å·ç¼–è¾‘äº§å“
    function editProductBySerial(productId, serialNumber, productName) {
      debugLog(`ç¼–è¾‘äº§å“: ${productId}, åºåˆ—å·: ${serialNumber}`);
      
      // å…ˆè·å–äº§å“è¯¦ç»†ä¿¡æ¯
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            showProductEditModal(product, serialNumber);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // æ˜¾ç¤ºäº§å“ç¼–è¾‘æ¨¡æ€çª—å£
    function showProductEditModal(product, serialNumber = null) {
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>âœï¸ ç¼–è¾‘äº§å“ä¿¡æ¯${serialNumber ? ` - ${serialNumber}` : ''}</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“åç§°</label>
              <input type="text" id="editProductName" value="${product.name || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">å“ç‰Œ</label>
              <input type="text" id="editProductBrand" value="${product.brand || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">å‹å·</label>
              <input type="text" id="editProductModel" value="${product.model || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">é¢œè‰²</label>
              <input type="text" id="editProductColor" value="${product.color || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">è¿›è´§ä»·ï¼ˆå«ç¨ï¼‰ (â‚¬)</label>
              <input type="number" id="editCostPrice" step="0.01" value="${product.costPrice || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ‰¹å‘ä»· (â‚¬)</label>
              <input type="number" id="editWholesalePrice" step="0.01" value="${product.wholesalePrice || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">é›¶å”®ä»· (â‚¬)</label>
              <input type="number" id="editRetailPrice" step="0.01" value="${product.retailPrice || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“åˆ†ç±»</label>
              <select id="editProductType" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="æ‰‹æœºé…ä»¶" ${product.productType === 'æ‰‹æœºé…ä»¶' ? 'selected' : ''}>æ‰‹æœºé…ä»¶</option>
                <option value="ç”µè„‘é…ä»¶" ${product.productType === 'ç”µè„‘é…ä»¶' ? 'selected' : ''}>ç”µè„‘é…ä»¶</option>
                <option value="è½¦è½½é…ä»¶" ${product.productType === 'è½¦è½½é…ä»¶' ? 'selected' : ''}>è½¦è½½é…ä»¶</option>
                <option value="audio" ${product.productType === 'audio' ? 'selected' : ''}>Audio</option>
                <option value="æ•°æ®çº¿" ${product.productType === 'æ•°æ®çº¿' ? 'selected' : ''}>æ•°æ®çº¿</option>
                <option value="power supply" ${product.productType === 'power supply' ? 'selected' : ''}>Power Supply</option>
                <option value="å…¨æ–°è®¾å¤‡" ${product.productType === 'å…¨æ–°è®¾å¤‡' ? 'selected' : ''}>å…¨æ–°è®¾å¤‡</option>
                <option value="äºŒæ‰‹è®¾å¤‡" ${product.productType === 'äºŒæ‰‹è®¾å¤‡' ? 'selected' : ''}>äºŒæ‰‹è®¾å¤‡</option>
                <option value="ç»´ä¿®" ${product.productType === 'ç»´ä¿®' ? 'selected' : ''}>ç»´ä¿®</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">ç¨åŠ¡ç±»ç›®</label>
              <select id="editVatRate" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="VAT 23%" ${product.vatRate === 'VAT 23%' ? 'selected' : ''}>VAT 23%</option>
                <option value="VAT 13.5%" ${product.vatRate === 'VAT 13.5%' ? 'selected' : ''}>VAT 13.5%</option>
                <option value="VAT 0%" ${product.vatRate === 'VAT 0%' ? 'selected' : ''}>VAT 0%</option>
              </select>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆè‰²</label>
              <select id="editCondition" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="Brand New" ${product.condition === 'Brand New' ? 'selected' : ''}>å…¨æ–°</option>
                <option value="Pre-Owned" ${product.condition === 'Pre-Owned' ? 'selected' : ''}>äºŒæ‰‹</option>
                <option value="Refurbished" ${product.condition === 'Refurbished' ? 'selected' : ''}>ç¿»æ–°</option>
              </select>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">çŠ¶æ€</label>
              <select id="editStatus" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="available" ${product.status === 'available' ? 'selected' : ''}>å¯é”€å”®</option>
                <option value="reserved" ${product.status === 'reserved' ? 'selected' : ''}>å·²é¢„è®¢</option>
                <option value="damaged" ${product.status === 'damaged' ? 'selected' : ''}>æŸå</option>
                <option value="repair" ${product.status === 'repair' ? 'selected' : ''}>ç»´ä¿®ä¸­</option>
                <option value="discontinued" ${product.status === 'discontinued' ? 'selected' : ''}>åœäº§</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">åº“å­˜æ•°é‡</label>
              <input type="number" id="editStockQuantity" min="0" value="${product.stockQuantity || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;"
                     ${product.serialNumbers && product.serialNumbers.length > 0 ? 'readonly' : ''}>
              ${product.serialNumbers && product.serialNumbers.length > 0 ? 
                '<small style="color: #6b7280;">æœ‰åºåˆ—å·çš„äº§å“ä¸èƒ½ç›´æ¥ä¿®æ”¹æ•°é‡</small>' : ''}
            </div>
          </div>
          
          ${product.barcode ? `
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ¡ç </label>
            <input type="text" id="editBarcode" value="${product.barcode || ''}" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          ` : ''}
          
          ${serialNumber ? `
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰åºåˆ—å·</label>
            <input type="text" id="editSerialNumber" value="${serialNumber}" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          ` : ''}
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
            <textarea id="editNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">${product.notes || ''}</textarea>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
            <button onclick="saveProductEdit('${product._id}', '${serialNumber || ''}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
          </div>
        </div>
      `;
      
      createModal(content);
    }

    // ä¿å­˜äº§å“ç¼–è¾‘
    async function saveProductEdit(productId, originalSerialNumber = '') {
      const costPriceIncludingTax = parseFloat(document.getElementById('editCostPrice').value) || 0;
      const vatRate = document.getElementById('editVatRate').value;
      
      // å°†å«ç¨è¿›è´§ä»·è½¬æ¢ä¸ºä¸å«ç¨ä»·æ ¼å­˜å‚¨åˆ°æ•°æ®åº“
      let taxMultiplier = 1.0;
      if (vatRate === 'VAT 23%') {
        taxMultiplier = 1.23;
      } else if (vatRate === 'VAT 13.5%') {
        taxMultiplier = 1.135;
      } else if (vatRate === 'VAT 0%') {
        taxMultiplier = 1.0;
      }
      
      const costPriceExcludingTax = costPriceIncludingTax / taxMultiplier;
      
      const updateData = {
        name: document.getElementById('editProductName').value,
        brand: document.getElementById('editProductBrand').value,
        model: document.getElementById('editProductModel').value,
        color: document.getElementById('editProductColor').value,
        costPrice: costPriceExcludingTax, // å­˜å‚¨ä¸å«ç¨ä»·æ ¼
        wholesalePrice: parseFloat(document.getElementById('editWholesalePrice').value) || 0,
        retailPrice: parseFloat(document.getElementById('editRetailPrice').value) || 0,
        productType: document.getElementById('editProductType').value,
        vatRate: vatRate,
        condition: document.getElementById('editCondition').value,
        status: document.getElementById('editStatus').value,
        stockQuantity: parseInt(document.getElementById('editStockQuantity').value) || 0,
        notes: document.getElementById('editNotes').value
      };
      
      // å¦‚æœæœ‰æ¡ç å­—æ®µï¼Œæ·»åŠ æ¡ç 
      const barcodeInput = document.getElementById('editBarcode');
      if (barcodeInput) {
        updateData.barcode = barcodeInput.value;
      }
      
      // å¦‚æœæœ‰åºåˆ—å·å­—æ®µï¼Œå¤„ç†åºåˆ—å·æ›´æ–°
      const serialNumberInput = document.getElementById('editSerialNumber');
      if (serialNumberInput && originalSerialNumber) {
        updateData.serialNumberUpdate = {
          oldSerialNumber: originalSerialNumber,
          newSerialNumber: serialNumberInput.value
        };
      }
      
      // éªŒè¯ä»·æ ¼é€»è¾‘
      if (updateData.wholesalePrice <= updateData.costPrice) {
        alert('æ‰¹å‘ä»·å¿…é¡»é«˜äºè¿›è´§ä»·');
        return;
      }
      
      if (updateData.retailPrice <= updateData.wholesalePrice) {
        alert('é›¶å”®ä»·å¿…é¡»é«˜äºæ‰¹å‘ä»·');
        return;
      }
      
      debugLog(`ä¿å­˜äº§å“ç¼–è¾‘: ${productId}`, updateData);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('äº§å“ä¿¡æ¯æ›´æ–°æˆåŠŸ');
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          const currentCategory = getCurrentCategory();
          if (currentCategory) {
            loadCategoryProductDetails(currentCategory);
          } else {
            loadCategoryCards();
          }
        } else {
          alert('äº§å“ä¿¡æ¯æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('äº§å“ä¿¡æ¯æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // æ‰¹é‡æ“ä½œå‡½æ•°
    function showPriceAdjustment() {
      alert('æ‰¹é‡ä»·æ ¼è°ƒæ•´åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    function showLocationManagement() {
      alert('æ‰¹é‡ä½ç½®ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    function showQuantityAdjustment() {
      alert('æ‰¹é‡æ•°é‡è°ƒæ•´åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    function showStatusManagement() {
      alert('æ‰¹é‡çŠ¶æ€ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    // åŠ è½½æŠ¥è¡¨æ•°æ®
    async function loadReports() {
      // ä¸å†è‡ªåŠ¨åŠ è½½ï¼Œç­‰å¾…ç”¨æˆ·æŸ¥è¯¢
      debugLog('æŠ¥è¡¨é¡µé¢å·²å‡†å¤‡å°±ç»ª');
    }
    
    // åŠ è½½è´¢åŠ¡æŠ¥è¡¨
    async function loadFinancialReport() {
      debugLog('å¼€å§‹åŠ è½½è´¢åŠ¡æŠ¥è¡¨');
      const container = document.getElementById('reportsContainer');
      container.innerHTML = '<div class="loading">Generating report...</div>';
      
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      const type = document.getElementById('reportType').value;
      
      if (!startDate || !endDate) {
        container.innerHTML = `
          <div class="error">
            Please select both start date and end date
          </div>
        `;
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/reports/financial?startDate=${startDate}&endDate=${endDate}&type=${type}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          renderFinancialReport(result.data);
        } else {
          throw new Error('Failed to load report');
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½è´¢åŠ¡æŠ¥è¡¨å¤±è´¥: ${error.message}`);
        container.innerHTML = `
          <div class="error">
            Failed to load report: ${error.message}
          </div>
        `;
      }
    }
    
    // æ¸²æŸ“è´¢åŠ¡æŠ¥è¡¨
    function renderFinancialReport(data) {
      const container = document.getElementById('reportsContainer');
      const { invoices, summary, assets } = data;
      
      if (invoices.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“Š</div>
            <h3>No records found</h3>
            <p>No invoices found in the selected date range</p>
          </div>
        `;
        return;
      }
      
      const typeLabels = {
        'sales': 'ğŸ“¤ Sales',
        'purchase': 'ğŸ“¥ Purchase'
      };
      
      // ç”Ÿæˆèµ„äº§åˆ—è¡¨HTML
      let assetsHtml = '';
      if (assets && assets.categories && assets.categories.length > 0) {
        assetsHtml = `
        <!-- Inventory Assets -->
        <div style="background: white; border-radius: 8px; overflow: hidden; margin-top: 30px; padding: 20px;">
          <h3 style="margin: 0 0 20px 0; color: #1f2937;">ğŸ“¦ Inventory Assets (Available for Sale)</h3>
          
          <!-- Total Asset Value Card -->
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px; color: white;">
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Asset Value (Cost Price)</div>
            <div style="font-size: 32px; font-weight: bold;">â‚¬${assets.totalAssetValue.toFixed(2)}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">${assets.totalProducts} products in stock</div>
          </div>
          
          <!-- Assets by Category -->
          ${assets.categories.map(cat => `
            <div style="margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
              <div style="background: #f8fafc; padding: 15px; border-bottom: 1px solid #e5e7eb; cursor: pointer;" 
                   onclick="toggleAssetCategory('${cat.category}')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <span style="font-weight: 600; font-size: 16px; color: #1f2937;">ğŸ“ ${cat.category}</span>
                    <span style="margin-left: 10px; color: #6b7280; font-size: 14px;">(${cat.products.length} products, ${cat.totalQuantity} units)</span>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">â‚¬${cat.totalValue.toFixed(2)}</div>
                    <div style="font-size: 12px; color: #6b7280;">Asset Value</div>
                  </div>
                </div>
              </div>
              
              <div id="asset-category-${cat.category}" style="display: none;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #fafafa;">
                      <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Product Name</th>
                      <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Brand</th>
                      <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Model</th>
                      <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Condition</th>
                      <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Quantity</th>
                      <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Cost Price</th>
                      <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb; font-size: 12px; color: #6b7280;">Total Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${cat.products.map(product => `
                      <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 10px; font-size: 14px;">${product.name}</td>
                        <td style="padding: 10px; font-size: 14px; color: #6b7280;">${product.brand || '-'}</td>
                        <td style="padding: 10px; font-size: 14px; color: #6b7280;">${product.model || '-'}</td>
                        <td style="padding: 10px; font-size: 14px;">
                          <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; background: ${product.condition === 'Brand New' ? '#d1fae5' : '#fef3c7'}; color: ${product.condition === 'Brand New' ? '#065f46' : '#92400e'};">
                            ${product.condition}
                          </span>
                        </td>
                        <td style="padding: 10px; text-align: right; font-weight: 500;">${product.quantity}</td>
                        <td style="padding: 10px; text-align: right; font-weight: 500;">â‚¬${product.costPrice.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; font-weight: 600; color: #3b82f6;">â‚¬${product.totalValue.toFixed(2)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                  <tfoot>
                    <tr style="background: #f8fafc; font-weight: bold;">
                      <td colspan="4" style="padding: 12px; text-align: right;">Category Total:</td>
                      <td style="padding: 12px; text-align: right;">${cat.totalQuantity}</td>
                      <td style="padding: 12px; text-align: right;">-</td>
                      <td style="padding: 12px; text-align: right; color: #3b82f6;">â‚¬${cat.totalValue.toFixed(2)}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          `).join('')}
        </div>
        `;
      }
      
      const html = `
        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
          <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Total Sales (Incl. VAT)</div>
            <div style="font-size: 24px; font-weight: bold; color: #10b981;">â‚¬${summary.totalSalesAmount.toFixed(2)}</div>
          </div>
          <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #059669;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Total Sales VAT</div>
            <div style="font-size: 24px; font-weight: bold; color: #059669;">â‚¬${summary.totalSalesTax.toFixed(2)}</div>
          </div>
          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Total Purchase (Incl. VAT)</div>
            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">â‚¬${summary.totalPurchaseAmount.toFixed(2)}</div>
          </div>
          <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #d97706;">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Total Purchase VAT (Deductible)</div>
            <div style="font-size: 24px; font-weight: bold; color: #d97706;">â‚¬${summary.totalPurchaseTax.toFixed(2)}</div>
          </div>
          <div style="background: ${summary.totalTaxPayable >= 0 ? '#eff6ff' : '#fef2f2'}; padding: 20px; border-radius: 8px; border-left: 4px solid ${summary.totalTaxPayable >= 0 ? '#3b82f6' : '#ef4444'};">
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Net VAT Payable</div>
            <div style="font-size: 24px; font-weight: bold; color: ${summary.totalTaxPayable >= 0 ? '#3b82f6' : '#ef4444'};">â‚¬${summary.totalTaxPayable.toFixed(2)}</div>
          </div>
        </div>
        
        <!-- Invoice List -->
        <div style="background: white; border-radius: 8px; overflow: hidden;">
          <h3 style="margin: 0 0 20px 0; color: #1f2937;">Invoice Details</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f8fafc;">
                  <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Invoice Number</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Type</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Customer/Supplier</th>
                  <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Date</th>
                  <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Amount (Incl. VAT)</th>
                  <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">VAT Amount</th>
                  <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${invoices.map(invoice => {
                  // åˆ¤æ–­æ˜¯å¦å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                  const isClickable = true; // æ‰€æœ‰å‘ç¥¨éƒ½å¯ä»¥ç‚¹å‡»
                  
                  // æ ¹æ®ç±»å‹å’Œå­ç±»å‹ç¡®å®šç‚¹å‡»å¤„ç†å‡½æ•°
                  let clickHandler = '';
                  let pdfHandler = '';
                  if (invoice.subType === 'wholesale') {
                    clickHandler = `showWarehouseOrderDetails('${invoice._id}')`;
                    pdfHandler = `downloadWarehouseOrderPDF('${invoice._id}', '${invoice.invoiceNumber}')`;
                  } else if (invoice.type === 'sales') {
                    clickHandler = `showSalesInvoiceDetails('${invoice._id}')`;
                    pdfHandler = `downloadSalesInvoicePDF('${invoice._id}', '${invoice.invoiceNumber}')`;
                  } else {
                    clickHandler = `showPurchaseInvoiceDetails('${invoice._id}')`;
                    pdfHandler = `downloadPurchaseInvoicePDF('${invoice._id}', '${invoice.invoiceNumber}')`;
                  }
                  
                  // ç±»å‹æ ‡ç­¾
                  let typeLabel = typeLabels[invoice.type];
                  if (invoice.subType === 'wholesale') {
                    typeLabel = 'ğŸ“¦ Wholesale';
                  } else if (invoice.subType === 'retail') {
                    typeLabel = 'ğŸ›’ Retail';
                  }
                  
                  return `
                  <tr onmouseover="this.style.background='#f8fafc'"
                      onmouseout="this.style.background='white'">
                    <td style="padding: 12px; border: 1px solid #e5e7eb; cursor: pointer;" onclick="${clickHandler}">
                      <span style="color: #3b82f6; text-decoration: underline; font-weight: 500;">
                        ${invoice.invoiceNumber}
                      </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb; cursor: pointer;" onclick="${clickHandler}">
                      <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; background: ${invoice.type === 'sales' ? '#d1fae5' : '#fef3c7'}; color: ${invoice.type === 'sales' ? '#065f46' : '#92400e'};">
                        ${typeLabel}
                      </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb; cursor: pointer;" onclick="${clickHandler}">${invoice.partner}</td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb; cursor: pointer;" onclick="${clickHandler}">${new Date(invoice.date).toLocaleDateString('en-IE')}</td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 500; cursor: pointer;" onclick="${clickHandler}">â‚¬${invoice.totalAmount.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: 500; color: ${invoice.taxAmount >= 0 ? '#10b981' : '#ef4444'}; cursor: pointer;" onclick="${clickHandler}">
                      â‚¬${invoice.taxAmount.toFixed(2)}
                    </td>
                    <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">
                      <button onclick="event.stopPropagation(); ${pdfHandler}" 
                              style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: inline-flex; align-items: center; gap: 5px;"
                              onmouseover="this.style.background='#2563eb'"
                              onmouseout="this.style.background='#3b82f6'">
                        ğŸ“¥ PDF
                      </button>
                    </td>
                  </tr>
                `;
                }).join('')}
              </tbody>
              <tfoot>
                <tr style="background: #f8fafc; font-weight: bold;">
                  <td colspan="4" style="padding: 12px; border: 1px solid #e5e7eb; text-align: right;">Total Profit:</td>
                  <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">
                    â‚¬${(summary.totalSalesAmount - summary.totalPurchaseAmount).toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; color: ${summary.totalTaxPayable >= 0 ? '#10b981' : '#ef4444'};">
                    â‚¬${summary.totalTaxPayable.toFixed(2)}
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
        
        ${assetsHtml}
        
        <!-- Export Button -->
        <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
          <button onclick="exportFinancialReport()" class="btn btn-primary">
            ğŸ“¥ Export to CSV
          </button>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // åˆ‡æ¢èµ„äº§åˆ†ç±»æ˜¾ç¤º
    function toggleAssetCategory(categoryName) {
      const element = document.getElementById(`asset-category-${categoryName}`);
      if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // å¯¼å‡ºè´¢åŠ¡æŠ¥è¡¨ä¸ºCSV
    function exportFinancialReport() {
      alert('ExportåŠŸèƒ½å¼€å‘ä¸­...');
      // TODO: å®ç°CSVå¯¼å‡ºåŠŸèƒ½
    }
    
    // æ˜¾ç¤ºä»“åº“è®¢å•è¯¦æƒ…
    async function showWarehouseOrderDetails(orderId) {
      debugLog(`æ˜¾ç¤ºä»“åº“è®¢å•è¯¦æƒ…: ${orderId}`);
      
      try {
        const response = await fetch(`/api/warehouse/orders/${orderId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const order = result.data;
          
          // çŠ¶æ€æ˜¾ç¤º
          const statusMap = {
            'pending': 'â³ Pending',
            'confirmed': 'âœ… Confirmed',
            'shipped': 'ğŸšš Shipped',
            'completed': 'âœ”ï¸ Completed',
            'cancelled': 'âŒ Cancelled'
          };
          const statusDisplay = statusMap[order.status] || order.status;
          
          // é…é€æ–¹å¼æ˜¾ç¤º
          const deliveryDisplay = order.deliveryMethod === 'delivery' ? 'ğŸšš Delivery' : 'ğŸª Pickup';
          
          const title = `ğŸ“¦ Warehouse Order Details - ${order.orderNumber}`;
          
          const content = `
            <div style="max-width: 1200px;">
              <!-- Order Header -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <div>
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Merchant Information</h3>
                  <div style="line-height: 1.8;">
                    <div><strong>${order.merchantName}</strong></div>
                    <div>Merchant ID: ${order.merchantId}</div>
                  </div>
                </div>
                
                <div>
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Order Information</h3>
                  <div style="line-height: 1.8;">
                    <div><strong>Order Number:</strong> ${order.orderNumber}</div>
                    <div><strong>Date:</strong> ${new Date(order.orderedAt).toLocaleDateString('en-IE')}</div>
                    <div><strong>Status:</strong> ${statusDisplay}</div>
                    <div><strong>Delivery:</strong> ${deliveryDisplay}</div>
                  </div>
                </div>
              </div>
              
              <!-- Items Table -->
              <div style="margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #1f2937;">Items</h3>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #f8fafc;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Product</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">Quantity</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Unit Price</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">Tax Class</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Tax Amount</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${order.items.map(item => {
                        const taxClassDisplay = item.taxClassification === 'VAT_23' ? 'VAT 23%' : 
                                               item.taxClassification === 'SERVICE_VAT_135' ? 'Service VAT 13.5%' : 
                                               item.taxClassification || 'N/A';
                        return `
                        <tr>
                          <td style="padding: 12px; border: 1px solid #e5e7eb;">
                            <div><strong>${item.productName}</strong></div>
                            ${item.brand ? `<div style="font-size: 12px; color: #6b7280;">Brand: ${item.brand}</div>` : ''}
                            ${item.model ? `<div style="font-size: 12px; color: #6b7280;">Model: ${item.model}</div>` : ''}
                            ${item.sku ? `<div style="font-size: 12px; color: #6b7280;">SKU: ${item.sku}</div>` : ''}
                          </td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${item.quantity}</td>
                          <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">â‚¬${(item.wholesalePrice || 0).toFixed(2)}</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${taxClassDisplay}</td>
                          <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">â‚¬${(item.taxAmount || 0).toFixed(2)}</td>
                          <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: bold;">â‚¬${(item.subtotal || 0).toFixed(2)}</td>
                        </tr>
                      `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Totals -->
              <div style="display: flex; justify-content: flex-end; margin-bottom: 30px;">
                <div style="width: 400px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span>Subtotal (Excl. VAT):</span>
                    <span style="font-weight: bold;">â‚¬${(order.subtotal || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span>VAT Amount:</span>
                    <span style="font-weight: bold;">â‚¬${(order.taxAmount || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 15px 0; font-size: 20px; font-weight: bold; color: #1f2937;">
                    <span>Total Amount (Incl. VAT):</span>
                    <span style="color: #f59e0b;">â‚¬${(order.totalAmount || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>
              
              ${order.notes ? `
              <!-- Notes -->
              <div style="margin-bottom: 30px; padding: 20px; background: #fef3c7; border-radius: 8px;">
                <h3 style="margin: 0 0 10px 0; color: #1f2937;">Notes</h3>
                <p style="margin: 0; color: #92400e;">${order.notes}</p>
              </div>
              ` : ''}
              
              <!-- Actions -->
              <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6; padding: 12px 24px;">
                  Close
                </button>
              </div>
            </div>
          `;
          
          showUniversalModal(title, content);
        } else {
          throw new Error('Failed to get order details');
        }
      } catch (error) {
        debugLog(`âŒ è·å–ä»“åº“è®¢å•è¯¦æƒ…å¤±è´¥: ${error.message}`);
        alert(`âŒ Failed to load order details: ${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºé‡‡è´­å‘ç¥¨è¯¦æƒ…
    async function showPurchaseInvoiceDetails(invoiceId) {
      debugLog(`æ˜¾ç¤ºé‡‡è´­å‘ç¥¨è¯¦æƒ…: ${invoiceId}`);
      
      try {
        const response = await fetch(`/api/admin/purchase-orders/${invoiceId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const invoice = result.data;
          const supplier = invoice.supplier || {};
          
          const title = `ğŸ“„ Purchase Invoice Details - ${invoice.invoiceNumber}`;
          
          const content = `
            <div style="max-width: 1200px;">
              <!-- Invoice Header -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <div>
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Supplier Information</h3>
                  <div style="line-height: 1.8;">
                    <div><strong>${supplier.name || 'N/A'}</strong></div>
                    <div>${supplier.contact?.person ? 'Contact: ' + supplier.contact.person : ''}</div>
                    <div>${supplier.contact?.phone ? 'Phone: ' + supplier.contact.phone : ''}</div>
                    <div>${supplier.contact?.email ? 'Email: ' + supplier.contact.email : ''}</div>
                  </div>
                </div>
                
                <div>
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Invoice Information</h3>
                  <div style="line-height: 1.8;">
                    <div><strong>Invoice Number:</strong> ${invoice.invoiceNumber}</div>
                    <div><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString('en-IE')}</div>
                    <div><strong>Status:</strong> ${invoice.status || 'Confirmed'}</div>
                  </div>
                </div>
              </div>
              
              <!-- Items Table -->
              <div style="margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #1f2937;">Items</h3>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #f8fafc;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Description</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">Quantity</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Unit Price</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Total Price</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">VAT Rate</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${invoice.items.map(item => `
                        <tr>
                          <td style="padding: 12px; border: 1px solid #e5e7eb;">${item.description || item.product?.name || 'N/A'}</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${item.quantity}</td>
                          <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">â‚¬${(item.unitCost || 0).toFixed(2)}</td>
                          <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: bold;">â‚¬${(item.totalCost || 0).toFixed(2)}</td>
                          <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${formatVatRate(item.vatRate)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Totals -->
              <div style="display: flex; justify-content: flex-end; margin-bottom: 30px;">
                <div style="width: 400px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span>Subtotal (Excl. VAT):</span>
                    <span style="font-weight: bold;">â‚¬${(invoice.subtotal || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span>VAT Amount:</span>
                    <span style="font-weight: bold;">â‚¬${(invoice.taxAmount || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 15px 0; font-size: 20px; font-weight: bold; color: #1f2937;">
                    <span>Total Amount (Incl. VAT):</span>
                    <span style="color: #f59e0b;">â‚¬${(invoice.totalAmount || 0).toFixed(2)}</span>
                  </div>
                </div>
              </div>
              
              <!-- Actions -->
              <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6; padding: 12px 24px;">
                  Close
                </button>
              </div>
            </div>
          `;
          
          showUniversalModal(title, content);
        } else {
          throw new Error('Failed to get invoice details');
        }
      } catch (error) {
        debugLog(`âŒ è·å–é‡‡è´­å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${error.message}`);
        alert(`âŒ Failed to load invoice details: ${error.message}`);
      }
    }

    // åŠ è½½ä¾›åº”å•† (ä¿ç•™ç”¨äºå…¥åº“ç®¡ç†)
    async function loadSuppliers() {
      console.log('ğŸ”„ loadSuppliers: å¼€å§‹åŠ è½½ä¾›åº”å•†æ•°æ®');
      debugLog('å¼€å§‹åŠ è½½ä¾›åº”å•†æ•°æ®');
      
      try {
        console.log('ğŸ“¡ å‘é€è¯·æ±‚åˆ° /api/suppliers');
        const response = await fetch('/api/suppliers');
        console.log('ğŸ“¥ æ”¶åˆ°å“åº”:', response.status, response.statusText);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        console.log('ğŸ“¦ è§£æJSONç»“æœ:', result);
        console.log(`âœ… ä¾›åº”å•†æ•°é‡: ${result.data?.length || 0}`);
        
        debugLog(`ä¾›åº”å•†APIå“åº”: ${result.data?.length || 0} ä¸ªä¾›åº”å•†`);
        
        return result.data || [];
      } catch (error) {
        console.error('âŒ ä¾›åº”å•†æ•°æ®åŠ è½½å¤±è´¥:', error);
        debugLog(`âŒ ä¾›åº”å•†æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
        return [];
      }
    }

    // åŠ è½½äº§å“åˆ†ç±»
    async function loadCategories() {
      console.log('ğŸ”„ å¼€å§‹åŠ è½½äº§å“åˆ†ç±»æ•°æ®');
      debugLog('å¼€å§‹åŠ è½½äº§å“åˆ†ç±»æ•°æ®');
      
      try {
        const response = await fetch('/api/admin/categories');
        console.log('ğŸ“¥ åˆ†ç±»APIå“åº”:', response.status, response.statusText);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        console.log('ğŸ“¦ åˆ†ç±»æ•°æ®:', result);
        console.log(`âœ… åˆ†ç±»æ•°é‡: ${result.data?.length || 0}`);
        
        debugLog(`åˆ†ç±»APIå“åº”: ${result.data?.length || 0} ä¸ªåˆ†ç±»`);
        
        return result.data || [];
      } catch (error) {
        console.error('âŒ åˆ†ç±»æ•°æ®åŠ è½½å¤±è´¥:', error);
        debugLog(`âŒ åˆ†ç±»æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
        return [];
      }
    }

    // åŠ è½½è®¾å¤‡æˆè‰²
    async function loadConditions() {
      console.log('ğŸ”„ å¼€å§‹åŠ è½½è®¾å¤‡æˆè‰²æ•°æ®');
      debugLog('å¼€å§‹åŠ è½½è®¾å¤‡æˆè‰²æ•°æ®');
      
      try {
        const response = await fetch('/api/admin/conditions');
        console.log('ğŸ“¥ æˆè‰²APIå“åº”:', response.status, response.statusText);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        console.log('ğŸ“¦ æˆè‰²æ•°æ®:', result);
        console.log(`âœ… æˆè‰²æ•°é‡: ${result.data?.length || 0}`);
        
        debugLog(`æˆè‰²APIå“åº”: ${result.data?.length || 0} ä¸ªæˆè‰²`);
        
        return result.data || [];
      } catch (error) {
        console.error('âŒ æˆè‰²æ•°æ®åŠ è½½å¤±è´¥:', error);
        debugLog(`âŒ æˆè‰²æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
        return [];
      }
    }

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadAllData() {
      debugLog('=== å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ® ===');
      await loadStats();
      await loadCategoryCards();
      debugLog('=== æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ ===');
    }

    // å¤„ç†æ–‡ä»¶ä¸Šä¼  - å®ç°çœŸå®çš„å›¾ç‰‡è¯†åˆ«å…¥åº“åŠŸèƒ½
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      debugLog(`é€‰æ‹©æ–‡ä»¶: ${file.name} (${file.type})`);
      
      const resultContainer = document.getElementById('recognitionResult');
      resultContainer.style.display = 'block';
      resultContainer.innerHTML = `
        <div class="card" style="margin-top: 20px;">
          <h3>ğŸ” æ­£åœ¨è¯†åˆ«å‘ç¥¨å†…å®¹...</h3>
          <div class="loading">è¯·ç¨å€™ï¼Œæ­£åœ¨ä½¿ç”¨AIè¯†åˆ«å‘ç¥¨ä¿¡æ¯...</div>
        </div>
      `;
      
      try {
        const formData = new FormData();
        formData.append('invoice', file);
        
        debugLog('å¼€å§‹è°ƒç”¨è¯†åˆ«API...');
        const response = await fetch(`${API_BASE}/recognize-invoice`, {
          method: 'POST',
          body: formData
        });
        
        debugLog(`APIå“åº”çŠ¶æ€: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`å›¾ç‰‡è¯†åˆ«APIå“åº”: ${JSON.stringify(result).substring(0, 200)}...`);
        
        if (result.success && result.data) {
          await displayRecognitionResult(result.data);
        } else {
          throw new Error(result.message || 'è¯†åˆ«å¤±è´¥');
        }
      } catch (error) {
        console.error('å›¾ç‰‡è¯†åˆ«å¤±è´¥:', error);
        debugLog(`âŒ å›¾ç‰‡è¯†åˆ«å¤±è´¥: ${error.message}`);
        resultContainer.innerHTML = `
          <div class="card" style="margin-top: 20px;">
            <div class="error">âŒ è¯†åˆ«å¤±è´¥: ${error.message}</div>
            <button onclick="document.getElementById('fileInput').click()" class="btn" style="margin-top: 15px;">
              é‡æ–°ä¸Šä¼ 
            </button>
          </div>
        `;
      }
    }

    // åˆ‡æ¢å…¥åº“æ¨¡å¼
    async function switchReceivingMode(mode) {
      console.log('ğŸ”„ åˆ‡æ¢å…¥åº“æ¨¡å¼:', mode);
      const uploadMode = document.getElementById('uploadMode');
      const manualMode = document.getElementById('manualMode');
      const uploadBtn = document.getElementById('uploadModeBtn');
      const manualBtn = document.getElementById('manualModeBtn');
      
      if (mode === 'upload') {
        uploadMode.style.display = 'block';
        manualMode.style.display = 'none';
        uploadBtn.classList.add('btn-primary');
        uploadBtn.style.background = '';
        manualBtn.classList.remove('btn-primary');
        manualBtn.style.background = '#48bb78';
        console.log('âœ… åˆ‡æ¢åˆ°å‘ç¥¨ä¸Šä¼ æ¨¡å¼');
        debugLog('åˆ‡æ¢åˆ°å‘ç¥¨ä¸Šä¼ æ¨¡å¼');
      } else {
        uploadMode.style.display = 'none';
        manualMode.style.display = 'block';
        manualBtn.classList.add('btn-primary');
        manualBtn.style.background = '';
        uploadBtn.classList.remove('btn-primary');
        uploadBtn.style.background = '#48bb78';
        console.log('âœ… åˆ‡æ¢åˆ°æ‰‹åŠ¨å½•å…¥æ¨¡å¼');
        debugLog('åˆ‡æ¢åˆ°æ‰‹åŠ¨å½•å…¥æ¨¡å¼');
        
        // åŠ è½½ä¾›åº”å•†åˆ—è¡¨
        console.log('ğŸ”„ å‡†å¤‡åŠ è½½ä¾›åº”å•†åˆ—è¡¨...');
        loadSuppliersForManual();
        
        // åŠ è½½åˆ†ç±»å’Œæˆè‰²æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰
        if (!window.categoriesData || window.categoriesData.length === 0) {
          console.log('ğŸ”„ åŠ è½½äº§å“åˆ†ç±»æ•°æ®...');
          try {
            const categories = await loadCategories();
            window.categoriesData = categories;
            console.log(`âœ… åˆ†ç±»æ•°æ®å·²åŠ è½½: ${categories.length} ä¸ªåˆ†ç±»`);
          } catch (err) {
            console.error('âŒ åŠ è½½åˆ†ç±»æ•°æ®å¤±è´¥:', err);
            window.categoriesData = [];
          }
        }
        
        if (!window.conditionsData || window.conditionsData.length === 0) {
          console.log('ğŸ”„ åŠ è½½è®¾å¤‡æˆè‰²æ•°æ®...');
          try {
            const conditions = await loadConditions();
            window.conditionsData = conditions;
            console.log(`âœ… æˆè‰²æ•°æ®å·²åŠ è½½: ${conditions.length} ä¸ªæˆè‰²`);
          } catch (err) {
            console.error('âŒ åŠ è½½æˆè‰²æ•°æ®å¤±è´¥:', err);
            window.conditionsData = [];
          }
        }
        
        // å¦‚æœæ²¡æœ‰äº§å“è¡Œï¼Œæ·»åŠ ä¸€ä¸ªï¼ˆç­‰å¾…æ•°æ®åŠ è½½å®Œæˆåï¼‰
        if (document.getElementById('manualProductsTable').children.length === 0) {
          console.log('â• æ·»åŠ ç¬¬ä¸€ä¸ªäº§å“è¡Œ');
          addManualProduct();
        }
      }
    }

    // ä¸ºæ‰‹åŠ¨å½•å…¥åŠ è½½ä¾›åº”å•†
    async function loadSuppliersForManual() {
      console.log('ğŸ”„ å¼€å§‹åŠ è½½ä¾›åº”å•†...');
      try {
        const suppliers = await loadSuppliers();
        console.log('ğŸ“¦ è·å–åˆ°ä¾›åº”å•†æ•°æ®:', suppliers);
        
        const select = document.getElementById('manualSupplier');
        if (!select) {
          console.error('âŒ æ‰¾ä¸åˆ° manualSupplier å…ƒç´ ');
          return;
        }
        
        console.log('âœ… æ‰¾åˆ° select å…ƒç´ :', select);
        select.innerHTML = '<option value="">é€‰æ‹©ä¾›åº”å•†...</option>';
        
        if (!suppliers || suppliers.length === 0) {
          console.warn('âš ï¸  æ²¡æœ‰ä¾›åº”å•†æ•°æ®');
          return;
        }
        
        suppliers.forEach((supplier, index) => {
          console.log(`  æ·»åŠ ä¾›åº”å•† ${index + 1}:`, supplier.name, supplier._id);
          const option = document.createElement('option');
          option.value = supplier._id;
          option.textContent = supplier.name;
          select.appendChild(option);
        });
        
        console.log(`âœ… æˆåŠŸåŠ è½½äº† ${suppliers.length} ä¸ªä¾›åº”å•†`);
        debugLog(`åŠ è½½äº† ${suppliers.length} ä¸ªä¾›åº”å•†`);
      } catch (error) {
        console.error('âŒ åŠ è½½ä¾›åº”å•†å¤±è´¥:', error);
        debugLog(`åŠ è½½ä¾›åº”å•†å¤±è´¥: ${error.message}`);
      }
    }

    // æ·»åŠ æ‰‹åŠ¨å½•å…¥äº§å“è¡Œ
    function addManualProduct() {
      const table = document.getElementById('manualProductsTable');
      const index = table.children.length;
      
      // ä½¿ç”¨å…¨å±€å˜é‡ä¸­çš„åˆ†ç±»å’Œæˆè‰²æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç©ºæ•°ç»„
      const categories = window.categoriesData || [];
      const conditions = window.conditionsData || [];
      
      console.log(`ğŸ“ æ·»åŠ æ‰‹åŠ¨äº§å“è¡Œ ${index}`);
      console.log(`   åˆ†ç±»æ•°æ®: ${categories.length} ä¸ª`);
      console.log(`   æˆè‰²æ•°æ®: ${conditions.length} ä¸ª`);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding: 8px;">
          <input type="text" placeholder="äº§å“åç§°" 
                 style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'name', this.value)">
        </td>
        <td style="padding: 8px;">
          <input type="text" placeholder="å“ç‰Œ" 
                 style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'brand', this.value)">
        </td>
        <td style="padding: 8px;">
          <input type="text" placeholder="å‹å·/è§„æ ¼" 
                 style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'model', this.value)">
        </td>
        <td style="padding: 8px;">
          <input type="text" placeholder="é¢œè‰²/ç±»å‹"
                 style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'color', this.value)">
        </td>
        <td style="padding: 8px;">
          <select onchange="updateManualProduct(${index}, 'productType', this.value); updateManualVatRate(${index}); updateManualProductRow(${index})"
                  style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <option value="">é€‰æ‹©åˆ†ç±»...</option>
            ${generateCategoryOptions(categories, '')}
          </select>
        </td>
        <td style="padding: 8px;">
          <input type="number" value="1" min="1"
                 style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'quantity', this.value); updateManualProductRow(${index})">
        </td>
        <td style="padding: 8px;">
          <input type="number" step="0.01" min="0" placeholder="0.00"
                 style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'purchasePrice', this.value)">
        </td>
        <td style="padding: 8px;">
          <input type="number" step="0.01" min="0" placeholder="0.00"
                 style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'wholesalePrice', this.value)">
        </td>
        <td style="padding: 8px;">
          <input type="number" step="0.01" min="0" placeholder="0.00"
                 style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'retailPrice', this.value)">
        </td>
        <td style="padding: 8px;">
          <select onchange="updateManualProduct(${index}, 'vatRate', this.value)"
                  style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <option value="VAT 23%">VAT 23%</option>
            <option value="VAT 13.5%">VAT 13.5%</option>
            <option value="VAT 0%">VAT 0%</option>
          </select>
        </td>
        <td style="padding: 8px;">
          <div id="manualIdentifier_${index}">
            <input type="text" placeholder="æ¡ç ï¼ˆå¯é€‰ï¼‰"
                   style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                   onchange="updateManualProduct(${index}, 'barcode', this.value)">
          </div>
        </td>
        <td style="padding: 8px;">
          <select onchange="updateManualProduct(${index}, 'condition', this.value)"
                  style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
            ${generateConditionOptions(conditions, 'BRAND NEW')}
          </select>
        </td>
        <td style="padding: 8px;">
          <button onclick="removeManualProduct(${index})" 
                  style="padding: 4px 8px; background: #fed7d7; color: #c53030; border: none; border-radius: 4px; cursor: pointer;">
            âŒ
          </button>
        </td>
      `;
      
      table.appendChild(row);
      
      // åˆå§‹åŒ–äº§å“æ•°æ®
      if (!window.manualProducts) {
        window.manualProducts = [];
      }
      window.manualProducts[index] = {
        name: '',
        brand: '',
        model: '',
        color: '',
        quantity: 1,
        purchasePrice: 0,
        wholesalePrice: 0,
        retailPrice: 0,
        productType: '',
        vatRate: 'VAT 23%',
        condition: 'BRAND NEW',
        barcode: '',
        serialNumbers: []
      };
      
      debugLog(`æ·»åŠ æ‰‹åŠ¨å½•å…¥äº§å“è¡Œ ${index}`);
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥äº§å“æ•°æ®
    function updateManualProduct(index, field, value) {
      if (!window.manualProducts) window.manualProducts = [];
      if (!window.manualProducts[index]) window.manualProducts[index] = {};
      
      window.manualProducts[index][field] = value;
      debugLog(`æ›´æ–°æ‰‹åŠ¨äº§å“ ${index} çš„ ${field}: ${value}`);
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥ç¨ç‡
    function updateManualVatRate(index) {
      const productType = window.manualProducts[index]?.productType;
      const defaultVatRate = getDefaultVatRate(productType);
      
      // æ›´æ–°ç¨ç‡é€‰æ‹©æ¡†
      const row = document.getElementById('manualProductsTable').children[index];
      const vatRateSelect = row.cells[6].querySelector('select');
      vatRateSelect.value = defaultVatRate;
      
      updateManualProduct(index, 'vatRate', defaultVatRate);
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥äº§å“è¡Œï¼ˆå¤„ç†è®¾å¤‡ç±»äº§å“çš„åºåˆ—å·è¾“å…¥ï¼‰
    function updateManualProductRow(index) {
      const product = window.manualProducts[index];
      // æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å«è®¾å¤‡ç›¸å…³å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
      const categoryLower = (product?.productType || '').toLowerCase();
      const isDevice = categoryLower.includes('device') || 
                      categoryLower.includes('è®¾å¤‡') || 
                      categoryLower.includes('æ‰‹æœº') || 
                      categoryLower.includes('phone') || 
                      categoryLower.includes('iphone') || 
                      categoryLower.includes('samsung') || 
                      categoryLower.includes('tablet') || 
                      categoryLower.includes('å¹³æ¿') || 
                      categoryLower.includes('watch') || 
                      categoryLower.includes('æ‰‹è¡¨');
      const quantity = parseInt(product?.quantity) || 1;
      
      const row = document.getElementById('manualProductsTable').children[index];
      const identifierCell = row.cells[10];  // æ¡ç /IMEI/SNåˆ—ï¼ˆç¬¬11åˆ—ï¼Œç´¢å¼•10ï¼‰
      const colorCell = row.cells[3];  // é¢œè‰²/ç±»å‹åˆ—ï¼ˆç¬¬4åˆ—ï¼Œç´¢å¼•3ï¼‰
      const identifierContainer = identifierCell.querySelector(`#manualIdentifier_${index}`);
      
      if (isDevice) {
        // è®¾å¤‡äº§å“ï¼šç”Ÿæˆå¤šä¸ªåºåˆ—å·å’Œé¢œè‰²è¾“å…¥æ¡†
        let identifierInputs = '';
        let colorInputs = '';
        
        for (let i = 0; i < quantity; i++) {
          const serialData = product.serialNumbers?.[i] || {};
          const serialNumber = typeof serialData === 'object' ? serialData.serialNumber : serialData;
          const color = typeof serialData === 'object' ? serialData.color : '';
          
          identifierInputs += `
            <div style="margin-bottom: 4px;">
              <input type="text" id="manualSerial_${index}_${i}" value="${serialNumber || ''}" 
                     placeholder="SN/IMEI ${i + 1} (å¿…å¡«)"
                     style="width: 120px; padding: 4px; border: 1px solid ${serialNumber ? '#e2e8f0' : '#f56565'}; border-radius: 4px;"
                     onchange="updateManualSerialNumber(${index}, ${i}, this.value, document.getElementById('manualColor_${index}_${i}').value)"
                     required>
            </div>
          `;
          
          colorInputs += `
            <div style="margin-bottom: 4px;">
              <input type="text" id="manualColor_${index}_${i}" value="${color || ''}" 
                     placeholder="é¢œè‰² ${i + 1}"
                     style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                     onchange="updateManualSerialNumber(${index}, ${i}, document.getElementById('manualSerial_${index}_${i}').value, this.value)">
            </div>
          `;
        }
        
        identifierContainer.innerHTML = identifierInputs;
        colorCell.innerHTML = colorInputs;
      } else {
        // é…ä»¶äº§å“ï¼šå•ä¸ªæ¡ç è¾“å…¥æ¡†å’Œé¢œè‰²è¾“å…¥æ¡†
        identifierContainer.innerHTML = `
          <input type="text" value="${product?.barcode || ''}" placeholder="æ¡ç ï¼ˆå¯é€‰ï¼‰"
                 style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'barcode', this.value)">
        `;
        
        colorCell.innerHTML = `
          <input type="text" value="${product?.color || ''}" placeholder="é¢œè‰²"
                 style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'color', this.value)">
        `;
      }
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥åºåˆ—å·å’Œé¢œè‰²
    function updateManualSerialNumber(productIndex, serialIndex, serialNumber, color) {
      if (!window.manualProducts[productIndex].serialNumbers) {
        window.manualProducts[productIndex].serialNumbers = [];
      }
      
      // å­˜å‚¨ä¸ºå¯¹è±¡ï¼ŒåŒ…å«åºåˆ—å·å’Œé¢œè‰²
      window.manualProducts[productIndex].serialNumbers[serialIndex] = {
        serialNumber: serialNumber,
        color: color
      };
      
      debugLog(`æ›´æ–°æ‰‹åŠ¨äº§å“ ${productIndex} çš„åºåˆ—å· ${serialIndex}: ${serialNumber}, é¢œè‰²: ${color}`);
    }

    // ç§»é™¤æ‰‹åŠ¨å½•å…¥äº§å“è¡Œ
    function removeManualProduct(index) {
      const table = document.getElementById('manualProductsTable');
      if (table.children.length > 1) {
        table.children[index].remove();
        window.manualProducts.splice(index, 1);
        debugLog(`ç§»é™¤æ‰‹åŠ¨äº§å“è¡Œ ${index}`);
        
        // é‡æ–°ç¼–å·æ‰€æœ‰è¡Œ
        Array.from(table.children).forEach((row, newIndex) => {
          updateRowIndexes(row, newIndex);
        });
      } else {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªäº§å“è¡Œ');
      }
    }

    // æ›´æ–°è¡Œç´¢å¼•
    function updateRowIndexes(row, newIndex) {
      // æ›´æ–°æ‰€æœ‰çš„onclickå’Œonchangeäº‹ä»¶ä¸­çš„ç´¢å¼•
      const inputs = row.querySelectorAll('input, select');
      inputs.forEach(input => {
        if (input.onchange) {
          const onchangeStr = input.onchange.toString();
          const updatedStr = onchangeStr.replace(/\d+/g, newIndex);
          input.setAttribute('onchange', updatedStr.match(/updateManual[^}]+}/)[0]);
        }
      });
      
      const button = row.querySelector('button');
      if (button) {
        button.setAttribute('onclick', `removeManualProduct(${newIndex})`);
      }
    }

    // æ¸…ç©ºæ‰‹åŠ¨å½•å…¥è¡¨å•
    function clearManualForm() {
      document.getElementById('manualSupplier').value = '';
      document.getElementById('manualInvoiceNumber').value = '';
      document.getElementById('manualProductsTable').innerHTML = '';
      window.manualProducts = [];
      addManualProduct();
      debugLog('æ¸…ç©ºæ‰‹åŠ¨å½•å…¥è¡¨å•');
    }

    // ç¡®è®¤æ‰‹åŠ¨å½•å…¥
    async function confirmManualReceiving() {
      const supplierId = document.getElementById('manualSupplier').value;
      const invoiceNumber = document.getElementById('manualInvoiceNumber').value;
      
      if (!supplierId) {
        alert('è¯·é€‰æ‹©ä¾›åº”å•†');
        return;
      }
      
      if (!invoiceNumber.trim()) {
        alert('è¯·è¾“å…¥å‘ç¥¨å·ç ');
        return;
      }
      
      // éªŒè¯äº§å“æ•°æ®
      const validationErrors = [];
      const products = window.manualProducts || [];
      
      products.forEach((product, index) => {
        if (!product.name?.trim()) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·è¾“å…¥äº§å“åç§°`);
        }
        
        if (!product.productType) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·é€‰æ‹©äº§å“åˆ†ç±»`);
        }
        
        if (!product.purchasePrice || product.purchasePrice <= 0) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·è¾“å…¥æœ‰æ•ˆçš„è¿›è´§ä»·`);
        }
        
        // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å· - æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å«è®¾å¤‡ç›¸å…³å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        const categoryLower = (product.productType || '').toLowerCase();
        const isDevice = categoryLower.includes('device') || 
                        categoryLower.includes('è®¾å¤‡') || 
                        categoryLower.includes('æ‰‹æœº') || 
                        categoryLower.includes('phone') || 
                        categoryLower.includes('iphone') || 
                        categoryLower.includes('samsung') || 
                        categoryLower.includes('tablet') || 
                        categoryLower.includes('å¹³æ¿') || 
                        categoryLower.includes('watch') || 
                        categoryLower.includes('æ‰‹è¡¨');
        
        if (isDevice) {
          const quantity = parseInt(product.quantity) || 1;
          const serialNumbers = product.serialNumbers || [];
          
          // è¿‡æ»¤å‡ºå·²å¡«å†™çš„åºåˆ—å·ï¼ˆå¤„ç†å¯¹è±¡å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼ï¼‰
          const filledSerialNumbers = serialNumbers.filter(sn => {
            if (typeof sn === 'object' && sn !== null) {
              return sn.serialNumber && sn.serialNumber.trim();
            } else if (typeof sn === 'string') {
              return sn.trim();
            }
            return false;
          });
          
          if (filledSerialNumbers.length < quantity) {
            validationErrors.push(`äº§å“ "${product.name}" éœ€è¦å¡«å†™ ${quantity} ä¸ªåºåˆ—å·ï¼Œä½†åªå¡«å†™äº† ${filledSerialNumbers.length} ä¸ª`);
          }
        }
      });
      
      if (validationErrors.length > 0) {
        alert('âŒ éªŒè¯å¤±è´¥ï¼š\n\n' + validationErrors.join('\n'));
        return;
      }
      
      // è·å–ä¾›åº”å•†ä¿¡æ¯
      const supplierSelect = document.getElementById('manualSupplier');
      const supplierName = supplierSelect.options[supplierSelect.selectedIndex].text;
      
      // è®¡ç®—å‘ç¥¨æ€»é¢å’Œç¨é¢
      const calculateManualInvoiceTotals = (products) => {
        let subtotal = 0;
        let totalTax = 0;
        
        products.forEach(p => {
          const itemSubtotal = (parseFloat(p.purchasePrice) || 0) * (parseInt(p.quantity) || 1);
          subtotal += itemSubtotal;
          
          // æ ¹æ®VATç¨ç‡è®¡ç®—ç¨é¢
          let itemTax = 0;
          if (p.vatRate === 'VAT 23%') {
            itemTax = itemSubtotal * 0.23;
          } else if (p.vatRate === 'VAT 13.5%') {
            itemTax = itemSubtotal * 0.135;
          } else if (p.vatRate === 'VAT 0%') {
            itemTax = 0;
          }
          totalTax += itemTax;
        });
        
        return {
          subtotal: subtotal,
          tax: totalTax,
          total: subtotal + totalTax
        };
      };
      
      const invoiceTotals = calculateManualInvoiceTotals(products);
      
      // æ„é€ å…¥åº“æ•°æ®
      const requestData = {
        supplier: {
          _id: supplierId,
          name: supplierName,
          email: '',
          phone: '',
          address: '',
          contactPerson: '',
          confidence: 100 // æ‰‹åŠ¨å½•å…¥ï¼Œç½®ä¿¡åº¦100%
        },
        products: products.map(product => {
          const baseProduct = {
            name: product.name || '',
            brand: product.brand || '',
            model: product.model || '',
            color: product.color || '',
            quantity: parseInt(product.quantity) || 1,
            unitPrice: parseFloat(product.purchasePrice) || 0,
            totalPrice: (parseInt(product.quantity) || 1) * (parseFloat(product.purchasePrice) || 0),
            wholesalePrice: parseFloat(product.wholesalePrice) || 0,
            retailPrice: parseFloat(product.retailPrice) || (parseFloat(product.wholesalePrice) || 0) * 1.3,
            category: product.productType || 'æ‰‹æœºé…ä»¶',
            vatRate: product.vatRate || getDefaultVatRate(product.productType),
            condition: product.condition || 'Brand New'
          };
          
          // å¤„ç†æ¡ç å’Œåºåˆ—å· - æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å«è®¾å¤‡ç›¸å…³å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          const categoryLower = (product.productType || '').toLowerCase();
          const isDevice = categoryLower.includes('device') || 
                          categoryLower.includes('è®¾å¤‡') || 
                          categoryLower.includes('æ‰‹æœº') || 
                          categoryLower.includes('phone') || 
                          categoryLower.includes('iphone') || 
                          categoryLower.includes('samsung') || 
                          categoryLower.includes('tablet') || 
                          categoryLower.includes('å¹³æ¿') || 
                          categoryLower.includes('watch') || 
                          categoryLower.includes('æ‰‹è¡¨');
          
          if (isDevice) {
            // è®¾å¤‡äº§å“ï¼šå¤„ç†åºåˆ—å·æ•°ç»„
            if (product.serialNumbers && product.serialNumbers.length > 0) {
              // ä¸ºæ¯ä¸ªåºåˆ—å·åˆ›å»ºä¸€ä¸ªäº§å“è®°å½•
              return product.serialNumbers
                .filter(sn => {
                  // æ”¯æŒå­—ç¬¦ä¸²æˆ–å¯¹è±¡æ ¼å¼
                  if (typeof sn === 'string') return sn && sn.trim();
                  if (typeof sn === 'object') return sn.serialNumber && sn.serialNumber.trim();
                  return false;
                })
                .map(serialData => {
                  // å¤„ç†å­—ç¬¦ä¸²æˆ–å¯¹è±¡æ ¼å¼
                  const serialNumber = typeof serialData === 'string' ? serialData : serialData.serialNumber;
                  const color = typeof serialData === 'object' ? serialData.color : '';
                  
                  return {
                    ...baseProduct,
                    quantity: 1, // æ¯ä¸ªåºåˆ—å·å¯¹åº”ä¸€ä¸ªäº§å“
                    serialNumber: serialNumber,
                    color: color || baseProduct.color, // ä½¿ç”¨åºåˆ—å·çš„é¢œè‰²æˆ–äº§å“çš„é¢œè‰²
                    totalPrice: baseProduct.unitPrice
                  };
                });
            } else {
              return [baseProduct];
            }
          } else {
            // é…ä»¶äº§å“ï¼šå¤„ç†æ¡ç 
            return [{
              ...baseProduct,
              barcode: product.barcode || ''
            }];
          }
        }).flat(), // å±•å¹³æ•°ç»„ï¼Œå› ä¸ºè®¾å¤‡äº§å“å¯èƒ½äº§ç”Ÿå¤šä¸ªè®°å½•
        invoiceInfo: {
          number: invoiceNumber,
          date: new Date().toISOString().split('T')[0],
          dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          currency: 'EUR',
          subtotal: invoiceTotals.subtotal,
          tax: invoiceTotals.tax,
          total: invoiceTotals.total
        }
      };
      
      debugLog('å¼€å§‹æ‰‹åŠ¨å½•å…¥ç¡®è®¤å…¥åº“');
      debugLog('å‘é€æ‰‹åŠ¨å…¥åº“æ•°æ®:', JSON.stringify(requestData, null, 2));
      
      try {
        const response = await fetch(`${API_BASE}/receiving/confirm`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        debugLog(`æ‰‹åŠ¨å…¥åº“ç¡®è®¤APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success) {
          alert(`âœ… æ‰‹åŠ¨å…¥åº“æˆåŠŸï¼\n\nåˆ›å»ºäº§å“: ${result.data.productsCreated} ä¸ª\næ›´æ–°äº§å“: ${result.data.productsUpdated} ä¸ª`);
          clearManualForm();
          loadAllData(); // åˆ·æ–°æ•°æ®
        } else {
          throw new Error(result.error || result.message || 'å…¥åº“å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ æ‰‹åŠ¨å…¥åº“å¤±è´¥: ${error.message}`);
        alert(`âŒ æ‰‹åŠ¨å…¥åº“å¤±è´¥: ${error.message}`);
      }
    }

    // è·å–é»˜è®¤ç¨ç‡
    function getDefaultVatRate(productType) {
      const vatRates = {
        'æ‰‹æœºé…ä»¶': 'VAT 23%',
        'ç”µè„‘é…ä»¶': 'VAT 23%',
        'è½¦è½½é…ä»¶': 'VAT 23%',
        'audio': 'VAT 23%',
        'æ•°æ®çº¿': 'VAT 23%',
        'power supply': 'VAT 23%',
        'å…¨æ–°è®¾å¤‡': 'VAT 23%',
        'äºŒæ‰‹è®¾å¤‡': 'VAT 13.5%',
        'ç»´ä¿®': 'VAT 13.5%'
      };
      return vatRates[productType] || 'VAT 23%';
    }

    // ç”Ÿæˆåˆ†ç±»é€‰é¡¹
    function generateCategoryOptions(categories, selectedType) {
      if (!categories || categories.length === 0) {
        // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°åˆ†ç±»ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹
        return `
          <option value="æ‰‹æœºé…ä»¶" ${selectedType === 'æ‰‹æœºé…ä»¶' ? 'selected' : ''}>æ‰‹æœºé…ä»¶</option>
          <option value="ç”µè„‘é…ä»¶" ${selectedType === 'ç”µè„‘é…ä»¶' ? 'selected' : ''}>ç”µè„‘é…ä»¶</option>
          <option value="è½¦è½½é…ä»¶" ${selectedType === 'è½¦è½½é…ä»¶' ? 'selected' : ''}>è½¦è½½é…ä»¶</option>
          <option value="audio" ${selectedType === 'audio' ? 'selected' : ''}>Audio</option>
          <option value="æ•°æ®çº¿" ${selectedType === 'æ•°æ®çº¿' ? 'selected' : ''}>æ•°æ®çº¿</option>
          <option value="power supply" ${selectedType === 'power supply' ? 'selected' : ''}>Power Supply</option>
          <option value="å…¨æ–°è®¾å¤‡" ${selectedType === 'å…¨æ–°è®¾å¤‡' ? 'selected' : ''}>å…¨æ–°è®¾å¤‡</option>
          <option value="äºŒæ‰‹è®¾å¤‡" ${selectedType === 'äºŒæ‰‹è®¾å¤‡' ? 'selected' : ''}>äºŒæ‰‹è®¾å¤‡</option>
          <option value="ç»´ä¿®" ${selectedType === 'ç»´ä¿®' ? 'selected' : ''}>ç»´ä¿®</option>
        `;
      }
      
      return categories
        .filter(cat => cat.isActive)
        .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0))
        .map(cat => `<option value="${cat.type}" ${cat.type === selectedType ? 'selected' : ''}>${cat.type}</option>`)
        .join('');
    }

    // ç”Ÿæˆæˆè‰²é€‰é¡¹
    function generateConditionOptions(conditions, selectedCondition) {
      if (!conditions || conditions.length === 0) {
        // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°æˆè‰²ï¼Œä½¿ç”¨é»˜è®¤é€‰é¡¹
        return `
          <option value="Brand New" ${selectedCondition === 'Brand New' ? 'selected' : ''}>å…¨æ–°</option>
          <option value="Pre-Owned" ${selectedCondition === 'Pre-Owned' ? 'selected' : ''}>äºŒæ‰‹</option>
          <option value="Refurbished" ${selectedCondition === 'Refurbished' ? 'selected' : ''}>ç¿»æ–°</option>
        `;
      }
      
      return conditions
        .filter(cond => cond.isActive)
        .sort((a, b) => (a.sortOrder || 0) - (b.sortOrder || 0))
        .map(cond => `<option value="${cond.code}" ${cond.code === selectedCondition ? 'selected' : ''}>${cond.name}</option>`)
        .join('');
    }

    // æ›´æ–°ç¨ç‡
    function updateVatRate(productIndex) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      const product = window.recognizedData.products[productIndex];
      const defaultVatRate = getDefaultVatRate(product.productType);
      product.vatRate = defaultVatRate;
      
      // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ›´æ–°ç¨ç‡æ˜¾ç¤º
      displayRecognitionResult(window.recognizedData);
      
      debugLog(`äº§å“ ${productIndex} ç¨ç‡æ›´æ–°ä¸º: ${defaultVatRate}`);
    }

    // ç”Ÿæˆæ¡ç /åºåˆ—å·è¾“å…¥æ¡†
    function generateIdentifierInputs(product, index) {
      // æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å« "Device" å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
      const isDevice = product.productType?.toLowerCase().includes('device');
      const quantity = parseInt(product.quantity) || 1;
      
      if (!isDevice) {
        // é…ä»¶ç±»äº§å“ï¼Œåªéœ€è¦ä¸€ä¸ªæ¡ç è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
        return `
          <input type="text" value="${product.barcode || ''}" 
                 placeholder="æ¡ç ï¼ˆå¯é€‰ï¼‰"
                 style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateProductField(${index}, 'barcode', this.value)">
        `;
      } else {
        // è®¾å¤‡ç±»äº§å“ï¼Œéœ€è¦æ ¹æ®æ•°é‡ç”Ÿæˆå¤šä¸ªSN/IMEIè¾“å…¥æ¡†å’Œé¢œè‰²è¾“å…¥æ¡†
        const serialNumbers = product.serialNumbers || [];
        let inputs = '';
        
        for (let i = 0; i < quantity; i++) {
          const serialData = typeof serialNumbers[i] === 'object' ? serialNumbers[i] : { serialNumber: serialNumbers[i] || '', color: '' };
          inputs += `
            <div style="margin-bottom: 6px; display: flex; gap: 4px; align-items: center;">
              <input type="text" id="serial_${index}_${i}" value="${serialData.serialNumber || ''}" 
                     placeholder="SN/IMEI ${i + 1}"
                     style="width: 140px; padding: 4px; border: 1px solid ${serialData.serialNumber ? '#e2e8f0' : '#f56565'}; border-radius: 4px; font-size: 12px;"
                     onchange="updateSerialNumber(${index}, ${i}, this.value, document.getElementById('color_${index}_${i}').value)"
                     required>
              <input type="text" id="color_${index}_${i}" value="${serialData.color || product.color || ''}" 
                     placeholder="é¢œè‰²"
                     style="width: 60px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px;"
                     onchange="updateSerialNumber(${index}, ${i}, document.getElementById('serial_${index}_${i}').value, this.value)">
            </div>
          `;
        }
        
        return `<div>${inputs}</div>`;
      }
    }

    // æ›´æ–°åºåˆ—å·å’Œé¢œè‰²
    function updateSerialNumber(productIndex, serialIndex, serialNumber, color) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      const product = window.recognizedData.products[productIndex];
      if (!product.serialNumbers) {
        product.serialNumbers = [];
      }
      
      // å­˜å‚¨ä¸ºå¯¹è±¡ï¼ŒåŒ…å«åºåˆ—å·å’Œé¢œè‰²
      product.serialNumbers[serialIndex] = {
        serialNumber: serialNumber || '',
        color: color || product.color || ''
      };
      
      debugLog(`æ›´æ–°äº§å“ ${productIndex} çš„åºåˆ—å· ${serialIndex}: ${serialNumber}, é¢œè‰²: ${color}`);
      
      // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·å®Œæ•´æ€§
      validateDeviceSerialNumbers(productIndex);
    }

    // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·å®Œæ•´æ€§
    function validateDeviceSerialNumbers(productIndex) {
      const product = window.recognizedData.products[productIndex];
      const isDevice = product.productType?.toLowerCase().includes('device');
      
      if (isDevice) {
        const quantity = parseInt(product.quantity) || 1;
        const serialNumbers = product.serialNumbers || [];
        const filledCount = serialNumbers.filter(sn => {
          if (typeof sn === 'object') {
            return sn.serialNumber && sn.serialNumber.trim();
          }
          return sn && sn.trim();
        }).length;
        
        if (filledCount < quantity) {
          debugLog(`âš ï¸ äº§å“ ${productIndex} éœ€è¦ ${quantity} ä¸ªåºåˆ—å·ï¼Œä½†åªå¡«å†™äº† ${filledCount} ä¸ª`);
        } else {
          debugLog(`âœ… äº§å“ ${productIndex} åºåˆ—å·å¡«å†™å®Œæ•´`);
        }
      }
    }

    // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
    async function displayRecognitionResult(data) {
      const resultContainer = document.getElementById('recognitionResult');
      
      try {
        debugLog('å¼€å§‹æ˜¾ç¤ºè¯†åˆ«ç»“æœ...');
        
        // æ˜ å°„åç«¯è¿”å›çš„ invoice å¯¹è±¡åˆ°å‰ç«¯ä½¿ç”¨çš„å­—æ®µ
        if (data.invoice) {
          data.invoiceNumber = data.invoice.number || data.invoiceNumber;
          data.invoiceDate = data.invoice.date || data.invoiceDate;
          data.currency = data.invoice.currency || data.currency;
        }
        
        // æ˜ å°„ totals å¯¹è±¡
        if (data.totals) {
          data.totalAmount = data.totals.total || data.totalAmount;
        }
        
        debugLog('å¼€å§‹åŠ è½½ä¾›åº”å•†åˆ—è¡¨...');
        // åŠ è½½ä¾›åº”å•†åˆ—è¡¨ç”¨äºä¸‹æ‹‰æ¡†
        let suppliers = [];
        try {
          suppliers = await loadSuppliers() || [];
          debugLog(`åŠ è½½äº† ${suppliers.length} ä¸ªä¾›åº”å•†`);
        } catch (error) {
          debugLog(`åŠ è½½ä¾›åº”å•†å¤±è´¥: ${error.message}ï¼Œå°†ä½¿ç”¨ç©ºåˆ—è¡¨`);
          suppliers = [];
        }
        
        debugLog('å¼€å§‹åŠ è½½äº§å“åˆ†ç±»...');
        // åŠ è½½äº§å“åˆ†ç±»åˆ—è¡¨
        let categories = [];
        try {
          categories = await loadCategories() || [];
          debugLog(`åŠ è½½äº† ${categories.length} ä¸ªåˆ†ç±»`);
        } catch (error) {
          debugLog(`åŠ è½½åˆ†ç±»å¤±è´¥: ${error.message}ï¼Œå°†ä½¿ç”¨ç©ºåˆ—è¡¨`);
          categories = [];
        }
        
        debugLog('å¼€å§‹åŠ è½½è®¾å¤‡æˆè‰²...');
        // åŠ è½½è®¾å¤‡æˆè‰²åˆ—è¡¨
        let conditions = [];
        try {
          conditions = await loadConditions() || [];
          debugLog(`åŠ è½½äº† ${conditions.length} ä¸ªæˆè‰²`);
        } catch (error) {
          debugLog(`åŠ è½½æˆè‰²å¤±è´¥: ${error.message}ï¼Œå°†ä½¿ç”¨ç©ºåˆ—è¡¨`);
          conditions = [];
        }
        
        // ä¿å­˜åˆ°å…¨å±€å˜é‡ä¾›åç»­ä½¿ç”¨
        window.categoriesData = categories;
        window.conditionsData = conditions;
        
        const supplierOptions = suppliers.map(s => 
          `<option value="${s._id}" data-name="${s.name}" ${s.name === data.supplier?.name ? 'selected' : ''}>${s.name}</option>`
        ).join('');
        
        debugLog('å¼€å§‹æ¸²æŸ“HTML...');
        const html = `
          <div class="card" style="margin-top: 20px;">
            <h3>âœ… å‘ç¥¨è¯†åˆ«å®Œæˆ</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
              <div>
                <h4>ğŸ“„ å‘ç¥¨ä¿¡æ¯ <span style="font-size: 12px; color: #718096; font-weight: normal;">(å¯ç¼–è¾‘)</span></h4>
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                  <div style="margin-bottom: 10px;">
                    <strong>ä¾›åº”å•†:</strong><br>
                    <select id="supplierSelect" 
                            style="width: 100%; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 5px;"
                            onchange="updateInvoiceField('supplier', this.value, this.options[this.selectedIndex].getAttribute('data-name'))">
                      <option value="">é€‰æ‹©ä¾›åº”å•†...</option>
                      ${supplierOptions}
                      <option value="new">+ æ–°å»ºä¾›åº”å•† (ä½¿ç”¨è¯†åˆ«çš„åç§°)</option>
                    </select>
                  </div>
                  <div style="margin-bottom: 10px;">
                    <strong>å‘ç¥¨å·:</strong><br>
                    <input type="text" id="invoiceNumberInput" 
                           value="${data.invoiceNumber || ''}" 
                           placeholder="è¯·è¾“å…¥å‘ç¥¨å·" 
                           style="width: 100%; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 5px;"
                           onchange="updateInvoiceField('invoiceNumber', this.value)">
                  </div>
                  <div style="margin-bottom: 10px;">
                    <strong>æ—¥æœŸ:</strong><br>
                    <input type="date" id="invoiceDateInput" 
                           value="${data.invoiceDate || ''}"
                           style="width: 100%; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 4px; margin-top: 5px;"
                           onchange="updateInvoiceField('invoiceDate', this.value)">
                  </div>
                  <div><strong>æ€»é‡‘é¢:</strong> ${data.currency || 'â‚¬'} ${(data.totalAmount || 0).toFixed(2)}</div>
                </div>
              </div>
              <div>
                <h4>ğŸ“Š è¯†åˆ«ç»Ÿè®¡</h4>
                <div style="background: #f0fff4; padding: 15px; border-radius: 8px;">
                  <div><strong>äº§å“æ•°é‡:</strong> ${(data.products || []).length} é¡¹</div>
                  <div><strong>è¯†åˆ«å‡†ç¡®åº¦:</strong> ${data.confidence || 85}%</div>
                  <div><strong>éœ€è¦ç¡®è®¤:</strong> ${data.needsReview ? 'æ˜¯' : 'å¦'}</div>
                  ${data.supplier?.name ? `<div style="margin-top: 10px; padding: 8px; background: #fff5e6; border-radius: 4px; font-size: 12px;"><strong>è¯†åˆ«çš„ä¾›åº”å•†:</strong> ${data.supplier.name}</div>` : ''}
                </div>
              </div>
            </div>
            
            <h4>ğŸ“¦ è¯†åˆ«çš„äº§å“åˆ—è¡¨</h4>
            <div style="overflow-x: auto;">
              <table>
                <thead>
                  <tr>
                    <th>äº§å“åç§°</th>
                    <th>å‹å·/è§„æ ¼</th>
                    <th>é¢œè‰²/ç±»å‹</th>
                    <th>æ•°é‡</th>
                    <th>è¿›è´§ä»·</th>
                    <th>æ‰¹å‘ä»·</th>
                    <th>é›¶å”®ä»·</th>
                    <th>åˆ†ç±»</th>
                    <th>ç¨åŠ¡åˆ†ç±»</th>
                    <th>æ¡ç /åºåˆ—å·</th>
                    <th>æˆè‰²</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  ${(data.products || []).map((product, index) => `
                    <tr>
                      <td>
                        <input type="text" value="${product.name || ''}" 
                               style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'name', this.value)">
                      </td>
                      <td>
                        <input type="text" value="${product.model || ''}" placeholder="å‹å·/è§„æ ¼"
                               style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'model', this.value)">
                      </td>
                      <td>
                        <input type="text" value="${product.color || ''}" placeholder="é¢œè‰²/ç±»å‹"
                               style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'color', this.value)">
                      </td>
                      <td>
                        <input type="number" value="${product.quantity || 1}" min="1"
                               style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'quantity', this.value)">
                      </td>
                      <td>
                        <input type="number" value="${parseFloat(product.unitPrice || product.purchasePrice || product.costPrice || 0).toFixed(2)}" step="0.01" min="0"
                               style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'purchasePrice', this.value)"
                               required>
                      </td>
                      <td>
                        <input type="number" value="${product.wholesalePrice || ''}" step="0.01" min="0" placeholder="è¯·æ‰‹åŠ¨è¾“å…¥æ‰¹å‘ä»·"
                               style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'wholesalePrice', this.value)">
                      </td>
                      <td>
                        <input type="number" value="${product.retailPrice || ''}" step="0.01" min="0" placeholder="è¯·æ‰‹åŠ¨è¾“å…¥é›¶å”®ä»·"
                               style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                               onchange="updateProductField(${index}, 'retailPrice', this.value)">
                      </td>
                      <td>
                        <select onchange="updateProductField(${index}, 'productType', this.value); updateVatRate(${index})"
                                style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                          ${generateCategoryOptions(window.categoriesData, product.productType)}
                        </select>
                      </td>
                      <td>
                        <select onchange="updateProductField(${index}, 'vatRate', this.value)"
                                style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                          <option value="VAT 23%" ${(product.vatRate || getDefaultVatRate(product.productType)) === 'VAT 23%' ? 'selected' : ''}>VAT 23%</option>
                          <option value="VAT 13.5%" ${(product.vatRate || getDefaultVatRate(product.productType)) === 'VAT 13.5%' ? 'selected' : ''}>VAT 13.5%</option>
                          <option value="VAT 0%" ${(product.vatRate || getDefaultVatRate(product.productType)) === 'VAT 0%' ? 'selected' : ''}>VAT 0%</option>
                        </select>
                      </td>
                      <td>
                        ${generateIdentifierInputs(product, index)}
                      </td>
                      <td>
                        <select onchange="updateProductField(${index}, 'condition', this.value)"
                                style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                          ${generateConditionOptions(window.conditionsData, product.condition)}
                        </select>
                      </td>
                      <td>
                        <button onclick="removeProduct(${index})" 
                                style="padding: 4px 8px; background: #fed7d7; color: #c53030; border: none; border-radius: 4px; cursor: pointer;">
                          âŒ
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
              <button onclick="cancelReceiving()" class="btn" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0;">
                âŒ å–æ¶ˆ
              </button>
              <button onclick="confirmReceiving(event)" class="btn btn-success" id="confirmReceivingBtn">
                âœ… ç¡®è®¤å…¥åº“
              </button>
            </div>
          </div>
        `;
        
        resultContainer.innerHTML = html;
        debugLog('HTMLæ¸²æŸ“å®Œæˆ');
        
        // ä¿å­˜è¯†åˆ«æ•°æ®åˆ°å…¨å±€å˜é‡
        window.recognizedData = data;
        debugLog('è¯†åˆ«æ•°æ®å·²ä¿å­˜åˆ°å…¨å±€å˜é‡');
        
      } catch (error) {
        console.error('æ˜¾ç¤ºè¯†åˆ«ç»“æœå¤±è´¥:', error);
        debugLog(`âŒ æ˜¾ç¤ºè¯†åˆ«ç»“æœå¤±è´¥: ${error.message}`);
        resultContainer.innerHTML = `
          <div class="card" style="margin-top: 20px;">
            <div class="error">âŒ æ˜¾ç¤ºç»“æœå¤±è´¥: ${error.message}</div>
            <pre style="background: #f7fafc; padding: 10px; border-radius: 4px; font-size: 12px; overflow: auto; max-height: 300px;">${error.stack}</pre>
            <button onclick="document.getElementById('fileInput').click()" class="btn" style="margin-top: 15px;">
              é‡æ–°ä¸Šä¼ 
            </button>
          </div>
        `;
      }
    }

    // æ›´æ–°äº§å“å­—æ®µ
    function updateProductField(index, field, value) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      const product = window.recognizedData.products[index];
      
      if (field === 'quantity') {
        product.quantity = parseInt(value) || 1;
        // å¦‚æœæ˜¯è®¾å¤‡äº§å“ï¼Œæ•°é‡å˜åŒ–æ—¶éœ€è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼ - æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å« "Device" å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        if (product.productType?.toLowerCase().includes('device')) {
          displayRecognitionResult(window.recognizedData);
          return;
        }
      } else if (field === 'productType') {
        product.productType = value;
        // äº§å“ç±»å‹å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ç¨ç‡
        product.vatRate = getDefaultVatRate(value);
        // é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼
        displayRecognitionResult(window.recognizedData);
        return;
      } else if (field === 'purchasePrice') {
        product.purchasePrice = parseFloat(value) || 0;
        // ä¸å†è‡ªåŠ¨è®¡ç®—æ‰¹å‘ä»·å’Œé›¶å”®ä»·ï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥
      } else if (field === 'wholesalePrice') {
        product.wholesalePrice = parseFloat(value) || 0;
        // ä¸å†è‡ªåŠ¨è®¡ç®—é›¶å”®ä»·ï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥
      } else if (field === 'retailPrice') {
        product.retailPrice = parseFloat(value) || 0;
      } else if (field === 'barcode') {
        product.barcode = value;
      } else {
        product[field] = value;
      }
      
      debugLog(`æ›´æ–°äº§å“ ${index} çš„ ${field}: ${value}`);
    }

    // æ›´æ–°å‘ç¥¨å­—æ®µ
    function updateInvoiceField(field, value, supplierName = null) {
      if (!window.recognizedData) return;
      
      if (field === 'supplier') {
        if (value === 'new') {
          // ä½¿ç”¨è¯†åˆ«çš„ä¾›åº”å•†åç§°åˆ›å»ºæ–°ä¾›åº”å•†
          if (!window.recognizedData.supplier) {
            window.recognizedData.supplier = {};
          }
          // ä¿æŒåŸæœ‰è¯†åˆ«çš„ä¾›åº”å•†ä¿¡æ¯
          debugLog(`å°†ä½¿ç”¨è¯†åˆ«çš„ä¾›åº”å•†ä¿¡æ¯åˆ›å»ºæ–°ä¾›åº”å•†: ${window.recognizedData.supplier.name}`);
        } else if (value) {
          // é€‰æ‹©äº†ç°æœ‰ä¾›åº”å•†
          if (!window.recognizedData.supplier) {
            window.recognizedData.supplier = {};
          }
          window.recognizedData.supplier._id = value;
          window.recognizedData.supplier.name = supplierName;
          debugLog(`é€‰æ‹©ä¾›åº”å•†: ${supplierName} (ID: ${value})`);
        }
      } else if (field === 'supplierName') {
        if (!window.recognizedData.supplier) {
          window.recognizedData.supplier = {};
        }
        window.recognizedData.supplier.name = value;
        debugLog(`æ›´æ–°ä¾›åº”å•†åç§°: ${value}`);
      } else if (field === 'invoiceNumber') {
        window.recognizedData.invoiceNumber = value;
        debugLog(`æ›´æ–°å‘ç¥¨å·: ${value}`);
      } else if (field === 'invoiceDate') {
        window.recognizedData.invoiceDate = value;
        debugLog(`æ›´æ–°å‘ç¥¨æ—¥æœŸ: ${value}`);
      }
    }

    // ç§»é™¤äº§å“
    function removeProduct(index) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      window.recognizedData.products.splice(index, 1);
      displayRecognitionResult(window.recognizedData);
      debugLog(`ç§»é™¤äº§å“ ${index}`);
    }

    // å–æ¶ˆå…¥åº“
    function cancelReceiving() {
      document.getElementById('recognitionResult').style.display = 'none';
      document.getElementById('fileInput').value = '';
      window.recognizedData = null;
      debugLog('å–æ¶ˆå…¥åº“æ“ä½œ');
    }

    // ç¡®è®¤å…¥åº“
    async function confirmReceiving(event) {
      // é˜²æ­¢é‡å¤æäº¤
      if (window.isSubmitting) {
        console.log('âš ï¸  æ­£åœ¨æäº¤ä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');
        return;
      }
      
      if (!window.recognizedData) {
        alert('æ²¡æœ‰å¯å…¥åº“çš„æ•°æ®');
        return;
      }
      
      // è®¾ç½®æäº¤æ ‡å¿—
      window.isSubmitting = true;
      
      // ç¦ç”¨ç¡®è®¤æŒ‰é’®
      const confirmButton = document.getElementById('confirmReceivingBtn');
      if (confirmButton) {
        confirmButton.disabled = true;
        confirmButton.style.opacity = '0.6';
        confirmButton.style.cursor = 'not-allowed';
        confirmButton.innerHTML = 'â³ æäº¤ä¸­...';
      }
      
      // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·å®Œæ•´æ€§
      const products = window.recognizedData.products || [];
      const validationErrors = [];
      
      products.forEach((product, index) => {
        // ğŸ”„ æ ‡å‡†åŒ–äº§å“åç§°å’Œå‹å·ï¼šè½¬å¤§å†™å¹¶å»é™¤ç©ºæ ¼
        if (product.name) {
          product.name = product.name.trim().toUpperCase().replace(/\s+/g, '');
        }
        if (product.model) {
          product.model = product.model.trim().toUpperCase().replace(/\s+/g, '');
        }
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!product.name || !product.name.trim()) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·è¾“å…¥äº§å“åç§°`);
        }
        
        // éªŒè¯è¿›è´§ä»· - æ¥å—æ•°å­—å’Œå°æ•°ç‚¹
        const purchasePriceNum = parseFloat(product.purchasePrice);
        if (!product.purchasePrice || isNaN(purchasePriceNum) || purchasePriceNum <= 0) {
          validationErrors.push(`äº§å“ "${product.name || index + 1}": è¯·è¾“å…¥æœ‰æ•ˆçš„è¿›è´§ä»·`);
        }
        
        // éªŒè¯æ‰¹å‘ä»·
        const wholesalePriceNum = parseFloat(product.wholesalePrice);
        if (!product.wholesalePrice || isNaN(wholesalePriceNum) || wholesalePriceNum <= 0) {
          validationErrors.push(`äº§å“ "${product.name || index + 1}": è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰¹å‘ä»·`);
        }
        
        // éªŒè¯é›¶å”®ä»·
        const retailPriceNum = parseFloat(product.retailPrice);
        if (!product.retailPrice || isNaN(retailPriceNum) || retailPriceNum <= 0) {
          validationErrors.push(`äº§å“ "${product.name || index + 1}": è¯·è¾“å…¥æœ‰æ•ˆçš„é›¶å”®ä»·`);
        }
        
        // éªŒè¯ä»·æ ¼é€»è¾‘ï¼ˆåªæœ‰å½“æ‰€æœ‰ä»·æ ¼éƒ½æœ‰æ•ˆæ—¶æ‰éªŒè¯ï¼‰
        if (!isNaN(purchasePriceNum) && !isNaN(wholesalePriceNum) && !isNaN(retailPriceNum)) {
          if (wholesalePriceNum <= purchasePriceNum) {
            validationErrors.push(`äº§å“ "${product.name || index + 1}": æ‰¹å‘ä»·(${wholesalePriceNum})å¿…é¡»é«˜äºè¿›è´§ä»·(${purchasePriceNum})`);
          }
          
          if (retailPriceNum <= wholesalePriceNum) {
            validationErrors.push(`äº§å“ "${product.name || index + 1}": é›¶å”®ä»·(${retailPriceNum})å¿…é¡»é«˜äºæ‰¹å‘ä»·(${wholesalePriceNum})`);
          }
        }
        
        // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·
        const isDevice = product.productType?.toLowerCase().includes('device');
        if (isDevice) {
          const quantity = parseInt(product.quantity) || 1;
          const serialNumbers = product.serialNumbers || [];
          const filledSerialNumbers = serialNumbers.filter(sn => {
            if (typeof sn === 'object') {
              return sn.serialNumber && sn.serialNumber.trim();
            }
            return sn && sn.trim();
          });
          
          if (filledSerialNumbers.length < quantity) {
            validationErrors.push(`äº§å“ "${product.name}" éœ€è¦å¡«å†™ ${quantity} ä¸ªåºåˆ—å·ï¼Œä½†åªå¡«å†™äº† ${filledSerialNumbers.length} ä¸ª`);
          }
          
          // æ£€æŸ¥åºåˆ—å·æ˜¯å¦é‡å¤
          const serialNumberStrings = filledSerialNumbers.map(sn => 
            typeof sn === 'object' ? sn.serialNumber : sn
          );
          const uniqueSerialNumbers = [...new Set(serialNumberStrings)];
          if (uniqueSerialNumbers.length !== serialNumberStrings.length) {
            validationErrors.push(`äº§å“ "${product.name}" å­˜åœ¨é‡å¤çš„åºåˆ—å·`);
          }
        }
      });
      
      if (validationErrors.length > 0) {
        alert('âŒ å…¥åº“éªŒè¯å¤±è´¥ï¼š\n\n' + validationErrors.join('\n'));
        // é‡ç½®æäº¤æ ‡å¿—
        window.isSubmitting = false;
        return;
      }
      
      debugLog('å¼€å§‹ç¡®è®¤å…¥åº“æ“ä½œ');
      
      try {
        // è®¡ç®—å‘ç¥¨æ€»é¢å’Œç¨é¢
        const calculateInvoiceTotals = (products) => {
          let subtotal = 0;
          let totalTax = 0;
          
          products.forEach(p => {
            const itemSubtotal = (parseFloat(p.purchasePrice) || 0) * (parseInt(p.quantity) || 1);
            subtotal += itemSubtotal;
            
            // æ ¹æ®VATç¨ç‡è®¡ç®—ç¨é¢
            let itemTax = 0;
            if (p.vatRate === 'VAT 23%') {
              itemTax = itemSubtotal * 0.23;
            } else if (p.vatRate === 'VAT 13.5%') {
              itemTax = itemSubtotal * 0.135;
            } else if (p.vatRate === 'VAT 0%') {
              itemTax = 0;
            }
            totalTax += itemTax;
          });
          
          return {
            subtotal: subtotal,
            tax: totalTax,
            total: subtotal + totalTax
          };
        };
        
        const invoiceTotals = calculateInvoiceTotals(products);
        
        // è½¬æ¢æ•°æ®æ ¼å¼ä¸ºåç«¯æœŸæœ›çš„æ ¼å¼
        const requestData = {
          supplier: {
            name: window.recognizedData.supplier?.name || 'æœªçŸ¥ä¾›åº”å•†',
            email: window.recognizedData.supplier?.email || '',
            phone: window.recognizedData.supplier?.phone || '',
            address: window.recognizedData.supplier?.address || '',
            contactPerson: window.recognizedData.supplier?.contactPerson || '',
            confidence: window.recognizedData.supplier?.confidence || 85
          },
          products: products.map(product => {
            const baseProduct = {
              name: product.name || '',
              brand: product.brand || '',
              model: product.model || '',
              color: product.color || '',
              quantity: parseInt(product.quantity) || 1,
              unitPrice: parseFloat(product.purchasePrice) || 0,
              totalPrice: (parseInt(product.quantity) || 1) * (parseFloat(product.purchasePrice) || 0),
              wholesalePrice: parseFloat(product.wholesalePrice) || 0,
              retailPrice: parseFloat(product.retailPrice) || (parseFloat(product.wholesalePrice) || 0) * 1.3,
              category: product.productType || 'æ‰‹æœºé…ä»¶',
              vatRate: product.vatRate || getDefaultVatRate(product.productType),
              condition: product.condition || 'Brand New'
            };
            
            // å¤„ç†æ¡ç å’Œåºåˆ—å· - æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å« "Device" å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            const isDevice = product.productType?.toLowerCase().includes('device');
            
            if (isDevice) {
              // è®¾å¤‡äº§å“ï¼šå¤„ç†åºåˆ—å·æ•°ç»„
              if (product.serialNumbers && product.serialNumbers.length > 0) {
                // ä¸ºæ¯ä¸ªåºåˆ—å·åˆ›å»ºä¸€ä¸ªäº§å“è®°å½•
                return product.serialNumbers.filter(sn => {
                  if (typeof sn === 'object') {
                    return sn.serialNumber && sn.serialNumber.trim();
                  }
                  return sn && sn.trim();
                }).map(snData => {
                  const serialNumber = typeof snData === 'object' ? snData.serialNumber : snData;
                  const color = typeof snData === 'object' ? snData.color : product.color;
                  
                  return {
                    ...baseProduct,
                    quantity: 1, // æ¯ä¸ªåºåˆ—å·å¯¹åº”ä¸€ä¸ªäº§å“
                    serialNumber: serialNumber,
                    color: color || baseProduct.color,
                    totalPrice: baseProduct.unitPrice
                  };
                });
              } else {
                return [baseProduct];
              }
            } else {
              // é…ä»¶äº§å“ï¼šå¤„ç†æ¡ç 
              return [{
                ...baseProduct,
                barcode: product.barcode || ''
              }];
            }
          }).flat(), // å±•å¹³æ•°ç»„ï¼Œå› ä¸ºè®¾å¤‡äº§å“å¯èƒ½äº§ç”Ÿå¤šä¸ªè®°å½•
          invoiceInfo: {
            number: window.recognizedData.invoiceNumber || `INV-${Date.now()}`,
            date: window.recognizedData.invoiceDate || new Date().toISOString().split('T')[0],
            dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            currency: 'EUR',
            subtotal: invoiceTotals.subtotal,
            tax: invoiceTotals.tax,
            total: invoiceTotals.total
          }
        };
        
        debugLog('å‘é€å…¥åº“æ•°æ®:', JSON.stringify(requestData, null, 2));
        
        const response = await fetch(`${API_BASE}/receiving/confirm`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        debugLog(`å…¥åº“ç¡®è®¤APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success) {
          alert(`âœ… å…¥åº“æˆåŠŸï¼\n\nåˆ›å»ºäº§å“: ${result.data.productsCreated} ä¸ª\næ›´æ–°äº§å“: ${result.data.productsUpdated} ä¸ª`);
          cancelReceiving();
          loadAllData(); // åˆ·æ–°æ•°æ®
        } else {
          throw new Error(result.error || result.message || 'å…¥åº“å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ å…¥åº“å¤±è´¥: ${error.message}`);
        alert(`âŒ å…¥åº“å¤±è´¥: ${error.message}`);
      } finally {
        // é‡ç½®æäº¤æ ‡å¿—
        window.isSubmitting = false;
      }
    }

    // æµ‹è¯•å›¾ç‰‡è¯†åˆ« - å·²ç§»é™¤
    /*
    function testImageRecognition() {
      window.open('/test-image-recognition.html', '_blank');
    }
    */

    // ==================== ä¾›è´§å•†/å®¢æˆ·ç®¡ç†åŠŸèƒ½ ====================
    
    // åˆ‡æ¢ä¾›è´§å•†/å®¢æˆ·ç®¡ç†å­æ ‡ç­¾é¡µ
    function switchPartnerTab(tabName) {
      debugLog(`åˆ‡æ¢åˆ°å­æ ‡ç­¾é¡µ: ${tabName}`);
      
      // éšè—æ‰€æœ‰å­æ ‡ç­¾å†…å®¹
      document.getElementById('suppliersTab').style.display = 'none';
      document.getElementById('customersTab').style.display = 'none';
      document.getElementById('trackingTab').style.display = 'none';
      
      // é‡ç½®æ‰€æœ‰æŒ‰é’®æ ·å¼
      document.getElementById('supplierTabBtn').className = 'btn';
      document.getElementById('supplierTabBtn').style.background = '#f7fafc';
      document.getElementById('supplierTabBtn').style.color = '#4a5568';
      
      document.getElementById('customerTabBtn').className = 'btn';
      document.getElementById('customerTabBtn').style.background = '#f7fafc';
      document.getElementById('customerTabBtn').style.color = '#4a5568';
      
      document.getElementById('trackingTabBtn').className = 'btn';
      document.getElementById('trackingTabBtn').style.background = '#f7fafc';
      document.getElementById('trackingTabBtn').style.color = '#4a5568';
      
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå¹¶é«˜äº®æŒ‰é’®
      if (tabName === 'suppliers') {
        document.getElementById('suppliersTab').style.display = 'block';
        document.getElementById('supplierTabBtn').className = 'btn btn-primary';
        document.getElementById('supplierTabBtn').style.background = '';
        document.getElementById('supplierTabBtn').style.color = '';
        loadSuppliersForPartners();
      } else if (tabName === 'customers') {
        document.getElementById('customersTab').style.display = 'block';
        document.getElementById('customerTabBtn').className = 'btn btn-primary';
        document.getElementById('customerTabBtn').style.background = '';
        document.getElementById('customerTabBtn').style.color = '';
        loadCustomers();
      } else if (tabName === 'tracking') {
        document.getElementById('trackingTab').style.display = 'block';
        document.getElementById('trackingTabBtn').className = 'btn btn-primary';
        document.getElementById('trackingTabBtn').style.background = '';
        document.getElementById('trackingTabBtn').style.color = '';
      }
    }
    
    // åŠ è½½ä¾›è´§å•†åˆ—è¡¨ï¼ˆç”¨äºä¾›è´§å•†ç®¡ç†æ ‡ç­¾é¡µï¼‰
    async function loadSuppliersForPartners(searchTerm = '') {
      debugLog('å¼€å§‹åŠ è½½ä¾›è´§å•†åˆ—è¡¨');
      const container = document.getElementById('suppliersContainer');
      container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ä¾›è´§å•†æ•°æ®...</div>';
      
      try {
        const url = searchTerm ? 
          `${API_BASE}/suppliers?search=${encodeURIComponent(searchTerm)}` : 
          `${API_BASE}/suppliers`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`ä¾›è´§å•†APIå“åº”: ${result.data?.length || 0} ä¸ªä¾›è´§å•†`);
        
        if (result.success && result.data && result.data.length > 0) {
          renderSuppliers(result.data);
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><h3>æš‚æ— ä¾›è´§å•†</h3><p>ç‚¹å‡»"æ·»åŠ ä¾›è´§å•†"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªä¾›è´§å•†</p></div>';
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½ä¾›è´§å•†å¤±è´¥: ${error.message}`);
        container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ¸²æŸ“ä¾›è´§å•†åˆ—è¡¨
    function renderSuppliers(suppliers) {
      const container = document.getElementById('suppliersContainer');
      
      const html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>ä¾›è´§å•†ä»£ç </th>
              <th>ä¾›è´§å•†åç§°</th>
              <th>è”ç³»äºº</th>
              <th>ç”µè¯</th>
              <th>é‚®ç®±</th>
              <th>ä»˜æ¬¾æ¡ä»¶</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${suppliers.map(supplier => `
              <tr>
                <td><strong>${supplier.code}</strong></td>
                <td>${supplier.name}</td>
                <td>${supplier.contact?.person || '-'}</td>
                <td>${supplier.contact?.phone || '-'}</td>
                <td>${supplier.contact?.email || '-'}</td>
                <td>${getPaymentTermsLabel(supplier.financial?.paymentTerms)}</td>
                <td>
                  <button onclick="viewSupplierInvoices('${supplier._id}', '${supplier.name}')" class="btn btn-sm btn-info" style="margin-right: 5px;">ğŸ“‹ æŸ¥çœ‹å‘ç¥¨</button>
                  <button onclick="editSupplier('${supplier._id}')" class="btn btn-sm btn-primary" style="margin-right: 5px;">âœï¸ ç¼–è¾‘</button>
                  <button onclick="deleteSupplier('${supplier._id}', '${supplier.name}')" class="btn btn-sm btn-danger">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }
    
    // è·å–ä»˜æ¬¾æ¡ä»¶æ ‡ç­¾
    function getPaymentTermsLabel(terms) {
      const labels = {
        'cash': 'ç°é‡‘',
        'net7': '7å¤©è´¦æœŸ',
        'net15': '15å¤©è´¦æœŸ',
        'net30': '30å¤©è´¦æœŸ',
        'net60': '60å¤©è´¦æœŸ',
        'net90': '90å¤©è´¦æœŸ'
      };
      return labels[terms] || terms || '-';
    }
    
    // æœç´¢ä¾›è´§å•†
    function searchSuppliers() {
      const searchTerm = document.getElementById('supplierSearchInput').value.trim();
      loadSuppliersForPartners(searchTerm);
    }
    
    // æ˜¾ç¤ºæ·»åŠ ä¾›è´§å•†æ¨¡æ€æ¡†
    async function showAddSupplierModal() {
      const name = prompt('è¯·è¾“å…¥ä¾›è´§å•†åç§°:');
      if (!name || !name.trim()) return;
      
      const code = prompt('è¯·è¾“å…¥ä¾›è´§å•†ä»£ç  (å¤§å†™å­—æ¯):');
      if (!code || !code.trim()) return;
      
      const contactPerson = prompt('è¯·è¾“å…¥è”ç³»äººå§“å (å¯é€‰):') || '';
      const phone = prompt('è¯·è¾“å…¥è”ç³»ç”µè¯ (å¯é€‰):') || '';
      const email = prompt('è¯·è¾“å…¥é‚®ç®± (å¯é€‰):') || '';
      
      try {
        const response = await fetch(`${API_BASE}/suppliers`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            name: name.trim(),
            code: code.trim().toUpperCase(),
            contact: {
              person: contactPerson.trim(),
              phone: phone.trim(),
              email: email.trim()
            }
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ä¾›è´§å•†æ·»åŠ æˆåŠŸï¼');
          loadSuppliers(); // åˆ·æ–°åˆ—è¡¨
        } else {
          throw new Error(result.error || 'æ·»åŠ å¤±è´¥');
        }
      } catch (error) {
        console.error('æ·»åŠ ä¾›è´§å•†å¤±è´¥:', error);
        alert(`âŒ æ·»åŠ ä¾›è´§å•†å¤±è´¥: ${error.message}`);
      }
    }
    
    // ç¼–è¾‘ä¾›è´§å•†
    async function editSupplier(supplierId) {
      debugLog(`ç¼–è¾‘ä¾›è´§å•†: ${supplierId}`);
      
      try {
        // è·å–ä¾›è´§å•†è¯¦æƒ…
        const response = await fetch(`${API_BASE}/suppliers/${supplierId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (!result.success || !result.data) {
          throw new Error('è·å–ä¾›è´§å•†ä¿¡æ¯å¤±è´¥');
        }
        
        const supplier = result.data;
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        const title = `âœï¸ Edit Supplier - ${supplier.name}`;
        const content = `
          <form id="editSupplierForm" style="max-width: 600px;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Supplier Code *</label>
              <input type="text" id="editSupplierCode" value="${supplier.code}" required
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Supplier Name *</label>
              <input type="text" id="editSupplierName" value="${supplier.name}" required
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Contact Person</label>
              <input type="text" id="editSupplierContactPerson" value="${supplier.contact?.person || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phone</label>
              <input type="tel" id="editSupplierPhone" value="${supplier.contact?.phone || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
              <input type="email" id="editSupplierEmail" value="${supplier.contact?.email || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Address</label>
              <textarea id="editSupplierAddress" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">${supplier.contact?.address?.street || ''}</textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Payment Terms</label>
              <select id="editSupplierPaymentTerms"
                      style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                <option value="cash" ${supplier.financial?.paymentTerms === 'cash' ? 'selected' : ''}>Cash</option>
                <option value="net7" ${supplier.financial?.paymentTerms === 'net7' ? 'selected' : ''}>Net 7 Days</option>
                <option value="net15" ${supplier.financial?.paymentTerms === 'net15' ? 'selected' : ''}>Net 15 Days</option>
                <option value="net30" ${supplier.financial?.paymentTerms === 'net30' ? 'selected' : ''}>Net 30 Days</option>
                <option value="net60" ${supplier.financial?.paymentTerms === 'net60' ? 'selected' : ''}>Net 60 Days</option>
                <option value="net90" ${supplier.financial?.paymentTerms === 'net90' ? 'selected' : ''}>Net 90 Days</option>
              </select>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tax Number (VAT Number)</label>
              <input type="text" id="editSupplierTaxNumber" value="${supplier.financial?.taxNumber || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;"
                     placeholder="IE1234567X">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
              <textarea id="editSupplierNotes" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">${supplier.notes || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
              <button type="submit" class="btn btn-primary">ğŸ’¾ Save Changes</button>
            </div>
          </form>
        `;
        
        showUniversalModal(title, content);
        
        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('editSupplierForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveSupplierEdit(supplierId);
        });
        
      } catch (error) {
        debugLog(`âŒ è·å–ä¾›è´§å•†ä¿¡æ¯å¤±è´¥: ${error.message}`);
        alert(`âŒ Failed to load supplier: ${error.message}`);
      }
    }
    
    // ä¿å­˜ä¾›è´§å•†ç¼–è¾‘
    async function saveSupplierEdit(supplierId) {
      const updateData = {
        code: document.getElementById('editSupplierCode').value.trim(),
        name: document.getElementById('editSupplierName').value.trim(),
        contact: {
          person: document.getElementById('editSupplierContactPerson').value.trim(),
          phone: document.getElementById('editSupplierPhone').value.trim(),
          email: document.getElementById('editSupplierEmail').value.trim(),
          address: {
            street: document.getElementById('editSupplierAddress').value.trim()
          }
        },
        financial: {
          paymentTerms: document.getElementById('editSupplierPaymentTerms').value,
          taxNumber: document.getElementById('editSupplierTaxNumber').value.trim()
        },
        notes: document.getElementById('editSupplierNotes').value.trim()
      };
      
      if (!updateData.code || !updateData.name) {
        alert('Supplier code and name are required');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/suppliers/${supplierId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (result.success) {
          alert('âœ… Supplier updated successfully');
          closeModal();
          loadSuppliers();
        } else {
          throw new Error(result.error || 'Update failed');
        }
      } catch (error) {
        debugLog(`âŒ æ›´æ–°ä¾›è´§å•†å¤±è´¥: ${error.message}`);
        alert(`âŒ Update failed: ${error.message}`);
      }
    }
    
    // åˆ é™¤ä¾›è´§å•†
    async function deleteSupplier(supplierId, supplierName) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¾›è´§å•†"${supplierName}"å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/suppliers/${supplierId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (result.success) {
          alert('âœ… ä¾›è´§å•†åˆ é™¤æˆåŠŸ');
          loadSuppliers();
        } else {
          throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ åˆ é™¤ä¾›è´§å•†å¤±è´¥: ${error.message}`);
        alert(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
      }
    }
    
    // æŸ¥çœ‹ä¾›è´§å•†å‘ç¥¨
    async function viewSupplierInvoices(supplierId, supplierName) {
      debugLog(`æŸ¥çœ‹ä¾›è´§å•†å‘ç¥¨: ${supplierId}`);
      
      try {
        const response = await fetch(`${API_BASE}/suppliers/${supplierId}/invoices`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          showSupplierInvoicesModal(supplierName, result.data);
        } else {
          throw new Error(result.error || 'è·å–å‘ç¥¨å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ è·å–ä¾›è´§å•†å‘ç¥¨å¤±è´¥: ${error.message}`);
        alert(`âŒ è·å–å‘ç¥¨å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºä¾›è´§å•†å‘ç¥¨æ¨¡æ€æ¡†
    function showSupplierInvoicesModal(supplierName, invoices) {
      const title = `ğŸ“‹ ${supplierName} - é‡‡è´­å‘ç¥¨è®°å½•`;
      
      let content;
      if (invoices.length === 0) {
        content = '<div class="empty-state"><p>æš‚æ— é‡‡è´­å‘ç¥¨è®°å½•</p></div>';
      } else {
        content = `
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>å‘ç¥¨ç¼–å·</th>
                  <th>å‘ç¥¨æ—¥æœŸ</th>
                  <th>å°è®¡ï¼ˆä¸å«ç¨ï¼‰</th>
                  <th>ç¨é¢</th>
                  <th>æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰</th>
                  <th>ä»˜æ¬¾çŠ¶æ€</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${invoices.map(invoice => `
                  <tr>
                    <td>
                      <a href="javascript:void(0)" 
                         onclick="viewInvoiceDetails('${invoice._id}')" 
                         style="color: #3b82f6; text-decoration: none; font-weight: bold;">
                        ${invoice.invoiceNumber}
                      </a>
                    </td>
                    <td>${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</td>
                    <td>â‚¬${invoice.subtotal.toFixed(2)}</td>
                    <td>â‚¬${invoice.taxAmount.toFixed(2)}</td>
                    <td><strong>â‚¬${invoice.totalAmount.toFixed(2)}</strong></td>
                    <td>${getPaymentStatusLabel(invoice.paymentStatus)}</td>
                    <td>${getInvoiceStatusLabel(invoice.status)}</td>
                    <td>
                      <button onclick="viewInvoiceDetails('${invoice._id}')" class="btn btn-sm btn-info">
                        ğŸ“„ æŸ¥çœ‹è¯¦æƒ…
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      showUniversalModal(title, content);
    }
    
    // æŸ¥çœ‹å‘ç¥¨è¯¦æƒ…
    async function viewInvoiceDetails(invoiceId) {
      debugLog(`æŸ¥çœ‹å‘ç¥¨è¯¦æƒ…: ${invoiceId}`);
      
      try {
        const response = await fetch(`${API_BASE}/purchase-orders/${invoiceId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          showInvoiceDetailsModal(result.data);
        } else {
          throw new Error(result.error || 'è·å–å‘ç¥¨è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ è·å–å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${error.message}`);
        alert(`âŒ è·å–å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºå‘ç¥¨è¯¦æƒ…æ¨¡æ€æ¡†
    function showInvoiceDetailsModal(invoice) {
      const title = `ğŸ“„ å‘ç¥¨è¯¦æƒ… - ${invoice.invoiceNumber}`;
      
      // è®¡ç®—å„ç¨ç‡çš„å°è®¡
      const taxBreakdown = {};
      invoice.items.forEach(item => {
        const vatRate = item.vatRate || 'VAT 23%';
        if (!taxBreakdown[vatRate]) {
          taxBreakdown[vatRate] = {
            subtotal: 0,
            taxAmount: 0,
            total: 0
          };
        }
        taxBreakdown[vatRate].subtotal += item.totalCostExcludingTax || 0;
        taxBreakdown[vatRate].taxAmount += item.taxAmount || 0;
        taxBreakdown[vatRate].total += item.totalCost || 0;
      });
      
      // è®¡ç®—å¾…ä»˜é‡‘é¢
      const remainingAmount = invoice.totalAmount - (invoice.paidAmount || 0);
      
      const content = `
        <div style="max-width: 1200px;">
          <!-- å‘ç¥¨åŸºæœ¬ä¿¡æ¯ -->
          <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div>
                <div style="font-size: 12px; color: #6b7280;">ä¾›è´§å•†</div>
                <div style="font-weight: bold;">${invoice.supplier.name}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280;">å‘ç¥¨æ—¥æœŸ</div>
                <div>${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280;">åˆ°æœŸæ—¥æœŸ</div>
                <div>${invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString('zh-CN') : '-'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280;">çŠ¶æ€</div>
                <div>${getInvoiceStatusLabel(invoice.status)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280;">ä»˜æ¬¾çŠ¶æ€</div>
                <div>${getPaymentStatusLabel(invoice.paymentStatus)}</div>
              </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
              ${remainingAmount > 0 ? `
                <button onclick="showAddPaymentModal('${invoice._id}', ${invoice.totalAmount}, ${invoice.paidAmount || 0})" class="btn-primary" style="padding: 8px 16px;">
                  ğŸ’° æ·»åŠ ä»˜æ¬¾
                </button>
              ` : ''}
              <button onclick="downloadPurchaseInvoicePDF('${invoice._id}')" class="btn-primary" style="padding: 8px 16px;">
                ğŸ“¥ ä¸‹è½½PDF
              </button>
            </div>
          </div>
          
          <!-- æ•°æ®æ¥æºç»Ÿè®¡ -->
          ${invoice.adminInventoryCount > 0 || invoice.purchaseInvoiceCount > 0 ? `
            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
              ğŸ“Š æ•°æ®æ¥æº: 
              ${invoice.purchaseInvoiceCount > 0 ? `<span style="margin-left: 10px;">ğŸ“‹ é‡‡è´­è®¢å•: ${invoice.purchaseInvoiceCount}é¡¹</span>` : ''}
              ${invoice.adminInventoryCount > 0 ? `<span style="margin-left: 10px;">ğŸ“¦ åº“å­˜ç³»ç»Ÿ: ${invoice.adminInventoryCount}é¡¹</span>` : ''}
            </div>
          ` : ''}
          
          <!-- äº§å“æ˜ç»† -->
          <h4 style="margin: 20px 0 10px 0;">ğŸ“¦ äº§å“æ˜ç»† (${invoice.items.length}é¡¹)</h4>
          <div style="overflow-x: auto; margin-bottom: 20px;">
            <table class="data-table">
              <thead>
                <tr>
                  <th style="min-width: 250px;">äº§å“ä¿¡æ¯</th>
                  <th>æ•°é‡</th>
                  <th>å•ä»·ï¼ˆå«ç¨ï¼‰</th>
                  <th>æ€»ä»·ï¼ˆå«ç¨ï¼‰</th>
                  <th>ç¨ç‡</th>
                  <th>åºåˆ—å·</th>
                  <th>æ¥æº</th>
                </tr>
              </thead>
              <tbody>
                ${invoice.items.map(item => {
                  // æ ¼å¼åŒ–äº§å“åç§°ï¼Œæ˜¾ç¤ºå˜ä½“ä¿¡æ¯
                  let displayName = item.productName;
                  if (item.description && item.description !== item.productName) {
                    displayName = item.description;
                  }
                  
                  // æ·»åŠ ä½ç½®å’ŒçŠ¶æ€ä¿¡æ¯
                  let extraInfo = [];
                  if (item.location) {
                    extraInfo.push(`ğŸ“ ${item.location}`);
                  }
                  if (item.condition) {
                    const conditionLabels = {
                      'BRAND_NEW': 'å…¨æ–°',
                      'LIKE_NEW': '99æ–°',
                      'EXCELLENT': 'ä¼˜ç§€',
                      'GOOD': 'è‰¯å¥½',
                      'FAIR': 'ä¸€èˆ¬'
                    };
                    extraInfo.push(conditionLabels[item.condition] || item.condition);
                  }
                  
                  return `
                    <tr>
                      <td>
                        <div style="font-weight: 500;">${displayName}</div>
                        ${extraInfo.length > 0 ? `<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${extraInfo.join(' â€¢ ')}</div>` : ''}
                      </td>
                      <td>${item.quantity}</td>
                      <td>â‚¬${item.unitCost.toFixed(2)}</td>
                      <td><strong>â‚¬${item.totalCost.toFixed(2)}</strong></td>
                      <td>${item.vatRate}</td>
                      <td>
                        ${item.serialNumbers && item.serialNumbers.length > 0 ? 
                          `<div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.serialNumbers.join(', ')}">
                            ${item.serialNumbers.join(', ')}
                          </div>` : 
                          '-'
                        }
                      </td>
                      <td>
                        <span style="font-size: 11px; padding: 2px 6px; border-radius: 4px; background: ${item.source === 'AdminInventory' ? '#dbeafe' : '#fef3c7'}; color: ${item.source === 'AdminInventory' ? '#1e40af' : '#92400e'};">
                          ${item.source === 'AdminInventory' ? 'ğŸ“¦ åº“å­˜ç³»ç»Ÿ' : 'ğŸ“‹ é‡‡è´­è®¢å•'}
                        </span>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
          
          <!-- ç¨é¢åˆ†è§£ -->
          <h4 style="margin: 20px 0 10px 0;">ğŸ’° ç¨é¢åˆ†è§£</h4>
          <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            ${Object.keys(taxBreakdown).map(vatRate => `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                <div>
                  <strong>${vatRate}</strong>
                  <div style="font-size: 12px; color: #6b7280;">
                    å°è®¡: â‚¬${taxBreakdown[vatRate].subtotal.toFixed(2)} + 
                    ç¨é¢: â‚¬${taxBreakdown[vatRate].taxAmount.toFixed(2)}
                  </div>
                </div>
                <div style="font-weight: bold;">
                  â‚¬${taxBreakdown[vatRate].total.toFixed(2)}
                </div>
              </div>
            `).join('')}
          </div>
          
          <!-- é‡‘é¢æ±‡æ€» -->
          <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>å°è®¡ï¼ˆä¸å«ç¨ï¼‰ï¼š</span>
              <span style="font-size: 18px;">â‚¬${invoice.subtotal.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <span>ç¨é¢åˆè®¡ï¼š</span>
              <span style="font-size: 18px; color: #f59e0b;">â‚¬${invoice.taxAmount.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #3b82f6;">
              <span style="font-weight: bold; font-size: 18px;">æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰ï¼š</span>
              <span style="font-weight: bold; font-size: 24px; color: #3b82f6;">â‚¬${invoice.totalAmount.toFixed(2)}</span>
            </div>
            ${(invoice.paidAmount || 0) > 0 ? `
              <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #bfdbfe;">
                <span>å·²ä»˜é‡‘é¢ï¼š</span>
                <span style="font-size: 18px; color: #10b981;">â‚¬${invoice.paidAmount.toFixed(2)}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                <span>å¾…ä»˜é‡‘é¢ï¼š</span>
                <span style="font-size: 18px; color: ${remainingAmount > 0 ? '#ef4444' : '#10b981'};">â‚¬${remainingAmount.toFixed(2)}</span>
              </div>
            ` : ''}
          </div>
          
          <!-- ä»˜æ¬¾è®°å½• -->
          ${invoice.payments && invoice.payments.length > 0 ? `
            <div style="margin-top: 20px;">
              <h4 style="margin: 0 0 10px 0;">ğŸ’³ ä»˜æ¬¾è®°å½•</h4>
              <div style="overflow-x: auto;">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>ä»˜æ¬¾æ—¥æœŸ</th>
                      <th>é‡‘é¢</th>
                      <th>ä»˜æ¬¾æ–¹å¼</th>
                      <th>Reference</th>
                      <th>å¤‡æ³¨</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${invoice.payments.map(payment => `
                      <tr>
                        <td>${new Date(payment.paymentDate).toLocaleDateString('zh-CN')}</td>
                        <td><strong>â‚¬${payment.amount.toFixed(2)}</strong></td>
                        <td>${formatPaymentMethod(payment.paymentMethod)}</td>
                        <td>${payment.reference || '-'}</td>
                        <td>${payment.notes || '-'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          ` : ''}
          
          ${invoice.notes ? `
            <div style="margin-top: 20px;">
              <h4 style="margin: 0 0 10px 0;">ğŸ“ å¤‡æ³¨</h4>
              <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                ${invoice.notes}
              </div>
            </div>
          ` : ''}
        </div>
      `;
      
      showUniversalModal(title, content);
    }
    
    // æ ¼å¼åŒ–ä»˜æ¬¾æ–¹å¼æ˜¾ç¤º
    function formatPaymentMethod(method) {
      const methodMap = {
        'bank_transfer': 'é“¶è¡Œè½¬è´¦',
        'cash': 'ç°é‡‘',
        'credit_card': 'ä¿¡ç”¨å¡',
        'check': 'æ”¯ç¥¨'
      };
      return methodMap[method] || method;
    }
    
    // è·å–ä»˜æ¬¾çŠ¶æ€æ ‡ç­¾
    function getPaymentStatusLabel(status) {
      const labels = {
        'pending': 'å¾…ä»˜æ¬¾',
        'partial': 'éƒ¨åˆ†ä»˜æ¬¾',
        'paid': 'å·²ä»˜æ¬¾',
        'overdue': 'é€¾æœŸ'
      };
      return labels[status] || status;
    }
    
    // è·å–å‘ç¥¨çŠ¶æ€æ ‡ç­¾
    function getInvoiceStatusLabel(status) {
      const labels = {
        'draft': 'è‰ç¨¿',
        'confirmed': 'å·²ç¡®è®¤',
        'received': 'å·²æ”¶è´§',
        'cancelled': 'å·²å–æ¶ˆ'
      };
      return labels[status] || status;
    }
    
    // æ˜¾ç¤ºæ·»åŠ ä»˜æ¬¾å¯¹è¯æ¡†
    function showAddPaymentModal(invoiceId, totalAmount, paidAmount) {
      const remainingAmount = totalAmount - paidAmount;
      
      const content = `
        <div style="max-width: 500px;">
          <h4 style="margin: 0 0 20px 0;">ğŸ’° æ·»åŠ ä»˜æ¬¾è®°å½•</h4>
          
          <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>å‘ç¥¨æ€»é‡‘é¢ï¼š</span>
              <span style="font-weight: bold;">â‚¬${totalAmount.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>å·²ä»˜é‡‘é¢ï¼š</span>
              <span style="color: #10b981;">â‚¬${paidAmount.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid #e5e7eb;">
              <span style="font-weight: bold;">å¾…ä»˜é‡‘é¢ï¼š</span>
              <span style="font-weight: bold; color: #ef4444;">â‚¬${remainingAmount.toFixed(2)}</span>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä»˜æ¬¾é‡‘é¢ (â‚¬) *</label>
            <input type="number" id="paymentAmount" step="0.01" value="${remainingAmount.toFixed(2)}" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä»˜æ¬¾æ–¹å¼ *</label>
            <select id="paymentMethod" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              <option value="">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</option>
              <option value="bank_transfer">é“¶è¡Œè½¬è´¦ (Bank Transfer)</option>
              <option value="cash">ç°é‡‘ (Cash)</option>
              <option value="credit_card">ä¿¡ç”¨å¡ (Credit Card)</option>
              <option value="check">æ”¯ç¥¨ (Check)</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Reference / äº¤æ˜“å·</label>
            <input type="text" id="paymentReference" placeholder="ä¾‹å¦‚: TXN123456" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä»˜æ¬¾æ—¥æœŸ</label>
            <input type="date" id="paymentDate" value="${new Date().toISOString().split('T')[0]}" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
            <textarea id="paymentNotes" rows="3" placeholder="ä»˜æ¬¾å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" 
                      style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;"></textarea>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal()" class="btn-secondary" style="padding: 8px 16px;">
              å–æ¶ˆ
            </button>
            <button onclick="submitPayment('${invoiceId}')" class="btn-primary" style="padding: 8px 16px;">
              âœ… ç¡®è®¤ä»˜æ¬¾
            </button>
          </div>
        </div>
      `;
      
      showUniversalModal('ğŸ’° æ·»åŠ ä»˜æ¬¾', content);
    }
    
    // æäº¤ä»˜æ¬¾è®°å½•
    async function submitPayment(invoiceId) {
      try {
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const paymentMethod = document.getElementById('paymentMethod').value;
        const reference = document.getElementById('paymentReference').value;
        const paymentDate = document.getElementById('paymentDate').value;
        const notes = document.getElementById('paymentNotes').value;
        
        // éªŒè¯
        if (!amount || amount <= 0) {
          alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ä»˜æ¬¾é‡‘é¢');
          return;
        }
        
        if (!paymentMethod) {
          alert('âŒ è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼');
          return;
        }
        
        debugLog(`æäº¤ä»˜æ¬¾: ${invoiceId}, é‡‘é¢: â‚¬${amount}`);
        
        const response = await fetch(`${API_BASE}/purchase-orders/${invoiceId}/payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            amount: amount,
            paymentMethod: paymentMethod,
            reference: reference,
            paymentDate: paymentDate,
            notes: notes
          })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… ä»˜æ¬¾è®°å½•æ·»åŠ æˆåŠŸï¼\n\nä»˜æ¬¾é‡‘é¢: â‚¬${amount.toFixed(2)}\nå·²ä»˜æ€»é¢: â‚¬${result.data.paidAmount.toFixed(2)}\nå¾…ä»˜é‡‘é¢: â‚¬${result.data.remainingAmount.toFixed(2)}`);
          closeModal();
          // åˆ·æ–°å‘ç¥¨è¯¦æƒ…
          viewInvoiceDetails(invoiceId);
        } else {
          throw new Error(result.error || 'æ·»åŠ ä»˜æ¬¾è®°å½•å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ æ·»åŠ ä»˜æ¬¾è®°å½•å¤±è´¥: ${error.message}`);
        alert(`âŒ æ·»åŠ ä»˜æ¬¾è®°å½•å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ ¼å¼åŒ–VAT Rateæ˜¾ç¤ºï¼ˆåŒ…å«ç¨åŠ¡åˆ†ç±»å…¨åå’Œç¨ç‡ï¼‰
    function formatVatRate(vatRate) {
      const vatRateMap = {
        'VAT 23%': 'Standard Rate - 23%',
        'VAT 13.5%': 'Reduced Rate - 13.5%',
        'VAT 0%': 'Margin VAT - 0%'
      };
      return vatRateMap[vatRate] || vatRate;
    }
    
    // ==================== å®¢æˆ·ç®¡ç†åŠŸèƒ½ ====================
    
    // åŠ è½½å®¢æˆ·åˆ—è¡¨
    async function loadCustomers(searchTerm = '') {
      debugLog('å¼€å§‹åŠ è½½å®¢æˆ·åˆ—è¡¨');
      const container = document.getElementById('customersContainer');
      container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å®¢æˆ·æ•°æ®...</div>';
      
      try {
        const url = searchTerm ? 
          `${API_BASE}/customers?search=${encodeURIComponent(searchTerm)}` : 
          `${API_BASE}/customers`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`å®¢æˆ·APIå“åº”: ${result.data?.length || 0} ä¸ªå®¢æˆ·`);
        
        if (result.success && result.data && result.data.length > 0) {
          renderCustomers(result.data);
        } else {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ›’</div><h3>æš‚æ— å®¢æˆ·</h3><p>ç‚¹å‡»"æ·»åŠ å®¢æˆ·"æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªå®¢æˆ·</p></div>';
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½å®¢æˆ·å¤±è´¥: ${error.message}`);
        container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ¸²æŸ“å®¢æˆ·åˆ—è¡¨
    function renderCustomers(customers) {
      const container = document.getElementById('customersContainer');
      
      const html = `
        <table class="data-table">
          <thead>
            <tr>
              <th>å®¢æˆ·ä»£ç </th>
              <th>å®¢æˆ·åç§°</th>
              <th>ç±»å‹</th>
              <th>è”ç³»äºº</th>
              <th>ç”µè¯</th>
              <th>é‚®ç®±</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${customers.map(customer => `
              <tr>
                <td><strong>${customer.code || '-'}</strong></td>
                <td>${customer.name}</td>
                <td>${customer.type === 'business' ? 'ä¼ä¸š' : 'ä¸ªäºº'}</td>
                <td>${customer.contact?.person || '-'}</td>
                <td>${customer.contact?.phone || '-'}</td>
                <td>${customer.contact?.email || '-'}</td>
                <td>
                  <button onclick="startSale('${customer._id}', '${customer.name}')" class="btn btn-sm btn-success" style="margin-right: 5px;">ğŸ’° é”€å”®</button>
                  <button onclick="viewCustomerInvoices('${customer._id}', '${customer.name}')" class="btn btn-sm btn-info" style="margin-right: 5px;">ğŸ“‹ æŸ¥çœ‹å‘ç¥¨</button>
                  <button onclick="editCustomer('${customer._id}')" class="btn btn-sm btn-primary" style="margin-right: 5px;">âœï¸ ç¼–è¾‘</button>
                  <button onclick="deleteCustomer('${customer._id}', '${customer.name}')" class="btn btn-sm btn-danger">ğŸ—‘ï¸ åˆ é™¤</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }
    
    // æœç´¢å®¢æˆ·
    function searchCustomers() {
      const searchTerm = document.getElementById('customerSearchInput').value.trim();
      loadCustomers(searchTerm);
    }
    
    // æ˜¾ç¤ºæ·»åŠ å®¢æˆ·æ¨¡æ€æ¡†
    function showAddCustomerModal() {
      const title = 'â• æ·»åŠ å®¢æˆ·';
      
      const content = `
        <div style="max-width: 800px;">
          <form id="addCustomerForm" onsubmit="saveNewCustomer(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¬å¸åç§° *</label>
                <input type="text" name="name" required
                       style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å®¢æˆ·ä»£ç </label>
                <input type="text" name="code" placeholder="è‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥"
                       style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
              </div>
              
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¬å¸æ³¨å†Œå·ç </label>
                <input type="text" name="registrationNumber"
                       style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
              </div>
              
              <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç±»å‹</label>
                <select name="type" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  <option value="business">ä¼ä¸š</option>
                  <option value="individual">ä¸ªäºº</option>
                </select>
              </div>
              
              <div style="grid-column: 1 / -1; background: #f8fafc; padding: 15px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0;">ğŸ“ è”ç³»ä¿¡æ¯</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è”ç³»äºº</label>
                    <input type="text" name="contact.person"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç”µè¯</label>
                    <input type="text" name="contact.phone"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                  
                  <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">é‚®ç®±</label>
                    <input type="email" name="contact.email"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                </div>
              </div>
              
              <div style="grid-column: 1 / -1; background: #f8fafc; padding: 15px; border-radius: 8px;">
                <h4 style="margin: 0 0 15px 0;">ğŸ“ åœ°å€ä¿¡æ¯</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¡—é“åœ°å€</label>
                    <input type="text" name="contact.address.street"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">åŸå¸‚</label>
                    <input type="text" name="contact.address.city"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å·/çœ</label>
                    <input type="text" name="contact.address.state"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">é‚®ç¼–</label>
                    <input type="text" name="contact.address.postalCode"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å›½å®¶</label>
                    <input type="text" name="contact.address.country" value="Ireland"
                           style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                  </div>
                </div>
              </div>
              
              <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç¨å·ï¼ˆVAT Numberï¼‰</label>
                <input type="text" name="taxNumber"
                       style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
              </div>
              
              <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¤‡æ³¨</label>
                <textarea name="notes" rows="3"
                          style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;"></textarea>
              </div>
            </div>
            
            <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px;">
              <button type="button" onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6;">
                å–æ¶ˆ
              </button>
              <button type="submit" class="btn btn-success">
                âœ… ä¿å­˜å®¢æˆ·
              </button>
            </div>
          </form>
        </div>
      `;
      
      showUniversalModal(title, content);
    }
    
    // ä¿å­˜æ–°å®¢æˆ·
    async function saveNewCustomer(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      // æ„å»ºåµŒå¥—å¯¹è±¡
      const data = {
        name: formData.get('name'),
        code: formData.get('code') || `CUST-${Date.now()}`,
        type: formData.get('type'),
        registrationNumber: formData.get('registrationNumber'),
        contact: {
          person: formData.get('contact.person'),
          phone: formData.get('contact.phone'),
          email: formData.get('contact.email'),
          address: {
            street: formData.get('contact.address.street'),
            city: formData.get('contact.address.city'),
            state: formData.get('contact.address.state'),
            postalCode: formData.get('contact.address.postalCode'),
            country: formData.get('contact.address.country')
          }
        },
        taxNumber: formData.get('taxNumber'),
        notes: formData.get('notes')
      };
      
      try {
        const response = await fetch(`${API_BASE}/customers`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å®¢æˆ·æ·»åŠ æˆåŠŸï¼');
          closeUniversalModal();
          loadCustomers(); // åˆ·æ–°å®¢æˆ·åˆ—è¡¨
        } else {
          throw new Error(result.error || 'æ·»åŠ å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ æ·»åŠ å®¢æˆ·å¤±è´¥: ${error.message}`);
        alert(`âŒ æ·»åŠ å®¢æˆ·å¤±è´¥: ${error.message}`);
      }
    }
    
    // ç¼–è¾‘å®¢æˆ·
    async function editCustomer(customerId) {
      debugLog(`ç¼–è¾‘å®¢æˆ·: ${customerId}`);
      
      try {
        // è·å–å®¢æˆ·è¯¦æƒ…
        const response = await fetch(`${API_BASE}/customers/${customerId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (!result.success || !result.data) {
          throw new Error('è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥');
        }
        
        const customer = result.data;
        
        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        const title = `âœï¸ Edit Customer - ${customer.name}`;
        const content = `
          <form id="editCustomerForm" style="max-width: 600px;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Customer Code *</label>
              <input type="text" id="editCustomerCode" value="${customer.code}" required
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Customer Name *</label>
              <input type="text" id="editCustomerName" value="${customer.name}" required
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Contact Person</label>
              <input type="text" id="editCustomerContactPerson" value="${customer.contact?.person || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phone</label>
              <input type="tel" id="editCustomerPhone" value="${customer.contact?.phone || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
              <input type="email" id="editCustomerEmail" value="${customer.contact?.email || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Address</label>
              <textarea id="editCustomerAddress" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">${customer.contact?.address?.street || ''}</textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Payment Terms</label>
              <select id="editCustomerPaymentTerms"
                      style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
                <option value="cash" ${customer.financial?.paymentTerms === 'cash' ? 'selected' : ''}>Cash</option>
                <option value="net7" ${customer.financial?.paymentTerms === 'net7' ? 'selected' : ''}>Net 7 Days</option>
                <option value="net15" ${customer.financial?.paymentTerms === 'net15' ? 'selected' : ''}>Net 15 Days</option>
                <option value="net30" ${customer.financial?.paymentTerms === 'net30' ? 'selected' : ''}>Net 30 Days</option>
                <option value="net60" ${customer.financial?.paymentTerms === 'net60' ? 'selected' : ''}>Net 60 Days</option>
                <option value="net90" ${customer.financial?.paymentTerms === 'net90' ? 'selected' : ''}>Net 90 Days</option>
              </select>
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tax Number (VAT Number)</label>
              <input type="text" id="editCustomerTaxNumber" value="${customer.taxNumber || ''}"
                     style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;"
                     placeholder="IE1234567X">
            </div>
            
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">Notes</label>
              <textarea id="editCustomerNotes" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">${customer.notes || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
              <button type="submit" class="btn btn-primary">ğŸ’¾ Save Changes</button>
            </div>
          </form>
        `;
        
        showUniversalModal(title, content);
        
        // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
        document.getElementById('editCustomerForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          await saveCustomerEdit(customerId);
        });
        
      } catch (error) {
        debugLog(`âŒ è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥: ${error.message}`);
        alert(`âŒ Failed to load customer: ${error.message}`);
      }
    }
    
    // ä¿å­˜å®¢æˆ·ç¼–è¾‘
    async function saveCustomerEdit(customerId) {
      const updateData = {
        code: document.getElementById('editCustomerCode').value.trim(),
        name: document.getElementById('editCustomerName').value.trim(),
        contact: {
          person: document.getElementById('editCustomerContactPerson').value.trim(),
          phone: document.getElementById('editCustomerPhone').value.trim(),
          email: document.getElementById('editCustomerEmail').value.trim(),
          address: {
            street: document.getElementById('editCustomerAddress').value.trim()
          }
        },
        financial: {
          paymentTerms: document.getElementById('editCustomerPaymentTerms').value
        },
        taxNumber: document.getElementById('editCustomerTaxNumber').value.trim(),
        notes: document.getElementById('editCustomerNotes').value.trim()
      };
      
      if (!updateData.code || !updateData.name) {
        alert('Customer code and name are required');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/customers/${customerId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (result.success) {
          alert('âœ… Customer updated successfully');
          closeModal();
          loadCustomers();
        } else {
          throw new Error(result.error || 'Update failed');
        }
      } catch (error) {
        debugLog(`âŒ æ›´æ–°å®¢æˆ·å¤±è´¥: ${error.message}`);
        alert(`âŒ Update failed: ${error.message}`);
      }
    }
    
    // åˆ é™¤å®¢æˆ·
    async function deleteCustomer(customerId, customerName) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤å®¢æˆ·"${customerName}"å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/customers/${customerId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (result.success) {
          alert('âœ… å®¢æˆ·åˆ é™¤æˆåŠŸ');
          loadCustomers();
        } else {
          throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ åˆ é™¤å®¢æˆ·å¤±è´¥: ${error.message}`);
        alert(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
      }
    }
    
    // æŸ¥çœ‹å®¢æˆ·å‘ç¥¨
    async function viewCustomerInvoices(customerId, customerName) {
      debugLog(`æŸ¥çœ‹å®¢æˆ·å‘ç¥¨: ${customerId}`);
      
      try {
        const response = await fetch(`${API_BASE}/customers/${customerId}/invoices`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          showCustomerInvoicesModal(customerName, result.data);
        } else {
          throw new Error(result.error || 'è·å–å‘ç¥¨å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ è·å–å®¢æˆ·å‘ç¥¨å¤±è´¥: ${error.message}`);
        alert(`âŒ è·å–å‘ç¥¨å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºå®¢æˆ·å‘ç¥¨æ¨¡æ€æ¡†
    function showCustomerInvoicesModal(customerName, invoices) {
      const title = `ğŸ“‹ ${customerName} - é”€å”®å‘ç¥¨è®°å½•`;
      
      let content;
      if (invoices.length === 0) {
        content = '<div class="empty-state"><p>æš‚æ— é”€å”®å‘ç¥¨è®°å½•</p></div>';
      } else {
        content = `
          <div style="overflow-x: auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>å‘ç¥¨ç¼–å·</th>
                  <th>å‘ç¥¨æ—¥æœŸ</th>
                  <th>å°è®¡ï¼ˆä¸å«ç¨ï¼‰</th>
                  <th>ç¨é¢</th>
                  <th>æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰</th>
                  <th>ä»˜æ¬¾çŠ¶æ€</th>
                  <th>çŠ¶æ€</th>
                </tr>
              </thead>
              <tbody>
                ${invoices.map(invoice => `
                  <tr>
                    <td>
                      <strong style="color: #3b82f6; cursor: pointer; text-decoration: underline;" 
                              onclick="showSalesInvoiceDetails('${invoice._id}')">
                        ${invoice.invoiceNumber}
                      </strong>
                    </td>
                    <td>${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</td>
                    <td>â‚¬${invoice.subtotal.toFixed(2)}</td>
                    <td>â‚¬${invoice.taxAmount.toFixed(2)}</td>
                    <td><strong>â‚¬${invoice.totalAmount.toFixed(2)}</strong></td>
                    <td>${getPaymentStatusLabel(invoice.paymentStatus)}</td>
                    <td>${getSalesInvoiceStatusLabel(invoice.status)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      }
      
      showUniversalModal(title, content);
    }
    
    // è·å–é”€å”®å‘ç¥¨çŠ¶æ€æ ‡ç­¾
    function getSalesInvoiceStatusLabel(status) {
      const labels = {
        'draft': 'è‰ç¨¿',
        'confirmed': 'å·²ç¡®è®¤',
        'delivered': 'å·²äº¤ä»˜',
        'cancelled': 'å·²å–æ¶ˆ'
      };
      return labels[status] || status;
    }
    
    // æ˜¾ç¤ºé”€å”®å‘ç¥¨è¯¦æƒ…
    async function showSalesInvoiceDetails(invoiceId) {
      debugLog(`æ˜¾ç¤ºé”€å”®å‘ç¥¨è¯¦æƒ…: ${invoiceId}`);
      
      try {
        const response = await fetch(`/api/admin/sales-invoices/${invoiceId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const invoice = result.data;
          const companyInfo = invoice.companyInfo || {};
          const customer = invoice.customer || {};
          
          const title = `ğŸ“„ Sales Invoice Details - ${invoice.invoiceNumber}`;
          
          const content = `
            <div style="max-width: 1200px;">
              <!-- Invoice Header -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <div>
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Company Information</h3>
                  <div style="line-height: 1.8;">
                    <div><strong>${companyInfo.companyName || 'N/A'}</strong></div>
                    <div>${companyInfo.address?.street || ''}</div>
                    <div>${companyInfo.address?.city || ''} ${companyInfo.address?.postalCode || ''}</div>
                    <div>${companyInfo.address?.country || 'Ireland'}</div>
                    <div style="margin-top: 10px;">
                      <div>Phone: ${companyInfo.contact?.phone || 'N/A'}</div>
                      <div>Email: ${companyInfo.contact?.email || 'N/A'}</div>
                      <div>VAT Number: ${companyInfo.taxNumber || 'N/A'}</div>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Customer Information</h3>
                  <div style="line-height: 1.8;">
                    <div><strong>${customer.name || 'N/A'}</strong></div>
                    <div>${customer.contact?.person ? 'Contact: ' + customer.contact.person : ''}</div>
                    <div>${customer.contact?.phone ? 'Phone: ' + customer.contact.phone : ''}</div>
                    <div>${customer.contact?.email ? 'Email: ' + customer.contact.email : ''}</div>
                    <div>${customer.taxNumber ? 'VAT Number: ' + customer.taxNumber : ''}</div>
                  </div>
                </div>
              </div>
              
              <!-- Invoice Info -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                <div style="padding: 15px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Invoice Number</div>
                  <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${invoice.invoiceNumber}</div>
                </div>
                <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Invoice Date</div>
                  <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${new Date(invoice.invoiceDate).toLocaleDateString('en-IE')}</div>
                </div>
                <div style="padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Status</div>
                  <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${invoice.status === 'confirmed' ? 'Confirmed' : invoice.status}</div>
                </div>
                <div style="padding: 15px; background: #fce7f3; border-radius: 8px; border-left: 4px solid #ec4899;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Payment Status</div>
                  <div style="font-size: 18px; font-weight: bold; color: #1f2937;">${getPaymentStatusLabel(invoice.paymentStatus)}</div>
                </div>
              </div>
              
              <!-- Items Table -->
              <div style="margin-bottom: 30px;">
                <h3 style="margin: 0 0 15px 0; color: #1f2937;">Items</h3>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #f8fafc;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Description</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Condition</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb;">Code</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">Quantity</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Unit Price<br>(Incl. VAT)</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">Total Price<br>(Incl. VAT)</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">VAT Rate</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">VAT Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${invoice.items.map(item => {
                        const code = item.serialNumbers && item.serialNumbers.length > 0 
                          ? item.serialNumbers.join(', ') 
                          : (item.barcode || item.code || 'N/A');
                        
                        // å®‰å…¨è·å–ä»·æ ¼ï¼Œå¦‚æœæœªå®šä¹‰åˆ™è®¡ç®—
                        const unitPriceIncludingTax = item.unitPriceIncludingTax || (item.unitPrice || 0);
                        const totalPriceIncludingTax = item.totalPriceIncludingTax || (item.totalPrice || 0);
                        const taxAmount = item.taxAmount || 0;
                        
                        return `
                          <tr>
                            <td style="padding: 12px; border: 1px solid #e5e7eb;">${item.description || item.product?.name || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #e5e7eb;">${item.condition || 'N/A'}</td>
                            <td style="padding: 12px; border: 1px solid #e5e7eb; font-family: monospace; font-size: 12px;">${code}</td>
                            <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${item.quantity}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">â‚¬${unitPriceIncludingTax.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb; font-weight: bold;">â‚¬${totalPriceIncludingTax.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center; border: 1px solid #e5e7eb;">${formatVatRate(item.vatRate)}</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #e5e7eb;">â‚¬${taxAmount.toFixed(2)}</td>
                          </tr>
                        `;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Totals -->
              <div style="display: flex; justify-content: flex-end; margin-bottom: 30px;">
                <div style="width: 400px; background: #f8fafc; padding: 20px; border-radius: 8px;">
                  <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span>Subtotal (Excl. VAT):</span>
                    <span style="font-weight: bold;">â‚¬${invoice.subtotal.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                    <span>VAT Amount:</span>
                    <span style="font-weight: bold;">â‚¬${invoice.taxAmount.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 15px 0; font-size: 20px; font-weight: bold; color: #1f2937;">
                    <span>Total Amount (Incl. VAT):</span>
                    <span style="color: #3b82f6;">â‚¬${invoice.totalAmount.toFixed(2)}</span>
                  </div>
                </div>
              </div>
              
              <!-- Payment Details -->
              ${invoice.payments && invoice.payments.length > 0 ? `
                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">
                  <h3 style="margin: 0 0 15px 0; color: #1f2937;">Payment Details</h3>
                  <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr style="background: #dcfce7;">
                          <th style="padding: 12px; text-align: left; border: 1px solid #bbf7d0;">Date</th>
                          <th style="padding: 12px; text-align: left; border: 1px solid #bbf7d0;">Payment Method</th>
                          <th style="padding: 12px; text-align: right; border: 1px solid #bbf7d0;">Amount</th>
                          <th style="padding: 12px; text-align: left; border: 1px solid #bbf7d0;">Reference</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${invoice.payments.map(payment => {
                          const methodLabels = {
                            'cash': 'ğŸ’µ Cash',
                            'bank_transfer': 'ğŸ¦ Bank Transfer',
                            'credit_card': 'ğŸ’³ Credit Card',
                            'check': 'ğŸ“ Check'
                          };
                          const methodLabel = methodLabels[payment.paymentMethod] || payment.paymentMethod;
                          
                          return `
                            <tr>
                              <td style="padding: 12px; border: 1px solid #bbf7d0;">${new Date(payment.paymentDate).toLocaleDateString('en-IE')}</td>
                              <td style="padding: 12px; border: 1px solid #bbf7d0;">${methodLabel}</td>
                              <td style="padding: 12px; text-align: right; border: 1px solid #bbf7d0; font-weight: bold;">â‚¬${payment.amount.toFixed(2)}</td>
                              <td style="padding: 12px; border: 1px solid #bbf7d0; font-family: monospace; font-size: 12px;">${payment.reference || '-'}</td>
                            </tr>
                          `;
                        }).join('')}
                        <tr style="background: #dcfce7; font-weight: bold;">
                          <td colspan="2" style="padding: 12px; border: 1px solid #bbf7d0; text-align: right;">Total Paid:</td>
                          <td style="padding: 12px; text-align: right; border: 1px solid #bbf7d0; color: #10b981; font-size: 18px;">â‚¬${(invoice.paidAmount || 0).toFixed(2)}</td>
                          <td style="padding: 12px; border: 1px solid #bbf7d0;"></td>
                        </tr>
                        ${invoice.paidAmount < invoice.totalAmount ? `
                          <tr style="background: #fef3c7; font-weight: bold;">
                            <td colspan="2" style="padding: 12px; border: 1px solid #fde68a; text-align: right;">Remaining Balance:</td>
                            <td style="padding: 12px; text-align: right; border: 1px solid #fde68a; color: #f59e0b; font-size: 18px;">â‚¬${(invoice.totalAmount - invoice.paidAmount).toFixed(2)}</td>
                            <td style="padding: 12px; border: 1px solid #fde68a;"></td>
                          </tr>
                        ` : ''}
                      </tbody>
                    </table>
                  </div>
                </div>
              ` : ''}
              
              <!-- Payment Information -->
              <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <h3 style="margin: 0 0 15px 0; color: #1f2937;">Bank Information</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                  <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">IBAN</div>
                    <div style="font-family: monospace; font-weight: bold;">${companyInfo.bankDetails?.iban || 'N/A'}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">BIC/SWIFT</div>
                    <div style="font-family: monospace; font-weight: bold;">${companyInfo.bankDetails?.bic || 'N/A'}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Bank</div>
                    <div style="font-weight: bold;">${companyInfo.bankDetails?.bankName || 'N/A'}</div>
                  </div>
                </div>
              </div>
              
              <!-- Actions -->
              <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  ${invoice.paymentStatus !== 'paid' ? `
                    <button onclick="showPaymentModal('${invoice._id}', ${invoice.totalAmount}, ${invoice.paidAmount || 0})" 
                            class="btn btn-success" style="padding: 12px 24px;">
                      ğŸ’³ Confirm Payment
                    </button>
                  ` : `
                    <span style="color: #10b981; font-weight: bold; font-size: 16px;">âœ… Fully Paid</span>
                  `}
                </div>
                <div style="display: flex; gap: 10px;">
                  <button onclick="downloadSalesInvoice('${invoice._id}')" class="btn btn-primary" style="padding: 12px 24px;">
                    ğŸ“¥ Download PDF
                  </button>
                  <button onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6; padding: 12px 24px;">
                    Close
                  </button>
                </div>
              </div>
            </div>
          `;
          
          showUniversalModal(title, content);
        } else {
          throw new Error('Failed to get invoice details');
        }
      } catch (error) {
        debugLog(`âŒ è·å–é”€å”®å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${error.message}`);
        alert(`âŒ Failed to load invoice details: ${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºä»˜æ¬¾æ¨¡æ€æ¡†
    function showPaymentModal(invoiceId, totalAmount, paidAmount) {
      const remainingAmount = totalAmount - paidAmount;
      
      const title = 'ğŸ’³ Confirm Payment';
      const content = `
        <div style="max-width: 600px;">
          <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #0ea5e9;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Total Amount</div>
                <div style="font-size: 20px; font-weight: bold; color: #1f2937;">â‚¬${totalAmount.toFixed(2)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Paid Amount</div>
                <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${paidAmount.toFixed(2)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Remaining</div>
                <div style="font-size: 20px; font-weight: bold; color: #ef4444;">â‚¬${remainingAmount.toFixed(2)}</div>
              </div>
            </div>
          </div>
          
          <form id="paymentForm" onsubmit="confirmPayment(event, '${invoiceId}')">
            <h3 style="margin: 0 0 20px 0; color: #1f2937;">Payment Methods</h3>
            
            <!-- Cash Payment -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <input type="checkbox" id="cashEnabled" onchange="togglePaymentMethod('cash')" 
                       style="width: 18px; height: 18px; margin-right: 10px;">
                <label for="cashEnabled" style="font-weight: bold; font-size: 16px; cursor: pointer;">
                  ğŸ’µ Cash
                </label>
              </div>
              <div id="cashInput" style="display: none;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount (EUR)</label>
                <input type="number" id="cashAmount" step="0.01" min="0" max="${remainingAmount}" 
                       placeholder="0.00" onchange="updateRemainingAmount()"
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;">
              </div>
            </div>
            
            <!-- Bank Transfer Payment -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <input type="checkbox" id="transferEnabled" onchange="togglePaymentMethod('transfer')" 
                       style="width: 18px; height: 18px; margin-right: 10px;">
                <label for="transferEnabled" style="font-weight: bold; font-size: 16px; cursor: pointer;">
                  ğŸ¦ Bank Transfer
                </label>
              </div>
              <div id="transferInput" style="display: none;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount (EUR)</label>
                <input type="number" id="transferAmount" step="0.01" min="0" max="${remainingAmount}" 
                       placeholder="0.00" onchange="updateRemainingAmount()"
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px; margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Reference (Optional)</label>
                <input type="text" id="transferReference" placeholder="Transaction reference" 
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;">
              </div>
            </div>
            
            <!-- Credit Card Payment -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; margin-bottom: 15px;">
                <input type="checkbox" id="cardEnabled" onchange="togglePaymentMethod('card')" 
                       style="width: 18px; height: 18px; margin-right: 10px;">
                <label for="cardEnabled" style="font-weight: bold; font-size: 16px; cursor: pointer;">
                  ğŸ’³ Credit Card
                </label>
              </div>
              <div id="cardInput" style="display: none;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount (EUR)</label>
                <input type="number" id="cardAmount" step="0.01" min="0" max="${remainingAmount}" 
                       placeholder="0.00" onchange="updateRemainingAmount()"
                       style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;">
              </div>
            </div>
            
            <!-- Payment Summary -->
            <div style="background: #fef3c7; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span style="font-weight: 500;">Total Payment:</span>
                <span id="totalPayment" style="font-weight: bold; font-size: 18px; color: #1f2937;">â‚¬0.00</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="font-weight: 500;">Remaining After Payment:</span>
                <span id="remainingAfterPayment" style="font-weight: bold; font-size: 18px; color: #ef4444;">â‚¬${remainingAmount.toFixed(2)}</span>
              </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
              <button type="button" onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6; padding: 12px 24px;">
                Cancel
              </button>
              <button type="submit" class="btn btn-success" style="padding: 12px 24px;">
                âœ… Confirm Payment
              </button>
            </div>
          </form>
        </div>
      `;
      
      showUniversalModal(title, content);
      
      // å­˜å‚¨å‰©ä½™é‡‘é¢åˆ°å…¨å±€å˜é‡
      window.currentRemainingAmount = remainingAmount;
    }
    
    // åˆ‡æ¢ä»˜æ¬¾æ–¹å¼è¾“å…¥æ¡†
    function togglePaymentMethod(method) {
      const checkbox = document.getElementById(`${method}Enabled`);
      const input = document.getElementById(`${method}Input`);
      
      if (checkbox.checked) {
        input.style.display = 'block';
      } else {
        input.style.display = 'none';
        document.getElementById(`${method}Amount`).value = '';
        updateRemainingAmount();
      }
    }
    
    // æ›´æ–°å‰©ä½™é‡‘é¢æ˜¾ç¤º
    function updateRemainingAmount() {
      const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
      const transferAmount = parseFloat(document.getElementById('transferAmount').value) || 0;
      const cardAmount = parseFloat(document.getElementById('cardAmount').value) || 0;
      
      const totalPayment = cashAmount + transferAmount + cardAmount;
      const remainingAfterPayment = window.currentRemainingAmount - totalPayment;
      
      document.getElementById('totalPayment').textContent = `â‚¬${totalPayment.toFixed(2)}`;
      document.getElementById('remainingAfterPayment').textContent = `â‚¬${Math.max(0, remainingAfterPayment).toFixed(2)}`;
      
      // å¦‚æœè¶…é¢ï¼Œæ˜¾ç¤ºè­¦å‘Š
      if (remainingAfterPayment < 0) {
        document.getElementById('remainingAfterPayment').style.color = '#ef4444';
        document.getElementById('totalPayment').style.color = '#ef4444';
      } else {
        document.getElementById('remainingAfterPayment').style.color = '#10b981';
        document.getElementById('totalPayment').style.color = '#1f2937';
      }
    }
    
    // ç¡®è®¤ä»˜æ¬¾
    async function confirmPayment(event, invoiceId) {
      event.preventDefault();
      
      const payments = [];
      
      // æ”¶é›†ç°é‡‘ä»˜æ¬¾
      if (document.getElementById('cashEnabled').checked) {
        const amount = parseFloat(document.getElementById('cashAmount').value) || 0;
        if (amount > 0) {
          payments.push({
            method: 'cash',
            amount: amount
          });
        }
      }
      
      // æ”¶é›†è½¬è´¦ä»˜æ¬¾
      if (document.getElementById('transferEnabled').checked) {
        const amount = parseFloat(document.getElementById('transferAmount').value) || 0;
        if (amount > 0) {
          payments.push({
            method: 'bank_transfer',
            amount: amount,
            reference: document.getElementById('transferReference').value || ''
          });
        }
      }
      
      // æ”¶é›†ä¿¡ç”¨å¡ä»˜æ¬¾
      if (document.getElementById('cardEnabled').checked) {
        const amount = parseFloat(document.getElementById('cardAmount').value) || 0;
        if (amount > 0) {
          payments.push({
            method: 'credit_card',
            amount: amount
          });
        }
      }
      
      if (payments.length === 0) {
        alert('Please enter at least one payment method and amount');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/sales-invoices/${invoiceId}/payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ payments })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          closeUniversalModal();
          alert('âœ… Payment confirmed successfully!');
          // é‡æ–°æ˜¾ç¤ºå‘ç¥¨è¯¦æƒ…
          showSalesInvoiceDetails(invoiceId);
        } else {
          throw new Error(result.error || 'Payment confirmation failed');
        }
      } catch (error) {
        debugLog(`âŒ ç¡®è®¤ä»˜æ¬¾å¤±è´¥: ${error.message}`);
        alert(`âŒ Payment confirmation failed: ${error.message}`);
      }
    }
    
    // ==================== äº§å“è¿½æº¯åŠŸèƒ½ ====================
    
    // æœç´¢äº§å“è¿½æº¯
    async function searchProductTracking() {
      const searchTerm = document.getElementById('trackingSearchInput').value.trim();
      
      if (!searchTerm) {
        alert('è¯·è¾“å…¥æœç´¢æ¡ä»¶');
        return;
      }
      
      debugLog(`å¼€å§‹äº§å“è¿½æº¯æŸ¥è¯¢: ${searchTerm}`);
      const container = document.getElementById('trackingContainer');
      container.innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢äº§å“è¿½æº¯ä¿¡æ¯...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/products/tracking?search=${encodeURIComponent(searchTerm)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`è¿½æº¯APIå“åº”: ${result.data?.history?.length || 0} æ¡è®°å½•`);
        
        if (result.success && result.data) {
          renderProductTracking(result.data);
        } else {
          throw new Error(result.error || 'æŸ¥è¯¢å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ äº§å“è¿½æº¯æŸ¥è¯¢å¤±è´¥: ${error.message}`);
        container.innerHTML = `<div class="error">æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ¸²æŸ“äº§å“è¿½æº¯ç»“æœ
    function renderProductTracking(data) {
      const container = document.getElementById('trackingContainer');
      
      if (!data.products || data.products.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><h3>æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</h3><p>è¯·å°è¯•å…¶ä»–æœç´¢æ¡ä»¶</p></div>';
        return;
      }
      
      const html = `
        <div style="margin-bottom: 30px;">
          <h3 style="margin-bottom: 15px;">ğŸ” æ‰¾åˆ° ${data.products.length} ä¸ªäº§å“</h3>
          <div style="display: grid; gap: 15px;">
            ${data.products.map(product => `
              <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <h4 style="margin: 0 0 8px 0;">${product.name}</h4>
                    <div style="color: #6b7280; font-size: 14px;">
                      <span>SKU: <strong>${product.sku}</strong></span>
                      ${product.barcode ? ` | æ¡ç : <strong>${product.barcode}</strong>` : ''}
                      ${product.color ? ` | é¢œè‰²: <strong>${product.color}</strong>` : ''}
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 14px; color: #6b7280;">å½“å‰åº“å­˜</div>
                    <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${product.stockQuantity}</div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <div>
          <h3 style="margin-bottom: 15px;">ğŸ“… å†å²è®°å½•æ—¶é—´çº¿ (${data.history.length} æ¡)</h3>
          ${data.history.length === 0 ? 
            '<div class="empty-state"><p>æš‚æ— å†å²è®°å½•</p></div>' :
            `<div style="position: relative; padding-left: 30px;">
              <div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: #e5e7eb;"></div>
              ${data.history.map((record, index) => `
                <div style="position: relative; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                  <div style="position: absolute; left: -24px; top: 20px; width: 12px; height: 12px; border-radius: 50%; background: ${record.type === 'purchase' ? '#10b981' : '#f59e0b'}; border: 2px solid white;"></div>
                  
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div>
                      <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; background: ${record.type === 'purchase' ? '#d1fae5' : '#fef3c7'}; color: ${record.type === 'purchase' ? '#065f46' : '#92400e'};">
                        ${record.type === 'purchase' ? 'ğŸ“¦ é‡‡è´­å…¥åº“' : 'ğŸ›’ é”€å”®å‡ºåº“'}
                      </span>
                      <span style="margin-left: 10px; color: #6b7280; font-size: 14px;">
                        ${new Date(record.date).toLocaleString('zh-CN')}
                      </span>
                    </div>
                    <div style="text-align: right;">
                      <div style="font-size: 12px; color: #6b7280;">${record.type === 'purchase' ? 'ä¾›è´§å•†' : 'å®¢æˆ·'}</div>
                      <div style="font-weight: bold;">${record.partner.name}</div>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div>
                      <div style="font-size: 12px; color: #6b7280;">å‘ç¥¨ç¼–å·</div>
                      <div style="font-weight: bold;">${record.invoiceNumber}</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: #6b7280;">äº§å“</div>
                      <div>${record.product.name}</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: #6b7280;">æ•°é‡</div>
                      <div style="font-weight: bold; color: ${record.type === 'purchase' ? '#10b981' : '#f59e0b'};">
                        ${record.type === 'purchase' ? '+' : '-'}${record.quantity}
                      </div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: #6b7280;">å•ä»·ï¼ˆå«ç¨ï¼‰</div>
                      <div>â‚¬${record.unitPrice.toFixed(2)}</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: #6b7280;">æ€»ä»·ï¼ˆå«ç¨ï¼‰</div>
                      <div style="font-weight: bold;">â‚¬${record.totalPrice.toFixed(2)}</div>
                    </div>
                    <div>
                      <div style="font-size: 12px; color: #6b7280;">ç¨ç‡</div>
                      <div>${record.vatRate || 'VAT 23%'}</div>
                    </div>
                  </div>
                  
                  ${record.serialNumbers && record.serialNumbers.length > 0 ? `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                      <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">åºåˆ—å·:</div>
                      <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        ${record.serialNumbers.map(sn => `
                          <span style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${sn}</span>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
            </div>`
          }
        </div>
      `;
      
      container.innerHTML = html;
    }

    // ==================== é”€å”®åŠŸèƒ½ ====================
    
    // å…¨å±€å˜é‡å­˜å‚¨å½“å‰é”€å”®ä¿¡æ¯
    let currentSaleCustomer = null;
    let selectedProducts = [];
    
    // å¼€å§‹é”€å”®æµç¨‹
    async function startSale(customerId, customerName) {
      debugLog(`å¼€å§‹é”€å”®æµç¨‹: å®¢æˆ· ${customerName}`);
      currentSaleCustomer = { id: customerId, name: customerName };
      selectedProducts = [];
      
      try {
        // è·å–æ‰€æœ‰äº§å“
        const response = await fetch('/api/products');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          showProductSelectionModal(result.data);
        } else {
          throw new Error('è·å–äº§å“å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ è·å–äº§å“å¤±è´¥: ${error.message}`);
        alert(`âŒ è·å–äº§å“å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ˜¾ç¤ºäº§å“é€‰æ‹©æ¨¡æ€æ¡† - ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©å¤§åˆ†ç±»
    function showProductSelectionModal(products) {
      const title = `ğŸ’° é”€å”®ç»™: ${currentSaleCustomer.name}`;
      
      // æŒ‰äº§å“ç±»å‹åˆ†ç»„
      const productsByType = {};
      products.forEach(product => {
        if (product.stockQuantity > 0 || (product.serialNumbers && product.serialNumbers.some(sn => sn.status === 'available'))) {
          const type = product.productType || 'å…¶ä»–';
          if (!productsByType[type]) {
            productsByType[type] = [];
          }
          productsByType[type].push(product);
        }
      });
      
      const content = `
        <div style="max-width: 1400px; width: 90vw;">
          <div style="background: #eff6ff; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #3b82f6;">
            <h3 style="margin: 0 0 10px 0;">ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©äº§å“åˆ†ç±»</h3>
            <p style="margin: 0; color: #6b7280; font-size: 16px;">ç‚¹å‡»åˆ†ç±»æŸ¥çœ‹è¯¥åˆ†ç±»ä¸‹çš„äº§å“</p>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
            ${Object.keys(productsByType).map(type => `
              <div onclick="showSaleCategoryProducts('${type}')" 
                   style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 30px; background: white; cursor: pointer; transition: all 0.3s; text-align: center;"
                   onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';"
                   onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                <div style="font-size: 48px; margin-bottom: 15px;">
                  ${getCategoryIcon(type)}
                </div>
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">
                  ${type}
                </div>
                <div style="color: #6b7280; font-size: 14px;">
                  ${productsByType[type].length} ä¸ªäº§å“
                </div>
              </div>
            `).join('')}
          </div>
          
          <div id="categoryProductsContainer"></div>
          
          <div style="position: sticky; bottom: 0; background: white; padding: 20px; border-top: 2px solid #e5e7eb; margin: 20px -20px -20px -20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 14px; color: #6b7280;">å·²é€‰æ‹©äº§å“</div>
                <div style="font-size: 24px; font-weight: bold; color: #3b82f6;" id="selectedCount">0 ä»¶</div>
              </div>
              <div style="display: flex; gap: 10px;">
                <button onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6; padding: 12px 24px; font-size: 16px;">å–æ¶ˆ</button>
                <button onclick="confirmSale()" class="btn btn-success" style="padding: 12px 40px; font-size: 16px;">
                  âœ… ç¡®è®¤é”€å”®
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      showUniversalModal(title, content);
      
      // ä¿å­˜äº§å“æ•°æ®åˆ°å…¨å±€å˜é‡
      window.allProducts = products;
    }
    
    // è·å–åˆ†ç±»å›¾æ ‡
    function getCategoryIcon(type) {
      const icons = {
        'æ‰‹æœºé…ä»¶': 'ğŸ“±',
        'ç”µè„‘é…ä»¶': 'ğŸ’»',
        'è½¦è½½é…ä»¶': 'ğŸš—',
        'audio': 'ğŸ§',
        'æ•°æ®çº¿': 'ğŸ”Œ',
        'power supply': 'ğŸ”‹',
        'å…¨æ–°è®¾å¤‡': 'ğŸ“¦',
        'äºŒæ‰‹è®¾å¤‡': 'â™»ï¸',
        'ç»´ä¿®': 'ğŸ”§'
      };
      return icons[type] || 'ğŸ“¦';
    }
    
    // æ˜¾ç¤ºåˆ†ç±»ä¸‹çš„äº§å“ - ç¬¬äºŒæ­¥ï¼ˆé”€å”®æµç¨‹ï¼‰
    function showSaleCategoryProducts(categoryType) {
      const products = window.allProducts.filter(p => p.productType === categoryType);
      // æ£€æŸ¥åˆ†ç±»åç§°ä¸­æ˜¯å¦åŒ…å« "Device" å…³é”®å­—ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
      const isDevice = categoryType?.toLowerCase().includes('device');
      
      const container = document.getElementById('categoryProductsContainer');
      
      let html = `
        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0ea5e9;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <h3 style="margin: 0 0 5px 0;">${getCategoryIcon(categoryType)} ${categoryType}</h3>
              <p style="margin: 0; color: #6b7280;">
                ${isDevice ? 'è¯·é€‰æ‹©è¦é”€å”®çš„è®¾å¤‡åºåˆ—å·' : 'è¯·è¾“å…¥è¦é”€å”®çš„æ•°é‡'}
              </p>
            </div>
            <button onclick="document.getElementById('categoryProductsContainer').innerHTML=''" 
                    class="btn" style="background: #f3f4f6;">
              â† è¿”å›åˆ†ç±»
            </button>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(${isDevice ? '400px' : '300px'}, 1fr)); gap: 20px;">
      `;
      
      products.forEach(product => {
        if (isDevice) {
          // è®¾å¤‡ï¼šæ˜¾ç¤ºåºåˆ—å·åˆ—è¡¨
          const availableSerials = product.serialNumbers?.filter(sn => sn.status === 'available') || [];
          
          if (availableSerials.length > 0) {
            html += `
              <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; background: white;">
                <div style="margin-bottom: 15px;">
                  <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${product.name}</div>
                  <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">
                    SKU: ${product.sku} ${product.color ? '| é¢œè‰²: ' + product.color : ''}
                  </div>
                  <div style="font-size: 16px; color: #10b981; font-weight: bold;">
                    â‚¬${(product.wholesalePrice || 0).toFixed(2)} / Unit
                  </div>
                </div>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                  <div style="font-weight: bold; margin-bottom: 10px; color: #374151;">
                    å¯ç”¨åºåˆ—å· (${availableSerials.length}):
                  </div>
                  ${availableSerials.map(sn => `
                    <label style="display: flex; align-items: center; padding: 10px; margin-bottom: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.background='#eff6ff'; this.style.borderColor='#3b82f6';"
                           onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb';">
                      <input type="checkbox" 
                             value="${sn.serialNumber}"
                             onchange="updateDeviceSelection('${product._id}', '${product.name}', ${product.wholesalePrice || 0}, '${sn.serialNumber}', this.checked)"
                             style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                      <span style="font-family: monospace; font-size: 14px; flex: 1;">${sn.serialNumber}</span>
                    </label>
                  `).join('')}
                </div>
              </div>
            `;
          }
        } else {
          // é…ä»¶ï¼šæ˜¾ç¤ºæ•°é‡è¾“å…¥
          html += `
            <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; background: white;">
              <div style="margin-bottom: 15px;">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">${product.name}</div>
                <div style="font-size: 14px; color: #6b7280; margin-bottom: 5px;">
                  SKU: ${product.sku} | åº“å­˜: ${product.stockQuantity}
                </div>
                <div style="font-size: 16px; color: #10b981; font-weight: bold;">
                  â‚¬${(product.wholesalePrice || 0).toFixed(2)}
                </div>
              </div>
              
              <div style="display: flex; gap: 10px; align-items: center;">
                <label style="font-weight: bold; color: #374151;">æ•°é‡:</label>
                <input type="number" 
                       id="qty_${product._id}" 
                       min="0" 
                       max="${product.stockQuantity}" 
                       value="0"
                       style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 16px;"
                       onchange="updateAccessorySelection('${product._id}', '${product.name}', ${product.wholesalePrice || 0}, ${product.stockQuantity}, '${product.barcode || ''}')">
              </div>
            </div>
          `;
        }
      });
      
      html += '</div>';
      container.innerHTML = html;
      
      // æ»šåŠ¨åˆ°äº§å“åˆ—è¡¨
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // æ›´æ–°è®¾å¤‡é€‰æ‹©ï¼ˆåºåˆ—å·ï¼‰
    function updateDeviceSelection(productId, productName, price, serialNumber, isChecked) {
      console.log(`[updateDeviceSelection] productId=${productId}, serialNumber=${serialNumber}, isChecked=${isChecked}`);
      console.log(`[updateDeviceSelection] å½“å‰ selectedProducts.length=${selectedProducts.length}`);
      
      if (isChecked) {
        // æ·»åŠ é€‰æ‹©
        selectedProducts.push({
          productId,
          productName,
          quantity: 1,
          price,
          serialNumbers: [serialNumber],
          code: serialNumber // ä½¿ç”¨åºåˆ—å·ä½œä¸ºCode
        });
        console.log(`[updateDeviceSelection] æ·»åŠ å selectedProducts.length=${selectedProducts.length}`);
      } else {
        // ç§»é™¤é€‰æ‹©
        selectedProducts = selectedProducts.filter(p => 
          !(p.productId === productId && p.serialNumbers && p.serialNumbers.includes(serialNumber))
        );
        console.log(`[updateDeviceSelection] ç§»é™¤å selectedProducts.length=${selectedProducts.length}`);
      }
      
      updateSelectedCount();
    }
    
    // æ›´æ–°é…ä»¶é€‰æ‹©ï¼ˆæ•°é‡ï¼‰
    function updateAccessorySelection(productId, productName, price, maxQty, barcode) {
      const qty = parseInt(document.getElementById(`qty_${productId}`).value) || 0;
      
      // ç§»é™¤æ—§çš„é€‰æ‹©
      selectedProducts = selectedProducts.filter(p => p.productId !== productId);
      
      // æ·»åŠ æ–°çš„é€‰æ‹©
      if (qty > 0 && qty <= maxQty) {
        selectedProducts.push({
          productId,
          productName,
          quantity: qty,
          price,
          code: barcode || '' // ä½¿ç”¨barcodeä½œä¸ºCode
        });
      }
      
      updateSelectedCount();
    }
    
    // æ›´æ–°å·²é€‰æ‹©æ•°é‡æ˜¾ç¤º
    function updateSelectedCount() {
      const countElement = document.getElementById('selectedCount');
      if (countElement) {
        const totalQty = selectedProducts.reduce((sum, p) => sum + p.quantity, 0);
        countElement.textContent = `${totalQty} ä»¶`;
      }
    }
    
    // ç¡®è®¤é”€å”®
    async function confirmSale() {
      console.log(`[confirmSale] selectedProducts.length=${selectedProducts.length}`);
      console.log(`[confirmSale] selectedProducts=`, JSON.stringify(selectedProducts, null, 2));
      
      if (selectedProducts.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªäº§å“');
        return;
      }
      
      debugLog(`ç¡®è®¤é”€å”®: ${selectedProducts.length} ä¸ªäº§å“`);
      
      try {
        const response = await fetch(`${API_BASE}/sales-invoices`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            customerId: currentSaleCustomer.id,
            items: selectedProducts,
            notes: ''
          })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          closeUniversalModal();
          alert(`âœ… Sales invoice created successfully!\nInvoice Number: ${result.data.invoiceNumber}`);
          
          // è¯¢é—®æ˜¯å¦ä¸‹è½½å‘ç¥¨
          if (confirm('Download sales invoice PDF?')) {
            downloadSalesInvoice(result.data._id);
          }
          
          // åˆ·æ–°å®¢æˆ·åˆ—è¡¨
          loadCustomers();
        } else {
          throw new Error(result.error || 'åˆ›å»ºé”€å”®å‘ç¥¨å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ åˆ›å»ºé”€å”®å‘ç¥¨å¤±è´¥: ${error.message}`);
        alert(`âŒ åˆ›å»ºé”€å”®å‘ç¥¨å¤±è´¥: ${error.message}`);
      }
    }
    
    // ä¸‹è½½é”€å”®å‘ç¥¨PDF
    async function downloadSalesInvoice(invoiceId) {
      try {
        // è·å–å‘ç¥¨è¯¦æƒ…
        const response = await fetch(`${API_BASE}/sales-invoices/${invoiceId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          generateInvoicePDF(result.data);
        } else {
          throw new Error('è·å–å‘ç¥¨è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ ä¸‹è½½å‘ç¥¨å¤±è´¥: ${error.message}`);
        alert(`âŒ ä¸‹è½½å‘ç¥¨å¤±è´¥: ${error.message}`);
      }
    }
    
    // ç”Ÿæˆå‘ç¥¨PDFï¼ˆç®€åŒ–ç‰ˆï¼Œä½¿ç”¨window.printï¼‰
    function generateInvoicePDF(invoice) {
      const companyInfo = invoice.companyInfo || {};
      const customer = invoice.customer || {};
      
      // åˆ›å»ºæ‰“å°çª—å£
      const printWindow = window.open('', '_blank');
      
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Sales Invoice - ${invoice.invoiceNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; }
            .header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
            .company-info { flex: 1; }
            .invoice-info { text-align: right; }
            .section-title { font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 14px; color: #666; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
            th { background-color: #f8f9fa; font-weight: bold; }
            .text-right { text-align: right; }
            .total-section { margin-top: 30px; float: right; width: 300px; }
            .total-row { display: flex; justify-content: space-between; padding: 8px 0; }
            .total-row.final { border-top: 2px solid #333; font-weight: bold; font-size: 18px; margin-top: 10px; padding-top: 10px; }
            @media print {
              body { padding: 20px; }
              button { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="company-info">
              <h1 style="margin: 0 0 10px 0;">${companyInfo.companyName || 'Company Name'}</h1>
              <div>${companyInfo.address?.street || ''}</div>
              <div>${companyInfo.address?.city || ''} ${companyInfo.address?.postalCode || ''}</div>
              <div>${companyInfo.address?.country || 'Ireland'}</div>
              <div style="margin-top: 10px;">
                <div>Phone: ${companyInfo.contact?.phone || ''}</div>
                <div>Email: ${companyInfo.contact?.email || ''}</div>
                <div>VAT Number: ${companyInfo.taxNumber || ''}</div>
              </div>
            </div>
            <div class="invoice-info">
              <h2 style="margin: 0 0 10px 0;">SALES INVOICE</h2>
              <div><strong>Invoice Number:</strong> ${invoice.invoiceNumber}</div>
              <div><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString('en-IE')}</div>
              <div><strong>Status:</strong> ${invoice.status === 'confirmed' ? 'Confirmed' : invoice.status}</div>
            </div>
          </div>
          
          <div class="section-title">BILL TO</div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <div><strong>${customer.name || ''}</strong></div>
            <div>${customer.contact?.person ? 'Contact: ' + customer.contact.person : ''}</div>
            <div>${customer.contact?.phone ? 'Phone: ' + customer.contact.phone : ''}</div>
            <div>${customer.contact?.email ? 'Email: ' + customer.contact.email : ''}</div>
            <div>${customer.taxNumber ? 'VAT Number: ' + customer.taxNumber : ''}</div>
          </div>
          
          <div class="section-title">ITEMS</div>
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th>Condition</th>
                <th>Code</th>
                <th class="text-right">Quantity</th>
                <th class="text-right">Unit Price (Incl. VAT)</th>
                <th class="text-right">Total Price (Incl. VAT)</th>
                <th>VAT Rate</th>
              </tr>
            </thead>
            <tbody>
              ${invoice.items.map(item => {
                // ç¡®å®šCodeï¼šä¼˜å…ˆä½¿ç”¨åºåˆ—å·ï¼Œå¦åˆ™ä½¿ç”¨barcode
                const code = item.serialNumbers && item.serialNumbers.length > 0 
                  ? item.serialNumbers.join(', ') 
                  : (item.barcode || item.code || 'N/A');
                
                // æ ¼å¼åŒ–VAT Rate
                const vatRateFormatted = formatVatRate(item.vatRate);
                
                return `
                  <tr>
                    <td>${item.description || item.product?.name || ''}</td>
                    <td>${item.condition || 'N/A'}</td>
                    <td>${code}</td>
                    <td class="text-right">${item.quantity}</td>
                    <td class="text-right">â‚¬${item.unitPriceIncludingTax.toFixed(2)}</td>
                    <td class="text-right">â‚¬${item.totalPriceIncludingTax.toFixed(2)}</td>
                    <td>${vatRateFormatted}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          
          <div class="total-section">
            <div class="total-row">
              <span>Subtotal (Excl. VAT):</span>
              <span>â‚¬${invoice.subtotal.toFixed(2)}</span>
            </div>
            <div class="total-row">
              <span>VAT Amount:</span>
              <span>â‚¬${invoice.taxAmount.toFixed(2)}</span>
            </div>
            <div class="total-row final">
              <span>Total Amount (Incl. VAT):</span>
              <span>â‚¬${invoice.totalAmount.toFixed(2)}</span>
            </div>
          </div>
          
          <div style="clear: both; margin-top: 80px; padding-top: 20px; border-top: 1px solid #ddd;">
            <div class="section-title">PAYMENT INFORMATION</div>
            <div>IBAN: ${companyInfo.bankDetails?.iban || ''}</div>
            <div>BIC: ${companyInfo.bankDetails?.bic || ''}</div>
            <div>Bank: ${companyInfo.bankDetails?.bankName || ''}</div>
          </div>
          
          <div style="margin-top: 40px; text-align: center;">
            <button onclick="window.print()" style="padding: 10px 30px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ğŸ–¨ï¸ Print Invoice
            </button>
            <button onclick="window.close()" style="padding: 10px 30px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">
              Close
            </button>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(html);
      printWindow.document.close();
    }
    
    // ==================== å…¬å¸ä¿¡æ¯ç®¡ç† ====================
    
    // æ˜¾ç¤ºå…¬å¸ä¿¡æ¯è®¾ç½®æ¨¡æ€æ¡†
    async function showCompanyInfoModal() {
      debugLog('æ˜¾ç¤ºå…¬å¸ä¿¡æ¯è®¾ç½®');
      
      try {
        // è·å–ç°æœ‰å…¬å¸ä¿¡æ¯
        const response = await fetch(`${API_BASE}/company-info`);
        const result = await response.json();
        
        const companyInfo = result.data || {};
        
        const title = 'ğŸ¢ å…¬å¸ä¿¡æ¯è®¾ç½®';
        const content = `
          <div style="max-width: 800px;">
            <form id="companyInfoForm" onsubmit="saveCompanyInfo(event)">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¬å¸åç§° *</label>
                  <input type="text" name="companyName" value="${companyInfo.companyName || ''}" required
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¡—é“åœ°å€</label>
                  <input type="text" name="address.street" value="${companyInfo.address?.street || ''}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">åŸå¸‚</label>
                  <input type="text" name="address.city" value="${companyInfo.address?.city || ''}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">é‚®ç¼–</label>
                  <input type="text" name="address.postalCode" value="${companyInfo.address?.postalCode || ''}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">å›½å®¶</label>
                  <input type="text" name="address.country" value="${companyInfo.address?.country || 'Ireland'}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç”µè¯</label>
                  <input type="text" name="contact.phone" value="${companyInfo.contact?.phone || ''}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">é‚®ç®±</label>
                  <input type="email" name="contact.email" value="${companyInfo.contact?.email || ''}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç¨å·</label>
                  <input type="text" name="taxNumber" value="${companyInfo.taxNumber || ''}"
                         style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                </div>
                
                <div style="grid-column: 1 / -1; background: #f8fafc; padding: 15px; border-radius: 8px;">
                  <h4 style="margin: 0 0 15px 0;">ğŸ’³ é“¶è¡Œä¿¡æ¯</h4>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">IBAN</label>
                      <input type="text" name="bankDetails.iban" value="${companyInfo.bankDetails?.iban || ''}"
                             style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                    </div>
                    
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">BIC/SWIFT</label>
                      <input type="text" name="bankDetails.bic" value="${companyInfo.bankDetails?.bic || ''}"
                             style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                    </div>
                    
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">é“¶è¡Œåç§°</label>
                      <input type="text" name="bankDetails.bankName" value="${companyInfo.bankDetails?.bankName || ''}"
                             style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                    </div>
                    
                    <div>
                      <label style="display: block; margin-bottom: 5px; font-weight: bold;">è´¦æˆ·åç§°</label>
                      <input type="text" name="bankDetails.accountName" value="${companyInfo.bankDetails?.accountName || ''}"
                             style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                    </div>
                  </div>
                </div>
              </div>
              
              <div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" onclick="closeUniversalModal()" class="btn" style="background: #f3f4f6;">
                  å–æ¶ˆ
                </button>
                <button type="submit" class="btn btn-primary">
                  ğŸ’¾ ä¿å­˜
                </button>
              </div>
            </form>
          </div>
        `;
        
        showUniversalModal(title, content);
      } catch (error) {
        debugLog(`âŒ è·å–å…¬å¸ä¿¡æ¯å¤±è´¥: ${error.message}`);
        alert(`âŒ è·å–å…¬å¸ä¿¡æ¯å¤±è´¥: ${error.message}`);
      }
    }
    
    // ä¿å­˜å…¬å¸ä¿¡æ¯
    async function saveCompanyInfo(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      // æ„å»ºåµŒå¥—å¯¹è±¡
      const data = {
        companyName: formData.get('companyName'),
        address: {
          street: formData.get('address.street'),
          city: formData.get('address.city'),
          postalCode: formData.get('address.postalCode'),
          country: formData.get('address.country')
        },
        contact: {
          phone: formData.get('contact.phone'),
          email: formData.get('contact.email')
        },
        taxNumber: formData.get('taxNumber'),
        bankDetails: {
          iban: formData.get('bankDetails.iban'),
          bic: formData.get('bankDetails.bic'),
          bankName: formData.get('bankDetails.bankName'),
          accountName: formData.get('bankDetails.accountName')
        }
      };
      
      try {
        const response = await fetch(`${API_BASE}/company-info`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å…¬å¸ä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
          closeUniversalModal();
        } else {
          throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ ä¿å­˜å…¬å¸ä¿¡æ¯å¤±è´¥: ${error.message}`);
        alert(`âŒ ä¿å­˜å…¬å¸ä¿¡æ¯å¤±è´¥: ${error.message}`);
      }
    }

    // ==================== ä»“åº“è®¢å•ç®¡ç† ====================
    
    // åŠ è½½ä»“åº“è®¢å•åˆ—è¡¨
    async function loadWarehouseOrders() {
      debugLog('å¼€å§‹åŠ è½½ä»“åº“è®¢å•åˆ—è¡¨');
      const container = document.getElementById('warehouseOrdersList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        // è·å–ç­›é€‰æ¡ä»¶
        const status = document.getElementById('warehouseOrderStatusFilter').value;
        const merchantFilter = document.getElementById('warehouseOrderMerchantFilter').value;
        
        // æ„å»ºæŸ¥è¯¢å‚æ•°
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (merchantFilter) params.append('merchantId', merchantFilter);
        
        const response = await fetch(`/api/warehouse/orders?${params.toString()}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`è®¢å•APIå“åº”: ${result.data?.length || 0} ä¸ªè®¢å•`);
        
        if (result.success && result.data && result.data.length > 0) {
          renderWarehouseOrders(result.data);
          debugLog('âœ… è®¢å•åˆ—è¡¨åŠ è½½æˆåŠŸ');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“¦</div>
              <h3>æš‚æ— è®¢å•</h3>
              <p>è¿˜æ²¡æœ‰å•†æˆ·ä¸‹å•</p>
            </div>
          `;
          debugLog('âš ï¸ æ²¡æœ‰è®¢å•æ•°æ®');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        debugLog(`âŒ è®¢å•åˆ—è¡¨åŠ è½½å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ¸²æŸ“è®¢å•åˆ—è¡¨
    function renderWarehouseOrders(orders) {
      const container = document.getElementById('warehouseOrdersList');
      
      const statusBadges = {
        'pending': '<span class="status-badge" style="background: #fef3c7; color: #92400e;">å¾…ç¡®è®¤</span>',
        'confirmed': '<span class="status-badge" style="background: #dbeafe; color: #1e40af;">å·²ç¡®è®¤</span>',
        'shipped': '<span class="status-badge" style="background: #e0e7ff; color: #4338ca;">å·²å‘è´§</span>',
        'completed': '<span class="status-badge" style="background: #d1fae5; color: #065f46;">å·²å®Œæˆ</span>',
        'cancelled': '<span class="status-badge" style="background: #fee2e2; color: #991b1b;">å·²å–æ¶ˆ</span>'
      };
      
      const deliveryMethods = {
        'delivery': 'ğŸšš ç‰©æµé…é€',
        'pickup': 'ğŸª åˆ°åº—è‡ªå–'
      };
      
      const html = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f9fafb;">
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">è®¢å•å·</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">å•†æˆ·</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">ä¸‹å•æ—¶é—´</th>
              <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">æ€»é‡‘é¢</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">é…é€æ–¹å¼</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">çŠ¶æ€</th>
              <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${orders.map(order => `
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px; font-weight: 600;">${order.orderNumber}</td>
                <td style="padding: 12px;">${order.merchantId}</td>
                <td style="padding: 12px;">${new Date(order.orderedAt).toLocaleString('zh-CN')}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">â‚¬${order.totalAmount.toFixed(2)}</td>
                <td style="padding: 12px;">${deliveryMethods[order.deliveryMethod] || order.deliveryMethod}</td>
                <td style="padding: 12px;">${statusBadges[order.status] || order.status}</td>
                <td style="padding: 12px; text-align: center;">
                  <button onclick="viewWarehouseOrderDetail('${order._id}')" style="padding: 6px 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">
                    æŸ¥çœ‹è¯¦æƒ…
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }
    
    // æŸ¥çœ‹è®¢å•è¯¦æƒ…
    async function viewWarehouseOrderDetail(orderId) {
      debugLog(`æŸ¥çœ‹è®¢å•è¯¦æƒ…: ${orderId}`);
      
      try {
        const response = await fetch(`/api/warehouse/orders/${orderId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success && result.data) {
          renderWarehouseOrderDetail(result.data);
          document.getElementById('warehouseOrderDetailModal').style.display = 'flex';
        } else {
          throw new Error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ è·å–è®¢å•è¯¦æƒ…å¤±è´¥: ${error.message}`);
        alert(`âŒ è·å–è®¢å•è¯¦æƒ…å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ¸²æŸ“è®¢å•è¯¦æƒ…
    function renderWarehouseOrderDetail(order) {
      const container = document.getElementById('warehouseOrderDetailContent');
      
      const statusBadges = {
        'pending': '<span class="status-badge" style="background: #fef3c7; color: #92400e;">å¾…ç¡®è®¤</span>',
        'confirmed': '<span class="status-badge" style="background: #dbeafe; color: #1e40af;">å·²ç¡®è®¤</span>',
        'shipped': '<span class="status-badge" style="background: #e0e7ff; color: #4338ca;">å·²å‘è´§</span>',
        'completed': '<span class="status-badge" style="background: #d1fae5; color: #065f46;">å·²å®Œæˆ</span>',
        'cancelled': '<span class="status-badge" style="background: #fee2e2; color: #991b1b;">å·²å–æ¶ˆ</span>'
      };
      
      const deliveryMethods = {
        'delivery': 'ğŸšš ç‰©æµé…é€',
        'pickup': 'ğŸª åˆ°åº—è‡ªå–'
      };
      
      // æ„å»ºæ“ä½œæŒ‰é’®
      let actionButtons = '';
      if (order.status === 'pending') {
        actionButtons = `
          <button onclick="confirmWarehouseOrder('${order._id}')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            âœ… ç¡®è®¤è®¢å•
          </button>
          <button onclick="cancelWarehouseOrder('${order._id}')" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            âŒ å–æ¶ˆè®¢å•
          </button>
        `;
      } else if (order.status === 'confirmed') {
        actionButtons = `
          <button onclick="shipWarehouseOrder('${order._id}')" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            ğŸšš æ ‡è®°å‘è´§
          </button>
          <button onclick="cancelWarehouseOrder('${order._id}')" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            âŒ å–æ¶ˆè®¢å•
          </button>
        `;
      } else if (order.status === 'shipped') {
        actionButtons = `
          <button onclick="completeWarehouseOrder('${order._id}')" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            âœ… å®Œæˆè®¢å•
          </button>
        `;
      }
      
      const html = `
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">è®¢å•å·</div>
              <div style="font-weight: 600; font-size: 16px;">${order.orderNumber}</div>
            </div>
            <div>
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">å•†æˆ·</div>
              <div style="font-weight: 600; font-size: 16px;">${order.merchantName || order.merchantId}</div>
            </div>
            <div>
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">ä¸‹å•æ—¶é—´</div>
              <div style="font-weight: 600;">${new Date(order.orderedAt).toLocaleString('zh-CN')}</div>
            </div>
            <div>
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">é…é€æ–¹å¼</div>
              <div style="font-weight: 600;">${deliveryMethods[order.deliveryMethod] || order.deliveryMethod}</div>
            </div>
            ${order.deliveryAddress ? `
              <div style="grid-column: 1 / -1;">
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">é…é€åœ°å€</div>
                <div style="font-weight: 600;">${order.deliveryAddress}</div>
              </div>
            ` : ''}
            ${order.pickupLocation ? `
              <div style="grid-column: 1 / -1;">
                <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">è‡ªå–åœ°ç‚¹</div>
                <div style="font-weight: 600;">${order.pickupLocation}</div>
              </div>
            ` : ''}
            <div>
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">è®¢å•çŠ¶æ€</div>
              <div>${statusBadges[order.status] || order.status}</div>
            </div>
            <div>
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">æ€»é‡‘é¢</div>
              <div style="font-weight: 700; font-size: 18px; color: #6366f1;">â‚¬${order.totalAmount.toFixed(2)}</div>
            </div>
          </div>
          ${order.notes ? `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
              <div style="color: #6b7280; font-size: 14px; margin-bottom: 5px;">å¤‡æ³¨</div>
              <div>${order.notes}</div>
            </div>
          ` : ''}
        </div>
        
        <h3 style="margin-bottom: 15px;">è®¢å•äº§å“</h3>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background: #f9fafb;">
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">äº§å“åç§°</th>
              <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">å˜ä½“ä¿¡æ¯</th>
              <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">æ•°é‡</th>
              <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">æ‰¹å‘ä»·</th>
              <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">å°è®¡</th>
            </tr>
          </thead>
          <tbody>
            ${order.items.map(item => {
              // æ„å»ºå˜ä½“ä¿¡æ¯æ˜¾ç¤º
              let variantBadges = [];
              if (item.model) {
                variantBadges.push(`<span style="background: #dbeafe; color: #1e40af; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 4px; display: inline-block; margin-bottom: 4px;">å‹å·: ${item.model}</span>`);
              }
              if (item.color) {
                variantBadges.push(`<span style="background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 4px; display: inline-block; margin-bottom: 4px;">é¢œè‰²: ${item.color}</span>`);
              }
              if (item.condition) {
                variantBadges.push(`<span style="background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 4px; font-size: 12px; display: inline-block; margin-bottom: 4px;">æˆè‰²: ${item.condition}</span>`);
              }
              
              const variantDisplay = variantBadges.length > 0 
                ? variantBadges.join('')
                : '<span style="color: #9ca3af; font-size: 12px;">-</span>';
              
              return `
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;">
                  <div style="font-weight: 600;">${item.productName}</div>
                  ${item.brand ? `<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">å“ç‰Œ: ${item.brand}</div>` : ''}
                </td>
                <td style="padding: 12px;">
                  ${variantDisplay}
                </td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">${item.quantity}</td>
                <td style="padding: 12px; text-align: right;">â‚¬${item.wholesalePrice.toFixed(2)}</td>
                <td style="padding: 12px; text-align: right; font-weight: 600;">â‚¬${item.subtotal.toFixed(2)}</td>
              </tr>
            `}).join('')}
          </tbody>
          <tfoot>
            <tr style="background: #f9fafb; font-weight: 700;">
              <td colspan="4" style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb;">æ€»è®¡:</td>
              <td style="padding: 12px; text-align: right; border-top: 2px solid #e5e7eb; color: #6366f1; font-size: 18px;">â‚¬${order.totalAmount.toFixed(2)}</td>
            </tr>
          </tfoot>
        </table>
        
        ${order.confirmedAt ? `
          <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 5px;">âœ… ç¡®è®¤ä¿¡æ¯</div>
            <div style="font-size: 14px;">ç¡®è®¤æ—¶é—´: ${new Date(order.confirmedAt).toLocaleString('zh-CN')}</div>
            ${order.confirmedBy ? `<div style="font-size: 14px;">ç¡®è®¤äºº: ${order.confirmedBy}</div>` : ''}
          </div>
        ` : ''}
        
        ${order.shippedAt ? `
          <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 5px;">ğŸšš å‘è´§ä¿¡æ¯</div>
            <div style="font-size: 14px;">å‘è´§æ—¶é—´: ${new Date(order.shippedAt).toLocaleString('zh-CN')}</div>
            ${order.shippedBy ? `<div style="font-size: 14px;">å‘è´§äºº: ${order.shippedBy}</div>` : ''}
          </div>
        ` : ''}
        
        ${order.completedAt ? `
          <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 5px;">âœ… å®Œæˆä¿¡æ¯</div>
            <div style="font-size: 14px;">å®Œæˆæ—¶é—´: ${new Date(order.completedAt).toLocaleString('zh-CN')}</div>
          </div>
        ` : ''}
        
        <div style="display: flex; gap: 10px; justify-content: space-between; margin-top: 20px;">
          <div>
            <button onclick="downloadWarehouseOrderPDF('${order._id}')" style="padding: 10px 20px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              ğŸ“„ ä¸‹è½½ PDF
            </button>
          </div>
          <div style="display: flex; gap: 10px;">
            ${actionButtons}
            <button onclick="closeWarehouseOrderDetail()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              å…³é—­
            </button>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // ä¸‹è½½ä»“åº“è®¢å• PDF
    async function downloadWarehouseOrderPDF(orderId) {
      try {
        debugLog(`ä¸‹è½½è®¢å• PDF: ${orderId}`);
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 10001; font-size: 16px;';
        loadingMsg.textContent = 'æ­£åœ¨ç”Ÿæˆ PDF...';
        document.body.appendChild(loadingMsg);
        
        const response = await fetch(`/api/warehouse/orders/${orderId}/pdf`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `warehouse-order-${orderId}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        document.body.removeChild(loadingMsg);
        
        debugLog('âœ… PDF ä¸‹è½½æˆåŠŸ');
      } catch (error) {
        debugLog(`âŒ ä¸‹è½½ PDF å¤±è´¥: ${error.message}`);
        alert(`ä¸‹è½½ PDF å¤±è´¥: ${error.message}`);
      }
    }
    
    // ä¸‹è½½é”€å”®å‘ç¥¨ PDF
    async function downloadSalesInvoicePDF(invoiceId, invoiceNumber) {
      try {
        debugLog(`ä¸‹è½½é”€å”®å‘ç¥¨ PDF: ${invoiceId}`);
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 10001; font-size: 16px;';
        loadingMsg.textContent = 'Generating PDF...';
        document.body.appendChild(loadingMsg);
        
        // å¹¶è¡Œè·å–å‘ç¥¨è¯¦æƒ…å’Œå…¬å¸ä¿¡æ¯
        const [invoiceResponse, companyResponse] = await Promise.all([
          fetch(`${API_BASE}/sales-invoices/${invoiceId}`),
          fetch(`${API_BASE}/company-info`)
        ]);
        
        if (!invoiceResponse.ok) throw new Error(`HTTP ${invoiceResponse.status}`);
        if (!companyResponse.ok) throw new Error(`Failed to get company info`);
        
        const invoiceResult = await invoiceResponse.json();
        const companyResult = await companyResponse.json();
        
        if (!invoiceResult.success || !invoiceResult.data) {
          throw new Error('Failed to get invoice details');
        }
        
        const invoice = invoiceResult.data;
        const companyInfo = companyResult.success && companyResult.data ? companyResult.data : null;
        
        // ä½¿ç”¨jsPDFç”ŸæˆPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let yPos = 20;
        const leftMargin = 20;
        const rightMargin = 190;
        
        // æ ‡é¢˜
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text('SALES INVOICE', 105, yPos, { align: 'center' });
        yPos += 10;
        
        doc.setFontSize(14);
        doc.text(invoice.invoiceNumber || invoiceNumber, 105, yPos, { align: 'center' });
        yPos += 15;
        
        // åŒæ–¹å…¬å¸ä¿¡æ¯ - å·¦å³å¸ƒå±€
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('FROM:', leftMargin, yPos);
        doc.text('TO:', 110, yPos);
        yPos += 6;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        // å·¦ä¾§ï¼šå–æ–¹å…¬å¸ä¿¡æ¯
        let leftYPos = yPos;
        if (companyInfo) {
          doc.setFont(undefined, 'bold');
          doc.text(companyInfo.companyName || 'N/A', leftMargin, leftYPos);
          leftYPos += 5;
          doc.setFont(undefined, 'normal');
          
          if (companyInfo.address) {
            if (companyInfo.address.street) {
              doc.text(companyInfo.address.street, leftMargin, leftYPos);
              leftYPos += 4;
            }
            const cityLine = [
              companyInfo.address.city,
              companyInfo.address.state,
              companyInfo.address.postalCode
            ].filter(Boolean).join(', ');
            if (cityLine) {
              doc.text(cityLine, leftMargin, leftYPos);
              leftYPos += 4;
            }
            if (companyInfo.address.country) {
              doc.text(companyInfo.address.country, leftMargin, leftYPos);
              leftYPos += 4;
            }
          }
          
          if (companyInfo.taxNumber) {
            doc.text(`VAT: ${companyInfo.taxNumber}`, leftMargin, leftYPos);
            leftYPos += 4;
          }
          
          if (companyInfo.contact?.phone) {
            doc.text(`Tel: ${companyInfo.contact.phone}`, leftMargin, leftYPos);
            leftYPos += 4;
          }
          
          if (companyInfo.contact?.email) {
            doc.text(`Email: ${companyInfo.contact.email}`, leftMargin, leftYPos);
            leftYPos += 4;
          }
        } else {
          doc.text('Company information not available', leftMargin, leftYPos);
          leftYPos += 5;
        }
        
        // å³ä¾§ï¼šä¹°æ–¹å…¬å¸ä¿¡æ¯
        let rightYPos = yPos;
        if (invoice.customer) {
          doc.setFont(undefined, 'bold');
          doc.text(invoice.customer.companyName || invoice.customer.name || 'N/A', 110, rightYPos);
          rightYPos += 5;
          doc.setFont(undefined, 'normal');
          
          if (invoice.customer.address) {
            if (typeof invoice.customer.address === 'string') {
              const lines = doc.splitTextToSize(invoice.customer.address, 80);
              lines.forEach(line => {
                doc.text(line, 110, rightYPos);
                rightYPos += 4;
              });
            } else {
              if (invoice.customer.address.street) {
                doc.text(invoice.customer.address.street, 110, rightYPos);
                rightYPos += 4;
              }
              const cityLine = [
                invoice.customer.address.city,
                invoice.customer.address.state,
                invoice.customer.address.postalCode
              ].filter(Boolean).join(', ');
              if (cityLine) {
                doc.text(cityLine, 110, rightYPos);
                rightYPos += 4;
              }
              if (invoice.customer.address.country) {
                doc.text(invoice.customer.address.country, 110, rightYPos);
                rightYPos += 4;
              }
            }
          }
          
          if (invoice.customer.taxNumber || invoice.customer.vatNumber) {
            doc.text(`VAT: ${invoice.customer.taxNumber || invoice.customer.vatNumber}`, 110, rightYPos);
            rightYPos += 4;
          }
        } else {
          doc.text('Customer information not available', 110, rightYPos);
          rightYPos += 5;
        }
        
        yPos = Math.max(leftYPos, rightYPos) + 10;
        
        // å‘ç¥¨ä¿¡æ¯
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Invoice Date: ${new Date(invoice.date || invoice.createdAt).toLocaleDateString('en-IE')}`, leftMargin, yPos);
        yPos += 5;
        doc.text(`Payment Method: ${invoice.paymentMethod || 'N/A'}`, leftMargin, yPos);
        yPos += 10;
        
        // äº§å“æ˜ç»†è¡¨å¤´
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(240, 240, 240);
        doc.rect(leftMargin, yPos - 4, 170, 7, 'F');
        doc.text('Product', leftMargin + 2, yPos);
        doc.text('Qty', 120, yPos, { align: 'center' });
        doc.text('Price', 145, yPos, { align: 'right' });
        doc.text('Total', rightMargin - 2, yPos, { align: 'right' });
        yPos += 7;
        
        doc.setFont(undefined, 'normal');
        
        // äº§å“åˆ—è¡¨
        (invoice.items || []).forEach(item => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          
          const productName = item.productName || item.name || 'Unknown';
          const productLines = doc.splitTextToSize(productName, 100);
          
          productLines.forEach((line, index) => {
            doc.text(line, leftMargin + 2, yPos);
            if (index === 0) {
              doc.text(String(item.quantity || 1), 120, yPos, { align: 'center' });
              doc.text(`â‚¬${(item.price || 0).toFixed(2)}`, 145, yPos, { align: 'right' });
              doc.text(`â‚¬${((item.quantity || 1) * (item.price || 0)).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
            }
            yPos += 5;
          });
        });
        
        yPos += 5;
        
        // åˆ†éš”çº¿
        doc.setDrawColor(200, 200, 200);
        doc.line(leftMargin, yPos, rightMargin, yPos);
        yPos += 7;
        
        // æ€»è®¡
        doc.setFont(undefined, 'normal');
        doc.text('Subtotal:', 145, yPos, { align: 'right' });
        doc.text(`â‚¬${(invoice.subtotal || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
        yPos += 6;
        
        doc.text('VAT:', 145, yPos, { align: 'right' });
        doc.text(`â‚¬${(invoice.taxAmount || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
        yPos += 8;
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(12);
        doc.text('Total:', 145, yPos, { align: 'right' });
        doc.text(`â‚¬${(invoice.totalAmount || 0).toFixed(2)}`, rightMargin - 2, yPos, { align: 'right' });
        
        // é“¶è¡Œä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        if (companyInfo && companyInfo.bankDetails && companyInfo.bankDetails.iban) {
          yPos += 15;
          doc.setFontSize(10);
          doc.setFont(undefined, 'bold');
          doc.text('Bank Details:', leftMargin, yPos);
          yPos += 5;
          doc.setFont(undefined, 'normal');
          doc.text(`IBAN: ${companyInfo.bankDetails.iban}`, leftMargin, yPos);
          yPos += 4;
          if (companyInfo.bankDetails.bic) {
            doc.text(`BIC: ${companyInfo.bankDetails.bic}`, leftMargin, yPos);
            yPos += 4;
          }
          if (companyInfo.bankDetails.bankName) {
            doc.text(`Bank: ${companyInfo.bankDetails.bankName}`, leftMargin, yPos);
          }
        }
        
        // ä¿å­˜PDF
        doc.save(`sales-invoice-${invoiceNumber || invoiceId}.pdf`);
        
        document.body.removeChild(loadingMsg);
        debugLog('âœ… PDF generated successfully');
        
      } catch (error) {
        debugLog(`âŒ Failed to generate PDF: ${error.message}`);
        alert(`Failed to generate PDF: ${error.message}`);
        const loadingMsg = document.querySelector('div[style*="Generating PDF"]');
        if (loadingMsg && loadingMsg.parentNode) document.body.removeChild(loadingMsg);
      }
    }
    
    // ç¡®è®¤è®¢å•
    async function confirmWarehouseOrder(orderId) {
      if (!confirm('ç¡®è®¤æ­¤è®¢å•ï¼Ÿç¡®è®¤åå°†æ— æ³•ä¿®æ”¹è®¢å•å†…å®¹ã€‚')) {
        return;
      }
      
      debugLog(`ç¡®è®¤è®¢å•: ${orderId}`);
      
      try {
        const response = await fetch(`/api/warehouse/orders/${orderId}/confirm`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… è®¢å•ç¡®è®¤æˆåŠŸï¼');
          closeWarehouseOrderDetail();
          loadWarehouseOrders();
        } else {
          throw new Error(result.error || 'ç¡®è®¤è®¢å•å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ ç¡®è®¤è®¢å•å¤±è´¥: ${error.message}`);
        alert(`âŒ ç¡®è®¤è®¢å•å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ ‡è®°å‘è´§ - æ‰“å¼€å‘è´§å¯¹è¯æ¡†
    async function shipWarehouseOrder(orderId) {
      debugLog(`å‡†å¤‡å‘è´§: ${orderId}`);
      
      try {
        // è·å–è®¢å•è¯¦æƒ…
        const response = await fetch(`/api/warehouse/orders/${orderId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        if (!result.success || !result.data) {
          throw new Error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥');
        }
        
        const order = result.data;
        
        // æ‰“å¼€å‘è´§å¯¹è¯æ¡†
        await openShipmentDialog(order);
        
      } catch (error) {
        debugLog(`âŒ å‡†å¤‡å‘è´§å¤±è´¥: ${error.message}`);
        alert(`âŒ å‡†å¤‡å‘è´§å¤±è´¥: ${error.message}`);
      }
    }
    
    // æ‰“å¼€å‘è´§å¯¹è¯æ¡†
    async function openShipmentDialog(order) {
      const modal = document.getElementById('shipmentModal');
      const container = document.getElementById('shipmentItemsList');
      
      // ä¸ºæ¯ä¸ªè®¢å•é¡¹ç›®åŠ è½½å¯ç”¨çš„äº§å“
      let itemsHtml = '';
      
      for (let i = 0; i < order.items.length; i++) {
        const item = order.items[i];
        
        // ç¡®ä¿ productId æ˜¯å­—ç¬¦ä¸²ï¼Œå¤„ç†å„ç§æƒ…å†µ
        let productId;
        if (!item.productId) {
          debugLog(`âš ï¸  äº§å“ ${item.productName} æ²¡æœ‰ productIdï¼Œè·³è¿‡`);
          continue;
        } else if (typeof item.productId === 'object' && item.productId !== null) {
          productId = item.productId._id || item.productId.toString();
        } else {
          productId = item.productId.toString();
        }
        
        debugLog(`ğŸ” åŠ è½½äº§å“ ${item.productName} çš„å¯ç”¨åº“å­˜...`);
        debugLog(`ğŸ“¡ è¯·æ±‚: /api/warehouse/products/${productId}/available`);
        
        // è·å–è¯¥äº§å“çš„æ‰€æœ‰å¯ç”¨åº“å­˜ï¼ˆå¸¦ IMEI/SNï¼‰
        const productsResponse = await fetch(`/api/warehouse/products/${productId}/available`);
        const productsResult = await productsResponse.json();
        
        debugLog(`ğŸ“¦ API å“åº”:`, productsResult);
        
        const availableProducts = productsResult.success ? productsResult.data : [];
        debugLog(`ğŸ“Š å¯ç”¨äº§å“æ•°é‡: ${availableProducts.length}`);
        
        if (availableProducts.length > 0) {
          debugLog(`ğŸ“‹ ç¬¬ä¸€ä¸ªäº§å“:`, availableProducts[0]);
        }
        
        const isDevice = availableProducts.some(p => p.imei || p.serialNumber);
        debugLog(`ğŸ”§ æ˜¯å¦ä¸ºè®¾å¤‡: ${isDevice}`);
        
        itemsHtml += `
          <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 15px;" data-item-index="${i}">
            <h4 style="margin-bottom: 15px; color: #1f2937;">
              ${item.productName}
              <span style="color: #6b7280; font-size: 14px; font-weight: normal;">
                (è®¢è´­æ•°é‡: ${item.quantity})
              </span>
            </h4>
            
            ${isDevice ? `
              <!-- è®¾å¤‡ï¼šé€‰æ‹© IMEI/SN -->
              <div>
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">é€‰æ‹©è®¾å¤‡ (éœ€é€‰æ‹© ${item.quantity} å°):</label>
                <div id="deviceList_${i}" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; background: white;">
                  ${availableProducts.map(product => `
                    <label style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6; cursor: pointer; hover:background: #f9fafb;">
                      <input type="checkbox" 
                        name="device_${i}" 
                        value="${product._id}" 
                        data-imei="${product.imei || ''}"
                        data-sn="${product.serialNumber || ''}"
                        onchange="updateWarehouseDeviceSelection(${i}, ${item.quantity})"
                        style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937;">
                          ${product.imei ? `IMEI: ${product.imei}` : `SN: ${product.serialNumber}`}
                        </div>
                        <div style="font-size: 13px; color: #6b7280;">
                          ${product.brand || ''} ${product.model || ''} - ${product.color || ''} - ${product.condition || ''}
                        </div>
                      </div>
                    </label>
                  `).join('')}
                </div>
                <div id="deviceCount_${i}" style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                  å·²é€‰æ‹©: <span id="selectedCount_${i}">0</span> / ${item.quantity}
                </div>
              </div>
            ` : `
              <!-- é…ä»¶ï¼šå¡«å†™æ•°é‡ -->
              <div>
                <label style="display: block; margin-bottom: 10px; font-weight: 600;">å‘è´§æ•°é‡:</label>
                <input type="number" 
                  id="quantity_${i}" 
                  value="${item.quantity}" 
                  min="1" 
                  max="${item.quantity}"
                  style="width: 150px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                <span style="margin-left: 10px; color: #6b7280; font-size: 14px;">
                  (æœ€å¤š ${item.quantity} ä»¶)
                </span>
              </div>
            `}
            
            <input type="hidden" id="productId_${i}" value="${productId}">
            <input type="hidden" id="isDevice_${i}" value="${isDevice}">
          </div>
        `;
      }
      
      container.innerHTML = itemsHtml;
      
      // ä¿å­˜è®¢å•ä¿¡æ¯åˆ°å¯¹è¯æ¡†
      modal.dataset.orderId = order._id;
      modal.dataset.itemCount = order.items.length;
      
      // æ˜¾ç¤ºå¯¹è¯æ¡†
      modal.style.display = 'flex';
    }
    
    // æ›´æ–°ä»“åº“å‘è´§è®¾å¤‡é€‰æ‹©è®¡æ•°
    function updateWarehouseDeviceSelection(itemIndex, requiredCount) {
      const checkboxes = document.querySelectorAll(`input[name="device_${itemIndex}"]:checked`);
      const selectedCount = checkboxes.length;
      const countElement = document.getElementById(`selectedCount_${itemIndex}`);
      if (countElement) {
        countElement.textContent = selectedCount;
      }
      
      // å¦‚æœå·²é€‰å¤Ÿï¼Œç¦ç”¨å…¶ä»–å¤é€‰æ¡†
      const allCheckboxes = document.querySelectorAll(`input[name="device_${itemIndex}"]`);
      allCheckboxes.forEach(cb => {
        if (!cb.checked && selectedCount >= requiredCount) {
          cb.disabled = true;
          cb.parentElement.style.opacity = '0.5';
        } else {
          cb.disabled = false;
          cb.parentElement.style.opacity = '1';
        }
      });
    }
    
    // ç¡®è®¤å‘è´§
    async function confirmShipment() {
      const modal = document.getElementById('shipmentModal');
      const orderId = modal.dataset.orderId;
      const itemCount = parseInt(modal.dataset.itemCount);
      
      // æ”¶é›†å‘è´§ä¿¡æ¯
      const shipmentItems = [];
      
      for (let i = 0; i < itemCount; i++) {
        const productId = document.getElementById(`productId_${i}`).value;
        const isDevice = document.getElementById(`isDevice_${i}`).value === 'true';
        
        if (isDevice) {
          // è®¾å¤‡ï¼šæ”¶é›†é€‰ä¸­çš„ IMEI/SN
          const checkboxes = document.querySelectorAll(`input[name="device_${i}"]:checked`);
          const selectedProducts = Array.from(checkboxes).map(cb => cb.value);
          
          if (selectedProducts.length === 0) {
            alert('è¯·ä¸ºæ‰€æœ‰è®¾å¤‡é€‰æ‹© IMEI/SN');
            return;
          }
          
          shipmentItems.push({
            productId,
            isDevice: true,
            selectedProducts
          });
        } else {
          // é…ä»¶ï¼šè·å–æ•°é‡
          const quantity = parseInt(document.getElementById(`quantity_${i}`).value);
          
          if (!quantity || quantity < 1) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å‘è´§æ•°é‡');
            return;
          }
          
          shipmentItems.push({
            productId,
            isDevice: false,
            quantity
          });
        }
      }
      
      // å‘é€å‘è´§è¯·æ±‚
      try {
        const response = await fetch(`/api/warehouse/orders/${orderId}/ship`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ shipmentItems })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å‘è´§æˆåŠŸï¼åº“å­˜å·²è½¬ç§»åˆ°å•†æˆ·ã€‚');
          closeShipmentModal();
          closeWarehouseOrderDetail();
          loadWarehouseOrders();
        } else {
          throw new Error(result.error || 'å‘è´§å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ å‘è´§å¤±è´¥: ${error.message}`);
        alert(`âŒ å‘è´§å¤±è´¥: ${error.message}`);
      }
    }
    
    // å…³é—­å‘è´§å¯¹è¯æ¡†
    function closeShipmentModal() {
      document.getElementById('shipmentModal').style.display = 'none';
    }
    
    // å®Œæˆè®¢å•
    async function completeWarehouseOrder(orderId) {
      if (!confirm('ç¡®è®¤å®Œæˆæ­¤è®¢å•ï¼Ÿ')) {
        return;
      }
      
      debugLog(`å®Œæˆè®¢å•: ${orderId}`);
      
      try {
        const response = await fetch(`/api/warehouse/orders/${orderId}/complete`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… è®¢å•å·²å®Œæˆï¼');
          closeWarehouseOrderDetail();
          loadWarehouseOrders();
        } else {
          throw new Error(result.error || 'å®Œæˆè®¢å•å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ å®Œæˆè®¢å•å¤±è´¥: ${error.message}`);
        alert(`âŒ å®Œæˆè®¢å•å¤±è´¥: ${error.message}`);
      }
    }
    
    // å–æ¶ˆè®¢å•
    async function cancelWarehouseOrder(orderId) {
      const reason = prompt('è¯·è¾“å…¥å–æ¶ˆåŸå› ï¼š');
      if (!reason) {
        return;
      }
      
      debugLog(`å–æ¶ˆè®¢å•: ${orderId}, åŸå› : ${reason}`);
      
      try {
        const response = await fetch(`/api/warehouse/orders/${orderId}/cancel`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… è®¢å•å·²å–æ¶ˆï¼');
          closeWarehouseOrderDetail();
          loadWarehouseOrders();
        } else {
          throw new Error(result.error || 'å–æ¶ˆè®¢å•å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ å–æ¶ˆè®¢å•å¤±è´¥: ${error.message}`);
        alert(`âŒ å–æ¶ˆè®¢å•å¤±è´¥: ${error.message}`);
      }
    }
    
    // å…³é—­è®¢å•è¯¦æƒ…å¯¹è¯æ¡†
    function closeWarehouseOrderDetail() {
      document.getElementById('warehouseOrderDetailModal').style.display = 'none';
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      if (typeof AuthGuard !== 'undefined') {
        AuthGuard.logout();
      } else {
        window.location.href = '/login.html';
      }
    }

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('=== ä»“åº“ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ===');
      
      // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
      setTimeout(function() {
        loadAllData();
      }, 100);
    });

    // ==================== æ‰¹é‡åˆ›å»ºå˜ä½“åŠŸèƒ½ ====================
    
    // æ˜¾ç¤ºæ‰¹é‡åˆ›å»ºå˜ä½“æ¨¡æ€æ¡†
    async function showBatchCreateVariantsModal() {
      document.getElementById('batchVariantsModal').style.display = 'block';
      
      // å¡«å……åˆ†ç±»ä¸‹æ‹‰æ¡†
      const categorySelect = document.getElementById('batchCategory');
      categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
      
      try {
        const categories = await loadCategories();
        categories.forEach(cat => {
          const option = document.createElement('option');
          const categoryName = cat.name || cat.type || cat.category;
          option.value = categoryName;
          option.textContent = categoryName;
          categorySelect.appendChild(option);
        });
      } catch (error) {
        debugLog(`åŠ è½½åˆ†ç±»å¤±è´¥: ${error.message}`);
      }
      
      // å¡«å……ä¾›è´§å•†ä¸‹æ‹‰æ¡†
      const supplierSelect = document.getElementById('batchSupplier');
      supplierSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¾›è´§å•†</option>';
      
      try {
        const suppliers = await loadSuppliers();
        suppliers.forEach(supplier => {
          const option = document.createElement('option');
          option.value = supplier.name;
          option.textContent = supplier.name;
          supplierSelect.appendChild(option);
        });
      } catch (error) {
        debugLog(`åŠ è½½ä¾›è´§å•†å¤±è´¥: ${error.message}`);
      }
      
      // å¡«å……æˆè‰²ä¸‹æ‹‰æ¡†
      const conditionSelect = document.getElementById('batchCondition');
      conditionSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æˆè‰²</option>';
      
      try {
        const conditions = await loadConditions();
        conditions.forEach(cond => {
          const option = document.createElement('option');
          option.value = cond.code;
          option.textContent = cond.name;
          conditionSelect.appendChild(option);
        });
      } catch (error) {
        debugLog(`åŠ è½½æˆè‰²å¤±è´¥: ${error.message}`);
      }
      
      // é‡ç½®è¡¨å•
      document.getElementById('batchVariantsForm').reset();
      updateVariantPreview();
    }
    
    // å…³é—­æ‰¹é‡åˆ›å»ºå˜ä½“æ¨¡æ€æ¡†
    function closeBatchVariantsModal() {
      document.getElementById('batchVariantsModal').style.display = 'none';
    }
    
    // æ›´æ–°å˜ä½“é¢„è§ˆ
    function updateVariantPreview() {
      const dim1Values = document.getElementById('batchDimension1Values').value
        .split('\n')
        .map(v => v.trim())
        .filter(v => v);
      
      const dim2Values = document.getElementById('batchDimension2Values').value
        .split('\n')
        .map(v => v.trim())
        .filter(v => v);
      
      const previewText = document.getElementById('variantPreviewText');
      
      if (dim1Values.length === 0 || dim2Values.length === 0) {
        previewText.textContent = 'è¯·å¡«å†™ç»´åº¦é€‰é¡¹ä»¥æŸ¥çœ‹é¢„è§ˆ';
        previewText.style.color = '#718096';
        return;
      }
      
      const totalVariants = dim1Values.length * dim2Values.length;
      const dim1Label = document.getElementById('batchDimension1Label').value;
      const dim2Label = document.getElementById('batchDimension2Label').value;
      
      previewText.innerHTML = `
        <strong style="color: #9f7aea; font-size: 16px;">å°†åˆ›å»º ${totalVariants} ä¸ªå˜ä½“</strong><br>
        <span style="color: #4a5568;">${dim1Values.length} ä¸ª${dim1Label} Ã— ${dim2Values.length} ä¸ª${dim2Label}</span><br><br>
        <span style="color: #718096; font-size: 13px;">ç¤ºä¾‹å˜ä½“ï¼š</span><br>
        <span style="color: #2d3748; font-size: 13px;">
          â€¢ ${dim1Values[0]} - ${dim2Values[0]}<br>
          â€¢ ${dim1Values[0]} - ${dim2Values[1] || dim2Values[0]}<br>
          ${dim1Values.length > 1 ? `â€¢ ${dim1Values[1]} - ${dim2Values[0]}<br>` : ''}
          ${totalVariants > 3 ? `<span style="color: #a0aec0;">... è¿˜æœ‰ ${totalVariants - 3} ä¸ªå˜ä½“</span>` : ''}
        </span>
      `;
    }
    
    // æ‰¹é‡åˆ›å»ºå˜ä½“
    async function createBatchVariants(event) {
      event.preventDefault();
      
      // è·å–è¡¨å•æ•°æ®
      const productName = document.getElementById('batchProductName').value.trim();
      const brand = document.getElementById('batchBrand').value.trim() || 'Generic';
      const category = document.getElementById('batchCategory').value;
      const invoiceNumber = document.getElementById('batchInvoiceNumber').value.trim();
      const supplier = document.getElementById('batchSupplier').value;
      const location = document.getElementById('batchLocation').value.trim();
      
      const dimension1Label = document.getElementById('batchDimension1Label').value;
      const dimension1Values = document.getElementById('batchDimension1Values').value
        .split('\n')
        .map(v => v.trim())
        .filter(v => v);
      
      const dimension2Label = document.getElementById('batchDimension2Label').value;
      const dimension2Values = document.getElementById('batchDimension2Values').value
        .split('\n')
        .map(v => v.trim())
        .filter(v => v);
      
      const costPrice = parseFloat(document.getElementById('batchCostPrice').value) || 0;
      const wholesalePrice = parseFloat(document.getElementById('batchWholesalePrice').value) || 0;
      const retailPrice = parseFloat(document.getElementById('batchRetailPrice').value) || 0;
      
      const taxClassification = document.getElementById('batchTaxClassification').value;
      const condition = document.getElementById('batchCondition').value;
      const initialQuantity = parseInt(document.getElementById('batchInitialQuantity').value) || 0;
      const notes = document.getElementById('batchNotes').value.trim();
      
      // éªŒè¯
      if (!productName || !category) {
        alert('è¯·å¡«å†™äº§å“åç§°å’Œåˆ†ç±»');
        return;
      }
      
      if (!supplier || !location) {
        alert('è¯·é€‰æ‹©ä¾›è´§å•†å¹¶å¡«å†™ä½ç½®');
        return;
      }
      
      if (dimension1Values.length === 0 || dimension2Values.length === 0) {
        alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªç»´åº¦1å’Œç»´åº¦2çš„é€‰é¡¹');
        return;
      }
      
      if (!taxClassification || !condition) {
        alert('è¯·é€‰æ‹©ç¨åŠ¡åˆ†ç±»å’Œæˆè‰²');
        return;
      }
      
      const totalVariants = dimension1Values.length * dimension2Values.length;
      
      // ç¡®è®¤
      const confirmMessage = invoiceNumber 
        ? `ç¡®è®¤åˆ›å»º ${totalVariants} ä¸ªäº§å“å˜ä½“å—ï¼Ÿ\n\näº§å“åç§°: ${productName}\nè®¢å•å·: ${invoiceNumber}\nä¾›è´§å•†: ${supplier}\nä½ç½®: ${location}\n${dimension1Label}: ${dimension1Values.length} ä¸ª\n${dimension2Label}: ${dimension2Values.length} ä¸ª`
        : `ç¡®è®¤åˆ›å»º ${totalVariants} ä¸ªäº§å“å˜ä½“å—ï¼Ÿ\n\näº§å“åç§°: ${productName}\nä¾›è´§å•†: ${supplier}\nä½ç½®: ${location}\n${dimension1Label}: ${dimension1Values.length} ä¸ª\n${dimension2Label}: ${dimension2Values.length} ä¸ª`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        debugLog(`å¼€å§‹æ‰¹é‡åˆ›å»ºå˜ä½“: ${productName}, ${totalVariants} ä¸ªå˜ä½“`);
        
        // è°ƒç”¨API
        const response = await fetch(`${API_BASE}/inventory/batch-create-variants`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            merchantId: 'admin',
            productName,
            brand,
            category,
            invoiceNumber,
            supplier,
            location,
            dimension1Label,
            dimension1Values,
            dimension2Label,
            dimension2Values,
            costPrice,
            wholesalePrice,
            retailPrice,
            taxClassification,
            condition,
            initialQuantity,
            notes
          })
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… æ‰¹é‡åˆ›å»ºæˆåŠŸï¼\n\nåˆ›å»ºäº† ${result.data.created} ä¸ªäº§å“å˜ä½“\näº§å“åç§°: ${result.data.productName}\n${dimension1Label}æ•°é‡: ${result.data.dimension1Count}\n${dimension2Label}æ•°é‡: ${result.data.dimension2Count}`);
          closeBatchVariantsModal();
          loadStats(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
          loadCategoryCards(); // åˆ·æ–°åº“å­˜åˆ—è¡¨
        } else {
          throw new Error(result.message || 'åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        console.error('æ‰¹é‡åˆ›å»ºå˜ä½“å¤±è´¥:', error);
        debugLog(`âŒ æ‰¹é‡åˆ›å»ºå˜ä½“å¤±è´¥: ${error.message}`);
        alert(`âŒ æ‰¹é‡åˆ›å»ºå¤±è´¥: ${error.message}`);
      }
    }
    
    // ==================== æ‰¹é‡åˆ›å»ºå˜ä½“åŠŸèƒ½ç»“æŸ ====================
  </script>
</body>
</html>