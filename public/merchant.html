<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹å‘å•†æˆ·ä¸­å¿ƒ - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #6366f1;
    }
    
    .tab.active {
      color: #6366f1;
      border-bottom-color: #6366f1;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #6366f1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #4f46e5;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #cfe2ff; color: #084298; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #6366f1;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <h1 id="merchantWelcome">ğŸ¢ Welcome</h1>
        <p>åº“å­˜ç®¡ç† Â· é”€å”®ä¸šåŠ¡ Â· ç¨åŠ¡æŠ¥è¡¨</p>
      </div>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <div class="container">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>æˆ‘çš„åº“å­˜</h3>
        <div class="value" id="myInventory">-</div>
      </div>
      <div class="stat-card" onclick="showDailySalesDetails()" style="cursor: pointer;" 
           onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
        <h3>æœ¬æ—¥é”€å”® ğŸ’°</h3>
        <div class="value" id="dailySales">-</div>
        <small style="color: #666; font-size: 12px;">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</small>
      </div>
      <div class="stat-card" onclick="showDailyRepairsDetails()" style="cursor: pointer;"
           onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
        <h3>æœ¬æ—¥ç»´ä¿® ğŸ”§</h3>
        <div class="value" id="dailyRepairs">-</div>
        <small style="color: #666; font-size: 12px;">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</small>
      </div>
      <div class="stat-card" onclick="showTaxCalculationDetails()" style="cursor: pointer;"
           onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
        <h3>åº”ç¼´ç¨é¢ ğŸ“Š</h3>
        <div class="value" id="taxDue">-</div>
        <small style="color: #666; font-size: 12px;">ç‚¹å‡»æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹</small>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('sales')">é”€å”®ä¸šåŠ¡</button>
      <button class="tab" onclick="switchTab('repairs')">ç»´ä¿®ä¸šåŠ¡</button>
      <button class="tab" onclick="switchTab('my-inventory')">æˆ‘çš„åº“å­˜</button>
      <button class="tab" onclick="switchTab('group-inventory')">ç¾¤ç»„åº“å­˜</button>
      <button class="tab" onclick="switchTab('warehouse-order')">ä»“åº“è®¢è´§</button>
      <button class="tab" onclick="switchTab('reports')">æŠ¥è¡¨ä¸­å¿ƒ</button>
      <button class="tab" onclick="switchTab('tax-report')">ç¨åŠ¡æŠ¥è¡¨</button>
    </div>

    <!-- é”€å”®ä¸šåŠ¡ -->
    <div id="sales" class="tab-content active">
      <div class="card">
        <h2>ğŸ›’ é”€å”®ä¸šåŠ¡</h2>
        <p style="color: #666; margin-bottom: 20px;">é€‰æ‹©äº§å“ç±»åˆ«ï¼Œæ·»åŠ åˆ°è´­ç‰©è½¦åç»“è´¦</p>
        
        <!-- è´­ç‰©è½¦æ‘˜è¦ -->
        <div id="cartSummary" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-size: 18px;">ğŸ›’</span>
              <strong>è´­ç‰©è½¦ï¼š</strong>
              <span id="cartItemCount">0</span> ä»¶å•†å“
              <span style="margin-left: 20px;"><strong>æ€»è®¡ï¼š</strong></span>
              <span id="cartTotal" style="color: #2563eb; font-size: 20px; font-weight: bold;">â‚¬0.00</span>
            </div>
            <div>
              <button class="btn btn-primary" onclick="showCheckoutModal()" style="padding: 10px 30px; font-size: 16px;">
                ğŸ’³ ç»“è´¦
              </button>
              <button onclick="clearCart()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; margin-left: 10px;">
                æ¸…ç©º
              </button>
            </div>
          </div>
        </div>
        
        <!-- äº§å“åˆ†ç±»åˆ—è¡¨ -->
        <div id="categoryList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- åˆ†ç±»äº§å“åˆ—è¡¨ -->
        <div id="categoryProducts" style="display: none;">
          <button onclick="backToCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
            â† è¿”å›åˆ†ç±»
          </button>
          <h3 id="currentCategoryName" style="margin-bottom: 15px;"></h3>
          <div id="productList"></div>
        </div>
      </div>
      
      <!-- é”€å”®è®°å½•æŸ¥è¯¢ -->
      <div class="card">
        <h2>é”€å”®è®°å½•æŸ¥è¯¢</h2>
        <div class="form-grid" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="salesStartDate">
          </div>
          <div class="form-group">
            <label>ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="salesEndDate">
          </div>
        </div>
        <button class="btn btn-primary" onclick="querySalesRecords()">æŸ¥è¯¢é”€å”®è®°å½•</button>
        
        <div id="salesRecordsTable" style="margin-top: 20px;">
          <p style="text-align: center; color: #999; padding: 20px;">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»æŸ¥è¯¢</p>
        </div>
      </div>
    </div>

    <!-- é€‰æ‹©IMEI/SNæ¨¡æ€æ¡† -->
    <div id="selectDeviceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">é€‰æ‹©è®¾å¤‡</h3>
        <p style="color: #666; margin-bottom: 15px;" id="deviceProductName"></p>
        <div id="deviceList" style="margin-bottom: 20px;"></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeDeviceModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- ç»“è´¦æ¨¡æ€æ¡† -->
    <div id="checkoutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">ğŸ’³ ç»“è´¦</h3>
        
        <!-- è´­ç‰©è½¦æ˜ç»† -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
          <h4 style="margin-bottom: 10px;">è´­ç‰©è½¦æ˜ç»†</h4>
          <div id="checkoutCartItems"></div>
          <div style="border-top: 2px solid #dee2e6; margin-top: 10px; padding-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
              <span>æ€»è®¡ï¼š</span>
              <span id="checkoutTotal" style="color: #2563eb;">â‚¬0.00</span>
            </div>
          </div>
        </div>
        
        <!-- å®¢æˆ·ä¿¡æ¯ -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px;">å®¢æˆ·ç”µè¯ï¼ˆé€‰å¡«ï¼‰</label>
          <input type="text" id="customerPhone" placeholder="è¾“å…¥å®¢æˆ·ç”µè¯..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        
        <!-- æ”¯ä»˜æ–¹å¼ -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px;">æ”¯ä»˜æ–¹å¼</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button onclick="selectPaymentMethod('CASH')" id="payBtn_CASH" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ’µ ç°é‡‘
            </button>
            <button onclick="selectPaymentMethod('CARD')" id="payBtn_CARD" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ’³ åˆ·å¡
            </button>
            <button onclick="selectPaymentMethod('MIXED')" id="payBtn_MIXED" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ’° æ··åˆ
            </button>
          </div>
          
          <!-- æ··åˆæ”¯ä»˜é‡‘é¢è¾“å…¥ -->
          <div id="mixedPaymentInputs" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç°é‡‘é‡‘é¢ (â‚¬)</label>
                <input type="number" id="cashAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateMixedPayment()">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px;">åˆ·å¡é‡‘é¢ (â‚¬)</label>
                <input type="number" id="cardAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateMixedPayment()">
              </div>
            </div>
            <p id="mixedPaymentWarning" style="color: #dc2626; margin-top: 10px; display: none;"></p>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeCheckoutModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å–æ¶ˆ
          </button>
          <button onclick="completeSale()" id="completeSaleBtn" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 16px;">
            âœ… ç¡®è®¤æ”¯ä»˜
          </button>
        </div>
      </div>
    </div>

    <!-- ç»´ä¿®ä¸šåŠ¡ -->
    <div id="repairs" class="tab-content">
      <div class="card">
        <h2>ğŸ”§ ç»´ä¿®ä¸šåŠ¡</h2>
        <button class="btn btn-success" onclick="showNewRepairModal()" style="margin-bottom: 15px;">+ æ–°å¢ç»´ä¿®è®¢å•</button>
        
        <!-- çŠ¶æ€ç­›é€‰ -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="filterRepairs('all')" id="filterBtn_all" class="btn" style="padding: 8px 16px; background: #6366f1; color: white;">
            å…¨éƒ¨
          </button>
          <button onclick="filterRepairs('pending')" id="filterBtn_pending" class="btn" style="padding: 8px 16px; background: #f59e0b; color: white;">
            å¾…ç»´ä¿®
          </button>
          <button onclick="filterRepairs('sent_out')" id="filterBtn_sent_out" class="btn" style="padding: 8px 16px; background: #8b5cf6; color: white;">
            å·²é€å‡º
          </button>
          <button onclick="filterRepairs('retrieved')" id="filterBtn_retrieved" class="btn" style="padding: 8px 16px; background: #10b981; color: white;">
            å·²å–å›
          </button>
          <button onclick="filterRepairs('completed')" id="filterBtn_completed" class="btn" style="padding: 8px 16px; background: #06b6d4; color: white;">
            å·²å®Œæˆ
          </button>
          <button onclick="filterRepairs('ready_for_sale')" id="filterBtn_ready_for_sale" class="btn" style="padding: 8px 16px; background: #ec4899; color: white;">
            ç­‰å¾…é”€å”®
          </button>
        </div>
        
        <div id="repairsTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ç»´ä¿®è®¢å•æ¨¡æ€æ¡† -->
    <div id="newRepairModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">ğŸ”§ æ–°å¢ç»´ä¿®è®¢å•</h3>
        
        <form id="newRepairForm" onsubmit="submitNewRepair(event)">
          <div style="display: grid; gap: 15px;">
            <!-- å®¢æˆ·ä¿¡æ¯ -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <h4 style="margin-bottom: 10px; color: #1e40af;">å®¢æˆ·ä¿¡æ¯</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·ç”µè¯ *</label>
                  <input type="text" id="repair_customerPhone" required placeholder="0851234567" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·å§“å</label>
                  <input type="text" id="repair_customerName" placeholder="é€‰å¡«" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
              </div>
            </div>
            
            <!-- è®¾å¤‡ä¿¡æ¯ -->
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <h4 style="margin-bottom: 10px; color: #92400e;">è®¾å¤‡ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">è®¾å¤‡åç§° *</label>
                  <input type="text" id="repair_deviceName" required placeholder="ä¾‹å¦‚: iPhone 13 Pro" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">IMEI</label>
                    <input type="text" id="repair_deviceIMEI" placeholder="é€‰å¡«" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">åºåˆ—å· (SN)</label>
                    <input type="text" id="repair_deviceSN" placeholder="é€‰å¡«" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ç»´ä¿®ä¿¡æ¯ -->
            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
              <h4 style="margin-bottom: 10px; color: #9f1239;">ç»´ä¿®ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">é—®é¢˜æè¿° *</label>
                  <textarea id="repair_problemDescription" required rows="3" placeholder="æè¿°è®¾å¤‡çš„é—®é¢˜..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å¤‡æ³¨</label>
                  <textarea id="repair_notes" rows="2" placeholder="å…¶ä»–å¤‡æ³¨ä¿¡æ¯..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®åœ°ç‚¹</label>
                    <input type="text" id="repair_location" placeholder="ç•™ç©ºè¡¨ç¤ºè‡ªå·±ç»´ä¿®" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">å¡«å†™åˆ™ä¸ºå¤–é€ç»´ä¿®</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é¢„è®¡å®Œæˆæ—¶é—´</label>
                    <input type="date" id="repair_estimatedDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®è´¹ç”¨ (â‚¬)</label>
                    <input type="number" id="repair_cost" min="0" step="0.01" value="0" placeholder="é€‰å¡«ï¼Œæˆæœ¬ä»·" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">ç»´ä¿®æˆæœ¬ï¼ˆé€‰å¡«ï¼‰</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é”€å”®ä»·æ ¼ (â‚¬) *</label>
                    <input type="number" id="repair_salePrice" min="0" step="0.01" required placeholder="å¿…å¡«ï¼Œé”€å”®ä»·" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #10b981; font-size: 12px;">å®¢æˆ·æ”¯ä»˜ä»·æ ¼ï¼ˆå¿…å¡«ï¼‰</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeNewRepairModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              âœ… åˆ›å»ºè®¢å•
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¼–è¾‘ç»´ä¿®è®¢å•æ¨¡æ€æ¡† -->
    <div id="editRepairModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">âœï¸ ç¼–è¾‘ç»´ä¿®è®¢å•</h3>
        
        <form id="editRepairForm" onsubmit="submitEditRepair(event)">
          <input type="hidden" id="edit_repair_id">
          
          <div style="display: grid; gap: 15px;">
            <!-- å®¢æˆ·ä¿¡æ¯ -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <h4 style="margin-bottom: 10px; color: #1e40af;">å®¢æˆ·ä¿¡æ¯</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·ç”µè¯ *</label>
                  <input type="text" id="edit_repair_customerPhone" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·å§“å</label>
                  <input type="text" id="edit_repair_customerName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
              </div>
            </div>
            
            <!-- è®¾å¤‡ä¿¡æ¯ -->
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <h4 style="margin-bottom: 10px; color: #92400e;">è®¾å¤‡ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">è®¾å¤‡åç§° *</label>
                  <input type="text" id="edit_repair_deviceName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">IMEI</label>
                    <input type="text" id="edit_repair_deviceIMEI" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">åºåˆ—å· (SN)</label>
                    <input type="text" id="edit_repair_deviceSN" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ç»´ä¿®ä¿¡æ¯ -->
            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
              <h4 style="margin-bottom: 10px; color: #9f1239;">ç»´ä¿®ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">é—®é¢˜æè¿° *</label>
                  <textarea id="edit_repair_problemDescription" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å¤‡æ³¨</label>
                  <textarea id="edit_repair_notes" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®åœ°ç‚¹</label>
                    <input type="text" id="edit_repair_location" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">ç•™ç©ºè¡¨ç¤ºè‡ªå·±ç»´ä¿®</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é¢„è®¡å®Œæˆæ—¶é—´</label>
                    <input type="date" id="edit_repair_estimatedDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®è´¹ç”¨ (â‚¬)</label>
                    <input type="number" id="edit_repair_cost" min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">ç»´ä¿®æˆæœ¬ï¼ˆé€‰å¡«ï¼‰</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é”€å”®ä»·æ ¼ (â‚¬) *</label>
                    <input type="number" id="edit_repair_salePrice" min="0" step="0.01" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #10b981; font-size: 12px;">å®¢æˆ·æ”¯ä»˜ä»·æ ¼ï¼ˆå¿…å¡«ï¼‰</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeEditRepairModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              âœ… ä¿å­˜ä¿®æ”¹
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- äº§å“æ—¶é—´çº¿æ¨¡æ€æ¡† -->
    <div id="productTimelineModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ“Š äº§å“æ—¶é—´çº¿</h3>
          <button onclick="closeProductTimeline()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="timelineProductName" style="font-size: 18px; font-weight: 600; color: #3b82f6; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;"></div>
        
        <div id="timelineContent" style="position: relative;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeProductTimeline()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æœ¬æ—¥é”€å”®æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="dailySalesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ’° æœ¬æ—¥é”€å”®æ˜ç»†</h3>
          <button onclick="closeDailySalesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="dailySalesDate" style="font-size: 16px; color: #666; margin-bottom: 20px;"></div>
        
        <div id="dailySalesContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeDailySalesModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æœ¬æ—¥ç»´ä¿®æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="dailyRepairsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ”§ æœ¬æ—¥ç»´ä¿®æ˜ç»†</h3>
          <button onclick="closeDailyRepairsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="dailyRepairsDate" style="font-size: 16px; color: #666; margin-bottom: 20px;"></div>
        
        <div id="dailyRepairsContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeDailyRepairsModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ç¨é¢è®¡ç®—æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="taxCalculationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ“Š ç¨é¢è®¡ç®—è¿‡ç¨‹</h3>
          <button onclick="closeTaxCalculationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="taxCalculationDate" style="font-size: 16px; color: #666; margin-bottom: 20px;"></div>
        
        <div id="taxCalculationContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeTaxCalculationModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„åº“å­˜ -->
    <div id="my-inventory" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>æˆ‘çš„åº“å­˜</h2>
          <button class="btn btn-primary" onclick="showAddInventoryModal()" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            + æ‰‹åŠ¨å…¥åº“
          </button>
        </div>
        
        <!-- æœç´¢æ¡† -->
        <div style="margin-bottom: 20px;">
          <input type="text" id="inventorySearchInput" placeholder="ğŸ” æœç´¢äº§å“åç§°ã€åºåˆ—å·ã€æ¡ç æˆ–å¤‡æ³¨..." 
            style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
            oninput="searchInventory()">
        </div>
        
        <!-- åˆ†ç±»åˆ—è¡¨ -->
        <div id="inventoryCategoryList" style="display: block;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- äº§å“åˆ—è¡¨ -->
        <div id="inventoryProductList" style="display: none;">
          <button onclick="backToInventoryCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
            â† è¿”å›åˆ†ç±»
          </button>
          <h3 id="currentInventoryCategoryName" style="margin-bottom: 15px;"></h3>
          <div id="inventoryProducts">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¥åº“æ¨¡æ€æ¡† -->
    <div id="addInventoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="font-size: 20px; color: #333;">æ‰‹åŠ¨å…¥åº“</h3>
          <button onclick="closeAddInventoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        
        <!-- æ˜¾ç¤ºå½“å‰å•†æˆ·ä¿¡æ¯ -->
        <div style="background: #f0f9ff; padding: 12px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">ğŸ¢</span>
            <div>
              <div style="font-size: 12px; color: #666;">å…¥åº“åˆ°</div>
              <div style="font-weight: 600; color: #1e40af;" id="currentMerchantInfo">å½“å‰å•†æˆ·</div>
            </div>
          </div>
        </div>
        
        <form id="addInventoryForm" onsubmit="submitAddInventory(event)">
          <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">äº§å“åç§° *</label>
              <input type="text" id="inv_productName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">å“ç‰Œ</label>
                <input type="text" id="inv_brand" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">å‹å·</label>
                <input type="text" id="inv_model" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">åˆ†ç±» *</label>
                <select id="inv_category" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  <option value="">è¯·é€‰æ‹©åˆ†ç±»...</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æ•°é‡ *</label>
                <input type="number" id="inv_quantity" required min="1" value="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æˆæœ¬ä»· (â‚¬) *</label>
                <input type="number" id="inv_costPrice" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æ‰¹å‘ä»· (â‚¬) *</label>
                <input type="number" id="inv_wholesalePrice" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">é›¶å”®ä»· (â‚¬) *</label>
                <input type="number" id="inv_retailPrice" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æ¡ç </label>
                <input type="text" id="inv_barcode" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">åºåˆ—å·</label>
                <input type="text" id="inv_serialNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">é¢œè‰²</label>
                <input type="text" id="inv_color" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æˆè‰²</label>
                <select id="inv_condition" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  <option value="BRAND_NEW">å…¨æ–°</option>
                  <option value="PRE_OWNED">äºŒæ‰‹</option>
                  <option value="REFURBISHED">ç¿»æ–°</option>
                </select>
              </div>
            </div>
            
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">å¤‡æ³¨</label>
              <textarea id="inv_notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeAddInventoryModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              ç¡®è®¤å…¥åº“
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¾¤ç»„åº“å­˜ -->
    <div id="group-inventory" class="tab-content">
      <div class="card">
        <h2>ğŸ‘¥ ç¾¤ç»„åº“å­˜</h2>
        <p style="color: #666; margin-bottom: 20px;">æŸ¥çœ‹åŒä¸€ç¾¤ç»„å†…å…¶ä»–å•†æˆ·çš„åº“å­˜ï¼Œæ–¹ä¾¿è°ƒè´§</p>
        
        <!-- åˆ†ç±»åˆ—è¡¨ -->
        <div id="groupInventoryCategoryList" style="display: block;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- äº§å“åˆ—è¡¨ -->
        <div id="groupInventoryProductList" style="display: none;">
          <button onclick="backToGroupCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
            â† è¿”å›åˆ†ç±»
          </button>
          <h3 id="currentGroupCategoryName" style="margin-bottom: 15px;"></h3>
          
          <!-- æœç´¢æ¡† -->
          <div style="margin-bottom: 20px;">
            <input type="text" id="groupInventorySearchInput" placeholder="ğŸ” æœç´¢äº§å“åç§°ã€åºåˆ—å·ã€å•†æˆ·..." 
              style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
              oninput="searchGroupInventory()">
          </div>
          
          <div id="groupInventoryTable">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»“åº“è®¢è´§ -->
    <div id="warehouse-order" class="tab-content">
      <div class="card">
        <h2>ğŸ“¦ ä»ä»“åº“è®¢è´§</h2>
        <p style="color: #666; margin-bottom: 20px;">é€‰æ‹©äº§å“ä»ä»“åº“é‡‡è´­åˆ°æ‚¨çš„åº“å­˜</p>
        
        <!-- è®¢å•æ ‡ç­¾ -->
        <div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
          <button id="warehouseOrderTabBtn" class="sub-tab active" onclick="switchWarehouseTab('order')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #6366f1; color: #6366f1; font-weight: 600; cursor: pointer;">
            æµè§ˆäº§å“
          </button>
          <button id="warehouseMyOrdersTabBtn" class="sub-tab" onclick="switchWarehouseTab('myOrders')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; cursor: pointer;">
            æˆ‘çš„è®¢å•
          </button>
        </div>
        
        <!-- æµè§ˆäº§å“åŒºåŸŸ -->
        <div id="warehouseOrderSection">
          <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px;">
            <!-- å·¦ä¾§ï¼šäº§å“åŒºåŸŸ -->
            <div>
              <!-- åˆ†ç±»åˆ—è¡¨è§†å›¾ -->
              <div id="warehouseCategoryListView" style="display: block;">
                <div id="warehouseCategoryList">
                  <h3 style="margin-bottom: 15px;">é€‰æ‹©äº§å“åˆ†ç±»</h3>
                  <div id="warehouseCategories" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                    <div class="loading">åŠ è½½ä¸­...</div>
                  </div>
                </div>
              </div>
              
              <!-- äº§å“åˆ—è¡¨è§†å›¾ -->
              <div id="warehouseProductList" style="display: none;">
                <button onclick="backToWarehouseCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
                  â† è¿”å›åˆ†ç±»
                </button>
                <h3 id="currentWarehouseCategoryName" style="margin-bottom: 15px;"></h3>
                <div id="warehouseProducts" style="overflow-x: auto;">
                  <div class="loading">åŠ è½½ä¸­...</div>
                </div>
              </div>
            </div>
            
            <!-- å³ä¾§ï¼šè´­ç‰©è½¦ï¼ˆå›ºå®šæ˜¾ç¤ºï¼‰ -->
            <div style="position: sticky; top: 20px; height: fit-content;">
              <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px;">
                <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                  <span>ğŸ›’ è´­ç‰©è½¦</span>
                  <span id="warehouseCartCount" style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px;">0</span>
                </h3>
                
                <div id="warehouseCartItems" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                  <p style="color: #9ca3af; text-align: center; padding: 40px 0;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                </div>
                
                <div style="border-top: 2px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px; font-weight: 600;">
                    <span>æ€»è®¡:</span>
                    <span style="color: #ef4444;">â‚¬<span id="warehouseCartTotal">0.00</span></span>
                  </div>
                  <button onclick="submitWarehouseOrder()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    æäº¤è®¢å•
                  </button>
                  <button onclick="clearWarehouseCart()" style="width: 100%; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 10px;">
                    æ¸…ç©ºè´­ç‰©è½¦
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- æˆ‘çš„è®¢å•åŒºåŸŸ -->
        <div id="warehouseMyOrdersSection" style="display: none;">
          <div style="margin-bottom: 20px;">
            <select id="orderStatusFilter" onchange="loadMyWarehouseOrders()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending">å¾…ç¡®è®¤</option>
              <option value="confirmed">å·²ç¡®è®¤</option>
              <option value="shipped">å·²å‘è´§</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </div>
          
          <div id="myWarehouseOrdersList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¢å•æäº¤å¯¹è¯æ¡† -->
    <div id="warehouseOrderSubmitModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeWarehouseOrderSubmitModal()">&times;</span>
        <h2>ğŸ“¦ æäº¤è®¢å•</h2>
        
        <div style="margin: 20px 0;">
          <h3 style="margin-bottom: 10px;">è®¢å•æ˜ç»†</h3>
          <div id="orderSubmitItems" style="max-height: 200px; overflow-y: auto; background: #f9fafb; padding: 15px; border-radius: 8px;">
          </div>
          <div style="text-align: right; margin-top: 10px; font-size: 18px; font-weight: 600;">
            æ€»è®¡: â‚¬<span id="orderSubmitTotal">0.00</span>
          </div>
        </div>
        
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…é€æ–¹å¼</label>
          <select id="deliveryMethod" onchange="toggleDeliveryFields()" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
            <option value="delivery">ğŸšš ç‰©æµé…é€</option>
            <option value="pickup">ğŸª åˆ°åº—è‡ªå–</option>
          </select>
        </div>
        
        <div id="deliveryAddressSection" style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…é€åœ°å€</label>
          <textarea id="deliveryAddress" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="è¯·è¾“å…¥è¯¦ç»†é…é€åœ°å€"></textarea>
        </div>
        
        <div id="pickupLocationSection" style="margin: 20px 0; display: none;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">è‡ªå–åœ°ç‚¹</label>
          <select id="pickupLocation" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
            <option value="warehouse">ä»“åº“</option>
            <option value="store">é—¨åº—</option>
          </select>
        </div>
        
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¤‡æ³¨</label>
          <textarea id="orderNotes" rows="2" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="é€‰å¡«"></textarea>
        </div>
        
        <button onclick="confirmWarehouseOrderSubmit()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
          ç¡®è®¤æäº¤
        </button>
      </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…å¯¹è¯æ¡† -->
    <div id="warehouseOrderDetailModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeWarehouseOrderDetailModal()">&times;</span>
        <h2>ğŸ“‹ è®¢å•è¯¦æƒ…</h2>
        
        <div id="orderDetailContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æŠ¥è¡¨ä¸­å¿ƒ -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>åº“å­˜æŠ¥è¡¨</h2>
        <div id="inventoryReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div class="card">
        <h2>é”€å”®æŠ¥è¡¨</h2>
        <div id="salesReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç¨åŠ¡æŠ¥è¡¨ -->
    <div id="tax-report" class="tab-content">
      <div class="card">
        <h2>ç¨åŠ¡æŠ¥è¡¨</h2>
        <div class="form-grid" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="taxStartDate">
          </div>
          <div class="form-group">
            <label>ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="taxEndDate">
          </div>
        </div>
        <button class="btn btn-primary" onclick="generateTaxReport()">ç”ŸæˆæŠ¥è¡¨</button>
        
        <div id="taxReportContent" style="margin-top: 20px;">
          <div class="loading">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç”ŸæˆæŠ¥è¡¨</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const merchantId = localStorage.getItem('username') || 'merchant_001'; // ä»ç™»å½•sessionè·å–
    
    // è´­ç‰©è½¦
    let cart = [];
    let selectedPaymentMethod = null;

    // åŠ è½½å•†æˆ·ä¿¡æ¯
    async function loadMerchantInfo() {
      try {
        // ä» localStorage è·å–ç”¨æˆ·å
        const userName = localStorage.getItem('username') || 'Guest';
        document.getElementById('merchantWelcome').textContent = `ğŸ¢ Welcome ${userName}`;
        document.title = `Welcome ${userName} - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ`;
      } catch (error) {
        console.error('åŠ è½½å•†æˆ·ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('merchantWelcome').textContent = `ğŸ¢ Welcome`;
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'sales': loadCategoryList(); break;
        case 'repairs': loadRepairs(); break;
        case 'my-inventory': loadMyInventory(); break;
        case 'group-inventory': loadGroupInventory(); break;
        case 'warehouse-order': switchWarehouseTab('order'); break;
        case 'reports': loadReports(); break;
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/merchant/stats?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          document.getElementById('myInventory').textContent = stats.myInventory || 0;
          document.getElementById('dailySales').textContent = 'â‚¬' + (stats.dailySales || 0).toFixed(2);
          document.getElementById('dailyRepairs').textContent = 'â‚¬' + (stats.dailyRepairs || 0).toFixed(2);
          document.getElementById('taxDue').textContent = 'â‚¬' + (stats.taxDue || 0).toFixed(2);
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // æ˜¾ç¤ºæœ¬æ—¥é”€å”®æ˜ç»†
    async function showDailySalesDetails() {
      document.getElementById('dailySalesModal').style.display = 'flex';
      
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
      document.getElementById('dailySalesDate').textContent = `ğŸ“… ${dateStr}`;
      document.getElementById('dailySalesContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const startDate = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const endDate = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
          const sales = result.data;
          let totalAmount = 0;
          let totalTax = 0;
          let totalProfit = 0;
          
          let html = `
            <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <h4 style="margin-bottom: 10px; color: #1e40af;">é”€å”®æ±‡æ€»</h4>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div>
                  <div style="font-size: 12px; color: #666;">é”€å”®ç¬”æ•°</div>
                  <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${sales.length}</div>
                </div>
                <div id="dailySalesSummary"></div>
              </div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                  <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                  <th style="padding: 12px; text-align: left;">äº§å“</th>
                  <th style="padding: 12px; text-align: right;">æ•°é‡</th>
                  <th style="padding: 12px; text-align: right;">é‡‘é¢</th>
                  <th style="padding: 12px; text-align: right;">ç¨é¢</th>
                  <th style="padding: 12px; text-align: left;">æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          sales.forEach(sale => {
            totalAmount += sale.totalAmount || 0;
            totalTax += sale.totalTax || 0;
            
            // è®¡ç®—åˆ©æ¶¦
            sale.items.forEach(item => {
              totalProfit += (item.price - item.costPrice) * item.quantity;
            });
            
            const time = new Date(sale.date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const paymentMethod = sale.paymentMethod === 'CASH' ? 'ğŸ’µ ç°é‡‘' : 
                                 sale.paymentMethod === 'CARD' ? 'ğŸ’³ åˆ·å¡' : 'ğŸ’° æ··åˆ';
            
            html += `
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;">${time}</td>
                <td style="padding: 12px;">
                  ${sale.items.map(item => `
                    <div style="margin-bottom: 5px;">
                      ${item.productName} ${item.serialNumber ? `<small style="color: #666;">(${item.serialNumber})</small>` : ''}
                    </div>
                  `).join('')}
                </td>
                <td style="padding: 12px; text-align: right;">
                  ${sale.items.map(item => `<div style="margin-bottom: 5px;">${item.quantity}</div>`).join('')}
                </td>
                <td style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">
                  â‚¬${sale.totalAmount.toFixed(2)}
                </td>
                <td style="padding: 12px; text-align: right; color: #f59e0b;">
                  â‚¬${(sale.totalTax || 0).toFixed(2)}
                </td>
                <td style="padding: 12px;">${paymentMethod}</td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
              <tfoot>
                <tr style="background: #f9fafb; font-weight: bold; border-top: 2px solid #e5e7eb;">
                  <td colspan="3" style="padding: 12px; text-align: right;">åˆè®¡ï¼š</td>
                  <td style="padding: 12px; text-align: right; color: #10b981;">â‚¬${totalAmount.toFixed(2)}</td>
                  <td style="padding: 12px; text-align: right; color: #f59e0b;">â‚¬${totalTax.toFixed(2)}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          `;
          
          document.getElementById('dailySalesContent').innerHTML = html;
          
          // æ›´æ–°æ±‡æ€»ä¿¡æ¯
          document.getElementById('dailySalesSummary').innerHTML = `
            <div>
              <div style="font-size: 12px; color: #666;">é”€å”®æ€»é¢</div>
              <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${totalAmount.toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #666;">åˆ©æ¶¦</div>
              <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">â‚¬${totalProfit.toFixed(2)}</div>
            </div>
          `;
        } else {
          document.getElementById('dailySalesContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— é”€å”®è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½é”€å”®æ˜ç»†å¤±è´¥:', error);
        document.getElementById('dailySalesContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­æœ¬æ—¥é”€å”®æ˜ç»†æ¨¡æ€æ¡†
    function closeDailySalesModal() {
      document.getElementById('dailySalesModal').style.display = 'none';
    }

    // æ˜¾ç¤ºæœ¬æ—¥ç»´ä¿®æ˜ç»†
    async function showDailyRepairsDetails() {
      document.getElementById('dailyRepairsModal').style.display = 'flex';
      
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
      document.getElementById('dailyRepairsDate').textContent = `ğŸ“… ${dateStr}`;
      document.getElementById('dailyRepairsContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          // ç­›é€‰ä»Šæ—¥åˆ›å»ºçš„ç»´ä¿®è®¢å•
          const todayRepairs = result.data.filter(repair => {
            const createdDate = new Date(repair.createdAt);
            return createdDate >= today && createdDate < tomorrow;
          });
          
          if (todayRepairs.length > 0) {
            let totalCost = 0;
            let totalSalePrice = 0;
            const statusCount = {};
            
            todayRepairs.forEach(repair => {
              totalCost += repair.repairCost || 0;
              totalSalePrice += repair.salePrice || 0;
              statusCount[repair.status] = (statusCount[repair.status] || 0) + 1;
            });
            
            const statusNames = {
              'pending': 'å¾…ç»´ä¿®',
              'sent_out': 'å·²é€å‡º',
              'retrieved': 'å·²å–å›',
              'completed': 'å·²å®Œæˆ',
              'ready_for_sale': 'ç­‰å¾…é”€å”®',
              'sold': 'å·²é”€å”®',
              'cancelled': 'å·²å–æ¶ˆ'
            };
            
            let html = `
              <div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <h4 style="margin-bottom: 10px; color: #92400e;">ç»´ä¿®æ±‡æ€»</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                  <div>
                    <div style="font-size: 12px; color: #666;">è®¢å•æ•°é‡</div>
                    <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${todayRepairs.length}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">ç»´ä¿®æˆæœ¬</div>
                    <div style="font-size: 20px; font-weight: bold; color: #dc3545;">â‚¬${totalCost.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">é¢„è®¡æ”¶å…¥</div>
                    <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${totalSalePrice.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">é¢„è®¡åˆ©æ¶¦</div>
                    <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">â‚¬${(totalSalePrice - totalCost).toFixed(2)}</div>
                  </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #fde68a;">
                  <div style="font-size: 12px; color: #666; margin-bottom: 8px;">çŠ¶æ€åˆ†å¸ƒï¼š</div>
                  <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    ${Object.entries(statusCount).map(([status, count]) => `
                      <span style="background: white; padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                        ${statusNames[status]}: <strong>${count}</strong>
                      </span>
                    `).join('')}
                  </div>
                </div>
              </div>
              
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                    <th style="padding: 12px; text-align: left;">å®¢æˆ·</th>
                    <th style="padding: 12px; text-align: left;">è®¾å¤‡</th>
                    <th style="padding: 12px; text-align: left;">é—®é¢˜</th>
                    <th style="padding: 12px; text-align: right;">æˆæœ¬</th>
                    <th style="padding: 12px; text-align: right;">å”®ä»·</th>
                    <th style="padding: 12px; text-align: center;">çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            todayRepairs.forEach(repair => {
              const time = new Date(repair.createdAt).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
              const statusColors = {
                'pending': '#f59e0b',
                'sent_out': '#8b5cf6',
                'retrieved': '#10b981',
                'completed': '#06b6d4',
                'ready_for_sale': '#ec4899',
                'sold': '#6b7280',
                'cancelled': '#ef4444'
              };
              
              html += `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                  <td style="padding: 12px;">${time}</td>
                  <td style="padding: 12px;">
                    ${repair.customerPhone}<br>
                    <small style="color: #666;">${repair.customerName || '-'}</small>
                  </td>
                  <td style="padding: 12px;">
                    ${repair.deviceName}<br>
                    <small style="color: #666;">${repair.deviceIMEI || repair.deviceSN || '-'}</small>
                  </td>
                  <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${repair.problemDescription}">
                    ${repair.problemDescription}
                  </td>
                  <td style="padding: 12px; text-align: right; color: #dc3545;">
                    â‚¬${(repair.repairCost || 0).toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">
                    â‚¬${(repair.salePrice || 0).toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    <span style="background: ${statusColors[repair.status]}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                      ${statusNames[repair.status]}
                    </span>
                  </td>
                </tr>
              `;
            });
            
            html += `
                </tbody>
              </table>
            `;
            
            document.getElementById('dailyRepairsContent').innerHTML = html;
          } else {
            document.getElementById('dailyRepairsContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— ç»´ä¿®è®¢å•</p>';
          }
        } else {
          document.getElementById('dailyRepairsContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— ç»´ä¿®è®¢å•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç»´ä¿®æ˜ç»†å¤±è´¥:', error);
        document.getElementById('dailyRepairsContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­æœ¬æ—¥ç»´ä¿®æ˜ç»†æ¨¡æ€æ¡†
    function closeDailyRepairsModal() {
      document.getElementById('dailyRepairsModal').style.display = 'none';
    }

    // æ˜¾ç¤ºç¨é¢è®¡ç®—æ˜ç»†
    async function showTaxCalculationDetails() {
      document.getElementById('taxCalculationModal').style.display = 'flex';
      
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const dateStr = `${firstDay.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' })} - ${today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' })}`;
      document.getElementById('taxCalculationDate').textContent = `ğŸ“… æœ¬æœˆç»Ÿè®¡æœŸé—´: ${dateStr}`;
      document.getElementById('taxCalculationContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const startDate = firstDay.toISOString();
        const endDate = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
          const sales = result.data;
          
          // æŒ‰ç¨ç‡åˆ†ç±»ç»Ÿè®¡
          const taxByRate = {};
          let totalTax = 0;
          let totalSales = 0;
          
          sales.forEach(sale => {
            totalSales += sale.totalAmount || 0;
            totalTax += sale.totalTax || 0;
            
            sale.items.forEach(item => {
              const taxClass = item.taxClassification || 'VAT_23';
              if (!taxByRate[taxClass]) {
                taxByRate[taxClass] = {
                  totalAmount: 0,
                  totalCost: 0,
                  totalTax: 0,
                  count: 0,
                  items: []
                };
              }
              
              const itemTotal = item.price * item.quantity;
              const itemCost = (item.costPrice || 0) * item.quantity;
              const itemTax = item.taxAmount || 0;
              
              taxByRate[taxClass].totalAmount += itemTotal;
              taxByRate[taxClass].totalCost += itemCost;
              taxByRate[taxClass].totalTax += itemTax;
              taxByRate[taxClass].count += item.quantity;
              taxByRate[taxClass].items.push({
                name: item.productName,
                quantity: item.quantity,
                price: item.price,
                costPrice: item.costPrice || 0,
                total: itemTotal,
                tax: itemTax,
                date: sale.date
              });
            });
          });
          
          // ç¨ç‡åç§°å’Œç¨ç‡
          const taxRates = {
            'VAT_23': { name: 'VAT 23%', rate: 23, formula: 'é”€å”®é¢ Ã— 23 / 123' },
            'VAT_13_5': { name: 'VAT 13.5%', rate: 13.5, formula: 'é”€å”®é¢ Ã— 13.5 / 113.5' },
            'SERVICE_VAT_13_5': { name: 'æœåŠ¡ VAT 13.5%', rate: 13.5, formula: 'é”€å”®é¢ Ã— 13.5 / 113.5' },
            'VAT_9': { name: 'VAT 9%', rate: 9, formula: 'é”€å”®é¢ Ã— 9 / 109' },
            'VAT_0': { name: 'VAT 0%', rate: 0, formula: 'å…ç¨' },
            'MARGIN_VAT_0': { name: 'å·®ä»·å¾ç¨ VAT 23%', rate: 23, formula: '(é”€å”®ä»· - æˆæœ¬ä»·) Ã— 23 / 123' }
          };
          
          let html = `
            <div style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
              <h4 style="margin-bottom: 10px; color: #065f46;">ç¨é¢æ±‡æ€»</h4>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div>
                  <div style="font-size: 12px; color: #666;">é”€å”®æ€»é¢</div>
                  <div style="font-size: 24px; font-weight: bold; color: #10b981;">â‚¬${totalSales.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">åº”ç¼´ç¨é¢</div>
                  <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">â‚¬${totalTax.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">å‡€æ”¶å…¥</div>
                  <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">â‚¬${(totalSales - totalTax).toFixed(2)}</div>
                </div>
              </div>
            </div>
          `;
          
          // æŒ‰ç¨ç‡åˆ†ç±»æ˜¾ç¤º
          Object.entries(taxByRate).forEach(([taxClass, data]) => {
            const taxInfo = taxRates[taxClass] || { name: taxClass, rate: 0, formula: 'æœªçŸ¥' };
            
            html += `
              <div style="margin-bottom: 20px; padding: 15px; background: white; border: 2px solid #e5e7eb; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                  <div>
                    <h4 style="margin: 0; color: #1e40af;">${taxInfo.name}</h4>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">
                      è®¡ç®—å…¬å¼: <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">${taxInfo.formula}</code>
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 12px; color: #666;">å•†å“æ•°é‡</div>
                    <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${data.count}</div>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; padding: 15px; background: #f9fafb; border-radius: 6px;">
                  <div>
                    <div style="font-size: 12px; color: #666;">é”€å”®é¢</div>
                    <div style="font-size: 18px; font-weight: bold; color: #10b981;">â‚¬${data.totalAmount.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">ç¨é¢</div>
                    <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">â‚¬${data.totalTax.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">å‡€é¢</div>
                    <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">â‚¬${(data.totalAmount - data.totalTax).toFixed(2)}</div>
                  </div>
                </div>
                
                <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                  <strong>è®¡ç®—è¿‡ç¨‹ï¼š</strong>
                </div>
                <div style="background: #f9fafb; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px;">
                  ${taxClass === 'MARGIN_VAT_0' ? `
                    é”€å”®é¢: â‚¬${data.totalAmount.toFixed(2)}<br>
                    æˆæœ¬ä»·: â‚¬${data.totalCost.toFixed(2)}<br>
                    åˆ©æ¶¦: â‚¬${(data.totalAmount - data.totalCost).toFixed(2)}<br>
                    ç¨ç‡: 23%<br>
                    ç¨é¢ = (â‚¬${data.totalAmount.toFixed(2)} - â‚¬${data.totalCost.toFixed(2)}) Ã— 23 / 123 = â‚¬${data.totalTax.toFixed(2)}
                  ` : `
                    é”€å”®é¢: â‚¬${data.totalAmount.toFixed(2)}<br>
                    ç¨ç‡: ${taxInfo.rate}%<br>
                    ${taxInfo.rate > 0 ? `ç¨é¢ = â‚¬${data.totalAmount.toFixed(2)} Ã— ${taxInfo.rate} / ${100 + taxInfo.rate} = â‚¬${data.totalTax.toFixed(2)}` : 'å…ç¨å•†å“ï¼Œç¨é¢ = â‚¬0.00'}
                  `}
                </div>
              </div>
            `;
          });
          
          html += `
            <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <h4 style="margin-bottom: 10px; color: #92400e;">ğŸ’¡ ç¨é¢è¯´æ˜</h4>
              <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 14px; line-height: 1.8;">
                <li>VAT 23%ï¼šæ ‡å‡†ç¨ç‡ï¼Œé€‚ç”¨äºå¤§å¤šæ•°å•†å“</li>
                <li>VAT 13.5%ï¼šé™ä½ç¨ç‡ï¼Œé€‚ç”¨äºç‰¹å®šå•†å“å’ŒæœåŠ¡</li>
                <li>VAT 9%ï¼šè¶…ä½ç¨ç‡ï¼Œé€‚ç”¨äºç‰¹æ®Šå•†å“</li>
                <li>VAT 0%ï¼šå…ç¨å•†å“</li>
                <li>å·®ä»·å¾ç¨ VAT 23%ï¼šé€‚ç”¨äºäºŒæ‰‹å•†å“ï¼Œä»…å¯¹åˆ©æ¶¦éƒ¨åˆ†å¾ç¨ï¼Œè®¡ç®—å…¬å¼ï¼š(é”€å”®ä»· - æˆæœ¬ä»·) Ã— 23 / 123</li>
                <li>ç¨é¢è®¡ç®—é‡‡ç”¨å«ç¨ä»·æ ¼åæ¨æ³•</li>
              </ul>
            </div>
          `;
          
          document.getElementById('taxCalculationContent').innerHTML = html;
        } else {
          document.getElementById('taxCalculationContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æœ¬æœˆæš‚æ— é”€å”®è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç¨é¢è®¡ç®—å¤±è´¥:', error);
        document.getElementById('taxCalculationContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­ç¨é¢è®¡ç®—æ˜ç»†æ¨¡æ€æ¡†
    function closeTaxCalculationModal() {
      document.getElementById('taxCalculationModal').style.display = 'none';
    }

    // ==================== é”€å”®ä¸šåŠ¡ - è´­ç‰©è½¦æ¨¡å¼ ====================
    
    // åŠ è½½äº§å“åˆ†ç±»åˆ—è¡¨
    async function loadCategoryList() {
      const container = document.getElementById('categoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        // è·å–åº“å­˜äº§å“
        const inventoryResponse = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const inventoryResult = await inventoryResponse.json();
        
        // è·å–å¾…é”€å”®çš„ç»´ä¿®è®¢å•
        const repairsResponse = await fetch(`${API_BASE}/merchant/repairs/ready-for-sale?merchantId=${merchantId}`);
        const repairsResult = await repairsResponse.json();
        
        const categories = {};
        let repairCount = 0;
        
        // å¤„ç†åº“å­˜äº§å“
        if (inventoryResult.success && inventoryResult.data.length > 0) {
          inventoryResult.data.forEach(item => {
            if (item.quantity > 0 && item.status === 'active') {
              // category æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
              const categoryName = item.category || 'æœªåˆ†ç±»';
              if (!categories[categoryName]) {
                categories[categoryName] = {
                  name: categoryName,
                  count: 0,
                  totalQty: 0
                };
              }
              categories[categoryName].count++;
              categories[categoryName].totalQty += item.quantity;
            }
          });
        }
        
        // ç»Ÿè®¡ç»´ä¿®è®¢å•æ•°é‡
        if (repairsResult.success && repairsResult.data.length > 0) {
          repairCount = repairsResult.data.length;
        }
        
        const categoryArray = Object.values(categories);
        
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">';
        
        // æ·»åŠ ç»´ä¿®è®¢å•åˆ†ç±»ï¼ˆå¦‚æœæœ‰ï¼‰
        if (repairCount > 0) {
          html += `
            <div onclick="showRepairOrders()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
              <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”§</div>
              <h3 style="font-size: 18px; margin-bottom: 10px;">ç»´ä¿®è®¢å•</h3>
              <div style="font-size: 14px; opacity: 0.9;">
                ${repairCount} ä¸ªå¾…é”€å”®è®¢å•
              </div>
            </div>
          `;
        }
        
        // æ·»åŠ åº“å­˜äº§å“åˆ†ç±»
        if (categoryArray.length > 0) {
          html += categoryArray.map(cat => `
            <div onclick="showCategoryProducts('${cat.name}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
              <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¦</div>
              <h3 style="font-size: 18px; margin-bottom: 10px;">${cat.name}</h3>
              <div style="font-size: 14px; opacity: 0.9;">
                ${cat.count} ç§äº§å“ Â· ${cat.totalQty} ä»¶åº“å­˜
              </div>
            </div>
          `).join('');
        }
        
        html += '</div>';
        
        if (categoryArray.length > 0 || repairCount > 0) {
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¯é”€å”®äº§å“</p>';
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºç»´ä¿®è®¢å•åˆ—è¡¨
    async function showRepairOrders() {
      document.getElementById('categoryList').style.display = 'none';
      document.getElementById('categoryProducts').style.display = 'block';
      document.getElementById('currentCategoryName').textContent = 'ğŸ”§ ç»´ä¿®è®¢å•';
      
      const container = document.getElementById('productList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/ready-for-sale?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <div style="display: grid; gap: 15px;">
              ${result.data.map(repair => `
                <div style="background: white; border: 2px solid #f59e0b; border-radius: 10px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                  <div style="flex: 1;">
                    <h4 style="font-size: 18px; margin-bottom: 8px;">ğŸ”§ ${repair.deviceName}</h4>
                    <div style="color: #666; font-size: 14px; margin-bottom: 8px;">
                      å®¢æˆ·: ${repair.customerPhone}${repair.customerName ? ` (${repair.customerName})` : ''}
                      ${repair.deviceIMEI ? `<br>IMEI: ${repair.deviceIMEI}` : ''}
                      ${repair.deviceSN ? `<br>SN: ${repair.deviceSN}` : ''}
                    </div>
                    <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                      é—®é¢˜: ${repair.problemDescription}
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                      <span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                        æˆæœ¬: â‚¬${repair.repairCost.toFixed(2)}
                      </span>
                      <span style="color: #10b981; font-size: 20px; font-weight: bold;">
                        å”®ä»·: â‚¬${repair.salePrice.toFixed(2)}
                      </span>
                    </div>
                  </div>
                  <div>
                    <button onclick="addRepairToCart('${repair._id}', '${repair.deviceName}', ${repair.repairCost}, ${repair.salePrice}, '${repair.customerPhone}')" 
                      style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                      + åŠ å…¥è´­ç‰©è½¦
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¾…é”€å”®çš„ç»´ä¿®è®¢å•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç»´ä¿®è®¢å•å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // å°†ç»´ä¿®è®¢å•åŠ å…¥è´­ç‰©è½¦
    function addRepairToCart(repairId, deviceName, repairCost, salePrice, customerPhone) {
      // ä½¿ç”¨é¢„è®¾çš„é”€å”®ä»·æ ¼
      const price = salePrice;
      
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
      const existingItem = cart.find(item => item.repairId === repairId);
      
      if (existingItem) {
        alert('æ­¤ç»´ä¿®è®¢å•å·²åœ¨è´­ç‰©è½¦ä¸­');
        return;
      }
      
      cart.push({
        repairId: repairId,
        productName: `ğŸ”§ ${deviceName} (ç»´ä¿®)`,
        price: price,
        quantity: 1,
        maxQty: 1,
        taxClassification: 'SERVICE_VAT_13_5', // ç»´ä¿®æœåŠ¡ä½¿ç”¨13.5%ç¨ç‡
        isRepair: true,
        customerPhone: customerPhone
      });
      
      updateCartDisplay();
      alert(`âœ… ${deviceName} ç»´ä¿®è®¢å•å·²æ·»åŠ åˆ°è´­ç‰©è½¦\né”€å”®ä»·æ ¼: â‚¬${price.toFixed(2)}`);
    }
    
    // æ˜¾ç¤ºåˆ†ç±»ä¸‹çš„äº§å“
    async function showCategoryProducts(category) {
      document.getElementById('categoryList').style.display = 'none';
      document.getElementById('categoryProducts').style.display = 'block';
      document.getElementById('currentCategoryName').textContent = `ğŸ“¦ ${category}`;
      
      const container = document.getElementById('productList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success) {
          // category æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ¯”è¾ƒ
          const allProducts = result.data.filter(item => 
            item.category === category && item.quantity > 0 && item.status === 'active'
          );
          
          // æŒ‰äº§å“åç§°ã€å“ç‰Œã€å‹å·ã€é¢œè‰²åˆ†ç»„
          const groupedProducts = {};
          allProducts.forEach(item => {
            const key = `${item.productName}_${item.brand || ''}_${item.model || ''}_${item.color || ''}`;
            if (!groupedProducts[key]) {
              groupedProducts[key] = {
                productName: item.productName,
                brand: item.brand,
                model: item.model,
                color: item.color,
                retailPrice: item.retailPrice,
                taxClassification: item.taxClassification,
                items: [],
                totalQuantity: 0
              };
            }
            groupedProducts[key].items.push(item);
            groupedProducts[key].totalQuantity += item.quantity;
          });
          
          const products = Object.values(groupedProducts);
          
          if (products.length > 0) {
            const html = `
              <div style="display: grid; gap: 15px;">
                ${products.map(product => {
                  const hasSerialNumber = product.items.some(item => item.serialNumber || item.imei);
                  return `
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                      <h4 style="font-size: 18px; margin-bottom: 8px;">${product.productName}</h4>
                      <div style="color: #666; font-size: 14px; margin-bottom: 8px;">
                        ${product.brand ? `å“ç‰Œ: ${product.brand}` : ''} 
                        ${product.model ? `å‹å·: ${product.model}` : ''}
                        ${product.color ? `Â· é¢œè‰²: ${product.color}` : ''}
                      </div>
                      <div style="display: flex; gap: 15px; align-items: center;">
                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                          åº“å­˜: ${product.totalQuantity}
                        </span>
                        <span style="color: #10b981; font-size: 20px; font-weight: bold;">
                          â‚¬${product.retailPrice.toFixed(2)}
                        </span>
                      </div>
                    </div>
                    <div>
                      ${hasSerialNumber ? `
                        <button onclick='showDeviceSelectionMultiple(${JSON.stringify(product.items.map(i => i._id))}, "${product.productName}")' 
                          style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                          é€‰æ‹©è®¾å¤‡
                        </button>
                      ` : `
                        <button onclick="addToCart('${product.items[0]._id}', '${product.productName}', ${product.retailPrice}, ${product.totalQuantity}, '${product.taxClassification || 'VAT_23'}')" 
                          style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                          + åŠ å…¥è´­ç‰©è½¦
                        </button>
                      `}
                    </div>
                  </div>
                `}).join('')}
              </div>
            `;
            container.innerHTML = html;
          } else {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯¥åˆ†ç±»æš‚æ— å¯é”€å”®äº§å“</p>';
          }
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºè®¾å¤‡ï¼ˆéœ€è¦é€‰æ‹©IMEI/SNï¼‰
    function isDevice(product) {
      // å¦‚æœæœ‰åºåˆ—å·æˆ–IMEIï¼Œè®¤ä¸ºæ˜¯è®¾å¤‡
      return product.serialNumber || product.barcode;
    }
    
    // è¿”å›åˆ†ç±»åˆ—è¡¨
    function backToCategories() {
      document.getElementById('categoryList').style.display = 'block';
      document.getElementById('categoryProducts').style.display = 'none';
    }
    
    // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†ï¼ˆå¤šä¸ªè®¾å¤‡ï¼‰
    async function showDeviceSelectionMultiple(inventoryIds, productName) {
      document.getElementById('deviceProductName').textContent = `äº§å“: ${productName}`;
      
      // è·å–æ‰€æœ‰è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯
      const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
      const result = await response.json();
      
      if (result.success) {
        const devices = result.data.filter(p => inventoryIds.includes(p._id));
        
        if (devices.length > 0) {
          const html = devices.map(device => {
            const displayInfo = device.serialNumber || device.imei || device.barcode || 'æ— åºåˆ—å·';
            return `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background 0.2s;" 
                onmouseover="this.style.background='#e9ecef'"
                onmouseout="this.style.background='#f8f9fa'"
                onclick="addDeviceToCart('${device._id}', '${productName}', ${device.retailPrice}, '${displayInfo}', '${device.taxClassification || 'VAT_23'}')">
                <div style="font-weight: 600; margin-bottom: 5px;">
                  ${device.serialNumber ? `åºåˆ—å·: ${device.serialNumber}` : ''}
                  ${device.imei ? `IMEI: ${device.imei}` : ''}
                </div>
                <div style="color: #666; font-size: 14px;">
                  ${device.color ? `é¢œè‰²: ${device.color} Â· ` : ''}
                  ä»·æ ¼: â‚¬${device.retailPrice.toFixed(2)}
                </div>
              </div>
            `;
          }).join('');
          
          document.getElementById('deviceList').innerHTML = html;
          document.getElementById('selectDeviceModal').style.display = 'flex';
        }
      }
    }
    
    // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†ï¼ˆå•ä¸ªè®¾å¤‡ - ä¿ç•™å‘åå…¼å®¹ï¼‰
    async function showDeviceSelection(inventoryId, productName) {
      showDeviceSelectionMultiple([inventoryId], productName);
    }
    
    // å…³é—­è®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†
    function closeDeviceModal() {
      document.getElementById('selectDeviceModal').style.display = 'none';
    }
    
    // æ·»åŠ è®¾å¤‡åˆ°è´­ç‰©è½¦
    function addDeviceToCart(inventoryId, productName, price, serialNumber, taxClassification) {
      addToCart(inventoryId, productName, price, 1, taxClassification, serialNumber);
      closeDeviceModal();
    }
    
    // æ·»åŠ åˆ°è´­ç‰©è½¦
    function addToCart(inventoryId, productName, price, maxQty, taxClassification, serialNumber = null) {
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
      const existingItem = cart.find(item => item.inventoryId === inventoryId && item.serialNumber === serialNumber);
      
      if (existingItem) {
        if (existingItem.quantity < maxQty) {
          existingItem.quantity++;
        } else {
          alert('å·²è¾¾åˆ°æœ€å¤§åº“å­˜æ•°é‡');
          return;
        }
      } else {
        cart.push({
          inventoryId,
          productName,
          price,
          quantity: 1,
          maxQty,
          taxClassification,
          serialNumber
        });
      }
      
      updateCartDisplay();
      alert(`âœ… ${productName} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`);
    }
    
    // æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
    function updateCartDisplay() {
      const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('cartItemCount').textContent = itemCount;
      document.getElementById('cartTotal').textContent = 'â‚¬' + total.toFixed(2);
      
      if (cart.length > 0) {
        document.getElementById('cartSummary').style.display = 'block';
      } else {
        document.getElementById('cartSummary').style.display = 'none';
      }
    }
    
    // æ¸…ç©ºè´­ç‰©è½¦
    function clearCart() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
        cart = [];
        updateCartDisplay();
      }
    }
    
    // æ˜¾ç¤ºç»“è´¦æ¨¡æ€æ¡†
    function showCheckoutModal() {
      if (cart.length === 0) {
        alert('è´­ç‰©è½¦ä¸ºç©º');
        return;
      }
      
      // æ˜¾ç¤ºè´­ç‰©è½¦æ˜ç»†
      const itemsHtml = cart.map(item => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
          <div>
            <div style="font-weight: 600;">${item.productName}</div>
            ${item.serialNumber ? `<div style="font-size: 12px; color: #666;">SN: ${item.serialNumber}</div>` : ''}
            <div style="font-size: 14px; color: #666;">â‚¬${item.price.toFixed(2)} Ã— ${item.quantity}</div>
          </div>
          <div style="font-weight: 600; color: #2563eb;">
            â‚¬${(item.price * item.quantity).toFixed(2)}
          </div>
        </div>
      `).join('');
      
      document.getElementById('checkoutCartItems').innerHTML = itemsHtml;
      
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('checkoutTotal').textContent = 'â‚¬' + total.toFixed(2);
      
      // é‡ç½®æ”¯ä»˜æ–¹å¼
      selectedPaymentMethod = null;
      document.querySelectorAll('[id^="payBtn_"]').forEach(btn => {
        btn.style.borderColor = '#ddd';
        btn.style.background = 'white';
      });
      document.getElementById('mixedPaymentInputs').style.display = 'none';
      document.getElementById('customerPhone').value = '';
      
      document.getElementById('checkoutModal').style.display = 'flex';
    }
    
    // å…³é—­ç»“è´¦æ¨¡æ€æ¡†
    function closeCheckoutModal() {
      document.getElementById('checkoutModal').style.display = 'none';
    }
    
    // é€‰æ‹©æ”¯ä»˜æ–¹å¼
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('[id^="payBtn_"]').forEach(btn => {
        btn.style.borderColor = '#ddd';
        btn.style.background = 'white';
      });
      document.getElementById(`payBtn_${method}`).style.borderColor = '#3b82f6';
      document.getElementById(`payBtn_${method}`).style.background = '#eff6ff';
      
      // æ˜¾ç¤º/éšè—æ··åˆæ”¯ä»˜è¾“å…¥
      if (method === 'MIXED') {
        document.getElementById('mixedPaymentInputs').style.display = 'block';
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        document.getElementById('cashAmount').value = (total / 2).toFixed(2);
        document.getElementById('cardAmount').value = (total / 2).toFixed(2);
      } else {
        document.getElementById('mixedPaymentInputs').style.display = 'none';
      }
    }
    
    // æ›´æ–°æ··åˆæ”¯ä»˜
    function updateMixedPayment() {
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
      const card = parseFloat(document.getElementById('cardAmount').value) || 0;
      const sum = cash + card;
      
      const warning = document.getElementById('mixedPaymentWarning');
      if (Math.abs(sum - total) > 0.01) {
        warning.textContent = `âš ï¸ æ”¯ä»˜æ€»é¢ â‚¬${sum.toFixed(2)} ä¸è®¢å•æ€»é¢ â‚¬${total.toFixed(2)} ä¸ç¬¦`;
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    }
    
    // å®Œæˆé”€å”®
    async function completeSale() {
      if (!selectedPaymentMethod) {
        alert('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
        return;
      }
      
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // éªŒè¯æ··åˆæ”¯ä»˜
      if (selectedPaymentMethod === 'MIXED') {
        const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
        const card = parseFloat(document.getElementById('cardAmount').value) || 0;
        if (Math.abs((cash + card) - total) > 0.01) {
          alert('æ··åˆæ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®');
          return;
        }
      }
      
      const customerPhone = document.getElementById('customerPhone').value;
      
      // å‡†å¤‡é”€å”®æ•°æ®
      const saleData = {
        merchantId,
        customerPhone: customerPhone || null,
        paymentMethod: selectedPaymentMethod,
        items: cart.map(item => ({
          inventoryId: item.inventoryId || null,
          repairId: item.repairId || null,
          productName: item.productName,
          quantity: item.quantity,
          price: item.price,
          taxClassification: item.taxClassification,
          serialNumber: item.serialNumber
        })),
        totalAmount: total
      };
      
      // æ·»åŠ æ··åˆæ”¯ä»˜é‡‘é¢
      if (selectedPaymentMethod === 'MIXED') {
        saleData.cashAmount = parseFloat(document.getElementById('cashAmount').value);
        saleData.cardAmount = parseFloat(document.getElementById('cardAmount').value);
      }
      
      try {
        document.getElementById('completeSaleBtn').disabled = true;
        document.getElementById('completeSaleBtn').textContent = 'å¤„ç†ä¸­...';
        
        const response = await fetch(`${API_BASE}/merchant/sales/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(saleData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… é”€å”®æˆåŠŸï¼\nè®¢å•å·: ${result.data.saleId}\næ€»é‡‘é¢: â‚¬${total.toFixed(2)}`);
          cart = [];
          updateCartDisplay();
          closeCheckoutModal();
          loadStats();
          backToCategories();
          loadCategoryList();
        } else {
          alert('âŒ é”€å”®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ é”€å”®å¤±è´¥: ' + error.message);
      } finally {
        document.getElementById('completeSaleBtn').disabled = false;
        document.getElementById('completeSaleBtn').textContent = 'âœ… ç¡®è®¤æ”¯ä»˜';
      }
    }
    
    // ==================== åŸæœ‰åŠŸèƒ½ ====================
    
    // æŸ¥è¯¢é”€å”®è®°å½•
    async function querySalesRecords() {
      const startDate = document.getElementById('salesStartDate').value;
      const endDate = document.getElementById('salesEndDate').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
      }
      
      const container = document.getElementById('salesRecordsTable');
      container.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // å±•å¼€é”€å”®è®°å½•ä¸­çš„æ‰€æœ‰å•†å“
          const allItems = [];
          result.data.forEach(sale => {
            sale.items.forEach(item => {
              allItems.push({
                date: sale.date,
                productName: item.productName,
                quantity: item.quantity,
                price: item.price,
                costPrice: item.costPrice,
                taxClassification: item.taxClassification,
                taxAmount: item.taxAmount,
                paymentMethod: sale.paymentMethod,
                cashAmount: sale.cashAmount,
                cardAmount: sale.cardAmount,
                customerPhone: sale.customerPhone,
                serialNumber: item.serialNumber
              });
            });
          });
          
          if (allItems.length > 0) {
            const html = `
              <table>
                <thead>
                  <tr>
                    <th>æ—¥æœŸ</th>
                    <th>äº§å“</th>
                    <th>åºåˆ—å·</th>
                    <th>æ•°é‡</th>
                    <th>å•ä»·</th>
                    <th>é”€å”®é¢</th>
                    <th>æˆæœ¬</th>
                    <th>ç¨é¢</th>
                    <th>ç¨åŠ¡åˆ†ç±»</th>
                    <th>æ”¯ä»˜æ–¹å¼</th>
                    <th>å®¢æˆ·</th>
                  </tr>
                </thead>
                <tbody>
                  ${allItems.map(item => `
                    <tr>
                      <td>${new Date(item.date).toLocaleDateString('zh-CN')} ${new Date(item.date).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</td>
                      <td><strong>${item.productName}</strong></td>
                      <td style="font-size: 11px; color: #666;">${item.serialNumber || '-'}</td>
                      <td>${item.quantity}</td>
                      <td>â‚¬${item.price.toFixed(2)}</td>
                      <td><strong>â‚¬${(item.price * item.quantity).toFixed(2)}</strong></td>
                      <td>â‚¬${(item.costPrice * item.quantity).toFixed(2)}</td>
                      <td>â‚¬${item.taxAmount.toFixed(2)}</td>
                      <td>${getTaxBadge(item.taxClassification)}</td>
                      <td>${getPaymentBadge(item.paymentMethod, item.cashAmount, item.cardAmount)}</td>
                      <td style="font-size: 12px;">${item.customerPhone || '-'}</td>
                    </tr>
                  `).join('')}
                  <tr style="font-weight: bold; background: #f8f9fa;">
                    <td colspan="5" style="text-align: right;">åˆè®¡ï¼š</td>
                    <td>â‚¬${allItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}</td>
                    <td>â‚¬${allItems.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0).toFixed(2)}</td>
                    <td>â‚¬${allItems.reduce((sum, item) => sum + item.taxAmount, 0).toFixed(2)}</td>
                    <td colspan="3">-</td>
                  </tr>
                </tbody>
              </table>
              <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                  <div>
                    <div style="font-size: 12px; color: #666;">é”€å”®è®°å½•æ•°</div>
                    <div style="font-size: 20px; font-weight: bold; color: #2563eb;">${result.data.length}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">å•†å“æ€»æ•°</div>
                    <div style="font-size: 20px; font-weight: bold; color: #2563eb;">${allItems.reduce((sum, item) => sum + item.quantity, 0)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">æ€»åˆ©æ¶¦</div>
                    <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${allItems.reduce((sum, item) => sum + ((item.price - item.costPrice) * item.quantity), 0).toFixed(2)}</div>
                  </div>
                </div>
              </div>
            `;
            container.innerHTML = html;
          } else {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®è®°å½•</p>';
          }
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®è®°å½•</p>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        console.error('æŸ¥è¯¢é”€å”®è®°å½•å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
      }
    }

    // å…¨å±€å˜é‡å­˜å‚¨åº“å­˜æ•°æ®
    let allInventoryData = [];
    let allInventoryDataIncludingZero = []; // åŒ…å«é›¶åº“å­˜çš„å®Œæ•´æ•°æ®ï¼Œç”¨äºæœç´¢
    
    // åŠ è½½æˆ‘çš„åº“å­˜ï¼ˆåˆ†ç±»è§†å›¾ï¼‰
    async function loadMyInventory() {
      const container = document.getElementById('inventoryCategoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // ä¿å­˜å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬é›¶åº“å­˜ï¼‰ç”¨äºæœç´¢
          allInventoryDataIncludingZero = result.data;
          
          // è¿‡æ»¤æ‰æ•°é‡ä¸º0çš„äº§å“ç”¨äºåˆ†ç±»æ˜¾ç¤º
          allInventoryData = result.data.filter(item => item.quantity > 0);
          
          if (allInventoryData.length === 0) {
            container.innerHTML = `
              <p style="text-align: center; color: #999; padding: 40px;">
                æš‚æ— å¯ç”¨åº“å­˜<br>
                <small>ç‚¹å‡»ä¸Šæ–¹"+ æ‰‹åŠ¨å…¥åº“"æŒ‰é’®æ·»åŠ äº§å“</small>
              </p>
            `;
            return;
          }
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categoryMap = {};
          allInventoryData.forEach(item => {
            const category = item.category || 'æœªåˆ†ç±»';
            if (!categoryMap[category]) {
              categoryMap[category] = [];
            }
            categoryMap[category].push(item);
          });
          
          // æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡
          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">';
          
          Object.keys(categoryMap).sort().forEach(category => {
            const items = categoryMap[category];
            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
            
            html += `
              <div onclick="showInventoryCategory('${category}')" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¦</div>
                <h3 style="font-size: 18px; margin-bottom: 10px;">${category}</h3>
                <div style="font-size: 14px; opacity: 0.9;">
                  ${items.length} ç§äº§å“ Â· ${totalQty} ä»¶åº“å­˜
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
              <h3 style="color: #856404; margin-bottom: 10px;">ğŸ“¦ æ‰¹å‘å•†ç‹¬ç«‹åº“å­˜ç³»ç»Ÿ</h3>
              <p style="color: #856404; margin: 0;">
                è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯æ‚¨ä½œä¸ºæ‰¹å‘å•†åœ¨è‡ªå·±åº—é“ºä¸­çš„åº“å­˜ï¼Œä¸ä»“åº“åº“å­˜æ˜¯ç‹¬ç«‹ç®¡ç†çš„ã€‚<br>
                æ‚¨å¯ä»¥é€šè¿‡"æ‰‹åŠ¨å…¥åº“"æˆ–"ä»“åº“è®¢è´§"åŠŸèƒ½æ·»åŠ äº§å“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚
              </p>
            </div>
            <p style="text-align: center; color: #999; padding: 40px;">
              æš‚æ— åº“å­˜æ•°æ®<br>
              <small>ç‚¹å‡»ä¸Šæ–¹"+ æ‰‹åŠ¨å…¥åº“"æŒ‰é’®æ·»åŠ äº§å“</small>
            </p>
          `;
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºæŸä¸ªåˆ†ç±»çš„äº§å“
    function showInventoryCategory(category) {
      document.getElementById('inventoryCategoryList').style.display = 'none';
      document.getElementById('inventoryProductList').style.display = 'block';
      document.getElementById('currentInventoryCategoryName').textContent = `ğŸ“¦ ${category}`;
      
      const products = allInventoryData.filter(item => (item.category || 'æœªåˆ†ç±»') === category);
      displayInventoryProducts(products);
    }
    
    // è¿”å›åˆ†ç±»åˆ—è¡¨
    function backToInventoryCategories() {
      document.getElementById('inventoryCategoryList').style.display = 'block';
      document.getElementById('inventoryProductList').style.display = 'none';
      document.getElementById('inventorySearchInput').value = '';
    }
    
    // æ˜¾ç¤ºäº§å“åˆ—è¡¨
    function displayInventoryProducts(products) {
      const container = document.getElementById('inventoryProducts');
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°äº§å“</p>';
        return;
      }
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>äº§å“åç§°</th>
              <th>å“ç‰Œ/å‹å·</th>
              <th>åº“å­˜æ•°é‡</th>
              <th>æˆæœ¬ä»·</th>
              <th>é›¶å”®ä»·</th>
              <th>ç¨åŠ¡åˆ†ç±»</th>
              <th>åºåˆ—å·/æ¡ç </th>
              <th>å¤‡æ³¨</th>
            </tr>
          </thead>
          <tbody>
            ${products.map(item => `
              <tr ${item.quantity === 0 ? 'style="background: #fff3cd; cursor: pointer;"' : 'style="cursor: pointer;"'}
                  onclick="showProductTimeline('${item._id}', '${item.productName}')"
                  onmouseover="this.style.background='${item.quantity === 0 ? '#ffe69c' : '#f0f9ff'}'"
                  onmouseout="this.style.background='${item.quantity === 0 ? '#fff3cd' : ''}'">
                <td><strong>${item.productName}</strong></td>
                <td>${item.brand || '-'} ${item.model || ''}</td>
                <td>
                  <strong style="color: ${item.quantity === 0 ? '#dc3545' : '#10b981'};">
                    ${item.quantity}
                  </strong>
                  ${item.quantity === 0 ? '<br><small style="color: #856404;">å·²å”®å®Œ</small>' : ''}
                </td>
                <td>â‚¬${item.costPrice.toFixed(2)}</td>
                <td>â‚¬${item.retailPrice.toFixed(2)}</td>
                <td>${getTaxBadge(item.taxClassification)}</td>
                <td style="font-size: 11px; color: #666;">
                  ${item.serialNumber || item.barcode || '-'}
                </td>
                <td style="font-size: 12px; color: #666; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.notes || ''}">
                  ${item.notes || '-'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      container.innerHTML = html;
    }
    
    // æœç´¢åº“å­˜
    function searchInventory() {
      const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œè¿”å›åˆ†ç±»è§†å›¾
        backToInventoryCategories();
        return;
      }
      
      // æœç´¢äº§å“åç§°ã€åºåˆ—å·ã€æ¡ç ã€å¤‡æ³¨ï¼ˆåŒ…æ‹¬é›¶åº“å­˜äº§å“ï¼‰
      const filteredProducts = allInventoryDataIncludingZero.filter(item => {
        return (
          (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
          (item.serialNumber && item.serialNumber.toLowerCase().includes(searchTerm)) ||
          (item.barcode && item.barcode.toLowerCase().includes(searchTerm)) ||
          (item.notes && item.notes.toLowerCase().includes(searchTerm))
        );
      });
      
      // æ˜¾ç¤ºæœç´¢ç»“æœ
      document.getElementById('inventoryCategoryList').style.display = 'none';
      document.getElementById('inventoryProductList').style.display = 'block';
      document.getElementById('currentInventoryCategoryName').textContent = `ğŸ” æœç´¢ç»“æœ: "${searchTerm}"`;
      displayInventoryProducts(filteredProducts);
    }

    // æ˜¾ç¤ºå…¥åº“æ¨¡æ€æ¡†
    async function showAddInventoryModal() {
      document.getElementById('addInventoryModal').style.display = 'flex';
      document.getElementById('addInventoryForm').reset();
      
      // æ˜¾ç¤ºå½“å‰å•†æˆ·ä¿¡æ¯
      const merchantInfo = document.getElementById('currentMerchantInfo');
      merchantInfo.textContent = `${merchantId} (å½“å‰ç™»å½•å•†æˆ·)`;
      
      // åŠ è½½åˆ†ç±»åˆ—è¡¨
      await loadCategoriesForInventory();
      
      // åŠ è½½æˆè‰²åˆ—è¡¨
      await loadConditionsForInventory();
    }
    
    // åŠ è½½åˆ†ç±»åˆ—è¡¨ï¼ˆç”¨äºå…¥åº“è¡¨å•ï¼‰
    async function loadCategoriesForInventory() {
      try {
        const response = await fetch(`${API_BASE}/admin/categories`);
        const result = await response.json();
        
        const select = document.getElementById('inv_category');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»...</option>';
        
        if (result.success && result.data && result.data.length > 0) {
          result.data.forEach(category => {
            const option = document.createElement('option');
            option.value = category.type;
            option.textContent = category.type;
            select.appendChild(option);
          });
        } else {
          // å¦‚æœæ²¡æœ‰åˆ†ç±»ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
          const defaultCategories = ['æ‰‹æœºé…ä»¶', 'ç”µè„‘é…ä»¶', 'è½¦è½½é…ä»¶', 'æ•°æ®çº¿', 'Audio', 'Power Supply'];
          defaultCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        // æ·»åŠ é»˜è®¤é€‰é¡¹
        const select = document.getElementById('inv_category');
        const defaultCategories = ['æ‰‹æœºé…ä»¶', 'ç”µè„‘é…ä»¶', 'è½¦è½½é…ä»¶', 'æ•°æ®çº¿', 'Audio', 'Power Supply'];
        defaultCategories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      }
    }
    
    // åŠ è½½æˆè‰²åˆ—è¡¨ï¼ˆç”¨äºå…¥åº“è¡¨å•ï¼‰
    async function loadConditionsForInventory() {
      try {
        const response = await fetch(`${API_BASE}/admin/conditions`);
        const result = await response.json();
        
        const select = document.getElementById('inv_condition');
        select.innerHTML = '';
        
        if (result.success && result.data && result.data.length > 0) {
          result.data.forEach(condition => {
            const option = document.createElement('option');
            option.value = condition.code;
            option.textContent = condition.name;
            if (condition.code === 'BRAND_NEW') {
              option.selected = true;
            }
            select.appendChild(option);
          });
        } else {
          // å¦‚æœæ²¡æœ‰æˆè‰²ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
          select.innerHTML = `
            <option value="BRAND_NEW" selected>å…¨æ–°</option>
            <option value="PRE_OWNED">äºŒæ‰‹</option>
            <option value="REFURBISHED">ç¿»æ–°</option>
          `;
        }
      } catch (error) {
        console.error('åŠ è½½æˆè‰²å¤±è´¥:', error);
        // æ·»åŠ é»˜è®¤é€‰é¡¹
        const select = document.getElementById('inv_condition');
        select.innerHTML = `
          <option value="BRAND_NEW" selected>å…¨æ–°</option>
          <option value="PRE_OWNED">äºŒæ‰‹</option>
          <option value="REFURBISHED">ç¿»æ–°</option>
        `;
      }
    }

    // å…³é—­å…¥åº“æ¨¡æ€æ¡†
    function closeAddInventoryModal() {
      document.getElementById('addInventoryModal').style.display = 'none';
    }

    // æäº¤å…¥åº“è¡¨å•
    async function submitAddInventory(event) {
      event.preventDefault();
      
      const formData = {
        merchantId: merchantId,
        productName: document.getElementById('inv_productName').value,
        brand: document.getElementById('inv_brand').value,
        model: document.getElementById('inv_model').value,
        category: document.getElementById('inv_category').value,
        quantity: parseInt(document.getElementById('inv_quantity').value),
        costPrice: parseFloat(document.getElementById('inv_costPrice').value),
        wholesalePrice: parseFloat(document.getElementById('inv_wholesalePrice').value),
        retailPrice: parseFloat(document.getElementById('inv_retailPrice').value),
        barcode: document.getElementById('inv_barcode').value,
        serialNumber: document.getElementById('inv_serialNumber').value,
        color: document.getElementById('inv_color').value,
        condition: document.getElementById('inv_condition').value,
        notes: document.getElementById('inv_notes').value
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å…¥åº“æˆåŠŸï¼');
          closeAddInventoryModal();
          loadMyInventory(); // åˆ·æ–°åº“å­˜åˆ—è¡¨
          loadStats(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        } else {
          alert('âŒ å…¥åº“å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ å…¥åº“å¤±è´¥: ' + error.message);
      }
    }

    // å…¨å±€å˜é‡å­˜å‚¨ä»“åº“äº§å“æ•°æ®
    let allWarehouseData = [];
    
    // ==================== ç¾¤ç»„åº“å­˜åŠŸèƒ½ ====================
    
    let allGroupInventoryData = [];
    
    // åŠ è½½ç¾¤ç»„åº“å­˜ï¼ˆåˆ†ç±»è§†å›¾ï¼‰
    async function loadGroupInventory() {
      const container = document.getElementById('groupInventoryCategoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/group-inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // åªä¿ç•™å¯é”€å”®çš„äº§å“
          allGroupInventoryData = result.data.filter(item => 
            item.quantity > 0 && item.status === 'active'
          );
          
          if (allGroupInventoryData.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç¾¤ç»„å†…æš‚æ— å¯é”€å”®äº§å“</p>';
            return;
          }
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categoryMap = {};
          allGroupInventoryData.forEach(item => {
            const category = item.category || 'æœªåˆ†ç±»';
            if (!categoryMap[category]) {
              categoryMap[category] = {
                name: category,
                count: 0,
                totalQty: 0,
                merchants: new Set()
              };
            }
            categoryMap[category].count++;
            categoryMap[category].totalQty += item.quantity;
            categoryMap[category].merchants.add(item.merchantId);
          });
          
          const categoryArray = Object.values(categoryMap);
          
          let html = `
            <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 20px;">
              <h3 style="color: #0c5460; margin-bottom: 10px;">ğŸ‘¥ ç¾¤ç»„åº“å­˜</h3>
              <p style="color: #0c5460; margin: 0;">
                æŸ¥çœ‹åŒä¸€ç¾¤ç»„å†…å…¶ä»–å•†æˆ·çš„åº“å­˜ã€‚ç‚¹å‡»åˆ†ç±»æŸ¥çœ‹è¯¦ç»†äº§å“åˆ—è¡¨ã€‚
              </p>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
          `;
          
          categoryArray.forEach(cat => {
            html += `
              <div onclick="showGroupCategory('${cat.name}')" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¦</div>
                <h3 style="font-size: 18px; margin-bottom: 10px;">${cat.name}</h3>
                <div style="font-size: 14px; opacity: 0.9;">
                  ${cat.count} ç§äº§å“ Â· ${cat.totalQty} ä»¶åº“å­˜<br>
                  ${cat.merchants.size} ä¸ªå•†æˆ·
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç¾¤ç»„å†…æš‚æ— å…¶ä»–å•†æˆ·åº“å­˜</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç¾¤ç»„åº“å­˜å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºæŸä¸ªåˆ†ç±»çš„ç¾¤ç»„äº§å“
    function showGroupCategory(category) {
      document.getElementById('groupInventoryCategoryList').style.display = 'none';
      document.getElementById('groupInventoryProductList').style.display = 'block';
      document.getElementById('currentGroupCategoryName').textContent = `ğŸ“¦ ${category}`;
      
      const products = allGroupInventoryData.filter(item => 
        (item.category || 'æœªåˆ†ç±»') === category
      );
      
      displayGroupInventoryProducts(products);
    }
    
    // è¿”å›ç¾¤ç»„åˆ†ç±»åˆ—è¡¨
    function backToGroupCategories() {
      document.getElementById('groupInventoryCategoryList').style.display = 'block';
      document.getElementById('groupInventoryProductList').style.display = 'none';
      document.getElementById('groupInventorySearchInput').value = '';
    }
    
    // æ˜¾ç¤ºç¾¤ç»„åº“å­˜äº§å“åˆ—è¡¨
    function displayGroupInventoryProducts(products) {
      const container = document.getElementById('groupInventoryTable');
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯¥åˆ†ç±»æš‚æ— äº§å“</p>';
        return;
      }
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>å•†æˆ·</th>
              <th>äº§å“åç§°</th>
              <th>å“ç‰Œ/å‹å·</th>
              <th>é¢œè‰²</th>
              <th>åºåˆ—å·/IMEI</th>
              <th>æ•°é‡</th>
              <th>é›¶å”®ä»·</th>
            </tr>
          </thead>
          <tbody>
            ${products.map(item => `
              <tr>
                <td><strong>${item.merchantId}</strong></td>
                <td>${item.productName}</td>
                <td>${item.brand || ''} ${item.model || ''}</td>
                <td>${item.color || '-'}</td>
                <td style="font-size: 11px; color: #666;">${item.serialNumber || item.imei || item.barcode || '-'}</td>
                <td>${item.quantity}</td>
                <td>â‚¬${item.retailPrice.toFixed(2)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
          <div style="font-size: 14px; color: #1e40af;">
            <strong>ğŸ’¡ æç¤ºï¼š</strong> å¦‚éœ€è°ƒè´§è¯·è”ç³»å¯¹åº”å•†æˆ·
          </div>
        </div>
      `;
      container.innerHTML = html;
    }
    
    // æœç´¢ç¾¤ç»„åº“å­˜
    function searchGroupInventory() {
      const searchTerm = document.getElementById('groupInventorySearchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#groupInventoryTable tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    }
    
    // ==================== ä»“åº“è®¢è´§åŠŸèƒ½ ====================
    
    // åŠ è½½ä»“åº“äº§å“ï¼ˆåˆ†ç±»è§†å›¾ï¼‰
    async function loadWarehouseProducts() {
      const container = document.getElementById('warehouseCategoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        console.log('ğŸ” å¼€å§‹åŠ è½½ä»“åº“äº§å“...');
        const url = `${API_BASE}/merchant/warehouse-products`;
        console.log('ğŸ“¡ è¯·æ±‚ URL:', url);
        
        const response = await fetch(url);
        console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);
        
        const result = await response.json();
        console.log('ğŸ“¦ API è¿”å›æ•°æ®:', result);
        console.log('ğŸ“Š äº§å“æ•°é‡:', result.data?.length);
        
        if (result.success && result.data.length > 0) {
          // åªä¿ç•™å¯é”€å”®çš„äº§å“ï¼ˆtotalAvailable > 0ï¼‰
          allWarehouseData = result.data.filter(group => group.totalAvailable > 0);
          console.log('âœ… å¯è®¢è´­äº§å“æ•°é‡:', allWarehouseData.length);
          
          if (allWarehouseData.length === 0) {
            container.innerHTML = `
              <p style="text-align: center; color: #999; padding: 40px;">
                ä»“åº“æš‚æ— å¯è®¢è´­äº§å“
              </p>
            `;
            return;
          }
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categoryMap = {};
          allWarehouseData.forEach(group => {
            const category = group.category || 'æœªåˆ†ç±»';
            if (!categoryMap[category]) {
              categoryMap[category] = [];
            }
            categoryMap[category].push(group);
          });
          
          console.log('ğŸ“‚ åˆ†ç±»:', Object.keys(categoryMap));
          
          // æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡
          let html = `
            <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 20px;">
              <h3 style="color: #0c5460; margin-bottom: 10px;">ğŸ­ ä»ä»“åº“è®¢è´§</h3>
              <p style="color: #0c5460; margin: 0;">
                ä»¥ä¸‹æ˜¯ä»“åº“ä¸­å¯ä¾›é‡‡è´­çš„äº§å“ã€‚é€‰æ‹©åˆ†ç±»æŸ¥çœ‹äº§å“è¯¦æƒ…ã€‚<br>
                è®¢å•ç¡®è®¤åï¼Œäº§å“å°†ä»ä»“åº“è½¬ç§»åˆ°æ‚¨çš„æ‰¹å‘å•†åº“å­˜ä¸­ã€‚
              </p>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
          `;
          
          Object.keys(categoryMap).sort().forEach(category => {
            const groups = categoryMap[category];
            const totalProducts = groups.length;
            const totalQty = groups.reduce((sum, group) => sum + group.totalAvailable, 0);
            
            html += `
              <div onclick="showWarehouseCategory('${category}')" 
                style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ­</div>
                <h3 style="font-size: 18px; margin-bottom: 10px;">${category}</h3>
                <div style="font-size: 14px; opacity: 0.9;">
                  ${totalProducts} ç§äº§å“ Â· ${totalQty} ä»¶å¯è®¢
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
          console.log('âœ… ä»“åº“äº§å“åŠ è½½å®Œæˆ');
        } else {
          console.log('âš ï¸ æ²¡æœ‰äº§å“æ•°æ®');
          container.innerHTML = `
            <p style="text-align: center; color: #999; padding: 40px;">
              ä»“åº“æš‚æ— å¯è®¢è´­äº§å“
            </p>
          `;
        }
      } catch (error) {
        console.error('âŒ åŠ è½½ä»“åº“äº§å“å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºæŸä¸ªåˆ†ç±»çš„ä»“åº“äº§å“
    function showWarehouseCategory(category) {
      // åªåˆ‡æ¢å·¦ä¾§å†…å®¹ï¼Œè´­ç‰©è½¦ä¿æŒæ˜¾ç¤º
      document.getElementById('warehouseCategoryListView').style.display = 'none';
      document.getElementById('warehouseProductList').style.display = 'block';
      document.getElementById('currentWarehouseCategoryName').textContent = `ğŸ­ ${category}`;
      
      const products = allWarehouseData.filter(group => (group.category || 'æœªåˆ†ç±»') === category);
      displayWarehouseProducts(products);
    }
    
    // è¿”å›ä»“åº“åˆ†ç±»åˆ—è¡¨
    function backToWarehouseCategories() {
      // åªåˆ‡æ¢å·¦ä¾§å†…å®¹ï¼Œè´­ç‰©è½¦ä¿æŒæ˜¾ç¤º
      document.getElementById('warehouseCategoryListView').style.display = 'block';
      document.getElementById('warehouseProductList').style.display = 'none';
    }
    
    // æ˜¾ç¤ºä»“åº“äº§å“åˆ—è¡¨
    function displayWarehouseProducts(products) {
      const container = document.getElementById('warehouseProducts');
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°äº§å“</p>';
        return;
      }
      
      const html = `
        <table style="width: 100%; table-layout: auto;">
          <thead>
            <tr>
              <th style="min-width: 120px;">äº§å“ç±»å‹</th>
              <th style="min-width: 150px;">å“ç‰Œ/å‹å·</th>
              <th style="min-width: 80px;">é¢œè‰²</th>
              <th style="min-width: 80px; text-align: center;">å¯ç”¨æ•°é‡</th>
              <th style="min-width: 100px; text-align: right;">æ‰¹å‘ä»·</th>
              <th style="min-width: 100px; text-align: right;">å»ºè®®é›¶å”®ä»·</th>
              <th style="min-width: 120px;">ç¨åŠ¡åˆ†ç±»</th>
              <th style="min-width: 100px; text-align: center;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${products.map((group, index) => {
              const displayName = `${group.brand || ''} ${group.model || ''}`.trim() || group.productType;
              const colorDisplay = group.color || '-';
              return `
              <tr>
                <td><strong>${group.productType}</strong></td>
                <td>${displayName}</td>
                <td>${colorDisplay}</td>
                <td style="text-align: center;"><strong style="color: #10b981;">${group.totalAvailable}</strong></td>
                <td style="text-align: right;">â‚¬${group.wholesalePrice.toFixed(2)}</td>
                <td style="text-align: right;">â‚¬${group.suggestedRetailPrice.toFixed(2)}</td>
                <td>${getTaxBadge(group.taxClassification)}</td>
                <td style="text-align: center;">
                  <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" 
                    onclick="addToWarehouseCartFromTable('${group.products[0]._id}', '${displayName}${colorDisplay !== '-' ? ' - ' + colorDisplay : ''}', ${group.wholesalePrice}, ${group.totalAvailable})">
                    ğŸ›’ åŠ å…¥è´­ç‰©è½¦
                  </button>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
      container.innerHTML = html;
    }
    
    // ä»è¡¨æ ¼æ·»åŠ åˆ°è´­ç‰©è½¦
    function addToWarehouseCartFromTable(productId, productName, price, maxQuantity) {
      const quantity = prompt(`è¯·è¾“å…¥è®¢è´­æ•°é‡ï¼ˆå¯ç”¨: ${maxQuantity}ï¼‰:`, '1');
      
      if (!quantity) return;
      
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      if (qty > maxQuantity) {
        alert(`è®¢è´­æ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨æ•°é‡ ${maxQuantity}`);
        return;
      }
      
      // æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²æœ‰è¯¥äº§å“
      const existingItem = warehouseCart.find(item => item.productId === productId);
      
      if (existingItem) {
        const newQty = existingItem.quantity + qty;
        if (newQty > maxQuantity) {
          alert(`è´­ç‰©è½¦ä¸­å·²æœ‰ ${existingItem.quantity} ä»¶ï¼Œæœ€å¤šå¯è®¢è´­ ${maxQuantity} ä»¶`);
          return;
        }
        existingItem.quantity = newQty;
      } else {
        warehouseCart.push({
          productId,
          productName,
          price,
          quantity: qty,
          maxQuantity
        });
      }
      
      updateWarehouseCart();
      alert(`å·²æ·»åŠ  ${qty} ä»¶ ${productName} åˆ°è´­ç‰©è½¦`);
    }

    // åŠ è½½é”€å”®è®°å½•
    async function loadSales() {
      const container = document.getElementById('salesTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>äº§å“</th>
                  <th>ç±»åˆ«</th>
                  <th>æ•°é‡</th>
                  <th>é”€å”®é¢</th>
                  <th>æˆæœ¬</th>
                  <th>ç¨é¢</th>
                  <th>æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.slice(0, 50).map(sale => `
                  <tr>
                    <td>${new Date(sale.date).toLocaleDateString('zh-CN')}</td>
                    <td>${sale.productName}</td>
                    <td>${getCategoryBadge(sale.category)}</td>
                    <td>${sale.quantity}</td>
                    <td>â‚¬${(sale.salePrice * sale.quantity).toFixed(2)}</td>
                    <td>â‚¬${(sale.costPrice * sale.quantity).toFixed(2)}</td>
                    <td>â‚¬${sale.taxAmount.toFixed(2)}</td>
                    <td>${getPaymentBadge(sale.paymentMethod)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${result.data.length > 50 ? `<p style="text-align: center; color: #666; margin-top: 10px;">æ˜¾ç¤ºæœ€è¿‘50æ¡è®°å½•ï¼Œå…±${result.data.length}æ¡</p>` : ''}
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— é”€å”®è®°å½•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½ç»´ä¿®è®°å½•
    async function loadRepairs() {
      const container = document.getElementById('repairsTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>å®¢æˆ·</th>
                  <th>ç»´ä¿®é¡¹ç›®</th>
                  <th>é‡‘é¢</th>
                  <th>ç¨é¢</th>
                  <th>æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.slice(0, 50).map(repair => `
                  <tr>
                    <td>${new Date(repair.date).toLocaleDateString('zh-CN')}</td>
                    <td>${repair.customerName}</td>
                    <td>${repair.repairItem}</td>
                    <td>â‚¬${repair.amount.toFixed(2)}</td>
                    <td>â‚¬${repair.taxAmount.toFixed(2)}</td>
                    <td>${getPaymentBadge(repair.paymentMethod)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${result.data.length > 50 ? `<p style="text-align: center; color: #666; margin-top: 10px;">æ˜¾ç¤ºæœ€è¿‘50æ¡è®°å½•ï¼Œå…±${result.data.length}æ¡</p>` : ''}
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— ç»´ä¿®è®°å½•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½æŠ¥è¡¨
    function loadReports() {
      document.getElementById('inventoryReport').innerHTML = `
        <p style="color: #999; text-align: center; padding: 20px;">åº“å­˜æŠ¥è¡¨åŠŸèƒ½å¼€å‘ä¸­...</p>
      `;
      document.getElementById('salesReport').innerHTML = `
        <p style="color: #999; text-align: center; padding: 20px;">é”€å”®æŠ¥è¡¨åŠŸèƒ½å¼€å‘ä¸­...</p>
      `;
    }

    // ç”Ÿæˆç¨åŠ¡æŠ¥è¡¨
    async function generateTaxReport() {
      const startDate = document.getElementById('taxStartDate').value;
      const endDate = document.getElementById('taxEndDate').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
      }
      
      const container = document.getElementById('taxReportContent');
      container.innerHTML = '<div class="loading">ç”ŸæˆæŠ¥è¡¨ä¸­...</div>';
      
      try {
        const response = await fetch(
          `${API_BASE}/merchant/tax-report?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`
        );
        const result = await response.json();
        
        if (result.success) {
          const data = result.data;
          const { dailySales, summary, taxByClassification } = data;
          
          // ç”Ÿæˆæ—¥é”€å”®è¡¨æ ¼
          const dailyTable = dailySales.length > 0 ? `
            <table style="margin-bottom: 30px;">
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>é”€å”®é¢</th>
                  <th>ç°é‡‘æ”¶å…¥</th>
                  <th>åˆ·å¡æ”¶å…¥</th>
                </tr>
              </thead>
              <tbody>
                ${dailySales.map(day => `
                  <tr>
                    <td>${new Date(day.date).toLocaleDateString('zh-CN')}</td>
                    <td>â‚¬${day.totalSales.toFixed(2)}</td>
                    <td>â‚¬${day.cashIncome.toFixed(2)}</td>
                    <td>â‚¬${day.cardIncome.toFixed(2)}</td>
                  </tr>
                `).join('')}
                <tr style="font-weight: bold; background: #e9ecef;">
                  <td>åˆè®¡</td>
                  <td>â‚¬${summary.totalSales.toFixed(2)}</td>
                  <td>â‚¬${summary.totalCashIncome.toFixed(2)}</td>
                  <td>â‚¬${summary.totalCardIncome.toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
          ` : '<p style="color: #999; text-align: center; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®æ•°æ®</p>';
          
          container.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
              <h3 style="margin-bottom: 20px;">ç¨åŠ¡æŠ¥è¡¨ (${startDate} è‡³ ${endDate})</h3>
              
              ${dailyTable}
              
              <h4 style="margin: 20px 0 10px 0;">ç¨åŠ¡è®¡ç®—æ˜ç»†</h4>
              <table>
                <thead>
                  <tr>
                    <th>ç¨åŠ¡åˆ†ç±»</th>
                    <th>é”€å”®é¢</th>
                    <th>é”€é¡¹ç¨</th>
                    <th>æˆæœ¬</th>
                    <th>è¿›é¡¹ç¨</th>
                    <th>åº”ç¼´ç¨é¢</th>
                  </tr>
                </thead>
                <tbody>
                  ${taxByClassification.VAT_23.sales > 0 ? `
                    <tr>
                      <td>VAT 23%</td>
                      <td>â‚¬${taxByClassification.VAT_23.sales.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.VAT_23.outputTax.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.VAT_23.cost.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.VAT_23.inputTax.toFixed(2)}</td>
                      <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.VAT_23.due.toFixed(2)}</td>
                    </tr>
                  ` : ''}
                  ${taxByClassification.SERVICE_VAT_13_5.sales > 0 ? `
                    <tr>
                      <td>Service VAT 13.5%</td>
                      <td>â‚¬${taxByClassification.SERVICE_VAT_13_5.sales.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.SERVICE_VAT_13_5.due.toFixed(2)}</td>
                      <td>-</td>
                      <td>-</td>
                      <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.SERVICE_VAT_13_5.due.toFixed(2)}</td>
                    </tr>
                  ` : ''}
                  ${taxByClassification.MARGIN_VAT_0.sales > 0 ? `
                    <tr>
                      <td>Margin VAT</td>
                      <td>â‚¬${taxByClassification.MARGIN_VAT_0.sales.toFixed(2)}</td>
                      <td>-</td>
                      <td>â‚¬${taxByClassification.MARGIN_VAT_0.cost.toFixed(2)}</td>
                      <td>-</td>
                      <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.MARGIN_VAT_0.due.toFixed(2)}</td>
                    </tr>
                  ` : ''}
                  <tr style="font-weight: bold; background: #fff3cd;">
                    <td colspan="5" style="text-align: right;">æ€»åº”ç¼´ç¨é¢ï¼š</td>
                    <td style="color: #dc3545; font-size: 18px;">â‚¬${summary.totalTaxDue.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
              
              <div style="margin-top: 20px; padding: 15px; background: white; border-left: 4px solid #6366f1;">
                <p style="margin: 0; color: #666;">
                  <strong>è®¡ç®—è¯´æ˜ï¼š</strong><br>
                  â€¢ VAT 23%: é”€é¡¹ç¨ = é”€å”®é¢Ã—23/123, è¿›é¡¹ç¨ = æˆæœ¬Ã—23/123, åº”ç¼´ = é”€é¡¹ç¨ - è¿›é¡¹ç¨<br>
                  â€¢ Service VAT 13.5%: åº”ç¼´ç¨ = é‡‘é¢Ã—13.5/113.5<br>
                  â€¢ Margin VAT: åº”ç¼´ç¨ = (é”€å”®é¢ - æˆæœ¬)Ã—23/123
                </p>
              </div>
            </div>
          `;
          
          if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">ç”ŸæˆæŠ¥è¡¨å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // è¾…åŠ©å‡½æ•°
    function getCategoryBadge(category) {
      const badges = {
        'NEW_DEVICE': '<span class="badge badge-success">å…¨æ–°è®¾å¤‡</span>',
        'USED_DEVICE': '<span class="badge badge-warning">äºŒæ‰‹è®¾å¤‡</span>',
        'ACCESSORY': '<span class="badge badge-info">é…ä»¶</span>'
      };
      return badges[category] || category;
    }
    
    function getPaymentBadge(method, cashAmount, cardAmount) {
      if (method === 'MIXED' && cashAmount !== undefined && cardAmount !== undefined) {
        return `<span class="badge badge-warning">æ··åˆ</span><br><small style="color: #666;">ç°é‡‘â‚¬${cashAmount.toFixed(2)}<br>åˆ·å¡â‚¬${cardAmount.toFixed(2)}</small>`;
      }
      const badges = {
        'CASH': '<span class="badge badge-info">ç°é‡‘</span>',
        'CARD': '<span class="badge badge-primary">åˆ·å¡</span>',
        'MIXED': '<span class="badge badge-warning">æ··åˆ</span>'
      };
      return badges[method] || method;
    }
    
    function getTaxBadge(tax) {
      const badges = {
        'VAT_23': '<span class="badge badge-primary">VAT 23%</span>',
        'MARGIN_VAT_0': '<span class="badge badge-info">Margin VAT</span>',
        'SERVICE_VAT_13_5': '<span class="badge badge-warning">Service 13.5%</span>'
      };
      return badges[tax] || tax;
    }
    
    function getStatusBadge(status) {
      const badges = {
        'ACTIVE': '<span class="badge badge-success">æ­£å¸¸</span>',
        'LOW_STOCK': '<span class="badge badge-warning">åº“å­˜ä½</span>',
        'OUT_OF_STOCK': '<span class="badge badge-danger">ç¼ºè´§</span>'
      };
      return badges[status] || status;
    }
    
    // ä»ä»“åº“è®¢è´§
    async function orderFromWarehouse(index, productId, productName, maxQty) {
      const qtyInput = document.getElementById(`orderQty_${index}`);
      const quantity = parseInt(qtyInput.value);
      
      if (!quantity || quantity < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢è´§æ•°é‡');
        return;
      }
      
      if (quantity > maxQty) {
        alert(`è®¢è´§æ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨æ•°é‡ ${maxQty}`);
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦è®¢è´­ ${quantity} ä»¶ ${productName} å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        // åˆ›å»ºè®¢å•
        const orderResponse = await fetch(`${API_BASE}/merchant/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId,
            merchantName: 'VIPå•†æˆ·', // å®é™…åº”ä»sessionè·å–
            items: [{
              productId,
              quantity
            }]
          })
        });
        
        const orderResult = await orderResponse.json();
        
        if (!orderResult.success) {
          alert('è®¢å•åˆ›å»ºå¤±è´¥: ' + orderResult.error);
          return;
        }
        
        // è‡ªåŠ¨ç¡®è®¤è®¢å•
        const confirmResponse = await fetch(`${API_BASE}/merchant/orders/${orderResult.data._id}/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const confirmResult = await confirmResponse.json();
        
        if (confirmResult.success) {
          alert(`è®¢è´§æˆåŠŸï¼å·²å°† ${quantity} ä»¶ ${productName} æ·»åŠ åˆ°æ‚¨çš„åº“å­˜`);
          // åˆ·æ–°é¡µé¢æ•°æ®
          loadWarehouseProducts();
          loadStats();
        } else {
          alert('è®¢å•ç¡®è®¤å¤±è´¥: ' + confirmResult.error);
        }
      } catch (error) {
        alert('è®¢è´§å¤±è´¥: ' + error.message);
      }
    }
    
    // é”€å”®äº§å“
    async function sellProduct(inventoryId, productName, availableQty, retailPrice) {
      const quantity = prompt(`è¯·è¾“å…¥é”€å”®æ•°é‡ï¼ˆå¯ç”¨: ${availableQty}ï¼‰:`, '1');
      
      if (!quantity) return;
      
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      if (qty > availableQty) {
        alert(`é”€å”®æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜æ•°é‡ ${availableQty}`);
        return;
      }
      
      const paymentMethod = confirm('æ”¯ä»˜æ–¹å¼ï¼š\nç¡®å®š = åˆ·å¡\nå–æ¶ˆ = ç°é‡‘') ? 'CARD' : 'CASH';
      
      const totalAmount = (qty * retailPrice).toFixed(2);
      
      if (!confirm(`ç¡®è®¤é”€å”®ï¼š\näº§å“: ${productName}\næ•°é‡: ${qty}\nå•ä»·: â‚¬${retailPrice.toFixed(2)}\næ€»é¢: â‚¬${totalAmount}\næ”¯ä»˜: ${paymentMethod === 'CARD' ? 'åˆ·å¡' : 'ç°é‡‘'}`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sell`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId,
            inventoryId,
            quantity: qty,
            paymentMethod
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`é”€å”®æˆåŠŸï¼\nå‰©ä½™åº“å­˜: ${result.data.remainingStock}`);
          // åˆ·æ–°åº“å­˜åˆ—è¡¨
          loadMyInventory();
          loadStats();
        } else {
          alert('é”€å”®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('é”€å”®å¤±è´¥: ' + error.message);
      }
    }

    // ==================== ç»´ä¿®ä¸šåŠ¡åŠŸèƒ½ ====================
    
    let currentRepairFilter = 'all';
    
    // åŠ è½½ç»´ä¿®è®°å½•
    async function loadRepairs(status = null) {
      const container = document.getElementById('repairsTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        let url = `${API_BASE}/merchant/repairs?merchantId=${merchantId}`;
        if (status && status !== 'all') {
          url += `&status=${status}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ¥æ”¶æ—¥æœŸ</th>
                  <th>å®¢æˆ·</th>
                  <th>è®¾å¤‡</th>
                  <th>IMEI/SN</th>
                  <th>é—®é¢˜æè¿°</th>
                  <th>ç»´ä¿®åœ°ç‚¹</th>
                  <th>æˆæœ¬</th>
                  <th>å”®ä»·</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(repair => `
                  <tr style="${repair.status !== 'sold' ? 'cursor: pointer;' : ''}" 
                      ${repair.status !== 'sold' ? `onclick="showEditRepairModal('${repair._id}')"` : ''}
                      ${repair.status !== 'sold' ? `onmouseover="this.style.background='#f0f9ff'"` : ''}
                      ${repair.status !== 'sold' ? `onmouseout="this.style.background=''"` : ''}>
                    <td>${new Date(repair.receivedDate).toLocaleDateString('zh-CN')}</td>
                    <td>
                      <div style="font-weight: 600;">${repair.customerPhone}</div>
                      ${repair.customerName ? `<small style="color: #666;">${repair.customerName}</small>` : ''}
                    </td>
                    <td><strong>${repair.deviceName}</strong></td>
                    <td style="font-size: 11px; color: #666;">
                      ${repair.deviceIMEI ? `IMEI: ${repair.deviceIMEI}<br>` : ''}
                      ${repair.deviceSN ? `SN: ${repair.deviceSN}` : '-'}
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${repair.problemDescription}">
                      ${repair.problemDescription}
                    </td>
                    <td>${repair.repairLocation || '<span style="color: #10b981;">è‡ªå·±ç»´ä¿®</span>'}</td>
                    <td style="color: #666;">â‚¬${repair.repairCost.toFixed(2)}</td>
                    <td><strong style="color: #10b981;">â‚¬${repair.salePrice.toFixed(2)}</strong></td>
                    <td>${getRepairStatusBadge(repair.status)}</td>
                    <td onclick="event.stopPropagation()">
                      ${getRepairActions(repair)}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— ç»´ä¿®è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç»´ä¿®è®°å½•å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // ç­›é€‰ç»´ä¿®è®°å½•
    function filterRepairs(status) {
      currentRepairFilter = status;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('[id^="filterBtn_"]').forEach(btn => {
        btn.style.opacity = '0.6';
      });
      document.getElementById(`filterBtn_${status}`).style.opacity = '1';
      
      // åŠ è½½æ•°æ®
      loadRepairs(status === 'all' ? null : status);
    }
    
    // è·å–ç»´ä¿®çŠ¶æ€æ ‡ç­¾
    function getRepairStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge badge-warning">å¾…ç»´ä¿®</span>',
        'sent_out': '<span class="badge" style="background: #8b5cf6; color: white;">å·²é€å‡º</span>',
        'retrieved': '<span class="badge badge-success">å·²å–å›</span>',
        'completed': '<span class="badge badge-info">å·²å®Œæˆ</span>',
        'ready_for_sale': '<span class="badge" style="background: #ec4899; color: white;">ç­‰å¾…é”€å”®</span>',
        'sold': '<span class="badge" style="background: #6b7280; color: white;">å·²é”€å”®</span>',
        'cancelled': '<span class="badge" style="background: #ef4444; color: white;">å·²å–æ¶ˆ</span>'
      };
      return badges[status] || status;
    }
    
    // è·å–ç»´ä¿®æ“ä½œæŒ‰é’®
    function getRepairActions(repair) {
      const buttons = [];
      
      switch (repair.status) {
        case 'pending':
          // å¾…ç»´ä¿® -> å¯ä»¥æ ‡è®°ä¸ºå·²å®Œæˆæˆ–ç­‰å¾…é”€å”®
          buttons.push(`<button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'completed')">å®Œæˆ</button>`);
          buttons.push(`<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'ready_for_sale')">å¾…é”€å”®</button>`);
          break;
        case 'sent_out':
          // å·²é€å‡º -> å¯ä»¥æ ‡è®°ä¸ºå·²å–å›
          buttons.push(`<button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'retrieved')">å·²å–å›</button>`);
          break;
        case 'retrieved':
        case 'completed':
          // å·²å–å›/å·²å®Œæˆ -> å¯ä»¥æ ‡è®°ä¸ºç­‰å¾…é”€å”®
          buttons.push(`<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'ready_for_sale')">å¾…é”€å”®</button>`);
          break;
        case 'ready_for_sale':
          // ç­‰å¾…é”€å”® -> æ˜¾ç¤ºåœ¨é”€å”®ä¸šåŠ¡ä¸­
          buttons.push(`<span style="color: #10b981; font-size: 12px;">âœ“ å¯é”€å”®</span>`);
          break;
      }
      
      // åˆ é™¤æŒ‰é’®ï¼ˆæœªé”€å”®çš„è®¢å•å¯ä»¥åˆ é™¤ï¼‰
      if (repair.status !== 'sold') {
        buttons.push(`<button class="btn" style="padding: 4px 8px; font-size: 12px; background: #ef4444; color: white;" onclick="deleteRepair('${repair._id}')">åˆ é™¤</button>`);
      }
      
      return buttons.join(' ');
    }
    
    // æ˜¾ç¤ºæ–°å¢ç»´ä¿®æ¨¡æ€æ¡†
    function showNewRepairModal() {
      document.getElementById('newRepairModal').style.display = 'flex';
      document.getElementById('newRepairForm').reset();
    }
    
    // å…³é—­æ–°å¢ç»´ä¿®æ¨¡æ€æ¡†
    function closeNewRepairModal() {
      document.getElementById('newRepairModal').style.display = 'none';
    }
    
    // æäº¤æ–°å¢ç»´ä¿®è®¢å•
    async function submitNewRepair(event) {
      event.preventDefault();
      
      const formData = {
        merchantId: merchantId,
        customerPhone: document.getElementById('repair_customerPhone').value,
        customerName: document.getElementById('repair_customerName').value,
        deviceName: document.getElementById('repair_deviceName').value,
        deviceIMEI: document.getElementById('repair_deviceIMEI').value,
        deviceSN: document.getElementById('repair_deviceSN').value,
        problemDescription: document.getElementById('repair_problemDescription').value,
        notes: document.getElementById('repair_notes').value,
        repairLocation: document.getElementById('repair_location').value,
        estimatedCompletionDate: document.getElementById('repair_estimatedDate').value || null,
        repairCost: parseFloat(document.getElementById('repair_cost').value) || 0,
        salePrice: parseFloat(document.getElementById('repair_salePrice').value) || 0
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          const isOutsourced = result.data.isOutsourced;
          const statusText = isOutsourced ? 'å·²é€å‡º' : 'å¾…ç»´ä¿®';
          alert(`âœ… ç»´ä¿®è®¢å•åˆ›å»ºæˆåŠŸï¼\nçŠ¶æ€: ${statusText}\nè®¢å•å·: ${result.data.repairOrderId}`);
          closeNewRepairModal();
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ åˆ›å»ºå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
      }
    }
    
    // æ›´æ–°ç»´ä¿®è®¢å•çŠ¶æ€
    async function updateRepairStatus(repairId, newStatus) {
      const statusNames = {
        'completed': 'å·²å®Œæˆ',
        'retrieved': 'å·²å–å›',
        'ready_for_sale': 'ç­‰å¾…é”€å”®',
        'sent_out': 'å·²é€å‡º'
      };
      
      if (!confirm(`ç¡®å®šè¦å°†æ­¤è®¢å•æ ‡è®°ä¸º"${statusNames[newStatus]}"å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… çŠ¶æ€å·²æ›´æ–°ä¸º: ${statusNames[newStatus]}`);
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }
    
    // åˆ é™¤ç»´ä¿®è®¢å•
    async function deleteRepair(repairId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç»´ä¿®è®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ç»´ä¿®è®¢å•å·²åˆ é™¤');
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ åˆ é™¤å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºç¼–è¾‘ç»´ä¿®è®¢å•æ¨¡æ€æ¡†
    async function showEditRepairModal(repairId) {
      try {
        // è·å–ç»´ä¿®è®¢å•è¯¦æƒ…
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const repair = result.data;
          
          // å¡«å……è¡¨å•
          document.getElementById('edit_repair_id').value = repair._id;
          document.getElementById('edit_repair_customerPhone').value = repair.customerPhone;
          document.getElementById('edit_repair_customerName').value = repair.customerName || '';
          document.getElementById('edit_repair_deviceName').value = repair.deviceName;
          document.getElementById('edit_repair_deviceIMEI').value = repair.deviceIMEI || '';
          document.getElementById('edit_repair_deviceSN').value = repair.deviceSN || '';
          document.getElementById('edit_repair_problemDescription').value = repair.problemDescription;
          document.getElementById('edit_repair_notes').value = repair.notes || '';
          document.getElementById('edit_repair_location').value = repair.repairLocation || '';
          document.getElementById('edit_repair_cost').value = repair.repairCost || 0;
          document.getElementById('edit_repair_salePrice').value = repair.salePrice || 0;
          
          // å¤„ç†æ—¥æœŸ
          if (repair.estimatedCompletionDate) {
            const date = new Date(repair.estimatedCompletionDate);
            document.getElementById('edit_repair_estimatedDate').value = date.toISOString().split('T')[0];
          } else {
            document.getElementById('edit_repair_estimatedDate').value = '';
          }
          
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          document.getElementById('editRepairModal').style.display = 'flex';
        } else {
          alert('âŒ è·å–ç»´ä¿®è®¢å•è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        alert('âŒ è·å–ç»´ä¿®è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
      }
    }
    
    // å…³é—­ç¼–è¾‘ç»´ä¿®è®¢å•æ¨¡æ€æ¡†
    function closeEditRepairModal() {
      document.getElementById('editRepairModal').style.display = 'none';
    }
    
    // æäº¤ç¼–è¾‘ç»´ä¿®è®¢å•
    async function submitEditRepair(event) {
      event.preventDefault();
      
      const repairId = document.getElementById('edit_repair_id').value;
      const formData = {
        customerPhone: document.getElementById('edit_repair_customerPhone').value,
        customerName: document.getElementById('edit_repair_customerName').value,
        deviceName: document.getElementById('edit_repair_deviceName').value,
        deviceIMEI: document.getElementById('edit_repair_deviceIMEI').value,
        deviceSN: document.getElementById('edit_repair_deviceSN').value,
        problemDescription: document.getElementById('edit_repair_problemDescription').value,
        notes: document.getElementById('edit_repair_notes').value,
        repairLocation: document.getElementById('edit_repair_location').value,
        estimatedCompletionDate: document.getElementById('edit_repair_estimatedDate').value || null,
        repairCost: parseFloat(document.getElementById('edit_repair_cost').value) || 0,
        salePrice: parseFloat(document.getElementById('edit_repair_salePrice').value) || 0
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ç»´ä¿®è®¢å•å·²æ›´æ–°');
          closeEditRepairModal();
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤ºäº§å“æ—¶é—´çº¿
    async function showProductTimeline(inventoryId, productName) {
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('productTimelineModal').style.display = 'flex';
      document.getElementById('timelineProductName').textContent = `ğŸ“¦ ${productName}`;
      document.getElementById('timelineContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/${inventoryId}/timeline`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const timeline = result.data;
          
          let html = '<div style="position: relative; padding-left: 30px;">';
          
          // æ—¶é—´çº¿æ ·å¼
          html += '<div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: #e5e7eb;"></div>';
          
          if (timeline.length === 0) {
            html += '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å†å²è®°å½•</p>';
          } else {
            timeline.forEach((event, index) => {
              const isFirst = index === 0;
              const eventColor = event.type === 'created' ? '#10b981' : 
                                 event.type === 'sold' ? '#3b82f6' : 
                                 event.type === 'transferred_out' ? '#f59e0b' : 
                                 event.type === 'transferred_in' ? '#8b5cf6' : '#6b7280';
              
              html += `
                <div style="position: relative; margin-bottom: 30px;">
                  <!-- æ—¶é—´çº¿åœ†ç‚¹ -->
                  <div style="position: absolute; left: -24px; width: 12px; height: 12px; border-radius: 50%; background: ${eventColor}; border: 3px solid white; box-shadow: 0 0 0 2px ${eventColor};"></div>
                  
                  <!-- äº‹ä»¶å¡ç‰‡ -->
                  <div style="background: white; border: 2px solid ${eventColor}; border-radius: 8px; padding: 15px; ${isFirst ? 'box-shadow: 0 4px 6px rgba(0,0,0,0.1);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                      <div style="font-weight: 600; color: ${eventColor}; font-size: 16px;">
                        ${event.icon} ${event.title}
                      </div>
                      <div style="font-size: 12px; color: #666;">
                        ${new Date(event.date).toLocaleString('zh-CN', { 
                          year: 'numeric', 
                          month: '2-digit', 
                          day: '2-digit', 
                          hour: '2-digit', 
                          minute: '2-digit' 
                        })}
                      </div>
                    </div>
                    
                    <div style="color: #666; font-size: 14px; line-height: 1.6;">
                      ${event.description}
                    </div>
                    
                    ${event.details ? `
                      <div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 5px; font-size: 13px; color: #666;">
                        ${event.details}
                      </div>
                    ` : ''}
                  </div>
                </div>
              `;
            });
          }
          
          html += '</div>';
          document.getElementById('timelineContent').innerHTML = html;
        } else {
          document.getElementById('timelineContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">åŠ è½½å¤±è´¥</p>';
        }
      } catch (error) {
        console.error('åŠ è½½æ—¶é—´çº¿å¤±è´¥:', error);
        document.getElementById('timelineContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­äº§å“æ—¶é—´çº¿æ¨¡æ€æ¡†
    function closeProductTimeline() {
      document.getElementById('productTimelineModal').style.display = 'none';
    }

    // ç™»å‡ºåŠŸèƒ½ - ä½¿ç”¨AuthGuardç»Ÿä¸€çš„logout
    function logout() {
      AuthGuard.logout();
    }

    // ==================== ä»“åº“è®¢è´§åŠŸèƒ½ ====================
    
    // ä»“åº“è®¢è´§è´­ç‰©è½¦
    let warehouseCart = [];
    
    // åˆ‡æ¢ä»“åº“è®¢è´§æ ‡ç­¾
    function switchWarehouseTab(tab) {
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('.sub-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottom = '3px solid transparent';
        btn.style.color = '#6b7280';
      });
      
      if (tab === 'order') {
        document.getElementById('warehouseOrderTabBtn').classList.add('active');
        document.getElementById('warehouseOrderTabBtn').style.borderBottom = '3px solid #6366f1';
        document.getElementById('warehouseOrderTabBtn').style.color = '#6366f1';
        document.getElementById('warehouseOrderSection').style.display = 'block';
        document.getElementById('warehouseMyOrdersSection').style.display = 'none';
        loadWarehouseProducts(); // ä¿®æ”¹ï¼šè°ƒç”¨æ­£ç¡®çš„å‡½æ•°
      } else if (tab === 'myOrders') {
        document.getElementById('warehouseMyOrdersTabBtn').classList.add('active');
        document.getElementById('warehouseMyOrdersTabBtn').style.borderBottom = '3px solid #6366f1';
        document.getElementById('warehouseMyOrdersTabBtn').style.color = '#6366f1';
        document.getElementById('warehouseOrderSection').style.display = 'none';
        document.getElementById('warehouseMyOrdersSection').style.display = 'block';
        loadMyWarehouseOrders();
      }
    }
    
    // åŠ è½½ä»“åº“äº§å“åˆ†ç±»ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ loadWarehouseProducts ä»£æ›¿ï¼‰
    // æ­¤å‡½æ•°ä¿ç•™ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œä½†å®é™…è°ƒç”¨ loadWarehouseProducts
    async function loadWarehouseCategories() {
      console.log('âš ï¸ loadWarehouseCategories å·²åºŸå¼ƒï¼Œè°ƒç”¨ loadWarehouseProducts');
      loadWarehouseProducts();
    }
    
    // æ›´æ–°ä»“åº“è´­ç‰©è½¦æ˜¾ç¤º
    function updateWarehouseCart() {
      const cartCount = warehouseCart.reduce((sum, item) => sum + item.quantity, 0);
      const cartTotal = warehouseCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('warehouseCartCount').textContent = cartCount;
      document.getElementById('warehouseCartTotal').textContent = cartTotal.toFixed(2);
      
      if (warehouseCart.length === 0) {
        document.getElementById('warehouseCartItems').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px 0;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>';
      } else {
        const html = warehouseCart.map((item, index) => `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #1f2937;">${item.productName}</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="decreaseWarehouseCartQuantity(${index})" style="width: 24px; height: 24px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1;">-</button>
                <span style="min-width: 30px; text-align: center; font-weight: 600;">${item.quantity}</span>
                <button onclick="increaseWarehouseCartQuantity(${index})" style="width: 24px; height: 24px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1;">+</button>
              </div>
              <div>
                <div style="color: #6b7280; font-size: 12px;">â‚¬${item.price.toFixed(2)} Ã— ${item.quantity}</div>
                <div style="font-weight: 600; color: #ef4444;">â‚¬${(item.price * item.quantity).toFixed(2)}</div>
              </div>
            </div>
            <button onclick="removeFromWarehouseCart(${index})" style="width: 100%; margin-top: 8px; padding: 4px; background: #fee2e2; color: #ef4444; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ç§»é™¤
            </button>
          </div>
        `).join('');
        
        document.getElementById('warehouseCartItems').innerHTML = html;
      }
    }
    
    // å¢åŠ æ•°é‡
    function increaseWarehouseCartQuantity(index) {
      if (warehouseCart[index].quantity < warehouseCart[index].maxQuantity) {
        warehouseCart[index].quantity++;
        updateWarehouseCart();
      } else {
        alert(`åº“å­˜ä¸è¶³ï¼Œæœ€å¤šå¯è®¢è´­ ${warehouseCart[index].maxQuantity} ä»¶`);
      }
    }
    
    // å‡å°‘æ•°é‡
    function decreaseWarehouseCartQuantity(index) {
      if (warehouseCart[index].quantity > 1) {
        warehouseCart[index].quantity--;
        updateWarehouseCart();
      }
    }
    
    // ä»è´­ç‰©è½¦ç§»é™¤
    function removeFromWarehouseCart(index) {
      warehouseCart.splice(index, 1);
      updateWarehouseCart();
    }
    
    // æ¸…ç©ºè´­ç‰©è½¦
    function clearWarehouseCart() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
        warehouseCart = [];
        updateWarehouseCart();
      }
    }
    
    // æäº¤è®¢å•
    function submitWarehouseOrder() {
      if (warehouseCart.length === 0) {
        alert('è´­ç‰©è½¦æ˜¯ç©ºçš„');
        return;
      }
      
      // æ˜¾ç¤ºè®¢å•ç¡®è®¤å¯¹è¯æ¡†
      const itemsHtml = warehouseCart.map(item => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
          <span>${item.productName} Ã— ${item.quantity}</span>
          <span style="font-weight: 600;">â‚¬${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');
      
      const total = warehouseCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('orderSubmitItems').innerHTML = itemsHtml;
      document.getElementById('orderSubmitTotal').textContent = total.toFixed(2);
      
      const modal = document.getElementById('warehouseOrderSubmitModal');
      modal.style.display = 'flex'; // ä½¿ç”¨ flex å¸ƒå±€å±…ä¸­æ˜¾ç¤º
    }
    
    // åˆ‡æ¢é…é€å­—æ®µ
    function toggleDeliveryFields() {
      const method = document.getElementById('deliveryMethod').value;
      document.getElementById('deliveryAddressSection').style.display = method === 'delivery' ? 'block' : 'none';
      document.getElementById('pickupLocationSection').style.display = method === 'pickup' ? 'block' : 'none';
    }
    
    // ç¡®è®¤æäº¤è®¢å•
    async function confirmWarehouseOrderSubmit() {
      try {
        const deliveryMethod = document.getElementById('deliveryMethod').value;
        const deliveryAddress = document.getElementById('deliveryAddress').value;
        const pickupLocation = document.getElementById('pickupLocation').value;
        const notes = document.getElementById('orderNotes').value;
        
        if (deliveryMethod === 'delivery' && !deliveryAddress.trim()) {
          alert('è¯·è¾“å…¥é…é€åœ°å€');
          return;
        }
        
        const orderData = {
          merchantId,
          items: warehouseCart.map(item => ({
            productId: item.productId,
            quantity: item.quantity
          })),
          deliveryMethod,
          deliveryAddress: deliveryMethod === 'delivery' ? deliveryAddress : '',
          pickupLocation: deliveryMethod === 'pickup' ? pickupLocation : '',
          notes
        };
        
        const response = await fetch(`${API_BASE}/warehouse/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·: ${result.data.orderNumber}\n\nåº“å­˜å·²é¢„ç•™ï¼Œç­‰å¾…ä»“ç®¡å‘˜ç¡®è®¤å‘è´§ã€‚`);
          warehouseCart = [];
          updateWarehouseCart();
          closeWarehouseOrderSubmitModal();
          
          // åˆ·æ–°ä»“åº“äº§å“åˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°åçš„åº“å­˜
          loadWarehouseProducts();
          
          // åˆ‡æ¢åˆ°æˆ‘çš„è®¢å•æ ‡ç­¾
          switchWarehouseTab('myOrders');
        } else {
          alert('è®¢å•åˆ›å»ºå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('æäº¤è®¢å•å¤±è´¥:', error);
        alert('æäº¤è®¢å•å¤±è´¥');
      }
    }
    
    // å…³é—­è®¢å•æäº¤å¯¹è¯æ¡†
    function closeWarehouseOrderSubmitModal() {
      document.getElementById('warehouseOrderSubmitModal').style.display = 'none';
      document.getElementById('deliveryAddress').value = '';
      document.getElementById('orderNotes').value = '';
    }
    
    // åŠ è½½æˆ‘çš„è®¢å•
    async function loadMyWarehouseOrders() {
      try {
        const status = document.getElementById('orderStatusFilter').value;
        const url = `${API_BASE}/warehouse/orders/my?merchantId=${merchantId}${status ? '&status=' + status : ''}`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
          if (result.data.length === 0) {
            document.getElementById('myWarehouseOrdersList').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px 0;">æš‚æ— è®¢å•</p>';
            return;
          }
          
          const html = result.data.map(order => {
            const statusColors = {
              'pending': '#f59e0b',
              'confirmed': '#3b82f6',
              'shipped': '#8b5cf6',
              'completed': '#10b981',
              'cancelled': '#ef4444'
            };
            
            const statusNames = {
              'pending': 'å¾…ç¡®è®¤',
              'confirmed': 'å·²ç¡®è®¤',
              'shipped': 'å·²å‘è´§',
              'completed': 'å·²å®Œæˆ',
              'cancelled': 'å·²å–æ¶ˆ'
            };
            
            return `
              <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                  <div>
                    <h3 style="margin-bottom: 5px;">è®¢å•å·: ${order.orderNumber}</h3>
                    <p style="color: #6b7280; font-size: 14px;">${new Date(order.orderedAt).toLocaleString('zh-CN')}</p>
                  </div>
                  <span style="padding: 6px 12px; background: ${statusColors[order.status]}; color: white; border-radius: 6px; font-weight: 600;">
                    ${statusNames[order.status]}
                  </span>
                </div>
                
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <p style="margin-bottom: 5px;"><strong>äº§å“æ•°é‡:</strong> ${order.items.length} ç§</p>
                  <p style="margin-bottom: 5px;"><strong>æ€»æ•°é‡:</strong> ${order.items.reduce((sum, item) => sum + item.quantity, 0)} ä»¶</p>
                  <p style="margin-bottom: 5px;"><strong>é…é€æ–¹å¼:</strong> ${order.deliveryMethod === 'delivery' ? 'ğŸšš ç‰©æµé…é€' : 'ğŸª åˆ°åº—è‡ªå–'}</p>
                  <p style="font-size: 18px; font-weight: 600; color: #ef4444; margin-top: 10px;">æ€»è®¡: â‚¬${order.totalAmount.toFixed(2)}</p>
                </div>
                
                <button onclick="viewWarehouseOrderDetail('${order._id}')" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                  æŸ¥çœ‹è¯¦æƒ…
                </button>
                ${order.status === 'shipped' ? `
                  <button onclick="confirmReceiveOrder('${order._id}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 10px;">
                    âœ… ç¡®è®¤æ”¶è´§
                  </button>
                ` : ''}
              </div>
            `;
          }).join('');
          
          document.getElementById('myWarehouseOrdersList').innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        document.getElementById('myWarehouseOrdersList').innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    // æŸ¥çœ‹è®¢å•è¯¦æƒ…
    async function viewWarehouseOrderDetail(orderId) {
      try {
        document.getElementById('warehouseOrderDetailModal').style.display = 'block';
        document.getElementById('orderDetailContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        
        const response = await fetch(`${API_BASE}/warehouse/orders/${orderId}`);
        const result = await response.json();
        
        if (result.success) {
          const order = result.data;
          
          const statusColors = {
            'pending': '#f59e0b',
            'confirmed': '#3b82f6',
            'shipped': '#8b5cf6',
            'completed': '#10b981',
            'cancelled': '#ef4444'
          };
          
          const statusNames = {
            'pending': 'å¾…ç¡®è®¤',
            'confirmed': 'å·²ç¡®è®¤',
            'shipped': 'å·²å‘è´§',
            'completed': 'å·²å®Œæˆ',
            'cancelled': 'å·²å–æ¶ˆ'
          };
          
          const html = `
            <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">è®¢å•å·</p>
                  <p style="font-weight: 600;">${order.orderNumber}</p>
                </div>
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">çŠ¶æ€</p>
                  <span style="padding: 6px 12px; background: ${statusColors[order.status]}; color: white; border-radius: 6px; font-weight: 600;">
                    ${statusNames[order.status]}
                  </span>
                </div>
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">ä¸‹å•æ—¶é—´</p>
                  <p style="font-weight: 600;">${new Date(order.orderedAt).toLocaleString('zh-CN')}</p>
                </div>
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">é…é€æ–¹å¼</p>
                  <p style="font-weight: 600;">${order.deliveryMethod === 'delivery' ? 'ğŸšš ç‰©æµé…é€' : 'ğŸª åˆ°åº—è‡ªå–'}</p>
                </div>
                ${order.deliveryAddress ? `
                <div style="grid-column: 1 / -1;">
                  <p style="color: #6b7280; margin-bottom: 5px;">é…é€åœ°å€</p>
                  <p style="font-weight: 600;">${order.deliveryAddress}</p>
                </div>
                ` : ''}
                ${order.notes ? `
                <div style="grid-column: 1 / -1;">
                  <p style="color: #6b7280; margin-bottom: 5px;">å¤‡æ³¨</p>
                  <p style="font-weight: 600;">${order.notes}</p>
                </div>
                ` : ''}
              </div>
            </div>
            
            <h3 style="margin-bottom: 15px;">è®¢å•æ˜ç»†</h3>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <thead>
                <tr style="background: #f9fafb;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">äº§å“åç§°</th>
                  <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">æ•°é‡</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">å•ä»·</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">å°è®¡</th>
                </tr>
              </thead>
              <tbody>
                ${order.items.map(item => `
                  <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${item.productName}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">â‚¬${item.wholesalePrice.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">â‚¬${item.subtotal.toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" style="padding: 12px; text-align: right; font-weight: 600; font-size: 18px;">æ€»è®¡:</td>
                  <td style="padding: 12px; text-align: right; font-weight: 600; font-size: 18px; color: #ef4444;">â‚¬${order.totalAmount.toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>
            
            ${order.status === 'shipped' ? `
              <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <p style="color: #92400e; margin-bottom: 10px;">
                  <strong>âš ï¸ è¯·ç¡®è®¤æ”¶è´§</strong><br>
                  è®¢å•å·²å‘è´§ï¼Œè¯·ç¡®è®¤æ”¶åˆ°è´§ç‰©åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚ç¡®è®¤æ”¶è´§åï¼Œäº§å“å°†è‡ªåŠ¨å…¥åº“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚
                </p>
                <button onclick="confirmReceiveOrder('${order._id}')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                  âœ… ç¡®è®¤æ”¶è´§
                </button>
              </div>
            ` : ''}
          `;
          
          document.getElementById('orderDetailContent').innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
        document.getElementById('orderDetailContent').innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    // å…³é—­è®¢å•è¯¦æƒ…å¯¹è¯æ¡†
    function closeWarehouseOrderDetailModal() {
      document.getElementById('warehouseOrderDetailModal').style.display = 'none';
    }
    
    // ç¡®è®¤æ”¶è´§
    async function confirmReceiveOrder(orderId) {
      if (!confirm('ç¡®è®¤å·²æ”¶åˆ°è´§ç‰©ï¼Ÿç¡®è®¤åäº§å“å°†è‡ªåŠ¨å…¥åº“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/warehouse/orders/${orderId}/complete?merchantId=${merchantId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ merchantId: merchantId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… æ”¶è´§ç¡®è®¤æˆåŠŸï¼äº§å“å·²å…¥åº“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚');
          closeWarehouseOrderDetailModal();
          loadMyWarehouseOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
          loadMyInventory(); // åˆ·æ–°åº“å­˜åˆ—è¡¨
        } else {
          alert('âŒ ç¡®è®¤æ”¶è´§å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('ç¡®è®¤æ”¶è´§å¤±è´¥:', error);
        alert('âŒ ç¡®è®¤æ”¶è´§å¤±è´¥: ' + error.message);
      }
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadMerchantInfo(); // åŠ è½½å•†æˆ·ä¿¡æ¯å’Œæ¬¢è¿æ ‡é¢˜
      loadStats();
      loadCategoryList(); // é»˜è®¤åŠ è½½é”€å”®ä¸šåŠ¡çš„åˆ†ç±»åˆ—è¡¨
      
      // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ¬æœˆï¼‰
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      
      // ç¨åŠ¡æŠ¥è¡¨æ—¥æœŸ
      document.getElementById('taxStartDate').valueAsDate = firstDay;
      document.getElementById('taxEndDate').valueAsDate = now;
      
      // é”€å”®è®°å½•æŸ¥è¯¢æ—¥æœŸ
      document.getElementById('salesStartDate').valueAsDate = firstDay;
      document.getElementById('salesEndDate').valueAsDate = now;
    });
  </script>
</body>
</html>
