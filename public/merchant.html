<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>æ‰¹å‘å•†æˆ·ä¸­å¿ƒ - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ v2.3.1</title>
  <script>console.log('âœ… é¡µé¢ç‰ˆæœ¬: v2.3.1 - ä¿®å¤ç¼–è¾‘ä¿å­˜ååˆ·æ–°æ˜¾ç¤º');</script>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <script src="/transfer-cart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #6366f1;
    }
    
    .tab.active {
      color: #6366f1;
      border-bottom-color: #6366f1;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #6366f1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #4f46e5;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #cfe2ff; color: #084298; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #6366f1;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 20px;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
    }
    
    /* è°ƒè´§ç®¡ç†å­æ ‡ç­¾æ ·å¼ */
    .transfer-sub-tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .transfer-sub-tab:hover {
      color: #6366f1;
    }
    
    .transfer-sub-tab.active {
      color: #6366f1;
      border-bottom-color: #6366f1;
      font-weight: 600;
    }
    
    .transfer-sub-content {
      display: none;
    }
    
    .transfer-sub-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <h1 id="merchantWelcome">ğŸ¢ Welcome</h1>
        <p>åº“å­˜ç®¡ç† Â· é”€å”®ä¸šåŠ¡ Â· ç¨åŠ¡æŠ¥è¡¨</p>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="logout-btn" onclick="toggleStats()" id="toggleStatsBtn">ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡</button>
        <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid" style="display: none;">
      <div class="stat-card">
        <h3>æˆ‘çš„åº“å­˜</h3>
        <div class="value" id="myInventory">-</div>
      </div>
      <div class="stat-card" onclick="showDailySalesDetails()" style="cursor: pointer;" 
           onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
        <h3>æœ¬æ—¥é”€å”® ğŸ’°</h3>
        <div class="value" id="dailySales">-</div>
        <small style="color: #666; font-size: 12px;">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</small>
      </div>
      <div class="stat-card" onclick="showDailyRepairsDetails()" style="cursor: pointer;"
           onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
        <h3>æœ¬æ—¥ç»´ä¿® ğŸ”§</h3>
        <div class="value" id="dailyRepairs">-</div>
        <small style="color: #666; font-size: 12px;">ç‚¹å‡»æŸ¥çœ‹æ˜ç»†</small>
      </div>
      <div class="stat-card" onclick="showTaxCalculationDetails()" style="cursor: pointer;"
           onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
        <h3>åº”ç¼´ç¨é¢ ğŸ“Š</h3>
        <div class="value" id="taxDue">-</div>
        <small style="color: #666; font-size: 12px;">ç‚¹å‡»æŸ¥çœ‹è®¡ç®—è¿‡ç¨‹</small>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('sales')">é”€å”®ä¸šåŠ¡</button>
      <button class="tab" onclick="switchTab('repairs')">ç»´ä¿®ä¸šåŠ¡</button>
      <button class="tab" onclick="switchTab('my-inventory')">æˆ‘çš„åº“å­˜</button>
      <button class="tab" onclick="switchTab('group-inventory')">ç¾¤ç»„åº“å­˜</button>
      <button class="tab" onclick="switchTab('transfer-management')">è°ƒè´§ç®¡ç†</button>
      <button class="tab" onclick="switchTab('warehouse-order')">ä»“åº“è®¢è´§</button>
      <button class="tab" onclick="switchTab('reports')">æŠ¥è¡¨ä¸­å¿ƒ</button>
      <button class="tab" onclick="switchTab('tax-report')">ç¨åŠ¡æŠ¥è¡¨</button>
    </div>

    <!-- é”€å”®ä¸šåŠ¡ -->
    <div id="sales" class="tab-content active">
      <div class="card">
        <h2>ğŸ›’ é”€å”®ä¸šåŠ¡</h2>
                
        <!-- è´­ç‰©è½¦æ‘˜è¦ -->
        <div id="cartSummary" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span style="font-size: 18px;">ğŸ›’</span>
              <strong>è´­ç‰©è½¦ï¼š</strong>
              <span id="cartItemCount">0</span> ä»¶å•†å“
              <span style="margin-left: 20px;"><strong>æ€»è®¡ï¼š</strong></span>
              <span id="cartTotal" style="color: #2563eb; font-size: 20px; font-weight: bold;">â‚¬0.00</span>
            </div>
            <div>
              <button class="btn btn-primary" onclick="showCheckoutModal()" style="padding: 10px 30px; font-size: 16px;">
                ğŸ’³ ç»“è´¦
              </button>
              <button onclick="clearCart()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; margin-left: 10px;">
                æ¸…ç©º
              </button>
            </div>
          </div>
        </div>
        
        <!-- å…¨å±€æœç´¢æ¡† -->
        <div style="margin-bottom: 20px;">
          <input type="text" id="globalProductSearchInput" 
            placeholder="ğŸ” æœç´¢äº§å“åç§°ã€IMEIã€åºåˆ—å·ã€æ¡å½¢ç æˆ–å¤‡æ³¨..." 
            oninput="globalSearchProducts()"
            style="width: 100%; padding: 12px 20px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: border-color 0.2s;"
            onfocus="this.style.borderColor='#3b82f6'"
            onblur="this.style.borderColor='#e5e7eb'">
        </div>
        
        <!-- äº§å“åˆ†ç±»åˆ—è¡¨ -->
        <div id="categoryList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- å…¨å±€æœç´¢ç»“æœ -->
        <div id="globalSearchResults" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">ğŸ” æœç´¢ç»“æœ</h3>
            <button onclick="clearGlobalSearch()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer;">
              âœ• æ¸…é™¤æœç´¢
            </button>
          </div>
          <div id="globalSearchProductList"></div>
        </div>
        
        <!-- åˆ†ç±»äº§å“åˆ—è¡¨ -->
        <div id="categoryProducts" style="display: none;">
          <button onclick="backToCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
            â† è¿”å›åˆ†ç±»
          </button>
          <h3 id="currentCategoryName" style="margin-bottom: 15px;"></h3>
          <div id="productList"></div>
        </div>
      </div>
      
      <!-- é”€å”®è®°å½•æŸ¥è¯¢ -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSalesRecordsSection()">
          <h2 style="margin: 0;">é”€å”®è®°å½•æŸ¥è¯¢</h2>
          <span id="salesRecordsToggleIcon" style="font-size: 24px; color: #6b7280; transition: transform 0.3s;">â–¼</span>
        </div>
        
        <div id="salesRecordsContent" style="display: none; margin-top: 20px;">
          <div class="form-grid" style="margin-bottom: 20px;">
            <div class="form-group">
              <label>å¼€å§‹æ—¥æœŸ</label>
              <input type="date" id="salesStartDate">
            </div>
            <div class="form-group">
              <label>ç»“æŸæ—¥æœŸ</label>
              <input type="date" id="salesEndDate">
            </div>
          </div>
          
          <!-- æœç´¢æ¡† -->
          <div class="form-group" style="margin-bottom: 20px;">
            <label>ğŸ” æœç´¢ (ç”µè¯å·ç /äº§å“åç§°/åºåˆ—å·/é‡‘é¢)</label>
            <input 
              type="text" 
              id="salesSearchInput" 
              placeholder="è¾“å…¥å…³é”®å­—æœç´¢..." 
              style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
              oninput="filterSalesRecords()"
            >
          </div>
          
          <button class="btn btn-primary" onclick="querySalesRecords()">æŸ¥è¯¢é”€å”®è®°å½•</button>
          
          <div id="salesRecordsTable" style="margin-top: 20px;">
            <p style="text-align: center; color: #999; padding: 20px;">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»æŸ¥è¯¢</p>
          </div>
        </div>
      </div>
    </div>

    <!-- é€‰æ‹©IMEI/SNæ¨¡æ€æ¡† -->
    <div id="selectDeviceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">é€‰æ‹©è®¾å¤‡</h3>
        <p style="color: #666; margin-bottom: 15px;" id="deviceProductName"></p>
        <div id="deviceList" style="margin-bottom: 20px;"></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeDeviceModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- å˜ä½“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="variantSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;">
        <h3 style="margin-bottom: 10px; font-size: 22px;">é€‰æ‹©äº§å“å˜ä½“</h3>
        <p style="color: #666; margin-bottom: 25px; font-size: 15px;" id="variantProductName"></p>
        
        <!-- æ­¥éª¤1: é€‰æ‹©ç»´åº¦1 -->
        <div id="dimension1Section" style="margin-bottom: 25px;">
          <h4 style="margin-bottom: 15px; color: #4a5568; font-size: 16px;">
            <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 50%; font-size: 12px; margin-right: 8px;">1</span>
            <span id="dimension1Label">é€‰æ‹©å‹å·</span>
          </h4>
          <div id="dimension1Options" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        
        <!-- æ­¥éª¤2: é€‰æ‹©ç»´åº¦2 -->
        <div id="dimension2Section" style="margin-bottom: 25px; display: none;">
          <h4 style="margin-bottom: 15px; color: #4a5568; font-size: 16px;">
            <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 50%; font-size: 12px; margin-right: 8px;">2</span>
            <span id="dimension2Label">é€‰æ‹©é¢œè‰²</span>
          </h4>
          <div id="dimension2Options" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
        
        <!-- å·²é€‰æ‹©ä¿¡æ¯ -->
        <div id="selectedVariantInfo" style="display: none; background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <div style="font-weight: 600; margin-bottom: 8px; color: #0c4a6e;">å·²é€‰æ‹©:</div>
          <div id="selectedVariantText" style="font-size: 15px; color: #0369a1; margin-bottom: 8px;"></div>
          <div style="display: flex; gap: 20px; font-size: 14px; color: #0c4a6e;">
            <span id="selectedVariantStock"></span>
            <span id="selectedVariantPrice" style="font-weight: 600; color: #10b981;"></span>
          </div>
        </div>
        
        <!-- æŒ‰é’® -->
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeVariantModal()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
            å–æ¶ˆ
          </button>
          <button id="addVariantToCartBtn" onclick="addSelectedVariantToCart()" disabled style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; opacity: 0.5;">
            åŠ å…¥è´­ç‰©è½¦
          </button>
        </div>
      </div>
    </div>

    <!-- ç»“è´¦æ¨¡æ€æ¡† -->
    <div id="checkoutModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">ğŸ’³ ç»“è´¦</h3>
        
        <!-- è´­ç‰©è½¦æ˜ç»† -->
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
          <h4 style="margin-bottom: 10px;">è´­ç‰©è½¦æ˜ç»†</h4>
          <div id="checkoutCartItems"></div>
          <div style="border-top: 2px solid #dee2e6; margin-top: 10px; padding-top: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 8px;">
              <span>å°è®¡ï¼š</span>
              <span id="checkoutSubtotal" style="color: #6b7280;">â‚¬0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; background: #f0f9ff; padding: 12px; border-radius: 8px; border: 2px solid #3b82f6;">
              <span style="color: #1e40af;">å®é™…æ”¶æ¬¾ï¼š</span>
              <span id="actualAmount" style="color: #2563eb;">â‚¬0.00</span>
            </div>
          </div>
        </div>
        
        <!-- å®¢æˆ·ä¿¡æ¯ -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px;">å®¢æˆ·ç”µè¯ï¼ˆé€‰å¡«ï¼‰</label>
          <input type="text" id="customerPhone" placeholder="è¾“å…¥å®¢æˆ·ç”µè¯..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        
        <!-- æ”¯ä»˜æ–¹å¼ -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px;">æ”¯ä»˜æ–¹å¼</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button onclick="selectPaymentMethod('CASH')" id="payBtn_CASH" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ’µ ç°é‡‘
            </button>
            <button onclick="selectPaymentMethod('CARD')" id="payBtn_CARD" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ’³ åˆ·å¡
            </button>
            <button onclick="selectPaymentMethod('MIXED')" id="payBtn_MIXED" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: 600;">
              ğŸ’° æ··åˆ
            </button>
          </div>
          
          <!-- æ··åˆæ”¯ä»˜é‡‘é¢è¾“å…¥ -->
          <div id="mixedPaymentInputs" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç°é‡‘é‡‘é¢ (â‚¬)</label>
                <input type="number" id="cashAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateMixedPayment()">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px;">åˆ·å¡é‡‘é¢ (â‚¬)</label>
                <input type="number" id="cardAmount" min="0" step="0.01" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateMixedPayment()">
              </div>
            </div>
            <p id="mixedPaymentWarning" style="color: #dc2626; margin-top: 10px; display: none;"></p>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button onclick="closeCheckoutModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å–æ¶ˆ
          </button>
          <button onclick="completeSale()" id="completeSaleBtn" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 16px;">
            âœ… ç¡®è®¤æ”¯ä»˜
          </button>
        </div>
      </div>
    </div>

    <!-- ç»´ä¿®ä¸šåŠ¡ -->
    <div id="repairs" class="tab-content">
      <div class="card">
        <h2>ğŸ”§ ç»´ä¿®ä¸šåŠ¡</h2>
        <button class="btn btn-success" onclick="showNewRepairModal()" style="margin-bottom: 15px;">+ æ–°å¢ç»´ä¿®è®¢å•</button>
        
        <!-- çŠ¶æ€ç­›é€‰ -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="filterRepairs('all')" id="filterBtn_all" class="btn" style="padding: 8px 16px; background: #6366f1; color: white;">
            å…¨éƒ¨
          </button>
          <button onclick="filterRepairs('pending')" id="filterBtn_pending" class="btn" style="padding: 8px 16px; background: #f59e0b; color: white;">
            å¾…ç»´ä¿®
          </button>
          <button onclick="filterRepairs('sent_out')" id="filterBtn_sent_out" class="btn" style="padding: 8px 16px; background: #8b5cf6; color: white;">
            å·²é€å‡º
          </button>
          <button onclick="filterRepairs('retrieved')" id="filterBtn_retrieved" class="btn" style="padding: 8px 16px; background: #10b981; color: white;">
            å·²å–å›
          </button>
          <button onclick="filterRepairs('completed')" id="filterBtn_completed" class="btn" style="padding: 8px 16px; background: #06b6d4; color: white;">
            å·²å®Œæˆ
          </button>
          <button onclick="filterRepairs('ready_for_sale')" id="filterBtn_ready_for_sale" class="btn" style="padding: 8px 16px; background: #ec4899; color: white;">
            ç­‰å¾…é”€å”®
          </button>
        </div>
        
        <div id="repairsTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ç»´ä¿®è®¢å•æ¨¡æ€æ¡† -->
    <div id="newRepairModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">ğŸ”§ æ–°å¢ç»´ä¿®è®¢å•</h3>
        
        <form id="newRepairForm" onsubmit="submitNewRepair(event)">
          <div style="display: grid; gap: 15px;">
            <!-- å®¢æˆ·ä¿¡æ¯ -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <h4 style="margin-bottom: 10px; color: #1e40af;">å®¢æˆ·ä¿¡æ¯</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·ç”µè¯ *</label>
                  <input type="text" id="repair_customerPhone" required placeholder="0851234567" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·å§“å</label>
                  <input type="text" id="repair_customerName" placeholder="é€‰å¡«" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
              </div>
            </div>
            
            <!-- è®¾å¤‡ä¿¡æ¯ -->
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <h4 style="margin-bottom: 10px; color: #92400e;">è®¾å¤‡ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">è®¾å¤‡åç§° *</label>
                  <input type="text" id="repair_deviceName" required placeholder="ä¾‹å¦‚: iPhone 13 Pro" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">IMEI</label>
                    <input type="text" id="repair_deviceIMEI" placeholder="é€‰å¡«" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">åºåˆ—å· (SN)</label>
                    <input type="text" id="repair_deviceSN" placeholder="é€‰å¡«" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ç»´ä¿®ä¿¡æ¯ -->
            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
              <h4 style="margin-bottom: 10px; color: #9f1239;">ç»´ä¿®ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">é—®é¢˜æè¿° *</label>
                  <textarea id="repair_problemDescription" required rows="3" placeholder="æè¿°è®¾å¤‡çš„é—®é¢˜..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å¤‡æ³¨</label>
                  <textarea id="repair_notes" rows="2" placeholder="å…¶ä»–å¤‡æ³¨ä¿¡æ¯..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®åœ°ç‚¹</label>
                    <input type="text" id="repair_location" placeholder="ç•™ç©ºè¡¨ç¤ºè‡ªå·±ç»´ä¿®" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">å¡«å†™åˆ™ä¸ºå¤–é€ç»´ä¿®</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é¢„è®¡å®Œæˆæ—¶é—´</label>
                    <input type="date" id="repair_estimatedDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®è´¹ç”¨ (â‚¬)</label>
                    <input type="number" id="repair_cost" min="0" step="0.01" value="0" placeholder="é€‰å¡«ï¼Œæˆæœ¬ä»·" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">ç»´ä¿®æˆæœ¬ï¼ˆé€‰å¡«ï¼‰</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é”€å”®ä»·æ ¼ (â‚¬) *</label>
                    <input type="number" id="repair_salePrice" min="0" step="0.01" required placeholder="å¿…å¡«ï¼Œé”€å”®ä»·" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #10b981; font-size: 12px;">å®¢æˆ·æ”¯ä»˜ä»·æ ¼ï¼ˆå¿…å¡«ï¼‰</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeNewRepairModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              âœ… åˆ›å»ºè®¢å•
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¼–è¾‘ç»´ä¿®è®¢å•æ¨¡æ€æ¡† -->
    <div id="editRepairModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px;">âœï¸ ç¼–è¾‘ç»´ä¿®è®¢å•</h3>
        
        <form id="editRepairForm" onsubmit="submitEditRepair(event)">
          <input type="hidden" id="edit_repair_id">
          
          <div style="display: grid; gap: 15px;">
            <!-- å®¢æˆ·ä¿¡æ¯ -->
            <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <h4 style="margin-bottom: 10px; color: #1e40af;">å®¢æˆ·ä¿¡æ¯</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·ç”µè¯ *</label>
                  <input type="text" id="edit_repair_customerPhone" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å®¢æˆ·å§“å</label>
                  <input type="text" id="edit_repair_customerName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
              </div>
            </div>
            
            <!-- è®¾å¤‡ä¿¡æ¯ -->
            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <h4 style="margin-bottom: 10px; color: #92400e;">è®¾å¤‡ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">è®¾å¤‡åç§° *</label>
                  <input type="text" id="edit_repair_deviceName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">IMEI</label>
                    <input type="text" id="edit_repair_deviceIMEI" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">åºåˆ—å· (SN)</label>
                    <input type="text" id="edit_repair_deviceSN" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ç»´ä¿®ä¿¡æ¯ -->
            <div style="background: #fce7f3; padding: 15px; border-radius: 8px; border-left: 4px solid #ec4899;">
              <h4 style="margin-bottom: 10px; color: #9f1239;">ç»´ä¿®ä¿¡æ¯</h4>
              <div style="display: grid; gap: 15px;">
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">é—®é¢˜æè¿° *</label>
                  <textarea id="edit_repair_problemDescription" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 5px;">å¤‡æ³¨</label>
                  <textarea id="edit_repair_notes" rows="2" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®åœ°ç‚¹</label>
                    <input type="text" id="edit_repair_location" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">ç•™ç©ºè¡¨ç¤ºè‡ªå·±ç»´ä¿®</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é¢„è®¡å®Œæˆæ—¶é—´</label>
                    <input type="date" id="edit_repair_estimatedDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">ç»´ä¿®è´¹ç”¨ (â‚¬)</label>
                    <input type="number" id="edit_repair_cost" min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666; font-size: 12px;">ç»´ä¿®æˆæœ¬ï¼ˆé€‰å¡«ï¼‰</small>
                  </div>
                  <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">é”€å”®ä»·æ ¼ (â‚¬) *</label>
                    <input type="number" id="edit_repair_salePrice" min="0" step="0.01" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #10b981; font-size: 12px;">å®¢æˆ·æ”¯ä»˜ä»·æ ¼ï¼ˆå¿…å¡«ï¼‰</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeEditRepairModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 30px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              âœ… ä¿å­˜ä¿®æ”¹
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- äº§å“æ—¶é—´çº¿æ¨¡æ€æ¡† -->
    <div id="productTimelineModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ“Š äº§å“æ—¶é—´çº¿</h3>
          <button onclick="closeProductTimeline()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="timelineProductName" style="font-size: 18px; font-weight: 600; color: #3b82f6; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;"></div>
        
        <div id="timelineContent" style="position: relative;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeProductTimeline()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘åº“å­˜äº§å“æ¨¡æ€æ¡† -->
    <div id="editInventoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">âœï¸ ç¼–è¾‘äº§å“ä¿¡æ¯</h3>
          <button onclick="closeEditInventoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <form id="editInventoryForm" onsubmit="saveInventoryEdit(event)">
          <input type="hidden" id="editInventoryId">
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">äº§å“åç§°</label>
              <input type="text" id="editProductName" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">å“ç‰Œ</label>
              <input type="text" id="editBrand" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">å‹å·</label>
              <input type="text" id="editModel" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">é¢œè‰²</label>
              <input type="text" id="editColor" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">æˆæœ¬ä»· (â‚¬)</label>
              <input type="number" id="editCostPrice" step="0.01" min="0" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">æ‰¹å‘ä»· (â‚¬)</label>
              <input type="number" id="editWholesalePrice" step="0.01" min="0" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">é›¶å”®ä»· (â‚¬)</label>
              <input type="number" id="editRetailPrice" step="0.01" min="0" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">ç¨åŠ¡åˆ†ç±»</label>
              <select id="editTaxClassification" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="VAT_23">VAT 23%</option>
                <option value="VAT_13.5">VAT 13.5%</option>
                <option value="VAT_9">VAT 9%</option>
                <option value="VAT_0">VAT 0%</option>
                <option value="Margin VAT">Margin VAT</option>
              </select>
            </div>
            
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600;">æˆè‰²</label>
              <input type="text" id="editCondition" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">çŠ¶æ€</label>
            <select id="editStatus" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
              <option value="active">âœ… Active (æ­£å¸¸)</option>
              <option value="damaged">âš ï¸ Damaged (æŸå)</option>
              <option value="repairing">ğŸ”§ Repairing (ç»´ä¿®ä¸­)</option>
              <option value="reserved">ğŸ“Œ Reserved (é¢„ç•™)</option>
              <option value="returned">â†©ï¸ Returned (é€€è´§)</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">ä½ç½®</label>
            <input type="text" id="editLocation" placeholder="ä¾‹å¦‚ï¼šè´§æ¶A-3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¤‡æ³¨</label>
            <textarea id="editNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
          </div>
          
          <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #f59e0b;">
            <div style="font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 3px;">âš ï¸ æ³¨æ„</div>
            <div style="font-size: 13px; color: #92400e;">åºåˆ—å·ã€IMEIã€æ¡ç ç­‰å”¯ä¸€æ ‡è¯†ç¬¦ä¸å¯ä¿®æ”¹</div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" onclick="closeEditInventoryModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              ğŸ’¾ ä¿å­˜ä¿®æ”¹
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- æœ¬æ—¥é”€å”®æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="dailySalesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ’° æœ¬æ—¥é”€å”®æ˜ç»†</h3>
          <button onclick="closeDailySalesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="dailySalesDate" style="font-size: 16px; color: #666; margin-bottom: 20px;"></div>
        
        <div id="dailySalesContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeDailySalesModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æœ¬æ—¥ç»´ä¿®æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="dailyRepairsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ”§ æœ¬æ—¥ç»´ä¿®æ˜ç»†</h3>
          <button onclick="closeDailyRepairsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="dailyRepairsDate" style="font-size: 16px; color: #666; margin-bottom: 20px;"></div>
        
        <div id="dailyRepairsContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeDailyRepairsModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ç¨é¢è®¡ç®—æ˜ç»†æ¨¡æ€æ¡† -->
    <div id="taxCalculationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 1000px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ğŸ“Š ç¨é¢è®¡ç®—è¿‡ç¨‹</h3>
          <button onclick="closeTaxCalculationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        
        <div id="taxCalculationDate" style="font-size: 16px; color: #666; margin-bottom: 20px;"></div>
        
        <div id="taxCalculationContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeTaxCalculationModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„åº“å­˜ -->
    <div id="my-inventory" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>æˆ‘çš„åº“å­˜</h2>
          <button class="btn btn-primary" onclick="showAddInventoryModal()" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
            + æ‰‹åŠ¨å…¥åº“
          </button>
        </div>
        
        <!-- æœç´¢æ¡† -->
        <div style="margin-bottom: 20px;">
          <input type="text" id="inventorySearchInput" placeholder="ğŸ” æœç´¢äº§å“åç§°ã€åºåˆ—å·ã€æ¡ç æˆ–å¤‡æ³¨..." 
            style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
            oninput="searchInventory()">
        </div>
        
        <!-- åˆ†ç±»åˆ—è¡¨ -->
        <div id="inventoryCategoryList" style="display: block;">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <!-- äº§å“åˆ—è¡¨ -->
        <div id="inventoryProductList" style="display: none;">
          <button onclick="backToInventoryCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
            â† è¿”å›åˆ†ç±»
          </button>
          <h3 id="currentInventoryCategoryName" style="margin-bottom: 15px;"></h3>
          <div id="inventoryProducts">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å…¥åº“æ¨¡æ€æ¡† -->
    <div id="addInventoryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="font-size: 20px; color: #333;">æ‰‹åŠ¨å…¥åº“</h3>
          <button onclick="closeAddInventoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
        </div>
        
        <!-- æ˜¾ç¤ºå½“å‰å•†æˆ·ä¿¡æ¯ -->
        <div style="background: #f0f9ff; padding: 12px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 18px;">ğŸ¢</span>
            <div>
              <div style="font-size: 12px; color: #666;">å…¥åº“åˆ°</div>
              <div style="font-weight: 600; color: #1e40af;" id="currentMerchantInfo">å½“å‰å•†æˆ·</div>
            </div>
          </div>
        </div>
        
        <form id="addInventoryForm" onsubmit="submitAddInventory(event)">
          <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">äº§å“åç§° *</label>
              <input type="text" id="inv_productName" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">å“ç‰Œ</label>
                <input type="text" id="inv_brand" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">å‹å·</label>
                <input type="text" id="inv_model" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">åˆ†ç±» *</label>
                <select id="inv_category" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  <option value="">è¯·é€‰æ‹©åˆ†ç±»...</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æ•°é‡ *</label>
                <input type="number" id="inv_quantity" required min="1" value="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æˆæœ¬ä»· (â‚¬) *</label>
                <input type="number" id="inv_costPrice" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æ‰¹å‘ä»· (â‚¬) *</label>
                <input type="number" id="inv_wholesalePrice" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">é›¶å”®ä»· (â‚¬) *</label>
                <input type="number" id="inv_retailPrice" required min="0" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æ¡ç </label>
                <input type="text" id="inv_barcode" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">åºåˆ—å·</label>
                <input type="text" id="inv_serialNumber" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">é¢œè‰²</label>
                <input type="text" id="inv_color" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              </div>
              <div>
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">æˆè‰²</label>
                <select id="inv_condition" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                  <option value="BRAND_NEW">å…¨æ–°</option>
                  <option value="PRE_OWNED">äºŒæ‰‹</option>
                  <option value="REFURBISHED">ç¿»æ–°</option>
                </select>
              </div>
            </div>
            
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #555;">å¤‡æ³¨</label>
              <textarea id="inv_notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" onclick="closeAddInventoryModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              å–æ¶ˆ
            </button>
            <button type="submit" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
              ç¡®è®¤å…¥åº“
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ç¾¤ç»„åº“å­˜ -->
    <div id="group-inventory" class="tab-content">
      <div class="card">
        <h2>ğŸ‘¥ ç¾¤ç»„åº“å­˜</h2>
                
        <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px;">
          <!-- å·¦ä¾§ï¼šåº“å­˜åŒºåŸŸ -->
          <div>
            <!-- æ­¥éª¤1ï¼šé€‰æ‹©åº—é“º -->
            <div id="groupStoreSelection" style="display: block;">
              <div style="background: #e0f2fe; padding: 20px; border-radius: 8px; border-left: 4px solid #0284c7; margin-bottom: 20px;">
                <h3 style="color: #075985; margin-bottom: 10px;">ğŸ“ æ­¥éª¤ 1: é€‰æ‹©åº—é“º</h3>
              </div>
              <div id="groupStoreList">
                <div class="loading">åŠ è½½ä¸­...</div>
              </div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šé€‰æ‹©åˆ†ç±» -->
            <div id="groupCategorySelection" style="display: none;">
              <button onclick="backToStoreSelection()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
                â† è¿”å›åº—é“ºé€‰æ‹©
              </button>
              <div style="background: #dbeafe; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 20px;">
                <h3 style="color: #1e40af; margin-bottom: 10px;">ğŸ“¦ æ­¥éª¤ 2: é€‰æ‹©åˆ†ç±»</h3>
                <p style="color: #1e40af; margin: 0;">
                  å½“å‰åº—é“º: <strong id="selectedStoreName"></strong>
                </p>
              </div>
              <div id="groupCategoryList">
                <div class="loading">åŠ è½½ä¸­...</div>
              </div>
            </div>
            
            <!-- æ­¥éª¤3ï¼šäº§å“åˆ—è¡¨ -->
            <div id="groupProductList" style="display: none;">
              <button onclick="backToGroupCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
                â† è¿”å›åˆ†ç±»
              </button>
              <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="color: #065f46; font-weight: 600;">åº—é“º: <span id="currentStoreName"></span></div>
                    <div style="color: #065f46; font-weight: 600;">åˆ†ç±»: <span id="currentCategoryName"></span></div>
                  </div>
                </div>
              </div>
              
              <!-- æœç´¢æ¡† -->
              <div style="margin-bottom: 20px;">
                <input type="text" id="groupInventorySearchInput" placeholder="ğŸ” æœç´¢äº§å“åç§°ã€åºåˆ—å·..." 
                  style="width: 100%; padding: 12px 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                  oninput="searchGroupInventory()">
              </div>
              
              <div id="groupInventoryTable">
                <div class="loading">åŠ è½½ä¸­...</div>
              </div>
            </div>
          </div>
          
          <!-- å³ä¾§ï¼šè°ƒè´§è´­ç‰©è½¦ï¼ˆå›ºå®šæ˜¾ç¤ºï¼‰ -->
          <div style="position: sticky; top: 20px; height: fit-content;">
            <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px;">
              <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ›’ è°ƒè´§æ¸…å•</span>
                <span id="transferCartCount" style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px;">0</span>
              </h3>
              
              <div id="transferCartTargetStore" style="display: none; background: #e0f2fe; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #0284c7;">
                <div style="font-size: 12px; color: #075985; margin-bottom: 3px;">ç›®æ ‡åº—é“º</div>
                <div style="font-weight: 600; color: #0c4a6e;" id="transferCartStoreName"></div>
              </div>
              
              <div id="transferCartItems" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                <p style="color: #9ca3af; text-align: center; padding: 40px 0;">è°ƒè´§æ¸…å•æ˜¯ç©ºçš„</p>
              </div>
              
              <div style="border-top: 2px solid #e5e7eb; padding-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px; font-weight: 600;">
                  <span>æ€»è®¡:</span>
                  <span style="color: #ef4444;">â‚¬<span id="transferCartTotal">0.00</span></span>
                </div>
                <button onclick="submitTransferRequest()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                  æäº¤è°ƒè´§ç”³è¯·
                </button>
                <button onclick="clearTransferCart()" style="width: 100%; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 10px;">
                  æ¸…ç©ºæ¸…å•
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¾¤ç»„åº“å­˜å˜ä½“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="groupVariantModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 10px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3 style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ¨ é€‰æ‹©å˜ä½“</span>
          <button onclick="closeGroupVariantModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
        </h3>
        
        <div id="groupVariantModalContent">
          <!-- åŠ¨æ€å†…å®¹ -->
        </div>
      </div>
    </div>

    <!-- è°ƒè´§ç®¡ç† -->
    <div id="transfer-management" class="tab-content">
      <div class="card">
        <h2>ğŸ“‹ è°ƒè´§ç®¡ç†</h2>
        <p style="color: #666; margin-bottom: 20px;">ç®¡ç†è°ƒè´§ç”³è¯·ã€å®¡æ‰¹å’Œæ”¶è´§</p>
        
        <!-- å­æ ‡ç­¾é¡µ -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
          <button class="transfer-sub-tab active" onclick="switchTransferTab('pending-approval')" id="tab-pending-approval">
            å¾…å®¡æ‰¹ <span class="badge badge-warning" id="badge-pending-approval">0</span>
          </button>
          <button class="transfer-sub-tab" onclick="switchTransferTab('pending-receive')" id="tab-pending-receive">
            å¾…æ”¶è´§ <span class="badge badge-info" id="badge-pending-receive">0</span>
          </button>
          <button class="transfer-sub-tab" onclick="switchTransferTab('my-requests')" id="tab-my-requests">
            æˆ‘å‘èµ·çš„ <span class="badge badge-primary" id="badge-my-requests">0</span>
          </button>
          <button class="transfer-sub-tab" onclick="switchTransferTab('completed')" id="tab-completed">
            å·²å®Œæˆ <span class="badge badge-success" id="badge-completed">0</span>
          </button>
        </div>
        
        <!-- å¾…å®¡æ‰¹åˆ—è¡¨ -->
        <div id="transfer-pending-approval" class="transfer-sub-content active">
          <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 20px;">
            <h4 style="color: #92400e; margin-bottom: 5px;">â³ å¾…å®¡æ‰¹çš„è°ƒè´§ç”³è¯·</h4>
            <p style="color: #92400e; margin: 0; font-size: 14px;">å…¶ä»–å•†æˆ·å‘æ‚¨å‘èµ·çš„è°ƒè´§ç”³è¯·ï¼Œéœ€è¦æ‚¨å®¡æ‰¹</p>
          </div>
          <div id="pendingApprovalList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
        
        <!-- å¾…æ”¶è´§åˆ—è¡¨ -->
        <div id="transfer-pending-receive" class="transfer-sub-content">
          <div style="background: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 20px;">
            <h4 style="color: #1e40af; margin-bottom: 5px;">ğŸ“¦ å¾…æ”¶è´§çš„è°ƒè´§</h4>
            <p style="color: #1e40af; margin: 0; font-size: 14px;">å·²æ‰¹å‡†çš„è°ƒè´§ç”³è¯·ï¼Œç­‰å¾…æ‚¨ç¡®è®¤æ”¶è´§</p>
          </div>
          <div id="pendingReceiveList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
        
        <!-- æˆ‘å‘èµ·çš„åˆ—è¡¨ -->
        <div id="transfer-my-requests" class="transfer-sub-content">
          <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1; margin-bottom: 20px;">
            <h4 style="color: #4338ca; margin-bottom: 5px;">ğŸ“¤ æˆ‘å‘èµ·çš„è°ƒè´§ç”³è¯·</h4>
            <p style="color: #4338ca; margin: 0; font-size: 14px;">æ‚¨å‘å…¶ä»–å•†æˆ·å‘èµ·çš„è°ƒè´§ç”³è¯·</p>
          </div>
          <div id="myRequestsList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
        
        <!-- å·²å®Œæˆåˆ—è¡¨ -->
        <div id="transfer-completed" class="transfer-sub-content">
          <div style="background: #d1fae5; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">
            <h4 style="color: #065f46; margin-bottom: 5px;">âœ… å·²å®Œæˆçš„è°ƒè´§</h4>
            <p style="color: #065f46; margin: 0; font-size: 14px;">å·²å®Œæˆçš„è°ƒè´§è®°å½•</p>
          </div>
          <div id="completedList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä»“åº“è®¢è´§ -->
    <div id="warehouse-order" class="tab-content">
      <div class="card">
        <h2>ğŸ“¦ ä»ä»“åº“è®¢è´§</h2>
                
        <!-- è®¢å•æ ‡ç­¾ -->
        <div style="margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
          <button id="warehouseOrderTabBtn" class="sub-tab active" onclick="switchWarehouseTab('order')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid #6366f1; color: #6366f1; font-weight: 600; cursor: pointer;">
            æµè§ˆäº§å“
          </button>
          <button id="warehouseMyOrdersTabBtn" class="sub-tab" onclick="switchWarehouseTab('myOrders')" style="padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; cursor: pointer;">
            æˆ‘çš„è®¢å•
          </button>
        </div>
        
        <!-- æµè§ˆäº§å“åŒºåŸŸ -->
        <div id="warehouseOrderSection">
          <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px;">
            <!-- å·¦ä¾§ï¼šäº§å“åŒºåŸŸ -->
            <div>
              <!-- åˆ†ç±»åˆ—è¡¨è§†å›¾ -->
              <div id="warehouseCategoryListView" style="display: block;">
                <div id="warehouseCategoryList">
                  <h3 style="margin-bottom: 15px;">é€‰æ‹©äº§å“åˆ†ç±»</h3>
                  <div id="warehouseCategories" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                    <div class="loading">åŠ è½½ä¸­...</div>
                  </div>
                </div>
              </div>
              
              <!-- äº§å“åˆ—è¡¨è§†å›¾ -->
              <div id="warehouseProductList" style="display: none;">
                <button onclick="backToWarehouseCategories()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">
                  â† è¿”å›åˆ†ç±»
                </button>
                <h3 id="currentWarehouseCategoryName" style="margin-bottom: 15px;"></h3>
                <div id="warehouseProducts" style="overflow-x: auto;">
                  <div class="loading">åŠ è½½ä¸­...</div>
                </div>
              </div>
            </div>
            
            <!-- å³ä¾§ï¼šè´­ç‰©è½¦ï¼ˆå›ºå®šæ˜¾ç¤ºï¼‰ -->
            <div style="position: sticky; top: 20px; height: fit-content;">
              <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px;">
                <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                  <span>ğŸ›’ è´­ç‰©è½¦</span>
                  <span id="warehouseCartCount" style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px;">0</span>
                </h3>
                
                <div id="warehouseCartItems" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px;">
                  <p style="color: #9ca3af; text-align: center; padding: 40px 0;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>
                </div>
                
                <div style="border-top: 2px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px; font-weight: 600;">
                    <span>æ€»è®¡:</span>
                    <span style="color: #ef4444;">â‚¬<span id="warehouseCartTotal">0.00</span></span>
                  </div>
                  <button onclick="submitWarehouseOrder()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    æäº¤è®¢å•
                  </button>
                  <button onclick="clearWarehouseCart()" style="width: 100%; padding: 8px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 10px;">
                    æ¸…ç©ºè´­ç‰©è½¦
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- æˆ‘çš„è®¢å•åŒºåŸŸ -->
        <div id="warehouseMyOrdersSection" style="display: none;">
          <div style="margin-bottom: 20px;">
            <select id="orderStatusFilter" onchange="loadMyWarehouseOrders()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 6px;">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending">å¾…ç¡®è®¤</option>
              <option value="confirmed">å·²ç¡®è®¤</option>
              <option value="shipped">å·²å‘è´§</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
          </div>
          
          <div id="myWarehouseOrdersList">
            <div class="loading">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- è®¢å•æäº¤å¯¹è¯æ¡† -->
    <div id="warehouseOrderSubmitModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeWarehouseOrderSubmitModal()">&times;</span>
        <h2>ğŸ“¦ æäº¤è®¢å•</h2>
        
        <div style="margin: 20px 0;">
          <h3 style="margin-bottom: 10px;">è®¢å•æ˜ç»†</h3>
          <div id="orderSubmitItems" style="max-height: 200px; overflow-y: auto; background: #f9fafb; padding: 15px; border-radius: 8px;">
          </div>
          <div style="text-align: right; margin-top: 10px; font-size: 18px; font-weight: 600;">
            æ€»è®¡: â‚¬<span id="orderSubmitTotal">0.00</span>
          </div>
        </div>
        
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…é€æ–¹å¼</label>
          <select id="deliveryMethod" onchange="toggleDeliveryFields()" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
            <option value="delivery">ğŸšš ç‰©æµé…é€</option>
            <option value="pickup">ğŸª åˆ°åº—è‡ªå–</option>
          </select>
        </div>
        
        <div id="deliveryAddressSection" style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">é…é€åœ°å€</label>
          <textarea id="deliveryAddress" rows="3" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="è¯·è¾“å…¥è¯¦ç»†é…é€åœ°å€"></textarea>
        </div>
        
        <div id="pickupLocationSection" style="margin: 20px 0; display: none;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">è‡ªå–åœ°ç‚¹</label>
          <select id="pickupLocation" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
            <option value="warehouse">ä»“åº“</option>
            <option value="store">é—¨åº—</option>
          </select>
        </div>
        
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600;">å¤‡æ³¨</label>
          <textarea id="orderNotes" rows="2" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;" placeholder="é€‰å¡«"></textarea>
        </div>
        
        <button id="confirmOrderSubmitBtn" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
          ç¡®è®¤æäº¤
        </button>
      </div>
    </div>

    <!-- è®¢å•è¯¦æƒ…å¯¹è¯æ¡† -->
    <div id="warehouseOrderDetailModal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeWarehouseOrderDetailModal()">&times;</span>
        <h2>ğŸ“‹ è®¢å•è¯¦æƒ…</h2>
        
        <div id="orderDetailContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- é”€å”®è®¢å•è¯¦æƒ…å’Œé€€æ¬¾å¯¹è¯æ¡† -->
    <div id="saleDetailModal" class="modal">
      <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
        <span class="close" onclick="closeSaleDetailModal()">&times;</span>
        <h2>ğŸ§¾ é”€å”®è®¢å•è¯¦æƒ…</h2>
        
        <div id="saleDetailContent">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
          <button onclick="closeSaleDetailModal()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            å…³é—­
          </button>
          <button onclick="processRefund()" style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            ğŸ’° å¤„ç†é€€æ¬¾
          </button>
        </div>
      </div>
    </div>

    <!-- æŠ¥è¡¨ä¸­å¿ƒ -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>åº“å­˜æŠ¥è¡¨</h2>
        <div id="inventoryReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div class="card">
        <h2>é”€å”®æŠ¥è¡¨</h2>
        <div id="salesReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç¨åŠ¡æŠ¥è¡¨ -->
    <div id="tax-report" class="tab-content">
      <div class="card">
        <h2>ç¨åŠ¡æŠ¥è¡¨</h2>
        <div class="form-grid" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="taxStartDate">
          </div>
          <div class="form-group">
            <label>ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="taxEndDate">
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="generateTaxReport()">ğŸ“Š ç”ŸæˆæŠ¥è¡¨</button>
          <button class="btn" onclick="exportTaxReportPDF()" id="exportTaxPdfBtn" style="display: none; background: #10b981; color: white;">ğŸ“¥ å¯¼å‡ºPDF</button>
        </div>
        
        <div id="taxReportContent" style="margin-top: 20px;">
          <div class="loading">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç”ŸæˆæŠ¥è¡¨</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const merchantId = localStorage.getItem('username') || 'merchant_001'; // ä»ç™»å½•sessionè·å–
    
    // è´­ç‰©è½¦
    let cart = [];
    let selectedPaymentMethod = null;

    // åŠ è½½å•†æˆ·ä¿¡æ¯
    async function loadMerchantInfo() {
      try {
        // ä» localStorage è·å–ç”¨æˆ·å
        const userName = localStorage.getItem('username') || 'Guest';
        document.getElementById('merchantWelcome').textContent = `ğŸ¢ Welcome ${userName}`;
        document.title = `Welcome ${userName} - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ`;
      } catch (error) {
        console.error('åŠ è½½å•†æˆ·ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('merchantWelcome').textContent = `ğŸ¢ Welcome`;
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'sales': loadCategoryList(); break;
        case 'repairs': loadRepairs(); break;
        case 'my-inventory': loadMyInventory(); break;
        case 'group-inventory': loadGroupInventory(); break;
        case 'transfer-management': loadTransferManagement(); break;
        case 'warehouse-order': switchWarehouseTab('order'); break;
        case 'reports': loadReports(); break;
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/merchant/stats?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          document.getElementById('myInventory').textContent = stats.myInventory || 0;
          document.getElementById('dailySales').textContent = 'â‚¬' + (stats.dailySales || 0).toFixed(2);
          document.getElementById('dailyRepairs').textContent = 'â‚¬' + (stats.dailyRepairs || 0).toFixed(2);
          document.getElementById('taxDue').textContent = 'â‚¬' + (stats.taxDue || 0).toFixed(2);
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // æ˜¾ç¤ºæœ¬æ—¥é”€å”®æ˜ç»†
    async function showDailySalesDetails() {
      document.getElementById('dailySalesModal').style.display = 'flex';
      
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
      document.getElementById('dailySalesDate').textContent = `ğŸ“… ${dateStr}`;
      document.getElementById('dailySalesContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const startDate = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const endDate = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
          // è¿‡æ»¤æ‰å·²é€€æ¬¾çš„é”€å”®è®°å½•ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
          const sales = result.data.filter(sale => !sale.status || sale.status.toUpperCase() !== 'REFUNDED');
          const refundedSales = result.data.filter(sale => sale.status && sale.status.toUpperCase() === 'REFUNDED');
          
          if (sales.length === 0) {
            document.getElementById('dailySalesContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— æœ‰æ•ˆé”€å”®è®°å½•ï¼ˆæ‰€æœ‰é”€å”®å·²é€€æ¬¾ï¼‰</p>';
            return;
          }
          
          let totalAmount = 0;
          let totalTax = 0;
          let totalProfit = 0;
          
          let html = `
            <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <h4 style="margin-bottom: 10px; color: #1e40af;">é”€å”®æ±‡æ€»</h4>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div>
                  <div style="font-size: 12px; color: #666;">æœ‰æ•ˆé”€å”®ç¬”æ•°</div>
                  <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${sales.length}</div>
                  ${refundedSales.length > 0 ? `<div style="font-size: 11px; color: #dc2626; margin-top: 2px;">å·²é€€æ¬¾: ${refundedSales.length} ç¬”</div>` : ''}
                </div>
                <div id="dailySalesSummary"></div>
              </div>
            </div>
            
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                  <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                  <th style="padding: 12px; text-align: left;">äº§å“</th>
                  <th style="padding: 12px; text-align: right;">æ•°é‡</th>
                  <th style="padding: 12px; text-align: right;">é‡‘é¢</th>
                  <th style="padding: 12px; text-align: right;">ç¨é¢</th>
                  <th style="padding: 12px; text-align: left;">æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          sales.forEach(sale => {
            totalAmount += sale.totalAmount || 0;
            totalTax += sale.totalTax || 0;
            
            // è®¡ç®—åˆ©æ¶¦
            sale.items.forEach(item => {
              totalProfit += (item.price - item.costPrice) * item.quantity;
            });
            
            const time = new Date(sale.date).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const paymentMethod = sale.paymentMethod === 'CASH' ? 'ğŸ’µ ç°é‡‘' : 
                                 sale.paymentMethod === 'CARD' ? 'ğŸ’³ åˆ·å¡' : 'ğŸ’° æ··åˆ';
            
            html += `
              <tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;">${time}</td>
                <td style="padding: 12px;">
                  ${sale.items.map(item => `
                    <div style="margin-bottom: 5px;">
                      ${item.productName} ${item.serialNumber ? `<small style="color: #666;">(${item.serialNumber})</small>` : ''}
                    </div>
                  `).join('')}
                </td>
                <td style="padding: 12px; text-align: right;">
                  ${sale.items.map(item => `<div style="margin-bottom: 5px;">${item.quantity}</div>`).join('')}
                </td>
                <td style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">
                  â‚¬${sale.totalAmount.toFixed(2)}
                </td>
                <td style="padding: 12px; text-align: right; color: #f59e0b;">
                  â‚¬${(sale.totalTax || 0).toFixed(2)}
                </td>
                <td style="padding: 12px;">${paymentMethod}</td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
              <tfoot>
                <tr style="background: #f9fafb; font-weight: bold; border-top: 2px solid #e5e7eb;">
                  <td colspan="3" style="padding: 12px; text-align: right;">åˆè®¡ï¼ˆä¸å«é€€æ¬¾ï¼‰ï¼š</td>
                  <td style="padding: 12px; text-align: right; color: #10b981;">â‚¬${totalAmount.toFixed(2)}</td>
                  <td style="padding: 12px; text-align: right; color: #f59e0b;">â‚¬${totalTax.toFixed(2)}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          `;
          
          // å¦‚æœæœ‰é€€æ¬¾è®°å½•ï¼Œæ˜¾ç¤ºè­¦å‘Š
          if (refundedSales.length > 0) {
            const refundedTotal = refundedSales.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
            html += `
              <div style="margin-top: 15px; padding: 12px; background: #fee2e2; border-radius: 6px; border-left: 3px solid #dc2626;">
                <div style="font-size: 12px; color: #991b1b; font-weight: bold;">âš ï¸ ä»Šæ—¥é€€æ¬¾è®°å½•</div>
                <div style="font-size: 11px; color: #7f1d1d; margin-top: 5px;">
                  å·²é€€æ¬¾è®¢å•: ${refundedSales.length} ç¬” | é€€æ¬¾é‡‘é¢: â‚¬${refundedTotal.toFixed(2)}
                </div>
              </div>
            `;
          }
          
          document.getElementById('dailySalesContent').innerHTML = html;
          
          // æ›´æ–°æ±‡æ€»ä¿¡æ¯
          document.getElementById('dailySalesSummary').innerHTML = `
            <div>
              <div style="font-size: 12px; color: #666;">æœ‰æ•ˆé”€å”®é¢</div>
              <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${totalAmount.toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #666;">åˆ©æ¶¦</div>
              <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">â‚¬${totalProfit.toFixed(2)}</div>
            </div>
          `;
        } else {
          document.getElementById('dailySalesContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— é”€å”®è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½é”€å”®æ˜ç»†å¤±è´¥:', error);
        document.getElementById('dailySalesContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­æœ¬æ—¥é”€å”®æ˜ç»†æ¨¡æ€æ¡†
    function closeDailySalesModal() {
      document.getElementById('dailySalesModal').style.display = 'none';
    }

    // æ˜¾ç¤ºæœ¬æ—¥ç»´ä¿®æ˜ç»†
    async function showDailyRepairsDetails() {
      document.getElementById('dailyRepairsModal').style.display = 'flex';
      
      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
      document.getElementById('dailyRepairsDate').textContent = `ğŸ“… ${dateStr}`;
      document.getElementById('dailyRepairsContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          // ç­›é€‰ä»Šæ—¥åˆ›å»ºçš„ç»´ä¿®è®¢å•
          const todayRepairs = result.data.filter(repair => {
            const createdDate = new Date(repair.createdAt);
            return createdDate >= today && createdDate < tomorrow;
          });
          
          if (todayRepairs.length > 0) {
            let totalCost = 0;
            let totalSalePrice = 0;
            const statusCount = {};
            
            todayRepairs.forEach(repair => {
              totalCost += repair.repairCost || 0;
              totalSalePrice += repair.salePrice || 0;
              statusCount[repair.status] = (statusCount[repair.status] || 0) + 1;
            });
            
            const statusNames = {
              'pending': 'å¾…ç»´ä¿®',
              'sent_out': 'å·²é€å‡º',
              'retrieved': 'å·²å–å›',
              'completed': 'å·²å®Œæˆ',
              'ready_for_sale': 'ç­‰å¾…é”€å”®',
              'sold': 'å·²é”€å”®',
              'cancelled': 'å·²å–æ¶ˆ'
            };
            
            let html = `
              <div style="margin-bottom: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <h4 style="margin-bottom: 10px; color: #92400e;">ç»´ä¿®æ±‡æ€»</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                  <div>
                    <div style="font-size: 12px; color: #666;">è®¢å•æ•°é‡</div>
                    <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${todayRepairs.length}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">ç»´ä¿®æˆæœ¬</div>
                    <div style="font-size: 20px; font-weight: bold; color: #dc3545;">â‚¬${totalCost.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">é¢„è®¡æ”¶å…¥</div>
                    <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${totalSalePrice.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">é¢„è®¡åˆ©æ¶¦</div>
                    <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">â‚¬${(totalSalePrice - totalCost).toFixed(2)}</div>
                  </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #fde68a;">
                  <div style="font-size: 12px; color: #666; margin-bottom: 8px;">çŠ¶æ€åˆ†å¸ƒï¼š</div>
                  <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    ${Object.entries(statusCount).map(([status, count]) => `
                      <span style="background: white; padding: 4px 12px; border-radius: 20px; font-size: 13px;">
                        ${statusNames[status]}: <strong>${count}</strong>
                      </span>
                    `).join('')}
                  </div>
                </div>
              </div>
              
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 12px; text-align: left;">æ—¶é—´</th>
                    <th style="padding: 12px; text-align: left;">å®¢æˆ·</th>
                    <th style="padding: 12px; text-align: left;">è®¾å¤‡</th>
                    <th style="padding: 12px; text-align: left;">é—®é¢˜</th>
                    <th style="padding: 12px; text-align: right;">æˆæœ¬</th>
                    <th style="padding: 12px; text-align: right;">å”®ä»·</th>
                    <th style="padding: 12px; text-align: center;">çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            todayRepairs.forEach(repair => {
              const time = new Date(repair.createdAt).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
              const statusColors = {
                'pending': '#f59e0b',
                'sent_out': '#8b5cf6',
                'retrieved': '#10b981',
                'completed': '#06b6d4',
                'ready_for_sale': '#ec4899',
                'sold': '#6b7280',
                'cancelled': '#ef4444'
              };
              
              html += `
                <tr style="border-bottom: 1px solid #e5e7eb;">
                  <td style="padding: 12px;">${time}</td>
                  <td style="padding: 12px;">
                    ${repair.customerPhone}<br>
                    <small style="color: #666;">${repair.customerName || '-'}</small>
                  </td>
                  <td style="padding: 12px;">
                    ${repair.deviceName}<br>
                    <small style="color: #666;">${repair.deviceIMEI || repair.deviceSN || '-'}</small>
                  </td>
                  <td style="padding: 12px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${repair.problemDescription}">
                    ${repair.problemDescription}
                  </td>
                  <td style="padding: 12px; text-align: right; color: #dc3545;">
                    â‚¬${(repair.repairCost || 0).toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">
                    â‚¬${(repair.salePrice || 0).toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    <span style="background: ${statusColors[repair.status]}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                      ${statusNames[repair.status]}
                    </span>
                  </td>
                </tr>
              `;
            });
            
            html += `
                </tbody>
              </table>
            `;
            
            document.getElementById('dailyRepairsContent').innerHTML = html;
          } else {
            document.getElementById('dailyRepairsContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— ç»´ä¿®è®¢å•</p>';
          }
        } else {
          document.getElementById('dailyRepairsContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ä»Šæ—¥æš‚æ— ç»´ä¿®è®¢å•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç»´ä¿®æ˜ç»†å¤±è´¥:', error);
        document.getElementById('dailyRepairsContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­æœ¬æ—¥ç»´ä¿®æ˜ç»†æ¨¡æ€æ¡†
    function closeDailyRepairsModal() {
      document.getElementById('dailyRepairsModal').style.display = 'none';
    }

    // æ˜¾ç¤ºç¨é¢è®¡ç®—æ˜ç»†
    async function showTaxCalculationDetails() {
      document.getElementById('taxCalculationModal').style.display = 'flex';
      
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const dateStr = `${firstDay.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' })} - ${today.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' })}`;
      document.getElementById('taxCalculationDate').textContent = `ğŸ“… æœ¬æœˆç»Ÿè®¡æœŸé—´: ${dateStr}`;
      document.getElementById('taxCalculationContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const startDate = firstDay.toISOString();
        const endDate = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
          const sales = result.data;
          
          // æŒ‰ç¨ç‡åˆ†ç±»ç»Ÿè®¡
          const taxByRate = {};
          let totalTax = 0;
          let totalSales = 0;
          let totalRefundedAmount = 0;
          let refundedItemsCount = 0;
          
          sales.forEach(sale => {
            // è·å–è¯¥è®¢å•çš„é€€æ¬¾å•†å“åˆ—è¡¨
            const refundedItemsInSale = sale.refundItems || [];
            
            sale.items.forEach(item => {
              // æ£€æŸ¥è¯¥å•†å“æ˜¯å¦è¢«é€€æ¬¾
              const isItemRefunded = refundedItemsInSale.some(refundItem => {
                if (item.serialNumber && refundItem.serialNumber) {
                  return item.serialNumber === refundItem.serialNumber;
                }
                return refundItem.productName === item.productName && 
                       refundItem.price === item.price;
              });
              
              // è·³è¿‡å·²é€€æ¬¾çš„å•†å“
              if (isItemRefunded) {
                const itemTotal = item.price * item.quantity;
                totalRefundedAmount += itemTotal;
                refundedItemsCount += item.quantity;
                return;
              }
              
              // åªè®¡ç®—æœªé€€æ¬¾çš„å•†å“
              const itemTotal = item.price * item.quantity;
              totalSales += itemTotal;
              
              const taxClass = item.taxClassification || 'VAT_23';
              let itemTax = 0;
              
              // è®¡ç®—ç¨é¢
              if (taxClass === 'VAT_23') {
                itemTax = itemTotal * (23 / 123);
              } else if (taxClass === 'SERVICE_VAT_13_5' || taxClass === 'VAT_13_5') {
                itemTax = itemTotal * (13.5 / 113.5);
              } else if (taxClass === 'VAT_9') {
                itemTax = itemTotal * (9 / 109);
              } else if (taxClass === 'MARGIN_VAT_0') {
                const itemCost = (item.costPrice || 0) * item.quantity;
                const margin = itemTotal - itemCost;
                itemTax = margin * (23 / 123);
              }
              // VAT_0 ç¨é¢ä¸º 0
              
              totalTax += itemTax;
              
              // æŒ‰ç¨ç‡åˆ†ç±»
              if (!taxByRate[taxClass]) {
                taxByRate[taxClass] = {
                  totalAmount: 0,
                  totalCost: 0,
                  totalTax: 0,
                  count: 0,
                  items: []
                };
              }
              
              const itemCost = (item.costPrice || 0) * item.quantity;
              
              taxByRate[taxClass].totalAmount += itemTotal;
              taxByRate[taxClass].totalCost += itemCost;
              taxByRate[taxClass].totalTax += itemTax;
              taxByRate[taxClass].count += item.quantity;
              
              taxByRate[taxClass].items.push({
                name: item.productName,
                quantity: item.quantity,
                price: item.price,
                costPrice: item.costPrice || 0,
                total: itemTotal,
                tax: itemTax,
                date: sale.date
              });
            });
          });
          
          // ç¨ç‡åç§°å’Œç¨ç‡
          const taxRates = {
            'VAT_23': { name: 'VAT 23%', rate: 23, formula: 'é”€å”®é¢ Ã— 23 / 123' },
            'VAT_13_5': { name: 'VAT 13.5%', rate: 13.5, formula: 'é”€å”®é¢ Ã— 13.5 / 113.5' },
            'SERVICE_VAT_13_5': { name: 'æœåŠ¡ VAT 13.5%', rate: 13.5, formula: 'é”€å”®é¢ Ã— 13.5 / 113.5' },
            'VAT_9': { name: 'VAT 9%', rate: 9, formula: 'é”€å”®é¢ Ã— 9 / 109' },
            'VAT_0': { name: 'VAT 0%', rate: 0, formula: 'å…ç¨' },
            'MARGIN_VAT_0': { name: 'å·®ä»·å¾ç¨ VAT 23%', rate: 23, formula: '(é”€å”®ä»· - æˆæœ¬ä»·) Ã— 23 / 123' }
          };
          
          let html = `
            <div style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
              <h4 style="margin-bottom: 10px; color: #065f46;">ç¨é¢æ±‡æ€»ï¼ˆä¸å«é€€æ¬¾ï¼‰</h4>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div>
                  <div style="font-size: 12px; color: #666;">æœ‰æ•ˆé”€å”®é¢</div>
                  <div style="font-size: 24px; font-weight: bold; color: #10b981;">â‚¬${totalSales.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">åº”ç¼´ç¨é¢</div>
                  <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">â‚¬${totalTax.toFixed(2)}</div>
                </div>
                <div>
                  <div style="font-size: 12px; color: #666;">å‡€æ”¶å…¥</div>
                  <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">â‚¬${(totalSales - totalTax).toFixed(2)}</div>
                </div>
              </div>
              ${refundedItemsCount > 0 ? `
                <div style="margin-top: 10px; padding: 10px; background: #fee2e2; border-radius: 6px; border-left: 3px solid #dc2626;">
                  <div style="font-size: 12px; color: #991b1b; font-weight: bold;">âš ï¸ å·²æ’é™¤é€€æ¬¾å•†å“</div>
                  <div style="font-size: 11px; color: #7f1d1d; margin-top: 5px;">
                    é€€æ¬¾å•†å“: ${refundedItemsCount} ä»¶ | é€€æ¬¾é‡‘é¢: â‚¬${totalRefundedAmount.toFixed(2)}
                  </div>
                </div>
              ` : ''}
            </div>
          `;
          
          // æŒ‰ç¨ç‡åˆ†ç±»æ˜¾ç¤º
          Object.entries(taxByRate).forEach(([taxClass, data]) => {
            const taxInfo = taxRates[taxClass] || { name: taxClass, rate: 0, formula: 'æœªçŸ¥' };
            
            html += `
              <div style="margin-bottom: 20px; padding: 15px; background: white; border: 2px solid #e5e7eb; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e5e7eb;">
                  <div>
                    <h4 style="margin: 0; color: #1e40af;">${taxInfo.name}</h4>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">
                      è®¡ç®—å…¬å¼: <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">${taxInfo.formula}</code>
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 12px; color: #666;">å•†å“æ•°é‡</div>
                    <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${data.count}</div>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; padding: 15px; background: #f9fafb; border-radius: 6px;">
                  <div>
                    <div style="font-size: 12px; color: #666;">é”€å”®é¢</div>
                    <div style="font-size: 18px; font-weight: bold; color: #10b981;">â‚¬${data.totalAmount.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">ç¨é¢</div>
                    <div style="font-size: 18px; font-weight: bold; color: #f59e0b;">â‚¬${data.totalTax.toFixed(2)}</div>
                  </div>
                  <div>
                    <div style="font-size: 12px; color: #666;">å‡€é¢</div>
                    <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">â‚¬${(data.totalAmount - data.totalTax).toFixed(2)}</div>
                  </div>
                </div>
                
                <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                  <strong>è®¡ç®—è¿‡ç¨‹ï¼š</strong>
                </div>
                <div style="background: #f9fafb; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px;">
                  ${taxClass === 'MARGIN_VAT_0' ? `
                    é”€å”®é¢: â‚¬${data.totalAmount.toFixed(2)}<br>
                    æˆæœ¬ä»·: â‚¬${data.totalCost.toFixed(2)}<br>
                    åˆ©æ¶¦: â‚¬${(data.totalAmount - data.totalCost).toFixed(2)}<br>
                    ç¨ç‡: 23%<br>
                    ç¨é¢ = (â‚¬${data.totalAmount.toFixed(2)} - â‚¬${data.totalCost.toFixed(2)}) Ã— 23 / 123 = â‚¬${data.totalTax.toFixed(2)}
                  ` : `
                    é”€å”®é¢: â‚¬${data.totalAmount.toFixed(2)}<br>
                    ç¨ç‡: ${taxInfo.rate}%<br>
                    ${taxInfo.rate > 0 ? `ç¨é¢ = â‚¬${data.totalAmount.toFixed(2)} Ã— ${taxInfo.rate} / ${100 + taxInfo.rate} = â‚¬${data.totalTax.toFixed(2)}` : 'å…ç¨å•†å“ï¼Œç¨é¢ = â‚¬0.00'}
                  `}
                </div>
              </div>
            `;
          });
          
          html += `
            <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
              <h4 style="margin-bottom: 10px; color: #92400e;">ğŸ’¡ ç¨é¢è¯´æ˜</h4>
              <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 14px; line-height: 1.8;">
                <li>VAT 23%ï¼šæ ‡å‡†ç¨ç‡ï¼Œé€‚ç”¨äºå¤§å¤šæ•°å•†å“</li>
                <li>VAT 13.5%ï¼šé™ä½ç¨ç‡ï¼Œé€‚ç”¨äºç‰¹å®šå•†å“å’ŒæœåŠ¡</li>
                <li>VAT 9%ï¼šè¶…ä½ç¨ç‡ï¼Œé€‚ç”¨äºç‰¹æ®Šå•†å“</li>
                <li>VAT 0%ï¼šå…ç¨å•†å“</li>
                <li>å·®ä»·å¾ç¨ VAT 23%ï¼šé€‚ç”¨äºäºŒæ‰‹å•†å“ï¼Œä»…å¯¹åˆ©æ¶¦éƒ¨åˆ†å¾ç¨ï¼Œè®¡ç®—å…¬å¼ï¼š(é”€å”®ä»· - æˆæœ¬ä»·) Ã— 23 / 123</li>
                <li>ç¨é¢è®¡ç®—é‡‡ç”¨å«ç¨ä»·æ ¼åæ¨æ³•</li>
                <li><strong>å·²é€€æ¬¾çš„å•†å“ä¸è®¡å…¥ç¨é¢è®¡ç®—</strong></li>
              </ul>
            </div>
          `;
          
          document.getElementById('taxCalculationContent').innerHTML = html;
        } else {
          document.getElementById('taxCalculationContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æœ¬æœˆæš‚æ— é”€å”®è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç¨é¢è®¡ç®—å¤±è´¥:', error);
        document.getElementById('taxCalculationContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­ç¨é¢è®¡ç®—æ˜ç»†æ¨¡æ€æ¡†
    function closeTaxCalculationModal() {
      document.getElementById('taxCalculationModal').style.display = 'none';
    }

    // ==================== é”€å”®ä¸šåŠ¡ - è´­ç‰©è½¦æ¨¡å¼ ====================
    
    // åŠ è½½äº§å“åˆ†ç±»åˆ—è¡¨
    async function loadCategoryList() {
      const container = document.getElementById('categoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        // è·å–åº“å­˜äº§å“
        const inventoryResponse = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const inventoryResult = await inventoryResponse.json();
        
        // è·å–å¾…é”€å”®çš„ç»´ä¿®è®¢å•
        const repairsResponse = await fetch(`${API_BASE}/merchant/repairs/ready-for-sale?merchantId=${merchantId}`);
        const repairsResult = await repairsResponse.json();
        
        const categories = {};
        let repairCount = 0;
        
        // å¤„ç†åº“å­˜äº§å“
        if (inventoryResult.success && inventoryResult.data.length > 0) {
          inventoryResult.data.forEach(item => {
            if (item.quantity > 0 && item.status === 'active') {
              // category æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
              const categoryName = item.category || 'æœªåˆ†ç±»';
              if (!categories[categoryName]) {
                categories[categoryName] = {
                  name: categoryName,
                  count: 0,
                  totalQty: 0
                };
              }
              categories[categoryName].count++;
              categories[categoryName].totalQty += item.quantity;
            }
          });
        }
        
        // ç»Ÿè®¡ç»´ä¿®è®¢å•æ•°é‡
        if (repairsResult.success && repairsResult.data.length > 0) {
          repairCount = repairsResult.data.length;
        }
        
        const categoryArray = Object.values(categories);
        
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">';
        
        // æ·»åŠ ç»´ä¿®è®¢å•åˆ†ç±»ï¼ˆå¦‚æœæœ‰ï¼‰
        if (repairCount > 0) {
          html += `
            <div onclick="showRepairOrders()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
              <div style="font-size: 40px; margin-bottom: 10px;">ğŸ”§</div>
              <h3 style="font-size: 18px; margin-bottom: 10px;">ç»´ä¿®è®¢å•</h3>
              <div style="font-size: 14px; opacity: 0.9;">
                ${repairCount} ä¸ªå¾…é”€å”®è®¢å•
              </div>
            </div>
          `;
        }
        
        // æ·»åŠ åº“å­˜äº§å“åˆ†ç±»
        if (categoryArray.length > 0) {
          html += categoryArray.map(cat => `
            <div onclick="showCategoryProducts('${cat.name}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
              onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
              <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¦</div>
              <h3 style="font-size: 18px; margin-bottom: 10px;">${cat.name}</h3>
              <div style="font-size: 14px; opacity: 0.9;">
                ${cat.count} ç§äº§å“ Â· ${cat.totalQty} ä»¶åº“å­˜
              </div>
            </div>
          `).join('');
        }
        
        html += '</div>';
        
        if (categoryArray.length > 0 || repairCount > 0) {
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¯é”€å”®äº§å“</p>';
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºç»´ä¿®è®¢å•åˆ—è¡¨
    async function showRepairOrders() {
      document.getElementById('categoryList').style.display = 'none';
      document.getElementById('categoryProducts').style.display = 'block';
      document.getElementById('currentCategoryName').textContent = 'ğŸ”§ ç»´ä¿®è®¢å•';
      
      const container = document.getElementById('productList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/ready-for-sale?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <div style="display: grid; gap: 15px;">
              ${result.data.map(repair => `
                <div style="background: white; border: 2px solid #f59e0b; border-radius: 10px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                  <div style="flex: 1;">
                    <h4 style="font-size: 18px; margin-bottom: 8px;">ğŸ”§ ${repair.deviceName}</h4>
                    <div style="color: #666; font-size: 14px; margin-bottom: 8px;">
                      å®¢æˆ·: ${repair.customerPhone}${repair.customerName ? ` (${repair.customerName})` : ''}
                      ${repair.deviceIMEI ? `<br>IMEI: ${repair.deviceIMEI}` : ''}
                      ${repair.deviceSN ? `<br>SN: ${repair.deviceSN}` : ''}
                    </div>
                    <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                      é—®é¢˜: ${repair.problemDescription}
                    </div>
                    <div style="display: flex; gap: 15px; align-items: center;">
                      <span style="background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                        æˆæœ¬: â‚¬${repair.repairCost.toFixed(2)}
                      </span>
                      <span style="color: #10b981; font-size: 20px; font-weight: bold;">
                        å”®ä»·: â‚¬${repair.salePrice.toFixed(2)}
                      </span>
                    </div>
                  </div>
                  <div>
                    <button onclick="addRepairToCart('${repair._id}', '${repair.deviceName}', ${repair.repairCost}, ${repair.salePrice}, '${repair.customerPhone}')" 
                      style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
                      + åŠ å…¥è´­ç‰©è½¦
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¾…é”€å”®çš„ç»´ä¿®è®¢å•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç»´ä¿®è®¢å•å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // å°†ç»´ä¿®è®¢å•åŠ å…¥è´­ç‰©è½¦
    function addRepairToCart(repairId, deviceName, repairCost, salePrice, customerPhone) {
      // ä½¿ç”¨é¢„è®¾çš„é”€å”®ä»·æ ¼
      const price = salePrice;
      
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
      const existingItem = cart.find(item => item.repairId === repairId);
      
      if (existingItem) {
        alert('æ­¤ç»´ä¿®è®¢å•å·²åœ¨è´­ç‰©è½¦ä¸­');
        return;
      }
      
      cart.push({
        repairId: repairId,
        productName: `ğŸ”§ ${deviceName} (Repair Service)`,
        price: price,
        quantity: 1,
        maxQty: 1,
        taxClassification: 'SERVICE_VAT_13_5', // ç»´ä¿®æœåŠ¡ä½¿ç”¨13.5%ç¨ç‡
        isRepair: true,
        customerPhone: customerPhone
      });
      
      updateCartDisplay();
      alert(`âœ… ${deviceName} ç»´ä¿®è®¢å•å·²æ·»åŠ åˆ°è´­ç‰©è½¦\né”€å”®ä»·æ ¼: â‚¬${price.toFixed(2)}`);
    }
    
    // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰äº§å“
    let allInventoryProducts = [];
    let allCategoryProducts = [];
    let currentCategory = '';
    let groupedProductsCache = {}; // ç¼“å­˜åˆ†ç»„åçš„äº§å“æ•°æ®
    
    // å…¨å±€æœç´¢äº§å“
    async function globalSearchProducts() {
      const searchTerm = document.getElementById('globalProductSearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        // æœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºåˆ†ç±»åˆ—è¡¨
        document.getElementById('categoryList').style.display = 'block';
        document.getElementById('globalSearchResults').style.display = 'none';
        document.getElementById('categoryProducts').style.display = 'none';
        return;
      }
      
      // éšè—åˆ†ç±»åˆ—è¡¨å’Œåˆ†ç±»äº§å“
      document.getElementById('categoryList').style.display = 'none';
      document.getElementById('categoryProducts').style.display = 'none';
      document.getElementById('globalSearchResults').style.display = 'block';
      
      const container = document.getElementById('globalSearchProductList');
      container.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
      
      try {
        // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½æ‰€æœ‰äº§å“ï¼Œå…ˆåŠ è½½
        if (allInventoryProducts.length === 0) {
          const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
          const result = await response.json();
          
          if (result.success) {
            allInventoryProducts = result.data.filter(item => 
              item.quantity > 0 && item.status === 'active'
            );
          }
        }
        
        // è¿‡æ»¤äº§å“
        const filteredProducts = allInventoryProducts.filter(item => {
          const productName = (item.productName || '').toLowerCase();
          const imei = (item.imei || '').toLowerCase();
          const serialNumber = (item.serialNumber || '').toLowerCase();
          const barcode = (item.barcode || '').toLowerCase();
          const notes = (item.notes || '').toLowerCase();
          const brand = (item.brand || '').toLowerCase();
          const model = (item.model || '').toLowerCase();
          const color = (item.color || '').toLowerCase();
          const category = (item.category || '').toLowerCase();
          
          return productName.includes(searchTerm) ||
                 imei.includes(searchTerm) ||
                 serialNumber.includes(searchTerm) ||
                 barcode.includes(searchTerm) ||
                 notes.includes(searchTerm) ||
                 brand.includes(searchTerm) ||
                 model.includes(searchTerm) ||
                 color.includes(searchTerm) ||
                 category.includes(searchTerm);
        });
        
        displayProducts(filteredProducts, 'globalSearchProductList');
      } catch (error) {
        container.innerHTML = `<div class="loading">æœç´¢å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ¸…é™¤å…¨å±€æœç´¢
    function clearGlobalSearch() {
      document.getElementById('globalProductSearchInput').value = '';
      document.getElementById('categoryList').style.display = 'block';
      document.getElementById('globalSearchResults').style.display = 'none';
      document.getElementById('categoryProducts').style.display = 'none';
    }
    
    // æ˜¾ç¤ºåˆ†ç±»ä¸‹çš„äº§å“
    async function showCategoryProducts(category) {
      // æ¸…ç©ºå…¨å±€æœç´¢
      document.getElementById('globalProductSearchInput').value = '';
      
      document.getElementById('categoryList').style.display = 'none';
      document.getElementById('globalSearchResults').style.display = 'none';
      document.getElementById('categoryProducts').style.display = 'block';
      document.getElementById('currentCategoryName').textContent = `ğŸ“¦ ${category}`;
      currentCategory = category;
      
      const container = document.getElementById('productList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success) {
          // ä¿å­˜æ‰€æœ‰äº§å“åˆ°å…¨å±€å˜é‡ï¼ˆç”¨äºå…¨å±€æœç´¢ï¼‰
          if (allInventoryProducts.length === 0) {
            allInventoryProducts = result.data.filter(item => 
              item.quantity > 0 && item.status === 'active'
            );
          }
          
          // ä¿å­˜å½“å‰åˆ†ç±»çš„äº§å“
          allCategoryProducts = result.data.filter(item => 
            item.category === category && item.quantity > 0 && item.status === 'active'
          );
          
          // æ˜¾ç¤ºäº§å“
          displayProducts(allCategoryProducts, 'productList');
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºäº§å“åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢è¿‡æ»¤ï¼‰
    function displayProducts(products, containerId) {
      const container = document.getElementById(containerId);
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„äº§å“</p>';
        return;
      }
      
      // æŒ‰äº§å“åç§°ã€å“ç‰Œã€å‹å·ã€é¢œè‰²åˆ†ç»„
      // å¯¹äºé…ä»¶äº§å“ï¼ˆæœ‰å¤šä¸ªå˜ä½“ï¼‰ï¼ŒåªæŒ‰ productName + brand åˆ†ç»„
      // å¯¹äºè®¾å¤‡äº§å“ï¼ˆæœ‰åºåˆ—å·ï¼‰ï¼ŒæŒ‰ productName åˆ†ç»„ï¼ˆä¸åŒºåˆ†å‹å·å’Œé¢œè‰²ï¼‰
      const groupedProducts = {};
      products.forEach(item => {
        // æ£€æŸ¥æ˜¯å¦ä¸ºè®¾å¤‡ï¼ˆæœ‰åºåˆ—å·æˆ–IMEIï¼‰
        const isDevice = item.serialNumber || item.imei;
        
        // è®¾å¤‡äº§å“ï¼šåªæŒ‰ productName åˆ†ç»„ï¼ˆä¸åŒºåˆ†å‹å·å’Œé¢œè‰²ï¼‰
        // é…ä»¶äº§å“ï¼šæŒ‰ productName + brand åˆ†ç»„
        const key = isDevice 
          ? `${item.productName}`
          : `${item.productName}_${item.brand || ''}`;
        
        if (!groupedProducts[key]) {
          groupedProducts[key] = {
            productName: item.productName,
            brand: item.brand,
            model: null, // è®¾å¤‡ä¸æ˜¾ç¤ºå•ä¸€å‹å·
            color: null, // è®¾å¤‡ä¸æ˜¾ç¤ºå•ä¸€é¢œè‰²
            category: item.category,
            retailPrice: item.retailPrice,
            taxClassification: item.taxClassification,
            items: [],
            totalQuantity: 0,
            isDevice: isDevice,
            hasVariants: false // æ˜¯å¦æœ‰å¤šä¸ªå˜ä½“
          };
        }
        groupedProducts[key].items.push(item);
        groupedProducts[key].totalQuantity += item.quantity;
      });
      
      // æ£€æµ‹å“ªäº›äº§å“æœ‰å¤šä¸ªå˜ä½“
      Object.values(groupedProducts).forEach(group => {
        // ç»Ÿè®¡ä¸åŒçš„ model å’Œ color ç»„åˆ
        const variants = new Set();
        group.items.forEach(item => {
          const variantKey = `${item.model || 'NO_MODEL'}_${item.color || 'NO_COLOR'}`;
          variants.add(variantKey);
        });
        group.hasVariants = variants.size > 1;
        
        // å¦‚æœæœ‰å˜ä½“ï¼Œæ”¶é›†æ‰€æœ‰ä¸åŒçš„å‹å·å’Œé¢œè‰²ç”¨äºæ˜¾ç¤º
        if (group.hasVariants || group.isDevice) {
          const models = new Set();
          const colors = new Set();
          group.items.forEach(item => {
            if (item.model) models.add(item.model);
            if (item.color) colors.add(item.color);
          });
          group.variantModels = Array.from(models);
          group.variantColors = Array.from(colors);
        }
      });
      
      const groupedProductsList = Object.values(groupedProducts);
      
      // ç¼“å­˜åˆ†ç»„åçš„äº§å“æ•°æ®
      groupedProductsCache = {};
      groupedProductsList.forEach((product, index) => {
        groupedProductsCache[`product_${index}`] = product;
      });
      
      const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
          ${groupedProductsList.map((product, index) => {
            const hasSerialNumber = product.isDevice;
            return `
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"
              onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.1)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)';">
              
              <h4 style="font-size: 18px; margin-bottom: 10px; color: #1f2937; font-weight: 700;">${product.productName}</h4>
              
              <div style="color: #666; font-size: 13px; margin-bottom: 10px;">
                ${product.category ? `<span style="background: #f3f4f6; padding: 3px 10px; border-radius: 12px; font-size: 12px; margin-right: 6px; font-weight: 600;">${product.category}</span>` : ''}
                ${product.brand ? `<span style="color: #6b7280;">å“ç‰Œ: ${product.brand}</span>` : ''}
              </div>
              
              ${!product.isDevice && (product.hasVariants || product.items.length > 0) ? `
                <div style="color: #666; font-size: 12px; margin-bottom: 12px; background: ${product.hasVariants ? '#f0f9ff' : '#f9fafb'}; padding: 10px; border-radius: 8px; border-left: 3px solid ${product.hasVariants ? '#3b82f6' : '#9ca3af'}; flex-grow: 1;">
                  ${product.hasVariants ? `
                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 6px; font-size: 13px;">ğŸ“¦ å¯é€‰å˜ä½“</div>
                  ` : ''}
                  ${(() => {
                    const models = new Set();
                    const colors = new Set();
                    product.items.forEach(item => {
                      if (item.model) models.add(item.model);
                      if (item.color) colors.add(item.color);
                    });
                    const modelList = Array.from(models);
                    const colorList = Array.from(colors);
                    
                    let html = '';
                    if (modelList.length > 0) {
                      html += `<div style="margin-bottom: 4px; line-height: 1.5;">
                        <span style="color: ${product.hasVariants ? '#1e40af' : '#6b7280'}; font-weight: 600;">å‹å·:</span> 
                        <span style="color: #374151;">${modelList.join(', ')}</span>
                      </div>`;
                    }
                    if (colorList.length > 0) {
                      html += `<div style="line-height: 1.5;">
                        <span style="color: ${product.hasVariants ? '#1e40af' : '#6b7280'}; font-weight: 600;">é¢œè‰²:</span> 
                        <span style="color: #374151;">${colorList.join(', ')}</span>
                      </div>`;
                    }
                    return html;
                  })()}
                </div>
              ` : product.isDevice && product.items.length > 0 ? `
                <div style="color: #666; font-size: 12px; margin-bottom: 12px; background: #f0f9ff; padding: 10px; border-radius: 8px; border-left: 3px solid #3b82f6; flex-grow: 1;">
                  <div style="font-weight: 600; color: #1e40af; margin-bottom: 6px; font-size: 13px;">ğŸ“± å¯é€‰è®¾å¤‡</div>
                  ${(() => {
                    const models = new Set();
                    const colors = new Set();
                    product.items.forEach(item => {
                      if (item.model) models.add(item.model);
                      if (item.color) colors.add(item.color);
                    });
                    const modelList = Array.from(models);
                    const colorList = Array.from(colors);
                    
                    let html = '';
                    if (modelList.length > 0) {
                      html += `<div style="margin-bottom: 4px; line-height: 1.5;">
                        <span style="color: #1e40af; font-weight: 600;">å‹å·:</span> 
                        <span style="color: #374151;">${modelList.join(', ')}</span>
                      </div>`;
                    }
                    if (colorList.length > 0) {
                      html += `<div style="line-height: 1.5;">
                        <span style="color: #1e40af; font-weight: 600;">é¢œè‰²:</span> 
                        <span style="color: #374151;">${colorList.join(', ')}</span>
                      </div>`;
                    }
                    return html;
                  })()}
                </div>
              ` : `
                <div style="flex-grow: 1;"></div>
              `}
              
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                <span style="background: #dbeafe; color: #1e40af; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700;">
                  åº“å­˜: ${product.totalQuantity}
                </span>
                <span style="color: #10b981; font-size: 22px; font-weight: 800;">
                  â‚¬${product.retailPrice.toFixed(2)}
                </span>
              </div>
              
              ${hasSerialNumber ? `
                <button onclick='showDeviceSelectionMultiple(${JSON.stringify(product.items.map(i => i._id))}, "${product.productName}")' 
                  style="width: 100%; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;"
                  onmouseover="this.style.background='#2563eb'"
                  onmouseout="this.style.background='#3b82f6'">
                  ğŸ“± é€‰æ‹©è®¾å¤‡
                </button>
              ` : product.hasVariants ? `
                <button onclick='showVariantSelectionByKey("product_${index}")' 
                  style="width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;"
                  onmouseover="this.style.background='#5a67d8'"
                  onmouseout="this.style.background='#667eea'">
                  ğŸ¨ é€‰æ‹©å‹å·å’Œé¢œè‰²
                </button>
              ` : `
                <button onclick="addToCart('${product.items[0]._id}', '${product.productName}', ${product.retailPrice}, ${product.totalQuantity}, '${product.taxClassification || 'VAT_23'}')" 
                  style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s;"
                  onmouseover="this.style.background='#059669'"
                  onmouseout="this.style.background='#10b981'">
                  â• åŠ å…¥è´­ç‰©è½¦
                </button>
              `}
            </div>
          `}).join('')}
        </div>
      `;
      container.innerHTML = html;
    }
    
    // æœç´¢è¿‡æ»¤äº§å“ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ä»¥é˜²å…¼å®¹æ€§é—®é¢˜ï¼‰
    function filterProducts() {
      // æ­¤å‡½æ•°å·²ä¸å†ä½¿ç”¨ï¼Œå…¨å±€æœç´¢ä½¿ç”¨ globalSearchProducts
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºè®¾å¤‡ï¼ˆéœ€è¦é€‰æ‹©IMEI/SNï¼‰
    function isDevice(product) {
      // å¦‚æœæœ‰åºåˆ—å·æˆ–IMEIï¼Œè®¤ä¸ºæ˜¯è®¾å¤‡
      return product.serialNumber || product.barcode;
    }
    
    // è¿”å›åˆ†ç±»åˆ—è¡¨
    function backToCategories() {
      // æ¸…ç©ºå…¨å±€æœç´¢
      document.getElementById('globalProductSearchInput').value = '';
      
      document.getElementById('categoryList').style.display = 'block';
      document.getElementById('categoryProducts').style.display = 'none';
      document.getElementById('globalSearchResults').style.display = 'none';
    }
    
    // åˆ‡æ¢é”€å”®è®°å½•æŸ¥è¯¢åŒºåŸŸçš„æ˜¾ç¤º/éšè—
    function toggleSalesRecordsSection() {
      const content = document.getElementById('salesRecordsContent');
      const icon = document.getElementById('salesRecordsToggleIcon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
        icon.textContent = 'â–²';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
        icon.textContent = 'â–¼';
      }
    }
    
    // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†ï¼ˆå¤šä¸ªè®¾å¤‡ï¼‰
    async function showDeviceSelectionMultiple(inventoryIds, productName) {
      document.getElementById('deviceProductName').textContent = `äº§å“: ${productName}`;
      
      // è·å–æ‰€æœ‰è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯
      const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
      const result = await response.json();
      
      if (result.success) {
        const devices = result.data.filter(p => inventoryIds.includes(p._id));
        
        if (devices.length > 0) {
          const html = devices.map(device => {
            const displayInfo = device.serialNumber || device.imei || device.barcode || 'æ— åºåˆ—å·';
            return `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background 0.2s;" 
                onmouseover="this.style.background='#e9ecef'"
                onmouseout="this.style.background='#f8f9fa'"
                onclick="addDeviceToCart('${device._id}', '${productName}', ${device.retailPrice}, '${displayInfo}', '${device.taxClassification || 'VAT_23'}')">
                <div style="font-weight: 600; margin-bottom: 5px;">
                  ${device.serialNumber ? `åºåˆ—å·: ${device.serialNumber}` : ''}
                  ${device.imei ? `IMEI: ${device.imei}` : ''}
                </div>
                <div style="color: #666; font-size: 14px;">
                  ${device.color ? `é¢œè‰²: ${device.color} Â· ` : ''}
                  ä»·æ ¼: â‚¬${device.retailPrice.toFixed(2)}
                </div>
              </div>
            `;
          }).join('');
          
          document.getElementById('deviceList').innerHTML = html;
          document.getElementById('selectDeviceModal').style.display = 'flex';
        }
      }
    }
    
    // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†ï¼ˆå•ä¸ªè®¾å¤‡ - ä¿ç•™å‘åå…¼å®¹ï¼‰
    async function showDeviceSelection(inventoryId, productName) {
      showDeviceSelectionMultiple([inventoryId], productName);
    }
    
    // å…³é—­è®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†
    function closeDeviceModal() {
      document.getElementById('selectDeviceModal').style.display = 'none';
    }
    
    // ==================== å˜ä½“é€‰æ‹©åŠŸèƒ½ ====================
    
    let variantSelectionState = {
      productData: null,
      dimension1Value: null,
      dimension2Value: null,
      selectedItem: null,
      dimension1Options: [],
      dimension2Options: []
    };
    
    // é€šè¿‡ç¼“å­˜çš„ key æ˜¾ç¤ºå˜ä½“é€‰æ‹©
    function showVariantSelectionByKey(key) {
      const productData = groupedProductsCache[key];
      if (!productData) {
        console.error('Product data not found for key:', key);
        alert('äº§å“æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
      }
      showVariantSelection(productData);
    }
    
    // æ˜¾ç¤ºå˜ä½“é€‰æ‹©æ¨¡æ€æ¡†
    function showVariantSelection(productData) {
      // é‡ç½®çŠ¶æ€
      variantSelectionState = {
        productData: productData,
        dimension1Value: null,
        dimension2Value: null,
        selectedItem: null,
        dimension1Options: [],
        dimension2Options: []
      };
      
      // è®¾ç½®äº§å“åç§°
      document.getElementById('variantProductName').textContent = `${productData.productName} ${productData.brand ? '- ' + productData.brand : ''}`;
      
      // åˆ†æç»´åº¦
      const dimension1Set = new Set();
      const dimension2Set = new Set();
      
      productData.items.forEach(item => {
        if (item.model) dimension1Set.add(item.model);
        if (item.color) dimension2Set.add(item.color);
      });
      
      variantSelectionState.dimension1Options = Array.from(dimension1Set);
      variantSelectionState.dimension2Options = Array.from(dimension2Set);
      
      // ç¡®å®šç»´åº¦æ ‡ç­¾
      const hasDimension1 = variantSelectionState.dimension1Options.length > 0;
      const hasDimension2 = variantSelectionState.dimension2Options.length > 0;
      
      if (hasDimension1) {
        document.getElementById('dimension1Label').textContent = 'é€‰æ‹©å‹å·';
      }
      if (hasDimension2) {
        document.getElementById('dimension2Label').textContent = 'é€‰æ‹©é¢œè‰²';
      }
      
      // æ¸²æŸ“ç»´åº¦1é€‰é¡¹
      renderDimension1Options();
      
      // éšè—ç»´åº¦2å’Œå·²é€‰æ‹©ä¿¡æ¯
      document.getElementById('dimension2Section').style.display = 'none';
      document.getElementById('selectedVariantInfo').style.display = 'none';
      
      // ç¦ç”¨åŠ å…¥è´­ç‰©è½¦æŒ‰é’®
      const addBtn = document.getElementById('addVariantToCartBtn');
      addBtn.disabled = true;
      addBtn.style.opacity = '0.5';
      addBtn.style.cursor = 'not-allowed';
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('variantSelectionModal').style.display = 'flex';
    }
    
    // æ¸²æŸ“ç»´åº¦1é€‰é¡¹
    function renderDimension1Options() {
      const container = document.getElementById('dimension1Options');
      const options = variantSelectionState.dimension1Options;
      
      const html = options.map(option => {
        // è®¡ç®—è¯¥ç»´åº¦1é€‰é¡¹çš„æ€»åº“å­˜
        const items = variantSelectionState.productData.items.filter(item => item.model === option);
        const totalStock = items.reduce((sum, item) => sum + item.quantity, 0);
        const isSelected = variantSelectionState.dimension1Value === option;
        
        return `
          <button onclick="selectDimension1('${option}')" 
            style="padding: 15px; background: ${isSelected ? '#667eea' : 'white'}; color: ${isSelected ? 'white' : '#333'}; 
                   border: 2px solid ${isSelected ? '#667eea' : '#e5e7eb'}; border-radius: 8px; cursor: pointer; 
                   transition: all 0.2s; font-weight: ${isSelected ? '600' : '500'}; text-align: center;">
            <div style="font-size: 14px; margin-bottom: 5px;">${option}</div>
            <div style="font-size: 12px; opacity: 0.8;">åº“å­˜: ${totalStock}</div>
          </button>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // é€‰æ‹©ç»´åº¦1
    function selectDimension1(value) {
      variantSelectionState.dimension1Value = value;
      variantSelectionState.dimension2Value = null;
      variantSelectionState.selectedItem = null;
      
      // é‡æ–°æ¸²æŸ“ç»´åº¦1ï¼ˆæ›´æ–°é€‰ä¸­çŠ¶æ€ï¼‰
      renderDimension1Options();
      
      // æ˜¾ç¤ºç»´åº¦2
      document.getElementById('dimension2Section').style.display = 'block';
      renderDimension2Options();
      
      // éšè—å·²é€‰æ‹©ä¿¡æ¯
      document.getElementById('selectedVariantInfo').style.display = 'none';
      
      // ç¦ç”¨åŠ å…¥è´­ç‰©è½¦æŒ‰é’®
      const addBtn = document.getElementById('addVariantToCartBtn');
      addBtn.disabled = true;
      addBtn.style.opacity = '0.5';
      addBtn.style.cursor = 'not-allowed';
    }
    
    // æ¸²æŸ“ç»´åº¦2é€‰é¡¹
    function renderDimension2Options() {
      const container = document.getElementById('dimension2Options');
      const options = variantSelectionState.dimension2Options;
      const dimension1Value = variantSelectionState.dimension1Value;
      
      const html = options.map(option => {
        // æŸ¥æ‰¾åŒ¹é…çš„åº“å­˜é¡¹
        const item = variantSelectionState.productData.items.find(
          i => i.model === dimension1Value && i.color === option
        );
        
        const stock = item ? item.quantity : 0;
        const isAvailable = stock > 0;
        const isSelected = variantSelectionState.dimension2Value === option;
        
        return `
          <button onclick="selectDimension2('${option}')" 
            ${!isAvailable ? 'disabled' : ''}
            style="padding: 15px; background: ${isSelected ? '#667eea' : isAvailable ? 'white' : '#f3f4f6'}; 
                   color: ${isSelected ? 'white' : isAvailable ? '#333' : '#9ca3af'}; 
                   border: 2px solid ${isSelected ? '#667eea' : isAvailable ? '#e5e7eb' : '#d1d5db'}; 
                   border-radius: 8px; cursor: ${isAvailable ? 'pointer' : 'not-allowed'}; 
                   transition: all 0.2s; font-weight: ${isSelected ? '600' : '500'}; text-align: center;">
            <div style="font-size: 14px; margin-bottom: 5px;">${option}</div>
            <div style="font-size: 12px; opacity: 0.8;">
              ${isAvailable ? `åº“å­˜: ${stock}` : 'ç¼ºè´§'}
            </div>
          </button>
        `;
      }).join('');
      
      container.innerHTML = html;
    }
    
    // é€‰æ‹©ç»´åº¦2
    function selectDimension2(value) {
      variantSelectionState.dimension2Value = value;
      
      // æŸ¥æ‰¾åŒ¹é…çš„åº“å­˜é¡¹
      const item = variantSelectionState.productData.items.find(
        i => i.model === variantSelectionState.dimension1Value && i.color === value
      );
      
      if (item && item.quantity > 0) {
        variantSelectionState.selectedItem = item;
        
        // é‡æ–°æ¸²æŸ“ç»´åº¦2ï¼ˆæ›´æ–°é€‰ä¸­çŠ¶æ€ï¼‰
        renderDimension2Options();
        
        // æ˜¾ç¤ºå·²é€‰æ‹©ä¿¡æ¯
        document.getElementById('selectedVariantText').textContent = 
          `${variantSelectionState.dimension1Value} - ${value}`;
        document.getElementById('selectedVariantStock').textContent = 
          `åº“å­˜: ${item.quantity}ä»¶`;
        document.getElementById('selectedVariantPrice').textContent = 
          `â‚¬${item.retailPrice.toFixed(2)}`;
        document.getElementById('selectedVariantInfo').style.display = 'block';
        
        // å¯ç”¨åŠ å…¥è´­ç‰©è½¦æŒ‰é’®
        const addBtn = document.getElementById('addVariantToCartBtn');
        addBtn.disabled = false;
        addBtn.style.opacity = '1';
        addBtn.style.cursor = 'pointer';
      }
    }
    
    // å°†é€‰ä¸­çš„å˜ä½“åŠ å…¥è´­ç‰©è½¦
    function addSelectedVariantToCart() {
      const item = variantSelectionState.selectedItem;
      if (!item) return;
      
      const productName = `${variantSelectionState.productData.productName} (${variantSelectionState.dimension1Value} - ${variantSelectionState.dimension2Value})`;
      
      addToCart(
        item._id,
        productName,
        item.retailPrice,
        item.quantity,
        item.taxClassification || 'VAT_23'
      );
      
      // å…³é—­æ¨¡æ€æ¡†
      closeVariantModal();
    }
    
    // å…³é—­å˜ä½“é€‰æ‹©æ¨¡æ€æ¡†
    function closeVariantModal() {
      document.getElementById('variantSelectionModal').style.display = 'none';
      variantSelectionState = {
        productData: null,
        dimension1Value: null,
        dimension2Value: null,
        selectedItem: null,
        dimension1Options: [],
        dimension2Options: []
      };
    }
    
    // ==================== å˜ä½“é€‰æ‹©åŠŸèƒ½ç»“æŸ ====================
    
    // æ·»åŠ è®¾å¤‡åˆ°è´­ç‰©è½¦
    function addDeviceToCart(inventoryId, productName, price, serialNumber, taxClassification) {
      addToCart(inventoryId, productName, price, 1, taxClassification, serialNumber);
      closeDeviceModal();
    }
    
    // æ·»åŠ åˆ°è´­ç‰©è½¦
    function addToCart(inventoryId, productName, price, maxQty, taxClassification, serialNumber = null) {
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨è´­ç‰©è½¦ä¸­
      const existingItem = cart.find(item => item.inventoryId === inventoryId && item.serialNumber === serialNumber);
      
      if (existingItem) {
        if (existingItem.quantity < maxQty) {
          existingItem.quantity++;
        } else {
          alert('å·²è¾¾åˆ°æœ€å¤§åº“å­˜æ•°é‡');
          return;
        }
      } else {
        cart.push({
          inventoryId,
          productName,
          price,
          quantity: 1,
          maxQty,
          taxClassification,
          serialNumber
        });
      }
      
      updateCartDisplay();
      alert(`âœ… ${productName} å·²æ·»åŠ åˆ°è´­ç‰©è½¦`);
    }
    
    // æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
    function updateCartDisplay() {
      const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('cartItemCount').textContent = itemCount;
      document.getElementById('cartTotal').textContent = 'â‚¬' + total.toFixed(2);
      
      if (cart.length > 0) {
        document.getElementById('cartSummary').style.display = 'block';
      } else {
        document.getElementById('cartSummary').style.display = 'none';
      }
    }
    
    // æ¸…ç©ºè´­ç‰©è½¦
    function clearCart() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
        cart = [];
        updateCartDisplay();
      }
    }
    
    // æ˜¾ç¤ºç»“è´¦æ¨¡æ€æ¡†
    function showCheckoutModal() {
      if (cart.length === 0) {
        alert('è´­ç‰©è½¦ä¸ºç©º');
        return;
      }
      
      // æ˜¾ç¤ºè´­ç‰©è½¦æ˜ç»†ï¼ˆä»·æ ¼å¯ç¼–è¾‘ï¼‰
      const itemsHtml = cart.map((item, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
          <div style="flex: 1;">
            <div style="font-weight: 600;">${item.productName}</div>
            ${item.serialNumber ? `<div style="font-size: 12px; color: #666;">SN: ${item.serialNumber}</div>` : ''}
            <div style="font-size: 14px; color: #666;">æ•°é‡: ${item.quantity}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 5px;">
              <span style="color: #666;">â‚¬</span>
              <input type="number" 
                id="itemPrice_${index}" 
                value="${item.price.toFixed(2)}" 
                step="0.01" 
                min="0"
                onchange="updateItemPrice(${index})"
                style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-weight: 600;" />
            </div>
            <div style="width: 100px; text-align: right;">
              <div style="font-size: 12px; color: #666;">å°è®¡</div>
              <div id="itemTotal_${index}" style="font-weight: 600; color: #2563eb;">
                â‚¬${(item.price * item.quantity).toFixed(2)}
              </div>
            </div>
          </div>
        </div>
      `).join('');
      
      document.getElementById('checkoutCartItems').innerHTML = itemsHtml;
      
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('checkoutSubtotal').textContent = 'â‚¬' + total.toFixed(2);
      document.getElementById('actualAmount').textContent = 'â‚¬' + total.toFixed(2);
      
      // é‡ç½®æ”¯ä»˜æ–¹å¼
      selectedPaymentMethod = null;
      document.querySelectorAll('[id^="payBtn_"]').forEach(btn => {
        btn.style.borderColor = '#ddd';
        btn.style.background = 'white';
      });
      document.getElementById('mixedPaymentInputs').style.display = 'none';
      document.getElementById('customerPhone').value = '';
      
      document.getElementById('checkoutModal').style.display = 'flex';
    }
    
    // æ›´æ–°å•ä¸ªäº§å“ä»·æ ¼
    function updateItemPrice(index) {
      const newPrice = parseFloat(document.getElementById(`itemPrice_${index}`).value) || 0;
      
      // æ›´æ–°è´­ç‰©è½¦ä¸­çš„ä»·æ ¼
      cart[index].price = newPrice;
      
      // æ›´æ–°è¯¥äº§å“çš„å°è®¡
      const itemTotal = newPrice * cart[index].quantity;
      document.getElementById(`itemTotal_${index}`).textContent = 'â‚¬' + itemTotal.toFixed(2);
      
      // é‡æ–°è®¡ç®—æ€»è®¡
      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      document.getElementById('checkoutSubtotal').textContent = 'â‚¬' + total.toFixed(2);
      document.getElementById('actualAmount').textContent = 'â‚¬' + total.toFixed(2);
      
      // å¦‚æœæ˜¯æ··åˆæ”¯ä»˜ï¼Œè‡ªåŠ¨è°ƒæ•´é‡‘é¢
      if (selectedPaymentMethod === 'MIXED') {
        const cashAmount = parseFloat(document.getElementById('cashAmount').value) || 0;
        const cardAmount = total - cashAmount;
        document.getElementById('cardAmount').value = cardAmount.toFixed(2);
      }
    }
    
    // å…³é—­ç»“è´¦æ¨¡æ€æ¡†
    function closeCheckoutModal() {
      document.getElementById('checkoutModal').style.display = 'none';
    }
    
    // é€‰æ‹©æ”¯ä»˜æ–¹å¼
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('[id^="payBtn_"]').forEach(btn => {
        btn.style.borderColor = '#ddd';
        btn.style.background = 'white';
      });
      document.getElementById(`payBtn_${method}`).style.borderColor = '#3b82f6';
      document.getElementById(`payBtn_${method}`).style.background = '#eff6ff';
      
      // æ˜¾ç¤º/éšè—æ··åˆæ”¯ä»˜è¾“å…¥
      if (method === 'MIXED') {
        document.getElementById('mixedPaymentInputs').style.display = 'block';
        const actualAmount = parseFloat(document.getElementById('actualAmount').value) || 0;
        document.getElementById('cashAmount').value = (actualAmount / 2).toFixed(2);
        document.getElementById('cardAmount').value = (actualAmount / 2).toFixed(2);
      } else {
        document.getElementById('mixedPaymentInputs').style.display = 'none';
      }
    }
    
    // æ›´æ–°æ··åˆæ”¯ä»˜
    function updateMixedPayment() {
      const actualAmount = parseFloat(document.getElementById('actualAmount').value) || 0;
      const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
      const card = parseFloat(document.getElementById('cardAmount').value) || 0;
      const sum = cash + card;
      
      const warning = document.getElementById('mixedPaymentWarning');
      if (Math.abs(sum - actualAmount) > 0.01) {
        warning.textContent = `âš ï¸ æ”¯ä»˜æ€»é¢ â‚¬${sum.toFixed(2)} ä¸å®é™…æ”¶æ¬¾ â‚¬${actualAmount.toFixed(2)} ä¸ç¬¦`;
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    }
    
    // å®Œæˆé”€å”®
    async function completeSale() {
      if (!selectedPaymentMethod) {
        alert('è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼');
        return;
      }
      
      // è®¡ç®—æ€»é‡‘é¢ï¼ˆä½¿ç”¨ä¿®æ”¹åçš„ä»·æ ¼ï¼‰
      const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      // éªŒè¯æ€»é‡‘é¢
      if (totalAmount <= 0) {
        alert('æ€»é‡‘é¢å¿…é¡»å¤§äº 0');
        return;
      }
      
      // éªŒè¯æ··åˆæ”¯ä»˜
      if (selectedPaymentMethod === 'MIXED') {
        const cash = parseFloat(document.getElementById('cashAmount').value) || 0;
        const card = parseFloat(document.getElementById('cardAmount').value) || 0;
        if (Math.abs((cash + card) - totalAmount) > 0.01) {
          alert('æ··åˆæ”¯ä»˜é‡‘é¢ä¸æ­£ç¡®');
          return;
        }
      }
      
      const customerPhone = document.getElementById('customerPhone').value;
      
      // å‡†å¤‡é”€å”®æ•°æ®
      const saleData = {
        merchantId,
        customerPhone: customerPhone || null,
        paymentMethod: selectedPaymentMethod,
        items: cart.map(item => ({
          inventoryId: item.inventoryId || null,
          repairId: item.repairId || null,
          productName: item.productName,
          quantity: item.quantity,
          price: item.price,  // ä½¿ç”¨ä¿®æ”¹åçš„ä»·æ ¼
          taxClassification: item.taxClassification,
          serialNumber: item.serialNumber
        })),
        totalAmount: totalAmount  // ä½¿ç”¨è®¡ç®—åçš„æ€»é‡‘é¢
      };
      
      // æ·»åŠ æ··åˆæ”¯ä»˜é‡‘é¢
      if (selectedPaymentMethod === 'MIXED') {
        saleData.cashAmount = parseFloat(document.getElementById('cashAmount').value);
        saleData.cardAmount = parseFloat(document.getElementById('cardAmount').value);
      }
      
      try {
        document.getElementById('completeSaleBtn').disabled = true;
        document.getElementById('completeSaleBtn').textContent = 'å¤„ç†ä¸­...';
        
        const response = await fetch(`${API_BASE}/merchant/sales/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(saleData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          alert(`âœ… é”€å”®æˆåŠŸï¼\nè®¢å•å·: ${result.data.saleId}\næ€»é‡‘é¢: â‚¬${totalAmount.toFixed(2)}`);
          
          // è¯¢é—®æ˜¯å¦æ‰“å°å°ç¥¨
          const shouldPrint = confirm('Do you want to print a receipt?\næ˜¯å¦æ‰“å°å°ç¥¨ï¼Ÿ');
          
          if (shouldPrint) {
            // æ‰“å°å°ç¥¨
            await printReceipt(result.data, saleData, totalAmount);
          }
          
          cart = [];
          updateCartDisplay();
          closeCheckoutModal();
          loadStats();
          backToCategories();
          loadCategoryList();
        } else {
          alert('âŒ é”€å”®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ é”€å”®å¤±è´¥: ' + error.message);
      } finally {
        document.getElementById('completeSaleBtn').disabled = false;
        document.getElementById('completeSaleBtn').textContent = 'âœ… ç¡®è®¤æ”¯ä»˜';
      }
    }
    
    // ==================== æ‰“å°å°ç¥¨åŠŸèƒ½ ====================
    
    // æ‰“å°é”€å”®å°ç¥¨
    async function printReceipt(saleData, orderData, totalAmount) {
      try {
        // è·å–ç”¨æˆ·å…¬å¸ä¿¡æ¯
        const userResponse = await fetch(`${API_BASE}/users/profile?username=${merchantId}`);
        const userResult = await userResponse.json();
        
        let companyInfo = {
          companyName: '3C Product Store',
          address: '',
          phone: '',
          email: '',
          vatNumber: ''
        };
        
        if (userResult.success && userResult.data.companyInfo) {
          const ci = userResult.data.companyInfo;
          companyInfo = {
            companyName: ci.companyName || companyInfo.companyName,
            address: ci.address ? 
              `${ci.address.street || ''} ${ci.address.city || ''} ${ci.address.postalCode || ''}`.trim() : '',
            phone: ci.contactPhone || '',
            email: ci.contactEmail || '',
            vatNumber: ci.vatNumber || ''
          };
        }
        
        // åˆ›å»ºæ‰“å°å†…å®¹
        const printWindow = window.open('', '_blank', 'width=300,height=600');
        
        const receiptHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>é”€å”®å°ç¥¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    @page {
      size: 80mm auto;
      margin: 0;
    }
    
    body {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
      width: 80mm;
      padding: 5mm;
      background: white;
    }
    
    .receipt {
      width: 100%;
    }
    
    .header {
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px dashed #000;
      padding-bottom: 10px;
    }
    
    .company-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .company-info {
      font-size: 10px;
      line-height: 1.3;
    }
    
    .section {
      margin: 10px 0;
      border-bottom: 1px dashed #000;
      padding-bottom: 10px;
    }
    
    .section-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
      font-size: 11px;
    }
    
    .items-table {
      width: 100%;
      margin: 10px 0;
    }
    
    .item-row {
      margin: 5px 0;
      font-size: 11px;
    }
    
    .item-name {
      font-weight: bold;
    }
    
    .item-details {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }
    
    .total-section {
      margin-top: 10px;
      border-top: 2px solid #000;
      padding-top: 10px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 12px;
    }
    
    .total-row.grand-total {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }
    
    .footer {
      text-align: center;
      margin-top: 15px;
      font-size: 10px;
      border-top: 1px dashed #000;
      padding-top: 10px;
    }
    
    .thank-you {
      font-size: 12px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    @media print {
      body {
        width: 80mm;
      }
      
      .no-print {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="receipt">
    <!-- å…¬å¸ä¿¡æ¯ -->
    <div class="header">
      <div class="company-name">${companyInfo.companyName}</div>
      <div class="company-info">
        ${companyInfo.address ? companyInfo.address + '<br>' : ''}
        ${companyInfo.phone ? 'Tel: ' + companyInfo.phone + '<br>' : ''}
        ${companyInfo.email ? 'Email: ' + companyInfo.email + '<br>' : ''}
        ${companyInfo.vatNumber ? 'VAT: ' + companyInfo.vatNumber : ''}
      </div>
    </div>
    
    <!-- Order Information -->
    <div class="section">
      <div class="info-row">
        <span>Order No:</span>
        <span>${saleData.saleId}</span>
      </div>
      <div class="info-row">
        <span>Date:</span>
        <span>${new Date().toLocaleString('en-IE', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        })}</span>
      </div>
      ${orderData.customerPhone ? `
      <div class="info-row">
        <span>Customer:</span>
        <span>${orderData.customerPhone}</span>
      </div>
      ` : ''}
    </div>
    
    <!-- Items -->
    <div class="section">
      <div class="section-title">Items</div>
      <div class="items-table">
        ${orderData.items.map(item => `
          <div class="item-row">
            <div class="item-name">${item.productName}</div>
            <div class="item-details">
              <span>${item.quantity} x â‚¬${item.price.toFixed(2)}</span>
              <span>â‚¬${(item.quantity * item.price).toFixed(2)}</span>
            </div>
            ${item.serialNumber ? `<div style="font-size: 10px; color: #666;">SN: ${item.serialNumber}</div>` : ''}
          </div>
        `).join('')}
      </div>
    </div>
    
    <!-- Total -->
    <div class="total-section">
      <div class="total-row">
        <span>Subtotal:</span>
        <span>â‚¬${totalAmount.toFixed(2)}</span>
      </div>
      ${orderData.paymentMethod === 'MIXED' ? `
      <div class="total-row">
        <span>Cash:</span>
        <span>â‚¬${orderData.cashAmount.toFixed(2)}</span>
      </div>
      <div class="total-row">
        <span>Card:</span>
        <span>â‚¬${orderData.cardAmount.toFixed(2)}</span>
      </div>
      ` : `
      <div class="total-row">
        <span>Payment:</span>
        <span>${getPaymentMethodName(orderData.paymentMethod)}</span>
      </div>
      `}
      <div class="total-row grand-total">
        <span>TOTAL:</span>
        <span>â‚¬${totalAmount.toFixed(2)}</span>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <div class="thank-you">Thank You!</div>
      <div style="margin-top: 10px;">For any questions, please contact us</div>
      ${companyInfo.phone ? `<div>${companyInfo.phone}</div>` : ''}
    </div>
  </div>
  
  <div class="no-print" style="text-align: center; margin-top: 20px;">
    <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px;">
      ğŸ–¨ï¸ Print
    </button>
    <button onclick="window.close()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
      Close
    </button>
  </div>
  
  <script>
    // è‡ªåŠ¨æ‰“å°
    window.onload = function() {
      setTimeout(function() {
        window.print();
      }, 500);
    };
    
    // æ‰“å°åå…³é—­çª—å£
    window.onafterprint = function() {
      setTimeout(function() {
        window.close();
      }, 1000);
    };
  <\/script>
</body>
</html>
        `;
        
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
        
      } catch (error) {
        console.error('æ‰“å°å°ç¥¨å¤±è´¥:', error);
        // æ‰“å°å¤±è´¥ä¸å½±å“é”€å”®æµç¨‹ï¼Œåªè®°å½•é”™è¯¯
      }
    }
    
    // è·å–æ”¯ä»˜æ–¹å¼åç§°
    // Get payment method name
    function getPaymentMethodName(method) {
      const names = {
        'CASH': 'Cash',
        'CARD': 'Card',
        'MIXED': 'Mixed Payment',
        'TRANSFER': 'Bank Transfer',
        'OTHER': 'Other'
      };
      return names[method] || method;
    }
    
    // ==================== åŸæœ‰åŠŸèƒ½ ====================
    
    // å…¨å±€å˜é‡å­˜å‚¨é”€å”®è®°å½•æ•°æ®
    let allSalesData = [];
    
    // æŸ¥è¯¢é”€å”®è®°å½•
    async function querySalesRecords() {
      const startDate = document.getElementById('salesStartDate').value;
      const endDate = document.getElementById('salesEndDate').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
      }
      
      const container = document.getElementById('salesRecordsTable');
      container.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // ä¿å­˜åŸå§‹é”€å”®æ•°æ®
          allSalesData = result.data;
          
          // æ¸…ç©ºæœç´¢æ¡†
          document.getElementById('salesSearchInput').value = '';
          
          // æ˜¾ç¤ºé”€å”®è®°å½•
          displaySalesRecords(allSalesData);
        } else {
          allSalesData = [];
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®è®°å½•</p>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        console.error('æŸ¥è¯¢é”€å”®è®°å½•å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºé”€å”®è®°å½•
    function displaySalesRecords(salesData) {
      const container = document.getElementById('salesRecordsTable');
      
      if (!salesData || salesData.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•</p>';
        return;
      }
      
      // å±•å¼€é”€å”®è®°å½•ä¸­çš„æ‰€æœ‰å•†å“
      const allItems = [];
      salesData.forEach(sale => {
        // è·å–è¯¥è®¢å•çš„é€€æ¬¾å•†å“åˆ—è¡¨
        const refundedItemsInSale = sale.refundItems || [];
        
        sale.items.forEach(item => {
          // æ£€æŸ¥è¯¥å•†å“æ˜¯å¦è¢«é€€æ¬¾ï¼ˆé€šè¿‡åºåˆ—å·æˆ–äº§å“åç§°åŒ¹é…ï¼‰
          const isItemRefunded = refundedItemsInSale.some(refundItem => {
            // å¦‚æœæœ‰åºåˆ—å·ï¼Œé€šè¿‡åºåˆ—å·åŒ¹é…
            if (item.serialNumber && refundItem.serialNumber) {
              return item.serialNumber === refundItem.serialNumber;
            }
            // å¦åˆ™é€šè¿‡äº§å“åç§°å’Œä»·æ ¼åŒ¹é…
            return refundItem.productName === item.productName && 
                   refundItem.price === item.price;
          });
          
          allItems.push({
            saleId: sale._id,
            saleNumber: sale.saleId || sale.invoiceNumber || sale._id || 'N/A',
            date: sale.date,
            productName: item.productName,
            quantity: item.quantity,
            price: item.price,
            costPrice: item.costPrice,
            taxClassification: item.taxClassification,
            taxAmount: item.taxAmount,
            paymentMethod: sale.paymentMethod,
            cashAmount: sale.cashAmount,
            cardAmount: sale.cardAmount,
            customerPhone: sale.customerPhone,
            serialNumber: item.serialNumber,
            totalAmount: sale.totalAmount,
            orderStatus: sale.status, // è®¢å•çŠ¶æ€
            itemRefunded: isItemRefunded, // å•†å“æ˜¯å¦è¢«é€€æ¬¾
            // ä¿å­˜å®Œæ•´çš„saleå¯¹è±¡ç”¨äºæ‰“å°
            saleData: sale
          });
        });
      });
      
      // åˆ†ç¦»å·²é€€æ¬¾å’Œæ­£å¸¸çš„å•†å“ï¼ˆæŒ‰å•†å“çº§åˆ«ï¼Œä¸æ˜¯è®¢å•çº§åˆ«ï¼‰
      const activeItems = allItems.filter(item => !item.itemRefunded);
      const refundedItems = allItems.filter(item => item.itemRefunded);
      
      if (allItems.length > 0) {
        const html = `
          <table>
            <thead>
              <tr>
                <th>çŠ¶æ€</th>
                <th>æ—¥æœŸ</th>
                <th>äº§å“</th>
                <th>åºåˆ—å·</th>
                <th>æ•°é‡</th>
                <th>å•ä»·</th>
                <th>é”€å”®é¢</th>
                <th>ç¨é¢</th>
                <th>ç¨åŠ¡åˆ†ç±»</th>
                <th>æ”¯ä»˜æ–¹å¼</th>
                <th>å®¢æˆ·</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${allItems.map(item => {
                const isRefunded = item.itemRefunded; // ä½¿ç”¨å•†å“çº§åˆ«çš„é€€æ¬¾çŠ¶æ€
                const rowStyle = isRefunded 
                  ? 'background: #fee2e2; text-decoration: line-through; opacity: 0.7;' 
                  : '';
                const hoverStyle = isRefunded 
                  ? 'onmouseover="this.style.background=\'#fecaca\'" onmouseout="this.style.background=\'#fee2e2\'"'
                  : 'onmouseover="this.style.background=\'#f9fafb\'" onmouseout="this.style.background=\'\'";';
                
                return `
                  <tr style="cursor: pointer; transition: background 0.2s; ${rowStyle}" 
                      ${hoverStyle}
                      onclick="viewSaleDetail('${item.saleId}')">
                    <td>
                      ${isRefunded 
                        ? '<span style="background: #dc2626; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">å·²é€€æ¬¾</span>' 
                        : '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">æ­£å¸¸</span>'}
                    </td>
                    <td>${new Date(item.date).toLocaleDateString('zh-CN')} ${new Date(item.date).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</td>
                    <td><strong>${item.productName}</strong></td>
                    <td style="font-size: 11px; color: #666;">${item.serialNumber || '-'}</td>
                    <td>${item.quantity}</td>
                    <td>â‚¬${item.price.toFixed(2)}</td>
                    <td><strong>â‚¬${(item.price * item.quantity).toFixed(2)}</strong></td>
                    <td>â‚¬${item.taxAmount.toFixed(2)}</td>
                    <td>${getTaxBadge(item.taxClassification)}</td>
                    <td>${getPaymentBadge(item.paymentMethod, item.cashAmount, item.cardAmount)}</td>
                    <td style="font-size: 12px;">${item.customerPhone || '-'}</td>
                    <td onclick="event.stopPropagation()">
                      <button onclick="reprintReceipt('${item.saleId}')" style="padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                        ğŸ–¨ï¸ æ‰“å°
                      </button>
                    </td>
                  </tr>
                `;
              }).join('')}
              <tr style="font-weight: bold; background: #f8f9fa;">
                <td colspan="6" style="text-align: right;">åˆè®¡ï¼ˆä¸å«é€€æ¬¾ï¼‰ï¼š</td>
                <td>â‚¬${activeItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}</td>
                <td>â‚¬${activeItems.reduce((sum, item) => sum + item.taxAmount, 0).toFixed(2)}</td>
                <td colspan="4">-</td>
              </tr>
              ${refundedItems.length > 0 ? `
                <tr style="font-weight: bold; background: #fee2e2; opacity: 0.7;">
                  <td colspan="6" style="text-align: right;">å·²é€€æ¬¾é‡‘é¢ï¼š</td>
                  <td style="text-decoration: line-through;">â‚¬${refundedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}</td>
                  <td style="text-decoration: line-through;">â‚¬${refundedItems.reduce((sum, item) => sum + item.taxAmount, 0).toFixed(2)}</td>
                  <td colspan="4">-</td>
                </tr>
              ` : ''}
            </tbody>
          </table>
          <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
              <div>
                <div style="font-size: 12px; color: #666;">é”€å”®è®¢å•æ•°</div>
                <div style="font-size: 20px; font-weight: bold; color: #2563eb;">${salesData.length}</div>
                <div style="font-size: 11px; color: #999; margin-top: 2px;">å•†å“: ${allItems.length} ä»¶</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666;">æœ‰æ•ˆå•†å“æ•°</div>
                <div style="font-size: 20px; font-weight: bold; color: #10b981;">${activeItems.length}</div>
                <div style="font-size: 11px; color: #999; margin-top: 2px;">ä¸å«é€€æ¬¾å•†å“</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666;">æœ‰æ•ˆé”€å”®é¢</div>
                <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${activeItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}</div>
                <div style="font-size: 11px; color: #999; margin-top: 2px;">ä¸å«é€€æ¬¾é‡‘é¢</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666;">æ€»åˆ©æ¶¦</div>
                <div style="font-size: 20px; font-weight: bold; color: #10b981;">â‚¬${activeItems.reduce((sum, item) => sum + ((item.price - item.costPrice) * item.quantity), 0).toFixed(2)}</div>
                <div style="font-size: 11px; color: #999; margin-top: 2px;">ä¸å«é€€æ¬¾å•†å“</div>
              </div>
            </div>
            ${refundedItems.length > 0 ? `
              <div style="margin-top: 10px; padding: 10px; background: #fee2e2; border-radius: 6px; border-left: 3px solid #dc2626;">
                <div style="font-size: 12px; color: #991b1b; font-weight: bold;">âš ï¸ é€€æ¬¾ç»Ÿè®¡</div>
                <div style="font-size: 11px; color: #7f1d1d; margin-top: 5px;">
                  å·²é€€æ¬¾å•†å“: ${refundedItems.length} ä»¶ | é€€æ¬¾é‡‘é¢: â‚¬${refundedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2)}
                </div>
              </div>
            ` : ''}
          </div>
        `;
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®è®°å½•</p>';
      }
    }
    
    // æœç´¢è¿‡æ»¤é”€å”®è®°å½•
    function filterSalesRecords() {
      const searchTerm = document.getElementById('salesSearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰è®°å½•
        displaySalesRecords(allSalesData);
        return;
      }
      
      // è¿‡æ»¤é”€å”®è®°å½•
      const filteredData = allSalesData.filter(sale => {
        // æœç´¢å®¢æˆ·ç”µè¯
        if (sale.customerPhone && sale.customerPhone.toLowerCase().includes(searchTerm)) {
          return true;
        }
        
        // æœç´¢è®¢å•å·ï¼ˆæ”¯æŒå¤šä¸ªå¯èƒ½çš„å­—æ®µåï¼‰
        const orderNumber = sale.saleId || sale.invoiceNumber || sale._id || '';
        if (orderNumber && orderNumber.toString().toLowerCase().includes(searchTerm)) {
          return true;
        }
        
        // æœç´¢æ€»é‡‘é¢
        if (sale.totalAmount && sale.totalAmount.toString().includes(searchTerm)) {
          return true;
        }
        
        // æœç´¢å•†å“åç§°å’Œåºåˆ—å·
        return sale.items.some(item => {
          return (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                 (item.serialNumber && item.serialNumber.toLowerCase().includes(searchTerm)) ||
                 (item.price && item.price.toString().includes(searchTerm));
        });
      });
      
      displaySalesRecords(filteredData);
    }
    
    // é‡æ–°æ‰“å°å°ç¥¨
    async function reprintReceipt(saleId) {
      try {
        // ä»allSalesDataä¸­æ‰¾åˆ°å¯¹åº”çš„é”€å”®è®°å½•
        const sale = allSalesData.find(s => s._id === saleId);
        
        if (!sale) {
          alert('æ‰¾ä¸åˆ°é”€å”®è®°å½•');
          return;
        }
        
        // å‡†å¤‡æ‰“å°æ•°æ®
        const saleData = {
          saleId: sale.saleId || sale.invoiceNumber || sale._id || 'N/A'
        };
        
        const orderData = {
          customerPhone: sale.customerPhone,
          paymentMethod: sale.paymentMethod,
          cashAmount: sale.cashAmount,
          cardAmount: sale.cardAmount,
          items: sale.items
        };
        
        const totalAmount = sale.totalAmount;
        
        // è°ƒç”¨æ‰“å°å‡½æ•°
        await printReceipt(saleData, orderData, totalAmount);
        
      } catch (error) {
        console.error('é‡æ–°æ‰“å°å¤±è´¥:', error);
        alert('æ‰“å°å¤±è´¥: ' + error.message);
      }
    }

    // ==================== é€€æ¬¾åŠŸèƒ½ ====================
    
    // å…¨å±€å˜é‡å­˜å‚¨æˆè‰²åˆ—è¡¨
    let productConditions = [];
    
    // åŠ è½½äº§å“æˆè‰²åˆ—è¡¨
    async function loadProductConditions() {
      try {
        const response = await fetch(`${API_BASE}/merchant/conditions`);
        const result = await response.json();
        
        if (result.success && result.data) {
          productConditions = result.data;
          console.log('âœ… æˆè‰²åˆ—è¡¨åŠ è½½æˆåŠŸ:', productConditions.length, 'ä¸ª');
        } else {
          console.warn('âš ï¸ æˆè‰²åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼');
          // ä½¿ç”¨é»˜è®¤æˆè‰²
          productConditions = [
            { code: 'BRAND_NEW', name: 'Brand New' },
            { code: 'LIKE_NEW', name: 'Like New' },
            { code: 'EXCELLENT', name: 'Excellent' },
            { code: 'GOOD', name: 'Good' },
            { code: 'FAIR', name: 'Fair' }
          ];
        }
      } catch (error) {
        console.error('âŒ åŠ è½½æˆè‰²åˆ—è¡¨å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤æˆè‰²
        productConditions = [
          { code: 'BRAND_NEW', name: 'Brand New' },
          { code: 'LIKE_NEW', name: 'Like New' },
          { code: 'EXCELLENT', name: 'Excellent' },
          { code: 'GOOD', name: 'Good' },
          { code: 'FAIR', name: 'Fair' }
        ];
      }
    }
    
    // æŸ¥çœ‹é”€å”®è®¢å•è¯¦æƒ…
    async function viewSaleDetail(saleId) {
      try {
        const sale = allSalesData.find(s => s._id === saleId);
        
        if (!sale) {
          alert('æ‰¾ä¸åˆ°é”€å”®è®°å½•');
          return;
        }
        
        // å¦‚æœæˆè‰²åˆ—è¡¨è¿˜æ²¡åŠ è½½ï¼Œå…ˆåŠ è½½
        if (productConditions.length === 0) {
          await loadProductConditions();
        }
        
        // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
        const container = document.getElementById('saleDetailContent');
        
        const html = `
          <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è®¢å•å·</div>
                <div style="font-weight: 600;">${sale.saleId || sale.invoiceNumber || sale._id || 'N/A'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ—¥æœŸæ—¶é—´</div>
                <div style="font-weight: 600;">${new Date(sale.date).toLocaleString('zh-CN')}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å®¢æˆ·ç”µè¯</div>
                <div style="font-weight: 600;">${sale.customerPhone || '-'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ”¯ä»˜æ–¹å¼</div>
                <div style="font-weight: 600;">${getPaymentMethodText(sale.paymentMethod)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»é‡‘é¢</div>
                <div style="font-weight: 600; font-size: 18px; color: #2563eb;">â‚¬${sale.totalAmount.toFixed(2)}</div>
              </div>
            </div>
          </div>
          
          <h3 style="margin-bottom: 15px;">å•†å“æ˜ç»†</h3>
          <div style="max-height: 400px; overflow-y: auto;">
            ${sale.items.map((item, index) => `
              <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <input type="checkbox" 
                    id="refundItem_${index}" 
                    value="${index}"
                    style="width: 20px; height: 20px; cursor: pointer;">
                  <label for="refundItem_${index}" style="flex: 1; cursor: pointer; font-weight: 600; font-size: 16px;">
                    ${item.productName}
                  </label>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-left: 30px;">
                  <div>
                    <span style="color: #666; font-size: 13px;">æ•°é‡:</span>
                    <span style="font-weight: 600;">${item.quantity}</span>
                  </div>
                  <div>
                    <span style="color: #666; font-size: 13px;">å•ä»·:</span>
                    <span style="font-weight: 600;">â‚¬${item.price.toFixed(2)}</span>
                  </div>
                  <div>
                    <span style="color: #666; font-size: 13px;">å°è®¡:</span>
                    <span style="font-weight: 600; color: #2563eb;">â‚¬${(item.price * item.quantity).toFixed(2)}</span>
                  </div>
                  ${item.serialNumber ? `
                    <div>
                      <span style="color: #666; font-size: 13px;">åºåˆ—å·:</span>
                      <span style="font-weight: 600; font-size: 11px;">${item.serialNumber}</span>
                    </div>
                  ` : ''}
                  ${item.repairLocation ? `
                    <div style="grid-column: 1 / -1;">
                      <span style="color: #666; font-size: 13px;">ç»´ä¿®åœ°ç‚¹:</span>
                      <span style="font-weight: 600; color: #f59e0b;">${item.repairLocation}</span>
                    </div>
                  ` : ''}
                </div>
                
                <!-- é€€æ¬¾é€‰é¡¹ï¼ˆåˆå§‹éšè—ï¼‰ -->
                <div id="refundOptions_${index}" style="display: none; margin-top: 15px; margin-left: 30px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                  ${getRefundOptions(item, index)}
                </div>
              </div>
            `).join('')}
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <div style="font-size: 14px; color: #92400e;">
              <strong>é€€æ¬¾è¯´æ˜ï¼š</strong><br>
              â€¢ è®¾å¤‡äº§å“ï¼šéœ€è¦é€‰æ‹©é€€å›åçš„çŠ¶æ€å’Œæˆè‰²<br>
              â€¢ ç»´ä¿®æœåŠ¡ï¼šè¯·ç¡®è®¤æ˜¯å¦å·²åœ¨ç»´ä¿®åœ°ç‚¹é€€æ¬¾<br>
              â€¢ å…¶ä»–äº§å“ï¼šé€‰æ‹©æ˜¯å¦è¡¥å›åº“å­˜
            </div>
          </div>
        `;
        
        container.innerHTML = html;
        
        // ä¿å­˜å½“å‰é”€å”®è®°å½•åˆ°å…¨å±€å˜é‡
        window.currentSaleForRefund = sale;
        
        // ä¸ºå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        sale.items.forEach((item, index) => {
          const checkbox = document.getElementById(`refundItem_${index}`);
          if (checkbox) {
            checkbox.addEventListener('change', function() {
              const optionsDiv = document.getElementById(`refundOptions_${index}`);
              if (optionsDiv) {
                optionsDiv.style.display = this.checked ? 'block' : 'none';
              }
            });
          }
        });
        
        // æ˜¾ç¤ºå¯¹è¯æ¡†
        document.getElementById('saleDetailModal').style.display = 'flex';
        
      } catch (error) {
        console.error('æŸ¥çœ‹è®¢å•è¯¦æƒ…å¤±è´¥:', error);
        alert('æŸ¥çœ‹è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
      }
    }
    
    // æ ¹æ®äº§å“ç±»å‹ç”Ÿæˆé€€æ¬¾é€‰é¡¹
    function getRefundOptions(item, index) {
      // åˆ¤æ–­äº§å“ç±»å‹
      const isDevice = item.serialNumber && !item.repairLocation;
      const isRepair = item.repairLocation;
      
      if (isDevice) {
        // è®¾å¤‡äº§å“ï¼šé€‰æ‹©çŠ¶æ€å’Œæˆè‰²ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
        const originalCondition = item.originalCondition || 'å…¨æ–°'; // ä½¿ç”¨ä¸­æ–‡é»˜è®¤å€¼ï¼ŒåŒ¹é…æ•°æ®åº“
        const originalCategory = item.originalCategory || '';
        
        // åˆ¤æ–­åŸå§‹æˆè‰²æ˜¯å¦ä¸ºå…¨æ–°
        const isBrandNew = originalCondition === 'Brand New' || originalCondition === 'å…¨æ–°' || originalCondition === 'BRAND NEW';
        
        // æ ¹æ®åŸå§‹æˆè‰²è¿‡æ»¤å¯é€‰æˆè‰²
        let availableConditions = [];
        if (isBrandNew) {
          // å…¨æ–°äº§å“ï¼šå¯ä»¥å˜æˆä»»ä½•æˆè‰²
          availableConditions = productConditions;
        } else {
          // äºŒæ‰‹äº§å“ï¼šä¸èƒ½å˜æˆå…¨æ–°ï¼Œåªèƒ½ä¿æŒäºŒæ‰‹æˆ–æ›´å·®
          availableConditions = productConditions.filter(cond => {
            const condName = cond.name.toLowerCase();
            const condCode = (cond.code || '').toUpperCase();
            // è¿‡æ»¤æ‰æ‰€æœ‰è¡¨ç¤º"å…¨æ–°"çš„æˆè‰²ï¼ˆæ”¯æŒä¸­è‹±æ–‡å’Œcodeï¼‰
            return condName !== 'brand new' && 
                   condName !== 'å…¨æ–°' && 
                   condCode !== 'BRAND NEW' &&
                   condCode !== 'BRAND_NEW';
          });
        }
        
        const conditionOptions = availableConditions.length > 0 
          ? availableConditions.map(cond => {
              const selected = cond.name === originalCondition ? 'selected' : '';
              return `<option value="${cond.name}" ${selected}>${cond.name}</option>`;
            }).join('')
          : `
            <option value="Like New">Like New</option>
            <option value="Excellent">Excellent</option>
            <option value="Good">Good</option>
            <option value="Fair">Fair</option>
            <option value="Pre-Owned">Pre-Owned</option>
          `;
        
        // æ·»åŠ åˆ†ç±»å˜æ›´æç¤º
        const categoryWarning = isBrandNew ? `
          <div id="categoryWarning_${index}" style="display: none; margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; border-left: 3px solid #f59e0b;">
            <div style="font-size: 13px; color: #92400e;">
              âš ï¸ <strong>æ³¨æ„ï¼š</strong>å°†å…¨æ–°äº§å“æ”¹ä¸ºäºŒæ‰‹æˆè‰²åï¼Œåˆ†ç±»å°†ä»"å…¨æ–°è®¾å¤‡"å˜æ›´ä¸º"äºŒæ‰‹è®¾å¤‡"
            </div>
          </div>
        ` : '';
        
        return `
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">é€€å›åçŠ¶æ€</label>
              <select id="deviceStatus_${index}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                <option value="available">å¯ç”¨</option>
                <option value="damaged">æŸå</option>
                <option value="repairing">ç»´ä¿®ä¸­</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">
                æˆè‰²
                ${!isBrandNew ? '<span style="color: #ef4444; font-size: 11px;">(äºŒæ‰‹äº§å“ä¸å¯å˜ä¸ºå…¨æ–°)</span>' : ''}
              </label>
              <select id="deviceCondition_${index}" 
                      onchange="checkCategoryChange(${index}, '${originalCondition}', '${originalCategory}')"
                      style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                ${conditionOptions}
              </select>
            </div>
          </div>
          ${categoryWarning}
          <div style="margin-top: 10px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="restockDevice_${index}" checked style="width: 16px; height: 16px;">
              <span style="font-size: 13px;">è¡¥å›åº“å­˜</span>
            </label>
          </div>
          <input type="hidden" id="originalCondition_${index}" value="${originalCondition}">
          <input type="hidden" id="originalCategory_${index}" value="${originalCategory}">
        `;
      } else if (isRepair) {
        // ç»´ä¿®æœåŠ¡ï¼šç¡®è®¤ç»´ä¿®åœ°ç‚¹é€€æ¬¾
        return `
          <div style="background: #fef3c7; padding: 15px; border-radius: 6px; border-left: 3px solid #f59e0b;">
            <div style="font-weight: 600; color: #92400e; margin-bottom: 10px;">
              âš ï¸ ç»´ä¿®æœåŠ¡é€€æ¬¾æé†’
            </div>
            <div style="font-size: 13px; color: #78350f; margin-bottom: 10px;">
              ç»´ä¿®åœ°ç‚¹: <strong>${item.repairLocation}</strong>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="repairRefundConfirm_${index}" style="width: 16px; height: 16px;">
              <span style="font-size: 13px; color: #92400e;">
                æˆ‘ç¡®è®¤å·²åœ¨ç»´ä¿®åœ°ç‚¹è¿›è¡Œé€€æ¬¾å¤„ç†
              </span>
            </label>
          </div>
        `;
      } else {
        // æ™®é€šäº§å“ï¼šé€‰æ‹©æ˜¯å¦è¡¥å›åº“å­˜
        return `
          <div>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="restockProduct_${index}" checked style="width: 16px; height: 16px;">
              <span style="font-size: 13px;">è¡¥å›åº“å­˜</span>
            </label>
          </div>
        `;
      }
    }
    
    // æ£€æŸ¥åˆ†ç±»å˜æ›´
    function checkCategoryChange(index, originalCondition, originalCategory) {
      const selectedCondition = document.getElementById(`deviceCondition_${index}`).value;
      const warningDiv = document.getElementById(`categoryWarning_${index}`);
      
      if (!warningDiv) return;
      
      // åˆ¤æ–­åŸå§‹æ˜¯å¦ä¸ºå…¨æ–°
      const wasNew = originalCondition === 'Brand New' || originalCondition === 'å…¨æ–°' || originalCondition === 'BRAND NEW';
      
      // åˆ¤æ–­é€‰æ‹©çš„æ˜¯å¦ä¸ºäºŒæ‰‹
      const isNowUsed = selectedCondition !== 'Brand New' && selectedCondition !== 'å…¨æ–°';
      
      // å¦‚æœä»å…¨æ–°å˜ä¸ºäºŒæ‰‹ï¼Œæ˜¾ç¤ºè­¦å‘Š
      if (wasNew && isNowUsed) {
        warningDiv.style.display = 'block';
      } else {
        warningDiv.style.display = 'none';
      }
    }
    
    // å¤„ç†é€€æ¬¾
    async function processRefund() {
      try {
        const sale = window.currentSaleForRefund;
        if (!sale) {
          alert('æœªæ‰¾åˆ°é”€å”®è®°å½•');
          return;
        }
        
        // æ”¶é›†é€‰ä¸­çš„é€€æ¬¾é¡¹ç›®
        const refundItems = [];
        
        for (let i = 0; i < sale.items.length; i++) {
          const checkbox = document.getElementById(`refundItem_${i}`);
          if (!checkbox || !checkbox.checked) continue;
          
          const item = sale.items[i];
          const isDevice = item.serialNumber && !item.repairLocation;
          const isRepair = item.repairLocation;
          
          const refundItem = {
            productName: item.productName,
            quantity: item.quantity,
            price: item.price,
            totalAmount: item.price * item.quantity,
            serialNumber: item.serialNumber,
            productId: item.productId
          };
          
          if (isDevice) {
            // è®¾å¤‡äº§å“
            const status = document.getElementById(`deviceStatus_${i}`).value;
            const condition = document.getElementById(`deviceCondition_${i}`).value;
            const restock = document.getElementById(`restockDevice_${i}`).checked;
            const originalCondition = document.getElementById(`originalCondition_${i}`)?.value || item.originalCondition || 'å…¨æ–°'; // ä½¿ç”¨ä¸­æ–‡é»˜è®¤å€¼
            const originalCategory = document.getElementById(`originalCategory_${i}`)?.value || item.originalCategory || '';
            
            refundItem.type = 'device';
            refundItem.deviceStatus = status;
            refundItem.deviceCondition = condition;
            refundItem.restock = restock;
            refundItem.originalCondition = originalCondition;
            refundItem.originalCategory = originalCategory;
          } else if (isRepair) {
            // ç»´ä¿®æœåŠ¡
            const confirmed = document.getElementById(`repairRefundConfirm_${i}`).checked;
            
            if (!confirmed) {
              alert(`è¯·ç¡®è®¤å·²åœ¨ç»´ä¿®åœ°ç‚¹ "${item.repairLocation}" è¿›è¡Œé€€æ¬¾å¤„ç†`);
              return;
            }
            
            refundItem.type = 'repair';
            refundItem.repairLocation = item.repairLocation;
            refundItem.confirmed = true;
          } else {
            // æ™®é€šäº§å“
            const restock = document.getElementById(`restockProduct_${i}`).checked;
            
            refundItem.type = 'product';
            refundItem.restock = restock;
          }
          
          refundItems.push(refundItem);
        }
        
        if (refundItems.length === 0) {
          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•†å“è¿›è¡Œé€€æ¬¾');
          return;
        }
        
        // è®¡ç®—é€€æ¬¾æ€»é¢
        const refundTotal = refundItems.reduce((sum, item) => sum + item.totalAmount, 0);
        
        // ç¡®è®¤é€€æ¬¾
        const confirmMsg = `ç¡®è®¤é€€æ¬¾ä»¥ä¸‹å•†å“ï¼Ÿ\n\n${refundItems.map(item => 
          `â€¢ ${item.productName} x${item.quantity} - â‚¬${item.totalAmount.toFixed(2)}`
        ).join('\n')}\n\né€€æ¬¾æ€»é¢: â‚¬${refundTotal.toFixed(2)}`;
        
        if (!confirm(confirmMsg)) {
          return;
        }
        
        // å‘é€é€€æ¬¾è¯·æ±‚
        const response = await fetch(`${API_BASE}/merchant/sales/${sale._id}/refund`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            merchantId: merchantId,
            refundItems: refundItems,
            refundTotal: refundTotal
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… é€€æ¬¾æˆåŠŸï¼\n\n' + 
            `é€€æ¬¾é‡‘é¢: â‚¬${refundTotal.toFixed(2)}\n` +
            (refundItems.some(i => i.restock) ? 'å·²è¡¥å›åº“å­˜' : ''));
          
          // è¯¢é—®æ˜¯å¦æ‰“å°é€€æ¬¾å°ç¥¨
          const shouldPrint = confirm('Do you want to print a refund receipt?\næ˜¯å¦æ‰“å°é€€æ¬¾å°ç¥¨ï¼Ÿ');
          
          if (shouldPrint) {
            // æ‰“å°é€€æ¬¾å°ç¥¨
            await printRefundReceipt(sale, refundItems, refundTotal);
          }
          
          // å…³é—­å¯¹è¯æ¡†
          closeSaleDetailModal();
          
          // åˆ·æ–°é”€å”®è®°å½•
          querySalesRecords();
        } else {
          throw new Error(result.error || 'é€€æ¬¾å¤±è´¥');
        }
        
      } catch (error) {
        console.error('é€€æ¬¾å¤±è´¥:', error);
        alert('âŒ é€€æ¬¾å¤±è´¥: ' + error.message);
      }
    }
    
    // å…³é—­é”€å”®è®¢å•è¯¦æƒ…å¯¹è¯æ¡†
    function closeSaleDetailModal() {
      document.getElementById('saleDetailModal').style.display = 'none';
      window.currentSaleForRefund = null;
    }
    
    // æ‰“å°é€€æ¬¾å°ç¥¨
    async function printRefundReceipt(sale, refundItems, refundTotal) {
      try {
        // è·å–ç”¨æˆ·å…¬å¸ä¿¡æ¯
        const userResponse = await fetch(`${API_BASE}/users/profile?username=${merchantId}`);
        const userResult = await userResponse.json();
        
        let companyInfo = {
          companyName: '3C Product Store',
          address: '',
          phone: '',
          email: '',
          vatNumber: ''
        };
        
        if (userResult.success && userResult.data.companyInfo) {
          const ci = userResult.data.companyInfo;
          companyInfo = {
            companyName: ci.companyName || companyInfo.companyName,
            address: ci.address ? 
              `${ci.address.street || ''} ${ci.address.city || ''} ${ci.address.postalCode || ''}`.trim() : '',
            phone: ci.contactPhone || '',
            email: ci.contactEmail || '',
            vatNumber: ci.vatNumber || ''
          };
        }
        
        // åˆ›å»ºæ‰“å°å†…å®¹
        const printWindow = window.open('', '_blank', 'width=300,height=600');
        
        const receiptHTML = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>é€€æ¬¾å°ç¥¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    @page {
      size: 80mm auto;
      margin: 0;
    }
    
    body {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.4;
      width: 80mm;
      padding: 5mm;
      background: white;
    }
    
    .receipt {
      width: 100%;
    }
    
    .header {
      text-align: center;
      margin-bottom: 10px;
      border-bottom: 1px dashed #000;
      padding-bottom: 10px;
    }
    
    .company-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .company-info {
      font-size: 10px;
      line-height: 1.3;
    }
    
    .refund-title {
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin: 15px 0;
      padding: 10px;
      background: #f0f0f0;
      border: 2px solid #000;
    }
    
    .section {
      margin: 10px 0;
      border-bottom: 1px dashed #000;
      padding-bottom: 10px;
    }
    
    .section-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 3px 0;
      font-size: 11px;
    }
    
    .items-table {
      width: 100%;
      margin: 10px 0;
    }
    
    .item-row {
      margin: 5px 0;
      font-size: 11px;
    }
    
    .item-name {
      font-weight: bold;
    }
    
    .item-details {
      display: flex;
      justify-content: space-between;
      margin-top: 2px;
    }
    
    .item-info {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }
    
    .total-section {
      margin-top: 10px;
      border-top: 2px solid #000;
      padding-top: 10px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 12px;
    }
    
    .total-row.grand-total {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
    }
    
    .footer {
      text-align: center;
      margin-top: 15px;
      font-size: 10px;
      border-top: 1px dashed #000;
      padding-top: 10px;
    }
    
    .notice {
      font-size: 11px;
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border: 1px solid #ddd;
    }
    
    @media print {
      body {
        width: 80mm;
      }
      
      .no-print {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="receipt">
    <!-- å…¬å¸ä¿¡æ¯ -->
    <div class="header">
      <div class="company-name">${companyInfo.companyName}</div>
      <div class="company-info">
        ${companyInfo.address ? companyInfo.address + '<br>' : ''}
        ${companyInfo.phone ? 'Tel: ' + companyInfo.phone + '<br>' : ''}
        ${companyInfo.email ? 'Email: ' + companyInfo.email + '<br>' : ''}
        ${companyInfo.vatNumber ? 'VAT: ' + companyInfo.vatNumber : ''}
      </div>
    </div>
    
    <!-- é€€æ¬¾æ ‡é¢˜ -->
    <div class="refund-title">REFUND RECEIPT</div>
    
    <!-- è®¢å•ä¿¡æ¯ -->
    <div class="section">
      <div class="info-row">
        <span>Original Order:</span>
        <span>${sale.saleId || sale.invoiceNumber || sale._id || 'N/A'}</span>
      </div>
      <div class="info-row">
        <span>Refund Date:</span>
        <span>${new Date().toLocaleString('en-IE', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        })}</span>
      </div>
      ${sale.customerPhone ? `
      <div class="info-row">
        <span>Customer:</span>
        <span>${sale.customerPhone}</span>
      </div>
      ` : ''}
    </div>
    
    <!-- é€€æ¬¾å•†å“ -->
    <div class="section">
      <div class="section-title">Refunded Items</div>
      <div class="items-table">
        ${refundItems.map(item => `
          <div class="item-row">
            <div class="item-name">${item.productName}</div>
            <div class="item-details">
              <span>${item.quantity} x â‚¬${item.price.toFixed(2)}</span>
              <span>-â‚¬${item.totalAmount.toFixed(2)}</span>
            </div>
            ${item.serialNumber ? `<div class="item-info">SN: ${item.serialNumber}</div>` : ''}
            ${item.type === 'device' ? `
              <div class="item-info">
                Status: ${item.deviceStatus} | Condition: ${item.deviceCondition}
                ${item.restock ? ' | Restocked' : ''}
              </div>
            ` : ''}
            ${item.type === 'repair' ? `
              <div class="item-info">Repair Service - ${item.repairLocation}</div>
            ` : ''}
            ${item.type === 'product' && item.restock ? `
              <div class="item-info">Restocked</div>
            ` : ''}
          </div>
        `).join('')}
      </div>
    </div>
    
    <!-- é€€æ¬¾æ€»é¢ -->
    <div class="total-section">
      <div class="total-row grand-total">
        <span>REFUND TOTAL:</span>
        <span>-â‚¬${refundTotal.toFixed(2)}</span>
      </div>
    </div>
    
    <!-- æ³¨æ„äº‹é¡¹ -->
    <div class="notice">
      <strong>Notice:</strong><br>
      â€¢ Please keep this receipt for your records<br>
      ${refundItems.some(i => i.restock) ? 'â€¢ Items have been restocked<br>' : ''}
    </div>
    
    <!-- Footer -->
    <div class="footer">
      <div>Thank you for your understanding</div>
      ${companyInfo.phone ? `<div style="margin-top: 5px;">${companyInfo.phone}</div>` : ''}
    </div>
  </div>
  
  <div class="no-print" style="text-align: center; margin-top: 20px;">
    <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-right: 10px;">
      ğŸ–¨ï¸ Print
    </button>
    <button onclick="window.close()" style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
      Close
    </button>
  </div>
  
  <script>
    // è‡ªåŠ¨æ‰“å°
    window.onload = function() {
      setTimeout(function() {
        window.print();
      }, 500);
    };
    
    // æ‰“å°åå…³é—­çª—å£
    window.onafterprint = function() {
      setTimeout(function() {
        window.close();
      }, 1000);
    };
  <\/script>
</body>
</html>
        `;
        
        printWindow.document.write(receiptHTML);
        printWindow.document.close();
        
      } catch (error) {
        console.error('æ‰“å°é€€æ¬¾å°ç¥¨å¤±è´¥:', error);
        alert('æ‰“å°å¤±è´¥: ' + error.message);
      }
    }
    
    // è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬
    function getPaymentMethodText(method) {
      const methods = {
        'cash': 'ç°é‡‘',
        'card': 'åˆ·å¡',
        'mixed': 'æ··åˆæ”¯ä»˜'
      };
      return methods[method] || method;
    }

    // å…¨å±€å˜é‡å­˜å‚¨åº“å­˜æ•°æ®
    let allInventoryData = [];
    let allInventoryDataIncludingZero = []; // åŒ…å«é›¶åº“å­˜çš„å®Œæ•´æ•°æ®ï¼Œç”¨äºæœç´¢
    
    // åŠ è½½æˆ‘çš„åº“å­˜ï¼ˆåˆ†ç±»è§†å›¾ï¼‰
    async function loadMyInventory() {
      const container = document.getElementById('inventoryCategoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // ä¿å­˜å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬é›¶åº“å­˜ï¼‰ç”¨äºæœç´¢
          allInventoryDataIncludingZero = result.data;
          
          // è¿‡æ»¤æ‰æ•°é‡ä¸º0çš„äº§å“ç”¨äºåˆ†ç±»æ˜¾ç¤º
          allInventoryData = result.data.filter(item => item.quantity > 0);
          
          if (allInventoryData.length === 0) {
            container.innerHTML = `
              <p style="text-align: center; color: #999; padding: 40px;">
                æš‚æ— å¯ç”¨åº“å­˜<br>
                <small>ç‚¹å‡»ä¸Šæ–¹"+ æ‰‹åŠ¨å…¥åº“"æŒ‰é’®æ·»åŠ äº§å“</small>
              </p>
            `;
            return;
          }
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categoryMap = {};
          allInventoryData.forEach(item => {
            const category = item.category || 'æœªåˆ†ç±»';
            if (!categoryMap[category]) {
              categoryMap[category] = [];
            }
            categoryMap[category].push(item);
          });
          
          // æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡
          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">';
          
          Object.keys(categoryMap).sort().forEach(category => {
            const items = categoryMap[category];
            const totalQty = items.reduce((sum, item) => sum + item.quantity, 0);
            
            html += `
              <div onclick="showInventoryCategory('${category}')" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¦</div>
                <h3 style="font-size: 18px; margin-bottom: 10px;">${category}</h3>
                <div style="font-size: 14px; opacity: 0.9;">
                  ${items.length} ç§äº§å“ Â· ${totalQty} ä»¶åº“å­˜
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
              <h3 style="color: #856404; margin-bottom: 10px;">ğŸ“¦ æ‰¹å‘å•†ç‹¬ç«‹åº“å­˜ç³»ç»Ÿ</h3>
              <p style="color: #856404; margin: 0;">
                è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯æ‚¨ä½œä¸ºæ‰¹å‘å•†åœ¨è‡ªå·±åº—é“ºä¸­çš„åº“å­˜ï¼Œä¸ä»“åº“åº“å­˜æ˜¯ç‹¬ç«‹ç®¡ç†çš„ã€‚<br>
                æ‚¨å¯ä»¥é€šè¿‡"æ‰‹åŠ¨å…¥åº“"æˆ–"ä»“åº“è®¢è´§"åŠŸèƒ½æ·»åŠ äº§å“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚
              </p>
            </div>
            <p style="text-align: center; color: #999; padding: 40px;">
              æš‚æ— åº“å­˜æ•°æ®<br>
              <small>ç‚¹å‡»ä¸Šæ–¹"+ æ‰‹åŠ¨å…¥åº“"æŒ‰é’®æ·»åŠ äº§å“</small>
            </p>
          `;
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºæŸä¸ªåˆ†ç±»çš„äº§å“
    function showInventoryCategory(category) {
      document.getElementById('inventoryCategoryList').style.display = 'none';
      document.getElementById('inventoryProductList').style.display = 'block';
      document.getElementById('currentInventoryCategoryName').textContent = `ğŸ“¦ ${category}`;
      
      const products = allInventoryData.filter(item => (item.category || 'æœªåˆ†ç±»') === category);
      displayInventoryProducts(products);
    }
    
    // è¿”å›åˆ†ç±»åˆ—è¡¨
    function backToInventoryCategories() {
      document.getElementById('inventoryCategoryList').style.display = 'block';
      document.getElementById('inventoryProductList').style.display = 'none';
      document.getElementById('inventorySearchInput').value = '';
    }
    
    // æ˜¾ç¤ºäº§å“åˆ—è¡¨ï¼ˆåˆå¹¶ç›¸åŒäº§å“ï¼‰
    function displayInventoryProducts(products) {
      const container = document.getElementById('inventoryProducts');
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°äº§å“</p>';
        return;
      }
      
      // åˆå¹¶ç›¸åŒäº§å“ï¼ˆç›¸åŒåç§°ã€å“ç‰Œã€å‹å·ã€é¢œè‰²ã€æˆè‰²ï¼‰
      const productMap = {};
      products.forEach(item => {
        const key = `${item.productName}_${item.brand || ''}_${item.model || ''}_${item.color || ''}_${item.condition || ''}`;
        if (!productMap[key]) {
          productMap[key] = {
            ...item,
            totalQuantity: 0,
            records: []
          };
        }
        productMap[key].totalQuantity += item.quantity;
        productMap[key].records.push(item);
      });
      
      const mergedProducts = Object.values(productMap);
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>äº§å“åç§°</th>
              <th>å“ç‰Œ/å‹å·</th>
              <th>åº“å­˜æ•°é‡</th>
              <th>æˆæœ¬ä»·èŒƒå›´</th>
              <th>é›¶å”®ä»·</th>
              <th>ç¨åŠ¡åˆ†ç±»</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${mergedProducts.map(item => {
              const minCost = Math.min(...item.records.map(r => r.costPrice));
              const maxCost = Math.max(...item.records.map(r => r.costPrice));
              const costDisplay = minCost === maxCost ? `â‚¬${minCost.toFixed(2)}` : `â‚¬${minCost.toFixed(2)} - â‚¬${maxCost.toFixed(2)}`;
              
              // å¤„ç†å“ç‰Œ/å‹å·æ˜¾ç¤ºï¼Œéšè— Unknown
              const brandText = (item.brand && item.brand !== 'Unknown') ? item.brand : '';
              const modelText = (item.model && item.model !== 'Unknown') ? item.model : '';
              const brandModelDisplay = `${brandText} ${modelText}`.trim() || '-';
              
              return `
              <tr ${item.totalQuantity === 0 ? 'style="background: #fff3cd; cursor: pointer;"' : 'style="cursor: pointer;"'}
                  onclick="showProductPurchaseHistory('${item.productName}', '${item.brand || ''}', '${item.model || ''}', '${item.color || ''}', '${item.condition || ''}')"
                  onmouseover="this.style.background='#f0f9ff'" 
                  onmouseout="this.style.background='${item.totalQuantity === 0 ? '#fff3cd' : 'white'}'">
                <td>
                  <strong>${item.productName}</strong>
                  ${item.color ? `<br><span style="display: inline-block; margin-top: 4px; padding: 2px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 11px;">${item.color}</span>` : ''}
                  ${item.condition && item.condition !== 'BRAND_NEW' ? `<br><span style="display: inline-block; margin-top: 4px; padding: 2px 8px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 11px;">${item.condition}</span>` : ''}
                </td>
                <td>${brandModelDisplay}</td>
                <td>
                  <strong style="color: ${item.totalQuantity === 0 ? '#dc3545' : '#10b981'};">
                    ${item.totalQuantity}
                  </strong>
                  ${item.records.length > 1 ? `<br><small style="color: #666;">(${item.records.length}æ¡è®°å½•)</small>` : ''}
                  ${item.totalQuantity === 0 ? '<br><small style="color: #856404;">å·²å”®å®Œ</small>' : ''}
                </td>
                <td>${costDisplay}</td>
                <td>â‚¬${item.retailPrice.toFixed(2)}</td>
                <td>${getTaxBadge(item.taxClassification)}</td>
                <td onclick="event.stopPropagation()">
                  ${item.records.length > 1 ? `
                    <button onclick="showInventoryRecords('${item.productName}', '${item.brand || ''}', '${item.model || ''}', '${item.color || ''}', '${item.condition || ''}')" class="btn-sm" style="background: #3b82f6; color: white; margin-right: 5px;">
                      ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…
                    </button>
                  ` : `
                    <button onclick="editInventoryItem('${item.records[0]._id}')" class="btn-sm btn-primary" style="margin-right: 5px;">
                      âœï¸ ç¼–è¾‘
                    </button>
                    <button onclick="showProductTimeline('${item.records[0]._id}', '${item.productName}')" class="btn-sm" style="background: #6b7280; color: white;">
                      ğŸ“Š æ—¶é—´çº¿
                    </button>
                  `}
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
      container.innerHTML = html;
    }
    
    // æ˜¾ç¤ºæŸä¸ªäº§å“çš„æ‰€æœ‰åº“å­˜è®°å½•
    function showInventoryRecords(productName, brand, model, color, condition) {
      const records = allInventoryDataIncludingZero.filter(item => 
        item.productName === productName &&
        (item.brand || '') === brand &&
        (item.model || '') === model &&
        (item.color || '') === color &&
        (item.condition || '') === condition
      );
      
      if (records.length === 0) {
        alert('æœªæ‰¾åˆ°åº“å­˜è®°å½•');
        return;
      }
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 1200px; width: 90%; max-height: 80vh; overflow: auto; padding: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">ğŸ“¦ ${productName} - åº“å­˜è¯¦æƒ…</h2>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
          </div>
          
          <div style="margin-bottom: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
            <strong>æ€»åº“å­˜ï¼š${records.reduce((sum, r) => sum + r.quantity, 0)} ä»¶</strong>
            ï¼ˆå…± ${records.length} æ¡è®°å½•ï¼‰
          </div>
          
          <table style="width: 100%;">
            <thead>
              <tr>
                <th>åºåˆ—å·/æ¡ç </th>
                <th>æ•°é‡</th>
                <th>æˆæœ¬ä»·</th>
                <th>æ‰¹å‘ä»·</th>
                <th>é›¶å”®ä»·</th>
                <th>æ¥æº</th>
                <th>ä½ç½®</th>
                <th>å¤‡æ³¨</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${records.map(record => `
                <tr ${record.quantity === 0 ? 'style="background: #fff3cd;"' : ''}>
                  <td style="font-size: 11px; color: #666;">${record.serialNumber || record.barcode || '-'}</td>
                  <td><strong style="color: ${record.quantity === 0 ? '#dc3545' : '#10b981'};">${record.quantity}</strong></td>
                  <td>â‚¬${record.costPrice.toFixed(2)}</td>
                  <td>â‚¬${record.wholesalePrice.toFixed(2)}</td>
                  <td>â‚¬${record.retailPrice.toFixed(2)}</td>
                  <td>
                    ${record.source === 'warehouse' ? 'ğŸ­ ä»“åº“' : 
                      record.source === 'transfer' ? 'ğŸ”„ è°ƒè´§' : 
                      record.source === 'manual' ? 'âœï¸ æ‰‹åŠ¨' : '-'}
                  </td>
                  <td style="font-size: 12px;">${record.location || '-'}</td>
                  <td style="font-size: 12px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${record.notes || ''}">${record.notes || '-'}</td>
                  <td>
                    <button onclick="editInventoryItemFromModal('${record._id}', this)" class="btn-sm btn-primary" style="margin-right: 5px;">
                      âœï¸ ç¼–è¾‘
                    </button>
                    <button onclick="showProductTimeline('${record._id}', '${record.productName}'); this.closest('div[style*=fixed]').remove();" class="btn-sm" style="background: #6b7280; color: white;">
                      ğŸ“Š æ—¶é—´çº¿
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // æ˜¾ç¤ºäº§å“çš„è¿›è´§å†å²ï¼ˆæŒ‰è¿›è´§æ¸…å•åˆ†ç»„ï¼‰
    async function showProductPurchaseHistory(productName, brand, model, color, condition) {
      // è·å–è¯¥äº§å“çš„æ‰€æœ‰åº“å­˜è®°å½•
      const records = allInventoryDataIncludingZero.filter(item => 
        item.productName === productName &&
        (item.brand || '') === brand &&
        (item.model || '') === model &&
        (item.color || '') === color &&
        (item.condition || '') === condition
      );
      
      if (records.length === 0) {
        alert('æœªæ‰¾åˆ°åº“å­˜è®°å½•');
        return;
      }
      
      // æŒ‰æ¥æºåˆ†ç»„
      const sourceGroups = {
        warehouse: [],
        transfer: [],
        manual: []
      };
      
      records.forEach(record => {
        const source = record.source || 'manual';
        if (sourceGroups[source]) {
          sourceGroups[source].push(record);
        }
      });
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      
      const totalQty = records.reduce((sum, r) => sum + r.quantity, 0);
      const totalValue = records.reduce((sum, r) => sum + (r.quantity * r.costPrice), 0);
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 1200px; width: 90%; max-height: 85vh; overflow: auto; padding: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">ğŸ“¦ ${productName} - è¿›è´§å†å²</h2>
            <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">æ€»åº“å­˜</div>
              <div style="font-size: 24px; font-weight: bold; color: #0ea5e9;">${totalQty} ä»¶</div>
            </div>
            <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">åº“å­˜ä»·å€¼</div>
              <div style="font-size: 24px; font-weight: bold; color: #10b981;">â‚¬${totalValue.toFixed(2)}</div>
            </div>
            <div style="padding: 15px; background: #fef3c7; border-radius: 8px; text-align: center;">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è¿›è´§æ‰¹æ¬¡</div>
              <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${records.length} æ‰¹</div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="margin-bottom: 15px; color: #374151;">ğŸ“‹ è¿›è´§æ¸…å•</h3>
            
            ${sourceGroups.warehouse.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="color: #0ea5e9; margin-bottom: 10px;">ğŸ­ ä»“åº“è®¢è´§ (${sourceGroups.warehouse.length}æ‰¹)</h4>
                <div style="display: grid; gap: 10px;">
                  ${sourceGroups.warehouse.map(record => {
                    const hasOrderId = record.sourceOrderId && record.sourceOrderId !== '';
                    return `
                    <div ${hasOrderId ? `onclick="showPurchaseOrderDetails('${record.sourceOrderId}')"` : ''}
                         style="padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; ${hasOrderId ? 'cursor: pointer;' : ''} transition: all 0.2s;"
                         ${hasOrderId ? `onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#0ea5e9'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'"` : ''}>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                          <div style="font-weight: 600; margin-bottom: 5px;">
                            ${hasOrderId ? `è®¢å•å·: ${record.sourceOrderId}` : 'ä»“åº“è®¢è´§ï¼ˆæ— è®¢å•å·ï¼‰'}
                          </div>
                          <div style="font-size: 12px; color: #666;">
                            æ•°é‡: ${record.quantity} ä»¶ | 
                            æˆæœ¬: â‚¬${record.costPrice.toFixed(2)} | 
                            æ‰¹å‘ä»·: â‚¬${record.wholesalePrice.toFixed(2)} | 
                            é›¶å”®ä»·: â‚¬${record.retailPrice.toFixed(2)}
                          </div>
                          ${record.serialNumber ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">åºåˆ—å·: ${record.serialNumber}</div>` : ''}
                          ${record.createdAt ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">å…¥åº“æ—¶é—´: ${new Date(record.createdAt).toLocaleString('zh-CN')}</div>` : ''}
                        </div>
                        ${hasOrderId ? '<div style="color: #0ea5e9; font-size: 20px;">â†’</div>' : ''}
                      </div>
                    </div>
                  `}).join('')}
                </div>
              </div>
            ` : ''}
            
            ${sourceGroups.transfer.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="color: #8b5cf6; margin-bottom: 10px;">ğŸ”„ è°ƒè´§å…¥åº“ (${sourceGroups.transfer.length}æ‰¹)</h4>
                <div style="display: grid; gap: 10px;">
                  ${sourceGroups.transfer.map(record => {
                    const hasTransferId = record.sourceTransferId && record.sourceTransferId !== '';
                    return `
                    <div ${hasTransferId ? `onclick="showTransferDetails('${record.sourceTransferId}')"` : ''}
                         style="padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; ${hasTransferId ? 'cursor: pointer;' : ''} transition: all 0.2s;"
                         ${hasTransferId ? `onmouseover="this.style.background='#faf5ff'; this.style.borderColor='#8b5cf6'" onmouseout="this.style.background='#f8fafc'; this.style.borderColor='#e2e8f0'"` : ''}>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                          <div style="font-weight: 600; margin-bottom: 5px;">
                            ${hasTransferId ? `è°ƒè´§å•å·: ${record.sourceTransferId}` : 'è°ƒè´§å…¥åº“ï¼ˆæ— å•å·ï¼‰'}
                          </div>
                          <div style="font-size: 12px; color: #666;">
                            æ•°é‡: ${record.quantity} ä»¶ | 
                            æˆæœ¬: â‚¬${record.costPrice.toFixed(2)} | 
                            æ‰¹å‘ä»·: â‚¬${record.wholesalePrice.toFixed(2)} | 
                            é›¶å”®ä»·: â‚¬${record.retailPrice.toFixed(2)}
                          </div>
                          ${record.serialNumber ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">åºåˆ—å·: ${record.serialNumber}</div>` : ''}
                          ${record.createdAt ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">å…¥åº“æ—¶é—´: ${new Date(record.createdAt).toLocaleString('zh-CN')}</div>` : ''}
                        </div>
                        ${hasTransferId ? '<div style="color: #8b5cf6; font-size: 20px;">â†’</div>' : ''}
                      </div>
                    </div>
                  `}).join('')}
                </div>
              </div>
            ` : ''}
            
            ${sourceGroups.manual.length > 0 ? `
              <div style="margin-bottom: 20px;">
                <h4 style="color: #10b981; margin-bottom: 10px;">âœï¸ æ‰‹åŠ¨å…¥åº“ (${sourceGroups.manual.length}æ‰¹)</h4>
                <div style="display: grid; gap: 10px;">
                  ${sourceGroups.manual.map(record => `
                    <div style="padding: 15px; background: #f0fdf4; border: 1px solid #d1fae5; border-radius: 8px;">
                      <div style="font-weight: 600; margin-bottom: 5px;">æ‰‹åŠ¨å½•å…¥</div>
                      <div style="font-size: 12px; color: #666;">
                        æ•°é‡: ${record.quantity} ä»¶ | 
                        æˆæœ¬: â‚¬${record.costPrice.toFixed(2)} | 
                        æ‰¹å‘ä»·: â‚¬${record.wholesalePrice.toFixed(2)} | 
                        é›¶å”®ä»·: â‚¬${record.retailPrice.toFixed(2)}
                      </div>
                      ${record.serialNumber ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">åºåˆ—å·: ${record.serialNumber}</div>` : ''}
                      ${record.notes ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">å¤‡æ³¨: ${record.notes}</div>` : ''}
                      ${record.createdAt ? `<div style="font-size: 11px; color: #666; margin-top: 3px;">å…¥åº“æ—¶é—´: ${new Date(record.createdAt).toLocaleString('zh-CN')}</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          
          <div style="text-align: right; padding-top: 15px; border-top: 1px solid #e5e7eb;">
            <button onclick="this.closest('div[style*=fixed]').remove()" class="btn" style="background: #6b7280; color: white;">
              å…³é—­
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // æ˜¾ç¤ºé‡‡è´­è®¢å•è¯¦æƒ…
    async function showPurchaseOrderDetails(orderId) {
      if (!orderId) {
        alert('è®¢å•IDä¸å­˜åœ¨');
        return;
      }
      
      try {
        // è·å–è®¢å•è¯¦æƒ…
        const response = await fetch(`${API_BASE}/warehouse/orders/${orderId}`);
        const result = await response.json();
        
        if (!result.success) {
          alert('è·å–è®¢å•è¯¦æƒ…å¤±è´¥: ' + result.error);
          return;
        }
        
        const order = result.data;
        
        // åˆ›å»ºè®¢å•è¯¦æƒ…æ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
        
        const statusBadge = {
          'pending': '<span style="background: #fbbf24; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å¾…ç¡®è®¤</span>',
          'confirmed': '<span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å·²ç¡®è®¤</span>',
          'shipped': '<span style="background: #8b5cf6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å·²å‘è´§</span>',
          'completed': '<span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å·²å®Œæˆ</span>',
          'cancelled': '<span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">å·²å–æ¶ˆ</span>'
        };
        
        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; max-width: 1000px; width: 90%; max-height: 85vh; overflow: auto; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <h2 style="margin: 0 0 10px 0;">ğŸ­ ä»“åº“è®¢å•è¯¦æƒ…</h2>
                <div style="font-size: 14px; color: #666;">
                  è®¢å•å·: <strong>${order.orderNumber}</strong> | 
                  çŠ¶æ€: ${statusBadge[order.status] || order.status}
                </div>
              </div>
              <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; padding: 20px; background: #f8fafc; border-radius: 8px;">
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è®¢å•æ—¥æœŸ</div>
                <div style="font-weight: 600;">${new Date(order.orderedAt || order.createdAt).toLocaleString('zh-CN')}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å®Œæˆæ—¥æœŸ</div>
                <div style="font-weight: 600;">${order.completedAt ? new Date(order.completedAt).toLocaleString('zh-CN') : '-'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">é…é€æ–¹å¼</div>
                <div style="font-weight: 600;">${order.deliveryMethod === 'pickup' ? 'ğŸª è‡ªæ' : 'ğŸšš é…é€'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è®¢å•é‡‘é¢</div>
                <div style="font-weight: 600; color: #10b981; font-size: 18px;">â‚¬${order.totalAmount.toFixed(2)}</div>
              </div>
            </div>
            
            <h3 style="margin: 20px 0 15px 0; color: #374151;">ğŸ“¦ è®¢å•äº§å“</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f1f5f9;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">äº§å“åç§°</th>
                  <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">å‹å·/é¢œè‰²</th>
                  <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">æˆè‰²</th>
                  <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">æ•°é‡</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">å•ä»·</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">å°è®¡</th>
                </tr>
              </thead>
              <tbody>
                ${order.items.map(item => `
                  <tr style="border-bottom: 1px solid #e2e8f0;">
                    <td style="padding: 12px;">
                      <strong>${item.productName}</strong>
                      ${item.sku ? `<br><span style="font-size: 11px; color: #666;">SKU: ${item.sku}</span>` : ''}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                      ${item.model || '-'}<br>
                      <span style="font-size: 11px; color: #666;">${item.color || '-'}</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                      <span style="padding: 2px 8px; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 11px;">
                        ${item.condition || '-'}
                      </span>
                    </td>
                    <td style="padding: 12px; text-align: center; font-weight: 600;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right;">â‚¬${item.wholesalePrice.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">â‚¬${item.subtotal.toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
              <tfoot>
                <tr style="background: #f8fafc; font-weight: 600;">
                  <td colspan="5" style="padding: 12px; text-align: right;">å°è®¡:</td>
                  <td style="padding: 12px; text-align: right;">â‚¬${order.subtotal.toFixed(2)}</td>
                </tr>
                <tr style="background: #f8fafc;">
                  <td colspan="5" style="padding: 12px; text-align: right;">ç¨é¢:</td>
                  <td style="padding: 12px; text-align: right;">â‚¬${order.taxAmount.toFixed(2)}</td>
                </tr>
                <tr style="background: #f1f5f9; font-weight: 600; font-size: 16px;">
                  <td colspan="5" style="padding: 12px; text-align: right;">æ€»è®¡:</td>
                  <td style="padding: 12px; text-align: right; color: #10b981;">â‚¬${order.totalAmount.toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>
            
            ${order.notes ? `
              <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px;">
                <div style="font-weight: 600; margin-bottom: 5px;">ğŸ“ å¤‡æ³¨</div>
                <div style="font-size: 14px;">${order.notes}</div>
              </div>
            ` : ''}
            
            <div style="text-align: right; padding-top: 20px; border-top: 1px solid #e5e7eb; margin-top: 20px;">
              <button onclick="this.closest('div[style*=fixed]').remove()" class="btn" style="background: #6b7280; color: white;">
                å…³é—­
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
      } catch (error) {
        console.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', error);
        alert('è·å–è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºè°ƒè´§è¯¦æƒ…
    async function showTransferDetails(transferId) {
      if (!transferId) {
        alert('è°ƒè´§å•IDä¸å­˜åœ¨');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/${transferId}`);
        const result = await response.json();
        
        if (result.success) {
          // ä½¿ç”¨ç°æœ‰çš„æ˜¾ç¤ºè°ƒè´§è¯¦æƒ…å‡½æ•°
          displayTransferDetails(result.data);
        } else {
          alert('è·å–è°ƒè´§è¯¦æƒ…å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('è·å–è°ƒè´§è¯¦æƒ…å¤±è´¥:', error);
        alert('è·å–è°ƒè´§è¯¦æƒ…å¤±è´¥: ' + error.message);
      }
    }
    
    // æœç´¢åº“å­˜
    function searchInventory() {
      const searchTerm = document.getElementById('inventorySearchInput').value.toLowerCase().trim();
      
      if (!searchTerm) {
        // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œè¿”å›åˆ†ç±»è§†å›¾
        backToInventoryCategories();
        return;
      }
      
      // æœç´¢äº§å“åç§°ã€åºåˆ—å·ã€æ¡ç ã€å¤‡æ³¨ï¼ˆåŒ…æ‹¬é›¶åº“å­˜äº§å“ï¼‰
      const filteredProducts = allInventoryDataIncludingZero.filter(item => {
        return (
          (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
          (item.serialNumber && item.serialNumber.toLowerCase().includes(searchTerm)) ||
          (item.barcode && item.barcode.toLowerCase().includes(searchTerm)) ||
          (item.notes && item.notes.toLowerCase().includes(searchTerm))
        );
      });
      
      // æ˜¾ç¤ºæœç´¢ç»“æœ
      document.getElementById('inventoryCategoryList').style.display = 'none';
      document.getElementById('inventoryProductList').style.display = 'block';
      document.getElementById('currentInventoryCategoryName').textContent = `ğŸ” æœç´¢ç»“æœ: "${searchTerm}"`;
      displayInventoryProducts(filteredProducts);
    }

    // æ˜¾ç¤ºå…¥åº“æ¨¡æ€æ¡†
    async function showAddInventoryModal() {
      document.getElementById('addInventoryModal').style.display = 'flex';
      document.getElementById('addInventoryForm').reset();
      
      // æ˜¾ç¤ºå½“å‰å•†æˆ·ä¿¡æ¯
      const merchantInfo = document.getElementById('currentMerchantInfo');
      merchantInfo.textContent = `${merchantId} (å½“å‰ç™»å½•å•†æˆ·)`;
      
      // åŠ è½½åˆ†ç±»åˆ—è¡¨
      await loadCategoriesForInventory();
      
      // åŠ è½½æˆè‰²åˆ—è¡¨
      await loadConditionsForInventory();
    }
    
    // åŠ è½½åˆ†ç±»åˆ—è¡¨ï¼ˆç”¨äºå…¥åº“è¡¨å•ï¼‰
    async function loadCategoriesForInventory() {
      try {
        const response = await fetch(`${API_BASE}/admin/categories`);
        const result = await response.json();
        
        const select = document.getElementById('inv_category');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»...</option>';
        
        if (result.success && result.data && result.data.length > 0) {
          result.data.forEach(category => {
            const option = document.createElement('option');
            option.value = category.type;
            option.textContent = category.type;
            select.appendChild(option);
          });
        } else {
          // å¦‚æœæ²¡æœ‰åˆ†ç±»ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
          const defaultCategories = ['æ‰‹æœºé…ä»¶', 'ç”µè„‘é…ä»¶', 'è½¦è½½é…ä»¶', 'æ•°æ®çº¿', 'Audio', 'Power Supply'];
          defaultCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        // æ·»åŠ é»˜è®¤é€‰é¡¹
        const select = document.getElementById('inv_category');
        const defaultCategories = ['æ‰‹æœºé…ä»¶', 'ç”µè„‘é…ä»¶', 'è½¦è½½é…ä»¶', 'æ•°æ®çº¿', 'Audio', 'Power Supply'];
        defaultCategories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          select.appendChild(option);
        });
      }
    }
    
    // åŠ è½½æˆè‰²åˆ—è¡¨ï¼ˆç”¨äºå…¥åº“è¡¨å•ï¼‰
    async function loadConditionsForInventory() {
      try {
        const response = await fetch(`${API_BASE}/admin/conditions`);
        const result = await response.json();
        
        const select = document.getElementById('inv_condition');
        select.innerHTML = '';
        
        if (result.success && result.data && result.data.length > 0) {
          result.data.forEach(condition => {
            const option = document.createElement('option');
            option.value = condition.code;
            option.textContent = condition.name;
            if (condition.code === 'BRAND_NEW') {
              option.selected = true;
            }
            select.appendChild(option);
          });
        } else {
          // å¦‚æœæ²¡æœ‰æˆè‰²ï¼Œæ·»åŠ é»˜è®¤é€‰é¡¹
          select.innerHTML = `
            <option value="BRAND_NEW" selected>å…¨æ–°</option>
            <option value="PRE_OWNED">äºŒæ‰‹</option>
            <option value="REFURBISHED">ç¿»æ–°</option>
          `;
        }
      } catch (error) {
        console.error('åŠ è½½æˆè‰²å¤±è´¥:', error);
        // æ·»åŠ é»˜è®¤é€‰é¡¹
        const select = document.getElementById('inv_condition');
        select.innerHTML = `
          <option value="BRAND_NEW" selected>å…¨æ–°</option>
          <option value="PRE_OWNED">äºŒæ‰‹</option>
          <option value="REFURBISHED">ç¿»æ–°</option>
        `;
      }
    }

    // å…³é—­å…¥åº“æ¨¡æ€æ¡†
    function closeAddInventoryModal() {
      document.getElementById('addInventoryModal').style.display = 'none';
    }

    // æäº¤å…¥åº“è¡¨å•
    async function submitAddInventory(event) {
      event.preventDefault();
      
      // è·å–è¡¨å•æ•°æ®
      let productName = document.getElementById('inv_productName').value;
      let model = document.getElementById('inv_model').value;
      
      // ğŸ”„ æ ‡å‡†åŒ–äº§å“åç§°å’Œå‹å·ï¼šè½¬å¤§å†™å¹¶å»é™¤ç©ºæ ¼
      if (productName) {
        productName = productName.trim().toUpperCase().replace(/\s+/g, '');
      }
      if (model) {
        model = model.trim().toUpperCase().replace(/\s+/g, '');
      }
      
      const formData = {
        merchantId: merchantId,
        productName: productName,
        brand: document.getElementById('inv_brand').value,
        model: model,
        category: document.getElementById('inv_category').value,
        quantity: parseInt(document.getElementById('inv_quantity').value),
        costPrice: parseFloat(document.getElementById('inv_costPrice').value),
        wholesalePrice: parseFloat(document.getElementById('inv_wholesalePrice').value),
        retailPrice: parseFloat(document.getElementById('inv_retailPrice').value),
        barcode: document.getElementById('inv_barcode').value,
        serialNumber: document.getElementById('inv_serialNumber').value,
        color: document.getElementById('inv_color').value,
        condition: document.getElementById('inv_condition').value,
        notes: document.getElementById('inv_notes').value
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å…¥åº“æˆåŠŸï¼');
          closeAddInventoryModal();
          loadMyInventory(); // åˆ·æ–°åº“å­˜åˆ—è¡¨
          loadStats(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
        } else {
          alert('âŒ å…¥åº“å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ å…¥åº“å¤±è´¥: ' + error.message);
      }
    }

    // å…¨å±€å˜é‡å­˜å‚¨ä»“åº“äº§å“æ•°æ®
    let allWarehouseData = [];
    
    // ==================== ç¾¤ç»„åº“å­˜åŠŸèƒ½ ====================
    
    let selectedTransferStore = null;  // é€‰ä¸­çš„ç›®æ ‡åº—é“º
    let allGroupInventoryData = [];
    
    // åŠ è½½ç¾¤ç»„åº“å­˜ - æ­¥éª¤1ï¼šæ˜¾ç¤ºåº—é“ºåˆ—è¡¨
    async function loadGroupInventory() {
      const container = document.getElementById('groupStoreList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      // é‡ç½®çŠ¶æ€
      selectedTransferStore = null;
      document.getElementById('groupStoreSelection').style.display = 'block';
      document.getElementById('groupCategorySelection').style.display = 'none';
      document.getElementById('groupProductList').style.display = 'none';
      
      try {
        // è·å–åŒä¸€ç¾¤ç»„çš„å…¶ä»–ç”¨æˆ·
        const response = await fetch(`${API_BASE}/merchant/group-users?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const stores = result.data.filter(user => user.username !== merchantId);
          
          if (stores.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç¾¤ç»„å†…æš‚æ— å…¶ä»–åº—é“º</p>';
            return;
          }
          
          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">';
          
          stores.forEach(store => {
            html += `
              <div onclick="selectStore('${store.username}', '${store.username}')" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 48px; margin-bottom: 15px; text-align: center;">ğŸª</div>
                <h3 style="font-size: 20px; margin-bottom: 10px; text-align: center;">${store.username}</h3>
                <div style="font-size: 14px; opacity: 0.9; text-align: center;">
                  ${store.profile?.firstName ? `è”ç³»äºº: ${store.profile.firstName}` : ''}
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç¾¤ç»„å†…æš‚æ— å…¶ä»–åº—é“º</p>';
        }
      } catch (error) {
        console.error('åŠ è½½åº—é“ºåˆ—è¡¨å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // é€‰æ‹©åº—é“º
    async function selectStore(storeUsername, storeName) {
      selectedTransferStore = {
        username: storeUsername,
        name: storeName
      };
      
      // æ˜¾ç¤ºç›®æ ‡åº—é“ºä¿¡æ¯åœ¨è´­ç‰©è½¦ä¸­
      document.getElementById('transferCartTargetStore').style.display = 'block';
      document.getElementById('transferCartStoreName').textContent = storeName;
      
      // æ˜¾ç¤ºåˆ†ç±»é€‰æ‹©ç•Œé¢
      document.getElementById('groupStoreSelection').style.display = 'none';
      document.getElementById('groupCategorySelection').style.display = 'block';
      document.getElementById('selectedStoreName').textContent = storeName;
      
      // åŠ è½½è¯¥åº—é“ºçš„åˆ†ç±»
      await loadStoreCategories(storeUsername);
    }
    
    // è¿”å›åº—é“ºé€‰æ‹©
    function backToStoreSelection() {
      // å¦‚æœè´­ç‰©è½¦ä¸ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
      if (transferCart.length > 0) {
        if (!confirm('è¿”å›åº—é“ºé€‰æ‹©å°†æ¸…ç©ºå½“å‰è°ƒè´§æ¸…å•ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
          return;
        }
        clearTransferCart();
      }
      
      selectedTransferStore = null;
      
      // éšè—ç›®æ ‡åº—é“ºä¿¡æ¯
      document.getElementById('transferCartTargetStore').style.display = 'none';
      document.getElementById('transferCartStoreName').textContent = '';
      
      document.getElementById('groupStoreSelection').style.display = 'block';
      document.getElementById('groupCategorySelection').style.display = 'none';
      document.getElementById('groupProductList').style.display = 'none';
    }
    
    // åŠ è½½åº—é“ºçš„åˆ†ç±»
    async function loadStoreCategories(storeUsername) {
      const container = document.getElementById('groupCategoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/group-inventory?merchantId=${merchantId}&targetMerchant=${storeUsername}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // åªä¿ç•™å¯é”€å”®çš„äº§å“
          allGroupInventoryData = result.data.filter(item => 
            item.quantity > 0 && item.status === 'active'
          );
          
          if (allGroupInventoryData.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯¥åº—é“ºæš‚æ— å¯é”€å”®äº§å“</p>';
            return;
          }
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categoryMap = {};
          allGroupInventoryData.forEach(item => {
            const category = item.category || 'æœªåˆ†ç±»';
            if (!categoryMap[category]) {
              categoryMap[category] = {
                name: category,
                count: 0,
                totalQty: 0
              };
            }
            categoryMap[category].count++;
            categoryMap[category].totalQty += item.quantity;
          });
          
          const categoryArray = Object.values(categoryMap);
          
          let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">';
          
          categoryArray.forEach(cat => {
            html += `
              <div onclick="showGroupCategory('${cat.name}')" 
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¦</div>
                <h3 style="font-size: 18px; margin-bottom: 10px;">${cat.name}</h3>
                <div style="font-size: 14px; opacity: 0.9;">
                  ${cat.count} ç§äº§å“<br>
                  ${cat.totalQty} ä»¶åº“å­˜
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯¥åº—é“ºæš‚æ— å¯é”€å”®äº§å“</p>';
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºæŸä¸ªåˆ†ç±»çš„ç¾¤ç»„äº§å“
    function showGroupCategory(category) {
      document.getElementById('groupCategorySelection').style.display = 'none';
      document.getElementById('groupProductList').style.display = 'block';
      document.getElementById('currentStoreName').textContent = selectedTransferStore.name;
      document.getElementById('currentCategoryName').textContent = category;
      
      const products = allGroupInventoryData.filter(item => 
        (item.category || 'æœªåˆ†ç±»') === category
      );
      
      displayGroupInventoryProducts(products);
    }
    
    // è¿”å›ç¾¤ç»„åˆ†ç±»åˆ—è¡¨
    function backToGroupCategories() {
      document.getElementById('groupCategorySelection').style.display = 'block';
      document.getElementById('groupProductList').style.display = 'none';
      document.getElementById('groupInventorySearchInput').value = '';
    }
    
    // æ˜¾ç¤ºç¾¤ç»„åº“å­˜äº§å“åˆ—è¡¨
    function displayGroupInventoryProducts(products) {
      const container = document.getElementById('groupInventoryTable');
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯¥åˆ†ç±»æš‚æ— äº§å“</p>';
        return;
      }
      
      // æ£€æµ‹å˜ä½“ï¼šä½¿ç”¨ NO_MODEL å’Œ NO_COLOR ä½œä¸ºå ä½ç¬¦
      const hasVariants = products.some(p => 
        (p.model && p.model !== 'NO_MODEL') || (p.color && p.color !== 'NO_COLOR')
      );
      
      if (hasVariants) {
        // æœ‰å˜ä½“ï¼šæŒ‰äº§å“åç§°åˆ†ç»„
        const grouped = {};
        products.forEach(item => {
          const key = item.productName;
          if (!grouped[key]) {
            grouped[key] = {
              productName: item.productName,
              brand: item.brand,
              category: item.category,
              variants: []
            };
          }
          
          // æ”¶é›†å˜ä½“ä¿¡æ¯
          const variantKey = `${item.model || 'NO_MODEL'}|${item.color || 'NO_COLOR'}`;
          let variant = grouped[key].variants.find(v => v.key === variantKey);
          
          if (!variant) {
            variant = {
              key: variantKey,
              model: item.model || '',
              color: item.color || '',
              retailPrice: item.retailPrice,
              wholesalePrice: item.wholesalePrice,
              taxClassification: item.taxClassification,
              quantity: 0,
              items: []
            };
            grouped[key].variants.push(variant);
          }
          
          variant.quantity += (item.quantity || 1);
          variant.items.push(item);
        });
        
        // ç”Ÿæˆç½‘æ ¼å¸ƒå±€
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">';
        
        Object.values(grouped).forEach(group => {
          // æ”¶é›†æ‰€æœ‰å‹å·å’Œé¢œè‰²
          const models = [...new Set(group.variants.map(v => v.model).filter(m => m))];
          const colors = [...new Set(group.variants.map(v => v.color).filter(c => c))];
          
          html += `
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
              onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
              
              <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #1f2937;">${group.productName}</h3>
              
              ${group.brand ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">å“ç‰Œ: ${group.brand}</div>` : ''}
              
              <!-- å˜ä½“ä¿¡æ¯æ¡† -->
              <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
                <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 8px;">ğŸ“± å¯é€‰å˜ä½“</div>
                ${models.length > 0 ? `
                  <div style="font-size: 12px; color: #1e40af; margin-bottom: 4px;">
                    <strong>å‹å·:</strong> ${models.join(', ')}
                  </div>
                ` : ''}
                ${colors.length > 0 ? `
                  <div style="font-size: 12px; color: #1e40af;">
                    <strong>é¢œè‰²:</strong> ${colors.join(', ')}
                  </div>
                ` : ''}
              </div>
              
              <!-- åº“å­˜å’Œä»·æ ¼ä¿¡æ¯ -->
              <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px; color: #6b7280;">æ€»åº“å­˜</span>
                  <span style="font-size: 16px; font-weight: 600; color: #10b981;">${group.variants.reduce((sum, v) => sum + v.quantity, 0)} ä»¶</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="font-size: 13px; color: #6b7280;">ä»·æ ¼èŒƒå›´</span>
                  <span style="font-size: 14px; font-weight: 600; color: #3b82f6;">â‚¬${Math.min(...group.variants.map(v => v.wholesalePrice)).toFixed(2)} - â‚¬${Math.max(...group.variants.map(v => v.wholesalePrice)).toFixed(2)}</span>
                </div>
              </div>
              
              <button class="btn-sm btn-primary" onclick='showVariantSelectionModal(${JSON.stringify({
                productName: group.productName,
                brand: group.brand,
                variants: group.variants
              }).replace(/'/g, "\\'")})'
                style="width: 100%; padding: 10px; font-size: 14px;">
                ğŸ¨ é€‰æ‹©å‹å·å’Œé¢œè‰²
              </button>
              
              <div style="font-size: 11px; color: #9ca3af; text-align: center; margin-top: 10px;">
                ${group.variants.length} ä¸ªå˜ä½“å¯é€‰
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
      } else {
        // æ— å˜ä½“ï¼šæŒ‰äº§å“åç§°åˆ†ç»„ï¼Œä½¿ç”¨ç½‘æ ¼å¸ƒå±€
        const grouped = {};
        products.forEach(item => {
          const key = item.productName;
          if (!grouped[key]) {
            grouped[key] = {
              productName: item.productName,
              brand: item.brand,
              category: item.category,
              retailPrice: item.retailPrice,
              wholesalePrice: item.wholesalePrice,
              taxClassification: item.taxClassification,
              quantity: 0,
              items: []
            };
          }
          grouped[key].quantity += (item.quantity || 1);
          grouped[key].items.push(item);
        });
        
        // ç”Ÿæˆç½‘æ ¼å¸ƒå±€
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
        
        Object.values(grouped).forEach(group => {
          html += `
            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
              onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">
              
              <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #1f2937;">${group.productName}</h3>
              
              ${group.brand ? `<div style="font-size: 14px; color: #6b7280; margin-bottom: 10px;">å“ç‰Œ: ${group.brand}</div>` : ''}
              
              <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px; color: #6b7280;">åº“å­˜</span>
                  <span style="font-size: 16px; font-weight: 600; color: #10b981;">${group.quantity} ä»¶</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span style="font-size: 13px; color: #6b7280;">æ‰¹å‘ä»·</span>
                  <span style="font-size: 14px; font-weight: 600; color: #3b82f6;">â‚¬${group.wholesalePrice.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="font-size: 13px; color: #6b7280;">é›¶å”®ä»·</span>
                  <span style="font-size: 14px; font-weight: 600; color: #6b7280;">â‚¬${group.retailPrice.toFixed(2)}</span>
                </div>
              </div>
              
              <div style="margin-bottom: 15px;">
                ${getTaxBadge(group.taxClassification)}
              </div>
              
              <button class="btn-sm btn-primary" onclick='addAccessoryToTransferCart(${JSON.stringify({
                ...group.items[0],
                quantity: group.quantity,
                allItems: group.items
              }).replace(/'/g, "\\'")})'
                style="width: 100%; padding: 10px; font-size: 14px;">
                ğŸ›’ åŠ å…¥è°ƒè´§æ¸…å•
              </button>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
      }
    }
    
    // æ˜¾ç¤ºå˜ä½“é€‰æ‹©æ¨¡æ€æ¡†
    function showVariantSelectionModal(data) {
      const modal = document.getElementById('groupVariantModal');
      const content = document.getElementById('groupVariantModalContent');
      
      let html = `
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
          <h4 style="margin: 0 0 10px 0; color: #1e40af;">${data.productName}</h4>
          ${data.brand ? `<div style="font-size: 14px; color: #0c4a6e;">å“ç‰Œ: ${data.brand}</div>` : ''}
        </div>
        
        <div style="display: grid; gap: 12px;">
      `;
      
      data.variants.forEach((variant, index) => {
        html += `
          <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s;"
            onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff';"
            onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f9fafb';"
            onclick='selectGroupVariant(${JSON.stringify({
              ...variant,
              productName: data.productName,
              brand: data.brand
            }).replace(/'/g, "\\'")})'
          >
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div>
                <div style="font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                  ${variant.model || 'é»˜è®¤å‹å·'} - ${variant.color || 'é»˜è®¤é¢œè‰²'}
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  åº“å­˜: <strong style="color: #10b981;">${variant.quantity}</strong> ä»¶
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: #6b7280;">æ‰¹å‘ä»·</div>
                <div style="font-size: 16px; font-weight: 600; color: #3b82f6;">â‚¬${variant.wholesalePrice.toFixed(2)}</div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 12px; color: #6b7280;">
                é›¶å”®ä»·: â‚¬${variant.retailPrice.toFixed(2)}
              </div>
              <div style="font-size: 12px;">
                ${getTaxBadge(variant.taxClassification)}
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      content.innerHTML = html;
      modal.style.display = 'flex';
    }
    
    // å…³é—­å˜ä½“é€‰æ‹©æ¨¡æ€æ¡†
    function closeGroupVariantModal() {
      document.getElementById('groupVariantModal').style.display = 'none';
    }
    
    // é€‰æ‹©ç¾¤ç»„å˜ä½“
    function selectGroupVariant(variant) {
      // å…³é—­æ¨¡æ€æ¡†
      closeGroupVariantModal();
      
      // æ·»åŠ åˆ°è°ƒè´§æ¸…å•
      if (variant.items && variant.items.length > 0) {
        // å¦‚æœæœ‰å…·ä½“çš„è®¾å¤‡åˆ—è¡¨
        const firstItem = variant.items[0];
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è®¾å¤‡ï¼ˆæœ‰åºåˆ—å·æˆ–IMEIï¼‰
        if (firstItem.serialNumber || firstItem.imei) {
          // è®¾å¤‡ï¼šæ·»åŠ ç¬¬ä¸€ä¸ª
          addDeviceToTransferCart(firstItem);
        } else {
          // é…ä»¶ï¼šå¯ä»¥é€‰æ‹©æ•°é‡
          // ä¼ é€’å˜ä½“çš„æ€»æ•°é‡ï¼Œè€Œä¸æ˜¯å•ä¸ªitemçš„æ•°é‡
          const itemWithTotalQty = {
            ...firstItem,
            quantity: variant.quantity, // ä½¿ç”¨å˜ä½“çš„æ€»æ•°é‡
            allItems: variant.items // ä¿å­˜æ‰€æœ‰åº“å­˜è®°å½•
          };
          addAccessoryToTransferCart(itemWithTotalQty);
        }
      } else {
        alert('è¯¥å˜ä½“æš‚æ— å¯ç”¨åº“å­˜');
      }
    }
    
    // é€‰æ‹©å˜ä½“è¿›è¡Œè°ƒè´§ï¼ˆä¿ç•™æ—§å‡½æ•°ä»¥å…¼å®¹ï¼‰
    function selectVariantForTransfer(data) {
      if (data.selectedVariant.items.length > 0) {
        addDeviceToTransferCart(data.selectedVariant.items[0]);
      }
    }
    
    // åˆ‡æ¢åºåˆ—å·æ˜¾ç¤º
    function toggleGroupSerialNumbers(rowIndex) {
      const serialRow = document.getElementById(`serial-row-${rowIndex}`);
      const icon = document.getElementById(`toggle-icon-${rowIndex}`);
      
      if (serialRow.style.display === 'none') {
        serialRow.style.display = 'table-row';
        icon.textContent = 'â–¼';
      } else {
        serialRow.style.display = 'none';
        icon.textContent = 'â–¶';
      }
    }
    
    // æœç´¢ç¾¤ç»„åº“å­˜
    function searchGroupInventory() {
      const searchTerm = document.getElementById('groupInventorySearchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#groupInventoryTable tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    }
    
    // ==================== è°ƒè´§ç®¡ç†åŠŸèƒ½ ====================
    
    // åŠ è½½è°ƒè´§ç®¡ç†
    async function loadTransferManagement() {
      // åŠ è½½æ‰€æœ‰æ ‡ç­¾çš„æ•°é‡
      await loadAllTransferCounts();
      
      // é»˜è®¤åŠ è½½å¾…å®¡æ‰¹åˆ—è¡¨
      switchTransferTab('pending-approval');
    }
    
    // åŠ è½½æ‰€æœ‰æ ‡ç­¾çš„æ•°é‡
    async function loadAllTransferCounts() {
      try {
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°é‡
        const [pendingRes, approvedRes, myRequestsRes, completedRes] = await Promise.all([
          fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&status=pending`),
          fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&type=received&status=approved`),
          fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&type=received`),
          fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&status=completed`)
        ]);
        
        const [pending, approved, myRequests, completed] = await Promise.all([
          pendingRes.json(),
          approvedRes.json(),
          myRequestsRes.json(),
          completedRes.json()
        ]);
        
        // æ›´æ–°å¾½ç« æ•°å­—
        if (pending.success) {
          document.getElementById('badge-pending-approval').textContent = pending.data.length;
        }
        if (approved.success) {
          document.getElementById('badge-pending-receive').textContent = approved.data.length;
        }
        if (myRequests.success) {
          const activeRequests = myRequests.data.filter(t => t.status !== 'completed');
          document.getElementById('badge-my-requests').textContent = activeRequests.length;
        }
        if (completed.success) {
          document.getElementById('badge-completed').textContent = completed.data.length;
        }
      } catch (error) {
        console.error('åŠ è½½è°ƒè´§æ•°é‡å¤±è´¥:', error);
      }
    }
    
    // åˆ‡æ¢è°ƒè´§ç®¡ç†å­æ ‡ç­¾
    function switchTransferTab(tabName) {
      // ç§»é™¤æ‰€æœ‰activeç±»
      document.querySelectorAll('.transfer-sub-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.transfer-sub-content').forEach(content => content.classList.remove('active'));
      
      // æ·»åŠ activeç±»
      document.getElementById(`tab-${tabName}`).classList.add('active');
      document.getElementById(`transfer-${tabName}`).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'pending-approval':
          loadPendingApprovalList();
          break;
        case 'pending-receive':
          loadPendingReceiveList();
          break;
        case 'my-requests':
          loadMyRequestsList();
          break;
        case 'completed':
          loadCompletedList();
          break;
      }
    }
    
    // åŠ è½½å¾…å®¡æ‰¹åˆ—è¡¨
    async function loadPendingApprovalList() {
      const container = document.getElementById('pendingApprovalList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        // è·å–æ‰€æœ‰å¾…å®¡æ‰¹çš„è°ƒè´§è®°å½•ï¼ˆä¸é™åˆ¶ typeï¼ŒåŒæ–¹éƒ½èƒ½çœ‹åˆ°ï¼‰
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&status=pending`);
        const result = await response.json();
        
        if (result.success) {
          const transfers = result.data;
          document.getElementById('badge-pending-approval').textContent = transfers.length;
          
          if (transfers.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¾…å®¡æ‰¹çš„è°ƒè´§ç”³è¯·</p>';
            return;
          }
          
          const html = transfers.map(transfer => renderTransferCard(transfer, 'approval')).join('');
          container.innerHTML = html;
        } else {
          container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½å¾…å®¡æ‰¹åˆ—è¡¨å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // åŠ è½½å¾…æ”¶è´§åˆ—è¡¨
    async function loadPendingReceiveList() {
      const container = document.getElementById('pendingReceiveList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&type=received&status=approved`);
        const result = await response.json();
        
        if (result.success) {
          const transfers = result.data;
          document.getElementById('badge-pending-receive').textContent = transfers.length;
          
          if (transfers.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å¾…æ”¶è´§çš„è°ƒè´§</p>';
            return;
          }
          
          const html = transfers.map(transfer => renderTransferCard(transfer, 'receive')).join('');
          container.innerHTML = html;
        } else {
          container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½å¾…æ”¶è´§åˆ—è¡¨å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // åŠ è½½æˆ‘å‘èµ·çš„åˆ—è¡¨
    async function loadMyRequestsList() {
      const container = document.getElementById('myRequestsList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        // è°ƒè´§æ˜¯ç”±è°ƒå…¥æ–¹å‘èµ·çš„ï¼Œæ‰€ä»¥æŸ¥è¯¢ toMerchant = å½“å‰ç”¨æˆ·
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&type=received`);
        const result = await response.json();
        
        if (result.success) {
          const transfers = result.data.filter(t => t.status !== 'completed');
          document.getElementById('badge-my-requests').textContent = transfers.length;
          
          if (transfers.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— è¿›è¡Œä¸­çš„è°ƒè´§ç”³è¯·</p>';
            return;
          }
          
          const html = transfers.map(transfer => renderTransferCard(transfer, 'sent')).join('');
          container.innerHTML = html;
        } else {
          container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½æˆ‘å‘èµ·çš„åˆ—è¡¨å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // åŠ è½½å·²å®Œæˆåˆ—è¡¨
    async function loadCompletedList() {
      const container = document.getElementById('completedList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}&status=completed`);
        const result = await response.json();
        
        if (result.success) {
          const transfers = result.data;
          document.getElementById('badge-completed').textContent = transfers.length;
          
          if (transfers.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å·²å®Œæˆçš„è°ƒè´§è®°å½•</p>';
            return;
          }
          
          const html = transfers.map(transfer => renderTransferCard(transfer, 'completed')).join('');
          container.innerHTML = html;
        } else {
          container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½å·²å®Œæˆåˆ—è¡¨å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ¸²æŸ“è°ƒè´§å¡ç‰‡
    function renderTransferCard(transfer, type) {
      const isInternalTransfer = transfer.transferType === 'INTERNAL_TRANSFER';
      const typeIcon = isInternalTransfer ? 'ğŸ“¦' : 'ğŸ’°';
      const typeColor = isInternalTransfer ? '#3b82f6' : '#10b981';
      const typeName = isInternalTransfer ? 'å†…éƒ¨è°ƒæ‹¨' : 'å…¬å¸é—´é”€å”®';
      
      // çŠ¶æ€æ˜¾ç¤º
      let statusBadge = '';
      switch(transfer.status) {
        case 'pending':
          statusBadge = '<span class="badge badge-warning">å¾…å®¡æ‰¹</span>';
          break;
        case 'approved':
          statusBadge = '<span class="badge badge-info">å·²æ‰¹å‡†</span>';
          break;
        case 'rejected':
          statusBadge = '<span class="badge" style="background: #fee2e2; color: #dc2626;">å·²æ‹’ç»</span>';
          break;
        case 'completed':
          statusBadge = '<span class="badge badge-success">å·²å®Œæˆ</span>';
          break;
      }
      
      // æ“ä½œæŒ‰é’®
      let actionButtons = '';
      if (type === 'approval') {
        // åªæœ‰è°ƒå‡ºæ–¹å¯ä»¥æ‰¹å‡†æˆ–æ‹’ç»
        const isFromMerchant = transfer.fromMerchant === merchantId;
        if (isFromMerchant) {
          actionButtons = `
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button onclick="approveTransfer('${transfer._id}')" style="flex: 1; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                âœ… æ‰¹å‡†
              </button>
              <button onclick="rejectTransfer('${transfer._id}')" style="flex: 1; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                âŒ æ‹’ç»
              </button>
            </div>
          `;
        } else {
          // è°ƒå…¥æ–¹åªèƒ½æŸ¥çœ‹ï¼Œæ˜¾ç¤ºç­‰å¾…å®¡æ‰¹æç¤º
          actionButtons = `
            <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-radius: 6px; text-align: center; color: #92400e;">
              â³ ç­‰å¾…è°ƒå‡ºæ–¹å®¡æ‰¹
            </div>
          `;
        }
      } else if (type === 'receive') {
        actionButtons = `
          <div style="margin-top: 15px;">
            <button onclick="confirmReceiveTransfer('${transfer._id}')" style="width: 100%; padding: 10px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              ğŸ“¦ ç¡®è®¤æ”¶è´§
            </button>
          </div>
        `;
      }
      
      return `
        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
          <!-- å¤´éƒ¨ä¿¡æ¯ -->
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
            <div>
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <span style="font-size: 18px; font-weight: 600; color: #111827;">${transfer.transferNumber}</span>
                ${statusBadge}
                <span style="padding: 4px 8px; background: ${typeColor}15; color: ${typeColor}; border-radius: 4px; font-size: 12px; font-weight: 600;">
                  ${typeIcon} ${typeName}
                </span>
              </div>
              <div style="font-size: 13px; color: #6b7280;">
                ${new Date(transfer.createdAt).toLocaleString('zh-CN')}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 24px; font-weight: 700; color: ${typeColor};">
                â‚¬${transfer.totalAmount.toFixed(2)}
              </div>
            </div>
          </div>
          
          <!-- åŒæ–¹ä¿¡æ¯ -->
          <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; margin-bottom: 15px; background: #f9fafb; padding: 15px; border-radius: 8px;">
            <div>
              <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">è°ƒå‡ºæ–¹</div>
              <div style="font-weight: 600; color: #111827;">${transfer.fromMerchant}</div>
              ${transfer.fromCompany?.companyName ? `<div style="font-size: 12px; color: #6b7280;">${transfer.fromCompany.companyName}</div>` : ''}
            </div>
            <div style="display: flex; align-items: center; color: #9ca3af;">
              â†’
            </div>
            <div>
              <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">è°ƒå…¥æ–¹</div>
              <div style="font-weight: 600; color: #111827;">${transfer.toMerchant}</div>
              ${transfer.toCompany?.companyName ? `<div style="font-size: 12px; color: #6b7280;">${transfer.toCompany.companyName}</div>` : ''}
            </div>
          </div>
          
          <!-- äº§å“åˆ—è¡¨ -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: #374151;">äº§å“æ¸…å•</div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead style="background: #f9fafb; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">äº§å“åç§°</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb;">å˜ä½“</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb;">åºåˆ—å·/IMEI</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb;">æˆè‰²</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 1px solid #e5e7eb;">æ•°é‡</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb;">å•ä»·</th>
                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #e5e7eb;">å°è®¡</th>
                  </tr>
                </thead>
                <tbody>
                  ${(() => {
                    // åˆå¹¶ç›¸åŒäº§å“
                    const grouped = {};
                    transfer.items.forEach(item => {
                      const key = item.productName + '|' + (item.model || '') + '|' + (item.color || '') + '|' + item.transferPrice;
                      if (!grouped[key]) {
                        grouped[key] = {
                          productName: item.productName,
                          model: item.model,
                          color: item.color,
                          condition: item.condition,
                          transferPrice: item.transferPrice,
                          quantity: 0,
                          serialNumbers: []
                        };
                      }
                      grouped[key].quantity += item.quantity;
                      if (item.serialNumber) {
                        grouped[key].serialNumbers.push(item.serialNumber);
                      }
                    });
                    
                    return Object.values(grouped).map(item => {
                      // æ„å»ºå˜ä½“æ˜¾ç¤º
                      let variantDisplay = '';
                      if (item.model || item.color) {
                        const parts = [];
                        if (item.model && item.model !== 'NO_MODEL') parts.push(item.model);
                        if (item.color && item.color !== 'NO_COLOR') parts.push(item.color);
                        variantDisplay = parts.join(' - ');
                      }
                      
                      // åºåˆ—å·æ˜¾ç¤º
                      let serialDisplay = '-';
                      if (item.serialNumbers.length > 0) {
                        if (item.serialNumbers.length === 1) {
                          serialDisplay = item.serialNumbers[0];
                        } else {
                          serialDisplay = item.serialNumbers.length + ' ä¸ª';
                        }
                      }
                      
                      return '<tr>' +
                        '<td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">' + item.productName + '</td>' +
                        '<td style="padding: 8px; text-align: center; border-bottom: 1px solid #f3f4f6;">' +
                          (variantDisplay ? '<span style="background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: 600;">' + variantDisplay + '</span>' : '-') +
                        '</td>' +
                        '<td style="padding: 8px; text-align: center; font-family: monospace; font-size: 11px; border-bottom: 1px solid #f3f4f6;">' + serialDisplay + '</td>' +
                        '<td style="padding: 8px; text-align: center; border-bottom: 1px solid #f3f4f6;">' + (item.condition || '-') + '</td>' +
                        '<td style="padding: 8px; text-align: center; border-bottom: 1px solid #f3f4f6;">' + item.quantity + '</td>' +
                        '<td style="padding: 8px; text-align: right; font-weight: 600; border-bottom: 1px solid #f3f4f6;">â‚¬' + item.transferPrice.toFixed(2) + '</td>' +
                        '<td style="padding: 8px; text-align: right; font-weight: 600; border-bottom: 1px solid #f3f4f6;">â‚¬' + (item.transferPrice * item.quantity).toFixed(2) + '</td>' +
                      '</tr>';
                    }).join('');
                  })()}
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- å¤‡æ³¨ -->
          ${transfer.notes ? `
            <div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
              <div style="font-size: 12px; color: #1e40af; font-weight: 600; margin-bottom: 3px;">å¤‡æ³¨</div>
              <div style="font-size: 13px; color: #1e40af;">${transfer.notes}</div>
            </div>
          ` : ''}
          
          <!-- æ‹’ç»åŸå›  -->
          ${transfer.status === 'rejected' && transfer.rejectionReason ? `
            <div style="background: #fee2e2; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #dc2626;">
              <div style="font-size: 12px; color: #dc2626; font-weight: 600; margin-bottom: 3px;">æ‹’ç»åŸå› </div>
              <div style="font-size: 13px; color: #dc2626;">${transfer.rejectionReason}</div>
            </div>
          ` : ''}
          
          ${actionButtons}
        </div>
      `;
    }
    
    // æ‰¹å‡†è°ƒè´§
    async function approveTransfer(transferId) {
      const notes = prompt('æ‰¹å‡†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:');
      if (notes === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/approve`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            transferId: transferId,
            action: 'approve',
            notes: notes,
            merchantId: merchantId
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å·²æ‰¹å‡†è°ƒè´§ç”³è¯·');
          loadPendingApprovalList();
        } else {
          alert('æ‰¹å‡†å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('æ‰¹å‡†è°ƒè´§å¤±è´¥:', error);
        alert('æ‰¹å‡†å¤±è´¥: ' + error.message);
      }
    }
    
    // æ‹’ç»è°ƒè´§
    async function rejectTransfer(transferId) {
      const reason = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› :');
      if (!reason) {
        alert('è¯·è¾“å…¥æ‹’ç»åŸå› ');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/approve`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            transferId: transferId,
            action: 'reject',
            notes: reason,
            merchantId: merchantId
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âŒ å·²æ‹’ç»è°ƒè´§ç”³è¯·');
          loadPendingApprovalList();
        } else {
          alert('æ‹’ç»å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('æ‹’ç»è°ƒè´§å¤±è´¥:', error);
        alert('æ‹’ç»å¤±è´¥: ' + error.message);
      }
    }
    
    // ç¡®è®¤æ”¶è´§
    async function confirmReceiveTransfer(transferId) {
      try {
        // å…ˆè·å–è°ƒè´§ä¿¡æ¯
        const listResponse = await fetch(`${API_BASE}/merchant/inventory/transfer/list?merchantId=${merchantId}`);
        const listResult = await listResponse.json();
        
        if (!listResult.success) {
          alert('è·å–è°ƒè´§ä¿¡æ¯å¤±è´¥');
          return;
        }
        
        const transfer = listResult.data.find(t => t._id === transferId);
        if (!transfer) {
          alert('è°ƒè´§è®°å½•ä¸å­˜åœ¨');
          return;
        }
        
        // å¦‚æœæ˜¯å…¬å¸é—´é”€å”®ï¼Œæ˜¾ç¤ºä»·æ ¼è®¾ç½®å¯¹è¯æ¡†
        if (transfer.transferType === 'INTER_COMPANY_SALE') {
          showPriceSettingDialog(transfer);
        } else {
          // å†…éƒ¨è°ƒæ‹¨ï¼Œç›´æ¥ç¡®è®¤æ”¶è´§
          if (!confirm('ç¡®è®¤æ”¶åˆ°è´§ç‰©å—ï¼Ÿ\n\nè¿™æ˜¯å†…éƒ¨è°ƒæ‹¨ï¼Œå°†ç»§æ‰¿åŸäº§å“çš„æ‰€æœ‰ä»·æ ¼ã€‚\n\nç¡®è®¤åå°†æ›´æ–°åº“å­˜ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
          }
          
          await completeTransfer(transferId, null);
        }
      } catch (error) {
        console.error('ç¡®è®¤æ”¶è´§å¤±è´¥:', error);
        alert('ç¡®è®¤æ”¶è´§å¤±è´¥: ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºä»·æ ¼è®¾ç½®å¯¹è¯æ¡†ï¼ˆå…¬å¸é—´é”€å”®ï¼‰
    function showPriceSettingDialog(transfer) {
      const modal = document.createElement('div');
      modal.id = 'priceSettingModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      
      // ä¸ºæ¯ä¸ªäº§å“ç”Ÿæˆä»·æ ¼è¾“å…¥è¡¨å•
      const priceInputs = transfer.items.map((item, index) => `
        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #6366f1;">
          <div style="font-weight: 600; margin-bottom: 10px; color: #111827;">${item.productName}</div>
          <div style="font-size: 13px; color: #6b7280; margin-bottom: 10px;">
            ${item.serialNumber ? `åºåˆ—å·: ${item.serialNumber}` : `æ•°é‡: ${item.quantity}`}
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #374151;">æ‰¹å‘ä»· (â‚¬) *</label>
              <input type="number" id="wholesalePrice_${index}" min="0" step="0.01" required
                     style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            </div>
            <div>
              <label style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #374151;">é›¶å”®ä»· (â‚¬) *</label>
              <input type="number" id="retailPrice_${index}" min="0" step="0.01" required
                     value="${item.retailPrice || ''}"
                     style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
              <small style="color: #6b7280; font-size: 11px;">é»˜è®¤ä¸ºåŸäº§å“é›¶å”®ä»·</small>
            </div>
          </div>
        </div>
      `).join('');
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
          <h2 style="margin: 0 0 10px 0; color: #111827;">ğŸ’° è®¾ç½®äº§å“ä»·æ ¼</h2>
          <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
            è¿™æ˜¯å…¬å¸é—´é”€å”®ï¼Œè¯·ä¸ºæ¯ä¸ªäº§å“è®¾ç½®æ‰¹å‘ä»·å’Œé›¶å”®ä»·ã€‚<br>
            <strong>æˆæœ¬ä»·</strong>å°†è‡ªåŠ¨è®¾ç½®ä¸ºåŸäº§å“çš„æ‰¹å‘ä»·ã€‚
          </p>
          
          <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
            <div style="font-size: 13px; color: #1e40af; margin-bottom: 5px;">
              <strong>ä»·æ ¼è¯´æ˜ï¼š</strong>
            </div>
            <div style="font-size: 12px; color: #1e40af;">
              â€¢ æˆæœ¬ä»· = åŸäº§å“çš„æ‰¹å‘ä»·ï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰<br>
              â€¢ æ‰¹å‘ä»· = æ‚¨è®¾ç½®çš„æ‰¹å‘ä»·ï¼ˆå¿…å¡«ï¼‰<br>
              â€¢ é›¶å”®ä»· = æ‚¨è®¾ç½®çš„é›¶å”®ä»·ï¼ˆé»˜è®¤ä¸ºåŸäº§å“é›¶å”®ä»·ï¼‰
            </div>
          </div>
          
          <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
            ${priceInputs}
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="closePriceSettingDialog()" style="flex: 1; padding: 12px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">
              å–æ¶ˆ
            </button>
            <button onclick="submitPriceSettings('${transfer._id}', ${transfer.items.length})" style="flex: 1; padding: 12px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 15px;">
              âœ… ç¡®è®¤æ”¶è´§
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // å…³é—­ä»·æ ¼è®¾ç½®å¯¹è¯æ¡†
    function closePriceSettingDialog() {
      const modal = document.getElementById('priceSettingModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // æäº¤ä»·æ ¼è®¾ç½®å¹¶å®Œæˆè°ƒè´§
    async function submitPriceSettings(transferId, itemCount) {
      const customPrices = [];
      
      // æ”¶é›†æ‰€æœ‰äº§å“çš„ä»·æ ¼
      for (let i = 0; i < itemCount; i++) {
        const wholesalePrice = document.getElementById(`wholesalePrice_${i}`).value;
        const retailPrice = document.getElementById(`retailPrice_${i}`).value;
        
        if (!wholesalePrice || !retailPrice) {
          alert(`è¯·å¡«å†™æ‰€æœ‰äº§å“çš„æ‰¹å‘ä»·å’Œé›¶å”®ä»·`);
          return;
        }
        
        customPrices.push({
          wholesalePrice: parseFloat(wholesalePrice),
          retailPrice: parseFloat(retailPrice)
        });
      }
      
      closePriceSettingDialog();
      
      await completeTransfer(transferId, customPrices);
    }
    
    // å®Œæˆè°ƒè´§ï¼ˆå®é™…APIè°ƒç”¨ï¼‰
    async function completeTransfer(transferId, customPrices) {
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            transferId: transferId,
            merchantId: merchantId,
            customPrices: customPrices
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… å·²ç¡®è®¤æ”¶è´§ï¼Œåº“å­˜å·²æ›´æ–°');
          loadPendingReceiveList();
          // åˆ·æ–°ç»Ÿè®¡æ•°æ®
          loadStats();
        } else {
          alert('ç¡®è®¤æ”¶è´§å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('ç¡®è®¤æ”¶è´§å¤±è´¥:', error);
        alert('ç¡®è®¤æ”¶è´§å¤±è´¥: ' + error.message);
      }
    }
    
    // ==================== ä»“åº“è®¢è´§åŠŸèƒ½ ====================
    
    // æ ¹æ®åˆ†ç±»åç§°è·å–å¯¹åº”å›¾æ ‡ï¼ˆå…¨å±€å‡½æ•°ï¼‰
    function getCategoryIcon(categoryName) {
      const name = categoryName.toLowerCase();
      
      // æ‰‹æœºç›¸å…³
      if (name.includes('phone') || name.includes('æ‰‹æœº') || name.includes('iphone') || name.includes('samsung') || name.includes('galaxy')) {
        return 'ğŸ“±';
      }
      // å¹³æ¿ç›¸å…³
      if (name.includes('tablet') || name.includes('ipad') || name.includes('å¹³æ¿')) {
        return 'ğŸ“²';
      }
      // ç”µè„‘ç›¸å…³
      if (name.includes('laptop') || name.includes('computer') || name.includes('macbook') || name.includes('ç”µè„‘') || name.includes('ç¬”è®°æœ¬')) {
        return 'ğŸ’»';
      }
      // æ‰‹è¡¨ç›¸å…³
      if (name.includes('watch') || name.includes('æ‰‹è¡¨')) {
        return 'âŒš';
      }
      // è€³æœºç›¸å…³
      if (name.includes('airpod') || name.includes('earphone') || name.includes('headphone') || name.includes('è€³æœº')) {
        return 'ğŸ§';
      }
      // å±å¹•ä¿æŠ¤è†œ
      if (name.includes('screen') || name.includes('protector') || name.includes('å±å¹•') || name.includes('è†œ')) {
        return 'ğŸ›¡ï¸';
      }
      // æ‰‹æœºå£³
      if (name.includes('case') || name.includes('cover') || name.includes('å£³') || name.includes('å¥—')) {
        return 'ğŸ“¦';
      }
      // å……ç”µå™¨/ç”µæº
      if (name.includes('charger') || name.includes('adapter') || name.includes('power') || name.includes('å……ç”µ')) {
        return 'ğŸ”Œ';
      }
      // æ•°æ®çº¿
      if (name.includes('cable') || name.includes('çº¿')) {
        return 'ğŸ”—';
      }
      // ç”µæ± 
      if (name.includes('battery') || name.includes('ç”µæ± ')) {
        return 'ğŸ”‹';
      }
      // é…ä»¶
      if (name.includes('accessory') || name.includes('accessories') || name.includes('é…ä»¶')) {
        return 'ğŸ';
      }
      // é»˜è®¤å›¾æ ‡
      return 'ğŸ“¦';
    }
    
    // åŠ è½½ä»“åº“äº§å“ï¼ˆåˆ†ç±»è§†å›¾ï¼‰
    async function loadWarehouseProducts() {
      const container = document.getElementById('warehouseCategoryList');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        console.log('ğŸ” å¼€å§‹åŠ è½½ä»“åº“äº§å“...');
        const url = `${API_BASE}/merchant/warehouse-products`;
        console.log('ğŸ“¡ è¯·æ±‚ URL:', url);
        
        const response = await fetch(url);
        console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);
        
        const result = await response.json();
        console.log('ğŸ“¦ API è¿”å›æ•°æ®:', result);
        console.log('ğŸ“Š äº§å“æ•°é‡:', result.data?.length);
        
        if (result.success && result.data.length > 0) {
          // åªä¿ç•™å¯é”€å”®çš„äº§å“ï¼ˆtotalAvailable > 0ï¼‰
          allWarehouseData = result.data.filter(group => group.totalAvailable > 0);
          console.log('âœ… å¯è®¢è´­äº§å“æ•°é‡:', allWarehouseData.length);
          
          if (allWarehouseData.length === 0) {
            container.innerHTML = `
              <p style="text-align: center; color: #999; padding: 40px;">
                ä»“åº“æš‚æ— å¯è®¢è´­äº§å“
              </p>
            `;
            return;
          }
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categoryMap = {};
          allWarehouseData.forEach(group => {
            const category = group.category || 'æœªåˆ†ç±»';
            if (!categoryMap[category]) {
              categoryMap[category] = [];
            }
            categoryMap[category].push(group);
          });
          
          console.log('ğŸ“‚ åˆ†ç±»:', Object.keys(categoryMap));
          
          // æ˜¾ç¤ºåˆ†ç±»å¡ç‰‡
          let html = `
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
          `;
          
          Object.keys(categoryMap).sort().forEach(category => {
            const groups = categoryMap[category];
            const totalProducts = groups.length;
            const totalQty = groups.reduce((sum, group) => sum + group.totalAvailable, 0);
            const categoryIcon = getCategoryIcon(category);
            
            html += `
              <div onclick="showWarehouseCategory('${category}')" 
                style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; padding: 30px; border-radius: 12px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 12px rgba(0,0,0,0.2)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
                <div style="font-size: 40px; margin-bottom: 10px;">${categoryIcon}</div>
                <h3 style="font-size: 18px; margin-bottom: 10px;">${category}</h3>
                <div style="font-size: 14px; opacity: 0.9;">
                  ${totalProducts} ç§äº§å“ Â· ${totalQty} ä»¶å¯è®¢
                </div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
          console.log('âœ… ä»“åº“äº§å“åŠ è½½å®Œæˆ');
        } else {
          console.log('âš ï¸ æ²¡æœ‰äº§å“æ•°æ®');
          container.innerHTML = `
            <p style="text-align: center; color: #999; padding: 40px;">
              ä»“åº“æš‚æ— å¯è®¢è´­äº§å“
            </p>
          `;
        }
      } catch (error) {
        console.error('âŒ åŠ è½½ä»“åº“äº§å“å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æ˜¾ç¤ºæŸä¸ªåˆ†ç±»çš„ä»“åº“äº§å“
    function showWarehouseCategory(category) {
      // åªåˆ‡æ¢å·¦ä¾§å†…å®¹ï¼Œè´­ç‰©è½¦ä¿æŒæ˜¾ç¤º
      document.getElementById('warehouseCategoryListView').style.display = 'none';
      document.getElementById('warehouseProductList').style.display = 'block';
      document.getElementById('currentWarehouseCategoryName').textContent = `ğŸ­ ${category}`;
      
      const products = allWarehouseData.filter(group => (group.category || 'æœªåˆ†ç±»') === category);
      displayWarehouseProducts(products);
    }
    
    // è¿”å›ä»“åº“åˆ†ç±»åˆ—è¡¨
    function backToWarehouseCategories() {
      // åªåˆ‡æ¢å·¦ä¾§å†…å®¹ï¼Œè´­ç‰©è½¦ä¿æŒæ˜¾ç¤º
      document.getElementById('warehouseCategoryListView').style.display = 'block';
      document.getElementById('warehouseProductList').style.display = 'none';
    }
    
    // æ˜¾ç¤ºä»“åº“äº§å“åˆ—è¡¨ï¼ˆå½’ç±»æ˜¾ç¤ºå˜ä½“äº§å“ï¼‰
    function displayWarehouseProducts(products) {
      const container = document.getElementById('warehouseProducts');
      
      if (products.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°äº§å“</p>';
        return;
      }
      
      // æŒ‰äº§å“åç§°å½’ç±»
      const groupedByProduct = {};
      
      console.log('ğŸ“Š å¼€å§‹åˆ†ç»„ï¼Œè¾“å…¥äº§å“æ•°é‡:', products.length);
      console.log('ğŸ“‹ ç¬¬ä¸€ä¸ªäº§å“ç»„çš„ç»“æ„:', products[0]);
      
      products.forEach((group, index) => {
        console.log(`\n--- å¤„ç†ç¬¬ ${index + 1} ä¸ªäº§å“ç»„ ---`);
        console.log('group.products æ•°é‡:', group.products?.length);
        console.log('group.products å†…å®¹:', group.products);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è®¾å¤‡ç±»å‹
        const isDevice = group.productType?.toLowerCase().includes('device');
        
        // ä» products æ•°ç»„ä¸­è·å–äº§å“åç§°
        const firstProduct = group.products[0];
        let rawName = firstProduct.name || `${group.brand || ''} ${group.model || ''}`.trim() || group.productType;
        
        console.log('ğŸ” åŸå§‹äº§å“åç§°:', rawName, '| æ˜¯å¦è®¾å¤‡:', isDevice);
        console.log('   firstProduct:', firstProduct);
        
        // è®¾å¤‡äº§å“ï¼šæå–çº¯äº§å“åç§°ï¼ˆå»æ‰å‹å·ã€å®¹é‡ç­‰ä¿¡æ¯ï¼‰
        // é…ä»¶äº§å“ï¼šæŒ‰äº§å“åç§°+å“ç‰Œåˆ†ç»„
        let productKey;
        if (isDevice) {
          // æå–è®¾å¤‡çš„åŸºç¡€åç§°ï¼ˆå»æ‰å®¹é‡ã€é¢œè‰²ç­‰ï¼‰
          // ä¾‹å¦‚ï¼šIPHONE15128GB -> IPHONE15, IPHONE15PROMAX256GB -> IPHONE15PROMAX
          // ç§»é™¤å¸¸è§çš„å®¹é‡æ ‡è¯†ï¼š16GB, 32GB, 64GB, 128GB, 256GB, 512GB, 1TB, 2TB
          productKey = rawName.replace(/\d+(GB|TB)/gi, '').trim();
          // å¦‚æœè¿˜æœ‰ç©ºæ ¼ï¼Œå»æ‰
          productKey = productKey.replace(/\s+/g, '');
          console.log('   âœ… è®¾å¤‡äº§å“ - æå–åçš„Key:', productKey);
        } else {
          // é…ä»¶äº§å“æŒ‰åç§°+å“ç‰Œåˆ†ç»„
          productKey = `${rawName}_${group.brand || ''}`;
          console.log('   âœ… é…ä»¶äº§å“ - Key:', productKey);
        }
        
        if (!groupedByProduct[productKey]) {
          groupedByProduct[productKey] = {
            displayName: productKey, // ä½¿ç”¨æå–åçš„çº¯äº§å“åç§°
            productType: group.productType,
            brand: group.brand,
            model: group.model,
            variants: []
          };
          console.log('   ğŸ†• åˆ›å»ºæ–°åˆ†ç»„:', productKey);
        } else {
          console.log('   â• æ·»åŠ åˆ°ç°æœ‰åˆ†ç»„:', productKey);
        }
        groupedByProduct[productKey].variants.push(group);
      });
      
      console.log('\nğŸ“¦ æœ€ç»ˆåˆ†ç»„ç»“æœ:', Object.keys(groupedByProduct).length, 'ä¸ªäº§å“ç»„');
      console.log('ğŸ“‹ åˆ†ç»„è¯¦æƒ…:', groupedByProduct);
      
      const html = `
        <table style="width: 100%; table-layout: auto;">
          <thead>
            <tr>
              <th style="min-width: 200px;">äº§å“åç§°</th>
              <th style="min-width: 100px; text-align: center;">å˜ä½“æ•°é‡</th>
              <th style="min-width: 100px; text-align: center;">æ€»åº“å­˜</th>
              <th style="min-width: 120px; text-align: right;">ä»·æ ¼èŒƒå›´</th>
              <th style="min-width: 100px; text-align: center;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(groupedByProduct).map((product, index) => {
              const totalQty = product.variants.reduce((sum, v) => sum + v.totalAvailable, 0);
              const prices = product.variants.map(v => v.wholesalePrice);
              const minPrice = Math.min(...prices);
              const maxPrice = Math.max(...prices);
              const priceRange = minPrice === maxPrice ? 
                `â‚¬${minPrice.toFixed(2)}` : 
                `â‚¬${minPrice.toFixed(2)} - â‚¬${maxPrice.toFixed(2)}`;
              
              return `
              <tr style="cursor: pointer; transition: background 0.2s;" 
                  onmouseover="this.style.background='#f8f9fa'" 
                  onmouseout="this.style.background='white'"
                  onclick="showProductVariants(${index})">
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 24px;">${getCategoryIcon(product.productType)}</div>
                    <div>
                      <strong style="font-size: 15px;">${product.displayName}</strong>
                      <div style="font-size: 12px; color: #6b7280;">${product.productType}</div>
                    </div>
                  </div>
                </td>
                <td style="text-align: center;">
                  <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                    ${product.variants.length} ä¸ªå˜ä½“
                  </span>
                </td>
                <td style="text-align: center;">
                  <strong style="color: #10b981; font-size: 16px;">${totalQty}</strong>
                </td>
                <td style="text-align: right; font-weight: 600; color: #059669;">
                  ${priceRange}
                </td>
                <td style="text-align: center;">
                  <button class="btn btn-primary" style="padding: 8px 16px; font-size: 14px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" 
                    onclick="event.stopPropagation(); showProductVariants(${index})">
                    ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…
                  </button>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
      container.innerHTML = html;
      
      // ä¿å­˜åˆ†ç»„æ•°æ®ä¾›è¯¦æƒ…é¡µä½¿ç”¨
      window.currentGroupedProducts = Object.values(groupedByProduct);
    }
    
    // æ˜¾ç¤ºäº§å“å˜ä½“è¯¦æƒ…
    function showProductVariants(productIndex) {
      const product = window.currentGroupedProducts[productIndex];
      if (!product) return;
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        max-width: 900px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      `;
      
      modalContent.innerHTML = `
        <div style="padding: 24px; border-bottom: 1px solid #e5e7eb;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 32px;">${getCategoryIcon(product.productType)}</div>
              <div>
                <h2 style="margin: 0; font-size: 24px; color: #111827;">${product.displayName}</h2>
                <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 14px;">${product.productType} Â· ${product.variants.length} ä¸ªå˜ä½“</p>
              </div>
            </div>
            <button onclick="this.closest('[style*=fixed]').remove()" 
              style="background: #f3f4f6; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; color: #6b7280; display: flex; align-items: center; justify-content: center;">
              âœ•
            </button>
          </div>
        </div>
        
        <div style="padding: 24px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #6b7280; font-weight: 600;">å‹å·/å°ºå¯¸</th>
                <th style="padding: 12px; text-align: left; font-size: 13px; color: #6b7280; font-weight: 600;">é¢œè‰²</th>
                <th style="padding: 12px; text-align: center; font-size: 13px; color: #6b7280; font-weight: 600;">æˆè‰²</th>
                <th style="padding: 12px; text-align: center; font-size: 13px; color: #6b7280; font-weight: 600;">åº“å­˜</th>
                <th style="padding: 12px; text-align: right; font-size: 13px; color: #6b7280; font-weight: 600;">æ‰¹å‘ä»·</th>
                <th style="padding: 12px; text-align: right; font-size: 13px; color: #6b7280; font-weight: 600;">é›¶å”®ä»·</th>
                <th style="padding: 12px; text-align: center; font-size: 13px; color: #6b7280; font-weight: 600;">ç¨åŠ¡</th>
                <th style="padding: 12px; text-align: center; font-size: 13px; color: #6b7280; font-weight: 600;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${product.variants.map(variant => {
                const displayName = `${product.displayName}${variant.model ? ' - ' + variant.model : ''}${variant.color ? ' - ' + variant.color : ''}`;
                return `
                <tr style="border-bottom: 1px solid #f3f4f6; transition: background 0.2s;" 
                    onmouseover="this.style.background='#f9fafb'" 
                    onmouseout="this.style.background='white'">
                  <td style="padding: 12px;">
                    <strong style="color: #111827;">${variant.model || '-'}</strong>
                  </td>
                  <td style="padding: 12px;">
                    ${variant.color ? `<span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">${variant.color}</span>` : '-'}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    ${getConditionBadge(variant.products[0]?.condition || 'New')}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    <strong style="color: #10b981; font-size: 15px;">${variant.totalAvailable}</strong>
                  </td>
                  <td style="padding: 12px; text-align: right; font-weight: 600; color: #059669;">
                    â‚¬${variant.wholesalePrice.toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: right; color: #6b7280;">
                    â‚¬${variant.suggestedRetailPrice.toFixed(2)}
                  </td>
                  <td style="padding: 12px; text-align: center; font-size: 12px;">
                    ${getTaxBadge(variant.taxClassification)}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    <button class="btn btn-primary" 
                      style="padding: 6px 14px; font-size: 13px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;" 
                      onclick="addToWarehouseCartFromModal('${variant.products[0]._id}', '${displayName.replace(/'/g, "\\'")}', ${variant.wholesalePrice}, ${variant.totalAvailable}); event.stopPropagation();">
                      ğŸ›’ åŠ å…¥è´­ç‰©è½¦
                    </button>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
          </table>
        </div>
        
        <div style="padding: 20px 24px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
          <div style="color: #6b7280; font-size: 14px;">
            æ€»è®¡: <strong style="color: #111827;">${product.variants.length}</strong> ä¸ªå˜ä½“ Â· 
            <strong style="color: #10b981;">${product.variants.reduce((sum, v) => sum + v.totalAvailable, 0)}</strong> ä»¶åº“å­˜
          </div>
          <button onclick="this.closest('[style*=fixed]').remove()" 
            style="padding: 10px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">
            å…³é—­
          </button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }
    
    // ä»æ¨¡æ€çª—å£æ·»åŠ åˆ°è´­ç‰©è½¦
    function addToWarehouseCartFromModal(productId, productName, price, maxQuantity) {
      const quantity = prompt(`è¯·è¾“å…¥è®¢è´­æ•°é‡ï¼ˆå¯ç”¨: ${maxQuantity}ï¼‰:`, '1');
      
      if (!quantity) return;
      
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      if (qty > maxQuantity) {
        alert(`è®¢è´­æ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨æ•°é‡ ${maxQuantity}`);
        return;
      }
      
      // æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²æœ‰è¯¥äº§å“
      const existingItem = warehouseCart.find(item => item.productId === productId);
      
      if (existingItem) {
        const newQty = existingItem.quantity + qty;
        if (newQty > maxQuantity) {
          alert(`è´­ç‰©è½¦ä¸­å·²æœ‰ ${existingItem.quantity} ä»¶ï¼Œæœ€å¤šå¯è®¢è´­ ${maxQuantity} ä»¶`);
          return;
        }
        existingItem.quantity = newQty;
      } else {
        warehouseCart.push({
          productId,
          productName,
          price,
          quantity: qty,
          maxQuantity
        });
      }
      
      updateWarehouseCart();
      alert(`å·²æ·»åŠ  ${qty} ä»¶åˆ°è´­ç‰©è½¦`);
    }
    
    // è·å–æˆè‰²å¾½ç« 
    function getConditionBadge(condition) {
      const badges = {
        'New': '<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">å…¨æ–°</span>',
        'Used': '<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">äºŒæ‰‹</span>',
        'Refurbished': '<span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">ç¿»æ–°</span>'
      };
      return badges[condition] || `<span style="background: #f3f4f6; color: #6b7280; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600;">${condition}</span>`;
    }
    
    // ä»è¡¨æ ¼æ·»åŠ åˆ°è´­ç‰©è½¦ï¼ˆä¿ç•™æ—§å‡½æ•°ä»¥é˜²å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰
    function addToWarehouseCartFromTable(productId, productName, price, maxQuantity) {
      const quantity = prompt(`è¯·è¾“å…¥è®¢è´­æ•°é‡ï¼ˆå¯ç”¨: ${maxQuantity}ï¼‰:`, '1');
      
      if (!quantity) return;
      
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      if (qty > maxQuantity) {
        alert(`è®¢è´­æ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨æ•°é‡ ${maxQuantity}`);
        return;
      }
      
      // æ£€æŸ¥è´­ç‰©è½¦ä¸­æ˜¯å¦å·²æœ‰è¯¥äº§å“
      const existingItem = warehouseCart.find(item => item.productId === productId);
      
      if (existingItem) {
        const newQty = existingItem.quantity + qty;
        if (newQty > maxQuantity) {
          alert(`è´­ç‰©è½¦ä¸­å·²æœ‰ ${existingItem.quantity} ä»¶ï¼Œæœ€å¤šå¯è®¢è´­ ${maxQuantity} ä»¶`);
          return;
        }
        existingItem.quantity = newQty;
      } else {
        warehouseCart.push({
          productId,
          productName,
          price,
          quantity: qty,
          maxQuantity
        });
      }
      
      updateWarehouseCart();
      alert(`å·²æ·»åŠ  ${qty} ä»¶ ${productName} åˆ°è´­ç‰©è½¦`);
    }

    // åŠ è½½é”€å”®è®°å½•
    async function loadSales() {
      const container = document.getElementById('salesTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>äº§å“</th>
                  <th>ç±»åˆ«</th>
                  <th>æ•°é‡</th>
                  <th>é”€å”®é¢</th>
                  <th>æˆæœ¬</th>
                  <th>ç¨é¢</th>
                  <th>æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.slice(0, 50).map(sale => `
                  <tr>
                    <td>${new Date(sale.date).toLocaleDateString('zh-CN')}</td>
                    <td>${sale.productName}</td>
                    <td>${getCategoryBadge(sale.category)}</td>
                    <td>${sale.quantity}</td>
                    <td>â‚¬${(sale.salePrice * sale.quantity).toFixed(2)}</td>
                    <td>â‚¬${(sale.costPrice * sale.quantity).toFixed(2)}</td>
                    <td>â‚¬${sale.taxAmount.toFixed(2)}</td>
                    <td>${getPaymentBadge(sale.paymentMethod)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${result.data.length > 50 ? `<p style="text-align: center; color: #666; margin-top: 10px;">æ˜¾ç¤ºæœ€è¿‘50æ¡è®°å½•ï¼Œå…±${result.data.length}æ¡</p>` : ''}
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— é”€å”®è®°å½•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½ç»´ä¿®è®°å½•
    async function loadRepairs() {
      const container = document.getElementById('repairsTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>å®¢æˆ·</th>
                  <th>ç»´ä¿®é¡¹ç›®</th>
                  <th>é‡‘é¢</th>
                  <th>ç¨é¢</th>
                  <th>æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.slice(0, 50).map(repair => `
                  <tr>
                    <td>${new Date(repair.date).toLocaleDateString('zh-CN')}</td>
                    <td>${repair.customerName}</td>
                    <td>${repair.repairItem}</td>
                    <td>â‚¬${repair.amount.toFixed(2)}</td>
                    <td>â‚¬${repair.taxAmount.toFixed(2)}</td>
                    <td>${getPaymentBadge(repair.paymentMethod)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${result.data.length > 50 ? `<p style="text-align: center; color: #666; margin-top: 10px;">æ˜¾ç¤ºæœ€è¿‘50æ¡è®°å½•ï¼Œå…±${result.data.length}æ¡</p>` : ''}
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— ç»´ä¿®è®°å½•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½æŠ¥è¡¨
    function loadReports() {
      document.getElementById('inventoryReport').innerHTML = `
        <p style="color: #999; text-align: center; padding: 20px;">åº“å­˜æŠ¥è¡¨åŠŸèƒ½å¼€å‘ä¸­...</p>
      `;
      document.getElementById('salesReport').innerHTML = `
        <p style="color: #999; text-align: center; padding: 20px;">é”€å”®æŠ¥è¡¨åŠŸèƒ½å¼€å‘ä¸­...</p>
      `;
    }

    // ç”Ÿæˆç¨åŠ¡æŠ¥è¡¨
    let currentTaxReportData = null; // å­˜å‚¨å½“å‰æŠ¥è¡¨æ•°æ®ç”¨äºPDFå¯¼å‡º
    
    async function generateTaxReport() {
      const startDate = document.getElementById('taxStartDate').value;
      const endDate = document.getElementById('taxEndDate').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
      }
      
      const container = document.getElementById('taxReportContent');
      container.innerHTML = '<div class="loading">ç”ŸæˆæŠ¥è¡¨ä¸­...</div>';
      document.getElementById('exportTaxPdfBtn').style.display = 'none';
      
      try {
        const response = await fetch(
          `${API_BASE}/merchant/tax-report?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`
        );
        const result = await response.json();
        
        if (result.success) {
          const data = result.data;
          currentTaxReportData = data; // ä¿å­˜æ•°æ®ç”¨äºPDFå¯¼å‡º
          const { dailySales, summary, taxByClassification } = data;
          
          // ç”Ÿæˆæ—¥é”€å”®è¡¨æ ¼
          const dailyTable = dailySales.length > 0 ? `
            <table style="margin-bottom: 30px;">
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>é”€å”®é¢</th>
                  <th>ç°é‡‘æ”¶å…¥</th>
                  <th>åˆ·å¡æ”¶å…¥</th>
                </tr>
              </thead>
              <tbody>
                ${dailySales.map(day => `
                  <tr>
                    <td>${new Date(day.date).toLocaleDateString('zh-CN')}</td>
                    <td>â‚¬${day.totalSales.toFixed(2)}</td>
                    <td>â‚¬${day.cashIncome.toFixed(2)}</td>
                    <td>â‚¬${day.cardIncome.toFixed(2)}</td>
                  </tr>
                `).join('')}
                <tr style="font-weight: bold; background: #e9ecef;">
                  <td>åˆè®¡</td>
                  <td>â‚¬${summary.totalSales.toFixed(2)}</td>
                  <td>â‚¬${summary.totalCashIncome.toFixed(2)}</td>
                  <td>â‚¬${summary.totalCardIncome.toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
          ` : '<p style="color: #999; text-align: center; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®æ•°æ®</p>';
          
          // ç”Ÿæˆç¨åŠ¡æ˜ç»†è¡¨æ ¼
          let taxRows = '';
          
          if (taxByClassification.VAT_23.sales > 0) {
            taxRows += `
              <tr>
                <td>VAT 23%</td>
                <td>â‚¬${taxByClassification.VAT_23.sales.toFixed(2)}</td>
                <td>â‚¬${taxByClassification.VAT_23.outputTax.toFixed(2)}</td>
                <td>â‚¬${taxByClassification.VAT_23.cost.toFixed(2)}</td>
                <td>â‚¬${taxByClassification.VAT_23.inputTax.toFixed(2)}</td>
                <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.VAT_23.due.toFixed(2)}</td>
              </tr>
            `;
          }
          
          if (taxByClassification.SERVICE_VAT_13_5.sales > 0) {
            taxRows += `
              <tr>
                <td>Service VAT 13.5%</td>
                <td>â‚¬${taxByClassification.SERVICE_VAT_13_5.sales.toFixed(2)}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.SERVICE_VAT_13_5.due.toFixed(2)}</td>
              </tr>
            `;
          }
          
          if (taxByClassification.MARGIN_VAT_0.sales > 0) {
            taxRows += `
              <tr>
                <td>Margin VAT</td>
                <td>â‚¬${taxByClassification.MARGIN_VAT_0.sales.toFixed(2)}</td>
                <td>-</td>
                <td>â‚¬${taxByClassification.MARGIN_VAT_0.cost.toFixed(2)}</td>
                <td>-</td>
                <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.MARGIN_VAT_0.due.toFixed(2)}</td>
              </tr>
              <tr style="background: #f8f9fa; font-size: 12px; color: #666;">
                <td colspan="6" style="padding-left: 30px;">
                  åˆ©æ¶¦: â‚¬${taxByClassification.MARGIN_VAT_0.margin.toFixed(2)} = é”€å”®é¢ - æˆæœ¬
                </td>
              </tr>
            `;
          }
          
          if (taxByClassification.VAT_0.sales > 0) {
            taxRows += `
              <tr>
                <td>VAT 0%</td>
                <td>â‚¬${taxByClassification.VAT_0.sales.toFixed(2)}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td style="color: #10b981; font-weight: bold;">â‚¬0.00</td>
              </tr>
            `;
          }
          
          if (!taxRows) {
            taxRows = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— ç¨åŠ¡æ•°æ®</td></tr>';
          }
          
          container.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
              <h3 style="margin-bottom: 20px;">ç¨åŠ¡æŠ¥è¡¨ (${startDate} è‡³ ${endDate})</h3>
              
              <h4 style="margin: 20px 0 10px 0;">ğŸ“… æ¯æ—¥é”€å”®æ±‡æ€»</h4>
              ${dailyTable}
              
              <h4 style="margin: 20px 0 10px 0;">ğŸ’° ç¨åŠ¡è®¡ç®—æ˜ç»†</h4>
              <table>
                <thead>
                  <tr>
                    <th>ç¨åŠ¡åˆ†ç±»</th>
                    <th>é”€å”®é¢</th>
                    <th>é”€é¡¹ç¨</th>
                    <th>æˆæœ¬</th>
                    <th>è¿›é¡¹ç¨</th>
                    <th>åº”ç¼´ç¨é¢</th>
                  </tr>
                </thead>
                <tbody>
                  ${taxRows}
                  <tr style="font-weight: bold; background: #fff3cd;">
                    <td colspan="5" style="text-align: right;">æ€»åº”ç¼´ç¨é¢ï¼š</td>
                    <td style="color: #dc3545; font-size: 18px;">â‚¬${summary.totalTaxDue.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
              
              <div style="margin-top: 20px; padding: 15px; background: white; border-left: 4px solid #6366f1;">
                <p style="margin: 0; color: #666;">
                  <strong>ğŸ“‹ è®¡ç®—è¯´æ˜ï¼š</strong><br>
                  â€¢ <strong>VAT 23%</strong>: é”€é¡¹ç¨ = é”€å”®é¢Ã—23/123, è¿›é¡¹ç¨ = æˆæœ¬Ã—23/123, åº”ç¼´ = é”€é¡¹ç¨ - è¿›é¡¹ç¨<br>
                  â€¢ <strong>Service VAT 13.5%</strong>: åº”ç¼´ç¨ = é‡‘é¢Ã—13.5/113.5<br>
                  â€¢ <strong>Margin VAT</strong>: åº”ç¼´ç¨ = (é”€å”®é¢ - æˆæœ¬)Ã—23/123<br>
                  â€¢ <strong>VAT 0%</strong>: å…ç¨å•†å“ï¼Œæ— éœ€ç¼´çº³å¢å€¼ç¨
                </p>
              </div>
            </div>
          `;
          
          // æ˜¾ç¤ºå¯¼å‡ºPDFæŒ‰é’®
          document.getElementById('exportTaxPdfBtn').style.display = 'inline-block';
          
          if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">ç”ŸæˆæŠ¥è¡¨å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // å¯¼å‡ºç¨åŠ¡æŠ¥è¡¨PDF
    async function exportTaxReportPDF() {
      if (!currentTaxReportData) {
        alert('è¯·å…ˆç”ŸæˆæŠ¥è¡¨');
        return;
      }
      
      try {
        const startDate = document.getElementById('taxStartDate').value;
        const endDate = document.getElementById('taxEndDate').value;
        
        const response = await fetch(`${API_BASE}/merchant/tax-report/pdf`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            merchantId: merchantId,
            startDate: startDate,
            endDate: endDate,
            data: currentTaxReportData
          })
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `tax-report-${startDate}-to-${endDate}.pdf`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          const error = await response.json();
          alert('å¯¼å‡ºPDFå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (error) {
        console.error('å¯¼å‡ºPDFå¤±è´¥:', error);
        alert('å¯¼å‡ºPDFå¤±è´¥: ' + error.message);
      }
    }
    
    // è¾…åŠ©å‡½æ•°
    function getCategoryBadge(category) {
      const badges = {
        'NEW_DEVICE': '<span class="badge badge-success">å…¨æ–°è®¾å¤‡</span>',
        'USED_DEVICE': '<span class="badge badge-warning">äºŒæ‰‹è®¾å¤‡</span>',
        'ACCESSORY': '<span class="badge badge-info">é…ä»¶</span>'
      };
      return badges[category] || category;
    }
    
    function getPaymentBadge(method, cashAmount, cardAmount) {
      if (method === 'MIXED' && cashAmount !== undefined && cardAmount !== undefined) {
        return `<span class="badge badge-warning">æ··åˆ</span><br><small style="color: #666;">ç°é‡‘â‚¬${cashAmount.toFixed(2)}<br>åˆ·å¡â‚¬${cardAmount.toFixed(2)}</small>`;
      }
      const badges = {
        'CASH': '<span class="badge badge-info">ç°é‡‘</span>',
        'CARD': '<span class="badge badge-primary">åˆ·å¡</span>',
        'MIXED': '<span class="badge badge-warning">æ··åˆ</span>'
      };
      return badges[method] || method;
    }
    
    function getTaxBadge(tax) {
      const badges = {
        'VAT_23': '<span class="badge badge-primary">VAT 23%</span>',
        'MARGIN_VAT_0': '<span class="badge badge-info">Margin VAT</span>',
        'SERVICE_VAT_13_5': '<span class="badge badge-warning">Service 13.5%</span>'
      };
      return badges[tax] || tax;
    }
    
    function getStatusBadge(status) {
      const badges = {
        'ACTIVE': '<span class="badge badge-success">æ­£å¸¸</span>',
        'LOW_STOCK': '<span class="badge badge-warning">åº“å­˜ä½</span>',
        'OUT_OF_STOCK': '<span class="badge badge-danger">ç¼ºè´§</span>'
      };
      return badges[status] || status;
    }
    
    // ä»ä»“åº“è®¢è´§
    async function orderFromWarehouse(index, productId, productName, maxQty) {
      const qtyInput = document.getElementById(`orderQty_${index}`);
      const quantity = parseInt(qtyInput.value);
      
      if (!quantity || quantity < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢è´§æ•°é‡');
        return;
      }
      
      if (quantity > maxQty) {
        alert(`è®¢è´§æ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨æ•°é‡ ${maxQty}`);
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦è®¢è´­ ${quantity} ä»¶ ${productName} å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        // åˆ›å»ºè®¢å•
        const orderResponse = await fetch(`${API_BASE}/merchant/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId,
            merchantName: 'VIPå•†æˆ·', // å®é™…åº”ä»sessionè·å–
            items: [{
              productId,
              quantity
            }]
          })
        });
        
        const orderResult = await orderResponse.json();
        
        if (!orderResult.success) {
          alert('è®¢å•åˆ›å»ºå¤±è´¥: ' + orderResult.error);
          return;
        }
        
        // è‡ªåŠ¨ç¡®è®¤è®¢å•
        const confirmResponse = await fetch(`${API_BASE}/merchant/orders/${orderResult.data._id}/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const confirmResult = await confirmResponse.json();
        
        if (confirmResult.success) {
          alert(`è®¢è´§æˆåŠŸï¼å·²å°† ${quantity} ä»¶ ${productName} æ·»åŠ åˆ°æ‚¨çš„åº“å­˜`);
          // åˆ·æ–°é¡µé¢æ•°æ®
          loadWarehouseProducts();
          loadStats();
        } else {
          alert('è®¢å•ç¡®è®¤å¤±è´¥: ' + confirmResult.error);
        }
      } catch (error) {
        alert('è®¢è´§å¤±è´¥: ' + error.message);
      }
    }
    
    // é”€å”®äº§å“
    async function sellProduct(inventoryId, productName, availableQty, retailPrice) {
      const quantity = prompt(`è¯·è¾“å…¥é”€å”®æ•°é‡ï¼ˆå¯ç”¨: ${availableQty}ï¼‰:`, '1');
      
      if (!quantity) return;
      
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      if (qty > availableQty) {
        alert(`é”€å”®æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜æ•°é‡ ${availableQty}`);
        return;
      }
      
      const paymentMethod = confirm('æ”¯ä»˜æ–¹å¼ï¼š\nç¡®å®š = åˆ·å¡\nå–æ¶ˆ = ç°é‡‘') ? 'CARD' : 'CASH';
      
      const totalAmount = (qty * retailPrice).toFixed(2);
      
      if (!confirm(`ç¡®è®¤é”€å”®ï¼š\näº§å“: ${productName}\næ•°é‡: ${qty}\nå•ä»·: â‚¬${retailPrice.toFixed(2)}\næ€»é¢: â‚¬${totalAmount}\næ”¯ä»˜: ${paymentMethod === 'CARD' ? 'åˆ·å¡' : 'ç°é‡‘'}`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sell`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId,
            inventoryId,
            quantity: qty,
            paymentMethod
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`é”€å”®æˆåŠŸï¼\nå‰©ä½™åº“å­˜: ${result.data.remainingStock}`);
          // åˆ·æ–°åº“å­˜åˆ—è¡¨
          loadMyInventory();
          loadStats();
        } else {
          alert('é”€å”®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('é”€å”®å¤±è´¥: ' + error.message);
      }
    }

    // ==================== ç»´ä¿®ä¸šåŠ¡åŠŸèƒ½ ====================
    
    let currentRepairFilter = 'all';
    
    // åŠ è½½ç»´ä¿®è®°å½•
    async function loadRepairs(status = null) {
      const container = document.getElementById('repairsTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        let url = `${API_BASE}/merchant/repairs?merchantId=${merchantId}`;
        if (status && status !== 'all') {
          url += `&status=${status}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ¥æ”¶æ—¥æœŸ</th>
                  <th>å®¢æˆ·</th>
                  <th>è®¾å¤‡</th>
                  <th>IMEI/SN</th>
                  <th>é—®é¢˜æè¿°</th>
                  <th>ç»´ä¿®åœ°ç‚¹</th>
                  <th>æˆæœ¬</th>
                  <th>å”®ä»·</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(repair => `
                  <tr style="${repair.status !== 'sold' ? 'cursor: pointer;' : ''}" 
                      ${repair.status !== 'sold' ? `onclick="showEditRepairModal('${repair._id}')"` : ''}
                      ${repair.status !== 'sold' ? `onmouseover="this.style.background='#f0f9ff'"` : ''}
                      ${repair.status !== 'sold' ? `onmouseout="this.style.background=''"` : ''}>
                    <td>${new Date(repair.receivedDate).toLocaleDateString('zh-CN')}</td>
                    <td>
                      <div style="font-weight: 600;">${repair.customerPhone}</div>
                      ${repair.customerName ? `<small style="color: #666;">${repair.customerName}</small>` : ''}
                    </td>
                    <td><strong>${repair.deviceName}</strong></td>
                    <td style="font-size: 11px; color: #666;">
                      ${repair.deviceIMEI ? `IMEI: ${repair.deviceIMEI}<br>` : ''}
                      ${repair.deviceSN ? `SN: ${repair.deviceSN}` : '-'}
                    </td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${repair.problemDescription}">
                      ${repair.problemDescription}
                    </td>
                    <td>${repair.repairLocation || '<span style="color: #10b981;">è‡ªå·±ç»´ä¿®</span>'}</td>
                    <td style="color: #666;">â‚¬${repair.repairCost.toFixed(2)}</td>
                    <td><strong style="color: #10b981;">â‚¬${repair.salePrice.toFixed(2)}</strong></td>
                    <td>${getRepairStatusBadge(repair.status)}</td>
                    <td onclick="event.stopPropagation()">
                      ${getRepairActions(repair)}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— ç»´ä¿®è®°å½•</p>';
        }
      } catch (error) {
        console.error('åŠ è½½ç»´ä¿®è®°å½•å¤±è´¥:', error);
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // ç­›é€‰ç»´ä¿®è®°å½•
    function filterRepairs(status) {
      currentRepairFilter = status;
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('[id^="filterBtn_"]').forEach(btn => {
        btn.style.opacity = '0.6';
      });
      document.getElementById(`filterBtn_${status}`).style.opacity = '1';
      
      // åŠ è½½æ•°æ®
      loadRepairs(status === 'all' ? null : status);
    }
    
    // è·å–ç»´ä¿®çŠ¶æ€æ ‡ç­¾
    function getRepairStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge badge-warning">å¾…ç»´ä¿®</span>',
        'sent_out': '<span class="badge" style="background: #8b5cf6; color: white;">å·²é€å‡º</span>',
        'retrieved': '<span class="badge badge-success">å·²å–å›</span>',
        'completed': '<span class="badge badge-info">å·²å®Œæˆ</span>',
        'ready_for_sale': '<span class="badge" style="background: #ec4899; color: white;">ç­‰å¾…é”€å”®</span>',
        'sold': '<span class="badge" style="background: #6b7280; color: white;">å·²é”€å”®</span>',
        'cancelled': '<span class="badge" style="background: #ef4444; color: white;">å·²å–æ¶ˆ</span>'
      };
      return badges[status] || status;
    }
    
    // è·å–ç»´ä¿®æ“ä½œæŒ‰é’®
    function getRepairActions(repair) {
      const buttons = [];
      
      switch (repair.status) {
        case 'pending':
          // å¾…ç»´ä¿® -> å¯ä»¥æ ‡è®°ä¸ºå·²å®Œæˆæˆ–ç­‰å¾…é”€å”®
          buttons.push(`<button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'completed')">å®Œæˆ</button>`);
          buttons.push(`<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'ready_for_sale')">å¾…é”€å”®</button>`);
          break;
        case 'sent_out':
          // å·²é€å‡º -> å¯ä»¥æ ‡è®°ä¸ºå·²å–å›
          buttons.push(`<button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'retrieved')">å·²å–å›</button>`);
          break;
        case 'retrieved':
        case 'completed':
          // å·²å–å›/å·²å®Œæˆ -> å¯ä»¥æ ‡è®°ä¸ºç­‰å¾…é”€å”®
          buttons.push(`<button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="updateRepairStatus('${repair._id}', 'ready_for_sale')">å¾…é”€å”®</button>`);
          break;
        case 'ready_for_sale':
          // ç­‰å¾…é”€å”® -> æ˜¾ç¤ºåœ¨é”€å”®ä¸šåŠ¡ä¸­
          buttons.push(`<span style="color: #10b981; font-size: 12px;">âœ“ å¯é”€å”®</span>`);
          break;
      }
      
      // æ‰“å°æŒ‰é’®ï¼ˆæ‰€æœ‰è®¢å•éƒ½å¯ä»¥æ‰“å°ï¼‰
      buttons.push(`<button class="btn" style="padding: 4px 8px; font-size: 12px; background: #3b82f6; color: white;" onclick="reprintRepairReceipts('${repair._id}')">ğŸ–¨ï¸ æ‰“å°</button>`);
      
      // åˆ é™¤æŒ‰é’®ï¼ˆæœªé”€å”®çš„è®¢å•å¯ä»¥åˆ é™¤ï¼‰
      if (repair.status !== 'sold') {
        buttons.push(`<button class="btn" style="padding: 4px 8px; font-size: 12px; background: #ef4444; color: white;" onclick="deleteRepair('${repair._id}')">åˆ é™¤</button>`);
      }
      
      return buttons.join(' ');
    }
    
    // æ˜¾ç¤ºæ–°å¢ç»´ä¿®æ¨¡æ€æ¡†
    function showNewRepairModal() {
      document.getElementById('newRepairModal').style.display = 'flex';
      document.getElementById('newRepairForm').reset();
    }
    
    // å…³é—­æ–°å¢ç»´ä¿®æ¨¡æ€æ¡†
    function closeNewRepairModal() {
      document.getElementById('newRepairModal').style.display = 'none';
    }
    
    // æäº¤æ–°å¢ç»´ä¿®è®¢å•
    async function submitNewRepair(event) {
      event.preventDefault();
      
      const formData = {
        merchantId: merchantId,
        customerPhone: document.getElementById('repair_customerPhone').value,
        customerName: document.getElementById('repair_customerName').value,
        deviceName: document.getElementById('repair_deviceName').value,
        deviceIMEI: document.getElementById('repair_deviceIMEI').value,
        deviceSN: document.getElementById('repair_deviceSN').value,
        problemDescription: document.getElementById('repair_problemDescription').value,
        notes: document.getElementById('repair_notes').value,
        repairLocation: document.getElementById('repair_location').value,
        estimatedCompletionDate: document.getElementById('repair_estimatedDate').value || null,
        repairCost: parseFloat(document.getElementById('repair_cost').value) || 0,
        salePrice: parseFloat(document.getElementById('repair_salePrice').value) || 0
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          const isOutsourced = result.data.isOutsourced;
          const statusText = isOutsourced ? 'å·²é€å‡º' : 'å¾…ç»´ä¿®';
          alert(`âœ… ç»´ä¿®è®¢å•åˆ›å»ºæˆåŠŸï¼\nçŠ¶æ€: ${statusText}\nè®¢å•å·: ${result.data.repairOrderId}`);
          
          // è¯¢é—®æ˜¯å¦æ‰“å°å°ç¥¨
          const shouldPrint = confirm('Do you want to print repair receipts?\næ˜¯å¦æ‰“å°ç»´ä¿®å°ç¥¨ï¼Ÿ');
          
          if (shouldPrint) {
            // æ‰“å°ä¸¤å¼ å°ç¥¨
            await printRepairReceipts(result.data, formData);
          }
          
          closeNewRepairModal();
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ åˆ›å»ºå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ åˆ›å»ºå¤±è´¥: ' + error.message);
      }
    }
    
    // æ›´æ–°ç»´ä¿®è®¢å•çŠ¶æ€
    async function updateRepairStatus(repairId, newStatus) {
      const statusNames = {
        'completed': 'å·²å®Œæˆ',
        'retrieved': 'å·²å–å›',
        'ready_for_sale': 'ç­‰å¾…é”€å”®',
        'sent_out': 'å·²é€å‡º'
      };
      
      if (!confirm(`ç¡®å®šè¦å°†æ­¤è®¢å•æ ‡è®°ä¸º"${statusNames[newStatus]}"å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… çŠ¶æ€å·²æ›´æ–°ä¸º: ${statusNames[newStatus]}`);
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }
    
    // æ‰“å°ç»´ä¿®å°ç¥¨ï¼ˆä¸¤å¼ ï¼‰
    async function printRepairReceipts(repairData, formData) {
      try {
        // è·å–å…¬å¸ä¿¡æ¯
        const profileResponse = await fetch(`${API_BASE}/users/profile?username=${merchantId}`);
        const profileResult = await profileResponse.json();
        
        if (!profileResult.success) {
          console.error('Failed to get company info');
          return;
        }
        
        // æ ¼å¼åŒ–å…¬å¸ä¿¡æ¯
        let companyInfo = {
          companyName: '3C Product Store',
          address: '',
          phone: '',
          email: ''
        };
        
        if (profileResult.data.companyInfo) {
          const ci = profileResult.data.companyInfo;
          companyInfo = {
            companyName: ci.companyName || companyInfo.companyName,
            address: ci.address ? 
              `${ci.address.street || ''} ${ci.address.city || ''} ${ci.address.postalCode || ''}`.trim() : '',
            phone: ci.contactPhone || '',
            email: ci.contactEmail || ''
          };
        }
        
        // æ ¼å¼åŒ–è®¢å•å·ï¼ˆä½¿ç”¨_idçš„å8ä½ï¼‰
        const orderId = repairData.repairOrderId || repairData._id || 'N/A';
        const formattedOrderId = orderId.length > 8 ? `RO-${orderId.toString().slice(-8).toUpperCase()}` : orderId;
        
        const printData = {
          repairOrderId: formattedOrderId
        };
        
        // æ‰“å°ç¬¬ä¸€å¼ ï¼šå®¢æˆ·å°ç¥¨
        await printCustomerRepairReceipt(printData, formData, companyInfo);
        
        // å»¶è¿Ÿ1ç§’åæ‰“å°ç¬¬äºŒå¼ ï¼šè½¦é—´å°ç¥¨
        setTimeout(() => {
          printWorkshopRepairReceipt(printData, formData, companyInfo);
        }, 1000);
        
      } catch (error) {
        console.error('Print repair receipts error:', error);
      }
    }
    
    // é‡æ–°æ‰“å°ç»´ä¿®å°ç¥¨ï¼ˆä»è®¢å•åˆ—è¡¨ï¼‰
    async function reprintRepairReceipts(repairId) {
      try {
        // è·å–ç»´ä¿®è®¢å•è¯¦æƒ…
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`);
        const result = await response.json();
        
        if (!result.success || !result.data) {
          alert('âŒ è·å–è®¢å•ä¿¡æ¯å¤±è´¥');
          return;
        }
        
        const repair = result.data;
        
        // è·å–å…¬å¸ä¿¡æ¯
        const profileResponse = await fetch(`${API_BASE}/users/profile?username=${merchantId}`);
        const profileResult = await profileResponse.json();
        
        if (!profileResult.success) {
          alert('âŒ è·å–å…¬å¸ä¿¡æ¯å¤±è´¥');
          return;
        }
        
        // æ ¼å¼åŒ–å…¬å¸ä¿¡æ¯
        let companyInfo = {
          companyName: '3C Product Store',
          address: '',
          phone: '',
          email: ''
        };
        
        if (profileResult.data.companyInfo) {
          const ci = profileResult.data.companyInfo;
          companyInfo = {
            companyName: ci.companyName || companyInfo.companyName,
            address: ci.address ? 
              `${ci.address.street || ''} ${ci.address.city || ''} ${ci.address.postalCode || ''}`.trim() : '',
            phone: ci.contactPhone || '',
            email: ci.contactEmail || ''
          };
        }
        
        // å‡†å¤‡æ‰“å°æ•°æ®
        const repairData = {
          repairOrderId: `RO-${repair._id.toString().slice(-8).toUpperCase()}` // ä½¿ç”¨_idçš„å8ä½ä½œä¸ºè®¢å•å·
        };
        
        const formData = {
          customerPhone: repair.customerPhone,
          customerName: repair.customerName,
          deviceName: repair.deviceName,
          deviceIMEI: repair.deviceIMEI,
          deviceSN: repair.deviceSN,
          problemDescription: repair.problemDescription,
          notes: repair.notes,
          salePrice: repair.salePrice,
          repairLocation: repair.repairLocation,
          estimatedCompletionDate: repair.estimatedCompletionDate
        };
        
        // ç¬¬ä¸€ä¸ªè¯¢é—®ï¼šæ˜¯å¦æ‰“å°å®¢æˆ·å°ç¥¨
        const printCustomer = confirm('Do you want to print CUSTOMER receipt?\næ˜¯å¦æ‰“å°å®¢äººç»´ä¿®å°ç¥¨ï¼Ÿ');
        
        // ç¬¬äºŒä¸ªè¯¢é—®ï¼šæ˜¯å¦æ‰“å°è½¦é—´å°ç¥¨
        const printWorkshop = confirm('Do you want to print WORKSHOP ticket?\næ˜¯å¦æ‰“å°åº—é“ºç»´ä¿®å°ç¥¨ï¼Ÿ');
        
        // æ ¹æ®é€‰æ‹©æ‰§è¡Œæ‰“å°
        if (printCustomer) {
          printCustomerRepairReceipt(repairData, formData, companyInfo);
          
          // å¦‚æœä¸¤å¼ éƒ½è¦æ‰“å°ï¼Œå»¶è¿Ÿæ‰“å°ç¬¬äºŒå¼ 
          if (printWorkshop) {
            setTimeout(() => {
              printWorkshopRepairReceipt(repairData, formData, companyInfo);
            }, 1500);
          }
        } else if (printWorkshop) {
          // åªæ‰“å°è½¦é—´å°ç¥¨
          printWorkshopRepairReceipt(repairData, formData, companyInfo);
        }
        
        // å¦‚æœä¸¤å¼ éƒ½ä¸æ‰“å°ï¼Œæç¤ºç”¨æˆ·
        if (!printCustomer && !printWorkshop) {
          console.log('ç”¨æˆ·å–æ¶ˆäº†æ‰“å°');
        }
        
      } catch (error) {
        console.error('Reprint repair receipts error:', error);
        alert('âŒ æ‰“å°å¤±è´¥: ' + error.message);
      }
    }
    
    // æ‰“å°å®¢æˆ·ç»´ä¿®å°ç¥¨
    function printCustomerRepairReceipt(repairData, formData, companyInfo) {
      const printWindow = window.open('', '_blank', 'width=300,height=600');
      
      const receiptHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Customer Repair Receipt</title>
          <style>
            @media print {
              @page { margin: 0; size: 80mm auto; }
              body { margin: 0; padding: 0; }
            }
            body {
              font-family: 'Courier New', monospace;
              width: 80mm;
              margin: 0 auto;
              padding: 5mm;
              font-size: 12px;
              line-height: 1.4;
            }
            .header {
              text-align: center;
              margin-bottom: 10px;
              border-bottom: 2px dashed #000;
              padding-bottom: 10px;
            }
            .company-name {
              font-size: 16px;
              font-weight: bold;
              margin-bottom: 5px;
            }
            .company-info {
              font-size: 11px;
            }
            .section {
              margin: 10px 0;
              border-bottom: 1px dashed #ccc;
              padding-bottom: 8px;
            }
            .row {
              display: flex;
              justify-content: space-between;
              margin: 3px 0;
            }
            .label {
              font-weight: bold;
            }
            .total {
              font-size: 14px;
              font-weight: bold;
              margin-top: 10px;
              text-align: right;
            }
            .footer {
              text-align: center;
              margin-top: 15px;
              font-size: 11px;
              border-top: 2px dashed #000;
              padding-top: 10px;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="company-name">${companyInfo.companyName || 'Company Name'}</div>
            <div class="company-info">
              ${companyInfo.address || ''}<br>
              ${companyInfo.phone || ''}<br>
              ${companyInfo.email || ''}
            </div>
          </div>
          
          <div style="text-align: center; font-weight: bold; margin: 10px 0;">
            CUSTOMER REPAIR RECEIPT
          </div>
          
          <div class="section">
            <div class="row">
              <span class="label">Order No:</span>
              <span>${repairData.repairOrderId || 'N/A'}</span>
            </div>
            <div class="row">
              <span class="label">Date:</span>
              <span>${new Date().toLocaleString('en-IE', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
              })}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="row">
              <span class="label">Customer Phone:</span>
              <span>${formData.customerPhone || 'N/A'}</span>
            </div>
            ${formData.customerName ? `
            <div class="row">
              <span class="label">Customer Name:</span>
              <span>${formData.customerName}</span>
            </div>
            ` : ''}
          </div>
          
          <div class="section">
            <div class="row">
              <span class="label">Device:</span>
              <span>${formData.deviceName || 'N/A'}</span>
            </div>
            ${formData.deviceIMEI ? `
            <div class="row">
              <span class="label">IMEI:</span>
              <span>${formData.deviceIMEI}</span>
            </div>
            ` : ''}
            ${formData.deviceSN ? `
            <div class="row">
              <span class="label">Serial No:</span>
              <span>${formData.deviceSN}</span>
            </div>
            ` : ''}
          </div>
          
          <div class="section">
            <div class="label">Problem Description:</div>
            <div style="margin-top: 5px;">${formData.problemDescription || 'N/A'}</div>
          </div>
          
          ${formData.notes ? `
          <div class="section">
            <div class="label">Notes:</div>
            <div style="margin-top: 5px;">${formData.notes}</div>
          </div>
          ` : ''}
          
          <div class="total">
            Sale Price: â‚¬${(formData.salePrice || 0).toFixed(2)}
          </div>
          
          <div class="footer">
            <div style="font-weight: bold; margin-bottom: 5px;">Thank You!</div>
            <div>For any questions, please contact us</div>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(receiptHTML);
      printWindow.document.close();
      
      setTimeout(() => {
        printWindow.print();
        setTimeout(() => {
          printWindow.close();
        }, 1000);
      }, 500);
    }
    
    // æ‰“å°è½¦é—´ç»´ä¿®å°ç¥¨
    function printWorkshopRepairReceipt(repairData, formData, companyInfo) {
      const printWindow = window.open('', '_blank', 'width=300,height=600');
      
      const receiptHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Workshop Repair Receipt</title>
          <style>
            @media print {
              @page { margin: 0; size: 80mm auto; }
              body { margin: 0; padding: 0; }
            }
            body {
              font-family: 'Courier New', monospace;
              width: 80mm;
              margin: 0 auto;
              padding: 5mm;
              font-size: 12px;
              line-height: 1.4;
            }
            .header {
              text-align: center;
              margin-bottom: 10px;
              border-bottom: 2px dashed #000;
              padding-bottom: 10px;
            }
            .company-name {
              font-size: 16px;
              font-weight: bold;
              margin-bottom: 5px;
            }
            .company-info {
              font-size: 11px;
            }
            .section {
              margin: 10px 0;
              border-bottom: 1px dashed #ccc;
              padding-bottom: 8px;
            }
            .row {
              display: flex;
              justify-content: space-between;
              margin: 3px 0;
            }
            .label {
              font-weight: bold;
            }
            .footer {
              text-align: center;
              margin-top: 15px;
              font-size: 11px;
              border-top: 2px dashed #000;
              padding-top: 10px;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="company-name">${companyInfo.companyName || 'Company Name'}</div>
            <div class="company-info">
              ${companyInfo.address || ''}<br>
              ${companyInfo.phone || ''}<br>
              ${companyInfo.email || ''}
            </div>
          </div>
          
          <div style="text-align: center; font-weight: bold; margin: 10px 0;">
            WORKSHOP REPAIR TICKET
          </div>
          
          <div class="section">
            <div class="row">
              <span class="label">Order No:</span>
              <span>${repairData.repairOrderId || 'N/A'}</span>
            </div>
            <div class="row">
              <span class="label">Date:</span>
              <span>${new Date().toLocaleString('en-IE', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
              })}</span>
            </div>
          </div>
          
          <div class="section">
            <div class="row">
              <span class="label">Device:</span>
              <span>${formData.deviceName || 'N/A'}</span>
            </div>
            ${formData.deviceIMEI ? `
            <div class="row">
              <span class="label">IMEI:</span>
              <span>${formData.deviceIMEI}</span>
            </div>
            ` : ''}
            ${formData.deviceSN ? `
            <div class="row">
              <span class="label">Serial No:</span>
              <span>${formData.deviceSN}</span>
            </div>
            ` : ''}
          </div>
          
          <div class="section">
            <div class="label">Problem Description:</div>
            <div style="margin-top: 5px;">${formData.problemDescription || 'N/A'}</div>
          </div>
          
          ${formData.notes ? `
          <div class="section">
            <div class="label">Notes:</div>
            <div style="margin-top: 5px;">${formData.notes}</div>
          </div>
          ` : ''}
          
          <div class="section">
            <div class="row">
              <span class="label">Repair Location:</span>
              <span>${formData.repairLocation || 'N/A'}</span>
            </div>
            ${formData.estimatedCompletionDate ? `
            <div class="row">
              <span class="label">Est. Completion:</span>
              <span>${new Date(formData.estimatedCompletionDate).toLocaleDateString('en-IE')}</span>
            </div>
            ` : ''}
          </div>
          
          <div class="footer">
            <div style="font-weight: bold;">INTERNAL USE ONLY</div>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(receiptHTML);
      printWindow.document.close();
      
      setTimeout(() => {
        printWindow.print();
        setTimeout(() => {
          printWindow.close();
        }, 1000);
      }, 500);
    }
    
    // åˆ é™¤ç»´ä¿®è®¢å•
    async function deleteRepair(repairId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç»´ä¿®è®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ç»´ä¿®è®¢å•å·²åˆ é™¤');
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ åˆ é™¤å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºç¼–è¾‘ç»´ä¿®è®¢å•æ¨¡æ€æ¡†
    async function showEditRepairModal(repairId) {
      try {
        // è·å–ç»´ä¿®è®¢å•è¯¦æƒ…
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const repair = result.data;
          
          // å¡«å……è¡¨å•
          document.getElementById('edit_repair_id').value = repair._id;
          document.getElementById('edit_repair_customerPhone').value = repair.customerPhone;
          document.getElementById('edit_repair_customerName').value = repair.customerName || '';
          document.getElementById('edit_repair_deviceName').value = repair.deviceName;
          document.getElementById('edit_repair_deviceIMEI').value = repair.deviceIMEI || '';
          document.getElementById('edit_repair_deviceSN').value = repair.deviceSN || '';
          document.getElementById('edit_repair_problemDescription').value = repair.problemDescription;
          document.getElementById('edit_repair_notes').value = repair.notes || '';
          document.getElementById('edit_repair_location').value = repair.repairLocation || '';
          document.getElementById('edit_repair_cost').value = repair.repairCost || 0;
          document.getElementById('edit_repair_salePrice').value = repair.salePrice || 0;
          
          // å¤„ç†æ—¥æœŸ
          if (repair.estimatedCompletionDate) {
            const date = new Date(repair.estimatedCompletionDate);
            document.getElementById('edit_repair_estimatedDate').value = date.toISOString().split('T')[0];
          } else {
            document.getElementById('edit_repair_estimatedDate').value = '';
          }
          
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          document.getElementById('editRepairModal').style.display = 'flex';
        } else {
          alert('âŒ è·å–ç»´ä¿®è®¢å•è¯¦æƒ…å¤±è´¥');
        }
      } catch (error) {
        alert('âŒ è·å–ç»´ä¿®è®¢å•è¯¦æƒ…å¤±è´¥: ' + error.message);
      }
    }
    
    // å…³é—­ç¼–è¾‘ç»´ä¿®è®¢å•æ¨¡æ€æ¡†
    function closeEditRepairModal() {
      document.getElementById('editRepairModal').style.display = 'none';
    }
    
    // æäº¤ç¼–è¾‘ç»´ä¿®è®¢å•
    async function submitEditRepair(event) {
      event.preventDefault();
      
      const repairId = document.getElementById('edit_repair_id').value;
      const formData = {
        customerPhone: document.getElementById('edit_repair_customerPhone').value,
        customerName: document.getElementById('edit_repair_customerName').value,
        deviceName: document.getElementById('edit_repair_deviceName').value,
        deviceIMEI: document.getElementById('edit_repair_deviceIMEI').value,
        deviceSN: document.getElementById('edit_repair_deviceSN').value,
        problemDescription: document.getElementById('edit_repair_problemDescription').value,
        notes: document.getElementById('edit_repair_notes').value,
        repairLocation: document.getElementById('edit_repair_location').value,
        estimatedCompletionDate: document.getElementById('edit_repair_estimatedDate').value || null,
        repairCost: parseFloat(document.getElementById('edit_repair_cost').value) || 0,
        salePrice: parseFloat(document.getElementById('edit_repair_salePrice').value) || 0
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs/${repairId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ç»´ä¿®è®¢å•å·²æ›´æ–°');
          closeEditRepairModal();
          loadRepairs(currentRepairFilter === 'all' ? null : currentRepairFilter);
        } else {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('âŒ æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤ºäº§å“æ—¶é—´çº¿
    async function showProductTimeline(inventoryId, productName) {
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('productTimelineModal').style.display = 'flex';
      document.getElementById('timelineProductName').textContent = `ğŸ“¦ ${productName}`;
      document.getElementById('timelineContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/${inventoryId}/timeline`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const timeline = result.data;
          
          let html = '<div style="position: relative; padding-left: 30px;">';
          
          // æ—¶é—´çº¿æ ·å¼
          html += '<div style="position: absolute; left: 10px; top: 0; bottom: 0; width: 2px; background: #e5e7eb;"></div>';
          
          if (timeline.length === 0) {
            html += '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— å†å²è®°å½•</p>';
          } else {
            timeline.forEach((event, index) => {
              const isFirst = index === 0;
              const eventColor = event.type === 'created' ? '#10b981' : 
                                 event.type === 'sold' ? '#3b82f6' : 
                                 event.type === 'refunded' ? '#dc2626' : 
                                 event.type === 'transferred_out' ? '#f59e0b' : 
                                 event.type === 'transferred_in' ? '#8b5cf6' : '#6b7280';
              
              // å¤„ç†è¯¦æƒ…ä¸­çš„è°ƒè´§å•å·ï¼Œä½¿å…¶å¯ç‚¹å‡»
              let details = event.details;
              if (event.transferId && event.transferNumber) {
                details = details.replace(
                  `è°ƒè´§å•å·: ${event.transferNumber}`,
                  `è°ƒè´§å•å·: <a href="javascript:void(0)" onclick="showTransferDetails('${event.transferId}')" style="color: #3b82f6; text-decoration: underline; cursor: pointer;">${event.transferNumber}</a>`
                );
              }
              
              html += `
                <div style="position: relative; margin-bottom: 30px;">
                  <!-- æ—¶é—´çº¿åœ†ç‚¹ -->
                  <div style="position: absolute; left: -24px; width: 12px; height: 12px; border-radius: 50%; background: ${eventColor}; border: 3px solid white; box-shadow: 0 0 0 2px ${eventColor};"></div>
                  
                  <!-- äº‹ä»¶å¡ç‰‡ -->
                  <div style="background: white; border: 2px solid ${eventColor}; border-radius: 8px; padding: 15px; ${isFirst ? 'box-shadow: 0 4px 6px rgba(0,0,0,0.1);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                      <div style="font-weight: 600; color: ${eventColor}; font-size: 16px;">
                        ${event.icon} ${event.title}
                      </div>
                      <div style="font-size: 12px; color: #666;">
                        ${new Date(event.date).toLocaleString('zh-CN', { 
                          year: 'numeric', 
                          month: '2-digit', 
                          day: '2-digit', 
                          hour: '2-digit', 
                          minute: '2-digit' 
                        })}
                      </div>
                    </div>
                    
                    <div style="color: #666; font-size: 14px; line-height: 1.6;">
                      ${event.description}
                    </div>
                    
                    ${details ? `
                      <div style="margin-top: 10px; padding: 10px; background: #f9fafb; border-radius: 5px; font-size: 13px; color: #666;">
                        ${details}
                      </div>
                    ` : ''}
                  </div>
                </div>
              `;
            });
          }
          
          html += '</div>';
          document.getElementById('timelineContent').innerHTML = html;
        } else {
          document.getElementById('timelineContent').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">åŠ è½½å¤±è´¥</p>';
        }
      } catch (error) {
        console.error('åŠ è½½æ—¶é—´çº¿å¤±è´¥:', error);
        document.getElementById('timelineContent').innerHTML = `<p style="text-align: center; color: #dc3545; padding: 40px;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // å…³é—­äº§å“æ—¶é—´çº¿æ¨¡æ€æ¡†
    function closeProductTimeline() {
      document.getElementById('productTimelineModal').style.display = 'none';
    }
    
    // ä»è¯¦æƒ…æ¨¡æ€æ¡†ä¸­ç¼–è¾‘åº“å­˜äº§å“
    async function editInventoryItemFromModal(inventoryId, buttonElement) {
      // ä¿å­˜æ¨¡æ€æ¡†å¼•ç”¨
      window.currentDetailsModal = buttonElement.closest('div[style*="position: fixed"]');
      
      // è°ƒç”¨ç¼–è¾‘å‡½æ•°
      await editInventoryItem(inventoryId);
    }
    
    // ç¼–è¾‘åº“å­˜äº§å“
    async function editInventoryItem(inventoryId) {
      try {
        // ä»allInventoryDataIncludingZeroä¸­æŸ¥æ‰¾äº§å“
        const item = allInventoryDataIncludingZero.find(inv => inv._id === inventoryId);
        
        if (!item) {
          alert('äº§å“ä¸å­˜åœ¨');
          return;
        }
        
        // å¡«å……è¡¨å•
        document.getElementById('editInventoryId').value = item._id;
        document.getElementById('editProductName').value = item.productName || '';
        document.getElementById('editBrand').value = item.brand || '';
        document.getElementById('editModel').value = item.model || '';
        document.getElementById('editColor').value = item.color || '';
        document.getElementById('editCostPrice').value = item.costPrice || 0;
        document.getElementById('editWholesalePrice').value = item.wholesalePrice || 0;
        document.getElementById('editRetailPrice').value = item.retailPrice || 0;
        document.getElementById('editTaxClassification').value = item.taxClassification || 'VAT_23';
        document.getElementById('editCondition').value = item.condition || '';
        document.getElementById('editStatus').value = item.status || 'active';
        document.getElementById('editLocation').value = item.location || '';
        document.getElementById('editNotes').value = item.notes || '';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        document.getElementById('editInventoryModal').style.display = 'flex';
      } catch (error) {
        console.error('åŠ è½½äº§å“ä¿¡æ¯å¤±è´¥:', error);
        alert('åŠ è½½äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
      }
    }
    
    // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
    function closeEditInventoryModal() {
      document.getElementById('editInventoryModal').style.display = 'none';
      document.getElementById('editInventoryForm').reset();
    }
    
    // ä¿å­˜äº§å“ç¼–è¾‘
    async function saveInventoryEdit(event) {
      event.preventDefault();
      
      const inventoryId = document.getElementById('editInventoryId').value;
      const updateData = {
        merchantId: merchantId, // æ·»åŠ merchantIdç”¨äºèº«ä»½éªŒè¯
        productName: document.getElementById('editProductName').value,
        brand: document.getElementById('editBrand').value,
        model: document.getElementById('editModel').value,
        color: document.getElementById('editColor').value,
        costPrice: parseFloat(document.getElementById('editCostPrice').value),
        wholesalePrice: parseFloat(document.getElementById('editWholesalePrice').value),
        retailPrice: parseFloat(document.getElementById('editRetailPrice').value),
        taxClassification: document.getElementById('editTaxClassification').value,
        condition: document.getElementById('editCondition').value,
        status: document.getElementById('editStatus').value,
        location: document.getElementById('editLocation').value,
        notes: document.getElementById('editNotes').value
      };
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/${inventoryId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… äº§å“ä¿¡æ¯å·²æ›´æ–°');
          closeEditInventoryModal();
          
          // å¦‚æœæ˜¯ä»è¯¦æƒ…æ¨¡æ€æ¡†æ‰“å¼€çš„ï¼Œå…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
          if (window.currentDetailsModal) {
            window.currentDetailsModal.remove();
            window.currentDetailsModal = null;
          }
          
          // é‡æ–°åŠ è½½åº“å­˜æ•°æ®
          await loadMyInventory();
          
          // å¦‚æœå½“å‰åœ¨äº§å“åˆ—è¡¨è§†å›¾ï¼Œé‡æ–°æ˜¾ç¤ºè¯¥åˆ†ç±»
          const productListDiv = document.getElementById('inventoryProductList');
          if (productListDiv.style.display !== 'none') {
            // ä»æ ‡é¢˜ä¸­è·å–å½“å‰åˆ†ç±»åç§°
            const categoryName = document.getElementById('currentInventoryCategoryName').textContent.replace('ğŸ“¦ ', '');
            showInventoryCategory(categoryName);
          }
        } else {
          alert('æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('ä¿å­˜äº§å“ä¿¡æ¯å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    }
    
    // æ˜¾ç¤ºè°ƒè´§è¯¦æƒ…
    async function showTransferDetails(transferId) {
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/${transferId}`);
        const result = await response.json();
        
        if (!result.success) {
          alert('åŠ è½½è°ƒè´§è¯¦æƒ…å¤±è´¥: ' + result.error);
          return;
        }
        
        const transfer = result.data;
        
        const isInternalTransfer = transfer.transferType === 'INTERNAL_TRANSFER';
        const typeIcon = isInternalTransfer ? 'ğŸ“¦' : 'ğŸ’°';
        const typeColor = isInternalTransfer ? '#3b82f6' : '#10b981';
        const typeName = isInternalTransfer ? 'å†…éƒ¨è°ƒæ‹¨' : 'å…¬å¸é—´é”€å”®';
        
        // çŠ¶æ€æ˜¾ç¤º
        let statusBadge = '';
        let statusColor = '';
        switch(transfer.status) {
          case 'pending':
            statusBadge = 'å¾…å®¡æ‰¹';
            statusColor = '#f59e0b';
            break;
          case 'approved':
            statusBadge = 'å·²æ‰¹å‡†';
            statusColor = '#3b82f6';
            break;
          case 'rejected':
            statusBadge = 'å·²æ‹’ç»';
            statusColor = '#dc2626';
            break;
          case 'completed':
            statusBadge = 'å·²å®Œæˆ';
            statusColor = '#10b981';
            break;
        }
        
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.id = 'transferDetailsModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10001;';
        
        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h2 style="margin: 0; color: #111827;">ğŸ“‹ è°ƒè´§è¯¦æƒ…</h2>
              <button onclick="closeTransferDetails()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <!-- å¤´éƒ¨ä¿¡æ¯ -->
            <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div>
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <span style="font-size: 20px; font-weight: 600; color: #111827;">${transfer.transferNumber}</span>
                    <span style="padding: 6px 12px; background: ${statusColor}; color: white; border-radius: 6px; font-size: 13px; font-weight: 600;">
                      ${statusBadge}
                    </span>
                    <span style="padding: 6px 12px; background: ${typeColor}15; color: ${typeColor}; border-radius: 6px; font-size: 13px; font-weight: 600;">
                      ${typeIcon} ${typeName}
                    </span>
                  </div>
                  <div style="font-size: 14px; color: #6b7280;">
                    åˆ›å»ºæ—¶é—´: ${new Date(transfer.createdAt).toLocaleString('zh-CN')}
                  </div>
                  ${transfer.completedAt ? `
                    <div style="font-size: 14px; color: #6b7280;">
                      å®Œæˆæ—¶é—´: ${new Date(transfer.completedAt).toLocaleString('zh-CN')}
                    </div>
                  ` : ''}
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 28px; font-weight: 700; color: ${typeColor};">
                    â‚¬${transfer.totalAmount.toFixed(2)}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- åŒæ–¹ä¿¡æ¯ -->
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; margin-bottom: 20px;">
              <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 13px; color: #1e40af; margin-bottom: 8px; font-weight: 600;">è°ƒå‡ºæ–¹</div>
                <div style="font-weight: 600; color: #111827; font-size: 16px; margin-bottom: 5px;">${transfer.fromMerchant}</div>
                ${transfer.fromCompany?.companyName ? `<div style="font-size: 14px; color: #6b7280;">${transfer.fromCompany.companyName}</div>` : ''}
              </div>
              <div style="display: flex; align-items: center; color: #3b82f6; font-size: 24px;">
                â†’
              </div>
              <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 4px solid #10b981;">
                <div style="font-size: 13px; color: #166534; margin-bottom: 8px; font-weight: 600;">è°ƒå…¥æ–¹</div>
                <div style="font-weight: 600; color: #111827; font-size: 16px; margin-bottom: 5px;">${transfer.toMerchant}</div>
                ${transfer.toCompany?.companyName ? `<div style="font-size: 14px; color: #6b7280;">${transfer.toCompany.companyName}</div>` : ''}
              </div>
            </div>
            
            <!-- äº§å“åˆ—è¡¨ -->
            <div style="margin-bottom: 20px;">
              <h3 style="font-size: 16px; margin-bottom: 12px; color: #374151;">äº§å“æ¸…å•</h3>
              <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead style="background: #f9fafb;">
                    <tr>
                      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; font-weight: 600;">äº§å“åç§°</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">å˜ä½“</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">åºåˆ—å·/IMEI</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">æˆè‰²</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb; font-weight: 600;">æ•°é‡</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb; font-weight: 600;">å•ä»·</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb; font-weight: 600;">å°è®¡</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(() => {
                      // åˆå¹¶ç›¸åŒäº§å“ï¼ˆç›¸åŒåç§°ã€å‹å·ã€é¢œè‰²ã€ä»·æ ¼ï¼‰
                      const grouped = {};
                      transfer.items.forEach(item => {
                        const key = item.productName + '|' + (item.model || '') + '|' + (item.color || '') + '|' + item.transferPrice;
                        if (!grouped[key]) {
                          grouped[key] = {
                            productName: item.productName,
                            model: item.model,
                            color: item.color,
                            condition: item.condition,
                            transferPrice: item.transferPrice,
                            quantity: 0,
                            serialNumbers: []
                          };
                        }
                        grouped[key].quantity += item.quantity;
                        if (item.serialNumber) {
                          grouped[key].serialNumbers.push(item.serialNumber);
                        }
                      });
                      
                      return Object.values(grouped).map((item, index) => {
                        // æ„å»ºå˜ä½“æ˜¾ç¤º
                        let variantDisplay = '';
                        if (item.model || item.color) {
                          const parts = [];
                          if (item.model && item.model !== 'NO_MODEL') parts.push(item.model);
                          if (item.color && item.color !== 'NO_COLOR') parts.push(item.color);
                          variantDisplay = parts.join(' - ');
                        }
                        
                        // åºåˆ—å·æ˜¾ç¤º
                        let serialDisplay = '-';
                        if (item.serialNumbers.length > 0) {
                          if (item.serialNumbers.length === 1) {
                            serialDisplay = item.serialNumbers[0];
                          } else {
                            serialDisplay = item.serialNumbers.length + ' ä¸ªåºåˆ—å·';
                          }
                        }
                        
                        return '<tr style="background: ' + (index % 2 === 0 ? 'white' : '#f9fafb') + ';">' +
                          '<td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">' + item.productName + '</td>' +
                          '<td style="padding: 12px; text-align: center; border-bottom: 1px solid #f3f4f6;">' +
                            (variantDisplay ? '<span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">' + variantDisplay + '</span>' : '-') +
                          '</td>' +
                          '<td style="padding: 12px; text-align: center; font-family: monospace; font-size: 11px; border-bottom: 1px solid #f3f4f6;">' + serialDisplay + '</td>' +
                          '<td style="padding: 12px; text-align: center; border-bottom: 1px solid #f3f4f6;">' + (item.condition || '-') + '</td>' +
                          '<td style="padding: 12px; text-align: center; border-bottom: 1px solid #f3f4f6;">' + item.quantity + '</td>' +
                          '<td style="padding: 12px; text-align: right; font-weight: 600; border-bottom: 1px solid #f3f4f6;">â‚¬' + item.transferPrice.toFixed(2) + '</td>' +
                          '<td style="padding: 12px; text-align: right; font-weight: 600; border-bottom: 1px solid #f3f4f6;">â‚¬' + (item.transferPrice * item.quantity).toFixed(2) + '</td>' +
                        '</tr>';
                      }).join('');
                    })()}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- å¤‡æ³¨ -->
            ${transfer.notes ? `
              <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                <div style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 5px;">å¤‡æ³¨</div>
                <div style="font-size: 14px; color: #1e40af;">${transfer.notes}</div>
              </div>
            ` : ''}
            
            <!-- æ‹’ç»åŸå›  -->
            ${transfer.status === 'rejected' && transfer.rejectionReason ? `
              <div style="background: #fee2e2; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc2626;">
                <div style="font-size: 13px; color: #dc2626; font-weight: 600; margin-bottom: 5px;">æ‹’ç»åŸå› </div>
                <div style="font-size: 14px; color: #dc2626;">${transfer.rejectionReason}</div>
              </div>
            ` : ''}
            
            <!-- å…³é—­æŒ‰é’® -->
            <div style="text-align: center;">
              <button onclick="generateTransferPDF('${transfer._id}')" style="padding: 12px 40px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; margin-right: 10px;">
                ğŸ“„ ç”ŸæˆPDF
              </button>
              <button onclick="closeTransferDetails()" style="padding: 12px 40px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px;">
                å…³é—­
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      } catch (error) {
        console.error('åŠ è½½è°ƒè´§è¯¦æƒ…å¤±è´¥:', error);
        alert('åŠ è½½è°ƒè´§è¯¦æƒ…å¤±è´¥: ' + error.message);
      }
    }
    
    // å…³é—­è°ƒè´§è¯¦æƒ…æ¨¡æ€æ¡†
    function closeTransferDetails() {
      const modal = document.getElementById('transferDetailsModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // ç”Ÿæˆè°ƒè´§PDF
    async function generateTransferPDF(transferId) {
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory/transfer/${transferId}`);
        const result = await response.json();
        
        if (!result.success) {
          alert('åŠ è½½è°ƒè´§è¯¦æƒ…å¤±è´¥: ' + result.error);
          return;
        }
        
        const transfer = result.data;
        const isInternalTransfer = transfer.transferType === 'INTERNAL_TRANSFER';
        
        // å¦‚æœæ˜¯å…¬å¸é—´é”€å”®ï¼Œç”ŸæˆInvoiceæ ¼å¼
        if (!isInternalTransfer) {
          generateInterCompanyInvoicePDF(transfer);
        } else {
          // å¦‚æœæ˜¯å†…éƒ¨è°ƒæ‹¨ï¼Œç”Ÿæˆè°ƒè´§å•æ ¼å¼
          generateInternalTransferPDF(transfer);
        }
      } catch (error) {
        console.error('ç”Ÿæˆè°ƒè´§PDFå¤±è´¥:', error);
        alert('ç”Ÿæˆè°ƒè´§PDFå¤±è´¥: ' + error.message);
      }
    }
    
    // ç”Ÿæˆå…¬å¸é—´é”€å”®Invoice PDF
    function generateInterCompanyInvoicePDF(transfer) {
      const printWindow = window.open('', '_blank');
      
      // è®¡ç®—VAT
      const subtotal = transfer.totalAmount;
      const vatRate = 0.23;
      const vatAmount = subtotal * vatRate;
      const totalAmount = subtotal + vatAmount;
      
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Invoice - ${transfer.transferNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; }
            .header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
            .company-info { flex: 1; }
            .invoice-info { text-align: right; }
            .section-title { font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 14px; color: #666; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
            th { background-color: #f8f9fa; font-weight: bold; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .total-section { margin-top: 30px; float: right; width: 300px; }
            .total-row { display: flex; justify-content: space-between; padding: 8px 0; }
            .total-row.final { border-top: 2px solid #333; font-weight: bold; font-size: 18px; margin-top: 10px; padding-top: 10px; }
            @media print {
              body { padding: 20px; }
              button { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="company-info">
              <h1 style="margin: 0 0 10px 0;">${transfer.fromCompany?.companyName || transfer.fromMerchant}</h1>
              ${transfer.fromCompany?.address ? `
                <div>${transfer.fromCompany.address.street || ''}</div>
                <div>${transfer.fromCompany.address.city || ''} ${transfer.fromCompany.address.postalCode || ''}</div>
                <div>${transfer.fromCompany.address.country || 'Ireland'}</div>
              ` : ''}
              <div style="margin-top: 10px;">
                ${transfer.fromCompany?.contactPhone ? `<div>Phone: ${transfer.fromCompany.contactPhone}</div>` : ''}
                ${transfer.fromCompany?.contactEmail ? `<div>Email: ${transfer.fromCompany.contactEmail}</div>` : ''}
                ${transfer.fromCompany?.vatNumber ? `<div>VAT Number: ${transfer.fromCompany.vatNumber}</div>` : ''}
              </div>
            </div>
            <div class="invoice-info">
              <h2 style="margin: 0 0 10px 0;">SALES INVOICE</h2>
              <div><strong>Invoice Number:</strong> ${transfer.transferNumber}</div>
              <div><strong>Date:</strong> ${new Date(transfer.createdAt).toLocaleDateString('en-IE')}</div>
              ${transfer.completedAt ? `<div><strong>Completed:</strong> ${new Date(transfer.completedAt).toLocaleDateString('en-IE')}</div>` : ''}
              <div><strong>Status:</strong> ${transfer.status === 'completed' ? 'Completed' : transfer.status}</div>
            </div>
          </div>
          
          <div class="section-title">BILL TO</div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <div><strong>${transfer.toCompany?.companyName || transfer.toMerchant}</strong></div>
            ${transfer.toCompany?.address ? `
              <div>${transfer.toCompany.address.street || ''}</div>
              <div>${transfer.toCompany.address.city || ''} ${transfer.toCompany.address.postalCode || ''}</div>
              <div>${transfer.toCompany.address.country || 'Ireland'}</div>
            ` : ''}
            ${transfer.toCompany?.contactPhone ? `<div>Phone: ${transfer.toCompany.contactPhone}</div>` : ''}
            ${transfer.toCompany?.contactEmail ? `<div>Email: ${transfer.toCompany.contactEmail}</div>` : ''}
            ${transfer.toCompany?.vatNumber ? `<div>VAT Number: ${transfer.toCompany.vatNumber}</div>` : ''}
          </div>
          
          <div class="section-title">ITEMS</div>
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th class="text-center">Serial Number</th>
                <th class="text-center">Condition</th>
                <th class="text-center">Quantity</th>
                <th class="text-right">Unit Price (Excl. VAT)</th>
                <th class="text-right">Total (Excl. VAT)</th>
              </tr>
            </thead>
            <tbody>
              ${transfer.items.map(item => `
                <tr>
                  <td>${item.productName}</td>
                  <td class="text-center" style="font-family: monospace; font-size: 11px;">${item.serialNumber || '-'}</td>
                  <td class="text-center">${item.condition || '-'}</td>
                  <td class="text-center">${item.quantity}</td>
                  <td class="text-right">â‚¬${item.transferPrice.toFixed(2)}</td>
                  <td class="text-right">â‚¬${(item.transferPrice * item.quantity).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div class="total-section">
            <div class="total-row">
              <span>Subtotal (Excl. VAT):</span>
              <span>â‚¬${subtotal.toFixed(2)}</span>
            </div>
            <div class="total-row">
              <span>VAT (23%):</span>
              <span>â‚¬${vatAmount.toFixed(2)}</span>
            </div>
            <div class="total-row final">
              <span>Total Amount (Incl. VAT):</span>
              <span>â‚¬${totalAmount.toFixed(2)}</span>
            </div>
          </div>
          
          ${transfer.notes ? `
            <div style="clear: both; margin-top: 80px;">
              <div class="section-title">NOTES</div>
              <div style="background: #f0f9ff; padding: 15px; border-radius: 5px; border-left: 4px solid #3b82f6;">
                ${transfer.notes}
              </div>
            </div>
          ` : '<div style="clear: both; margin-top: 80px;"></div>'}
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd;">
            <div class="section-title">PAYMENT INFORMATION</div>
            ${transfer.fromCompany?.bankDetails ? `
              <div>IBAN: ${transfer.fromCompany.bankDetails.iban || ''}</div>
              <div>BIC: ${transfer.fromCompany.bankDetails.bic || ''}</div>
              <div>Bank: ${transfer.fromCompany.bankDetails.bankName || ''}</div>
            ` : '<div>Payment details not available</div>'}
          </div>
          
          <div style="margin-top: 40px; text-align: center;">
            <button onclick="window.print()" style="padding: 10px 30px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ğŸ–¨ï¸ Print Invoice
            </button>
            <button onclick="window.close()" style="padding: 10px 30px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">
              Close
            </button>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(html);
      printWindow.document.close();
    }
    
    // ç”Ÿæˆå†…éƒ¨è°ƒæ‹¨PDF
    function generateInternalTransferPDF(transfer) {
      const printWindow = window.open('', '_blank');
      
      // çŠ¶æ€æ˜¾ç¤º
      let statusText = '';
      switch(transfer.status) {
        case 'pending':
          statusText = 'å¾…å®¡æ‰¹';
          break;
        case 'approved':
          statusText = 'å·²æ‰¹å‡†';
          break;
        case 'rejected':
          statusText = 'å·²æ‹’ç»';
          break;
        case 'completed':
          statusText = 'å·²å®Œæˆ';
          break;
      }
      
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>è°ƒè´§å• - ${transfer.transferNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; }
            .header { display: flex; justify-content: space-between; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
            .company-info { flex: 1; }
            .transfer-info { text-align: right; }
            .section-title { font-weight: bold; margin-top: 20px; margin-bottom: 10px; font-size: 14px; color: #666; }
            .party-section { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; margin: 20px 0; }
            .party-box { background: #f8f9fa; padding: 15px; border-radius: 5px; }
            .arrow { text-align: center; font-size: 24px; color: #666; display: flex; align-items: center; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
            th { background-color: #f8f9fa; font-weight: bold; }
            .text-right { text-align: right; }
            .text-center { text-align: center; }
            .total-section { margin-top: 30px; float: right; width: 300px; }
            .total-row { display: flex; justify-content: space-between; padding: 8px 0; }
            .total-row.final { border-top: 2px solid #333; font-weight: bold; font-size: 18px; margin-top: 10px; padding-top: 10px; }
            .badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; }
            .badge-success { background: #d1fae5; color: #065f46; }
            .badge-warning { background: #fef3c7; color: #92400e; }
            .badge-danger { background: #fee2e2; color: #dc2626; }
            .badge-info { background: #dbeafe; color: #1e40af; }
            .notes-box { background: #f0f9ff; padding: 15px; border-radius: 5px; border-left: 4px solid #3b82f6; margin: 20px 0; }
            @media print {
              body { padding: 20px; }
              button { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="company-info">
              <h1 style="margin: 0 0 10px 0;">ğŸ“¦ å†…éƒ¨è°ƒè´§å•</h1>
              <div style="font-size: 14px; color: #666;">Internal Transfer</div>
            </div>
            <div class="transfer-info">
              <h2 style="margin: 0 0 10px 0;">${transfer.transferNumber}</h2>
              <div><strong>çŠ¶æ€:</strong> <span class="badge ${
                transfer.status === 'completed' ? 'badge-success' : 
                transfer.status === 'approved' ? 'badge-info' : 
                transfer.status === 'rejected' ? 'badge-danger' : 'badge-warning'
              }">${statusText}</span></div>
              <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(transfer.createdAt).toLocaleString('zh-CN')}</div>
              ${transfer.completedAt ? `<div><strong>å®Œæˆæ—¶é—´:</strong> ${new Date(transfer.completedAt).toLocaleString('zh-CN')}</div>` : ''}
            </div>
          </div>
          
          <div class="section-title">è°ƒè´§åŒæ–¹</div>
          <div class="party-section">
            <div class="party-box">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è°ƒå‡ºæ–¹</div>
              <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${transfer.fromMerchant}</div>
              ${transfer.fromCompany?.companyName ? `<div style="font-size: 14px; color: #666;">${transfer.fromCompany.companyName}</div>` : ''}
            </div>
            <div class="arrow">â†’</div>
            <div class="party-box">
              <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è°ƒå…¥æ–¹</div>
              <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${transfer.toMerchant}</div>
              ${transfer.toCompany?.companyName ? `<div style="font-size: 14px; color: #666;">${transfer.toCompany.companyName}</div>` : ''}
            </div>
          </div>
          
          <div class="section-title">äº§å“æ¸…å•</div>
          <table>
            <thead>
              <tr>
                <th>äº§å“åç§°</th>
                <th class="text-center">åºåˆ—å·/IMEI</th>
                <th class="text-center">æˆè‰²</th>
                <th class="text-center">æ•°é‡</th>
                <th class="text-right">å•ä»·</th>
                <th class="text-right">å°è®¡</th>
              </tr>
            </thead>
            <tbody>
              ${transfer.items.map(item => `
                <tr>
                  <td>${item.productName}</td>
                  <td class="text-center" style="font-family: monospace; font-size: 11px;">${item.serialNumber || '-'}</td>
                  <td class="text-center">${item.condition || '-'}</td>
                  <td class="text-center">${item.quantity}</td>
                  <td class="text-right">â‚¬${item.transferPrice.toFixed(2)}</td>
                  <td class="text-right">â‚¬${(item.transferPrice * item.quantity).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          <div class="total-section">
            <div class="total-row final">
              <span>æ€»é‡‘é¢:</span>
              <span>â‚¬${transfer.totalAmount.toFixed(2)}</span>
            </div>
          </div>
          
          ${transfer.notes ? `
            <div style="clear: both; margin-top: 80px;">
              <div class="section-title">å¤‡æ³¨</div>
              <div class="notes-box">
                ${transfer.notes}
              </div>
            </div>
          ` : '<div style="clear: both; margin-top: 80px;"></div>'}
          
          ${transfer.status === 'rejected' && transfer.rejectionReason ? `
            <div class="section-title">æ‹’ç»åŸå› </div>
            <div style="background: #fee2e2; padding: 15px; border-radius: 5px; border-left: 4px solid #dc2626; margin: 20px 0;">
              ${transfer.rejectionReason}
            </div>
          ` : ''}
          
          <div style="margin-top: 40px; text-align: center;">
            <button onclick="window.print()" style="padding: 10px 30px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
              ğŸ–¨ï¸ æ‰“å°è°ƒè´§å•
            </button>
            <button onclick="window.close()" style="padding: 10px 30px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">
              å…³é—­
            </button>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(html);
      printWindow.document.close();
    }

    // åˆ‡æ¢ç»Ÿè®¡å¡ç‰‡æ˜¾ç¤º/éšè—
    function toggleStats() {
      const statsGrid = document.querySelector('.stats-grid');
      const btn = document.getElementById('toggleStatsBtn');
      
      if (statsGrid.style.display === 'none') {
        statsGrid.style.display = 'grid';
        btn.textContent = 'ğŸ“ˆ éšè—ç»Ÿè®¡';
      } else {
        statsGrid.style.display = 'none';
        btn.textContent = 'ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡';
      }
    }

    // ç™»å‡ºåŠŸèƒ½ - ä½¿ç”¨AuthGuardç»Ÿä¸€çš„logout
    function logout() {
      AuthGuard.logout();
    }

    // ==================== ä»“åº“è®¢è´§åŠŸèƒ½ ====================
    
    // ä»“åº“è®¢è´§è´­ç‰©è½¦
    let warehouseCart = [];
    
    // åˆ‡æ¢ä»“åº“è®¢è´§æ ‡ç­¾
    function switchWarehouseTab(tab) {
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('.sub-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottom = '3px solid transparent';
        btn.style.color = '#6b7280';
      });
      
      if (tab === 'order') {
        document.getElementById('warehouseOrderTabBtn').classList.add('active');
        document.getElementById('warehouseOrderTabBtn').style.borderBottom = '3px solid #6366f1';
        document.getElementById('warehouseOrderTabBtn').style.color = '#6366f1';
        document.getElementById('warehouseOrderSection').style.display = 'block';
        document.getElementById('warehouseMyOrdersSection').style.display = 'none';
        loadWarehouseProducts(); // ä¿®æ”¹ï¼šè°ƒç”¨æ­£ç¡®çš„å‡½æ•°
      } else if (tab === 'myOrders') {
        document.getElementById('warehouseMyOrdersTabBtn').classList.add('active');
        document.getElementById('warehouseMyOrdersTabBtn').style.borderBottom = '3px solid #6366f1';
        document.getElementById('warehouseMyOrdersTabBtn').style.color = '#6366f1';
        document.getElementById('warehouseOrderSection').style.display = 'none';
        document.getElementById('warehouseMyOrdersSection').style.display = 'block';
        loadMyWarehouseOrders();
      }
    }
    
    // åŠ è½½ä»“åº“äº§å“åˆ†ç±»ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ loadWarehouseProducts ä»£æ›¿ï¼‰
    // æ­¤å‡½æ•°ä¿ç•™ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼Œä½†å®é™…è°ƒç”¨ loadWarehouseProducts
    async function loadWarehouseCategories() {
      console.log('âš ï¸ loadWarehouseCategories å·²åºŸå¼ƒï¼Œè°ƒç”¨ loadWarehouseProducts');
      loadWarehouseProducts();
    }
    
    // æ›´æ–°ä»“åº“è´­ç‰©è½¦æ˜¾ç¤º
    function updateWarehouseCart() {
      const cartCount = warehouseCart.reduce((sum, item) => sum + item.quantity, 0);
      const cartTotal = warehouseCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('warehouseCartCount').textContent = cartCount;
      document.getElementById('warehouseCartTotal').textContent = cartTotal.toFixed(2);
      
      if (warehouseCart.length === 0) {
        document.getElementById('warehouseCartItems').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px 0;">è´­ç‰©è½¦æ˜¯ç©ºçš„</p>';
      } else {
        const html = warehouseCart.map((item, index) => `
          <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #1f2937;">${item.productName}</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="decreaseWarehouseCartQuantity(${index})" style="width: 24px; height: 24px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1;">-</button>
                <span style="min-width: 30px; text-align: center; font-weight: 600;">${item.quantity}</span>
                <button onclick="increaseWarehouseCartQuantity(${index})" style="width: 24px; height: 24px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; line-height: 1;">+</button>
              </div>
              <div>
                <div style="color: #6b7280; font-size: 12px;">â‚¬${item.price.toFixed(2)} Ã— ${item.quantity}</div>
                <div style="font-weight: 600; color: #ef4444;">â‚¬${(item.price * item.quantity).toFixed(2)}</div>
              </div>
            </div>
            <button onclick="removeFromWarehouseCart(${index})" style="width: 100%; margin-top: 8px; padding: 4px; background: #fee2e2; color: #ef4444; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
              ç§»é™¤
            </button>
          </div>
        `).join('');
        
        document.getElementById('warehouseCartItems').innerHTML = html;
      }
    }
    
    // å¢åŠ æ•°é‡
    function increaseWarehouseCartQuantity(index) {
      if (warehouseCart[index].quantity < warehouseCart[index].maxQuantity) {
        warehouseCart[index].quantity++;
        updateWarehouseCart();
      } else {
        alert(`åº“å­˜ä¸è¶³ï¼Œæœ€å¤šå¯è®¢è´­ ${warehouseCart[index].maxQuantity} ä»¶`);
      }
    }
    
    // å‡å°‘æ•°é‡
    function decreaseWarehouseCartQuantity(index) {
      if (warehouseCart[index].quantity > 1) {
        warehouseCart[index].quantity--;
        updateWarehouseCart();
      }
    }
    
    // ä»è´­ç‰©è½¦ç§»é™¤
    function removeFromWarehouseCart(index) {
      warehouseCart.splice(index, 1);
      updateWarehouseCart();
    }
    
    // æ¸…ç©ºè´­ç‰©è½¦
    function clearWarehouseCart() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) {
        warehouseCart = [];
        updateWarehouseCart();
      }
    }
    
    // æäº¤è®¢å•
    function submitWarehouseOrder() {
      if (warehouseCart.length === 0) {
        alert('è´­ç‰©è½¦æ˜¯ç©ºçš„');
        return;
      }
      
      // æ˜¾ç¤ºè®¢å•ç¡®è®¤å¯¹è¯æ¡†
      const itemsHtml = warehouseCart.map(item => `
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
          <span>${item.productName} Ã— ${item.quantity}</span>
          <span style="font-weight: 600;">â‚¬${(item.price * item.quantity).toFixed(2)}</span>
        </div>
      `).join('');
      
      const total = warehouseCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('orderSubmitItems').innerHTML = itemsHtml;
      document.getElementById('orderSubmitTotal').textContent = total.toFixed(2);
      
      const modal = document.getElementById('warehouseOrderSubmitModal');
      modal.style.display = 'flex'; // ä½¿ç”¨ flex å¸ƒå±€å±…ä¸­æ˜¾ç¤º
    }
    
    // åˆ‡æ¢é…é€å­—æ®µ
    function toggleDeliveryFields() {
      const method = document.getElementById('deliveryMethod').value;
      document.getElementById('deliveryAddressSection').style.display = method === 'delivery' ? 'block' : 'none';
      document.getElementById('pickupLocationSection').style.display = method === 'pickup' ? 'block' : 'none';
    }
    
    // é˜²æ­¢é‡å¤æäº¤çš„æ ‡å¿—
    let isSubmittingOrder = false;
    
    // ç¡®è®¤æäº¤è®¢å•
    async function confirmWarehouseOrderSubmit() {
      // é˜²æ­¢é‡å¤æäº¤
      if (isSubmittingOrder) {
        console.log('è®¢å•æ­£åœ¨æäº¤ä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');
        return;
      }
      
      try {
        isSubmittingOrder = true;
        
        // ç¦ç”¨æäº¤æŒ‰é’®
        const submitBtn = document.getElementById('confirmOrderSubmitBtn');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.style.opacity = '0.6';
          submitBtn.style.cursor = 'not-allowed';
          submitBtn.textContent = 'æäº¤ä¸­...';
        }
        
        const deliveryMethod = document.getElementById('deliveryMethod').value;
        const deliveryAddress = document.getElementById('deliveryAddress').value;
        const pickupLocation = document.getElementById('pickupLocation').value;
        const notes = document.getElementById('orderNotes').value;
        
        if (deliveryMethod === 'delivery' && !deliveryAddress.trim()) {
          alert('è¯·è¾“å…¥é…é€åœ°å€');
          return;
        }
        
        const orderData = {
          merchantId,
          items: warehouseCart.map(item => ({
            productId: item.productId,
            quantity: item.quantity
          })),
          deliveryMethod,
          deliveryAddress: deliveryMethod === 'delivery' ? deliveryAddress : '',
          pickupLocation: deliveryMethod === 'pickup' ? pickupLocation : '',
          notes
        };
        
        const response = await fetch(`${API_BASE}/warehouse/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`è®¢å•åˆ›å»ºæˆåŠŸï¼\nè®¢å•å·: ${result.data.orderNumber}\n\nåº“å­˜å·²é¢„ç•™ï¼Œç­‰å¾…ä»“ç®¡å‘˜ç¡®è®¤å‘è´§ã€‚`);
          warehouseCart = [];
          updateWarehouseCart();
          closeWarehouseOrderSubmitModal();
          
          // åˆ·æ–°ä»“åº“äº§å“åˆ—è¡¨ä»¥æ˜¾ç¤ºæ›´æ–°åçš„åº“å­˜
          loadWarehouseProducts();
          
          // åˆ‡æ¢åˆ°æˆ‘çš„è®¢å•æ ‡ç­¾
          switchWarehouseTab('myOrders');
        } else {
          alert('è®¢å•åˆ›å»ºå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('æäº¤è®¢å•å¤±è´¥:', error);
        alert('æäº¤è®¢å•å¤±è´¥');
      } finally {
        // æ¢å¤æäº¤çŠ¶æ€
        isSubmittingOrder = false;
        
        // æ¢å¤æäº¤æŒ‰é’®
        const submitBtn = document.getElementById('confirmOrderSubmitBtn');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
          submitBtn.textContent = 'ç¡®è®¤æäº¤';
        }
      }
    }
    
    // å…³é—­è®¢å•æäº¤å¯¹è¯æ¡†
    function closeWarehouseOrderSubmitModal() {
      document.getElementById('warehouseOrderSubmitModal').style.display = 'none';
      document.getElementById('deliveryAddress').value = '';
      document.getElementById('orderNotes').value = '';
    }
    
    // åŠ è½½æˆ‘çš„è®¢å•
    async function loadMyWarehouseOrders() {
      try {
        const status = document.getElementById('orderStatusFilter').value;
        const url = `${API_BASE}/warehouse/orders/my?merchantId=${merchantId}${status ? '&status=' + status : ''}`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
          if (result.data.length === 0) {
            document.getElementById('myWarehouseOrdersList').innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px 0;">æš‚æ— è®¢å•</p>';
            return;
          }
          
          const html = result.data.map(order => {
            const statusColors = {
              'pending': '#f59e0b',
              'confirmed': '#3b82f6',
              'shipped': '#8b5cf6',
              'completed': '#10b981',
              'cancelled': '#ef4444'
            };
            
            const statusNames = {
              'pending': 'å¾…ç¡®è®¤',
              'confirmed': 'å·²ç¡®è®¤',
              'shipped': 'å·²å‘è´§',
              'completed': 'å·²å®Œæˆ',
              'cancelled': 'å·²å–æ¶ˆ'
            };
            
            return `
              <div style="background: white; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                  <div>
                    <h3 style="margin-bottom: 5px;">è®¢å•å·: ${order.orderNumber}</h3>
                    <p style="color: #6b7280; font-size: 14px;">${new Date(order.orderedAt).toLocaleString('zh-CN')}</p>
                  </div>
                  <span style="padding: 6px 12px; background: ${statusColors[order.status]}; color: white; border-radius: 6px; font-weight: 600;">
                    ${statusNames[order.status]}
                  </span>
                </div>
                
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                  <p style="margin-bottom: 5px;"><strong>äº§å“æ•°é‡:</strong> ${order.items.length} ç§</p>
                  <p style="margin-bottom: 5px;"><strong>æ€»æ•°é‡:</strong> ${order.items.reduce((sum, item) => sum + item.quantity, 0)} ä»¶</p>
                  <p style="margin-bottom: 5px;"><strong>é…é€æ–¹å¼:</strong> ${order.deliveryMethod === 'delivery' ? 'ğŸšš ç‰©æµé…é€' : 'ğŸª åˆ°åº—è‡ªå–'}</p>
                  <p style="font-size: 18px; font-weight: 600; color: #ef4444; margin-top: 10px;">æ€»è®¡: â‚¬${order.totalAmount.toFixed(2)}</p>
                </div>
                
                <button onclick="viewWarehouseOrderDetail('${order._id}')" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                  æŸ¥çœ‹è¯¦æƒ…
                </button>
                ${order.status === 'shipped' ? `
                  <button onclick="confirmReceiveOrder('${order._id}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 10px;">
                    âœ… ç¡®è®¤æ”¶è´§
                  </button>
                ` : ''}
              </div>
            `;
          }).join('');
          
          document.getElementById('myWarehouseOrdersList').innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
        document.getElementById('myWarehouseOrdersList').innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    // æŸ¥çœ‹è®¢å•è¯¦æƒ…
    async function viewWarehouseOrderDetail(orderId) {
      try {
        document.getElementById('warehouseOrderDetailModal').style.display = 'block';
        document.getElementById('orderDetailContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        
        const response = await fetch(`${API_BASE}/warehouse/orders/${orderId}`);
        const result = await response.json();
        
        if (result.success) {
          const order = result.data;
          
          const statusColors = {
            'pending': '#f59e0b',
            'confirmed': '#3b82f6',
            'shipped': '#8b5cf6',
            'completed': '#10b981',
            'cancelled': '#ef4444'
          };
          
          const statusNames = {
            'pending': 'å¾…ç¡®è®¤',
            'confirmed': 'å·²ç¡®è®¤',
            'shipped': 'å·²å‘è´§',
            'completed': 'å·²å®Œæˆ',
            'cancelled': 'å·²å–æ¶ˆ'
          };
          
          const html = `
            <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">è®¢å•å·</p>
                  <p style="font-weight: 600;">${order.orderNumber}</p>
                </div>
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">çŠ¶æ€</p>
                  <span style="padding: 6px 12px; background: ${statusColors[order.status]}; color: white; border-radius: 6px; font-weight: 600;">
                    ${statusNames[order.status]}
                  </span>
                </div>
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">ä¸‹å•æ—¶é—´</p>
                  <p style="font-weight: 600;">${new Date(order.orderedAt).toLocaleString('zh-CN')}</p>
                </div>
                <div>
                  <p style="color: #6b7280; margin-bottom: 5px;">é…é€æ–¹å¼</p>
                  <p style="font-weight: 600;">${order.deliveryMethod === 'delivery' ? 'ğŸšš ç‰©æµé…é€' : 'ğŸª åˆ°åº—è‡ªå–'}</p>
                </div>
                ${order.deliveryAddress ? `
                <div style="grid-column: 1 / -1;">
                  <p style="color: #6b7280; margin-bottom: 5px;">é…é€åœ°å€</p>
                  <p style="font-weight: 600;">${order.deliveryAddress}</p>
                </div>
                ` : ''}
                ${order.notes ? `
                <div style="grid-column: 1 / -1;">
                  <p style="color: #6b7280; margin-bottom: 5px;">å¤‡æ³¨</p>
                  <p style="font-weight: 600;">${order.notes}</p>
                </div>
                ` : ''}
              </div>
            </div>
            
            <h3 style="margin-bottom: 15px;">è®¢å•æ˜ç»†</h3>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
              <thead>
                <tr style="background: #f9fafb;">
                  <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">äº§å“åç§°</th>
                  <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">æ•°é‡</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">å•ä»·</th>
                  <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">å°è®¡</th>
                </tr>
              </thead>
              <tbody>
                ${order.items.map(item => `
                  <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${item.productName}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #e5e7eb;">${item.quantity}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb;">â‚¬${item.wholesalePrice.toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: 600;">â‚¬${item.subtotal.toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" style="padding: 12px; text-align: right; font-weight: 600; font-size: 18px;">æ€»è®¡:</td>
                  <td style="padding: 12px; text-align: right; font-weight: 600; font-size: 18px; color: #ef4444;">â‚¬${order.totalAmount.toFixed(2)}</td>
                </tr>
              </tfoot>
            </table>
            
            ${order.status === 'shipped' ? `
              <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
                <p style="color: #92400e; margin-bottom: 10px;">
                  <strong>âš ï¸ è¯·ç¡®è®¤æ”¶è´§</strong><br>
                  è®¢å•å·²å‘è´§ï¼Œè¯·ç¡®è®¤æ”¶åˆ°è´§ç‰©åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚ç¡®è®¤æ”¶è´§åï¼Œäº§å“å°†è‡ªåŠ¨å…¥åº“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚
                </p>
                <button onclick="confirmReceiveOrder('${order._id}')" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 16px;">
                  âœ… ç¡®è®¤æ”¶è´§
                </button>
              </div>
            ` : ''}
          `;
          
          document.getElementById('orderDetailContent').innerHTML = html;
        }
      } catch (error) {
        console.error('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥:', error);
        document.getElementById('orderDetailContent').innerHTML = '<p style="color: #ef4444;">åŠ è½½å¤±è´¥</p>';
      }
    }
    
    // å…³é—­è®¢å•è¯¦æƒ…å¯¹è¯æ¡†
    function closeWarehouseOrderDetailModal() {
      document.getElementById('warehouseOrderDetailModal').style.display = 'none';
    }
    
    // ç¡®è®¤æ”¶è´§
    async function confirmReceiveOrder(orderId) {
      if (!confirm('ç¡®è®¤å·²æ”¶åˆ°è´§ç‰©ï¼Ÿç¡®è®¤åäº§å“å°†è‡ªåŠ¨å…¥åº“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/warehouse/orders/${orderId}/complete?merchantId=${merchantId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ merchantId: merchantId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… æ”¶è´§ç¡®è®¤æˆåŠŸï¼äº§å“å·²å…¥åº“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚');
          closeWarehouseOrderDetailModal();
          loadMyWarehouseOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
          loadMyInventory(); // åˆ·æ–°åº“å­˜åˆ—è¡¨
        } else {
          alert('âŒ ç¡®è®¤æ”¶è´§å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        console.error('ç¡®è®¤æ”¶è´§å¤±è´¥:', error);
        alert('âŒ ç¡®è®¤æ”¶è´§å¤±è´¥: ' + error.message);
      }
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadMerchantInfo(); // åŠ è½½å•†æˆ·ä¿¡æ¯å’Œæ¬¢è¿æ ‡é¢˜
      loadStats();
      loadCategoryList(); // é»˜è®¤åŠ è½½é”€å”®ä¸šåŠ¡çš„åˆ†ç±»åˆ—è¡¨
      
      // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ¬æœˆï¼‰
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      
      // ç¨åŠ¡æŠ¥è¡¨æ—¥æœŸ
      document.getElementById('taxStartDate').valueAsDate = firstDay;
      document.getElementById('taxEndDate').valueAsDate = now;
      
      // é”€å”®è®°å½•æŸ¥è¯¢æ—¥æœŸ
      document.getElementById('salesStartDate').valueAsDate = firstDay;
      document.getElementById('salesEndDate').valueAsDate = now;
      
      // ç»‘å®šè®¢å•æäº¤æŒ‰é’®äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨è€Œä¸æ˜¯onclickï¼Œé˜²æ­¢é‡å¤æäº¤ï¼‰
      const confirmBtn = document.getElementById('confirmOrderSubmitBtn');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmWarehouseOrderSubmit);
      }
    });
    
  </script>
</body>
</html>
