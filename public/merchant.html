<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹å‘å•†æˆ·ä¸­å¿ƒ - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .logout-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #6366f1;
    }
    
    .tab.active {
      color: #6366f1;
      border-bottom-color: #6366f1;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #6366f1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #4f46e5;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #cfe2ff; color: #084298; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #6366f1;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <h1>ğŸ¢ æ‰¹å‘å•†æˆ·ä¸­å¿ƒ</h1>
        <p>åº“å­˜ç®¡ç† Â· é”€å”®ä¸šåŠ¡ Â· ç¨åŠ¡æŠ¥è¡¨</p>
      </div>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <div class="container">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>æˆ‘çš„åº“å­˜</h3>
        <div class="value" id="myInventory">-</div>
      </div>
      <div class="stat-card">
        <h3>æœ¬æœˆé”€å”®</h3>
        <div class="value" id="monthlySales">-</div>
      </div>
      <div class="stat-card">
        <h3>æœ¬æœˆç»´ä¿®</h3>
        <div class="value" id="monthlyRepairs">-</div>
      </div>
      <div class="stat-card">
        <h3>åº”ç¼´ç¨é¢</h3>
        <div class="value" id="taxDue">-</div>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('sales')">é”€å”®ä¸šåŠ¡</button>
      <button class="tab" onclick="switchTab('repairs')">ç»´ä¿®ä¸šåŠ¡</button>
      <button class="tab" onclick="switchTab('my-inventory')">æˆ‘çš„åº“å­˜</button>
      <button class="tab" onclick="switchTab('warehouse-order')">ä»“åº“è®¢è´§</button>
      <button class="tab" onclick="switchTab('reports')">æŠ¥è¡¨ä¸­å¿ƒ</button>
      <button class="tab" onclick="switchTab('tax-report')">ç¨åŠ¡æŠ¥è¡¨</button>
    </div>

    <!-- é”€å”®ä¸šåŠ¡ -->
    <div id="sales" class="tab-content active">
      <div class="card">
        <h2>é”€å”®ä¸šåŠ¡</h2>
        <p style="color: #666; margin-bottom: 20px;">ä»æ‚¨çš„åº“å­˜ä¸­é€‰æ‹©äº§å“è¿›è¡Œé”€å”®</p>
        
        <!-- é”€å”®è¡¨å• -->
        <div id="salesForm">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <!-- é”€å”®è®°å½•æŸ¥è¯¢ -->
      <div class="card">
        <h2>é”€å”®è®°å½•æŸ¥è¯¢</h2>
        <div class="form-grid" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="salesStartDate">
          </div>
          <div class="form-group">
            <label>ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="salesEndDate">
          </div>
        </div>
        <button class="btn btn-primary" onclick="querySalesRecords()">æŸ¥è¯¢é”€å”®è®°å½•</button>
        
        <div id="salesRecordsTable" style="margin-top: 20px;">
          <p style="text-align: center; color: #999; padding: 20px;">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç‚¹å‡»æŸ¥è¯¢</p>
        </div>
      </div>
    </div>

    <!-- ç»´ä¿®ä¸šåŠ¡ -->
    <div id="repairs" class="tab-content">
      <div class="card">
        <h2>ç»´ä¿®è®°å½•</h2>
        <button class="btn btn-success" onclick="showNewRepairModal()" style="margin-bottom: 15px;">+ æ–°å¢ç»´ä¿®</button>
        <div id="repairsTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æˆ‘çš„åº“å­˜ -->
    <div id="my-inventory" class="tab-content">
      <div class="card">
        <h2>æˆ‘çš„åº“å­˜</h2>
        <div id="inventoryTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ä»“åº“è®¢è´§ -->
    <div id="warehouse-order" class="tab-content">
      <div class="card">
        <h2>ä»ä»“åº“è®¢è´§</h2>
        <p style="color: #666; margin-bottom: 20px;">é€‰æ‹©äº§å“ä»ä»“åº“é‡‡è´­åˆ°æ‚¨çš„åº“å­˜</p>
        <div id="warehouseProducts">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æŠ¥è¡¨ä¸­å¿ƒ -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>åº“å­˜æŠ¥è¡¨</h2>
        <div id="inventoryReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div class="card">
        <h2>é”€å”®æŠ¥è¡¨</h2>
        <div id="salesReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç¨åŠ¡æŠ¥è¡¨ -->
    <div id="tax-report" class="tab-content">
      <div class="card">
        <h2>ç¨åŠ¡æŠ¥è¡¨</h2>
        <div class="form-grid" style="margin-bottom: 20px;">
          <div class="form-group">
            <label>å¼€å§‹æ—¥æœŸ</label>
            <input type="date" id="taxStartDate">
          </div>
          <div class="form-group">
            <label>ç»“æŸæ—¥æœŸ</label>
            <input type="date" id="taxEndDate">
          </div>
        </div>
        <button class="btn btn-primary" onclick="generateTaxReport()">ç”ŸæˆæŠ¥è¡¨</button>
        
        <div id="taxReportContent" style="margin-top: 20px;">
          <div class="loading">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´å¹¶ç”ŸæˆæŠ¥è¡¨</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    const merchantId = 'merchant_001'; // å®é™…åº”ä»ç™»å½•sessionè·å–

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'sales': loadSalesForm(); break;
        case 'repairs': loadRepairs(); break;
        case 'my-inventory': loadMyInventory(); break;
        case 'warehouse-order': loadWarehouseProducts(); break;
        case 'reports': loadReports(); break;
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/merchant/stats?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          document.getElementById('myInventory').textContent = stats.myInventory || 0;
          document.getElementById('monthlySales').textContent = 'â‚¬' + (stats.monthlySales || 0).toFixed(2);
          document.getElementById('monthlyRepairs').textContent = 'â‚¬' + (stats.monthlyRepairs || 0).toFixed(2);
          document.getElementById('taxDue').textContent = 'â‚¬' + (stats.taxDue || 0).toFixed(2);
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }

    // åŠ è½½é”€å”®ä¸šåŠ¡è¡¨å•
    async function loadSalesForm() {
      const container = document.getElementById('salesForm');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>ç±»åˆ«</th>
                  <th>å“ç‰Œ/å‹å·</th>
                  <th>åº“å­˜æ•°é‡</th>
                  <th>é›¶å”®ä»·</th>
                  <th>ç¨åŠ¡åˆ†ç±»</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(item => `
                  <tr>
                    <td><strong>${item.productName}</strong></td>
                    <td>${getCategoryBadge(item.category)}</td>
                    <td>${item.brand || '-'} ${item.model || ''}</td>
                    <td><strong>${item.quantity}</strong></td>
                    <td>â‚¬${item.retailPrice.toFixed(2)}</td>
                    <td>${getTaxBadge(item.taxClassification)}</td>
                    <td>${getStatusBadge(item.status)}</td>
                    <td>
                      <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" 
                        onclick="sellProduct('${item._id}', '${item.productName}', ${item.quantity}, ${item.retailPrice})"
                        ${item.quantity === 0 ? 'disabled' : ''}>
                        é”€å”®
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
              <h3 style="color: #856404; margin-bottom: 10px;">ğŸ“¦ æš‚æ— åº“å­˜</h3>
              <p style="color: #856404; margin: 0;">
                æ‚¨çš„åº“å­˜ä¸ºç©ºï¼Œè¯·å…ˆå‰å¾€"ä»“åº“è®¢è´§"é¡µé¢é‡‡è´­äº§å“ã€‚
              </p>
            </div>
          `;
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // æŸ¥è¯¢é”€å”®è®°å½•
    async function querySalesRecords() {
      const startDate = document.getElementById('salesStartDate').value;
      const endDate = document.getElementById('salesEndDate').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
      }
      
      const container = document.getElementById('salesRecordsTable');
      container.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          // è¿‡æ»¤æ—¥æœŸèŒƒå›´å†…çš„è®°å½•
          const filteredData = result.data.filter(sale => {
            const saleDate = new Date(sale.date);
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // åŒ…å«ç»“æŸæ—¥æœŸçš„å…¨å¤©
            return saleDate >= start && saleDate <= end;
          });
          
          if (filteredData.length > 0) {
            const html = `
              <table>
                <thead>
                  <tr>
                    <th>æ—¥æœŸ</th>
                    <th>äº§å“</th>
                    <th>ç±»åˆ«</th>
                    <th>æ•°é‡</th>
                    <th>é”€å”®é¢</th>
                    <th>æˆæœ¬</th>
                    <th>ç¨é¢</th>
                    <th>æ”¯ä»˜æ–¹å¼</th>
                  </tr>
                </thead>
                <tbody>
                  ${filteredData.map(sale => `
                    <tr>
                      <td>${new Date(sale.date).toLocaleDateString('zh-CN')}</td>
                      <td>${sale.productName}</td>
                      <td>${getCategoryBadge(sale.category)}</td>
                      <td>${sale.quantity}</td>
                      <td>â‚¬${(sale.salePrice * sale.quantity).toFixed(2)}</td>
                      <td>â‚¬${(sale.costPrice * sale.quantity).toFixed(2)}</td>
                      <td>â‚¬${sale.taxAmount.toFixed(2)}</td>
                      <td>${getPaymentBadge(sale.paymentMethod)}</td>
                    </tr>
                  `).join('')}
                  <tr style="font-weight: bold; background: #f8f9fa;">
                    <td colspan="4" style="text-align: right;">åˆè®¡ï¼š</td>
                    <td>â‚¬${filteredData.reduce((sum, s) => sum + (s.salePrice * s.quantity), 0).toFixed(2)}</td>
                    <td>â‚¬${filteredData.reduce((sum, s) => sum + (s.costPrice * s.quantity), 0).toFixed(2)}</td>
                    <td>â‚¬${filteredData.reduce((sum, s) => sum + s.taxAmount, 0).toFixed(2)}</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>
              <p style="text-align: center; color: #666; margin-top: 10px;">
                å…±æ‰¾åˆ° ${filteredData.length} æ¡é”€å”®è®°å½•
              </p>
            `;
            container.innerHTML = html;
          } else {
            container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®è®°å½•</p>';
          }
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®è®°å½•</p>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">æŸ¥è¯¢å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½æˆ‘çš„åº“å­˜
    async function loadMyInventory() {
      const container = document.getElementById('inventoryTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/inventory?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>ç±»åˆ«</th>
                  <th>å“ç‰Œ/å‹å·</th>
                  <th>åº“å­˜æ•°é‡</th>
                  <th>æˆæœ¬ä»·</th>
                  <th>é›¶å”®ä»·</th>
                  <th>ç¨åŠ¡åˆ†ç±»</th>
                  <th>çŠ¶æ€</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(item => `
                  <tr>
                    <td><strong>${item.productName}</strong></td>
                    <td>${getCategoryBadge(item.category)}</td>
                    <td>${item.brand || '-'} ${item.model || ''}</td>
                    <td><strong>${item.quantity}</strong></td>
                    <td>â‚¬${item.costPrice.toFixed(2)}</td>
                    <td>â‚¬${item.retailPrice.toFixed(2)}</td>
                    <td>${getTaxBadge(item.taxClassification)}</td>
                    <td>${getStatusBadge(item.status)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
              <h3 style="color: #856404; margin-bottom: 10px;">ğŸ“¦ æ‰¹å‘å•†ç‹¬ç«‹åº“å­˜ç³»ç»Ÿ</h3>
              <p style="color: #856404; margin: 0;">
                è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯æ‚¨ä½œä¸ºæ‰¹å‘å•†åœ¨è‡ªå·±åº—é“ºä¸­çš„åº“å­˜ï¼Œä¸ä»“åº“åº“å­˜æ˜¯ç‹¬ç«‹ç®¡ç†çš„ã€‚<br>
                æ‚¨å¯ä»¥é€šè¿‡"ä»“åº“è®¢è´§"åŠŸèƒ½ä»ä»“åº“é‡‡è´­äº§å“åˆ°æ‚¨çš„åº“å­˜ä¸­ã€‚
              </p>
            </div>
            <p style="text-align: center; color: #999; padding: 40px;">
              æš‚æ— åº“å­˜æ•°æ®<br>
              <small>è¯·å‰å¾€"ä»“åº“è®¢è´§"é¡µé¢é‡‡è´­äº§å“</small>
            </p>
          `;
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½ä»“åº“äº§å“
    async function loadWarehouseProducts() {
      const container = document.getElementById('warehouseProducts');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/warehouse-products`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 20px;">
              <h3 style="color: #0c5460; margin-bottom: 10px;">ğŸ­ ä»ä»“åº“è®¢è´§</h3>
              <p style="color: #0c5460; margin: 0;">
                ä»¥ä¸‹æ˜¯ä»“åº“ä¸­å¯ä¾›é‡‡è´­çš„äº§å“ã€‚é€‰æ‹©äº§å“å¹¶è¾“å…¥æ•°é‡åç‚¹å‡»"è®¢è´§"æŒ‰é’®ã€‚<br>
                è®¢å•ç¡®è®¤åï¼Œäº§å“å°†ä»ä»“åº“è½¬ç§»åˆ°æ‚¨çš„æ‰¹å‘å•†åº“å­˜ä¸­ã€‚
              </p>
            </div>
            <table>
              <thead>
                <tr>
                  <th>äº§å“ç±»å‹</th>
                  <th>ç±»åˆ«</th>
                  <th>å“ç‰Œ/å‹å·</th>
                  <th>å¯ç”¨æ•°é‡</th>
                  <th>æ‰¹å‘ä»·</th>
                  <th>å»ºè®®é›¶å”®ä»·</th>
                  <th>ç¨åŠ¡åˆ†ç±»</th>
                  <th>è®¢è´§æ•°é‡</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map((group, index) => `
                  <tr>
                    <td><strong>${group.productType}</strong></td>
                    <td>${getCategoryBadge(group.category)}</td>
                    <td>${group.brand || '-'} ${group.model || ''}</td>
                    <td><strong>${group.totalAvailable}</strong></td>
                    <td>â‚¬${group.wholesalePrice.toFixed(2)}</td>
                    <td>â‚¬${group.suggestedRetailPrice.toFixed(2)}</td>
                    <td>${getTaxBadge(group.taxClassification)}</td>
                    <td>
                      <input type="number" id="orderQty_${index}" min="1" max="${group.totalAvailable}" 
                        value="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                    </td>
                    <td>
                      <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" 
                        onclick="orderFromWarehouse(${index}, '${group.products[0]._id}', '${group.productType}', ${group.category === 'ACCESSORY' ? group.totalAvailable : 1})">
                        è®¢è´§
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <p style="color: #999; text-align: center; padding: 40px;">
              ä»“åº“æš‚æ— å¯è®¢è´­äº§å“
            </p>
          `;
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½é”€å”®è®°å½•
    async function loadSales() {
      const container = document.getElementById('salesTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sales?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>äº§å“</th>
                  <th>ç±»åˆ«</th>
                  <th>æ•°é‡</th>
                  <th>é”€å”®é¢</th>
                  <th>æˆæœ¬</th>
                  <th>ç¨é¢</th>
                  <th>æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.slice(0, 50).map(sale => `
                  <tr>
                    <td>${new Date(sale.date).toLocaleDateString('zh-CN')}</td>
                    <td>${sale.productName}</td>
                    <td>${getCategoryBadge(sale.category)}</td>
                    <td>${sale.quantity}</td>
                    <td>â‚¬${(sale.salePrice * sale.quantity).toFixed(2)}</td>
                    <td>â‚¬${(sale.costPrice * sale.quantity).toFixed(2)}</td>
                    <td>â‚¬${sale.taxAmount.toFixed(2)}</td>
                    <td>${getPaymentBadge(sale.paymentMethod)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${result.data.length > 50 ? `<p style="text-align: center; color: #666; margin-top: 10px;">æ˜¾ç¤ºæœ€è¿‘50æ¡è®°å½•ï¼Œå…±${result.data.length}æ¡</p>` : ''}
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— é”€å”®è®°å½•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½ç»´ä¿®è®°å½•
    async function loadRepairs() {
      const container = document.getElementById('repairsTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/merchant/repairs?merchantId=${merchantId}`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>å®¢æˆ·</th>
                  <th>ç»´ä¿®é¡¹ç›®</th>
                  <th>é‡‘é¢</th>
                  <th>ç¨é¢</th>
                  <th>æ”¯ä»˜æ–¹å¼</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.slice(0, 50).map(repair => `
                  <tr>
                    <td>${new Date(repair.date).toLocaleDateString('zh-CN')}</td>
                    <td>${repair.customerName}</td>
                    <td>${repair.repairItem}</td>
                    <td>â‚¬${repair.amount.toFixed(2)}</td>
                    <td>â‚¬${repair.taxAmount.toFixed(2)}</td>
                    <td>${getPaymentBadge(repair.paymentMethod)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${result.data.length > 50 ? `<p style="text-align: center; color: #666; margin-top: 10px;">æ˜¾ç¤ºæœ€è¿‘50æ¡è®°å½•ï¼Œå…±${result.data.length}æ¡</p>` : ''}
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="loading">æš‚æ— ç»´ä¿®è®°å½•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½æŠ¥è¡¨
    function loadReports() {
      document.getElementById('inventoryReport').innerHTML = `
        <p style="color: #999; text-align: center; padding: 20px;">åº“å­˜æŠ¥è¡¨åŠŸèƒ½å¼€å‘ä¸­...</p>
      `;
      document.getElementById('salesReport').innerHTML = `
        <p style="color: #999; text-align: center; padding: 20px;">é”€å”®æŠ¥è¡¨åŠŸèƒ½å¼€å‘ä¸­...</p>
      `;
    }

    // ç”Ÿæˆç¨åŠ¡æŠ¥è¡¨
    async function generateTaxReport() {
      const startDate = document.getElementById('taxStartDate').value;
      const endDate = document.getElementById('taxEndDate').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
        return;
      }
      
      const container = document.getElementById('taxReportContent');
      container.innerHTML = '<div class="loading">ç”ŸæˆæŠ¥è¡¨ä¸­...</div>';
      
      try {
        const response = await fetch(
          `${API_BASE}/merchant/tax-report?merchantId=${merchantId}&startDate=${startDate}&endDate=${endDate}`
        );
        const result = await response.json();
        
        if (result.success) {
          const data = result.data;
          const { dailySales, summary, taxByClassification } = data;
          
          // ç”Ÿæˆæ—¥é”€å”®è¡¨æ ¼
          const dailyTable = dailySales.length > 0 ? `
            <table style="margin-bottom: 30px;">
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  <th>é”€å”®é¢</th>
                  <th>ç°é‡‘æ”¶å…¥</th>
                  <th>åˆ·å¡æ”¶å…¥</th>
                </tr>
              </thead>
              <tbody>
                ${dailySales.map(day => `
                  <tr>
                    <td>${new Date(day.date).toLocaleDateString('zh-CN')}</td>
                    <td>â‚¬${day.totalSales.toFixed(2)}</td>
                    <td>â‚¬${day.cashIncome.toFixed(2)}</td>
                    <td>â‚¬${day.cardIncome.toFixed(2)}</td>
                  </tr>
                `).join('')}
                <tr style="font-weight: bold; background: #e9ecef;">
                  <td>åˆè®¡</td>
                  <td>â‚¬${summary.totalSales.toFixed(2)}</td>
                  <td>â‚¬${summary.totalCashIncome.toFixed(2)}</td>
                  <td>â‚¬${summary.totalCardIncome.toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
          ` : '<p style="color: #999; text-align: center; padding: 20px;">è¯¥æ—¶é—´æ®µå†…æ— é”€å”®æ•°æ®</p>';
          
          container.innerHTML = `
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
              <h3 style="margin-bottom: 20px;">ç¨åŠ¡æŠ¥è¡¨ (${startDate} è‡³ ${endDate})</h3>
              
              ${dailyTable}
              
              <h4 style="margin: 20px 0 10px 0;">ç¨åŠ¡è®¡ç®—æ˜ç»†</h4>
              <table>
                <thead>
                  <tr>
                    <th>ç¨åŠ¡åˆ†ç±»</th>
                    <th>é”€å”®é¢</th>
                    <th>é”€é¡¹ç¨</th>
                    <th>æˆæœ¬</th>
                    <th>è¿›é¡¹ç¨</th>
                    <th>åº”ç¼´ç¨é¢</th>
                  </tr>
                </thead>
                <tbody>
                  ${taxByClassification.VAT_23.sales > 0 ? `
                    <tr>
                      <td>VAT 23%</td>
                      <td>â‚¬${taxByClassification.VAT_23.sales.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.VAT_23.outputTax.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.VAT_23.cost.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.VAT_23.inputTax.toFixed(2)}</td>
                      <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.VAT_23.due.toFixed(2)}</td>
                    </tr>
                  ` : ''}
                  ${taxByClassification.SERVICE_VAT_13_5.sales > 0 ? `
                    <tr>
                      <td>Service VAT 13.5%</td>
                      <td>â‚¬${taxByClassification.SERVICE_VAT_13_5.sales.toFixed(2)}</td>
                      <td>â‚¬${taxByClassification.SERVICE_VAT_13_5.due.toFixed(2)}</td>
                      <td>-</td>
                      <td>-</td>
                      <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.SERVICE_VAT_13_5.due.toFixed(2)}</td>
                    </tr>
                  ` : ''}
                  ${taxByClassification.MARGIN_VAT_0.sales > 0 ? `
                    <tr>
                      <td>Margin VAT</td>
                      <td>â‚¬${taxByClassification.MARGIN_VAT_0.sales.toFixed(2)}</td>
                      <td>-</td>
                      <td>â‚¬${taxByClassification.MARGIN_VAT_0.cost.toFixed(2)}</td>
                      <td>-</td>
                      <td style="color: #dc3545; font-weight: bold;">â‚¬${taxByClassification.MARGIN_VAT_0.due.toFixed(2)}</td>
                    </tr>
                  ` : ''}
                  <tr style="font-weight: bold; background: #fff3cd;">
                    <td colspan="5" style="text-align: right;">æ€»åº”ç¼´ç¨é¢ï¼š</td>
                    <td style="color: #dc3545; font-size: 18px;">â‚¬${summary.totalTaxDue.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
              
              <div style="margin-top: 20px; padding: 15px; background: white; border-left: 4px solid #6366f1;">
                <p style="margin: 0; color: #666;">
                  <strong>è®¡ç®—è¯´æ˜ï¼š</strong><br>
                  â€¢ VAT 23%: é”€é¡¹ç¨ = é”€å”®é¢Ã—23/123, è¿›é¡¹ç¨ = æˆæœ¬Ã—23/123, åº”ç¼´ = é”€é¡¹ç¨ - è¿›é¡¹ç¨<br>
                  â€¢ Service VAT 13.5%: åº”ç¼´ç¨ = é‡‘é¢Ã—13.5/113.5<br>
                  â€¢ Margin VAT: åº”ç¼´ç¨ = (é”€å”®é¢ - æˆæœ¬)Ã—23/123
                </p>
              </div>
            </div>
          `;
          
          if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">ç”ŸæˆæŠ¥è¡¨å¤±è´¥: ${error.message}</div>`;
      }
    }
    
    // è¾…åŠ©å‡½æ•°
    function getCategoryBadge(category) {
      const badges = {
        'NEW_DEVICE': '<span class="badge badge-success">å…¨æ–°è®¾å¤‡</span>',
        'USED_DEVICE': '<span class="badge badge-warning">äºŒæ‰‹è®¾å¤‡</span>',
        'ACCESSORY': '<span class="badge badge-info">é…ä»¶</span>'
      };
      return badges[category] || category;
    }
    
    function getPaymentBadge(method) {
      const badges = {
        'CASH': '<span class="badge badge-info">ç°é‡‘</span>',
        'CARD': '<span class="badge badge-primary">åˆ·å¡</span>'
      };
      return badges[method] || method;
    }
    
    function getTaxBadge(tax) {
      const badges = {
        'VAT_23': '<span class="badge badge-primary">VAT 23%</span>',
        'MARGIN_VAT_0': '<span class="badge badge-info">Margin VAT</span>',
        'SERVICE_VAT_13_5': '<span class="badge badge-warning">Service 13.5%</span>'
      };
      return badges[tax] || tax;
    }
    
    function getStatusBadge(status) {
      const badges = {
        'ACTIVE': '<span class="badge badge-success">æ­£å¸¸</span>',
        'LOW_STOCK': '<span class="badge badge-warning">åº“å­˜ä½</span>',
        'OUT_OF_STOCK': '<span class="badge badge-danger">ç¼ºè´§</span>'
      };
      return badges[status] || status;
    }
    
    // ä»ä»“åº“è®¢è´§
    async function orderFromWarehouse(index, productId, productName, maxQty) {
      const qtyInput = document.getElementById(`orderQty_${index}`);
      const quantity = parseInt(qtyInput.value);
      
      if (!quantity || quantity < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢è´§æ•°é‡');
        return;
      }
      
      if (quantity > maxQty) {
        alert(`è®¢è´§æ•°é‡ä¸èƒ½è¶…è¿‡å¯ç”¨æ•°é‡ ${maxQty}`);
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦è®¢è´­ ${quantity} ä»¶ ${productName} å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        // åˆ›å»ºè®¢å•
        const orderResponse = await fetch(`${API_BASE}/merchant/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId,
            merchantName: 'VIPå•†æˆ·', // å®é™…åº”ä»sessionè·å–
            items: [{
              productId,
              quantity
            }]
          })
        });
        
        const orderResult = await orderResponse.json();
        
        if (!orderResult.success) {
          alert('è®¢å•åˆ›å»ºå¤±è´¥: ' + orderResult.error);
          return;
        }
        
        // è‡ªåŠ¨ç¡®è®¤è®¢å•
        const confirmResponse = await fetch(`${API_BASE}/merchant/orders/${orderResult.data._id}/confirm`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const confirmResult = await confirmResponse.json();
        
        if (confirmResult.success) {
          alert(`è®¢è´§æˆåŠŸï¼å·²å°† ${quantity} ä»¶ ${productName} æ·»åŠ åˆ°æ‚¨çš„åº“å­˜`);
          // åˆ·æ–°é¡µé¢æ•°æ®
          loadWarehouseProducts();
          loadStats();
        } else {
          alert('è®¢å•ç¡®è®¤å¤±è´¥: ' + confirmResult.error);
        }
      } catch (error) {
        alert('è®¢è´§å¤±è´¥: ' + error.message);
      }
    }
    
    // é”€å”®äº§å“
    async function sellProduct(inventoryId, productName, availableQty, retailPrice) {
      const quantity = prompt(`è¯·è¾“å…¥é”€å”®æ•°é‡ï¼ˆå¯ç”¨: ${availableQty}ï¼‰:`, '1');
      
      if (!quantity) return;
      
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      if (qty > availableQty) {
        alert(`é”€å”®æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜æ•°é‡ ${availableQty}`);
        return;
      }
      
      const paymentMethod = confirm('æ”¯ä»˜æ–¹å¼ï¼š\nç¡®å®š = åˆ·å¡\nå–æ¶ˆ = ç°é‡‘') ? 'CARD' : 'CASH';
      
      const totalAmount = (qty * retailPrice).toFixed(2);
      
      if (!confirm(`ç¡®è®¤é”€å”®ï¼š\näº§å“: ${productName}\næ•°é‡: ${qty}\nå•ä»·: â‚¬${retailPrice.toFixed(2)}\næ€»é¢: â‚¬${totalAmount}\næ”¯ä»˜: ${paymentMethod === 'CARD' ? 'åˆ·å¡' : 'ç°é‡‘'}`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/merchant/sell`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId,
            inventoryId,
            quantity: qty,
            paymentMethod
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`é”€å”®æˆåŠŸï¼\nå‰©ä½™åº“å­˜: ${result.data.remainingStock}`);
          // åˆ·æ–°åº“å­˜åˆ—è¡¨
          loadMyInventory();
          loadStats();
        } else {
          alert('é”€å”®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('é”€å”®å¤±è´¥: ' + error.message);
      }
    }

    // å ä½å‡½æ•°
    function showNewRepairModal() {
      alert('æ–°å¢ç»´ä¿®åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // ç™»å‡ºåŠŸèƒ½ - ä½¿ç”¨AuthGuardç»Ÿä¸€çš„logout
    function logout() {
      AuthGuard.logout();
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadSalesForm(); // é»˜è®¤åŠ è½½é”€å”®ä¸šåŠ¡é¡µé¢
      
      // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ¬æœˆï¼‰
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      
      // ç¨åŠ¡æŠ¥è¡¨æ—¥æœŸ
      document.getElementById('taxStartDate').valueAsDate = firstDay;
      document.getElementById('taxEndDate').valueAsDate = now;
      
      // é”€å”®è®°å½•æŸ¥è¯¢æ—¥æœŸ
      document.getElementById('salesStartDate').valueAsDate = firstDay;
      document.getElementById('salesEndDate').valueAsDate = now;
    });
  </script>
</body>
</html>
