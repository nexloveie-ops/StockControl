<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é”€å”®ç®¡ç† - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header .nav {
      margin-top: 10px;
    }
    
    .header .nav a {
      color: white;
      text-decoration: none;
      margin-right: 20px;
      opacity: 0.9;
    }
    
    .header .nav a:hover {
      opacity: 1;
      text-decoration: underline;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .sales-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-box {
      margin-bottom: 20px;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
    }
    
    .product-card {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .product-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    .product-card.selected {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .product-card h3 {
      font-size: 16px;
      margin-bottom: 8px;
      color: #333;
    }
    
    .product-card .price {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }
    
    .product-card .info {
      font-size: 12px;
      color: #666;
      margin: 5px 0;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-primary { background: #cfe2ff; color: #084298; }
    
    .cart-section {
      position: sticky;
      top: 20px;
    }
    
    .customer-select {
      margin-bottom: 20px;
    }
    
    .customer-select select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .cart-items {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .cart-item-info {
      flex: 1;
    }
    
    .cart-item-name {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .cart-item-price {
      color: #666;
      font-size: 14px;
    }
    
    .cart-item-qty {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .qty-btn {
      width: 30px;
      height: 30px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .qty-btn:hover {
      background: #f0f0f0;
    }
    
    .qty-input {
      width: 50px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
    }
    
    .remove-btn {
      color: #dc3545;
      cursor: pointer;
      padding: 5px 10px;
      border: none;
      background: none;
      font-size: 18px;
    }
    
    .cart-summary {
      border-top: 2px solid #e0e0e0;
      padding-top: 15px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .summary-row.total {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
    }
    
    .discount-input {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    
    .discount-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .empty-cart {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }
    
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h3 {
      margin-bottom: 20px;
      color: #28a745;
    }
    
    .modal-content p {
      margin-bottom: 20px;
      color: #666;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>ğŸ›’ é”€å”®ç®¡ç†</h1>
        <div class="nav">
          <a href="/prototype.html">â† è¿”å›ä¸»é¡µ</a>
          <a href="/sales.html">é”€å”®</a>
        </div>
      </div>
      <button onclick="logout()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 5px; cursor: pointer; font-weight: 600;">
        é€€å‡ºç™»å½•
      </button>
    </div>
  </div>

  <div class="container">
    <div id="alertContainer"></div>
    
    <div class="sales-layout">
      <!-- äº§å“é€‰æ‹©åŒº -->
      <div class="card">
        <h2>ğŸ“¦ é€‰æ‹©äº§å“</h2>
        
        <!-- åˆ†ç»„è§†å›¾ -->
        <div id="groupView" style="display: block;">
          <div class="search-box">
            <input type="text" id="groupSearch" placeholder="æœç´¢äº§å“åˆ†ç»„...">
          </div>
          <div class="product-grid" id="groupGrid">
            <div class="loading">åŠ è½½äº§å“åˆ†ç»„ä¸­...</div>
          </div>
        </div>
        
        <!-- äº§å“åˆ—è¡¨è§†å›¾ -->
        <div id="productListView" style="display: none;">
          <div style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="backToGroups()" style="width: auto; padding: 10px 20px;">
              â† è¿”å›åˆ†ç»„
            </button>
            <span id="currentGroupTitle" style="margin-left: 15px; font-size: 18px; font-weight: 600;"></span>
          </div>
          <div class="search-box">
            <input type="text" id="productSearch" placeholder="æœç´¢äº§å“åç§°ã€æ¡ç ã€åºåˆ—å·...">
          </div>
          <div class="product-grid" id="productGrid">
            <div class="loading">åŠ è½½äº§å“ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- è´­ç‰©è½¦åŒº -->
      <div class="cart-section">
        <div class="card">
          <h2>ğŸ›ï¸ è´­ç‰©è½¦</h2>
          
          <div class="customer-select">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">é€‰æ‹©å®¢æˆ·</label>
            <select id="customerSelect">
              <option value="">-- é€‰æ‹©å®¢æˆ· --</option>
            </select>
          </div>
          
          <div class="cart-items" id="cartItems">
            <div class="empty-cart">è´­ç‰©è½¦ä¸ºç©º<br>è¯·é€‰æ‹©äº§å“</div>
          </div>
          
          <div class="cart-summary" id="cartSummary" style="display: none;">
            <div class="summary-row">
              <span>å°è®¡:</span>
              <span id="subtotal">â‚¬0.00</span>
            </div>
            
            <div class="discount-input">
              <input type="number" id="discountPercent" placeholder="æŠ˜æ‰£ %" min="0" max="100" value="0">
              <span style="line-height: 35px;">%</span>
            </div>
            
            <div class="summary-row">
              <span>æŠ˜æ‰£:</span>
              <span id="discountAmount">-â‚¬0.00</span>
            </div>
            
            <div class="summary-row">
              <span>ç¨é¢:</span>
              <span id="taxAmount">â‚¬0.00</span>
            </div>
            
            <div class="summary-row total">
              <span>æ€»è®¡:</span>
              <span id="totalAmount">â‚¬0.00</span>
            </div>
          </div>
          
          <button class="btn btn-primary" id="createInvoiceBtn" disabled>åˆ›å»ºå‘ç¥¨</button>
          <button class="btn btn-success" id="finalizeBtn" style="display: none;">ç¡®å®šå¹¶ç”ŸæˆPDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æˆåŠŸæ¨¡æ€æ¡† -->
  <div class="modal" id="successModal">
    <div class="modal-content">
      <h3>âœ… å‘ç¥¨åˆ›å»ºæˆåŠŸï¼</h3>
      <p>å‘ç¥¨å·: <strong id="invoiceNumber"></strong></p>
      <p>æ‚¨å¯ä»¥é€‰æ‹©ç¡®å®šå‘ç¥¨ï¼ˆæ›´æ–°åº“å­˜ï¼‰å¹¶ä¸‹è½½PDF</p>
      <div class="modal-actions">
        <button class="btn btn-success" id="finalizeAndDownloadBtn">ç¡®å®šå¹¶ä¸‹è½½PDF</button>
        <button class="btn btn-primary" id="closeModalBtn">ç¨åå¤„ç†</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let products = [];
    let productGroups = [];
    let currentGroupProducts = [];
    let customers = [];
    let cart = [];
    let selectedCustomer = null;
    let currentInvoiceId = null;

    // åŠ è½½äº§å“åˆ†ç»„
    async function loadProductGroups() {
      try {
        const response = await fetch(`${API_BASE}/products/groups`);
        const result = await response.json();
        
        if (result.success) {
          productGroups = result.data.filter(g => g.availableStock > 0);
          renderProductGroups(productGroups);
        }
      } catch (error) {
        showAlert('åŠ è½½äº§å“åˆ†ç»„å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ¸²æŸ“äº§å“åˆ†ç»„
    function renderProductGroups(groups) {
      const grid = document.getElementById('groupGrid');
      
      if (groups.length === 0) {
        grid.innerHTML = '<div class="empty-cart">æš‚æ— å¯ç”¨äº§å“</div>';
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        return;
      }
      
      grid.innerHTML = groups.map(g => {
        const categoryClass = g.category === 'ACCESSORY' ? 'info' : 
                             g.category === 'NEW_DEVICE' ? 'success' : 'warning';
        const categoryText = g.category === 'ACCESSORY' ? 'é…ä»¶' : 
                            g.category === 'NEW_DEVICE' ? 'å…¨æ–°è®¾å¤‡' : 'äºŒæ‰‹è®¾å¤‡';
        
        return `
          <div class="product-card" onclick="showGroupProducts('${g.productType}', '${g.category}')">
            <h3>${g.productType}</h3>
            <div class="info">
              <span class="badge badge-${categoryClass}">${categoryText}</span>
              <span class="badge badge-info">åº“å­˜: ${g.availableStock}</span>
            </div>
            <div class="price">â‚¬${g.avgRetailPrice.toFixed(2)}</div>
            <div class="info">${g.productCount} ä¸ªäº§å“</div>
          </div>
        `;
      }).join('');
      
      // ç¿»è¯‘åŠ¨æ€å†…å®¹
      if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
    }

    // æ˜¾ç¤ºåˆ†ç»„ä¸‹çš„äº§å“
    async function showGroupProducts(productType, category) {
      try {
        const response = await fetch(
          `${API_BASE}/products/group-details?productType=${encodeURIComponent(productType)}&category=${category}`
        );
        const result = await response.json();
        
        if (result.success) {
          currentGroupProducts = result.data.products.filter(p => p.status === 'AVAILABLE');
          
          // åˆ‡æ¢è§†å›¾
          document.getElementById('groupView').style.display = 'none';
          document.getElementById('productListView').style.display = 'block';
          document.getElementById('currentGroupTitle').textContent = productType;
          
          renderProducts(currentGroupProducts);
        }
      } catch (error) {
        showAlert('åŠ è½½äº§å“å¤±è´¥: ' + error.message, 'error');
      }
    }

    // è¿”å›åˆ†ç»„è§†å›¾
    function backToGroups() {
      document.getElementById('groupView').style.display = 'block';
      document.getElementById('productListView').style.display = 'none';
      currentGroupProducts = [];
    }

    // åŠ è½½äº§å“ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
    async function loadProducts() {
      try {
        const response = await fetch(`${API_BASE}/sales/available-products`);
        const result = await response.json();
        
        if (result.success) {
          products = result.data;
        }
      } catch (error) {
        showAlert('åŠ è½½äº§å“å¤±è´¥: ' + error.message, 'error');
      }
    }

    // åŠ è½½å®¢æˆ·
    async function loadCustomers() {
      try {
        const response = await fetch(`${API_BASE}/sales/customers`);
        const result = await response.json();
        
        if (result.success) {
          customers = result.data;
          renderCustomers();
        }
      } catch (error) {
        showAlert('åŠ è½½å®¢æˆ·å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ¸²æŸ“äº§å“åˆ—è¡¨
    function renderProducts(productList) {
      const grid = document.getElementById('productGrid');
      
      if (productList.length === 0) {
        grid.innerHTML = '<div class="empty-cart">æš‚æ— å¯ç”¨äº§å“</div>';
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        return;
      }
      
      grid.innerHTML = productList.map(p => {
        const isInCart = cart.some(item => item.productId === p._id);
        const price = getProductPrice(p);
        
        // è®¡ç®—ç¨é¢
        let taxRate = 0;
        if (p.taxClassification === 'VAT_23') taxRate = 0.23;
        else if (p.taxClassification === 'SERVICE_VAT_13_5') taxRate = 0.135;
        const taxAmount = price * taxRate;
        
        return `
          <div class="product-card ${isInCart ? 'selected' : ''}" onclick="addToCart('${p._id}')">
            <h3>${p.name}</h3>
            <div class="price">â‚¬${price.toFixed(2)}</div>
            <div class="info">
              ${getCategoryBadge(p.category)}
              ${p.category === 'ACCESSORY' ? `<span class="badge badge-info">åº“å­˜: ${p.quantity}</span>` : ''}
            </div>
            <div class="info">${p.barcode || p.serialNumber || ''}</div>
            <div class="info">
              ${getTaxBadge(p.taxClassification)}
              ${taxAmount > 0 ? `<span class="badge badge-warning">ç¨: â‚¬${taxAmount.toFixed(2)}</span>` : ''}
            </div>
            <div class="info">ä½ç½®: ${p.warehouseLocation}</div>
          </div>
        `;
      }).join('');
      
      // ç¿»è¯‘åŠ¨æ€å†…å®¹
      if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
    }

    // æ¸²æŸ“å®¢æˆ·åˆ—è¡¨
    function renderCustomers() {
      const select = document.getElementById('customerSelect');
      select.innerHTML = '<option value="">-- é€‰æ‹©å®¢æˆ· --</option>' +
        customers.map(c => `
          <option value="${c._id}" data-customer='${JSON.stringify(c)}'>
            ${c.username} - ${c.role === 'RETAIL_CUSTOMER' ? 'é›¶å”®' : 'æ‰¹å‘'}
            ${c.merchantTier ? ` (${c.merchantTier.tierName})` : ''}
          </option>
        `).join('');
    }

    // è·å–äº§å“ä»·æ ¼ï¼ˆæ ¹æ®å®¢æˆ·ç±»å‹ï¼‰
    function getProductPrice(product) {
      if (!selectedCustomer) {
        return product.suggestedRetailPrice;
      }
      
      if (selectedCustomer.role === 'WHOLESALE_MERCHANT') {
        if (selectedCustomer.merchantTier) {
          const tierPrice = product.tierPricing.find(
            t => t.tierLevel === selectedCustomer.merchantTier.tierLevel
          );
          return tierPrice ? tierPrice.price : product.wholesalePrice;
        }
        return product.wholesalePrice;
      }
      
      return product.suggestedRetailPrice;
    }

    // æ·»åŠ åˆ°è´­ç‰©è½¦
    function addToCart(productId) {
      // ä»å½“å‰æ˜¾ç¤ºçš„äº§å“åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼ˆä¼˜å…ˆä»åˆ†ç»„äº§å“ä¸­æŸ¥æ‰¾ï¼‰
      let product = currentGroupProducts.find(p => p._id === productId);
      if (!product) {
        product = products.find(p => p._id === productId);
      }
      if (!product) return;
      
      const existingItem = cart.find(item => item.productId === productId);
      
      if (existingItem) {
        // å¦‚æœæ˜¯é…ä»¶ï¼Œå¢åŠ æ•°é‡
        if (product.category === 'ACCESSORY') {
          if (existingItem.quantity < product.quantity) {
            existingItem.quantity++;
          } else {
            showAlert('åº“å­˜ä¸è¶³', 'error');
            return;
          }
        } else {
          showAlert('è®¾å¤‡å·²åœ¨è´­ç‰©è½¦ä¸­', 'error');
          return;
        }
      } else {
        cart.push({
          productId: product._id,
          product: product,
          quantity: 1
        });
      }
      
      renderCart();
      // é‡æ–°æ¸²æŸ“å½“å‰æ˜¾ç¤ºçš„äº§å“åˆ—è¡¨ï¼Œè€Œä¸æ˜¯åˆ‡æ¢è§†å›¾
      if (currentGroupProducts.length > 0) {
        renderProducts(currentGroupProducts);
      } else {
        renderProducts(products);
      }
    }

    // æ¸²æŸ“è´­ç‰©è½¦
    function renderCart() {
      const container = document.getElementById('cartItems');
      const summary = document.getElementById('cartSummary');
      const createBtn = document.getElementById('createInvoiceBtn');
      
      if (cart.length === 0) {
        container.innerHTML = '<div class="empty-cart">è´­ç‰©è½¦ä¸ºç©º<br>è¯·é€‰æ‹©äº§å“</div>';
        summary.style.display = 'none';
        createBtn.disabled = true;
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        return;
      }
      
      container.innerHTML = cart.map(item => {
        const price = getProductPrice(item.product);
        const total = price * item.quantity;
        
        return `
          <div class="cart-item">
            <div class="cart-item-info">
              <div class="cart-item-name">${item.product.name}</div>
              <div class="cart-item-price">â‚¬${price.toFixed(2)} Ã— ${item.quantity} = â‚¬${total.toFixed(2)}</div>
            </div>
            <div class="cart-item-qty">
              ${item.product.category === 'ACCESSORY' ? `
                <button class="qty-btn" onclick="updateQuantity('${item.productId}', -1)">-</button>
                <input type="number" class="qty-input" value="${item.quantity}" 
                       onchange="setQuantity('${item.productId}', this.value)" min="1" max="${item.product.quantity}">
                <button class="qty-btn" onclick="updateQuantity('${item.productId}', 1)">+</button>
              ` : ''}
              <button class="remove-btn" onclick="removeFromCart('${item.productId}')">Ã—</button>
            </div>
          </div>
        `;
      }).join('');
      
      summary.style.display = 'block';
      createBtn.disabled = !selectedCustomer;
      calculateTotal();
      
      // ç¿»è¯‘åŠ¨æ€å†…å®¹
      if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
    }

    // æ›´æ–°æ•°é‡
    function updateQuantity(productId, delta) {
      const item = cart.find(i => i.productId === productId);
      if (!item) return;
      
      const newQty = item.quantity + delta;
      if (newQty < 1) {
        removeFromCart(productId);
        return;
      }
      
      if (newQty > item.product.quantity) {
        showAlert('åº“å­˜ä¸è¶³', 'error');
        return;
      }
      
      item.quantity = newQty;
      renderCart();
    }

    // è®¾ç½®æ•°é‡
    function setQuantity(productId, value) {
      const item = cart.find(i => i.productId === productId);
      if (!item) return;
      
      const qty = parseInt(value);
      if (isNaN(qty) || qty < 1) {
        item.quantity = 1;
      } else if (qty > item.product.quantity) {
        item.quantity = item.product.quantity;
        showAlert('å·²è®¾ç½®ä¸ºæœ€å¤§åº“å­˜æ•°é‡', 'error');
      } else {
        item.quantity = qty;
      }
      
      renderCart();
    }

    // ä»è´­ç‰©è½¦ç§»é™¤
    function removeFromCart(productId) {
      cart = cart.filter(item => item.productId !== productId);
      renderCart();
      // é‡æ–°æ¸²æŸ“å½“å‰æ˜¾ç¤ºçš„äº§å“åˆ—è¡¨
      if (currentGroupProducts.length > 0) {
        renderProducts(currentGroupProducts);
      } else if (products.length > 0) {
        renderProducts(products);
      }
    }

    // è®¡ç®—æ€»é¢
    function calculateTotal() {
      let subtotal = 0;
      let totalTax = 0;
      
      cart.forEach(item => {
        const price = getProductPrice(item.product);
        const lineTotal = price * item.quantity;
        subtotal += lineTotal;
        
        // è®¡ç®—ç¨é¢
        let taxRate = 0;
        if (item.product.taxClassification === 'VAT_23') taxRate = 0.23;
        else if (item.product.taxClassification === 'SERVICE_VAT_13_5') taxRate = 0.135;
        
        totalTax += lineTotal * taxRate;
      });
      
      const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
      const discountAmount = subtotal * (discountPercent / 100);
      const total = subtotal - discountAmount + totalTax;
      
      document.getElementById('subtotal').textContent = `â‚¬${subtotal.toFixed(2)}`;
      document.getElementById('discountAmount').textContent = `-â‚¬${discountAmount.toFixed(2)}`;
      document.getElementById('taxAmount').textContent = `â‚¬${totalTax.toFixed(2)}`;
      document.getElementById('totalAmount').textContent = `â‚¬${total.toFixed(2)}`;
    }

    // åˆ›å»ºå‘ç¥¨
    async function createInvoice() {
      if (!selectedCustomer) {
        showAlert('è¯·é€‰æ‹©å®¢æˆ·', 'error');
        return;
      }
      
      if (cart.length === 0) {
        showAlert('è´­ç‰©è½¦ä¸ºç©º', 'error');
        return;
      }
      
      const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
      
      const invoiceData = {
        customer: {
          name: selectedCustomer.username,
          email: selectedCustomer.email,
          customerType: selectedCustomer.role === 'RETAIL_CUSTOMER' ? 'RETAIL' : 'WHOLESALE',
          merchantTier: selectedCustomer.merchantTier
        },
        lineItems: cart.map(item => ({
          productId: item.productId,
          quantity: item.quantity
        })),
        discountPercent: discountPercent
      };
      
      try {
        const response = await fetch(`${API_BASE}/sales/create-invoice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentInvoiceId = result.data._id;
          document.getElementById('invoiceNumber').textContent = result.data.invoiceNumber;
          document.getElementById('successModal').classList.add('show');
        } else {
          showAlert('åˆ›å»ºå‘ç¥¨å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('åˆ›å»ºå‘ç¥¨å¤±è´¥: ' + error.message, 'error');
      }
    }

    // ç¡®å®šå‘ç¥¨å¹¶ä¸‹è½½PDF
    async function finalizeAndDownload() {
      if (!currentInvoiceId) return;
      
      try {
        // ç¡®å®šå‘ç¥¨
        const response = await fetch(`${API_BASE}/sales/finalize-invoice/${currentInvoiceId}`, {
          method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
          // ä¸‹è½½PDF
          window.open(`${API_BASE}/sales/invoice-pdf/${currentInvoiceId}`, '_blank');
          
          // é‡ç½®
          cart = [];
          selectedCustomer = null;
          currentInvoiceId = null;
          document.getElementById('customerSelect').value = '';
          document.getElementById('discountPercent').value = '0';
          document.getElementById('successModal').classList.remove('show');
          
          renderCart();
          loadProducts();
          
          showAlert('å‘ç¥¨å·²ç¡®å®šï¼Œåº“å­˜å·²æ›´æ–°ï¼', 'success');
        } else {
          showAlert('ç¡®å®šå‘ç¥¨å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('æ“ä½œå¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºæç¤º
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // è¾…åŠ©å‡½æ•°
    function getCategoryBadge(category) {
      const badges = {
        'ACCESSORY': '<span class="badge badge-info">é…ä»¶</span>',
        'NEW_DEVICE': '<span class="badge badge-success">å…¨æ–°</span>',
        'USED_DEVICE': '<span class="badge badge-warning">äºŒæ‰‹</span>'
      };
      return badges[category] || '';
    }
    
    function getTaxBadge(tax) {
      const badges = {
        'VAT_23': '<span class="badge badge-primary">VAT 23%</span>',
        'MARGIN_VAT_0': '<span class="badge badge-info">Margin 0%</span>',
        'SERVICE_VAT_13_5': '<span class="badge badge-warning">Service 13.5%</span>'
      };
      return badges[tax] || tax;
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('customerSelect').addEventListener('change', (e) => {
      const option = e.target.selectedOptions[0];
      if (option.value) {
        selectedCustomer = JSON.parse(option.dataset.customer);
        renderCart();
        renderProducts(products);
      } else {
        selectedCustomer = null;
      }
    });

    document.getElementById('discountPercent').addEventListener('input', calculateTotal);
    document.getElementById('productSearch').addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      const filtered = currentGroupProducts.filter(p => 
        p.name.toLowerCase().includes(search) ||
        (p.barcode && p.barcode.toLowerCase().includes(search)) ||
        (p.serialNumber && p.serialNumber.toLowerCase().includes(search))
      );
      renderProducts(filtered);
    });
    
    document.getElementById('groupSearch').addEventListener('input', (e) => {
      const search = e.target.value.toLowerCase();
      const filtered = productGroups.filter(g => 
        g.productType.toLowerCase().includes(search)
      );
      renderProductGroups(filtered);
    });

    document.getElementById('createInvoiceBtn').addEventListener('click', createInvoice);
    document.getElementById('finalizeAndDownloadBtn').addEventListener('click', finalizeAndDownload);
    document.getElementById('closeModalBtn').addEventListener('click', () => {
      document.getElementById('successModal').classList.remove('show');
      window.location.reload();
    });
    
    // ç™»å‡ºåŠŸèƒ½ - ä½¿ç”¨AuthGuardç»Ÿä¸€çš„logout
    function logout() {
      AuthGuard.logout();
    }

    // åˆå§‹åŒ–
    loadProductGroups();
    loadProducts();
    loadCustomers();
    
    // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
    window.addEventListener('languageChanged', () => {
      // é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹
      if (currentGroupProducts.length > 0) {
        renderProducts(currentGroupProducts);
      } else if (productGroups.length > 0) {
        renderProductGroups(productGroups);
      }
      renderCustomers();
      renderCart();
    });
  </script>
</body>
</html>
