<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜æ§åˆ¶å° - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header .nav {
      margin-top: 10px;
    }
    
    .header .nav a {
      color: white;
      text-decoration: none;
      margin-right: 20px;
      opacity: 0.9;
    }
    
    .header .nav a:hover {
      opacity: 1;
      text-decoration: underline;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #dc3545;
    }
    
    .tab.active {
      color: #dc3545;
      border-bottom-color: #dc3545;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #dc3545;
      color: white;
    }
    
    .btn-primary:hover {
      background: #c82333;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }
    
    td {
      font-size: 14px;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #cfe2ff; color: #084298; }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #dc3545;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h1>ğŸ” ç®¡ç†å‘˜æ§åˆ¶å°</h1>
        <div class="nav">
          <a href="/prototype.html">â† è¿”å›ä¸»é¡µ</a>
          <a href="/admin.html">ç®¡ç†å‘˜</a>
        </div>
      </div>
      <button onclick="logout()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 5px; cursor: pointer; font-weight: 600;">
        é€€å‡ºç™»å½•
      </button>
    </div>
  </div>


  <div class="container">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>å¾…å¤„ç†é‡‡è´­è®¢å•</h3>
        <div class="value" id="pendingOrders">-</div>
      </div>
      <div class="stat-card">
        <h3>æœ¬æœˆé‡‡è´­æ€»é¢</h3>
        <div class="value" id="monthlyPurchase">-</div>
      </div>
      <div class="stat-card">
        <h3>æœ¬æœˆé”€å”®æ€»é¢</h3>
        <div class="value" id="monthlySales">-</div>
      </div>
      <div class="stat-card">
        <h3>æ´»è·ƒä¾›åº”å•†</h3>
        <div class="value" id="activeSuppliers">-</div>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('purchase-orders')">é‡‡è´­è®¢å•</button>
      <button class="tab" onclick="switchTab('suppliers')">ä¾›åº”å•†ç®¡ç†</button>
      <button class="tab" onclick="switchTab('reports')">æŠ¥è¡¨åˆ†æ</button>
      <button class="tab" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</button>
    </div>

    <!-- é‡‡è´­è®¢å• -->
    <div id="purchase-orders" class="tab-content active">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>é‡‡è´­è®¢å•åˆ—è¡¨</h2>
          <button class="btn btn-primary" onclick="showCreatePOModal()">+ åˆ›å»ºé‡‡è´­è®¢å•</button>
        </div>
        <div id="purchaseOrdersTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>


    <!-- ä¾›åº”å•†ç®¡ç† -->
    <div id="suppliers" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>ä¾›åº”å•†åˆ—è¡¨</h2>
          <button class="btn btn-primary" onclick="showCreateSupplierModal()">+ æ·»åŠ ä¾›åº”å•†</button>
        </div>
        <div id="suppliersTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- æŠ¥è¡¨åˆ†æ -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>åº“å­˜æŠ¥è¡¨</h2>
        <div id="inventoryReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div class="card">
        <h2>é”€å”®æŠ¥è¡¨</h2>
        <div id="salesReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
      
      <div class="card">
        <h2>åˆ©æ¶¦ç‡åˆ†æ</h2>
        <div id="profitReport">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç† -->
    <div id="users" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>ç”¨æˆ·åˆ—è¡¨</h2>
          <button class="btn btn-primary" onclick="showCreateUserModal()">+ æ·»åŠ ç”¨æˆ·</button>
        </div>
        <div id="usersTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>


  <script>
    const API_BASE = '/api';

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'purchase-orders': loadPurchaseOrders(); break;
        case 'suppliers': loadSuppliers(); break;
        case 'reports': loadReports(); break;
        case 'users': loadUsers(); break;
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/admin/stats`);
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          document.getElementById('pendingOrders').textContent = stats.pendingOrders || 0;
          document.getElementById('monthlyPurchase').textContent = 'â‚¬' + (stats.monthlyPurchase || 0).toFixed(2);
          document.getElementById('monthlySales').textContent = 'â‚¬' + (stats.monthlySales || 0).toFixed(2);
          document.getElementById('activeSuppliers').textContent = stats.activeSuppliers || 0;
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    }


    // åŠ è½½é‡‡è´­è®¢å•
    async function loadPurchaseOrders() {
      const container = document.getElementById('purchaseOrdersTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/purchase-orders`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>è®¢å•å·</th>
                  <th>ä¾›åº”å•†</th>
                  <th>æ€»é‡‘é¢</th>
                  <th>çŠ¶æ€</th>
                  <th>è®¢å•æ—¥æœŸ</th>
                  <th>è·Ÿè¸ªå·</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(order => `
                  <tr>
                    <td><strong>${order.orderNumber}</strong></td>
                    <td>${order.supplier?.name || '-'}</td>
                    <td>â‚¬${order.totalAmount.toFixed(2)}</td>
                    <td>${getOrderStatusBadge(order.status)}</td>
                    <td>${order.orderDate ? new Date(order.orderDate).toLocaleDateString('zh-CN') : '-'}</td>
                    <td>${order.trackingNumber || '-'}</td>
                    <td>
                      <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="updateOrderStatus('${order._id}')">æ›´æ–°çŠ¶æ€</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty">æš‚æ— é‡‡è´­è®¢å•</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }


    // åŠ è½½ä¾›åº”å•†
    async function loadSuppliers() {
      const container = document.getElementById('suppliersTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/suppliers`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>ä¾›åº”å•†åç§°</th>
                  <th>è”ç³»äºº</th>
                  <th>é‚®ç®±</th>
                  <th>ç”µè¯</th>
                  <th>åœ°å€</th>
                  <th>ç¨å·</th>
                  <th>ä»˜æ¬¾æ¡æ¬¾</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(sup => `
                  <tr>
                    <td><strong>${sup.name}</strong></td>
                    <td>${sup.contactPerson}</td>
                    <td>${sup.email}</td>
                    <td>${sup.phone}</td>
                    <td>${sup.address}</td>
                    <td>${sup.taxId}</td>
                    <td>${sup.paymentTerms}</td>
                    <td>${sup.active ? '<span class="badge badge-success">æ´»è·ƒ</span>' : '<span class="badge badge-danger">åœç”¨</span>'}</td>
                    <td>
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="toggleSupplierStatus('${sup._id}', ${sup.active})">
                        ${sup.active ? 'åœç”¨' : 'å¯ç”¨'}
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty">æš‚æ— ä¾›åº”å•†</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }


    // åŠ è½½æŠ¥è¡¨
    async function loadReports() {
      // åº“å­˜æŠ¥è¡¨
      try {
        const response = await fetch(`${API_BASE}/reports/inventory`);
        const result = await response.json();
        
        if (result.success) {
          const data = result.data;
          document.getElementById('inventoryReport').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>ç±»åˆ«</th>
                  <th>æ€»åº“å­˜</th>
                  <th>å¯é”€å”®</th>
                  <th>åº“å­˜ä»·å€¼</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>é…ä»¶ç±»</td>
                  <td>${data.accessories?.total || 0}</td>
                  <td>${data.accessories?.available || 0}</td>
                  <td>â‚¬${(data.accessories?.value || 0).toFixed(2)}</td>
                </tr>
                <tr>
                  <td>å…¨æ–°è®¾å¤‡</td>
                  <td>${data.newDevices?.total || 0}</td>
                  <td>${data.newDevices?.available || 0}</td>
                  <td>â‚¬${(data.newDevices?.value || 0).toFixed(2)}</td>
                </tr>
                <tr>
                  <td>äºŒæ‰‹è®¾å¤‡</td>
                  <td>${data.usedDevices?.total || 0}</td>
                  <td>${data.usedDevices?.available || 0}</td>
                  <td>â‚¬${(data.usedDevices?.value || 0).toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        document.getElementById('inventoryReport').innerHTML = '<div class="empty">æš‚æ— æ•°æ®</div>';
      }
      
      if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
    }


    // åŠ è½½ç”¨æˆ·
    async function loadUsers() {
      const container = document.getElementById('usersTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/users`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>ç”¨æˆ·å</th>
                  <th>é‚®ç®±</th>
                  <th>è§’è‰²</th>
                  <th>å•†æˆ·ç­‰çº§</th>
                  <th>æŠ˜æ‰£èŒƒå›´</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(user => `
                  <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email}</td>
                    <td>${getRoleBadge(user.role)}</td>
                    <td>${user.merchantTier ? `${user.merchantTier.tierName} (L${user.merchantTier.tierLevel})` : '-'}</td>
                    <td>${user.discountRange ? `${user.discountRange.minPercent}% - ${user.discountRange.maxPercent}%` : '-'}</td>
                    <td>${user.isActive ? '<span class="badge badge-success">æ´»è·ƒ</span>' : '<span class="badge badge-danger">åœç”¨</span>'}</td>
                    <td>
                      <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="editUser('${user._id}')">ç¼–è¾‘</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<div class="empty">æš‚æ— ç”¨æˆ·</div>';
        }
        
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
      } catch (error) {
        container.innerHTML = `<div class="empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }


    // è¾…åŠ©å‡½æ•°
    function getOrderStatusBadge(status) {
      const badges = {
        'DRAFT': '<span class="badge badge-warning">è‰ç¨¿</span>',
        'SENT': '<span class="badge badge-info">å·²å‘é€</span>',
        'ORDERED': '<span class="badge badge-primary">å·²ä¸‹å•</span>',
        'SHIPPED': '<span class="badge badge-primary">å·²å‘è´§</span>',
        'RECEIVED': '<span class="badge badge-success">å·²æ”¶è´§</span>',
        'CONFIRMED': '<span class="badge badge-success">å·²ç¡®è®¤</span>',
        'CANCELLED': '<span class="badge badge-danger">å·²å–æ¶ˆ</span>'
      };
      return badges[status] || status;
    }

    function getRoleBadge(role) {
      const badges = {
        'RETAIL_CUSTOMER': '<span class="badge badge-info">é›¶å”®å®¢æˆ·</span>',
        'WHOLESALE_MERCHANT': '<span class="badge badge-primary">æ‰¹å‘å•†æˆ·</span>',
        'WAREHOUSE_STAFF': '<span class="badge badge-warning">ä»“ç®¡å‘˜</span>',
        'ADMINISTRATOR': '<span class="badge badge-danger">ç®¡ç†å‘˜</span>'
      };
      return badges[role] || role;
    }

    // å ä½å‡½æ•°
    function showCreatePOModal() {
      alert('åˆ›å»ºé‡‡è´­è®¢å•åŠŸèƒ½å¼€å‘ä¸­...');
    }

    function showCreateSupplierModal() {
      alert('æ·»åŠ ä¾›åº”å•†åŠŸèƒ½å¼€å‘ä¸­...');
    }

    function showCreateUserModal() {
      alert('æ·»åŠ ç”¨æˆ·åŠŸèƒ½å¼€å‘ä¸­...');
    }

    function updateOrderStatus(orderId) {
      alert('æ›´æ–°è®¢å•çŠ¶æ€åŠŸèƒ½å¼€å‘ä¸­...');
    }

    function toggleSupplierStatus(supplierId, currentStatus) {
      alert('åˆ‡æ¢ä¾›åº”å•†çŠ¶æ€åŠŸèƒ½å¼€å‘ä¸­...');
    }

    function editUser(userId) {
      alert('ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½å¼€å‘ä¸­...');
    }
    
    // ç™»å‡ºåŠŸèƒ½ - ä½¿ç”¨AuthGuardç»Ÿä¸€çš„logout
    function logout() {
      AuthGuard.logout();
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadPurchaseOrders();
    });
    
    // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
    window.addEventListener('languageChanged', () => {
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        const tabName = activeTab.textContent.trim();
        if (tabName.includes('é‡‡è´­') || tabName.includes('Purchase')) loadPurchaseOrders();
        else if (tabName.includes('ä¾›åº”å•†') || tabName.includes('Supplier')) loadSuppliers();
        else if (tabName.includes('æŠ¥è¡¨') || tabName.includes('Report')) loadReports();
        else if (tabName.includes('ç”¨æˆ·') || tabName.includes('User')) loadUsers();
      }
    });
  </script>
</body>
</html>
