<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•åº“å­˜æ˜¾ç¤º</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    h2 {
      margin-top: 0;
    }
    .product-card {
      background: #f5f5f5;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
    }
    .category-card {
      background: #e3f2fd;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      cursor: pointer;
    }
    .category-card:hover {
      background: #bbdefb;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>ğŸ“¦ åº“å­˜æ˜¾ç¤ºæµ‹è¯•</h1>

  <div class="section">
    <h2>1. API å“åº”æµ‹è¯•</h2>
    <button onclick="testAPI()">ğŸ” æµ‹è¯• /api/products API</button>
    <div id="apiResult"></div>
  </div>

  <div class="section">
    <h2>2. äº§å“åˆ—è¡¨ï¼ˆåŸå§‹æ•°æ®ï¼‰</h2>
    <div id="productList"></div>
  </div>

  <div class="section">
    <h2>3. æŒ‰åˆ†ç±»åˆ†ç»„æ˜¾ç¤º</h2>
    <div id="categoryGroups"></div>
  </div>

  <script>
    async function testAPI() {
      const resultDiv = document.getElementById('apiResult');
      const productListDiv = document.getElementById('productList');
      const categoryGroupsDiv = document.getElementById('categoryGroups');
      
      resultDiv.innerHTML = '<p>â³ åŠ è½½ä¸­...</p>';
      
      try {
        console.log('ğŸ” å¼€å§‹æµ‹è¯• API...');
        
        const response = await fetch('/api/products');
        console.log('ğŸ“¥ API å“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('ğŸ“¦ API å“åº”æ•°æ®:', result);
        
        // æ˜¾ç¤º API å“åº”æ‘˜è¦
        resultDiv.innerHTML = `
          <div class="success">
            <p>âœ… API è°ƒç”¨æˆåŠŸ</p>
            <p><strong>æ€»äº§å“æ•°:</strong> ${result.data?.length || 0}</p>
            <p><strong>ProductNew:</strong> ${result.summary?.productNew || 0}</p>
            <p><strong>AdminInventory:</strong> ${result.summary?.adminInventory || 0}</p>
          </div>
        `;
        
        // æ˜¾ç¤ºäº§å“åˆ—è¡¨
        if (result.data && result.data.length > 0) {
          const products = result.data;
          
          // åŸå§‹äº§å“åˆ—è¡¨
          productListDiv.innerHTML = `
            <p><strong>å…± ${products.length} ä¸ªäº§å“ï¼š</strong></p>
            ${products.map((p, i) => `
              <div class="product-card">
                <strong>${i + 1}. ${p.name}</strong><br>
                åˆ†ç±»: ${p.productType || 'æœªåˆ†ç±»'}<br>
                æ¥æº: ${p.source}<br>
                åº“å­˜: ${p.stockQuantity || p.quantity || 0}<br>
                ä»·æ ¼: â‚¬${p.retailPrice || 0}
              </div>
            `).join('')}
          `;
          
          // æŒ‰åˆ†ç±»åˆ†ç»„
          const categories = {};
          products.forEach(product => {
            const category = product.productType || 'æœªåˆ†ç±»';
            if (!categories[category]) {
              categories[category] = [];
            }
            categories[category].push(product);
          });
          
          console.log('ğŸ“Š åˆ†ç±»ç»Ÿè®¡:', categories);
          
          categoryGroupsDiv.innerHTML = `
            <p><strong>å…± ${Object.keys(categories).length} ä¸ªåˆ†ç±»ï¼š</strong></p>
            ${Object.entries(categories).map(([category, categoryProducts]) => {
              const totalQuantity = categoryProducts.reduce((sum, p) => sum + (p.stockQuantity || p.quantity || 0), 0);
              return `
                <div class="category-card" onclick="alert('${category}: ${categoryProducts.length} ä¸ªäº§å“')">
                  <strong>ğŸ“¦ ${category}</strong><br>
                  äº§å“æ•°é‡: ${categoryProducts.length}<br>
                  æ€»åº“å­˜: ${totalQuantity}
                </div>
              `;
            }).join('')}
          `;
          
        } else {
          productListDiv.innerHTML = '<p class="error">âš ï¸ æ²¡æœ‰äº§å“æ•°æ®</p>';
          categoryGroupsDiv.innerHTML = '<p class="error">âš ï¸ æ²¡æœ‰åˆ†ç±»æ•°æ®</p>';
        }
        
      } catch (error) {
        console.error('âŒ API æµ‹è¯•å¤±è´¥:', error);
        resultDiv.innerHTML = `
          <div class="error">
            <p>âŒ API è°ƒç”¨å¤±è´¥</p>
            <p><strong>é”™è¯¯:</strong> ${error.message}</p>
          </div>
        `;
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
    window.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
      testAPI();
    });
  </script>
</body>
</html>
