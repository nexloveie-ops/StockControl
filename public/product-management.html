<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº§å“ç®¡ç† - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header .nav {
      margin-top: 10px;
    }
    
    .header .nav a {
      color: white;
      text-decoration: none;
      margin-right: 20px;
      opacity: 0.9;
    }
    
    .header .nav a:hover {
      opacity: 1;
      text-decoration: underline;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
    }
    
    .search-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .search-filters input,
    .search-filters select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .search-filters input {
      flex: 1;
      min-width: 200px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }
    
    td {
      font-size: 14px;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-primary { background: #cfe2ff; color: #084298; }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
      transition: all 0.3s;
    }
    
    .btn-edit {
      background: #667eea;
      color: white;
    }
    
    .btn-edit:hover {
      background: #5568d3;
    }
    
    .btn-status {
      background: #28a745;
      color: white;
    }
    
    .btn-status:hover {
      background: #218838;
    }
    
    .btn-location {
      background: #17a2b8;
      color: white;
    }
    
    .btn-location:hover {
      background: #138496;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .tier-pricing-group {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
    }
    
    .tier-pricing-group h4 {
      font-size: 14px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”§ äº§å“ç®¡ç†</h1>
    <div class="nav">
      <a href="/prototype.html">â† è¿”å›ä¸»é¡µ</a>
      <a href="/inventory.html">åº“å­˜ç®¡ç†</a>
      <a href="/product-management.html">äº§å“ç®¡ç†</a>
      <a href="/receiving.html">å…¥åº“ç®¡ç†</a>
      <a href="/sales.html">é”€å”®</a>
    </div>
  </div>

  <div class="container">
    <div id="alertContainer"></div>
    
    <div class="card">
      <h2>äº§å“åˆ—è¡¨</h2>
      
      <div class="search-filters">
        <input type="text" id="searchInput" placeholder="æœç´¢äº§å“åç§°ã€æ¡ç ã€åºåˆ—å·...">
        <select id="categoryFilter">
          <option value="">æ‰€æœ‰ç±»åˆ«</option>
          <option value="ACCESSORY">é…ä»¶</option>
          <option value="NEW_DEVICE">å…¨æ–°è®¾å¤‡</option>
          <option value="USED_DEVICE">äºŒæ‰‹è®¾å¤‡</option>
        </select>
        <select id="statusFilter">
          <option value="">æ‰€æœ‰çŠ¶æ€</option>
          <option value="AVAILABLE">å¯é”€å”®</option>
          <option value="DAMAGED">åæŸ</option>
          <option value="SCRAPPED">æŠ¥åºŸ</option>
          <option value="SOLD">å·²å”®</option>
        </select>
        <button class="btn btn-primary" onclick="loadProducts()">æœç´¢</button>
      </div>
      
      <div id="productsTable">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘ä»·æ ¼æ¨¡æ€æ¡† -->
  <div class="modal" id="priceModal">
    <div class="modal-content">
      <h3>è°ƒæ•´ä»·æ ¼</h3>
      <div class="form-group">
        <label>äº§å“åç§°</label>
        <input type="text" id="editProductName" readonly>
      </div>
      <div class="form-group">
        <label>å»ºè®®é›¶å”®ä»· *</label>
        <input type="number" id="editRetailPrice" step="0.01" min="0">
      </div>
      <div class="form-group">
        <label>æ‰¹å‘ä»· *</label>
        <input type="number" id="editWholesalePrice" step="0.01" min="0">
      </div>
      <div class="tier-pricing-group">
        <h4>åˆ†çº§æ‰¹å‘ä»·</h4>
        <div class="form-group">
          <label>VIPç­‰çº§ä»·æ ¼</label>
          <input type="number" id="editTierPriceVIP" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Goldç­‰çº§ä»·æ ¼</label>
          <input type="number" id="editTierPriceGold" step="0.01" min="0">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('priceModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="updatePrice()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ›´æ–°çŠ¶æ€æ¨¡æ€æ¡† -->
  <div class="modal" id="statusModal">
    <div class="modal-content">
      <h3>æ›´æ–°äº§å“çŠ¶æ€</h3>
      <div class="form-group">
        <label>äº§å“åç§°</label>
        <input type="text" id="statusProductName" readonly>
      </div>
      <div class="form-group">
        <label>å½“å‰çŠ¶æ€</label>
        <input type="text" id="currentStatus" readonly>
      </div>
      <div class="form-group">
        <label>æ–°çŠ¶æ€ *</label>
        <select id="newStatus">
          <option value="AVAILABLE">å¯é”€å”®</option>
          <option value="DAMAGED">åæŸ</option>
          <option value="SCRAPPED">æŠ¥åºŸ</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('statusModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="updateStatus()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- æ›´æ–°ä½ç½®æ¨¡æ€æ¡† -->
  <div class="modal" id="locationModal">
    <div class="modal-content">
      <h3>æ›´æ–°ä»“å‚¨ä½ç½®</h3>
      <div class="form-group">
        <label>äº§å“åç§°</label>
        <input type="text" id="locationProductName" readonly>
      </div>
      <div class="form-group">
        <label>å½“å‰ä½ç½®</label>
        <input type="text" id="currentLocation" readonly>
      </div>
      <div class="form-group">
        <label>æ–°ä½ç½® *</label>
        <input type="text" id="newLocation" placeholder="å¦‚: A-01, B-02">
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('locationModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="updateLocation()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- è°ƒæ•´æ•°é‡æ¨¡æ€æ¡† -->
  <div class="modal" id="quantityModal">
    <div class="modal-content">
      <h3>è°ƒæ•´åº“å­˜æ•°é‡</h3>
      <div class="form-group">
        <label>äº§å“åç§°</label>
        <input type="text" id="quantityProductName" readonly>
      </div>
      <div class="form-group">
        <label>å½“å‰æ•°é‡</label>
        <input type="number" id="currentQuantity" readonly>
      </div>
      <div class="form-group">
        <label>æ–°æ•°é‡ *</label>
        <input type="number" id="newQuantity" min="0">
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('quantityModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="updateQuantity()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let products = [];
    let currentEditProduct = null;

    // åŠ è½½äº§å“
    async function loadProducts() {
      try {
        const search = document.getElementById('searchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;
        
        let url = `${API_BASE}/admin/products?`;
        if (category) url += `category=${category}&`;
        if (status) url += `status=${status}&`;
        if (search) url += `search=${search}&`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
          products = result.data.products || result.data;
          renderProducts();
        }
      } catch (error) {
        showAlert('åŠ è½½äº§å“å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ¸²æŸ“äº§å“è¡¨æ ¼
    function renderProducts() {
      const container = document.getElementById('productsTable');
      
      if (products.length === 0) {
        container.innerHTML = '<div class="loading">æš‚æ— äº§å“æ•°æ®</div>';
        if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
        return;
      }
      
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>äº§å“åç§°</th>
              <th>ç±»åˆ«</th>
              <th>æ ‡è¯†</th>
              <th>æ•°é‡/æˆè‰²</th>
              <th>é›¶å”®ä»·</th>
              <th>æ‰¹å‘ä»·</th>
              <th>çŠ¶æ€</th>
              <th>ä½ç½®</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${products.map(p => `
              <tr>
                <td><strong>${p.name || '-'}</strong></td>
                <td>${getCategoryBadge(p.category?.type || p.category || 'Unknown')}</td>
                <td style="font-family: monospace; font-size: 12px;">${p.barcode || p.serialNumber || p.sku || '-'}</td>
                <td>${p.category === 'ACCESSORY' ? (p.quantity || p.stockQuantity || 0) : (p.conditionGrade || p.condition || 'NEW')}</td>
                <td>â‚¬${(p.suggestedRetailPrice || p.retailPrice || 0).toFixed(2)}</td>
                <td>â‚¬${(p.wholesalePrice || p.costPrice || 0).toFixed(2)}</td>
                <td>${getStatusBadge(p.status)}</td>
                <td>${p.warehouseLocation}</td>
                <td>
                  <button class="action-btn btn-edit" onclick="openPriceModal('${p._id}')">è°ƒä»·</button>
                  ${p.status !== 'SOLD' ? `<button class="action-btn btn-status" onclick="openStatusModal('${p._id}')">çŠ¶æ€</button>` : ''}
                  <button class="action-btn btn-location" onclick="openLocationModal('${p._id}')">ä½ç½®</button>
                  ${p.category === 'ACCESSORY' ? `<button class="action-btn btn-edit" onclick="openQuantityModal('${p._id}')">æ•°é‡</button>` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      // ç¿»è¯‘åŠ¨æ€å†…å®¹
      if (typeof i18n !== 'undefined') i18n.translateDynamicContent();
    }

    // æ‰“å¼€ä»·æ ¼ç¼–è¾‘æ¨¡æ€æ¡†
    function openPriceModal(productId) {
      const product = products.find(p => p._id === productId);
      if (!product) return;
      
      currentEditProduct = product;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editRetailPrice').value = product.suggestedRetailPrice;
      document.getElementById('editWholesalePrice').value = product.wholesalePrice;
      
      const vipPrice = product.tierPricing.find(t => t.tierLevel === 1);
      const goldPrice = product.tierPricing.find(t => t.tierLevel === 2);
      document.getElementById('editTierPriceVIP').value = vipPrice ? vipPrice.price : '';
      document.getElementById('editTierPriceGold').value = goldPrice ? goldPrice.price : '';
      
      document.getElementById('priceModal').classList.add('show');
    }

    // æ›´æ–°ä»·æ ¼
    async function updatePrice() {
      if (!currentEditProduct) return;
      
      const tierPricing = [];
      const vipPrice = parseFloat(document.getElementById('editTierPriceVIP').value);
      const goldPrice = parseFloat(document.getElementById('editTierPriceGold').value);
      
      if (vipPrice > 0) tierPricing.push({ tierName: 'VIP', tierLevel: 1, price: vipPrice });
      if (goldPrice > 0) tierPricing.push({ tierName: 'Gold', tierLevel: 2, price: goldPrice });
      
      try {
        const response = await fetch(`${API_BASE}/products/${currentEditProduct._id}/pricing`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            suggestedRetailPrice: parseFloat(document.getElementById('editRetailPrice').value),
            wholesalePrice: parseFloat(document.getElementById('editWholesalePrice').value),
            tierPricing
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showAlert('ä»·æ ¼æ›´æ–°æˆåŠŸï¼', 'success');
          closeModal('priceModal');
          loadProducts();
        } else {
          showAlert('æ›´æ–°å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ‰“å¼€çŠ¶æ€ç¼–è¾‘æ¨¡æ€æ¡†
    function openStatusModal(productId) {
      const product = products.find(p => p._id === productId);
      if (!product) return;
      
      currentEditProduct = product;
      document.getElementById('statusProductName').value = product.name;
      document.getElementById('currentStatus').value = getStatusText(product.status);
      document.getElementById('newStatus').value = product.status;
      
      document.getElementById('statusModal').classList.add('show');
    }

    // æ›´æ–°çŠ¶æ€
    async function updateStatus() {
      if (!currentEditProduct) return;
      
      try {
        const response = await fetch(`${API_BASE}/products/${currentEditProduct._id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            status: document.getElementById('newStatus').value
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showAlert('çŠ¶æ€æ›´æ–°æˆåŠŸï¼', 'success');
          closeModal('statusModal');
          loadProducts();
        } else {
          showAlert('æ›´æ–°å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ‰“å¼€ä½ç½®ç¼–è¾‘æ¨¡æ€æ¡†
    function openLocationModal(productId) {
      const product = products.find(p => p._id === productId);
      if (!product) return;
      
      currentEditProduct = product;
      document.getElementById('locationProductName').value = product.name;
      document.getElementById('currentLocation').value = product.warehouseLocation;
      document.getElementById('newLocation').value = product.warehouseLocation;
      
      document.getElementById('locationModal').classList.add('show');
    }

    // æ›´æ–°ä½ç½®
    async function updateLocation() {
      if (!currentEditProduct) return;
      
      try {
        const response = await fetch(`${API_BASE}/products/${currentEditProduct._id}/location`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            warehouseLocation: document.getElementById('newLocation').value
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showAlert('ä½ç½®æ›´æ–°æˆåŠŸï¼', 'success');
          closeModal('locationModal');
          loadProducts();
        } else {
          showAlert('æ›´æ–°å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ‰“å¼€æ•°é‡ç¼–è¾‘æ¨¡æ€æ¡†
    function openQuantityModal(productId) {
      const product = products.find(p => p._id === productId);
      if (!product) return;
      
      currentEditProduct = product;
      document.getElementById('quantityProductName').value = product.name;
      document.getElementById('currentQuantity').value = product.quantity;
      document.getElementById('newQuantity').value = product.quantity;
      
      document.getElementById('quantityModal').classList.add('show');
    }

    // æ›´æ–°æ•°é‡
    async function updateQuantity() {
      if (!currentEditProduct) return;
      
      try {
        const response = await fetch(`${API_BASE}/products/${currentEditProduct._id}/quantity`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quantity: parseInt(document.getElementById('newQuantity').value)
          })
        });
        
        const result = await response.json();
        if (result.success) {
          showAlert('æ•°é‡æ›´æ–°æˆåŠŸï¼', 'success');
          closeModal('quantityModal');
          loadProducts();
        } else {
          showAlert('æ›´æ–°å¤±è´¥: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
      currentEditProduct = null;
    }

    // æ˜¾ç¤ºæç¤º
    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      container.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }

    // è¾…åŠ©å‡½æ•°
    function getCategoryBadge(category) {
      const badges = {
        'ACCESSORY': '<span class="badge badge-info">é…ä»¶</span>',
        'NEW_DEVICE': '<span class="badge badge-success">å…¨æ–°</span>',
        'USED_DEVICE': '<span class="badge badge-warning">äºŒæ‰‹</span>'
      };
      return badges[category] || category;
    }

    function getStatusBadge(status) {
      const badges = {
        'AVAILABLE': '<span class="badge badge-success">å¯é”€å”®</span>',
        'DAMAGED': '<span class="badge badge-warning">åæŸ</span>',
        'SCRAPPED': '<span class="badge badge-danger">æŠ¥åºŸ</span>',
        'SOLD': '<span class="badge badge-info">å·²å”®</span>'
      };
      return badges[status] || status;
    }

    function getStatusText(status) {
      const texts = {
        'AVAILABLE': 'å¯é”€å”®',
        'DAMAGED': 'åæŸ',
        'SCRAPPED': 'æŠ¥åºŸ',
        'SOLD': 'å·²å”®'
      };
      return texts[status] || status;
    }

    // åˆå§‹åŒ–
    loadProducts();
    
    // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
    window.addEventListener('languageChanged', () => {
      // é‡æ–°æ¸²æŸ“äº§å“åˆ—è¡¨
      renderProducts();
    });
  </script>
</body>
</html>
