<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»“åº“ç®¡ç†ç³»ç»Ÿ - ä»“ç®¡å‘˜å·¥ä½œå°</title>
  <script src="/i18n.js"></script>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 0;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .header-buttons button {
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .header-buttons button:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .stats-section {
      margin-bottom: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid #e8ecf0;
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    
    .stat-card h3 {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
      line-height: 1;
    }
    
    .actions-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover {
      background: #38a169;
      transform: translateY(-1px);
    }
    
    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      padding: 6px;
      margin-bottom: 25px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border: 1px solid #e8ecf0;
    }
    
    .tab {
      flex: 1;
      padding: 12px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      border-radius: 8px;
      transition: all 0.3s;
      text-align: center;
    }
    
    .tab:hover {
      color: #667eea;
      background: #f7fafc;
    }
    
    .tab.active {
      color: white;
      background: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      border: 1px solid #e8ecf0;
    }
    
    .card h2 {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .group-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #e8ecf0;
      position: relative;
      overflow: hidden;
    }
    
    .group-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transform: scaleX(0);
      transition: transform 0.3s;
    }
    
    .group-card:hover::before {
      transform: scaleX(1);
    }
    
    .group-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }
    
    .group-card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2d3748;
    }
    
    .group-card-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    
    .group-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .stat-item {
      text-align: center;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .loading::before {
      content: 'â³';
      font-size: 24px;
      display: block;
      margin-bottom: 10px;
    }
    
    .error {
      background: #fed7d7;
      color: #c53030;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #feb2b2;
    }
    
    .success {
      background: #c6f6d5;
      color: #2f855a;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #9ae6b4;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    th, td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    
    th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      background: #f7fafc;
      transition: all 0.3s;
    }
    
    .upload-area:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }
    
    .upload-text {
      margin-top: 16px;
      color: #6b7280;
      font-size: 14px;
    }
    
    /* Debug panel CSS removed */
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-received {
      background: #c6f6d5;
      color: #2f855a;
    }
    
    .status-pending {
      background: #fef5e7;
      color: #d69e2e;
    }
    
    .operation-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .operation-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }
    
    .operation-card h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2d3748;
    }
    
    .operation-card p {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .products-grid {
        grid-template-columns: 1fr;
      }
      
      .tabs {
        flex-direction: column;
      }
      
      .tab {
        text-align: left;
      }
      
      .actions-bar {
        flex-direction: column;
      }
      
      .btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- è°ƒè¯•é¢æ¿å·²ç§»é™¤ -->

  <div class="header">
    <div class="header-content">
      <div>
        <h1>ğŸ“¦ ä»“åº“ç®¡ç†ç³»ç»Ÿ</h1>
        <p>ä»“ç®¡å‘˜å·¥ä½œå° - åº“å­˜ç®¡ç†ä¸å…¥åº“æ“ä½œ</p>
      </div>
      <div class="header-buttons">
        <button onclick="window.location.href='/admin.html'">
          ğŸ“„ ç®¡ç†åå°
        </button>
        <button onclick="logout()">
          ğŸšª é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-section">
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <h3>æ€»äº§å“æ•°</h3>
          <div class="value" id="totalProducts">-</div>
        </div>
        <div class="stat-card">
          <h3>å¯é”€å”®äº§å“</h3>
          <div class="value" id="availableProducts">-</div>
        </div>
        <div class="stat-card">
          <h3>é…ä»¶ç±»äº§å“</h3>
          <div class="value" id="accessories">-</div>
        </div>
        <div class="stat-card">
          <h3>å…¨æ–°è®¾å¤‡</h3>
          <div class="value" id="newDevices">-</div>
        </div>
        <div class="stat-card">
          <h3>äºŒæ‰‹è®¾å¤‡</h3>
          <div class="value" id="usedDevices">-</div>
        </div>
        <div class="stat-card">
          <h3>ä¾›åº”å•†æ•°é‡</h3>
          <div class="value" id="totalSuppliers">-</div>
        </div>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="actions-bar" style="display: none;">
      <!-- æŒ‰é’®å·²ç§»é™¤ï¼šğŸ”„ åˆ·æ–°æ•°æ®, ğŸ” æµ‹è¯•å›¾ç‰‡è¯†åˆ«, ğŸ› è°ƒè¯•é¢æ¿ -->
    </div>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('inventory')">
        ğŸ“¦ åº“å­˜ç®¡ç†
      </button>
      <button class="tab" onclick="switchTab('receiving')">
        ğŸ“¥ å…¥åº“ç®¡ç†
      </button>
      <button class="tab" onclick="switchTab('operations')">
        âš™ï¸ åº“å­˜æ“ä½œ
      </button>
      <button class="tab" onclick="switchTab('reports')">
        ğŸ“Š åº“å­˜æŠ¥è¡¨
      </button>
    </div>

    <!-- åº“å­˜ç®¡ç† -->
    <div id="inventory" class="tab-content active">
      <div class="card">
        <h2>ğŸ“¦ åº“å­˜äº§å“ç®¡ç†</h2>
        
        <!-- æœç´¢å’Œç­›é€‰ -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
          <input type="text" id="searchInput" placeholder="æœç´¢äº§å“åç§°ã€æ¡ç ã€IMEI..." 
                 style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
          <select id="categoryFilter" style="padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            <option value="">æ‰€æœ‰åˆ†ç±»</option>
            <option value="æ‰‹æœºé…ä»¶">æ‰‹æœºé…ä»¶</option>
            <option value="ç”µè„‘é…ä»¶">ç”µè„‘é…ä»¶</option>
            <option value="è½¦è½½é…ä»¶">è½¦è½½é…ä»¶</option>
            <option value="audio">Audio</option>
            <option value="æ•°æ®çº¿">æ•°æ®çº¿</option>
            <option value="power supply">Power Supply</option>
            <option value="å…¨æ–°è®¾å¤‡">å…¨æ–°è®¾å¤‡</option>
            <option value="äºŒæ‰‹è®¾å¤‡">äºŒæ‰‹è®¾å¤‡</option>
            <option value="ç»´ä¿®">ç»´ä¿®</option>
          </select>
          <button onclick="searchProducts()" class="btn btn-primary">ğŸ” æœç´¢</button>
          <button onclick="loadCategoryCards()" class="btn btn-success">ğŸ”„ åˆ·æ–°</button>
        </div>
        
        <div id="inventoryContainer">
          <div class="loading">æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...</div>
        </div>
      </div>
    </div>

    <!-- å…¥åº“ç®¡ç† -->
    <div id="receiving" class="tab-content">
      <div class="card">
        <h2>ğŸ“¥ å…¥åº“ç®¡ç†</h2>
        
        <!-- å…¥åº“æ–¹å¼é€‰æ‹© -->
        <div style="display: flex; gap: 15px; margin-bottom: 25px;">
          <button onclick="switchReceivingMode('upload')" id="uploadModeBtn" class="btn btn-primary">
            ğŸ“¤ å‘ç¥¨ä¸Šä¼ å…¥åº“
          </button>
          <button onclick="switchReceivingMode('manual')" id="manualModeBtn" class="btn" style="background: #48bb78; color: white;">
            âœï¸ æ‰‹åŠ¨å½•å…¥å…¥åº“
          </button>
        </div>
        
        <!-- å‘ç¥¨ä¸Šä¼ æ¨¡å¼ -->
        <div id="uploadMode" style="display: block;">
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“„</div>
            <div>
              <button onclick="document.getElementById('fileInput').click()" class="btn btn-primary">
                ğŸ“¤ ä¸Šä¼ å‘ç¥¨å›¾ç‰‡
              </button>
              <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
            </div>
            <div class="upload-text">
              æ”¯æŒæ ¼å¼ï¼šJPG, PNG, PDF<br>
              ä¸Šä¼ å‘ç¥¨å›¾ç‰‡è¿›è¡Œæ™ºèƒ½è¯†åˆ«å’Œè‡ªåŠ¨å…¥åº“
            </div>
          </div>
        </div>
        
        <!-- æ‰‹åŠ¨å½•å…¥æ¨¡å¼ -->
        <div id="manualMode" style="display: none;">
          <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3>ğŸ“ æ‰‹åŠ¨å½•å…¥äº§å“ä¿¡æ¯</h3>
            
            <!-- ä¾›åº”å•†ä¿¡æ¯ -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä¾›åº”å•†</label>
                <select id="manualSupplier" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <option value="">é€‰æ‹©ä¾›åº”å•†...</option>
                </select>
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å‘ç¥¨å·ç </label>
                <input type="text" id="manualInvoiceNumber" placeholder="è¾“å…¥å‘ç¥¨å·ç " 
                       style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              </div>
            </div>
            
            <!-- äº§å“ä¿¡æ¯è¡¨å• -->
            <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
              <table style="width: 100%; margin: 0;">
                <thead style="background: #f7fafc;">
                  <tr>
                    <th style="padding: 12px; text-align: left;">äº§å“åç§°</th>
                    <th style="padding: 12px; text-align: left;">æ•°é‡</th>
                    <th style="padding: 12px; text-align: left;">è¿›è´§ä»·</th>
                    <th style="padding: 12px; text-align: left;">æ‰¹å‘ä»·</th>
                    <th style="padding: 12px; text-align: left;">é›¶å”®ä»·</th>
                    <th style="padding: 12px; text-align: left;">åˆ†ç±»</th>
                    <th style="padding: 12px; text-align: left;">ç¨åŠ¡åˆ†ç±»</th>
                    <th style="padding: 12px; text-align: left;">æ¡ç /åºåˆ—å·</th>
                    <th style="padding: 12px; text-align: left;">é¢œè‰²</th>
                    <th style="padding: 12px; text-align: left;">æˆè‰²</th>
                    <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="manualProductsTable">
                  <!-- åŠ¨æ€ç”Ÿæˆçš„äº§å“è¡Œ -->
                </tbody>
              </table>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: space-between; margin-top: 20px;">
              <button onclick="addManualProduct()" class="btn btn-success">
                â• æ·»åŠ äº§å“
              </button>
              <div>
                <button onclick="clearManualForm()" class="btn" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0;">
                  ğŸ—‘ï¸ æ¸…ç©º
                </button>
                <button onclick="confirmManualReceiving()" class="btn btn-success">
                  âœ… ç¡®è®¤å…¥åº“
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div id="recognitionResult" style="display: none;"></div>
      </div>
    </div>

    <!-- åº“å­˜æ“ä½œ -->
    <div id="operations" class="tab-content">
      <div class="card">
        <h2>âš™ï¸ æ‰¹é‡åº“å­˜æ“ä½œ</h2>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <div class="operation-card" onclick="showPriceAdjustment()">
            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ’°</div>
            <h3>ä»·æ ¼è°ƒæ•´</h3>
            <p>æ‰¹é‡è°ƒæ•´äº§å“è¿›è´§ä»·ã€æ‰¹å‘ä»·ã€é›¶å”®ä»·</p>
          </div>
          
          <div class="operation-card" onclick="showLocationManagement()">
            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“</div>
            <h3>ä½ç½®ç®¡ç†</h3>
            <p>è®¾ç½®å’Œè°ƒæ•´äº§å“å­˜å‚¨ä½ç½®</p>
          </div>
          
          <div class="operation-card" onclick="showQuantityAdjustment()">
            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“Š</div>
            <h3>æ•°é‡è°ƒæ•´</h3>
            <p>åº“å­˜ç›˜ç‚¹ã€æŸè€—ç™»è®°ã€æ•°é‡ä¿®æ­£</p>
          </div>
          
          <div class="operation-card" onclick="showStatusManagement()">
            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ·ï¸</div>
            <h3>çŠ¶æ€ç®¡ç†</h3>
            <p>äº§å“çŠ¶æ€å˜æ›´ã€è´¨é‡ç­‰çº§è°ƒæ•´</p>
          </div>
        </div>
      </div>
    </div>

    <!-- åº“å­˜æŠ¥è¡¨ -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>ğŸ“Š åº“å­˜åˆ†ææŠ¥è¡¨</h2>
        <div id="reportsContainer">
          <div class="loading">æ­£åœ¨ç”ŸæˆæŠ¥è¡¨æ•°æ®...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    // debugVisible variable removed since debug panel is removed

    // è°ƒè¯•æ—¥å¿— - åªè¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆè°ƒè¯•é¢æ¿å·²ç§»é™¤ï¼‰
    function debugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
    }

    // åˆ‡æ¢è°ƒè¯•é¢æ¿ - å·²ç§»é™¤
    /*
    function toggleDebugPanel() {
      const panel = document.getElementById('debugPanel');
      debugVisible = !debugVisible;
      panel.style.display = debugVisible ? 'block' : 'none';
    }
    */

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      debugLog(`åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${tabName}`);
      
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      switch(tabName) {
        case 'inventory': loadCategoryCards(); break;
        case 'receiving': break;
        case 'operations': break;
        case 'reports': loadReports(); break;
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
      debugLog('å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®');
      try {
        const response = await fetch('/api/stats');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`ç»Ÿè®¡APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success && result.data) {
          const stats = result.data;
          document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
          document.getElementById('availableProducts').textContent = stats.availableProducts || 0;
          document.getElementById('accessories').textContent = stats.productsByCategory?.accessories || 0;
          document.getElementById('newDevices').textContent = stats.productsByCategory?.newDevices || 0;
          document.getElementById('usedDevices').textContent = stats.productsByCategory?.usedDevices || 0;
          document.getElementById('totalSuppliers').textContent = stats.totalSuppliers || 0;
          
          debugLog('âœ… ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸ');
        } else {
          throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
        }
      } catch (error) {
        debugLog(`âŒ ç»Ÿè®¡æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
      }
    }

    // åŠ è½½åˆ†ç±»å¡ç‰‡
    async function loadCategoryCards() {
      debugLog('å¼€å§‹åŠ è½½åˆ†ç±»å¡ç‰‡');
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch('/api/products');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`äº§å“APIå“åº”: ${result.data?.length || 0} ä¸ªäº§å“`);
        
        if (result.success && result.data && result.data.length > 0) {
          renderCategoryCards(result.data);
          debugLog('âœ… åˆ†ç±»å¡ç‰‡åŠ è½½æˆåŠŸ');
        } else {
          container.innerHTML = '<div>æš‚æ— åº“å­˜äº§å“æ•°æ®</div>';
          debugLog('âš ï¸ æ²¡æœ‰åº“å­˜äº§å“æ•°æ®');
        }
      } catch (error) {
        container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        debugLog(`âŒ åˆ†ç±»å¡ç‰‡åŠ è½½å¤±è´¥: ${error.message}`);
      }
    }

    // æ¸²æŸ“åˆ†ç±»å¡ç‰‡
    function renderCategoryCards(products) {
      const container = document.getElementById('inventoryContainer');
      
      if (!products || products.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <h3>æš‚æ— åº“å­˜äº§å“</h3>
            <p>è¯·å…ˆè¿›è¡Œå…¥åº“æ“ä½œ</p>
          </div>
        `;
        return;
      }
      
      // æŒ‰åˆ†ç±»åˆ†ç»„äº§å“
      const categories = {};
      products.forEach(product => {
        const category = product.productType || 'æœªåˆ†ç±»';
        if (!categories[category]) {
          categories[category] = [];
        }
        categories[category].push(product);
      });
      
      // ç”Ÿæˆåˆ†ç±»å¡ç‰‡HTML
      const html = `
        <div class="products-grid">
          ${Object.entries(categories).map(([category, categoryProducts]) => {
            const totalQuantity = categoryProducts.reduce((sum, p) => sum + (p.stockQuantity || p.quantity || 0), 0);
            const totalValue = categoryProducts.reduce((sum, p) => sum + ((p.costPrice || p.purchasePrice || 0) * (p.stockQuantity || p.quantity || 0)), 0);
            const lowStockCount = categoryProducts.filter(p => (p.stockQuantity || p.quantity || 0) < 5).length;
            
            return `
              <div class="group-card" onclick="showCategoryProducts('${category}')">
                <div class="group-card-title">${getCategoryIcon(category)} ${category}</div>
                <div class="group-card-subtitle">${categoryProducts.length} ç§äº§å“</div>
                <div class="group-stats">
                  <div class="stat-item">
                    <div class="stat-label">æ€»åº“å­˜</div>
                    <div class="stat-value">${totalQuantity}</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">åº“å­˜ä»·å€¼</div>
                    <div class="stat-value">â‚¬${totalValue.toFixed(0)}</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">ä½åº“å­˜</div>
                    <div class="stat-value" style="color: ${lowStockCount > 0 ? '#e53e3e' : '#48bb78'}">${lowStockCount}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    // è·å–åˆ†ç±»å›¾æ ‡
    function getCategoryIcon(category) {
      const icons = {
        'æ‰‹æœºé…ä»¶': 'ğŸ“±',
        'ç”µè„‘é…ä»¶': 'ğŸ’»',
        'è½¦è½½é…ä»¶': 'ğŸš—',
        'audio': 'ğŸµ',
        'æ•°æ®çº¿': 'ğŸ”Œ',
        'power supply': 'ğŸ”‹',
        'å…¨æ–°è®¾å¤‡': 'ğŸ“¦',
        'äºŒæ‰‹è®¾å¤‡': 'â™»ï¸',
        'ç»´ä¿®': 'ğŸ”§',
        'æœªåˆ†ç±»': 'ğŸ“‹'
      };
      return icons[category] || 'ğŸ“‹';
    }

    // æ˜¾ç¤ºåˆ†ç±»ä¸‹çš„äº§å“
    function showCategoryProducts(category) {
      debugLog(`æ˜¾ç¤ºåˆ†ç±»äº§å“: ${category}`);
      
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 98vw; width: 1500px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>${getCategoryIcon(category)} ${category} - äº§å“ç®¡ç†</h3>
            <button onclick="closeCategoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          <div id="categoryProductsContainer">
            <div class="loading">æ­£åœ¨åŠ è½½äº§å“...</div>
          </div>
        </div>
      `;
      
      // ä½¿ç”¨createModalåˆ›å»ºæ¨¡æ€çª—å£ï¼Œç¡®ä¿æ­£ç¡®çš„z-index
      const modal = createModal(content, 9000); // ä½¿ç”¨è¾ƒä½çš„z-indexä½œä¸ºåŸºç¡€å±‚
      modal.id = 'categoryModal';
      
      // åŠ è½½è¯¥åˆ†ç±»çš„äº§å“
      loadCategoryProductDetails(category);
    }

    // å…³é—­åˆ†ç±»å¼¹çª—
    function closeCategoryModal() {
      const modal = document.getElementById('categoryModal');
      if (modal) {
        modal.remove();
        debugLog('åˆ†ç±»å¼¹çª—å·²å…³é—­');
      }
    }

    // åŠ è½½åˆ†ç±»äº§å“è¯¦æƒ…
    async function loadCategoryProductDetails(category) {
      debugLog(`åŠ è½½åˆ†ç±»äº§å“è¯¦æƒ…: ${category}`);
      
      try {
        const response = await fetch(`/api/products?category=${encodeURIComponent(category)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const products = result.data || [];
        
        debugLog(`åˆ†ç±» "${category}" çš„äº§å“æ•°é‡: ${products.length}`);
        
        const container = document.getElementById('categoryProductsContainer');
        if (products.length === 0) {
          container.innerHTML = '<div>è¯¥åˆ†ç±»ä¸‹æš‚æ— äº§å“</div>';
          return;
        }
        
        const html = `
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>æ•°é‡</th>
                  <th>è¿›è´§ä»·</th>
                  <th>æ‰¹å‘ä»·</th>
                  <th>é›¶å”®ä»·</th>
                  <th>ä½ç½®</th>
                  <th>çŠ¶æ€</th>
                  <th>ç®¡ç†æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${products.map(product => {
                  const stockQuantity = product.stockQuantity || product.quantity || 0;
                  const hasSerialNumbers = product.serialNumbers && product.serialNumbers.length > 0;
                  const statusBadge = stockQuantity > 0 ? 
                    '<span class="status-badge status-received">âœ… æœ‰åº“å­˜</span>' :
                    '<span class="status-badge status-pending">âŒ ç¼ºè´§</span>';
                  
                  // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                  const locationDisplay = product.location?.fullLocation || 'æœªè®¾ç½®';
                  
                  // æ˜¾ç¤ºåºåˆ—å·ä¿¡æ¯ï¼ˆéšè—ï¼Œç‚¹å‡»æ˜¾ç¤ºï¼‰
                  let serialInfo = '';
                  if (hasSerialNumbers) {
                    const serialNumbers = product.serialNumbers.map(sn => sn.serialNumber);
                    const serialCount = serialNumbers.length;
                    serialInfo = `
                      <br>
                      <small style="color: #6b7280; cursor: pointer;" onclick="toggleSerialNumbers('${product._id}')">
                        ğŸ“± åºåˆ—å· (${serialCount}ä¸ª) 
                        <span style="color: #3b82f6;">ç‚¹å‡»æŸ¥çœ‹</span>
                      </small>
                      <div id="serial-${product._id}" style="display: none; margin-top: 5px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 11px;">
                        ${serialNumbers.map((sn, index) => `<div>${index + 1}. ${sn}</div>`).join('')}
                      </div>
                    `;
                  } else if (product.barcode) {
                    serialInfo = `<br><small style="color: #6b7280;">æ¡ç : ${product.barcode}</small>`;
                  }
                  
                  return `
                    <tr>
                      <td style="font-weight: 600;">
                        <span style="color: #667eea; cursor: pointer; text-decoration: underline;" 
                              onclick="showProductInvoices('${product._id}', '${product.name.replace(/'/g, "\\'")}')">
                          ${product.name}
                        </span>
                        ${serialInfo}
                      </td>
                      <td style="text-align: center; font-weight: 600; color: ${stockQuantity > 0 ? '#059669' : '#c53030'};">
                        ${stockQuantity}
                      </td>
                      <td style="color: #059669;">â‚¬${(product.costPrice || product.purchasePrice || 0).toFixed(2)}</td>
                      <td style="color: #d69e2e;">â‚¬${(product.wholesalePrice || 0).toFixed(2)}</td>
                      <td style="color: #7c3aed;">â‚¬${(product.retailPrice || product.suggestedRetailPrice || 0).toFixed(2)}</td>
                      <td>${locationDisplay}</td>
                      <td>${statusBadge}</td>
                      <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                          <button onclick="adjustPrice('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white;">
                            ğŸ’° è°ƒä»·
                          </button>
                          ${!hasSerialNumbers ? `
                          <button onclick="adjustQuantity('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #48bb78; color: white;">
                            ğŸ“Š è°ƒé‡
                          </button>
                          ` : ''}
                          <button onclick="setLocation('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #ed8936; color: white;">
                            ğŸ“ ä½ç½®
                          </button>
                          <button onclick="changeStatus('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #9f7aea; color: white;">
                            ğŸ·ï¸ çŠ¶æ€
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      } catch (error) {
        debugLog(`âŒ åŠ è½½åˆ†ç±»äº§å“å¤±è´¥: ${error.message}`);
        document.getElementById('categoryProductsContainer').innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½åº“å­˜äº§å“æ•°æ® (ä¿ç•™ç”¨äºå…¼å®¹)
    async function loadInventoryProducts() {
      await loadCategoryCards();
    }

    // æœç´¢äº§å“
    function searchProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      
      debugLog(`æœç´¢äº§å“: "${searchTerm}", åˆ†ç±»: "${categoryFilter}"`);
      
      // å¦‚æœæœ‰åˆ†ç±»ç­›é€‰ï¼Œç›´æ¥æ˜¾ç¤ºè¯¥åˆ†ç±»çš„äº§å“
      if (categoryFilter) {
        showCategoryProducts(categoryFilter);
        return;
      }
      
      // å¦‚æœæœ‰æœç´¢è¯ï¼Œæ‰§è¡Œæœç´¢
      if (searchTerm) {
        searchProductsByTerm(searchTerm);
        return;
      }
      
      // å¦åˆ™é‡æ–°åŠ è½½åˆ†ç±»å¡ç‰‡
      loadCategoryCards();
    }

    // æŒ‰æœç´¢è¯æœç´¢äº§å“
    async function searchProductsByTerm(searchTerm) {
      debugLog(`æŒ‰æœç´¢è¯æœç´¢: ${searchTerm}`);
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';
      
      try {
        const response = await fetch(`/api/products?search=${encodeURIComponent(searchTerm)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        const products = result.data || [];
        
        if (products.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ”</div>
              <h3>æœªæ‰¾åˆ°åŒ¹é…çš„äº§å“</h3>
              <p>è¯·å°è¯•å…¶ä»–æœç´¢è¯</p>
            </div>
          `;
          return;
        }
        
        // æ˜¾ç¤ºæœç´¢ç»“æœè¡¨æ ¼
        const html = `
          <div style="margin-bottom: 15px;">
            <h3>ğŸ” æœç´¢ç»“æœ (${products.length} ä¸ªäº§å“)</h3>
            <button onclick="loadCategoryCards()" class="btn btn-primary" style="margin-left: 10px;">è¿”å›åˆ†ç±»è§†å›¾</button>
          </div>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>åˆ†ç±»</th>
                  <th>æ•°é‡</th>
                  <th>è¿›è´§ä»·</th>
                  <th>æ‰¹å‘ä»·</th>
                  <th>é›¶å”®ä»·</th>
                  <th>ä½ç½®</th>
                  <th>çŠ¶æ€</th>
                  <th>ç®¡ç†æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${products.map(product => {
                  const stockQuantity = product.stockQuantity || product.quantity || 0;
                  const hasSerialNumbers = product.serialNumbers && product.serialNumbers.length > 0;
                  const statusBadge = stockQuantity > 0 ? 
                    '<span class="status-badge status-received">âœ… æœ‰åº“å­˜</span>' :
                    '<span class="status-badge status-pending">âŒ ç¼ºè´§</span>';
                  
                  // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                  const locationDisplay = product.location?.fullLocation || 'æœªè®¾ç½®';
                  
                  // æ˜¾ç¤ºåºåˆ—å·ä¿¡æ¯ï¼ˆéšè—ï¼Œç‚¹å‡»æ˜¾ç¤ºï¼‰
                  let serialInfo = '';
                  if (hasSerialNumbers) {
                    const serialNumbers = product.serialNumbers.map(sn => sn.serialNumber);
                    const serialCount = serialNumbers.length;
                    serialInfo = `
                      <br>
                      <small style="color: #6b7280; cursor: pointer;" onclick="toggleSerialNumbers('${product._id}')">
                        ğŸ“± åºåˆ—å· (${serialCount}ä¸ª) 
                        <span style="color: #3b82f6;">ç‚¹å‡»æŸ¥çœ‹</span>
                      </small>
                      <div id="serial-${product._id}" style="display: none; margin-top: 5px; padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 11px;">
                        ${serialNumbers.map((sn, index) => `<div>${index + 1}. ${sn}</div>`).join('')}
                      </div>
                    `;
                  } else if (product.barcode) {
                    serialInfo = `<br><small style="color: #6b7280;">æ¡ç : ${product.barcode}</small>`;
                  }
                  
                  return `
                    <tr>
                      <td style="font-weight: 600;">
                        <span style="color: #667eea; cursor: pointer; text-decoration: underline;" 
                              onclick="showProductInvoices('${product._id}', '${product.name.replace(/'/g, "\\'")}')">
                          ${product.name}
                        </span>
                        ${serialInfo}
                      </td>
                      <td>${product.productType || '-'}</td>
                      <td style="text-align: center; font-weight: 600; color: ${stockQuantity > 0 ? '#059669' : '#c53030'};">
                        ${stockQuantity}
                      </td>
                      <td style="color: #059669;">â‚¬${(product.costPrice || product.purchasePrice || 0).toFixed(2)}</td>
                      <td style="color: #d69e2e;">â‚¬${(product.wholesalePrice || 0).toFixed(2)}</td>
                      <td style="color: #7c3aed;">â‚¬${(product.retailPrice || product.suggestedRetailPrice || 0).toFixed(2)}</td>
                      <td>${locationDisplay}</td>
                      <td>${statusBadge}</td>
                      <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                          <button onclick="adjustPrice('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #667eea; color: white;">
                            ğŸ’° è°ƒä»·
                          </button>
                          ${!hasSerialNumbers ? `
                          <button onclick="adjustQuantity('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #48bb78; color: white;">
                            ğŸ“Š è°ƒé‡
                          </button>
                          ` : ''}
                          <button onclick="setLocation('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #ed8936; color: white;">
                            ğŸ“ ä½ç½®
                          </button>
                          <button onclick="changeStatus('${product._id}')" class="btn" style="padding: 4px 8px; font-size: 12px; background: #9f7aea; color: white;">
                            ğŸ·ï¸ çŠ¶æ€
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${error.message}</div>`;
      }
    }

    // å…³é—­æ¨¡æ€çª—å£ï¼ˆæ”¯æŒåµŒå¥—æ¨¡æ€çª—å£ï¼‰
    function closeModal() {
      // æ‰¾åˆ°æ‰€æœ‰æ¨¡æ€çª—å£ï¼ŒæŒ‰z-indexæ’åºï¼Œå…³é—­æœ€é¡¶å±‚çš„
      // åªæŸ¥æ‰¾çœŸæ­£çš„æ¨¡æ€çª—å£ï¼ˆæœ‰èƒŒæ™¯é®ç½©ä¸”z-index >= 9000ï¼‰
      const modals = Array.from(document.querySelectorAll('[style*="position: fixed"]')).filter(modal => {
        const zIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
        const hasOverlay = modal.style.background && modal.style.background.includes('rgba');
        return zIndex >= 9000 && hasOverlay;
      });
      
      if (modals.length === 0) return;
      
      // æŒ‰z-indexæ’åºï¼Œæ‰¾åˆ°æœ€é¡¶å±‚çš„æ¨¡æ€çª—å£
      const topModal = modals.reduce((top, current) => {
        const topZIndex = parseInt(window.getComputedStyle(top).zIndex) || 0;
        const currentZIndex = parseInt(window.getComputedStyle(current).zIndex) || 0;
        return currentZIndex > topZIndex ? current : top;
      });
      
      topModal.remove();
    }

    // åˆ›å»ºæ¨¡æ€çª—å£ï¼ˆå¸¦ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½å’Œæ­£ç¡®çš„z-indexï¼‰
    function createModal(content, zIndex = 10000) {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¨¡æ€çª—å£ï¼Œå¦‚æœæœ‰åˆ™å¢åŠ z-index
      // åªè€ƒè™‘çœŸæ­£çš„æ¨¡æ€çª—å£ï¼ˆz-index >= 9000ï¼‰
      const existingModals = Array.from(document.querySelectorAll('[style*="position: fixed"]')).filter(modal => {
        const modalZIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
        const hasOverlay = modal.style.background && modal.style.background.includes('rgba');
        return modalZIndex >= 9000 && hasOverlay;
      });
      
      if (existingModals.length > 0) {
        zIndex = Math.max(...existingModals.map(m => 
          parseInt(window.getComputedStyle(m).zIndex) || 0
        )) + 100;
      }
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: ${zIndex}; display: flex;
        align-items: center; justify-content: center; padding: 20px;
      `;
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€çª—å£
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      modal.innerHTML = content;
      document.body.appendChild(modal);
      return modal;
    }

    // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€çª—å£çš„æ”¯æŒ
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        // åªæŸ¥æ‰¾çœŸæ­£çš„æ¨¡æ€çª—å£
        const modals = Array.from(document.querySelectorAll('[style*="position: fixed"]')).filter(modal => {
          const zIndex = parseInt(window.getComputedStyle(modal).zIndex) || 0;
          const hasOverlay = modal.style.background && modal.style.background.includes('rgba');
          return zIndex >= 9000 && hasOverlay;
        });
        
        if (modals.length > 0) {
          closeModal();
        }
      }
    });

    // ä»·æ ¼è°ƒæ•´
    function adjustPrice(productId) {
      debugLog(`è°ƒæ•´äº§å“ä»·æ ¼: ${productId}`);
      
      // å…ˆè·å–äº§å“å½“å‰ä»·æ ¼
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            
            const content = `
              <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 100%;">
                <h3 style="margin-bottom: 20px;">ğŸ’° ä»·æ ¼è°ƒæ•´ - ${product.name}</h3>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">è¿›è´§ä»· (â‚¬)</label>
                  <input type="number" id="purchasePrice" step="0.01" value="${product.costPrice || 0}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ‰¹å‘ä»· (â‚¬)</label>
                  <input type="number" id="wholesalePrice" step="0.01" value="${product.wholesalePrice || 0}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">é›¶å”®ä»· (â‚¬)</label>
                  <input type="number" id="retailPrice" step="0.01" value="${product.retailPrice || 0}" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                  <button onclick="savePriceAdjustment('${productId}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                </div>
              </div>
            `;
            
            createModal(content);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // æ•°é‡è°ƒæ•´
    function adjustQuantity(productId) {
      debugLog(`è°ƒæ•´äº§å“æ•°é‡: ${productId}`);
      
      // å…ˆè·å–äº§å“ä¿¡æ¯ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰åºåˆ—å·
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åºåˆ—å·
            if (product.serialNumbers && product.serialNumbers.length > 0) {
              alert('æœ‰åºåˆ—å·/IMEIçš„äº§å“ä¸èƒ½è°ƒæ•´æ•°é‡');
              return;
            }
            
            const content = `
              <div style="background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 100%;">
                <h3 style="margin-bottom: 20px;">ğŸ“Š æ•°é‡è°ƒæ•´ - ${product.name}</h3>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰åº“å­˜: ${product.stockQuantity || 0}</label>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">è°ƒæ•´ç±»å‹</label>
                  <select id="adjustmentType" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="add">å¢åŠ åº“å­˜</option>
                    <option value="subtract">å‡å°‘åº“å­˜</option>
                    <option value="set">è®¾ç½®åº“å­˜</option>
                  </select>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ•°é‡</label>
                  <input type="number" id="quantityValue" min="0" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
                  <textarea id="adjustmentNote" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;" placeholder="è°ƒæ•´åŸå› ..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                  <button onclick="saveQuantityAdjustment('${productId}')" style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                </div>
              </div>
            `;
            
            createModal(content);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // è®¾ç½®ä½ç½®
    function setLocation(productId) {
      debugLog(`è®¾ç½®äº§å“ä½ç½®: ${productId}`);
      
      // å…ˆè·å–äº§å“å½“å‰ä½ç½®å’Œå­˜å‚¨ä½ç½®ç›®å½•
      Promise.all([
        fetch(`${API_BASE}/products/${productId}`).then(r => r.json()),
        fetch(`${API_BASE}/storage-locations`).then(r => r.json())
      ])
      .then(([productResult, locationsResult]) => {
        if (productResult.success && locationsResult.success) {
          const product = productResult.data;
          const locations = locationsResult.data;
          
          const content = `
            <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 100%;">
              <h3 style="margin-bottom: 20px;">ğŸ“ è®¾ç½®å­˜å‚¨ä½ç½® - ${product.name}</h3>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰ä½ç½®: ${product.location?.fullLocation || 'æœªè®¾ç½®'}</label>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">ä»“åº“åŒºåŸŸ</label>
                <select id="warehouseArea" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <option value="">é€‰æ‹©åŒºåŸŸ...</option>
                  ${locations.predefinedAreas.map(area => 
                    `<option value="${area.area}" ${product.location?.area === area.area ? 'selected' : ''}>${area.area} - ${area.description}</option>`
                  ).join('')}
                </select>
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">è´§æ¶å·</label>
                <input type="text" id="shelfNumber" value="${product.location?.shelf || ''}" placeholder="å¦‚: A01, B15" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              </div>
              <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å…·ä½“ä½ç½®</label>
                <input type="text" id="specificLocation" value="${product.location?.position || ''}" placeholder="å¦‚: ç¬¬3å±‚å·¦ä¾§" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¸¸ç”¨ä½ç½®</label>
                <select onchange="fillLocationFromUsed(this.value)" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                  <option value="">é€‰æ‹©å¸¸ç”¨ä½ç½®...</option>
                  ${locations.usedLocations.map(loc => 
                    `<option value="${loc}">${loc}</option>`
                  ).join('')}
                </select>
              </div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                <button onclick="saveLocation('${productId}')" style="padding: 8px 16px; background: #ed8936; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
              </div>
            </div>
          `;
          
          createModal(content);
        } else {
          alert('è·å–äº§å“æˆ–ä½ç½®ä¿¡æ¯å¤±è´¥');
        }
      })
      .catch(error => {
        alert('è·å–ä¿¡æ¯å¤±è´¥: ' + error.message);
      });
    }

    // ä»å¸¸ç”¨ä½ç½®å¡«å……è¡¨å•
    function fillLocationFromUsed(locationString) {
      if (!locationString) return;
      
      const parts = locationString.split('-');
      if (parts.length >= 1) document.getElementById('warehouseArea').value = parts[0];
      if (parts.length >= 2) document.getElementById('shelfNumber').value = parts[1];
      if (parts.length >= 3) document.getElementById('specificLocation').value = parts.slice(2).join('-');
    }

    // ä¿å­˜ä»·æ ¼è°ƒæ•´
    async function savePriceAdjustment(productId) {
      const costPrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
      const wholesalePrice = parseFloat(document.getElementById('wholesalePrice').value) || 0;
      const retailPrice = parseFloat(document.getElementById('retailPrice').value) || 0;
      
      // éªŒè¯ä»·æ ¼é€»è¾‘
      if (costPrice >= wholesalePrice) {
        alert('æ‰¹å‘ä»·å¿…é¡»é«˜äºè¿›è´§ä»·');
        return;
      }
      
      if (wholesalePrice >= retailPrice) {
        alert('é›¶å”®ä»·å¿…é¡»é«˜äºæ‰¹å‘ä»·');
        return;
      }
      
      debugLog(`ä¿å­˜ä»·æ ¼è°ƒæ•´: ${productId}, è¿›è´§ä»·: ${costPrice}, æ‰¹å‘ä»·: ${wholesalePrice}, é›¶å”®ä»·: ${retailPrice}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/price`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            costPrice,
            wholesalePrice,
            retailPrice
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ä»·æ ¼è°ƒæ•´æˆåŠŸ');
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('ä»·æ ¼è°ƒæ•´å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('ä»·æ ¼è°ƒæ•´å¤±è´¥: ' + error.message);
      }
    }

    // ä¿å­˜æ•°é‡è°ƒæ•´
    async function saveQuantityAdjustment(productId) {
      const type = document.getElementById('adjustmentType').value;
      const quantity = parseInt(document.getElementById('quantityValue').value) || 0;
      const note = document.getElementById('adjustmentNote').value;
      
      if (quantity <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
        return;
      }
      
      debugLog(`ä¿å­˜æ•°é‡è°ƒæ•´: ${productId}, ç±»å‹: ${type}, æ•°é‡: ${quantity}, å¤‡æ³¨: ${note}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/quantity`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            type,
            quantity,
            note
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`æ•°é‡è°ƒæ•´æˆåŠŸ: ${result.data.oldQuantity} â†’ ${result.data.newQuantity}`);
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('æ•°é‡è°ƒæ•´å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('æ•°é‡è°ƒæ•´å¤±è´¥: ' + error.message);
      }
    }

    // ä¿å­˜ä½ç½®è®¾ç½®
    async function saveLocation(productId) {
      const area = document.getElementById('warehouseArea').value;
      const shelf = document.getElementById('shelfNumber').value;
      const position = document.getElementById('specificLocation').value;
      
      debugLog(`ä¿å­˜ä½ç½®è®¾ç½®: ${productId}, åŒºåŸŸ: ${area}, è´§æ¶: ${shelf}, ä½ç½®: ${position}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/location`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            area,
            shelf,
            position
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          const location = result.data.fullLocation || 'æœªè®¾ç½®';
          alert(`ä½ç½®è®¾ç½®æˆåŠŸ: ${location}`);
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('ä½ç½®è®¾ç½®å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('ä½ç½®è®¾ç½®å¤±è´¥: ' + error.message);
      }
    }

    // çŠ¶æ€ç®¡ç†
    function changeStatus(productId) {
      debugLog(`æ›´æ”¹äº§å“çŠ¶æ€: ${productId}`);
      
      // å…ˆè·å–äº§å“å½“å‰çŠ¶æ€
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            
            const content = `
              <div style="background: white; border-radius: 12px; padding: 25px; max-width: 400px; width: 100%;">
                <h3 style="margin-bottom: 20px;">ğŸ·ï¸ çŠ¶æ€ç®¡ç† - ${product.name}</h3>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰çŠ¶æ€: ${getStatusText(product.status || 'available')}</label>
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰æˆè‰²: ${getConditionText(product.condition || 'Brand New')}</label>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“çŠ¶æ€</label>
                  <select id="productStatus" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="available" ${product.status === 'available' ? 'selected' : ''}>å¯é”€å”®</option>
                    <option value="reserved" ${product.status === 'reserved' ? 'selected' : ''}>å·²é¢„è®¢</option>
                    <option value="damaged" ${product.status === 'damaged' ? 'selected' : ''}>æŸå</option>
                    <option value="repair" ${product.status === 'repair' ? 'selected' : ''}>ç»´ä¿®ä¸­</option>
                    <option value="discontinued" ${product.status === 'discontinued' ? 'selected' : ''}>åœäº§</option>
                  </select>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆè‰²ç­‰çº§</label>
                  <select id="conditionGrade" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <option value="Brand New" ${product.condition === 'Brand New' ? 'selected' : ''}>å…¨æ–°</option>
                    <option value="Pre-Owned" ${product.condition === 'Pre-Owned' ? 'selected' : ''}>äºŒæ‰‹</option>
                    <option value="Refurbished" ${product.condition === 'Refurbished' ? 'selected' : ''}>ç¿»æ–°</option>
                  </select>
                </div>
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
                  <textarea id="statusNote" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;" placeholder="çŠ¶æ€å˜æ›´åŸå› ..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                  <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
                  <button onclick="saveStatusChange('${productId}')" style="padding: 8px 16px; background: #9f7aea; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
                </div>
              </div>
            `;
            
            createModal(content);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const statusMap = {
        'available': 'å¯é”€å”®',
        'reserved': 'å·²é¢„è®¢',
        'damaged': 'æŸå',
        'repair': 'ç»´ä¿®ä¸­',
        'discontinued': 'åœäº§'
      };
      return statusMap[status] || status;
    }

    // è·å–æˆè‰²æ–‡æœ¬
    function getConditionText(condition) {
      const conditionMap = {
        'Brand New': 'å…¨æ–°',
        'Pre-Owned': 'äºŒæ‰‹',
        'Refurbished': 'ç¿»æ–°'
      };
      return conditionMap[condition] || condition;
    }

    // ä¿å­˜çŠ¶æ€å˜æ›´
    async function saveStatusChange(productId) {
      const status = document.getElementById('productStatus').value;
      const condition = document.getElementById('conditionGrade').value;
      const note = document.getElementById('statusNote').value;
      
      debugLog(`ä¿å­˜çŠ¶æ€å˜æ›´: ${productId}, çŠ¶æ€: ${status}, æˆè‰²: ${condition}, å¤‡æ³¨: ${note}`);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status,
            condition,
            note
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`çŠ¶æ€æ›´æ–°æˆåŠŸ: ${getStatusText(result.data.status)} - ${getConditionText(result.data.condition)}`);
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          loadCategoryProductDetails(getCurrentCategory());
        } else {
          alert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // è·å–å½“å‰åˆ†ç±»ï¼ˆç”¨äºåˆ·æ–°ï¼‰
    function getCurrentCategory() {
      // ä»å½“å‰æ˜¾ç¤ºçš„æ¨¡æ€çª—å£æ ‡é¢˜ä¸­æå–åˆ†ç±»åç§°
      const modal = document.getElementById('categoryModal');
      if (modal) {
        const title = modal.querySelector('h3');
        if (title) {
          const match = title.textContent.match(/^[^-]+ (.+) - äº§å“ç®¡ç†$/);
          if (match) {
            return match[1];
          }
        }
      }
      return null;
    }

    // æ˜¾ç¤ºäº§å“çš„é‡‡è´­å‘ç¥¨
    async function showProductInvoices(productId, productName) {
      debugLog(`æ˜¾ç¤ºäº§å“é‡‡è´­å‘ç¥¨: ${productId} - ${productName}`);
      
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 98vw; width: 1400px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>ğŸ“„ ${productName} - é‡‡è´­å‘ç¥¨è®°å½•</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          <div id="productInvoicesContainer">
            <div class="loading">æ­£åœ¨åŠ è½½é‡‡è´­å‘ç¥¨...</div>
          </div>
        </div>
      `;
      
      createModal(content);
      
      try {
        debugLog(`æ­£åœ¨è¯·æ±‚API: ${API_BASE}/products/${productId}/purchase-invoices`);
        const response = await fetch(`${API_BASE}/products/${productId}/purchase-invoices`);
        debugLog(`APIå“åº”çŠ¶æ€: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`äº§å“é‡‡è´­å‘ç¥¨APIå“åº”: ${result.data?.length || 0} å¼ å‘ç¥¨`);
        
        const container = document.getElementById('productInvoicesContainer');
        
        if (result.success && result.data && result.data.length > 0) {
          const invoices = result.data;
          
          const html = `
            <div style="margin-bottom: 15px;">
              <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:</strong> å…±æ‰¾åˆ° ${invoices.length} å¼ é‡‡è´­å‘ç¥¨ï¼Œ
                æ€»é‡‡è´­æ•°é‡: ${invoices.reduce((sum, inv) => sum + inv.productItems.reduce((itemSum, item) => itemSum + item.quantity, 0), 0)} ä¸ª
              </div>
            </div>
            
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f8fafc;">
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">å‘ç¥¨å·</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">ä¾›åº”å•†</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">å‘ç¥¨æ—¥æœŸ</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">é‡‡è´­æ•°é‡</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">å•ä»·</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">æ€»ä»·</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">æˆè‰²</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">åºåˆ—å·/æ¡ç </th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">çŠ¶æ€</th>
                  </tr>
                </thead>
                <tbody>
                  ${invoices.map(invoice => {
                    return invoice.productItems.map(item => `
                      <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 10px; font-weight: 600; color: #1e40af;">
                          <span style="cursor: pointer; text-decoration: underline;" 
                                onclick="showInvoiceDetails('${invoice._id}', '${invoice.invoiceNumber}')">
                            ${invoice.invoiceNumber}
                          </span>
                          <br><small style="color: #6b7280; font-weight: normal;">
                            å‘ç¥¨æ€»é¢: ${invoice.currency} ${(invoice.totalAmount || 0).toFixed(2)}
                          </small>
                        </td>
                        <td style="padding: 10px;">
                          <div style="font-weight: 600;">${invoice.supplier.name}</div>
                          ${invoice.supplier.phone ? `<small style="color: #6b7280;">ğŸ“ ${invoice.supplier.phone}</small><br>` : ''}
                          ${invoice.supplier.email ? `<small style="color: #6b7280;">ğŸ“§ ${invoice.supplier.email}</small>` : ''}
                        </td>
                        <td style="padding: 10px;">
                          <div>${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</div>
                          ${invoice.dueDate ? `<small style="color: #6b7280;">åˆ°æœŸ: ${new Date(invoice.dueDate).toLocaleDateString('zh-CN')}</small>` : ''}
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #059669;">
                          ${item.quantity}
                        </td>
                        <td style="padding: 10px; color: #059669;">
                          ${invoice.currency} ${item.unitPrice?.toFixed(2) || '0.00'}
                        </td>
                        <td style="padding: 10px; font-weight: 600; color: #7c3aed;">
                          ${invoice.currency} ${item.totalPrice?.toFixed(2) || '0.00'}
                        </td>
                        <td style="padding: 10px;">
                          <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                       background: #dcfce7; color: #166534;">
                            å…¨æ–°
                          </span>
                        </td>
                        <td style="padding: 10px;">
                          ${item.serialNumbers && item.serialNumbers.length > 0 ? 
                            item.serialNumbers.map(sn => `<div style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px;">${sn}</div>`).join('') : ''}
                          ${item.barcode ? `<div style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${item.barcode}</div>` : ''}
                          ${!item.serialNumbers?.length && !item.barcode ? '<span style="color: #9ca3af;">-</span>' : ''}
                        </td>
                        <td style="padding: 10px;">
                          <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                       background: ${invoice.status === 'received' ? '#dcfce7' : '#fef3c7'}; 
                                       color: ${invoice.status === 'received' ? '#166534' : '#92400e'};">
                            ${invoice.status === 'received' ? 'âœ… å·²æ”¶è´§' : 'â³ å¾…å¤„ç†'}
                          </span>
                        </td>
                      </tr>
                    `).join('');
                  }).join('')}
                </tbody>
              </table>
            </div>
            
            ${invoices.some(inv => inv.notes) ? `
              <div style="margin-top: 20px;">
                <h4 style="margin-bottom: 10px;">ğŸ“ å¤‡æ³¨ä¿¡æ¯</h4>
                ${invoices.filter(inv => inv.notes).map(inv => `
                  <div style="background: #fffbeb; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #f59e0b;">
                    <strong>${inv.invoiceNumber}:</strong> ${inv.notes}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          `;
          
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“„</div>
              <h3>æš‚æ— é‡‡è´­è®°å½•</h3>
              <p>è¯¥äº§å“è¿˜æ²¡æœ‰é‡‡è´­å‘ç¥¨è®°å½•</p>
            </div>
          `;
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½äº§å“é‡‡è´­å‘ç¥¨å¤±è´¥: ${error.message}`);
        document.getElementById('productInvoicesContainer').innerHTML = `
          <div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // æ˜¾ç¤ºå‘ç¥¨è¯¦ç»†ä¿¡æ¯
    async function showInvoiceDetails(invoiceId, invoiceNumber) {
      debugLog(`æ˜¾ç¤ºå‘ç¥¨è¯¦ç»†ä¿¡æ¯: ${invoiceId} - ${invoiceNumber}`);
      
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 98vw; width: 1500px; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>ğŸ“„ å‘ç¥¨è¯¦æƒ… - ${invoiceNumber}</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          <div id="invoiceDetailsContainer">
            <div class="loading">æ­£åœ¨åŠ è½½å‘ç¥¨è¯¦æƒ…...</div>
          </div>
        </div>
      `;
      
      createModal(content);
      
      try {
        const response = await fetch(`${API_BASE}/purchase-orders/${invoiceId}`);
        debugLog(`å‘ç¥¨è¯¦æƒ…APIå“åº”çŠ¶æ€: ${response.status}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`å‘ç¥¨è¯¦æƒ…æ•°æ®: ${JSON.stringify(result)}`);
        
        const container = document.getElementById('invoiceDetailsContainer');
        
        if (result.success && result.data) {
          const invoice = result.data;
          
          const html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
              <!-- å‘ç¥¨åŸºæœ¬ä¿¡æ¯ -->
              <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                <h4 style="margin-bottom: 15px; color: #1e40af;">ğŸ“‹ å‘ç¥¨ä¿¡æ¯</h4>
                <div style="display: grid; gap: 8px;">
                  <div><strong>å‘ç¥¨å·:</strong> ${invoice.invoiceNumber}</div>
                  <div><strong>å‘ç¥¨æ—¥æœŸ:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString('zh-CN')}</div>
                  <div><strong>åˆ°æœŸæ—¥æœŸ:</strong> ${invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString('zh-CN') : 'æœªè®¾ç½®'}</div>
                  <div><strong>è´§å¸:</strong> ${invoice.currency}</div>
                  <div><strong>çŠ¶æ€:</strong> 
                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                 background: ${invoice.status === 'received' ? '#dcfce7' : invoice.status === 'confirmed' ? '#dbeafe' : '#fef3c7'}; 
                                 color: ${invoice.status === 'received' ? '#166534' : invoice.status === 'confirmed' ? '#1e40af' : '#92400e'};">
                      ${invoice.status === 'received' ? 'âœ… å·²æ”¶è´§' : invoice.status === 'confirmed' ? 'âœ“ å·²ç¡®è®¤' : 'â³ å¾…å¤„ç†'}
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- ä¾›åº”å•†ä¿¡æ¯ -->
              <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border-left: 4px solid #22c55e;">
                <h4 style="margin-bottom: 15px; color: #166534;">ğŸ¢ ä¾›åº”å•†ä¿¡æ¯</h4>
                <div style="display: grid; gap: 8px;">
                  <div><strong>å…¬å¸åç§°:</strong> ${invoice.supplier?.name || 'æœªçŸ¥ä¾›åº”å•†'}</div>
                  <div><strong>è”ç³»ç”µè¯:</strong> ${invoice.supplier?.phone || 'æœªæä¾›'}</div>
                  <div><strong>ç”µå­é‚®ç®±:</strong> ${invoice.supplier?.email || 'æœªæä¾›'}</div>
                  <div><strong>åœ°å€:</strong> ${invoice.supplier?.address ? 
                    (typeof invoice.supplier.address === 'string' ? invoice.supplier.address : 
                     `${invoice.supplier.address.street || ''} ${invoice.supplier.address.city || ''} ${invoice.supplier.address.state || ''} ${invoice.supplier.address.postalCode || ''} ${invoice.supplier.address.country || ''}`.trim()) 
                    : 'æœªæä¾›'}</div>
                </div>
              </div>
            </div>
            
            <!-- é‡‘é¢ä¿¡æ¯ -->
            <div style="background: #fefce8; padding: 20px; border-radius: 12px; border-left: 4px solid #eab308; margin-bottom: 25px;">
              <h4 style="margin-bottom: 15px; color: #a16207;">ğŸ’° é‡‘é¢æ˜ç»†</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div style="text-align: center;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">å°è®¡ï¼ˆä¸å«ç¨ï¼‰</div>
                  <div style="font-size: 18px; font-weight: 600; color: #059669;">
                    ${invoice.currency} ${(invoice.subtotal || 0).toFixed(2)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ç¨é¢</div>
                  <div style="font-size: 18px; font-weight: 600; color: #dc2626;">
                    ${invoice.currency} ${(invoice.taxAmount || 0).toFixed(2)}
                  </div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">æ€»é‡‘é¢ï¼ˆå«ç¨ï¼‰</div>
                  <div style="font-size: 20px; font-weight: 700; color: #7c3aed;">
                    ${invoice.currency} ${(invoice.totalAmount || 0).toFixed(2)}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- äº§å“æ˜ç»† -->
            <div style="margin-bottom: 25px;">
              <h4 style="margin-bottom: 15px;">ğŸ“¦ äº§å“æ˜ç»†</h4>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f8fafc;">
                      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0;">äº§å“æè¿°</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">æ•°é‡</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">å•ä»·</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0;">æ€»ä»·</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0;">åºåˆ—å·</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(invoice.items || []).map(item => `
                      <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 12px;">
                          <div style="font-weight: 600;">${item.description || 'æœªçŸ¥äº§å“'}</div>
                          ${item.product ? `<small style="color: #6b7280;">äº§å“ID: ${item.product}</small>` : ''}
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #059669;">
                          ${item.quantity}
                        </td>
                        <td style="padding: 12px; text-align: right; color: #059669;">
                          ${invoice.currency} ${(item.unitCost || 0).toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #7c3aed;">
                          ${invoice.currency} ${(item.totalCost || 0).toFixed(2)}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                          ${item.serialNumbers && item.serialNumbers.length > 0 ? 
                            item.serialNumbers.map(sn => `<div style="font-family: monospace; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-bottom: 2px;">${sn}</div>`).join('') : 
                            '<span style="color: #9ca3af;">-</span>'}
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            ${invoice.notes ? `
              <div style="background: #fffbeb; padding: 15px; border-radius: 8px; border-left: 3px solid #f59e0b;">
                <h4 style="margin-bottom: 10px; color: #92400e;">ğŸ“ å¤‡æ³¨</h4>
                <p style="margin: 0; color: #78350f;">${invoice.notes}</p>
              </div>
            ` : ''}
          `;
          
          container.innerHTML = html;
        } else {
          container.innerHTML = `
            <div class="error">è·å–å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>
          `;
        }
      } catch (error) {
        debugLog(`âŒ åŠ è½½å‘ç¥¨è¯¦æƒ…å¤±è´¥: ${error.message}`);
        document.getElementById('invoiceDetailsContainer').innerHTML = `
          <div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // åˆ‡æ¢åºåˆ—å·æ˜¾ç¤º/éšè—
    function toggleSerialNumbers(productId) {
      const serialDiv = document.getElementById(`serial-${productId}`);
      const toggleText = document.querySelector(`[onclick="toggleSerialNumbers('${productId}')"] span`);
      
      if (serialDiv && toggleText) {
        if (serialDiv.style.display === 'none') {
          serialDiv.style.display = 'block';
          toggleText.textContent = 'ç‚¹å‡»éšè—';
          toggleText.style.color = '#ef4444';
        } else {
          serialDiv.style.display = 'none';
          toggleText.textContent = 'ç‚¹å‡»æŸ¥çœ‹';
          toggleText.style.color = '#3b82f6';
        }
      }
    }

    // é€šè¿‡åºåˆ—å·ç¼–è¾‘äº§å“
    function editProductBySerial(productId, serialNumber, productName) {
      debugLog(`ç¼–è¾‘äº§å“: ${productId}, åºåˆ—å·: ${serialNumber}`);
      
      // å…ˆè·å–äº§å“è¯¦ç»†ä¿¡æ¯
      fetch(`${API_BASE}/products/${productId}`)
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const product = result.data;
            showProductEditModal(product, serialNumber);
          } else {
            alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + result.error);
          }
        })
        .catch(error => {
          alert('è·å–äº§å“ä¿¡æ¯å¤±è´¥: ' + error.message);
        });
    }

    // æ˜¾ç¤ºäº§å“ç¼–è¾‘æ¨¡æ€çª—å£
    function showProductEditModal(product, serialNumber = null) {
      const content = `
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>âœï¸ ç¼–è¾‘äº§å“ä¿¡æ¯${serialNumber ? ` - ${serialNumber}` : ''}</h3>
            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; padding: 5px;">âœ•</button>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“åç§°</label>
              <input type="text" id="editProductName" value="${product.name || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">å“ç‰Œ</label>
              <input type="text" id="editProductBrand" value="${product.brand || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">å‹å·</label>
              <input type="text" id="editProductModel" value="${product.model || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">é¢œè‰²</label>
              <input type="text" id="editProductColor" value="${product.color || ''}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">è¿›è´§ä»· (â‚¬)</label>
              <input type="number" id="editCostPrice" step="0.01" value="${product.costPrice || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ‰¹å‘ä»· (â‚¬)</label>
              <input type="number" id="editWholesalePrice" step="0.01" value="${product.wholesalePrice || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">é›¶å”®ä»· (â‚¬)</label>
              <input type="number" id="editRetailPrice" step="0.01" value="${product.retailPrice || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">äº§å“åˆ†ç±»</label>
              <select id="editProductType" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="æ‰‹æœºé…ä»¶" ${product.productType === 'æ‰‹æœºé…ä»¶' ? 'selected' : ''}>æ‰‹æœºé…ä»¶</option>
                <option value="ç”µè„‘é…ä»¶" ${product.productType === 'ç”µè„‘é…ä»¶' ? 'selected' : ''}>ç”µè„‘é…ä»¶</option>
                <option value="è½¦è½½é…ä»¶" ${product.productType === 'è½¦è½½é…ä»¶' ? 'selected' : ''}>è½¦è½½é…ä»¶</option>
                <option value="audio" ${product.productType === 'audio' ? 'selected' : ''}>Audio</option>
                <option value="æ•°æ®çº¿" ${product.productType === 'æ•°æ®çº¿' ? 'selected' : ''}>æ•°æ®çº¿</option>
                <option value="power supply" ${product.productType === 'power supply' ? 'selected' : ''}>Power Supply</option>
                <option value="å…¨æ–°è®¾å¤‡" ${product.productType === 'å…¨æ–°è®¾å¤‡' ? 'selected' : ''}>å…¨æ–°è®¾å¤‡</option>
                <option value="äºŒæ‰‹è®¾å¤‡" ${product.productType === 'äºŒæ‰‹è®¾å¤‡' ? 'selected' : ''}>äºŒæ‰‹è®¾å¤‡</option>
                <option value="ç»´ä¿®" ${product.productType === 'ç»´ä¿®' ? 'selected' : ''}>ç»´ä¿®</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">æˆè‰²</label>
              <select id="editCondition" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="Brand New" ${product.condition === 'Brand New' ? 'selected' : ''}>å…¨æ–°</option>
                <option value="Pre-Owned" ${product.condition === 'Pre-Owned' ? 'selected' : ''}>äºŒæ‰‹</option>
                <option value="Refurbished" ${product.condition === 'Refurbished' ? 'selected' : ''}>ç¿»æ–°</option>
              </select>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">çŠ¶æ€</label>
              <select id="editStatus" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
                <option value="available" ${product.status === 'available' ? 'selected' : ''}>å¯é”€å”®</option>
                <option value="reserved" ${product.status === 'reserved' ? 'selected' : ''}>å·²é¢„è®¢</option>
                <option value="damaged" ${product.status === 'damaged' ? 'selected' : ''}>æŸå</option>
                <option value="repair" ${product.status === 'repair' ? 'selected' : ''}>ç»´ä¿®ä¸­</option>
                <option value="discontinued" ${product.status === 'discontinued' ? 'selected' : ''}>åœäº§</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: 500;">åº“å­˜æ•°é‡</label>
              <input type="number" id="editStockQuantity" min="0" value="${product.stockQuantity || 0}" 
                     style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;"
                     ${product.serialNumbers && product.serialNumbers.length > 0 ? 'readonly' : ''}>
              ${product.serialNumbers && product.serialNumbers.length > 0 ? 
                '<small style="color: #6b7280;">æœ‰åºåˆ—å·çš„äº§å“ä¸èƒ½ç›´æ¥ä¿®æ”¹æ•°é‡</small>' : ''}
            </div>
          </div>
          
          ${product.barcode ? `
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">æ¡ç </label>
            <input type="text" id="editBarcode" value="${product.barcode || ''}" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          ` : ''}
          
          ${serialNumber ? `
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å½“å‰åºåˆ—å·</label>
            <input type="text" id="editSerialNumber" value="${serialNumber}" 
                   style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          </div>
          ` : ''}
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">å¤‡æ³¨</label>
            <textarea id="editNotes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">${product.notes || ''}</textarea>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal()" style="padding: 8px 16px; background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;">å–æ¶ˆ</button>
            <button onclick="saveProductEdit('${product._id}', '${serialNumber || ''}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ä¿å­˜</button>
          </div>
        </div>
      `;
      
      createModal(content);
    }

    // ä¿å­˜äº§å“ç¼–è¾‘
    async function saveProductEdit(productId, originalSerialNumber = '') {
      const updateData = {
        name: document.getElementById('editProductName').value,
        brand: document.getElementById('editProductBrand').value,
        model: document.getElementById('editProductModel').value,
        color: document.getElementById('editProductColor').value,
        costPrice: parseFloat(document.getElementById('editCostPrice').value) || 0,
        wholesalePrice: parseFloat(document.getElementById('editWholesalePrice').value) || 0,
        retailPrice: parseFloat(document.getElementById('editRetailPrice').value) || 0,
        productType: document.getElementById('editProductType').value,
        condition: document.getElementById('editCondition').value,
        status: document.getElementById('editStatus').value,
        stockQuantity: parseInt(document.getElementById('editStockQuantity').value) || 0,
        notes: document.getElementById('editNotes').value
      };
      
      // å¦‚æœæœ‰æ¡ç å­—æ®µï¼Œæ·»åŠ æ¡ç 
      const barcodeInput = document.getElementById('editBarcode');
      if (barcodeInput) {
        updateData.barcode = barcodeInput.value;
      }
      
      // å¦‚æœæœ‰åºåˆ—å·å­—æ®µï¼Œå¤„ç†åºåˆ—å·æ›´æ–°
      const serialNumberInput = document.getElementById('editSerialNumber');
      if (serialNumberInput && originalSerialNumber) {
        updateData.serialNumberUpdate = {
          oldSerialNumber: originalSerialNumber,
          newSerialNumber: serialNumberInput.value
        };
      }
      
      // éªŒè¯ä»·æ ¼é€»è¾‘
      if (updateData.wholesalePrice <= updateData.costPrice) {
        alert('æ‰¹å‘ä»·å¿…é¡»é«˜äºè¿›è´§ä»·');
        return;
      }
      
      if (updateData.retailPrice <= updateData.wholesalePrice) {
        alert('é›¶å”®ä»·å¿…é¡»é«˜äºæ‰¹å‘ä»·');
        return;
      }
      
      debugLog(`ä¿å­˜äº§å“ç¼–è¾‘: ${productId}`, updateData);
      
      try {
        const response = await fetch(`${API_BASE}/products/${productId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('äº§å“ä¿¡æ¯æ›´æ–°æˆåŠŸ');
          closeModal();
          // åˆ·æ–°äº§å“åˆ—è¡¨
          const currentCategory = getCurrentCategory();
          if (currentCategory) {
            loadCategoryProductDetails(currentCategory);
          } else {
            loadCategoryCards();
          }
        } else {
          alert('äº§å“ä¿¡æ¯æ›´æ–°å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('äº§å“ä¿¡æ¯æ›´æ–°å¤±è´¥: ' + error.message);
      }
    }

    // æ‰¹é‡æ“ä½œå‡½æ•°
    function showPriceAdjustment() {
      alert('æ‰¹é‡ä»·æ ¼è°ƒæ•´åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    function showLocationManagement() {
      alert('æ‰¹é‡ä½ç½®ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    function showQuantityAdjustment() {
      alert('æ‰¹é‡æ•°é‡è°ƒæ•´åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    function showStatusManagement() {
      alert('æ‰¹é‡çŠ¶æ€ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­');
    }

    // åŠ è½½æŠ¥è¡¨æ•°æ®
    async function loadReports() {
      debugLog('å¼€å§‹åŠ è½½æŠ¥è¡¨æ•°æ®');
      const container = document.getElementById('reportsContainer');
      container.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆæŠ¥è¡¨...</div>';
      
      // æ¨¡æ‹ŸæŠ¥è¡¨æ•°æ®
      setTimeout(() => {
        container.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div class="stat-card">
              <h3>åº“å­˜å‘¨è½¬ç‡</h3>
              <div class="value" style="color: #48bb78;">85%</div>
              <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">æœ¬æœˆè¾ƒä¸Šæœˆæå‡12%</p>
            </div>
            <div class="stat-card">
              <h3>åº“å­˜ä»·å€¼</h3>
              <div class="value" style="color: #667eea;">â‚¬45,230</div>
              <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">æ€»åº“å­˜æˆæœ¬ä»·å€¼</p>
            </div>
            <div class="stat-card">
              <h3>æ»é”€äº§å“</h3>
              <div class="value" style="color: #ed8936;">23</div>
              <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">è¶…è¿‡30å¤©æœªé”€å”®</p>
            </div>
            <div class="stat-card">
              <h3>ç¼ºè´§äº§å“</h3>
              <div class="value" style="color: #e53e3e;">8</div>
              <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">éœ€è¦åŠæ—¶è¡¥è´§</p>
            </div>
          </div>
          
          <div style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px;">ğŸ“Š è¯¦ç»†æŠ¥è¡¨</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="btn btn-primary">ğŸ“ˆ åº“å­˜è¶‹åŠ¿åˆ†æ</button>
              <button class="btn btn-primary">ğŸ“‹ æ»é”€äº§å“æŠ¥å‘Š</button>
              <button class="btn btn-primary">ğŸ’° åº“å­˜ä»·å€¼åˆ†æ</button>
              <button class="btn btn-primary">ğŸ”„ å‘¨è½¬ç‡æŠ¥å‘Š</button>
            </div>
          </div>
        `;
      }, 1000);
    }

    // åŠ è½½ä¾›åº”å•† (ä¿ç•™ç”¨äºå…¥åº“ç®¡ç†)
    async function loadSuppliers() {
      debugLog('å¼€å§‹åŠ è½½ä¾›åº”å•†æ•°æ®');
      
      try {
        const response = await fetch('/api/suppliers');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`ä¾›åº”å•†APIå“åº”: ${result.data?.length || 0} ä¸ªä¾›åº”å•†`);
        
        return result.data || [];
      } catch (error) {
        debugLog(`âŒ ä¾›åº”å•†æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
        return [];
      }
    }

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadAllData() {
      debugLog('=== å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ® ===');
      await loadStats();
      await loadCategoryCards();
      debugLog('=== æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ ===');
    }

    // å¤„ç†æ–‡ä»¶ä¸Šä¼  - å®ç°çœŸå®çš„å›¾ç‰‡è¯†åˆ«å…¥åº“åŠŸèƒ½
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      debugLog(`é€‰æ‹©æ–‡ä»¶: ${file.name} (${file.type})`);
      
      const resultContainer = document.getElementById('recognitionResult');
      resultContainer.style.display = 'block';
      resultContainer.innerHTML = `
        <div class="card" style="margin-top: 20px;">
          <h3>ğŸ” æ­£åœ¨è¯†åˆ«å‘ç¥¨å†…å®¹...</h3>
          <div class="loading">è¯·ç¨å€™ï¼Œæ­£åœ¨ä½¿ç”¨AIè¯†åˆ«å‘ç¥¨ä¿¡æ¯...</div>
        </div>
      `;
      
      try {
        const formData = new FormData();
        formData.append('invoice', file);
        
        const response = await fetch(`${API_BASE}/recognize-invoice`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        debugLog(`å›¾ç‰‡è¯†åˆ«APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success && result.data) {
          displayRecognitionResult(result.data);
        } else {
          throw new Error(result.message || 'è¯†åˆ«å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ å›¾ç‰‡è¯†åˆ«å¤±è´¥: ${error.message}`);
        resultContainer.innerHTML = `
          <div class="card" style="margin-top: 20px;">
            <div class="error">âŒ è¯†åˆ«å¤±è´¥: ${error.message}</div>
          </div>
        `;
      }
    }

    // åˆ‡æ¢å…¥åº“æ¨¡å¼
    function switchReceivingMode(mode) {
      const uploadMode = document.getElementById('uploadMode');
      const manualMode = document.getElementById('manualMode');
      const uploadBtn = document.getElementById('uploadModeBtn');
      const manualBtn = document.getElementById('manualModeBtn');
      
      if (mode === 'upload') {
        uploadMode.style.display = 'block';
        manualMode.style.display = 'none';
        uploadBtn.classList.add('btn-primary');
        uploadBtn.style.background = '';
        manualBtn.classList.remove('btn-primary');
        manualBtn.style.background = '#48bb78';
        debugLog('åˆ‡æ¢åˆ°å‘ç¥¨ä¸Šä¼ æ¨¡å¼');
      } else {
        uploadMode.style.display = 'none';
        manualMode.style.display = 'block';
        manualBtn.classList.add('btn-primary');
        manualBtn.style.background = '';
        uploadBtn.classList.remove('btn-primary');
        uploadBtn.style.background = '#48bb78';
        debugLog('åˆ‡æ¢åˆ°æ‰‹åŠ¨å½•å…¥æ¨¡å¼');
        
        // åŠ è½½ä¾›åº”å•†åˆ—è¡¨
        loadSuppliersForManual();
        
        // å¦‚æœæ²¡æœ‰äº§å“è¡Œï¼Œæ·»åŠ ä¸€ä¸ª
        if (document.getElementById('manualProductsTable').children.length === 0) {
          addManualProduct();
        }
      }
    }

    // ä¸ºæ‰‹åŠ¨å½•å…¥åŠ è½½ä¾›åº”å•†
    async function loadSuppliersForManual() {
      try {
        const suppliers = await loadSuppliers();
        const select = document.getElementById('manualSupplier');
        select.innerHTML = '<option value="">é€‰æ‹©ä¾›åº”å•†...</option>';
        
        suppliers.forEach(supplier => {
          const option = document.createElement('option');
          option.value = supplier._id;
          option.textContent = supplier.name;
          select.appendChild(option);
        });
        
        debugLog(`åŠ è½½äº† ${suppliers.length} ä¸ªä¾›åº”å•†`);
      } catch (error) {
        debugLog(`åŠ è½½ä¾›åº”å•†å¤±è´¥: ${error.message}`);
      }
    }

    // æ·»åŠ æ‰‹åŠ¨å½•å…¥äº§å“è¡Œ
    function addManualProduct() {
      const table = document.getElementById('manualProductsTable');
      const index = table.children.length;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td style="padding: 8px;">
          <input type="text" placeholder="äº§å“åç§°" 
                 style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'name', this.value)">
        </td>
        <td style="padding: 8px;">
          <input type="number" value="1" min="1"
                 style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'quantity', this.value); updateManualProductRow(${index})">
        </td>
        <td style="padding: 8px;">
          <input type="number" step="0.01" min="0" placeholder="0.00"
                 style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'purchasePrice', this.value); calculateWholesalePrice(${index})">
        </td>
        <td style="padding: 8px;">
          <input type="number" step="0.01" min="0" placeholder="0.00"
                 style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'wholesalePrice', this.value); calculateRetailPrice(${index})">
        </td>
        <td style="padding: 8px;">
          <input type="number" step="0.01" min="0" placeholder="0.00"
                 style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'retailPrice', this.value)">
        </td>
        <td style="padding: 8px;">
          <select onchange="updateManualProduct(${index}, 'productType', this.value); updateManualVatRate(${index}); updateManualProductRow(${index})"
                  style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <option value="">é€‰æ‹©åˆ†ç±»...</option>
            <option value="æ‰‹æœºé…ä»¶">æ‰‹æœºé…ä»¶</option>
            <option value="ç”µè„‘é…ä»¶">ç”µè„‘é…ä»¶</option>
            <option value="è½¦è½½é…ä»¶">è½¦è½½é…ä»¶</option>
            <option value="audio">Audio</option>
            <option value="æ•°æ®çº¿">æ•°æ®çº¿</option>
            <option value="power supply">Power Supply</option>
            <option value="å…¨æ–°è®¾å¤‡">å…¨æ–°è®¾å¤‡</option>
            <option value="äºŒæ‰‹è®¾å¤‡">äºŒæ‰‹è®¾å¤‡</option>
            <option value="ç»´ä¿®">ç»´ä¿®</option>
          </select>
        </td>
        <td style="padding: 8px;">
          <select onchange="updateManualProduct(${index}, 'vatRate', this.value)"
                  style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <option value="VAT 23%">VAT 23%</option>
            <option value="VAT 13.5%">VAT 13.5%</option>
            <option value="VAT 0%">VAT 0%</option>
          </select>
        </td>
        <td style="padding: 8px;">
          <div id="manualIdentifier_${index}">
            <input type="text" placeholder="æ¡ç ï¼ˆå¯é€‰ï¼‰"
                   style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                   onchange="updateManualProduct(${index}, 'barcode', this.value)">
          </div>
        </td>
        <td style="padding: 8px;">
          <input type="text" placeholder="é¢œè‰²"
                 style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'color', this.value)">
        </td>
        <td style="padding: 8px;">
          <select onchange="updateManualProduct(${index}, 'condition', this.value)"
                  style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
            <option value="Brand New">å…¨æ–°</option>
            <option value="Pre-Owned">äºŒæ‰‹</option>
            <option value="Refurbished">ç¿»æ–°</option>
          </select>
        </td>
        <td style="padding: 8px;">
          <button onclick="removeManualProduct(${index})" 
                  style="padding: 4px 8px; background: #fed7d7; color: #c53030; border: none; border-radius: 4px; cursor: pointer;">
            âŒ
          </button>
        </td>
      `;
      
      table.appendChild(row);
      
      // åˆå§‹åŒ–äº§å“æ•°æ®
      if (!window.manualProducts) {
        window.manualProducts = [];
      }
      window.manualProducts[index] = {
        name: '',
        quantity: 1,
        purchasePrice: 0,
        wholesalePrice: 0,
        retailPrice: 0,
        productType: '',
        vatRate: 'VAT 23%',
        condition: 'Brand New',
        barcode: '',
        color: '',
        serialNumbers: []
      };
      
      debugLog(`æ·»åŠ æ‰‹åŠ¨å½•å…¥äº§å“è¡Œ ${index}`);
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥äº§å“æ•°æ®
    function updateManualProduct(index, field, value) {
      if (!window.manualProducts) window.manualProducts = [];
      if (!window.manualProducts[index]) window.manualProducts[index] = {};
      
      window.manualProducts[index][field] = value;
      debugLog(`æ›´æ–°æ‰‹åŠ¨äº§å“ ${index} çš„ ${field}: ${value}`);
    }

    // è®¡ç®—æ‰¹å‘ä»·
    function calculateWholesalePrice(index) {
      const purchasePrice = parseFloat(window.manualProducts[index]?.purchasePrice) || 0;
      const wholesalePrice = (purchasePrice * 1.2).toFixed(2);
      
      // æ›´æ–°æ‰¹å‘ä»·è¾“å…¥æ¡†
      const row = document.getElementById('manualProductsTable').children[index];
      const wholesalePriceInput = row.cells[3].querySelector('input');
      wholesalePriceInput.value = wholesalePrice;
      
      updateManualProduct(index, 'wholesalePrice', wholesalePrice);
      
      // è‡ªåŠ¨è®¡ç®—é›¶å”®ä»·
      calculateRetailPrice(index);
    }

    // è®¡ç®—é›¶å”®ä»·
    function calculateRetailPrice(index) {
      const wholesalePrice = parseFloat(window.manualProducts[index]?.wholesalePrice) || 0;
      const retailPrice = (wholesalePrice * 1.3).toFixed(2);
      
      // æ›´æ–°é›¶å”®ä»·è¾“å…¥æ¡†
      const row = document.getElementById('manualProductsTable').children[index];
      const retailPriceInput = row.cells[4].querySelector('input');
      retailPriceInput.value = retailPrice;
      
      updateManualProduct(index, 'retailPrice', retailPrice);
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥ç¨ç‡
    function updateManualVatRate(index) {
      const productType = window.manualProducts[index]?.productType;
      const defaultVatRate = getDefaultVatRate(productType);
      
      // æ›´æ–°ç¨ç‡é€‰æ‹©æ¡†
      const row = document.getElementById('manualProductsTable').children[index];
      const vatRateSelect = row.cells[6].querySelector('select');
      vatRateSelect.value = defaultVatRate;
      
      updateManualProduct(index, 'vatRate', defaultVatRate);
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥äº§å“è¡Œï¼ˆå¤„ç†è®¾å¤‡ç±»äº§å“çš„åºåˆ—å·è¾“å…¥ï¼‰
    function updateManualProductRow(index) {
      const product = window.manualProducts[index];
      const isDevice = product?.productType?.includes('è®¾å¤‡');
      const quantity = parseInt(product?.quantity) || 1;
      
      const row = document.getElementById('manualProductsTable').children[index];
      const identifierCell = row.cells[7];
      const identifierContainer = identifierCell.querySelector(`#manualIdentifier_${index}`);
      
      if (isDevice) {
        // è®¾å¤‡äº§å“ï¼šç”Ÿæˆå¤šä¸ªåºåˆ—å·è¾“å…¥æ¡†
        let inputs = '';
        for (let i = 0; i < quantity; i++) {
          const serialNumber = product.serialNumbers?.[i] || '';
          inputs += `
            <div style="margin-bottom: 4px;">
              <input type="text" value="${serialNumber}" 
                     placeholder="SN/IMEI ${i + 1} (å¿…å¡«)"
                     style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; ${serialNumber ? '' : 'border-color: #f56565;'}"
                     onchange="updateManualSerialNumber(${index}, ${i}, this.value)"
                     required>
            </div>
          `;
        }
        identifierContainer.innerHTML = inputs;
      } else {
        // é…ä»¶äº§å“ï¼šå•ä¸ªæ¡ç è¾“å…¥æ¡†
        identifierContainer.innerHTML = `
          <input type="text" value="${product?.barcode || ''}" placeholder="æ¡ç ï¼ˆå¯é€‰ï¼‰"
                 style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateManualProduct(${index}, 'barcode', this.value)">
        `;
      }
    }

    // æ›´æ–°æ‰‹åŠ¨å½•å…¥åºåˆ—å·
    function updateManualSerialNumber(productIndex, serialIndex, value) {
      if (!window.manualProducts[productIndex].serialNumbers) {
        window.manualProducts[productIndex].serialNumbers = [];
      }
      
      window.manualProducts[productIndex].serialNumbers[serialIndex] = value;
      debugLog(`æ›´æ–°æ‰‹åŠ¨äº§å“ ${productIndex} çš„åºåˆ—å· ${serialIndex}: ${value}`);
    }

    // ç§»é™¤æ‰‹åŠ¨å½•å…¥äº§å“è¡Œ
    function removeManualProduct(index) {
      const table = document.getElementById('manualProductsTable');
      if (table.children.length > 1) {
        table.children[index].remove();
        window.manualProducts.splice(index, 1);
        debugLog(`ç§»é™¤æ‰‹åŠ¨äº§å“è¡Œ ${index}`);
        
        // é‡æ–°ç¼–å·æ‰€æœ‰è¡Œ
        Array.from(table.children).forEach((row, newIndex) => {
          updateRowIndexes(row, newIndex);
        });
      } else {
        alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªäº§å“è¡Œ');
      }
    }

    // æ›´æ–°è¡Œç´¢å¼•
    function updateRowIndexes(row, newIndex) {
      // æ›´æ–°æ‰€æœ‰çš„onclickå’Œonchangeäº‹ä»¶ä¸­çš„ç´¢å¼•
      const inputs = row.querySelectorAll('input, select');
      inputs.forEach(input => {
        if (input.onchange) {
          const onchangeStr = input.onchange.toString();
          const updatedStr = onchangeStr.replace(/\d+/g, newIndex);
          input.setAttribute('onchange', updatedStr.match(/updateManual[^}]+}/)[0]);
        }
      });
      
      const button = row.querySelector('button');
      if (button) {
        button.setAttribute('onclick', `removeManualProduct(${newIndex})`);
      }
    }

    // æ¸…ç©ºæ‰‹åŠ¨å½•å…¥è¡¨å•
    function clearManualForm() {
      document.getElementById('manualSupplier').value = '';
      document.getElementById('manualInvoiceNumber').value = '';
      document.getElementById('manualProductsTable').innerHTML = '';
      window.manualProducts = [];
      addManualProduct();
      debugLog('æ¸…ç©ºæ‰‹åŠ¨å½•å…¥è¡¨å•');
    }

    // ç¡®è®¤æ‰‹åŠ¨å½•å…¥
    async function confirmManualReceiving() {
      const supplierId = document.getElementById('manualSupplier').value;
      const invoiceNumber = document.getElementById('manualInvoiceNumber').value;
      
      if (!supplierId) {
        alert('è¯·é€‰æ‹©ä¾›åº”å•†');
        return;
      }
      
      if (!invoiceNumber.trim()) {
        alert('è¯·è¾“å…¥å‘ç¥¨å·ç ');
        return;
      }
      
      // éªŒè¯äº§å“æ•°æ®
      const validationErrors = [];
      const products = window.manualProducts || [];
      
      products.forEach((product, index) => {
        if (!product.name?.trim()) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·è¾“å…¥äº§å“åç§°`);
        }
        
        if (!product.productType) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·é€‰æ‹©äº§å“åˆ†ç±»`);
        }
        
        if (!product.purchasePrice || product.purchasePrice <= 0) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·è¾“å…¥æœ‰æ•ˆçš„è¿›è´§ä»·`);
        }
        
        // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·
        const isDevice = product.productType?.includes('è®¾å¤‡');
        if (isDevice) {
          const quantity = parseInt(product.quantity) || 1;
          const serialNumbers = product.serialNumbers || [];
          const filledSerialNumbers = serialNumbers.filter(sn => sn && sn.trim());
          
          if (filledSerialNumbers.length < quantity) {
            validationErrors.push(`äº§å“ "${product.name}" éœ€è¦å¡«å†™ ${quantity} ä¸ªåºåˆ—å·ï¼Œä½†åªå¡«å†™äº† ${filledSerialNumbers.length} ä¸ª`);
          }
        }
      });
      
      if (validationErrors.length > 0) {
        alert('âŒ éªŒè¯å¤±è´¥ï¼š\n\n' + validationErrors.join('\n'));
        return;
      }
      
      // è·å–ä¾›åº”å•†ä¿¡æ¯
      const supplierSelect = document.getElementById('manualSupplier');
      const supplierName = supplierSelect.options[supplierSelect.selectedIndex].text;
      
      // æ„é€ å…¥åº“æ•°æ®
      const requestData = {
        supplier: {
          _id: supplierId,
          name: supplierName,
          email: '',
          phone: '',
          address: '',
          contactPerson: '',
          confidence: 100 // æ‰‹åŠ¨å½•å…¥ï¼Œç½®ä¿¡åº¦100%
        },
        products: products.map(product => {
          const baseProduct = {
            name: product.name || '',
            brand: product.brand || '',
            model: product.model || '',
            color: product.color || '',
            quantity: parseInt(product.quantity) || 1,
            unitPrice: parseFloat(product.purchasePrice) || 0,
            totalPrice: (parseInt(product.quantity) || 1) * (parseFloat(product.purchasePrice) || 0),
            wholesalePrice: parseFloat(product.wholesalePrice) || 0,
            retailPrice: parseFloat(product.retailPrice) || (parseFloat(product.wholesalePrice) || 0) * 1.3, // é›¶å”®ä»·æˆ–é»˜è®¤30%æ¯›åˆ©
            category: product.productType || 'æ‰‹æœºé…ä»¶',
            vatRate: product.vatRate || getDefaultVatRate(product.productType),
            condition: product.condition || 'Brand New'
          };
          
          // å¤„ç†æ¡ç å’Œåºåˆ—å·
          if (product.productType?.includes('è®¾å¤‡')) {
            // è®¾å¤‡äº§å“ï¼šå¤„ç†åºåˆ—å·æ•°ç»„
            if (product.serialNumbers && product.serialNumbers.length > 0) {
              // ä¸ºæ¯ä¸ªåºåˆ—å·åˆ›å»ºä¸€ä¸ªäº§å“è®°å½•
              return product.serialNumbers.filter(sn => sn && sn.trim()).map(serialNumber => ({
                ...baseProduct,
                quantity: 1, // æ¯ä¸ªåºåˆ—å·å¯¹åº”ä¸€ä¸ªäº§å“
                serialNumber: serialNumber,
                totalPrice: baseProduct.unitPrice
              }));
            } else {
              return [baseProduct];
            }
          } else {
            // é…ä»¶äº§å“ï¼šå¤„ç†æ¡ç 
            return [{
              ...baseProduct,
              barcode: product.barcode || ''
            }];
          }
        }).flat(), // å±•å¹³æ•°ç»„ï¼Œå› ä¸ºè®¾å¤‡äº§å“å¯èƒ½äº§ç”Ÿå¤šä¸ªè®°å½•
        invoiceInfo: {
          number: invoiceNumber,
          date: new Date().toISOString().split('T')[0],
          dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          currency: 'EUR', // ä¿®å¤ï¼šä½¿ç”¨EURè€Œä¸æ˜¯â‚¬ç¬¦å·
          subtotal: products.reduce((sum, p) => sum + (p.purchasePrice * p.quantity), 0),
          tax: 0,
          total: products.reduce((sum, p) => sum + (p.purchasePrice * p.quantity), 0)
        }
      };
      
      debugLog('å¼€å§‹æ‰‹åŠ¨å½•å…¥ç¡®è®¤å…¥åº“');
      debugLog('å‘é€æ‰‹åŠ¨å…¥åº“æ•°æ®:', JSON.stringify(requestData, null, 2));
      
      try {
        const response = await fetch(`${API_BASE}/receiving/confirm`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        debugLog(`æ‰‹åŠ¨å…¥åº“ç¡®è®¤APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success) {
          alert(`âœ… æ‰‹åŠ¨å…¥åº“æˆåŠŸï¼\n\nåˆ›å»ºäº§å“: ${result.data.productsCreated} ä¸ª\næ›´æ–°äº§å“: ${result.data.productsUpdated} ä¸ª`);
          clearManualForm();
          loadAllData(); // åˆ·æ–°æ•°æ®
        } else {
          throw new Error(result.error || result.message || 'å…¥åº“å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ æ‰‹åŠ¨å…¥åº“å¤±è´¥: ${error.message}`);
        alert(`âŒ æ‰‹åŠ¨å…¥åº“å¤±è´¥: ${error.message}`);
      }
    }

    // è·å–é»˜è®¤ç¨ç‡
    function getDefaultVatRate(productType) {
      const vatRates = {
        'æ‰‹æœºé…ä»¶': 'VAT 23%',
        'ç”µè„‘é…ä»¶': 'VAT 23%',
        'è½¦è½½é…ä»¶': 'VAT 23%',
        'audio': 'VAT 23%',
        'æ•°æ®çº¿': 'VAT 23%',
        'power supply': 'VAT 23%',
        'å…¨æ–°è®¾å¤‡': 'VAT 23%',
        'äºŒæ‰‹è®¾å¤‡': 'VAT 13.5%',
        'ç»´ä¿®': 'VAT 13.5%'
      };
      return vatRates[productType] || 'VAT 23%';
    }

    // æ›´æ–°ç¨ç‡
    function updateVatRate(productIndex) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      const product = window.recognizedData.products[productIndex];
      const defaultVatRate = getDefaultVatRate(product.productType);
      product.vatRate = defaultVatRate;
      
      // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥æ›´æ–°ç¨ç‡æ˜¾ç¤º
      displayRecognitionResult(window.recognizedData);
      
      debugLog(`äº§å“ ${productIndex} ç¨ç‡æ›´æ–°ä¸º: ${defaultVatRate}`);
    }

    // ç”Ÿæˆæ¡ç /åºåˆ—å·è¾“å…¥æ¡†
    function generateIdentifierInputs(product, index) {
      const isDevice = product.productType?.includes('è®¾å¤‡');
      const quantity = parseInt(product.quantity) || 1;
      
      if (!isDevice) {
        // é…ä»¶ç±»äº§å“ï¼Œåªéœ€è¦ä¸€ä¸ªæ¡ç è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
        return `
          <input type="text" value="${product.barcode || ''}" 
                 placeholder="æ¡ç ï¼ˆå¯é€‰ï¼‰"
                 style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                 onchange="updateProductField(${index}, 'barcode', this.value)">
        `;
      } else {
        // è®¾å¤‡ç±»äº§å“ï¼Œéœ€è¦æ ¹æ®æ•°é‡ç”Ÿæˆå¤šä¸ªSN/IMEIè¾“å…¥æ¡†
        const serialNumbers = product.serialNumbers || [];
        let inputs = '';
        
        for (let i = 0; i < quantity; i++) {
          inputs += `
            <div style="margin-bottom: 4px;">
              <input type="text" value="${serialNumbers[i] || ''}" 
                     placeholder="SN/IMEI ${i + 1} (å¿…å¡«)"
                     style="width: 120px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; ${serialNumbers[i] ? '' : 'border-color: #f56565;'}"
                     onchange="updateSerialNumber(${index}, ${i}, this.value)"
                     required>
            </div>
          `;
        }
        
        return `<div>${inputs}</div>`;
      }
    }

    // æ›´æ–°åºåˆ—å·
    function updateSerialNumber(productIndex, serialIndex, value) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      const product = window.recognizedData.products[productIndex];
      if (!product.serialNumbers) {
        product.serialNumbers = [];
      }
      
      product.serialNumbers[serialIndex] = value;
      debugLog(`æ›´æ–°äº§å“ ${productIndex} çš„åºåˆ—å· ${serialIndex}: ${value}`);
      
      // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·å®Œæ•´æ€§
      validateDeviceSerialNumbers(productIndex);
    }

    // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·å®Œæ•´æ€§
    function validateDeviceSerialNumbers(productIndex) {
      const product = window.recognizedData.products[productIndex];
      const isDevice = product.productType?.includes('è®¾å¤‡');
      
      if (isDevice) {
        const quantity = parseInt(product.quantity) || 1;
        const serialNumbers = product.serialNumbers || [];
        const filledCount = serialNumbers.filter(sn => sn && sn.trim()).length;
        
        if (filledCount < quantity) {
          debugLog(`âš ï¸ äº§å“ ${productIndex} éœ€è¦ ${quantity} ä¸ªåºåˆ—å·ï¼Œä½†åªå¡«å†™äº† ${filledCount} ä¸ª`);
        } else {
          debugLog(`âœ… äº§å“ ${productIndex} åºåˆ—å·å¡«å†™å®Œæ•´`);
        }
      }
    }

    // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
    function displayRecognitionResult(data) {
      const resultContainer = document.getElementById('recognitionResult');
      
      const html = `
        <div class="card" style="margin-top: 20px;">
          <h3>âœ… å‘ç¥¨è¯†åˆ«å®Œæˆ</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <div>
              <h4>ğŸ“„ å‘ç¥¨ä¿¡æ¯</h4>
              <div style="background: #f7fafc; padding: 15px; border-radius: 8px;">
                <div><strong>ä¾›åº”å•†:</strong> ${data.supplier?.name || 'æœªè¯†åˆ«'}</div>
                <div><strong>å‘ç¥¨å·:</strong> ${data.invoiceNumber || 'æœªè¯†åˆ«'}</div>
                <div><strong>æ—¥æœŸ:</strong> ${data.invoiceDate || 'æœªè¯†åˆ«'}</div>
                <div><strong>æ€»é‡‘é¢:</strong> ${data.currency || 'â‚¬'} ${data.totalAmount || '0.00'}</div>
              </div>
            </div>
            <div>
              <h4>ğŸ“Š è¯†åˆ«ç»Ÿè®¡</h4>
              <div style="background: #f0fff4; padding: 15px; border-radius: 8px;">
                <div><strong>äº§å“æ•°é‡:</strong> ${data.products?.length || 0} é¡¹</div>
                <div><strong>è¯†åˆ«å‡†ç¡®åº¦:</strong> ${data.confidence || 85}%</div>
                <div><strong>éœ€è¦ç¡®è®¤:</strong> ${data.needsReview ? 'æ˜¯' : 'å¦'}</div>
              </div>
            </div>
          </div>
          
          <h4>ğŸ“¦ è¯†åˆ«çš„äº§å“åˆ—è¡¨</h4>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>äº§å“åç§°</th>
                  <th>æ•°é‡</th>
                  <th>è¿›è´§ä»·</th>
                  <th>æ‰¹å‘ä»·</th>
                  <th>é›¶å”®ä»·</th>
                  <th>åˆ†ç±»</th>
                  <th>ç¨åŠ¡åˆ†ç±»</th>
                  <th>æ¡ç /åºåˆ—å·</th>
                  <th>é¢œè‰²</th>
                  <th>æˆè‰²</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${(data.products || []).map((product, index) => `
                  <tr>
                    <td>
                      <input type="text" value="${product.name || ''}" 
                             style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                             onchange="updateProductField(${index}, 'name', this.value)">
                    </td>
                    <td>
                      <input type="number" value="${product.quantity || 1}" min="1"
                             style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                             onchange="updateProductField(${index}, 'quantity', this.value)">
                    </td>
                    <td>
                      <input type="number" value="${parseFloat(product.unitPrice || product.purchasePrice || product.costPrice || 0).toFixed(2)}" step="0.01" min="0"
                             style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                             onchange="updateProductField(${index}, 'purchasePrice', this.value)"
                             required>
                    </td>
                    <td>
                      <input type="number" value="${product.wholesalePrice || ''}" step="0.01" min="0" placeholder="è¯·æ‰‹åŠ¨è¾“å…¥æ‰¹å‘ä»·"
                             style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                             onchange="updateProductField(${index}, 'wholesalePrice', this.value)">
                    </td>
                    <td>
                      <input type="number" value="${product.retailPrice || ''}" step="0.01" min="0" placeholder="è¯·æ‰‹åŠ¨è¾“å…¥é›¶å”®ä»·"
                             style="width: 100px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                             onchange="updateProductField(${index}, 'retailPrice', this.value)">
                    </td>
                    <td>
                      <select onchange="updateProductField(${index}, 'productType', this.value); updateVatRate(${index})"
                              style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                        <option value="æ‰‹æœºé…ä»¶" ${product.productType === 'æ‰‹æœºé…ä»¶' ? 'selected' : ''}>æ‰‹æœºé…ä»¶</option>
                        <option value="ç”µè„‘é…ä»¶" ${product.productType === 'ç”µè„‘é…ä»¶' ? 'selected' : ''}>ç”µè„‘é…ä»¶</option>
                        <option value="è½¦è½½é…ä»¶" ${product.productType === 'è½¦è½½é…ä»¶' ? 'selected' : ''}>è½¦è½½é…ä»¶</option>
                        <option value="audio" ${product.productType === 'audio' ? 'selected' : ''}>Audio</option>
                        <option value="æ•°æ®çº¿" ${product.productType === 'æ•°æ®çº¿' ? 'selected' : ''}>æ•°æ®çº¿</option>
                        <option value="power supply" ${product.productType === 'power supply' ? 'selected' : ''}>Power Supply</option>
                        <option value="å…¨æ–°è®¾å¤‡" ${product.productType === 'å…¨æ–°è®¾å¤‡' ? 'selected' : ''}>å…¨æ–°è®¾å¤‡</option>
                        <option value="äºŒæ‰‹è®¾å¤‡" ${product.productType === 'äºŒæ‰‹è®¾å¤‡' ? 'selected' : ''}>äºŒæ‰‹è®¾å¤‡</option>
                        <option value="ç»´ä¿®" ${product.productType === 'ç»´ä¿®' ? 'selected' : ''}>ç»´ä¿®</option>
                      </select>
                    </td>
                    <td>
                      <select onchange="updateProductField(${index}, 'vatRate', this.value)"
                              style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                        <option value="VAT 23%" ${(product.vatRate || getDefaultVatRate(product.productType)) === 'VAT 23%' ? 'selected' : ''}>VAT 23%</option>
                        <option value="VAT 13.5%" ${(product.vatRate || getDefaultVatRate(product.productType)) === 'VAT 13.5%' ? 'selected' : ''}>VAT 13.5%</option>
                        <option value="VAT 0%" ${(product.vatRate || getDefaultVatRate(product.productType)) === 'VAT 0%' ? 'selected' : ''}>VAT 0%</option>
                      </select>
                    </td>
                    <td>
                      ${generateIdentifierInputs(product, index)}
                    </td>
                    <td>
                      <input type="text" value="${product.color || ''}" placeholder="é¢œè‰²"
                             style="width: 80px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;"
                             onchange="updateProductField(${index}, 'color', this.value)">
                    </td>
                    <td>
                      <select onchange="updateProductField(${index}, 'condition', this.value)"
                              style="width: 100%; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px;">
                        <option value="Brand New" ${product.condition === 'Brand New' ? 'selected' : ''}>å…¨æ–°</option>
                        <option value="Pre-Owned" ${product.condition === 'Pre-Owned' ? 'selected' : ''}>äºŒæ‰‹</option>
                        <option value="Refurbished" ${product.condition === 'Refurbished' ? 'selected' : ''}>ç¿»æ–°</option>
                      </select>
                    </td>
                    <td>
                      <button onclick="removeProduct(${index})" 
                              style="padding: 4px 8px; background: #fed7d7; color: #c53030; border: none; border-radius: 4px; cursor: pointer;">
                        âŒ
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
            <button onclick="cancelReceiving()" class="btn" style="background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0;">
              âŒ å–æ¶ˆ
            </button>
            <button onclick="confirmReceiving()" class="btn btn-success">
              âœ… ç¡®è®¤å…¥åº“
            </button>
          </div>
        </div>
      `;
      
      resultContainer.innerHTML = html;
      
      // ä¿å­˜è¯†åˆ«æ•°æ®åˆ°å…¨å±€å˜é‡
      window.recognizedData = data;
    }

    // æ›´æ–°äº§å“å­—æ®µ
    function updateProductField(index, field, value) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      const product = window.recognizedData.products[index];
      
      if (field === 'quantity') {
        product.quantity = parseInt(value) || 1;
        // å¦‚æœæ˜¯è®¾å¤‡äº§å“ï¼Œæ•°é‡å˜åŒ–æ—¶éœ€è¦é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼
        if (product.productType?.includes('è®¾å¤‡')) {
          displayRecognitionResult(window.recognizedData);
          return;
        }
      } else if (field === 'productType') {
        product.productType = value;
        // äº§å“ç±»å‹å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ç¨ç‡
        product.vatRate = getDefaultVatRate(value);
        // é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼
        displayRecognitionResult(window.recognizedData);
        return;
      } else if (field === 'purchasePrice') {
        product.purchasePrice = parseFloat(value) || 0;
        // ä¸å†è‡ªåŠ¨è®¡ç®—æ‰¹å‘ä»·å’Œé›¶å”®ä»·ï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥
      } else if (field === 'wholesalePrice') {
        product.wholesalePrice = parseFloat(value) || 0;
        // ä¸å†è‡ªåŠ¨è®¡ç®—é›¶å”®ä»·ï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥
      } else if (field === 'retailPrice') {
        product.retailPrice = parseFloat(value) || 0;
      } else if (field === 'barcode') {
        product.barcode = value;
      } else {
        product[field] = value;
      }
      
      debugLog(`æ›´æ–°äº§å“ ${index} çš„ ${field}: ${value}`);
    }

    // ç§»é™¤äº§å“
    function removeProduct(index) {
      if (!window.recognizedData || !window.recognizedData.products) return;
      
      window.recognizedData.products.splice(index, 1);
      displayRecognitionResult(window.recognizedData);
      debugLog(`ç§»é™¤äº§å“ ${index}`);
    }

    // å–æ¶ˆå…¥åº“
    function cancelReceiving() {
      document.getElementById('recognitionResult').style.display = 'none';
      document.getElementById('fileInput').value = '';
      window.recognizedData = null;
      debugLog('å–æ¶ˆå…¥åº“æ“ä½œ');
    }

    // ç¡®è®¤å…¥åº“
    async function confirmReceiving() {
      if (!window.recognizedData) {
        alert('æ²¡æœ‰å¯å…¥åº“çš„æ•°æ®');
        return;
      }
      
      // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·å®Œæ•´æ€§
      const products = window.recognizedData.products || [];
      const validationErrors = [];
      
      products.forEach((product, index) => {
        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!product.name || !product.name.trim()) {
          validationErrors.push(`äº§å“ ${index + 1}: è¯·è¾“å…¥äº§å“åç§°`);
        }
        
        // æ¸…ç†å’ŒéªŒè¯è¿›è´§ä»·
        const cleanPurchasePrice = String(product.purchasePrice || '').replace(/[^\d.-]/g, '');
        const purchasePriceNum = parseFloat(cleanPurchasePrice);
        if (!cleanPurchasePrice || isNaN(purchasePriceNum) || purchasePriceNum <= 0) {
          validationErrors.push(`äº§å“ "${product.name || index + 1}": è¯·è¾“å…¥æœ‰æ•ˆçš„è¿›è´§ä»·`);
        }
        
        // æ¸…ç†å’ŒéªŒè¯æ‰¹å‘ä»·
        const cleanWholesalePrice = String(product.wholesalePrice || '').replace(/[^\d.-]/g, '');
        const wholesalePriceNum = parseFloat(cleanWholesalePrice);
        if (!cleanWholesalePrice || isNaN(wholesalePriceNum) || wholesalePriceNum <= 0) {
          validationErrors.push(`äº§å“ "${product.name || index + 1}": è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰¹å‘ä»·`);
        }
        
        // æ¸…ç†å’ŒéªŒè¯é›¶å”®ä»·
        const cleanRetailPrice = String(product.retailPrice || '').replace(/[^\d.-]/g, '');
        const retailPriceNum = parseFloat(cleanRetailPrice);
        if (!cleanRetailPrice || isNaN(retailPriceNum) || retailPriceNum <= 0) {
          validationErrors.push(`äº§å“ "${product.name || index + 1}": è¯·è¾“å…¥æœ‰æ•ˆçš„é›¶å”®ä»·`);
        }
        
        // éªŒè¯ä»·æ ¼é€»è¾‘ï¼ˆåªæœ‰å½“æ‰€æœ‰ä»·æ ¼éƒ½æœ‰æ•ˆæ—¶æ‰éªŒè¯ï¼‰
        if (!isNaN(purchasePriceNum) && !isNaN(wholesalePriceNum) && !isNaN(retailPriceNum)) {
          if (wholesalePriceNum <= purchasePriceNum) {
            validationErrors.push(`äº§å“ "${product.name || index + 1}": æ‰¹å‘ä»·å¿…é¡»é«˜äºè¿›è´§ä»·`);
          }
          
          if (retailPriceNum <= wholesalePriceNum) {
            validationErrors.push(`äº§å“ "${product.name || index + 1}": é›¶å”®ä»·å¿…é¡»é«˜äºæ‰¹å‘ä»·`);
          }
        }
        
        // éªŒè¯è®¾å¤‡äº§å“çš„åºåˆ—å·
        const isDevice = product.productType?.includes('è®¾å¤‡');
        if (isDevice) {
          const quantity = parseInt(product.quantity) || 1;
          const serialNumbers = product.serialNumbers || [];
          const filledSerialNumbers = serialNumbers.filter(sn => sn && sn.trim());
          
          if (filledSerialNumbers.length < quantity) {
            validationErrors.push(`äº§å“ "${product.name}" éœ€è¦å¡«å†™ ${quantity} ä¸ªåºåˆ—å·ï¼Œä½†åªå¡«å†™äº† ${filledSerialNumbers.length} ä¸ª`);
          }
          
          // æ£€æŸ¥åºåˆ—å·æ˜¯å¦é‡å¤
          const uniqueSerialNumbers = [...new Set(filledSerialNumbers)];
          if (uniqueSerialNumbers.length !== filledSerialNumbers.length) {
            validationErrors.push(`äº§å“ "${product.name}" å­˜åœ¨é‡å¤çš„åºåˆ—å·`);
          }
        }
      });
      
      if (validationErrors.length > 0) {
        alert('âŒ å…¥åº“éªŒè¯å¤±è´¥ï¼š\n\n' + validationErrors.join('\n'));
        return;
      }
      
      debugLog('å¼€å§‹ç¡®è®¤å…¥åº“æ“ä½œ');
      
      try {
        // è½¬æ¢æ•°æ®æ ¼å¼ä¸ºåç«¯æœŸæœ›çš„æ ¼å¼
        const requestData = {
          supplier: {
            name: window.recognizedData.supplier?.name || 'æœªçŸ¥ä¾›åº”å•†',
            email: window.recognizedData.supplier?.email || '',
            phone: window.recognizedData.supplier?.phone || '',
            address: window.recognizedData.supplier?.address || '',
            contactPerson: window.recognizedData.supplier?.contactPerson || '',
            confidence: window.recognizedData.supplier?.confidence || 85
          },
          products: products.map(product => {
            const baseProduct = {
              name: product.name || '',
              brand: product.brand || '',
              model: product.model || '',
              color: product.color || '',
              quantity: parseInt(product.quantity) || 1,
              unitPrice: parseFloat(product.purchasePrice) || 0,
              totalPrice: (parseInt(product.quantity) || 1) * (parseFloat(product.purchasePrice) || 0),
              wholesalePrice: parseFloat(product.wholesalePrice) || 0,
              retailPrice: parseFloat(product.retailPrice) || (parseFloat(product.wholesalePrice) || 0) * 1.3, // é›¶å”®ä»·æˆ–é»˜è®¤30%æ¯›åˆ©
              category: product.productType || 'æ‰‹æœºé…ä»¶',
              vatRate: product.vatRate || getDefaultVatRate(product.productType),
              condition: product.condition || 'Brand New'
            };
            
            // å¤„ç†æ¡ç å’Œåºåˆ—å·
            if (product.productType?.includes('è®¾å¤‡')) {
              // è®¾å¤‡äº§å“ï¼šå¤„ç†åºåˆ—å·æ•°ç»„
              if (product.serialNumbers && product.serialNumbers.length > 0) {
                // ä¸ºæ¯ä¸ªåºåˆ—å·åˆ›å»ºä¸€ä¸ªäº§å“è®°å½•
                return product.serialNumbers.filter(sn => sn && sn.trim()).map(serialNumber => ({
                  ...baseProduct,
                  quantity: 1, // æ¯ä¸ªåºåˆ—å·å¯¹åº”ä¸€ä¸ªäº§å“
                  serialNumber: serialNumber,
                  totalPrice: baseProduct.unitPrice
                }));
              } else {
                return [baseProduct];
              }
            } else {
              // é…ä»¶äº§å“ï¼šå¤„ç†æ¡ç 
              return [{
                ...baseProduct,
                barcode: product.barcode || ''
              }];
            }
          }).flat(), // å±•å¹³æ•°ç»„ï¼Œå› ä¸ºè®¾å¤‡äº§å“å¯èƒ½äº§ç”Ÿå¤šä¸ªè®°å½•
          invoiceInfo: {
            number: window.recognizedData.invoiceNumber || `INV-${Date.now()}`,
            date: window.recognizedData.invoiceDate || new Date().toISOString().split('T')[0],
            dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
            currency: 'EUR', // ä¿®å¤ï¼šä½¿ç”¨EURè€Œä¸æ˜¯â‚¬ç¬¦å·
            subtotal: parseFloat(window.recognizedData.totalAmount) || 0,
            tax: 0, // æš‚æ—¶è®¾ä¸º0
            total: parseFloat(window.recognizedData.totalAmount) || 0
          }
        };
        
        debugLog('å‘é€å…¥åº“æ•°æ®:', JSON.stringify(requestData, null, 2));
        
        const response = await fetch(`${API_BASE}/receiving/confirm`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const result = await response.json();
        debugLog(`å…¥åº“ç¡®è®¤APIå“åº”: ${JSON.stringify(result)}`);
        
        if (result.success) {
          alert(`âœ… å…¥åº“æˆåŠŸï¼\n\nåˆ›å»ºäº§å“: ${result.data.productsCreated} ä¸ª\næ›´æ–°äº§å“: ${result.data.productsUpdated} ä¸ª`);
          cancelReceiving();
          loadAllData(); // åˆ·æ–°æ•°æ®
        } else {
          throw new Error(result.error || result.message || 'å…¥åº“å¤±è´¥');
        }
      } catch (error) {
        debugLog(`âŒ å…¥åº“å¤±è´¥: ${error.message}`);
        alert(`âŒ å…¥åº“å¤±è´¥: ${error.message}`);
      }
    }

    // æµ‹è¯•å›¾ç‰‡è¯†åˆ« - å·²ç§»é™¤
    /*
    function testImageRecognition() {
      window.open('/test-image-recognition.html', '_blank');
    }
    */

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      if (typeof AuthGuard !== 'undefined') {
        AuthGuard.logout();
      } else {
        window.location.href = '/login.html';
      }
    }

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('=== ä»“åº“ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ===');
      
      // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
      setTimeout(function() {
        loadAllData();
      }, 100);
    });
  </script>
</body>
</html>