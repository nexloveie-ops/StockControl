<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æµ‹è¯•ä¾›åº”å•†åŠ è½½</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
    }
    select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #cbd5e0;
      border-radius: 6px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      background: #4299e1;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #3182ce;
    }
    #log {
      background: #f7fafc;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .success { color: #38a169; }
    .error { color: #e53e3e; }
    .info { color: #3182ce; }
  </style>
</head>
<body>
  <h1>ğŸ§ª ä¾›åº”å•†åŠ è½½æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>1. APIæµ‹è¯•</h2>
    <button onclick="testAPI()">æµ‹è¯• /api/suppliers</button>
    <div id="apiResult" style="margin-top: 10px;"></div>
  </div>
  
  <div class="test-section">
    <h2>2. ä¾›åº”å•†ä¸‹æ‹‰æ¡†</h2>
    <label for="supplierSelect">é€‰æ‹©ä¾›åº”å•†ï¼š</label>
    <select id="supplierSelect">
      <option value="">åŠ è½½ä¸­...</option>
    </select>
    <button onclick="loadSuppliers()">é‡æ–°åŠ è½½</button>
  </div>
  
  <div class="test-section">
    <h2>3. è°ƒè¯•æ—¥å¿—</h2>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <div id="log"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function testAPI() {
      log('ğŸ”„ æµ‹è¯• API: /api/suppliers', 'info');
      const resultDiv = document.getElementById('apiResult');
      
      try {
        const response = await fetch('/api/suppliers');
        log(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        log(`âœ… æˆåŠŸè·å–æ•°æ®`, 'success');
        log(`ğŸ“Š ä¾›åº”å•†æ•°é‡: ${result.data?.length || 0}`, 'success');
        
        resultDiv.innerHTML = `
          <div style="background: #f0fff4; padding: 15px; border-radius: 6px; margin-top: 10px;">
            <strong>âœ… API æ­£å¸¸å·¥ä½œ</strong><br>
            ä¾›åº”å•†æ•°é‡: ${result.data?.length || 0}<br>
            <details style="margin-top: 10px;">
              <summary>æŸ¥çœ‹è¯¦ç»†æ•°æ®</summary>
              <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(result, null, 2)}</pre>
            </details>
          </div>
        `;
        
        return result.data;
      } catch (error) {
        log(`âŒ API é”™è¯¯: ${error.message}`, 'error');
        resultDiv.innerHTML = `
          <div style="background: #fff5f5; padding: 15px; border-radius: 6px; margin-top: 10px; color: #c53030;">
            <strong>âŒ API é”™è¯¯</strong><br>
            ${error.message}
          </div>
        `;
        return [];
      }
    }

    async function loadSuppliers() {
      log('ğŸ”„ å¼€å§‹åŠ è½½ä¾›åº”å•†åˆ°ä¸‹æ‹‰æ¡†', 'info');
      const select = document.getElementById('supplierSelect');
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
        log('ğŸ“¡ å‘é€è¯·æ±‚åˆ° /api/suppliers', 'info');
        
        const response = await fetch('/api/suppliers');
        log(`ğŸ“¥ æ”¶åˆ°å“åº”: ${response.status}`, 'info');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        const suppliers = result.data || [];
        
        log(`âœ… è·å–åˆ° ${suppliers.length} ä¸ªä¾›åº”å•†`, 'success');
        
        // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
        select.innerHTML = '<option value="">é€‰æ‹©ä¾›åº”å•†...</option>';
        
        if (suppliers.length === 0) {
          log('âš ï¸  æ²¡æœ‰ä¾›åº”å•†æ•°æ®', 'error');
          select.innerHTML = '<option value="">æ²¡æœ‰å¯ç”¨ä¾›åº”å•†</option>';
          return;
        }
        
        suppliers.forEach((supplier, index) => {
          log(`  ${index + 1}. ${supplier.name} (${supplier._id})`, 'info');
          const option = document.createElement('option');
          option.value = supplier._id;
          option.textContent = supplier.name;
          select.appendChild(option);
        });
        
        log(`âœ… æˆåŠŸåŠ è½½ ${suppliers.length} ä¸ªä¾›åº”å•†åˆ°ä¸‹æ‹‰æ¡†`, 'success');
        
      } catch (error) {
        log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
    window.addEventListener('DOMContentLoaded', () => {
      log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ', 'success');
      log('ğŸ”„ è‡ªåŠ¨åŠ è½½ä¾›åº”å•†...', 'info');
      loadSuppliers();
    });

    // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–
    document.getElementById('supplierSelect').addEventListener('change', (e) => {
      if (e.target.value) {
        log(`âœ… é€‰æ‹©äº†ä¾›åº”å•†: ${e.target.options[e.target.selectedIndex].text} (${e.target.value})`, 'success');
      }
    });
  </script>
</body>
</html>
