<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»ç»Ÿè®¾ç½® - 3Cäº§å“ç®¡ç†ç³»ç»Ÿ</title>
  <script src="/auth-guard.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .back-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .tab:hover {
      color: #667eea;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-info { background: #d1ecf1; color: #0c5460; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h3 {
      font-size: 20px;
      color: #333;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .icon-btn {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .alert {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }
    
    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffc107;
    }
    
    .alert-danger {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div>
        <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
        <p>ç®¡ç†äº§å“åˆ†ç±»ã€è®¾å¤‡æˆè‰²ç­‰ç³»ç»ŸåŸºç¡€ä¿¡æ¯</p>
      </div>
      <a href="/admin.html" class="back-btn">è¿”å›ç®¡ç†åå°</a>
    </div>
  </div>

  <div class="container">
    <!-- æ ‡ç­¾é¡µ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('categories')">äº§å“åˆ†ç±»</button>
      <button class="tab" onclick="switchTab('conditions')">è®¾å¤‡æˆè‰²</button>
      <button class="tab" onclick="switchTab('vat-rates')">ç¨ç‡è®¾ç½®</button>
      <button class="tab" onclick="switchTab('system-info')">ç³»ç»Ÿä¿¡æ¯</button>
    </div>

    <!-- äº§å“åˆ†ç±»ç®¡ç† -->
    <div id="categories" class="tab-content active">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>äº§å“åˆ†ç±»ç®¡ç†</h2>
          <button class="btn btn-success" onclick="showAddCategoryModal()">+ æ·»åŠ åˆ†ç±»</button>
        </div>
        
        <div class="alert alert-info">
          <strong>ğŸ’¡ æç¤ºï¼š</strong>äº§å“åˆ†ç±»ç”¨äºç»„ç»‡å’Œç®¡ç†ä¸åŒç±»å‹çš„äº§å“ã€‚åˆ é™¤åˆ†ç±»å‰ï¼Œè¯·ç¡®ä¿å°†è¯¥åˆ†ç±»ä¸‹çš„äº§å“ç§»åŠ¨åˆ°å…¶ä»–åˆ†ç±»ã€‚
        </div>
        
        <div id="categoriesTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- è®¾å¤‡æˆè‰²ç®¡ç† -->
    <div id="conditions" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>è®¾å¤‡æˆè‰²ç®¡ç†</h2>
          <button class="btn btn-success" onclick="showAddConditionModal()">+ æ·»åŠ æˆè‰²</button>
        </div>
        
        <div class="alert alert-info">
          <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>è®¾å¤‡æˆè‰²ç”¨äºæ ‡è¯†äº§å“çš„æ–°æ—§ç¨‹åº¦ã€‚å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æˆè‰²ã€‚
        </div>
        
        <div id="conditionsTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç¨ç‡è®¾ç½® -->
    <div id="vat-rates" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>ç¨ç‡ç®¡ç†</h2>
          <button class="btn btn-success" onclick="showAddVatRateModal()">+ æ·»åŠ ç¨ç‡</button>
        </div>
        
        <div class="alert alert-info">
          <strong>ğŸ’¡ è¯´æ˜ï¼š</strong>æ ¹æ®çˆ±å°”å…°ç¨æ³•ï¼Œä¸åŒç±»å‹çš„äº§å“é€‚ç”¨ä¸åŒçš„å¢å€¼ç¨ç‡ã€‚å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤ç¨ç‡ã€‚
        </div>
        
        <div class="alert alert-warning">
          <strong>âš ï¸ æ³¨æ„ï¼š</strong>ç¨ç‡è®¾ç½®æ¶‰åŠè´¢åŠ¡åˆè§„ï¼Œä¿®æ”¹å‰è¯·å’¨è¯¢ç¨åŠ¡é¡¾é—®ã€‚åˆ é™¤ç¨ç‡å‰ï¼Œè¯·ç¡®ä¿æ²¡æœ‰äº§å“æˆ–åˆ†ç±»ä½¿ç”¨è¯¥ç¨ç‡ã€‚
        </div>
        
        <div id="vatRatesTable">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ç³»ç»Ÿä¿¡æ¯ -->
    <div id="system-info" class="tab-content">
      <div class="card">
        <h2>ç³»ç»Ÿä¿¡æ¯</h2>
        
        <table>
          <tr>
            <th style="width: 200px;">ç³»ç»Ÿåç§°</th>
            <td>3Cäº§å“åº“å­˜ç®¡ç†ç³»ç»Ÿ</td>
          </tr>
          <tr>
            <th>ç‰ˆæœ¬</th>
            <td>v2.0.0</td>
          </tr>
          <tr>
            <th>æ•°æ®åº“</th>
            <td>MongoDB Atlas</td>
          </tr>
          <tr>
            <th>æœåŠ¡å™¨çŠ¶æ€</th>
            <td><span class="badge badge-success">è¿è¡Œä¸­</span></td>
          </tr>
          <tr>
            <th>æœ€åæ›´æ–°</th>
            <td id="lastUpdate">2026-02-02</td>
          </tr>
        </table>
      </div>
      
      <div class="card">
        <h2>æ•°æ®ç»Ÿè®¡</h2>
        <div id="systemStats">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘åˆ†ç±»æ¨¡æ€æ¡† -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">æ·»åŠ äº§å“åˆ†ç±»</h3>
        <button class="close-btn" onclick="closeCategoryModal()">&times;</button>
      </div>
      
      <form id="categoryForm">
        <input type="hidden" id="categoryId">
        
        <div class="form-group">
          <label>åˆ†ç±»ç±»å‹ *</label>
          <input type="text" id="categoryType" required placeholder="ä¾‹å¦‚ï¼šæ‰‹æœºé…ä»¶ã€ç”µè„‘é…ä»¶ã€è½¦è½½é…ä»¶">
          <small style="color: #666; font-size: 12px;">è¿™æ˜¯äº§å“çš„åˆ†ç±»ç±»å‹ï¼Œå¦‚ï¼šæ‰‹æœºé…ä»¶ã€ç”µè„‘é…ä»¶ç­‰</small>
        </div>
        
        <div class="form-group">
          <label>æè¿°</label>
          <textarea id="categoryDescription" placeholder="åˆ†ç±»æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        
        <div class="form-group">
          <label>é»˜è®¤ç¨ç‡</label>
          <select id="categoryVatRate">
            <!-- åŠ¨æ€åŠ è½½ -->
          </select>
          <small style="color: #666; font-size: 12px;">æ–°äº§å“é»˜è®¤ä½¿ç”¨æ­¤ç¨ç‡</small>
        </div>
        
        <div class="form-group">
          <label>é»˜è®¤æˆè‰²</label>
          <select id="categoryCondition">
            <!-- åŠ¨æ€åŠ è½½ -->
          </select>
          <small style="color: #666; font-size: 12px;">æ–°äº§å“é»˜è®¤ä½¿ç”¨æ­¤æˆè‰²</small>
        </div>
        
        <div class="form-group">
          <label>æ’åºæƒé‡</label>
          <input type="number" id="categorySortOrder" value="0" placeholder="æ•°å­—è¶Šå¤§è¶Šé å‰">
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘æˆè‰²æ¨¡æ€æ¡† -->
  <div id="conditionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="conditionModalTitle">æ·»åŠ è®¾å¤‡æˆè‰²</h3>
        <button class="close-btn" onclick="closeConditionModal()">&times;</button>
      </div>
      
      <form id="conditionForm">
        <input type="hidden" id="conditionId">
        
        <div class="form-group">
          <label>æˆè‰²ä»£ç  *</label>
          <input type="text" id="conditionCode" required placeholder="ä¾‹å¦‚ï¼šBRAND_NEW" style="text-transform: uppercase;">
          <small style="color: #666; font-size: 12px;">å»ºè®®ä½¿ç”¨å¤§å†™å­—æ¯å’Œä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šBRAND_NEW</small>
        </div>
        
        <div class="form-group">
          <label>æ˜¾ç¤ºåç§° *</label>
          <input type="text" id="conditionName" required placeholder="ä¾‹å¦‚ï¼šå…¨æ–°">
        </div>
        
        <div class="form-group">
          <label>æè¿°</label>
          <textarea id="conditionDescription" placeholder="æˆè‰²æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        
        <div class="form-group">
          <label>æ’åºæƒé‡</label>
          <input type="number" id="conditionSortOrder" value="0" placeholder="æ•°å­—è¶Šå°è¶Šé å‰">
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeConditionModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ·»åŠ /ç¼–è¾‘ç¨ç‡æ¨¡æ€æ¡† -->
  <div id="vatRateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="vatRateModalTitle">æ·»åŠ ç¨ç‡</h3>
        <button class="close-btn" onclick="closeVatRateModal()">&times;</button>
      </div>
      
      <form id="vatRateForm">
        <input type="hidden" id="vatRateId">
        
        <div class="form-group">
          <label>ç¨ç‡ä»£ç  *</label>
          <input type="text" id="vatRateCode" required placeholder="ä¾‹å¦‚ï¼šVAT 23%">
          <small style="color: #666; font-size: 12px;">å»ºè®®æ ¼å¼ï¼šVAT XX%</small>
        </div>
        
        <div class="form-group">
          <label>æ˜¾ç¤ºåç§° *</label>
          <input type="text" id="vatRateName" required placeholder="ä¾‹å¦‚ï¼šVAT 23%">
        </div>
        
        <div class="form-group">
          <label>ç¨ç‡ (%) *</label>
          <input type="number" id="vatRateValue" required min="0" max="100" step="0.1" placeholder="ä¾‹å¦‚ï¼š23">
        </div>
        
        <div class="form-group">
          <label>æè¿°</label>
          <textarea id="vatRateDescription" placeholder="ç¨ç‡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        
        <div class="form-group">
          <label>é€‚ç”¨èŒƒå›´</label>
          <textarea id="vatRateScope" placeholder="é€‚ç”¨èŒƒå›´è¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        
        <div class="form-group">
          <label>æ’åºæƒé‡</label>
          <input type="number" id="vatRateSortOrder" value="0" placeholder="æ•°å­—è¶Šå°è¶Šé å‰">
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeVatRateModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    let allCategories = [];
    let allConditions = [];
    let allVatRates = [];

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // åŠ è½½å¯¹åº”æ•°æ®
      if (tabName === 'categories') {
        loadCategories();
      } else if (tabName === 'conditions') {
        loadConditions();
      } else if (tabName === 'vat-rates') {
        loadVatRates();
      } else if (tabName === 'system-info') {
        loadSystemStats();
      }
    }

    // åŠ è½½äº§å“åˆ†ç±»
    async function loadCategories() {
      const container = document.getElementById('categoriesTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/categories`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          allCategories = result.data;
          
          const html = `
            <table>
              <thead>
                <tr>
                  <th>åˆ†ç±»ç±»å‹</th>
                  <th>æè¿°</th>
                  <th>é»˜è®¤ç¨ç‡</th>
                  <th>é»˜è®¤æˆè‰²</th>
                  <th>æ’åº</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(cat => `
                  <tr>
                    <td><strong>${cat.type}</strong></td>
                    <td>${cat.description || '-'}</td>
                    <td>${cat.defaultVatRate || 'VAT 23%'}</td>
                    <td>${cat.defaultCondition || 'BRAND_NEW'}</td>
                    <td>${cat.sortOrder || 0}</td>
                    <td>${cat.isActive ? '<span class="badge badge-success">å¯ç”¨</span>' : '<span class="badge badge-danger">ç¦ç”¨</span>'}</td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-primary icon-btn" onclick="editCategory('${cat._id}')">ç¼–è¾‘</button>
                        <button class="btn btn-danger icon-btn" onclick="deleteCategory('${cat._id}', '${cat.type}')">åˆ é™¤</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— åˆ†ç±»æ•°æ®</p>';
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ˜¾ç¤ºæ·»åŠ åˆ†ç±»æ¨¡æ€æ¡†
    async function showAddCategoryModal() {
      document.getElementById('modalTitle').textContent = 'æ·»åŠ äº§å“åˆ†ç±»';
      document.getElementById('categoryForm').reset();
      document.getElementById('categoryId').value = '';
      
      // åŠ è½½ç¨ç‡å’Œæˆè‰²é€‰é¡¹
      await loadModalOptions();
      
      document.getElementById('categoryModal').classList.add('active');
    }

    // åŠ è½½æ¨¡æ€æ¡†çš„ä¸‹æ‹‰é€‰é¡¹
    async function loadModalOptions() {
      // åŠ è½½ç¨ç‡é€‰é¡¹
      if (allVatRates.length === 0) {
        await loadVatRatesData();
      }
      const vatRateSelect = document.getElementById('categoryVatRate');
      vatRateSelect.innerHTML = allVatRates.map(vat => 
        `<option value="${vat.code}">${vat.name}</option>`
      ).join('');
      
      // åŠ è½½æˆè‰²é€‰é¡¹
      if (allConditions.length === 0) {
        await loadConditionsData();
      }
      const conditionSelect = document.getElementById('categoryCondition');
      conditionSelect.innerHTML = allConditions.map(cond => 
        `<option value="${cond.code}">${cond.name}</option>`
      ).join('');
    }

    // åŠ è½½ç¨ç‡æ•°æ®ï¼ˆä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œåªç”¨äºä¸‹æ‹‰é€‰é¡¹ï¼‰
    async function loadVatRatesData() {
      try {
        const response = await fetch(`${API_BASE}/vat-rates`);
        const result = await response.json();
        if (result.success && result.data.length > 0) {
          allVatRates = result.data;
        } else {
          // ä½¿ç”¨é»˜è®¤å€¼
          allVatRates = [
            { code: 'VAT 23%', name: 'VAT 23%', rate: 23 },
            { code: 'VAT 13.5%', name: 'VAT 13.5%', rate: 13.5 },
            { code: 'VAT 0%', name: 'VAT 0%', rate: 0 }
          ];
        }
      } catch (error) {
        console.error('åŠ è½½ç¨ç‡å¤±è´¥:', error);
        allVatRates = [
          { code: 'VAT 23%', name: 'VAT 23%', rate: 23 },
          { code: 'VAT 13.5%', name: 'VAT 13.5%', rate: 13.5 },
          { code: 'VAT 0%', name: 'VAT 0%', rate: 0 }
        ];
      }
    }

    // åŠ è½½æˆè‰²æ•°æ®ï¼ˆä¸æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œåªç”¨äºä¸‹æ‹‰é€‰é¡¹ï¼‰
    async function loadConditionsData() {
      try {
        const response = await fetch(`${API_BASE}/conditions`);
        const result = await response.json();
        if (result.success && result.data.length > 0) {
          allConditions = result.data;
        } else {
          // ä½¿ç”¨é»˜è®¤å€¼
          allConditions = [
            { code: 'BRAND_NEW', name: 'å…¨æ–°' },
            { code: 'PRE_OWNED', name: 'äºŒæ‰‹' },
            { code: 'REFURBISHED', name: 'ç¿»æ–°' }
          ];
        }
      } catch (error) {
        console.error('åŠ è½½æˆè‰²å¤±è´¥:', error);
        allConditions = [
          { code: 'BRAND_NEW', name: 'å…¨æ–°' },
          { code: 'PRE_OWNED', name: 'äºŒæ‰‹' },
          { code: 'REFURBISHED', name: 'ç¿»æ–°' }
        ];
      }
    }

    // ç¼–è¾‘åˆ†ç±»
    async function editCategory(categoryId) {
      const category = allCategories.find(c => c._id === categoryId);
      if (!category) {
        alert('åˆ†ç±»ä¸å­˜åœ¨');
        return;
      }
      
      document.getElementById('modalTitle').textContent = 'ç¼–è¾‘äº§å“åˆ†ç±»';
      document.getElementById('categoryId').value = category._id;
      document.getElementById('categoryType').value = category.type;
      document.getElementById('categoryDescription').value = category.description || '';
      document.getElementById('categorySortOrder').value = category.sortOrder || 0;
      
      // åŠ è½½ä¸‹æ‹‰é€‰é¡¹
      await loadModalOptions();
      
      // è®¾ç½®é€‰ä¸­çš„å€¼
      document.getElementById('categoryVatRate').value = category.defaultVatRate || 'VAT 23%';
      document.getElementById('categoryCondition').value = category.defaultCondition || 'BRAND_NEW';
      
      document.getElementById('categoryModal').classList.add('active');
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
    }

    // ä¿å­˜åˆ†ç±»
    document.getElementById('categoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const categoryId = document.getElementById('categoryId').value;
      const data = {
        type: document.getElementById('categoryType').value,
        description: document.getElementById('categoryDescription').value,
        defaultVatRate: document.getElementById('categoryVatRate').value,
        defaultCondition: document.getElementById('categoryCondition').value,
        sortOrder: parseInt(document.getElementById('categorySortOrder').value) || 0,
        isActive: true
      };
      
      try {
        const url = categoryId ? `${API_BASE}/categories/${categoryId}` : `${API_BASE}/categories`;
        const method = categoryId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(categoryId ? 'åˆ†ç±»æ›´æ–°æˆåŠŸ' : 'åˆ†ç±»æ·»åŠ æˆåŠŸ');
          closeCategoryModal();
          loadCategories();
        } else {
          alert('æ“ä½œå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    });

    // åˆ é™¤åˆ†ç±»
    async function deleteCategory(categoryId, categoryType) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»"${categoryType}"å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šåˆ é™¤å‰è¯·ç¡®ä¿è¯¥åˆ†ç±»ä¸‹æ²¡æœ‰äº§å“ï¼Œæˆ–å·²å°†äº§å“ç§»åŠ¨åˆ°å…¶ä»–åˆ†ç±»ã€‚`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/categories/${categoryId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('åˆ†ç±»åˆ é™¤æˆåŠŸ');
          loadCategories();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // åŠ è½½ç³»ç»Ÿç»Ÿè®¡
    async function loadSystemStats() {
      const container = document.getElementById('systemStats');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/stats`);
        const result = await response.json();
        
        if (result.success) {
          const stats = result.data;
          const html = `
            <table>
              <tr>
                <th style="width: 200px;">äº§å“æ€»æ•°</th>
                <td>${stats.totalProducts || 0}</td>
              </tr>
              <tr>
                <th>æœ‰åº“å­˜äº§å“</th>
                <td>${stats.availableProducts || 0}</td>
              </tr>
              <tr>
                <th>ç”¨æˆ·æ€»æ•°</th>
                <td>${stats.totalUsers || 0}</td>
              </tr>
              <tr>
                <th>ä¾›åº”å•†æ€»æ•°</th>
                <td>${stats.totalSuppliers || 0}</td>
              </tr>
              <tr>
                <th>é‡‡è´­å‘ç¥¨</th>
                <td>${stats.totalInvoices || 0}</td>
              </tr>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">åŠ è½½å¤±è´¥</p>';
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      loadCategories();
      document.getElementById('lastUpdate').textContent = new Date().toLocaleDateString('zh-CN');
    });

    // ==================== è®¾å¤‡æˆè‰²ç®¡ç† ====================
    
    // åŠ è½½è®¾å¤‡æˆè‰²
    async function loadConditions() {
      const container = document.getElementById('conditionsTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/conditions`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          allConditions = result.data;
          
          const html = `
            <table>
              <thead>
                <tr>
                  <th>æˆè‰²ä»£ç </th>
                  <th>æ˜¾ç¤ºåç§°</th>
                  <th>æè¿°</th>
                  <th>æ’åº</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(cond => `
                  <tr>
                    <td><code>${cond.code}</code></td>
                    <td><strong>${cond.name}</strong></td>
                    <td>${cond.description || '-'}</td>
                    <td>${cond.sortOrder || 0}</td>
                    <td>${cond.isActive ? '<span class="badge badge-success">å¯ç”¨</span>' : '<span class="badge badge-danger">ç¦ç”¨</span>'}</td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-primary icon-btn" onclick="editCondition('${cond._id}')">ç¼–è¾‘</button>
                        <button class="btn btn-danger icon-btn" onclick="deleteCondition('${cond._id}', '${cond.name}')">åˆ é™¤</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— æˆè‰²æ•°æ®</p>';
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ˜¾ç¤ºæ·»åŠ æˆè‰²æ¨¡æ€æ¡†
    function showAddConditionModal() {
      document.getElementById('conditionModalTitle').textContent = 'æ·»åŠ è®¾å¤‡æˆè‰²';
      document.getElementById('conditionForm').reset();
      document.getElementById('conditionId').value = '';
      document.getElementById('conditionModal').classList.add('active');
    }

    // ç¼–è¾‘æˆè‰²
    function editCondition(conditionId) {
      const condition = allConditions.find(c => c._id === conditionId);
      if (!condition) {
        alert('æˆè‰²ä¸å­˜åœ¨');
        return;
      }
      
      document.getElementById('conditionModalTitle').textContent = 'ç¼–è¾‘è®¾å¤‡æˆè‰²';
      document.getElementById('conditionId').value = condition._id;
      document.getElementById('conditionCode').value = condition.code;
      document.getElementById('conditionName').value = condition.name;
      document.getElementById('conditionDescription').value = condition.description || '';
      document.getElementById('conditionSortOrder').value = condition.sortOrder || 0;
      
      document.getElementById('conditionModal').classList.add('active');
    }

    // å…³é—­æˆè‰²æ¨¡æ€æ¡†
    function closeConditionModal() {
      document.getElementById('conditionModal').classList.remove('active');
    }

    // ä¿å­˜æˆè‰²
    document.getElementById('conditionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const conditionId = document.getElementById('conditionId').value;
      const data = {
        code: document.getElementById('conditionCode').value.toUpperCase(),
        name: document.getElementById('conditionName').value,
        description: document.getElementById('conditionDescription').value,
        sortOrder: parseInt(document.getElementById('conditionSortOrder').value) || 0,
        isActive: true
      };
      
      try {
        const url = conditionId ? `${API_BASE}/conditions/${conditionId}` : `${API_BASE}/conditions`;
        const method = conditionId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(conditionId ? 'æˆè‰²æ›´æ–°æˆåŠŸ' : 'æˆè‰²æ·»åŠ æˆåŠŸ');
          closeConditionModal();
          loadConditions();
        } else {
          alert('æ“ä½œå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    });

    // åˆ é™¤æˆè‰²
    async function deleteCondition(conditionId, conditionName) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤æˆè‰²"${conditionName}"å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šåˆ é™¤å‰è¯·ç¡®ä¿æ²¡æœ‰äº§å“ä½¿ç”¨æ­¤æˆè‰²ã€‚`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/conditions/${conditionId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('æˆè‰²åˆ é™¤æˆåŠŸ');
          loadConditions();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // ==================== ç¨ç‡ç®¡ç† ====================
    
    // åŠ è½½ç¨ç‡
    async function loadVatRates() {
      const container = document.getElementById('vatRatesTable');
      container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/vat-rates`);
        const result = await response.json();
        
        if (result.success && result.data.length > 0) {
          allVatRates = result.data;
          
          const html = `
            <table>
              <thead>
                <tr>
                  <th>ç¨ç‡ä»£ç </th>
                  <th>æ˜¾ç¤ºåç§°</th>
                  <th>ç¨ç‡</th>
                  <th>æè¿°</th>
                  <th>é€‚ç”¨èŒƒå›´</th>
                  <th>æ’åº</th>
                  <th>çŠ¶æ€</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${result.data.map(vat => `
                  <tr>
                    <td><code>${vat.code}</code></td>
                    <td><strong>${vat.name}</strong></td>
                    <td>${vat.rate}%</td>
                    <td>${vat.description || '-'}</td>
                    <td>${vat.applicableScope || '-'}</td>
                    <td>${vat.sortOrder || 0}</td>
                    <td>${vat.isActive ? '<span class="badge badge-success">å¯ç”¨</span>' : '<span class="badge badge-danger">ç¦ç”¨</span>'}</td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-primary icon-btn" onclick="editVatRate('${vat._id}')">ç¼–è¾‘</button>
                        <button class="btn btn-danger icon-btn" onclick="deleteVatRate('${vat._id}', '${vat.name}')">åˆ é™¤</button>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          container.innerHTML = html;
        } else {
          container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš‚æ— ç¨ç‡æ•°æ®</p>';
        }
      } catch (error) {
        container.innerHTML = `<div class="loading">åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ˜¾ç¤ºæ·»åŠ ç¨ç‡æ¨¡æ€æ¡†
    function showAddVatRateModal() {
      document.getElementById('vatRateModalTitle').textContent = 'æ·»åŠ ç¨ç‡';
      document.getElementById('vatRateForm').reset();
      document.getElementById('vatRateId').value = '';
      document.getElementById('vatRateModal').classList.add('active');
    }

    // ç¼–è¾‘ç¨ç‡
    function editVatRate(vatRateId) {
      const vatRate = allVatRates.find(v => v._id === vatRateId);
      if (!vatRate) {
        alert('ç¨ç‡ä¸å­˜åœ¨');
        return;
      }
      
      document.getElementById('vatRateModalTitle').textContent = 'ç¼–è¾‘ç¨ç‡';
      document.getElementById('vatRateId').value = vatRate._id;
      document.getElementById('vatRateCode').value = vatRate.code;
      document.getElementById('vatRateName').value = vatRate.name;
      document.getElementById('vatRateValue').value = vatRate.rate;
      document.getElementById('vatRateDescription').value = vatRate.description || '';
      document.getElementById('vatRateScope').value = vatRate.applicableScope || '';
      document.getElementById('vatRateSortOrder').value = vatRate.sortOrder || 0;
      
      document.getElementById('vatRateModal').classList.add('active');
    }

    // å…³é—­ç¨ç‡æ¨¡æ€æ¡†
    function closeVatRateModal() {
      document.getElementById('vatRateModal').classList.remove('active');
    }

    // ä¿å­˜ç¨ç‡
    document.getElementById('vatRateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const vatRateId = document.getElementById('vatRateId').value;
      const data = {
        code: document.getElementById('vatRateCode').value,
        name: document.getElementById('vatRateName').value,
        rate: parseFloat(document.getElementById('vatRateValue').value),
        description: document.getElementById('vatRateDescription').value,
        applicableScope: document.getElementById('vatRateScope').value,
        sortOrder: parseInt(document.getElementById('vatRateSortOrder').value) || 0,
        isActive: true
      };
      
      try {
        const url = vatRateId ? `${API_BASE}/vat-rates/${vatRateId}` : `${API_BASE}/vat-rates`;
        const method = vatRateId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(vatRateId ? 'ç¨ç‡æ›´æ–°æˆåŠŸ' : 'ç¨ç‡æ·»åŠ æˆåŠŸ');
          closeVatRateModal();
          loadVatRates();
        } else {
          alert('æ“ä½œå¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('æ“ä½œå¤±è´¥: ' + error.message);
      }
    });

    // åˆ é™¤ç¨ç‡
    async function deleteVatRate(vatRateId, vatRateName) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¨ç‡"${vatRateName}"å—ï¼Ÿ\n\nâš ï¸ æ³¨æ„ï¼šåˆ é™¤å‰è¯·ç¡®ä¿æ²¡æœ‰äº§å“æˆ–åˆ†ç±»ä½¿ç”¨æ­¤ç¨ç‡ã€‚`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/vat-rates/${vatRateId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('ç¨ç‡åˆ é™¤æˆåŠŸ');
          loadVatRates();
        } else {
          alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
      } catch (error) {
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }
  </script>
</body>
</html>
