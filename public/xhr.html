<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>XHR版本测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; background: #f8f9fa; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>XHR版本测试</h1>
    
    <h2>JavaScript状态</h2>
    <button onclick="testJS()">测试JavaScript</button>
    <div id="jsResult" class="result"></div>
    
    <h2>API测试</h2>
    <button onclick="testHealthXHR()">健康检查(XHR)</button>
    <button onclick="testHealthFetch()">健康检查(Fetch)</button>
    <div id="apiResult" class="result"></div>
    
    <h2>用户注册</h2>
    <input type="text" id="username" placeholder="用户名" value="xhrtest">
    <input type="email" id="email" placeholder="邮箱" value="xhr@test.com">
    <input type="password" id="password" placeholder="密码" value="123456">
    <select id="role">
        <option value="admin">管理员</option>
        <option value="manager">经理</option>
        <option value="staff">员工</option>
    </select>
    <br><br>
    <button onclick="registerXHR()">注册(XHR)</button>
    <button onclick="registerFetch()">注册(Fetch)</button>
    <div id="registerResult" class="result"></div>

    <script>
        console.log('XHR页面脚本加载');
        
        function testJS() {
            console.log('testJS被调用');
            document.getElementById('jsResult').innerHTML = 'JavaScript工作正常！时间: ' + new Date().toLocaleString();
            document.getElementById('jsResult').className = 'result success';
        }
        
        // 使用XMLHttpRequest测试健康检查
        function testHealthXHR() {
            console.log('开始XHR健康检查');
            document.getElementById('apiResult').innerHTML = '正在测试XHR...';
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/health', true);
            
            xhr.onreadystatechange = function() {
                console.log('XHR状态变化:', xhr.readyState, xhr.status);
                
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        console.log('XHR成功:', data);
                        document.getElementById('apiResult').innerHTML = 'XHR健康检查成功: ' + data.status;
                        document.getElementById('apiResult').className = 'result success';
                    } else {
                        console.log('XHR失败:', xhr.status, xhr.responseText);
                        document.getElementById('apiResult').innerHTML = 'XHR健康检查失败: ' + xhr.status;
                        document.getElementById('apiResult').className = 'result error';
                    }
                }
            };
            
            xhr.onerror = function() {
                console.log('XHR错误');
                document.getElementById('apiResult').innerHTML = 'XHR请求错误';
                document.getElementById('apiResult').className = 'result error';
            };
            
            xhr.send();
        }
        
        // 使用Fetch测试健康检查
        function testHealthFetch() {
            console.log('开始Fetch健康检查');
            document.getElementById('apiResult').innerHTML = '正在测试Fetch...';
            
            fetch('/health')
                .then(function(response) {
                    console.log('Fetch响应:', response);
                    return response.json();
                })
                .then(function(data) {
                    console.log('Fetch成功:', data);
                    document.getElementById('apiResult').innerHTML = 'Fetch健康检查成功: ' + data.status;
                    document.getElementById('apiResult').className = 'result success';
                })
                .catch(function(error) {
                    console.log('Fetch错误:', error);
                    document.getElementById('apiResult').innerHTML = 'Fetch请求失败: ' + error.message;
                    document.getElementById('apiResult').className = 'result error';
                });
        }
        
        // 使用XMLHttpRequest注册
        function registerXHR() {
            console.log('开始XHR注册');
            
            var userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };
            
            console.log('注册数据:', userData);
            document.getElementById('registerResult').innerHTML = '正在注册(XHR)...';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/auth/register', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                console.log('注册XHR状态:', xhr.readyState, xhr.status);
                
                if (xhr.readyState === 4) {
                    if (xhr.status === 201) {
                        var data = JSON.parse(xhr.responseText);
                        console.log('XHR注册成功:', data);
                        document.getElementById('registerResult').innerHTML = 'XHR注册成功: ' + data.user.username + ' (' + data.user.role + ')';
                        document.getElementById('registerResult').className = 'result success';
                    } else {
                        var errorData = JSON.parse(xhr.responseText);
                        console.log('XHR注册失败:', errorData);
                        document.getElementById('registerResult').innerHTML = 'XHR注册失败: ' + errorData.error;
                        document.getElementById('registerResult').className = 'result error';
                    }
                }
            };
            
            xhr.onerror = function() {
                console.log('XHR注册错误');
                document.getElementById('registerResult').innerHTML = 'XHR注册请求错误';
                document.getElementById('registerResult').className = 'result error';
            };
            
            xhr.send(JSON.stringify(userData));
        }
        
        // 使用Fetch注册
        function registerFetch() {
            console.log('开始Fetch注册');
            
            var userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };
            
            console.log('注册数据:', userData);
            document.getElementById('registerResult').innerHTML = '正在注册(Fetch)...';
            
            fetch('/api/auth/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            })
            .then(function(response) {
                console.log('Fetch注册响应:', response);
                return response.json();
            })
            .then(function(data) {
                console.log('Fetch注册成功:', data);
                if (data.user) {
                    document.getElementById('registerResult').innerHTML = 'Fetch注册成功: ' + data.user.username + ' (' + data.user.role + ')';
                    document.getElementById('registerResult').className = 'result success';
                } else {
                    document.getElementById('registerResult').innerHTML = 'Fetch注册失败: ' + data.error;
                    document.getElementById('registerResult').className = 'result error';
                }
            })
            .catch(function(error) {
                console.log('Fetch注册错误:', error);
                document.getElementById('registerResult').innerHTML = 'Fetch注册失败: ' + error.message;
                document.getElementById('registerResult').className = 'result error';
            });
        }
        
        // 页面加载时自动测试
        window.onload = function() {
            console.log('页面加载完成');
            testJS();
        };
    </script>
</body>
</html>