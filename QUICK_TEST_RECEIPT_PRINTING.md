# 快速测试 - 销售小票打印

## 测试目标
验证销售完成后自动打印80mm小票功能

## 前置条件

### 1. 确保服务器运行
```bash
node app.js
```

### 2. 准备测试账号
使用已有的商户账号，例如：
- 用户名: `merchant_001` 或 `murraydundrum`
- 密码: 对应密码

## 测试步骤

### 步骤1: 登录系统
1. 打开浏览器访问: http://localhost:3000/login.html
2. 输入商户账号和密码
3. 点击登录

### 步骤2: 进入销售业务
1. 点击"销售业务"标签
2. 选择一个产品分类（例如：手机配件）
3. 查看可用产品列表

### 步骤3: 添加商品到购物车
1. 点击任意商品的"添加到购物车"按钮
2. 确认购物车中显示商品
3. 可以添加多个商品测试

### 步骤4: 结账
1. 点击购物车中的"结账"按钮
2. 弹出结账对话框

### 步骤5: 选择支付方式
选择以下任一支付方式：
- 💵 现金 (CASH)
- 💳 刷卡 (CARD)
- 🔄 混合支付 (MIXED) - 需要输入现金和刷卡金额
- 🏦 转账 (TRANSFER)

### 步骤6: 输入客户信息（可选）
- 输入客户电话号码（可选）
- 例如：+353 87 123 4567

### 步骤7: 确认支付
1. 点击"✅ 确认支付"按钮
2. 等待处理

### 步骤8: 验证打印
**预期结果**:
1. ✅ 显示"销售成功"提示
2. ✅ 自动弹出新窗口显示小票
3. ✅ 自动触发打印对话框（延迟500ms）
4. ✅ 小票内容包含：
   - 公司信息（如果已配置）
   - 订单号
   - 日期时间
   - 收银员
   - 商品明细
   - 支付信息
   - 总金额
   - 感谢语

### 步骤9: 打印操作
**选项A - 自动打印**:
1. 打印对话框自动弹出
2. 选择打印机
3. 点击"打印"
4. 小票窗口自动关闭

**选项B - 手动打印**:
1. 如果自动打印未触发
2. 点击窗口中的"🖨️ 打印"按钮
3. 选择打印机并打印
4. 点击"关闭"按钮

## 验证清单

### 小票内容验证
- [ ] 公司名称显示正确
- [ ] 地址信息完整（如果已配置）
- [ ] 联系电话显示
- [ ] VAT号码显示（如果已配置）
- [ ] 订单号格式正确
- [ ] 日期时间准确
- [ ] 收银员名称正确
- [ ] 客户电话显示（如果输入了）
- [ ] 商品名称正确
- [ ] 数量和单价正确
- [ ] 小计金额正确
- [ ] 序列号显示（如果有）
- [ ] 支付方式显示
- [ ] 总金额正确
- [ ] 感谢语显示

### 格式验证
- [ ] 宽度适合80mm纸张
- [ ] 文字清晰可读
- [ ] 对齐整齐
- [ ] 分隔线显示正确
- [ ] 无内容溢出
- [ ] 字体大小合适

### 功能验证
- [ ] 打印窗口正常弹出
- [ ] 自动打印触发（或手动打印可用）
- [ ] 打印后窗口自动关闭
- [ ] 主窗口功能正常
- [ ] 购物车已清空
- [ ] 可以继续下一笔销售

## 测试不同场景

### 场景1: 单个商品
- 添加1个商品
- 现金支付
- 验证打印

### 场景2: 多个商品
- 添加3-5个商品
- 刷卡支付
- 验证打印

### 场景3: 混合支付
- 添加商品
- 选择混合支付
- 输入现金和刷卡金额
- 验证打印显示两种支付方式

### 场景4: 带客户信息
- 添加商品
- 输入客户电话
- 验证打印显示客户电话

### 场景5: 带序列号商品
- 添加有序列号的设备（如手机）
- 验证打印显示序列号

## 故障排除

### 问题1: 打印窗口被拦截
**现象**: 点击确认支付后没有弹出窗口

**解决**:
1. 检查浏览器地址栏右侧是否有弹窗拦截图标
2. 点击允许弹出窗口
3. 重新测试

### 问题2: 公司信息显示默认值
**现象**: 小票显示"3C Product Store"而不是实际公司名

**原因**: 用户未配置公司信息

**解决**:
1. 使用管理员账号登录
2. 进入用户管理
3. 编辑测试用户
4. 填写公司信息：
   ```
   公司名称: 测试商店
   地址: 测试街道123号, 都柏林, D01 ABC1
   电话: +353 1 234 5678
   邮箱: test@store.ie
   VAT号: IE1234567X
   ```
5. 保存后重新测试

### 问题3: 自动打印不工作
**现象**: 窗口弹出但不自动打印

**原因**: 浏览器安全限制

**解决**: 使用窗口中的"🖨️ 打印"按钮手动打印

### 问题4: 打印格式错误
**现象**: 内容溢出或格式混乱

**解决**:
1. 在打印对话框中选择正确的纸张大小
2. 设置边距为"最小"或"无"
3. 确保缩放为100%

### 问题5: API错误
**现象**: 控制台显示404或500错误

**检查**:
1. 确认服务器正在运行
2. 检查控制台错误信息
3. 验证API路径: `/api/users/profile?username=xxx`

## 浏览器兼容性

### 推荐浏览器
- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ⚠️ Safari (可能需要手动打印)

### 已知问题
- Safari: `onafterprint` 事件可能不触发，需要手动关闭窗口
- 旧版浏览器: 可能不支持某些CSS特性

## 打印机测试

### 虚拟打印机测试
如果没有实体打印机，可以使用：
1. **Microsoft Print to PDF** - 生成PDF文件
2. **Microsoft XPS Document Writer** - 生成XPS文件
3. 验证内容和格式

### 实体打印机测试
1. 连接80mm热敏打印机
2. 设置为默认打印机
3. 执行测试
4. 检查实际打印效果

## 成功标准

测试通过条件：
1. ✅ 销售流程完整无错误
2. ✅ 打印窗口正常弹出
3. ✅ 小票内容完整准确
4. ✅ 格式适合80mm纸张
5. ✅ 打印功能正常工作
6. ✅ 主窗口功能不受影响

## 下一步

测试通过后：
1. 配置所有商户的公司信息
2. 培训用户使用打印功能
3. 准备实体打印机
4. 进行实际环境测试
5. 收集用户反馈

## 报告问题

如果发现问题，请记录：
1. 问题描述
2. 重现步骤
3. 浏览器版本
4. 控制台错误信息
5. 截图或打印样本
