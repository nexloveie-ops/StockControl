# 利润计算修复

## 问题描述

之前的利润计算存在两个问题：

1. **成本价错误**: 使用`wholesalePrice`（批发价）作为成本价，而不是真实的`costPrice`（采购成本）
2. **未扣除税额**: 利润计算没有减去应缴税额

### 示例问题

以IMEI 352928114188457为例：
- 真实采购成本: €195（从MurrayRanelagh调货）
- Mobile123设置的批发价: €200
- 销售价格: €249
- 税额: €9.16

**错误计算**:
- 利润 = €249 - €200 = €49

**正确计算**:
- 利润 = €249 - €195 - €9.16 = €44.84

## 修复内容

### 1. 后端修复 (app.js 第7759行)

**修改前**:
```javascript
// 使用批发价作为成本价（批发价就是商户的采购成本）
const costPrice = inventory.wholesalePrice || inventory.costPrice;
```

**修改后**:
```javascript
// 使用真实的采购成本价（costPrice才是真实的采购成本）
const costPrice = inventory.costPrice || inventory.wholesalePrice;
```

**说明**: 
- `costPrice`: 真实的采购成本（从供应商或调货获得的价格）
- `wholesalePrice`: 商户设置的批发价（用于对外销售的价格）
- 优先使用`costPrice`作为成本计算基础

### 2. 前端修复 (merchant.html 第1679-1683行)

**修改前**:
```javascript
// 计算利润
sale.items.forEach(item => {
  totalProfit += (item.price - item.costPrice) * item.quantity;
});
```

**修改后**:
```javascript
// 计算利润（利润 = 销售额 - 成本 - 应缴税额）
sale.items.forEach(item => {
  const itemProfit = (item.price - item.costPrice) * item.quantity;
  const itemTax = item.taxAmount || 0;
  totalProfit += itemProfit - itemTax;
});
```

**说明**:
- 毛利润 = (销售价 - 成本价) × 数量
- 净利润 = 毛利润 - 应缴税额
- 这才是真实的利润

## 利润计算公式

### 完整公式

```
净利润 = (销售价格 - 采购成本) × 数量 - 应缴税额
```

### 税额计算

根据产品的税务分类（taxClassification）：

1. **VAT_23** (标准税率 23%)
   ```
   税额 = 销售额 × 23/123
   ```

2. **SERVICE_VAT_13_5** (服务税率 13.5%)
   ```
   税额 = 销售额 × 13.5/113.5
   ```

3. **MARGIN_VAT_0** (差价税 23%)
   ```
   差价 = 销售额 - 成本
   税额 = 差价 × 23/123
   ```

## 示例计算

### 示例1: IPHONE11 (VAT 23%)

**数据**:
- 销售价格: €249
- 采购成本: €195
- 数量: 1
- 税务分类: VAT_23

**计算过程**:
```
销售额 = €249 × 1 = €249
税额 = €249 × 23/123 = €46.56
毛利润 = (€249 - €195) × 1 = €54
净利润 = €54 - €46.56 = €7.44
```

### 示例2: iPhone Screen Saver (VAT 23%)

**数据**:
- 销售价格: €10
- 采购成本: €2
- 数量: 1
- 税务分类: VAT_23

**计算过程**:
```
销售额 = €10 × 1 = €10
税额 = €10 × 23/123 = €1.87
毛利润 = (€10 - €2) × 1 = €8
净利润 = €8 - €1.87 = €6.13
```

### Mobile123 2月11日总利润

```
IPHONE11 净利润: €7.44
iPhone Screen Saver 净利润: €6.13
总净利润: €13.57
```

## 影响范围

### 已修改的文件
1. `app.js` - 销售API，修改成本价获取逻辑
2. `merchant.html` - 本日销售明细，修改利润计算公式

### 需要注意的地方

1. **历史数据**: 已经保存的销售记录不会自动更新，但显示时会使用新的计算方式
2. **成本价来源**: 
   - 从供应商采购: `costPrice` = 采购发票价格
   - 从仓库调货: `costPrice` = 仓库订单价格
   - 公司间调货: `costPrice` = 调货价格（transferPrice）
3. **税额**: 每个销售记录都保存了`taxAmount`，确保计算准确

## 测试建议

1. 创建新的销售订单，验证成本价是否正确
2. 查看本日销售明细，确认利润计算正确
3. 对比修改前后的利润差异
4. 验证不同税务分类的产品利润计算

## 版本信息

- 修复日期: 2026年2月11日
- 版本: v2.4.1
- 修复内容: 利润计算使用真实采购成本并扣除应缴税额
