# 销售发票价格问题修复

## 问题描述

用户发现客户管理中查看发票时，产品价格与实际销售价格不一致。

### 具体案例
- **产品**: IPHONE13
- **序列号**: 357479188926245
- **发票编号**: SI-1770856113244-0001
- **发票中的价格**: €275.6（不含税）
- **产品批发价**: €275.6
- **产品零售价**: €349

## 根本原因

### 1. 两套系统并存
系统中存在两套销售记录系统：

#### 旧系统（SalesInvoice）
- 位置：`app.js` 第5050-5200行
- 创建逻辑：使用产品的 `wholesalePrice` 作为销售价格
- 问题：**无法记录实际销售价格**，因为同一产品不同IMEI可能以不同价格销售

```javascript
// 第5069行 - 使用批发价作为销售价格
const unitPrice = product.wholesalePrice || 0;
const totalPrice = unitPrice * item.quantity;
```

#### 新系统（MerchantSale）
- 位置：`app.js` 第7910-8100行
- 创建逻辑：记录实际销售价格 `item.price`
- 优点：**准确记录每笔交易的实际价格**

```javascript
// 第8050行 - 使用实际销售价格
saleItems.push({
  productName: item.productName,
  quantity: item.quantity,
  price: item.price,  // 实际销售价格
  costPrice: costPrice,
  // ...
});
```

### 2. 客户发票API返回旧数据
- API端点：`/api/admin/customers/:customerId/invoices`（第4835行）
- 返回数据：只返回 `SalesInvoice` 数据
- 问题：显示的是批发价，不是实际销售价格

## 数据验证结果

### 发票数据（SalesInvoice）
```
发票编号: SI-1770856113244-0001
发票日期: 2026-02-12
客户: WY Tech & Electronics Limited
总金额: €5280.60

目标产品:
  - 产品名称: IPHONE13
  - 产品批发价: €275.6
  - 产品零售价: €349
  - 发票单价: €275.6 (使用批发价)
  - 税率: VAT 0%
```

### 商户销售记录（MerchantSale）
```
❌ 未找到商户销售记录
```

**结论**: 这笔销售是使用旧系统创建的，只有 `SalesInvoice` 记录，没有 `MerchantSale` 记录。

## 解决方案

### 方案1：修改客户发票API（推荐）
修改 `/api/admin/customers/:customerId/invoices` API，同时返回两种系统的数据：

```javascript
app.get('/api/admin/customers/:customerId/invoices', checkDbConnection, async (req, res) => {
  try {
    const { customerId } = req.params;
    const SalesInvoice = require('./models/SalesInvoice');
    const MerchantSale = require('./models/MerchantSale');
    
    // 获取旧系统的销售发票
    const salesInvoices = await SalesInvoice.find({ customer: customerId })
      .populate('customer', 'name code')
      .populate('items.product', 'name sku barcode')
      .sort({ invoiceDate: -1 })
      .lean();
    
    // 获取新系统的商户销售记录（通过客户电话匹配）
    const customer = await Customer.findById(customerId);
    const merchantSales = customer && customer.contact?.phone 
      ? await MerchantSale.find({ customerPhone: customer.contact.phone })
          .sort({ saleDate: -1 })
          .lean()
      : [];
    
    // 合并两种数据，标记来源
    const allInvoices = [
      ...salesInvoices.map(inv => ({ ...inv, source: 'SalesInvoice' })),
      ...merchantSales.map(sale => ({ ...sale, source: 'MerchantSale' }))
    ].sort((a, b) => {
      const dateA = a.invoiceDate || a.saleDate;
      const dateB = b.invoiceDate || b.saleDate;
      return new Date(dateB) - new Date(dateA);
    });
    
    res.json({
      success: true,
      data: allInvoices
    });
  } catch (error) {
    console.error('获取客户发票失败:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});
```

### 方案2：废弃旧系统，只使用MerchantSale
- 停止创建 `SalesInvoice` 记录
- 所有销售都使用 `MerchantSale` 系统
- 保留旧的 `SalesInvoice` 数据用于历史查询

### 方案3：修改SalesInvoice创建逻辑
在创建 `SalesInvoice` 时，传入实际销售价格而不是使用 `wholesalePrice`：

```javascript
// 修改第5069行
// 旧代码：
const unitPrice = product.wholesalePrice || 0;

// 新代码：
const unitPrice = item.actualPrice || product.wholesalePrice || 0;
```

但这需要修改所有调用 `SalesInvoice` 创建的地方，传入 `actualPrice` 参数。

## 推荐方案

**方案1（修改客户发票API）** 是最佳选择，因为：

1. ✅ 不破坏现有数据
2. ✅ 兼容新旧两套系统
3. ✅ 显示真实的销售价格（MerchantSale）
4. ✅ 保留历史数据（SalesInvoice）
5. ✅ 前端可以根据 `source` 字段区分数据来源

## 前端修改

修改 `prototype-working.html` 中的 `viewCustomerInvoices()` 函数，处理两种数据格式：

```javascript
function viewCustomerInvoices(customerId, customerName) {
  fetch(`/api/admin/customers/${customerId}/invoices`)
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        const invoices = result.data;
        
        let html = `
          <div class="modal-header">
            <h3>客户发票 - ${customerName}</h3>
            <button onclick="closeCustomerInvoicesModal()" class="close-btn">×</button>
          </div>
          <div class="modal-body">
            <table class="data-table">
              <thead>
                <tr>
                  <th>发票编号</th>
                  <th>日期</th>
                  <th>金额</th>
                  <th>来源</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        invoices.forEach(invoice => {
          const invoiceNumber = invoice.invoiceNumber || invoice._id;
          const date = invoice.invoiceDate || invoice.saleDate;
          const amount = invoice.totalAmount;
          const source = invoice.source === 'MerchantSale' ? '商户系统' : '旧系统';
          
          html += `
            <tr>
              <td>${invoiceNumber}</td>
              <td>${new Date(date).toLocaleDateString('zh-CN')}</td>
              <td>€${amount.toFixed(2)}</td>
              <td>${source}</td>
              <td>
                <button onclick="downloadSalesInvoicePDF('${invoice._id}', '${invoice.source}')" 
                        class="btn-small">
                  下载PDF
                </button>
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('customerInvoicesModal').innerHTML = html;
        document.getElementById('customerInvoicesModal').style.display = 'block';
      }
    });
}
```

## 实施步骤

1. ✅ 验证问题（已完成）
2. ⏳ 修改后端API（`/api/admin/customers/:customerId/invoices`）
3. ⏳ 修改前端显示逻辑
4. ⏳ 测试新旧数据显示
5. ⏳ 更新PDF导出功能支持两种数据格式

## 相关文件

- `StockControl-main/app.js` (第4835行 - 客户发票API)
- `StockControl-main/app.js` (第5050-5200行 - SalesInvoice创建)
- `StockControl-main/app.js` (第7910-8100行 - MerchantSale创建)
- `StockControl-main/public/prototype-working.html` (第6433-6550行 - 客户发票查看)
- `StockControl-main/check-invoice-SI-1770856113244-0001.js` (验证脚本)

## 日期
2026-02-12
