# åŸºäºå…¬å¸ä¿¡æ¯çš„è°ƒè´§/é”€å”®é€»è¾‘è®¾è®¡

## ä¸šåŠ¡éœ€æ±‚

åœ¨ç¾¤ç»„å†…è°ƒè´§æ—¶ï¼Œæ ¹æ®åŒæ–¹æ‰€å±å…¬å¸åˆ¤æ–­äº¤æ˜“ç±»å‹ï¼š
- **ç›¸åŒå…¬å¸**ï¼šç”Ÿæˆè°ƒè´§å•ï¼ˆå†…éƒ¨è°ƒæ‹¨ï¼ŒTransfer Orderï¼‰
- **ä¸åŒå…¬å¸**ï¼šç”Ÿæˆé”€å”®å‘ç¥¨ï¼ˆå…¬å¸é—´äº¤æ˜“ï¼ŒSales Invoiceï¼‰

## æ•°æ®æ¨¡å‹è®¾è®¡

### 1. UserNew æ¨¡å‹æ·»åŠ å…¬å¸ä¿¡æ¯

```javascript
companyInfo: {
  companyName: String,           // å…¬å¸åç§°
  registrationNumber: String,    // å…¬å¸æ³¨å†Œå·
  vatNumber: String,             // ç¨å·/VATå·
  address: {                     // å…¬å¸åœ°å€
    street: String,
    city: String,
    state: String,
    postalCode: String,
    country: String
  },
  contactPhone: String,          // è”ç³»ç”µè¯
  contactEmail: String           // è”ç³»é‚®ç®±
}
```

### 2. äº¤æ˜“ç±»å‹åˆ¤æ–­é€»è¾‘

```javascript
function determineTransactionType(fromUser, toUser) {
  // è·å–åŒæ–¹å…¬å¸åç§°
  const fromCompany = fromUser.companyInfo?.companyName;
  const toCompany = toUser.companyInfo?.companyName;
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€å…¬å¸
  if (fromCompany && toCompany && fromCompany === toCompany) {
    return 'INTERNAL_TRANSFER';  // å†…éƒ¨è°ƒæ‹¨
  } else {
    return 'INTER_COMPANY_SALE';  // å…¬å¸é—´é”€å”®
  }
}
```

## ä¸šåŠ¡æµç¨‹

### æµç¨‹ 1: å†…éƒ¨è°ƒæ‹¨ï¼ˆåŒä¸€å…¬å¸ï¼‰

```
ç”¨æˆ·A (Murray Mobile Ltd) â†’ ç”¨æˆ·B (Murray Mobile Ltd)

1. ç”¨æˆ·B åœ¨ç¾¤ç»„åº“å­˜ä¸­é€‰æ‹©äº§å“
2. å‘èµ·è°ƒè´§è¯·æ±‚
3. ç³»ç»Ÿæ£€æµ‹ï¼šåŒæ–¹å±äºåŒä¸€å…¬å¸
4. ç”Ÿæˆè°ƒè´§å•ï¼ˆTransfer Orderï¼‰
   - ç±»å‹ï¼šinternal_transfer
   - æ— éœ€å¼€å…·å‘ç¥¨
   - æˆæœ¬ä»·è½¬ç§»
5. ç”¨æˆ·A ç¡®è®¤å‘è´§
6. ç”¨æˆ·B ç¡®è®¤æ”¶è´§
7. åº“å­˜è½¬ç§»å®Œæˆ
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä¸æ¶‰åŠé”€å”®
- âœ… æˆæœ¬ä»·è½¬ç§»
- âœ… ä¸äº§ç”Ÿåˆ©æ¶¦
- âœ… ç®€åŒ–æµç¨‹

### æµç¨‹ 2: å…¬å¸é—´é”€å”®ï¼ˆä¸åŒå…¬å¸ï¼‰

```
ç”¨æˆ·A (Murray Mobile Ltd) â†’ ç”¨æˆ·C (Tech Store Ltd)

1. ç”¨æˆ·C åœ¨ç¾¤ç»„åº“å­˜ä¸­é€‰æ‹©äº§å“
2. å‘èµ·è°ƒè´§è¯·æ±‚
3. ç³»ç»Ÿæ£€æµ‹ï¼šåŒæ–¹å±äºä¸åŒå…¬å¸
4. ç”Ÿæˆé”€å”®å‘ç¥¨ï¼ˆSales Invoiceï¼‰
   - ç±»å‹ï¼šinter_company_sale
   - å–æ–¹ï¼šç”¨æˆ·A çš„å…¬å¸
   - ä¹°æ–¹ï¼šç”¨æˆ·C çš„å…¬å¸
   - é”€å”®ä»·æ ¼ï¼ˆæ‰¹å‘ä»·æˆ–é›¶å”®ä»·ï¼‰
5. ç”¨æˆ·A ç¡®è®¤å‘è´§
6. ç”¨æˆ·C ç¡®è®¤æ”¶è´§å¹¶ä»˜æ¬¾
7. å®Œæˆé”€å”®äº¤æ˜“
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ­£å¼é”€å”®äº¤æ˜“
- âœ… éœ€è¦å¼€å…·å‘ç¥¨
- âœ… äº§ç”Ÿåˆ©æ¶¦
- âœ… å®Œæ•´çš„é”€å”®æµç¨‹

## æ•°æ®åº“æ¨¡å‹

### InventoryTransfer æ¨¡å‹æ‰©å±•

```javascript
{
  transferNumber: String,
  transferType: {
    type: String,
    enum: ['INTERNAL_TRANSFER', 'INTER_COMPANY_SALE'],
    required: true
  },
  
  // è°ƒå‡ºæ–¹ä¿¡æ¯
  fromMerchant: String,
  fromCompany: {
    name: String,
    vatNumber: String,
    address: Object
  },
  
  // è°ƒå…¥æ–¹ä¿¡æ¯
  toMerchant: String,
  toCompany: {
    name: String,
    vatNumber: String,
    address: Object
  },
  
  // äº§å“ä¿¡æ¯
  items: [{
    productName: String,
    quantity: Number,
    transferPrice: Number,  // å†…éƒ¨è°ƒæ‹¨ï¼šæˆæœ¬ä»·ï¼›å…¬å¸é—´ï¼šé”€å”®ä»·
    // ...
  }],
  
  // è´¢åŠ¡ä¿¡æ¯ï¼ˆä»…å…¬å¸é—´é”€å”®ï¼‰
  financialInfo: {
    subtotal: Number,
    vatAmount: Number,
    totalAmount: Number,
    paymentStatus: {
      type: String,
      enum: ['pending', 'paid', 'partial'],
      default: 'pending'
    },
    paymentMethod: String,
    paidAmount: Number
  },
  
  // å…³è”å‘ç¥¨ï¼ˆä»…å…¬å¸é—´é”€å”®ï¼‰
  salesInvoiceId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'SalesInvoice'
  },
  
  status: {
    type: String,
    enum: ['pending', 'approved', 'shipped', 'completed', 'cancelled']
  }
}
```

## ç”¨æˆ·ç•Œé¢è®¾è®¡

### 1. ç”¨æˆ·ç®¡ç† - æ·»åŠ å…¬å¸ä¿¡æ¯

**ä½ç½®**: ç®¡ç†å‘˜æ§åˆ¶å° â†’ ç”¨æˆ·ç®¡ç† â†’ ç¼–è¾‘ç”¨æˆ·

**æ–°å¢å­—æ®µ**:
```
â”Œâ”€ å…¬å¸ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¬å¸åç§°: [________________]       â”‚
â”‚ æ³¨å†Œå·:   [________________]       â”‚
â”‚ VATå·:    [________________]       â”‚
â”‚                                    â”‚
â”‚ åœ°å€:                              â”‚
â”‚   è¡—é“:   [________________]       â”‚
â”‚   åŸå¸‚:   [________________]       â”‚
â”‚   é‚®ç¼–:   [________________]       â”‚
â”‚   å›½å®¶:   [________________]       â”‚
â”‚                                    â”‚
â”‚ è”ç³»ç”µè¯: [________________]       â”‚
â”‚ è”ç³»é‚®ç®±: [________________]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç¾¤ç»„åº“å­˜ - è°ƒè´§æµç¨‹

**åœºæ™¯ A: å†…éƒ¨è°ƒæ‹¨**
```
â”Œâ”€ è°ƒè´§ç¡®è®¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ å†…éƒ¨è°ƒæ‹¨                        â”‚
â”‚                                    â”‚
â”‚ è°ƒå‡ºæ–¹: MurrayRanelagh             â”‚
â”‚ è°ƒå…¥æ–¹: MurrayDundrum              â”‚
â”‚ å…¬å¸:   Murray Mobile Ltd (ç›¸åŒ)  â”‚
â”‚                                    â”‚
â”‚ äº§å“: iPhone 14 128GB              â”‚
â”‚ æ•°é‡: 1 å°                         â”‚
â”‚ ä»·æ ¼: â‚¬400.00 (æˆæœ¬ä»·)             â”‚
â”‚                                    â”‚
â”‚ â„¹ï¸ è¿™æ˜¯å†…éƒ¨è°ƒæ‹¨ï¼Œä¸ä¼šäº§ç”Ÿé”€å”®è®°å½•  â”‚
â”‚                                    â”‚
â”‚ [ç¡®è®¤è°ƒè´§] [å–æ¶ˆ]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœºæ™¯ B: å…¬å¸é—´é”€å”®**
```
â”Œâ”€ é”€å”®ç¡®è®¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’° å…¬å¸é—´é”€å”®                      â”‚
â”‚                                    â”‚
â”‚ å–æ–¹: MurrayRanelagh               â”‚
â”‚      Murray Mobile Ltd             â”‚
â”‚                                    â”‚
â”‚ ä¹°æ–¹: TechStore001                 â”‚
â”‚      Tech Store Ltd                â”‚
â”‚                                    â”‚
â”‚ äº§å“: iPhone 14 128GB              â”‚
â”‚ æ•°é‡: 1 å°                         â”‚
â”‚ ä»·æ ¼: â‚¬450.00 (æ‰¹å‘ä»·)             â”‚
â”‚ VAT:  â‚¬103.50 (23%)                â”‚
â”‚ æ€»è®¡: â‚¬553.50                      â”‚
â”‚                                    â”‚
â”‚ â„¹ï¸ è¿™æ˜¯å…¬å¸é—´é”€å”®ï¼Œå°†ç”Ÿæˆé”€å”®å‘ç¥¨  â”‚
â”‚                                    â”‚
â”‚ [ç¡®è®¤è´­ä¹°] [å–æ¶ˆ]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API è®¾è®¡

### 1. åˆ›å»ºè°ƒè´§/é”€å”®è¯·æ±‚

```javascript
POST /api/merchant/inventory/transfer

Request:
{
  fromMerchantId: "MurrayRanelagh",
  toMerchantId: "MurrayDundrum",
  items: [
    {
      inventoryId: "...",
      productName: "iPhone 14 128GB",
      quantity: 1,
      serialNumber: "222222"
    }
  ]
}

Response:
{
  success: true,
  data: {
    transferId: "...",
    transferType: "INTERNAL_TRANSFER" | "INTER_COMPANY_SALE",
    transferNumber: "TRF-2026020500001",
    fromCompany: "Murray Mobile Ltd",
    toCompany: "Murray Mobile Ltd",
    items: [...],
    totalAmount: 400.00,
    message: "å†…éƒ¨è°ƒæ‹¨å•å·²åˆ›å»º" | "é”€å”®è®¢å•å·²åˆ›å»º"
  }
}
```

### 2. ç¡®è®¤æ”¶è´§

```javascript
POST /api/merchant/inventory/transfer/:id/complete

// å†…éƒ¨è°ƒæ‹¨
Response:
{
  success: true,
  message: "è°ƒè´§å®Œæˆï¼Œåº“å­˜å·²æ›´æ–°"
}

// å…¬å¸é—´é”€å”®
Response:
{
  success: true,
  data: {
    salesInvoiceId: "...",
    invoiceNumber: "SI-2026020500001",
    totalAmount: 553.50
  },
  message: "é”€å”®å®Œæˆï¼Œå‘ç¥¨å·²ç”Ÿæˆ"
}
```

## å®ç°æ­¥éª¤

### Phase 1: æ•°æ®æ¨¡å‹ âœ…
- [x] UserNew æ¨¡å‹æ·»åŠ  companyInfo å­—æ®µ
- [ ] InventoryTransfer æ¨¡å‹æ·»åŠ  transferType å’Œå…¬å¸ä¿¡æ¯
- [ ] æ•°æ®è¿ç§»è„šæœ¬

### Phase 2: åç«¯é€»è¾‘
- [ ] åˆ›å»ºè°ƒè´§æ—¶åˆ¤æ–­äº¤æ˜“ç±»å‹
- [ ] å†…éƒ¨è°ƒæ‹¨é€»è¾‘
- [ ] å…¬å¸é—´é”€å”®é€»è¾‘
- [ ] è‡ªåŠ¨ç”Ÿæˆé”€å”®å‘ç¥¨

### Phase 3: å‰ç«¯ç•Œé¢
- [ ] ç”¨æˆ·ç®¡ç†æ·»åŠ å…¬å¸ä¿¡æ¯è¡¨å•
- [ ] ç¾¤ç»„åº“å­˜è°ƒè´§ç•Œé¢åŒºåˆ†æ˜¾ç¤º
- [ ] è°ƒè´§ç¡®è®¤å¯¹è¯æ¡†

### Phase 4: æµ‹è¯•
- [ ] åŒå…¬å¸å†…éƒ¨è°ƒæ‹¨æµ‹è¯•
- [ ] ä¸åŒå…¬å¸é”€å”®æµ‹è¯•
- [ ] å‘ç¥¨ç”Ÿæˆæµ‹è¯•

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: åŒå…¬å¸å†…éƒ¨è°ƒæ‹¨
```
ç”¨æˆ·è®¾ç½®:
- MurrayRanelagh: Murray Mobile Ltd
- MurrayDundrum: Murray Mobile Ltd

æµ‹è¯•æ­¥éª¤:
1. MurrayDundrum ä»ç¾¤ç»„åº“å­˜é€‰æ‹© MurrayRanelagh çš„äº§å“
2. å‘èµ·è°ƒè´§
3. éªŒè¯ï¼šç”Ÿæˆå†…éƒ¨è°ƒæ‹¨å•
4. éªŒè¯ï¼šä½¿ç”¨æˆæœ¬ä»·
5. éªŒè¯ï¼šä¸ç”Ÿæˆé”€å”®å‘ç¥¨
```

### åœºæ™¯ 2: ä¸åŒå…¬å¸é”€å”®
```
ç”¨æˆ·è®¾ç½®:
- MurrayRanelagh: Murray Mobile Ltd
- TechStore001: Tech Store Ltd

æµ‹è¯•æ­¥éª¤:
1. TechStore001 ä»ç¾¤ç»„åº“å­˜é€‰æ‹© MurrayRanelagh çš„äº§å“
2. å‘èµ·è°ƒè´§
3. éªŒè¯ï¼šç”Ÿæˆé”€å”®è®¢å•
4. éªŒè¯ï¼šä½¿ç”¨é”€å”®ä»·æ ¼
5. éªŒè¯ï¼šè‡ªåŠ¨ç”Ÿæˆé”€å”®å‘ç¥¨
6. éªŒè¯ï¼šå‘ç¥¨åŒ…å«åŒæ–¹å…¬å¸ä¿¡æ¯
```

## æ³¨æ„äº‹é¡¹

### 1. å…¬å¸ä¿¡æ¯å¿…å¡«
- å¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®å…¬å¸ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºä¸åŒå…¬å¸
- å»ºè®®ç®¡ç†å‘˜ä¸ºæ‰€æœ‰ç”¨æˆ·è®¾ç½®å…¬å¸ä¿¡æ¯

### 2. ä»·æ ¼ç­–ç•¥
- **å†…éƒ¨è°ƒæ‹¨**: ä½¿ç”¨æˆæœ¬ä»·ï¼ˆcostPriceï¼‰
- **å…¬å¸é—´é”€å”®**: ä½¿ç”¨æ‰¹å‘ä»·ï¼ˆwholesalePriceï¼‰æˆ–é›¶å”®ä»·ï¼ˆretailPriceï¼‰

### 3. ç¨åŠ¡å¤„ç†
- **å†…éƒ¨è°ƒæ‹¨**: ä¸æ¶‰åŠVAT
- **å…¬å¸é—´é”€å”®**: éœ€è¦è®¡ç®—VATå¹¶å¼€å…·å‘ç¥¨

### 4. æƒé™æ§åˆ¶
- åªæœ‰åŒç¾¤ç»„æˆå‘˜æ‰èƒ½äº’ç›¸è°ƒè´§
- éœ€è¦æœ‰ canTransferFromGroup æƒé™

## ä¼˜åŠ¿

### ä¸šåŠ¡ä¼˜åŠ¿
- âœ… ç¬¦åˆè´¢åŠ¡è§„èŒƒ
- âœ… åŒºåˆ†å†…éƒ¨è°ƒæ‹¨å’Œå¤–éƒ¨é”€å”®
- âœ… è‡ªåŠ¨åŒ–å‘ç¥¨ç”Ÿæˆ
- âœ… æ¸…æ™°çš„äº¤æ˜“è®°å½•

### æŠ€æœ¯ä¼˜åŠ¿
- âœ… çµæ´»çš„äº¤æ˜“ç±»å‹åˆ¤æ–­
- âœ… ç»Ÿä¸€çš„è°ƒè´§æµç¨‹
- âœ… å¯æ‰©å±•çš„æ•°æ®æ¨¡å‹

## ä¸‹ä¸€æ­¥

1. å®Œæˆ InventoryTransfer æ¨¡å‹æ‰©å±•
2. å®ç°äº¤æ˜“ç±»å‹åˆ¤æ–­é€»è¾‘
3. ä¿®æ”¹è°ƒè´§ API
4. æ›´æ–°å‰ç«¯ç•Œé¢
5. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

## çŠ¶æ€
ğŸ“ è®¾è®¡é˜¶æ®µ - 2026-02-05
