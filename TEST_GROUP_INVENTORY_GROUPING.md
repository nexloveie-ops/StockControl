# 测试群组库存设备分组功能

## 测试准备

### 1. 确保用户在同一群组
运行检查脚本：
```bash
node check-group-inventory.js
```

确认：
- MurrayDundrum 和 MurrayRanelagh 在同一群组
- MurrayDundrum 有查看群组库存的权限

### 2. 确保有测试数据
MurrayRanelagh 应该有：
- 多台相同型号的设备（如 iPhone 14）
- 至少一些配件（如 Lightning Cable）

## 测试步骤

### 测试 1: 设备产品合并显示

**步骤**:
1. 访问 http://localhost:3000
2. 使用 MurrayDundrum 登录
   - 用户名: `MurrayDundrum`
   - 密码: `merchant123`
3. 点击"群组库存"标签页
4. 点击"手机"或其他设备分类

**预期结果**:
- 相同产品合并为一行
- 显示格式：
  ```
  商户: MurrayRanelagh
  产品: iPhone 14 128GB AB Grade Vat margin
  品牌/型号: Apple iPhone 14
  颜色: -
  数量: 3 台  ← 合并后的总数
  零售价: €450.00
  操作: [▶ 查看序列号]
  ```

---

### 测试 2: 展开序列号列表

**步骤**:
1. 在设备列表中，点击某个产品的"▶ 查看序列号"按钮

**预期结果**:
- 按钮图标变为"▼"
- 下方展开显示序列号详情表格：
  ```
  ┌────────────────────────────────────────┐
  │ 序列号    │ IMEI      │ 成色          │
  ├────────────────────────────────────────┤
  │ 222222    │ -         │ AB Grade      │
  │ 222333    │ -         │ AB Grade      │
  │ 222555    │ -         │ AB Grade      │
  └────────────────────────────────────────┘
  ```
- 表格背景为浅灰色
- 序列号使用等宽字体

---

### 测试 3: 收起序列号列表

**步骤**:
1. 在展开状态下，再次点击"▼ 查看序列号"按钮

**预期结果**:
- 按钮图标变回"▶"
- 序列号列表收起隐藏

---

### 测试 4: 多个产品独立展开

**步骤**:
1. 展开第一个产品的序列号
2. 展开第二个产品的序列号
3. 收起第一个产品的序列号

**预期结果**:
- 每个产品的展开/收起状态独立
- 第一个产品收起后，第二个产品仍然展开

---

### 测试 5: 配件产品直接显示

**步骤**:
1. 点击"配件"分类

**预期结果**:
- 配件产品直接显示，不合并
- 表格列：
  ```
  商户 | 产品名称 | 品牌/型号 | 颜色 | 条码 | 数量 | 零售价
  ```
- 没有"查看序列号"按钮
- 数量直接显示（如 98）

---

### 测试 6: 不同商户的相同产品

**准备**: 确保两个商户都有相同型号的产品

**步骤**:
1. 查看设备分类

**预期结果**:
- 不同商户的相同产品分开显示
- 每个商户的产品独立合并
- 例如：
  ```
  MurrayRanelagh - iPhone 14 - 3台
  MurrayDundrum - iPhone 14 - 2台
  ```

---

### 测试 7: 序列号列表滚动

**准备**: 确保某个产品有很多台（超过10台）

**步骤**:
1. 展开该产品的序列号列表

**预期结果**:
- 序列号列表最大高度 300px
- 超出部分显示滚动条
- 可以滚动查看所有序列号

---

## 视觉验证

### 合并前 vs 合并后

**合并前（旧版本）**:
```
MurrayRanelagh | iPhone 14 | ... | 222222 | 1 | €450
MurrayRanelagh | iPhone 14 | ... | 222333 | 1 | €450
MurrayRanelagh | iPhone 14 | ... | 222555 | 1 | €450
```
→ 3 行，序列号直接显示

**合并后（新版本）**:
```
MurrayRanelagh | iPhone 14 | ... | 3台 | €450 | [▶ 查看序列号]
  (点击展开)
  ├─ 222222 | - | AB Grade
  ├─ 222333 | - | AB Grade
  └─ 222555 | - | AB Grade
```
→ 1 行 + 展开详情

---

## 功能检查清单

- [ ] 设备产品正确合并
- [ ] 合并后显示正确的总数量
- [ ] "查看序列号"按钮显示
- [ ] 点击按钮展开序列号列表
- [ ] 序列号列表显示完整信息（SN、IMEI、成色）
- [ ] 再次点击按钮收起列表
- [ ] 按钮图标正确切换（▶ ↔ ▼）
- [ ] 多个产品可以独立展开/收起
- [ ] 配件产品不合并，直接显示
- [ ] 不同商户的产品分开显示
- [ ] 序列号列表超出时可滚动
- [ ] 界面美观，对齐正确

---

## 问题排查

### 如果产品没有合并

1. **检查数据**
   - 确认产品有 serialNumber 或 imei
   - 确认产品名称、品牌、型号、颜色、价格完全相同

2. **查看控制台**
   - 按 F12 打开开发者工具
   - 查看是否有 JavaScript 错误

3. **刷新页面**
   - 清除缓存（Ctrl+Shift+Delete）
   - 重新加载页面

### 如果序列号无法展开

1. **检查按钮**
   - 确认按钮有 onclick 事件
   - 查看控制台是否有错误

2. **检查 HTML**
   - 按 F12 查看元素
   - 确认 `serial-row-{index}` 元素存在

3. **检查函数**
   - 在控制台输入：`typeof toggleGroupSerialNumbers`
   - 应该返回 "function"

---

## 预期的用户体验

### 优点
✅ 界面更简洁，相同产品合并显示
✅ 一眼看到每种产品的总数量
✅ 序列号按需查看，不占用空间
✅ 展开/收起流畅，交互友好

### 改进
- 比旧版本减少了列表长度
- 更容易找到想要的产品
- 详细信息按需查看

---

## 相关文档
- `GROUP_INVENTORY_DEVICE_GROUPING.md` - 完整功能文档

## 状态
✅ 功能已实现
⏳ 等待测试验证
