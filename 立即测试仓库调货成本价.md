# 立即测试：仓库调货成本价修复

## 🎯 测试目标
验证仓库调货的成本价是否正确显示为仓库的批发价

## 📋 准备工作
1. 重启服务器（应用代码修改）
2. 准备测试账号：
   - 仓库管理员：admin / admin123
   - 商户：MurrayDundrum / 密码

## 🧪 测试步骤

### 方案 A：测试现有产品（序列号 350032738439198）

#### 步骤 1: 查看当前成本价
1. 登录 MurrayDundrum 账号
2. 进入"我的库存"
3. 搜索：350032738439198
4. 点击"📊 时间线"按钮
5. 查看"产品入库"事件的成本价
6. 记录当前显示的成本价：€______

#### 步骤 2: 查看仓库批发价
1. 登录 admin 账号
2. 进入"管理库存"
3. 搜索相同的产品（通过序列号或产品名称）
4. 查看该产品的批发价
5. 记录批发价：€______

#### 步骤 3: 对比验证
- 如果成本价 = 批发价 → ✅ 已经正确
- 如果成本价 ≠ 批发价 → ❌ 需要运行数据迁移脚本

#### 步骤 4: 运行数据迁移脚本（如果需要）
```bash
cd StockControl-main
node fix-warehouse-order-cost-price.js
```

脚本会：
1. 显示所有需要更新的记录
2. 显示旧成本价和新成本价的对比
3. 询问是否继续
4. 输入 `yes` 确认更新

#### 步骤 5: 验证修复结果
1. 再次登录 MurrayDundrum 账号
2. 搜索：350032738439198
3. 点击"📊 时间线"
4. ✅ 验证：成本价应该等于批发价

---

### 方案 B：测试新订单（完整流程）

#### 步骤 1: 创建仓库订单
1. 登录 MurrayDundrum 账号
2. 进入"仓库订单"标签
3. 点击"创建新订单"
4. 选择一个产品（记录产品名称和批发价）
   - 产品名称：__________
   - 批发价：€______
5. 输入数量：1
6. 提交订单
7. 记录订单号：__________

#### 步骤 2: 仓库确认和发货
1. 登录 admin 账号
2. 进入"仓库订单管理"
3. 找到刚才创建的订单
4. 点击"确认订单"
5. 点击"标记发货"
6. 如果是设备（有序列号）：
   - 选择一个序列号
   - 记录序列号：__________
7. 如果是配件（无序列号）：
   - 输入发货数量：1
8. 确认发货

#### 步骤 3: 商户确认收货
1. 登录 MurrayDundrum 账号
2. 进入"仓库订单"
3. 找到状态为"已发货"的订单
4. 点击"确认收货"
5. ✅ 应该显示成功消息

#### 步骤 4: 验证成本价
1. 进入"我的库存"
2. 搜索刚才收货的产品：
   - 如果是设备：搜索序列号
   - 如果是配件：搜索产品名称
3. 找到产品后，点击"📊 时间线"按钮
4. 查看"产品入库"事件

**应该显示**：
```
📥 产品入库
产品入库到商户库存

来源: 仓库调货
成本价: €150.00  ← 应该等于步骤1记录的批发价
零售价: €200.00
数量: 1
```

5. ✅ 验证：成本价 = 批发价

---

## 📊 价格逻辑验证

### 示例产品价格结构

**仓库产品**：
```
成本价：€100  (仓库从供应商进货的价格)
批发价：€150  (仓库卖给商户的价格) ← 这是商户的成本价
零售价：€200  (建议零售价)
```

**商户库存**（修复后）：
```
成本价：€150  (= 仓库批发价) ✅
批发价：€150  (= 仓库批发价)
零售价：€200  (商户的零售价)
```

### 利润计算验证
假设商户以 €180 的价格销售：

**修复前**（错误）：
```
销售价：€180
成本价：€100  ← 错误（使用了仓库成本价）
利润：€80     ← 错误（虚高）
```

**修复后**（正确）：
```
销售价：€180
成本价：€150  ← 正确（仓库批发价）
利润：€30     ← 正确
```

---

## 🐛 常见问题

### 问题 1: 数据迁移脚本报错
**检查**:
- 确认 .env 文件中的 MONGODB_URI 正确
- 确认数据库连接正常
- 查看错误信息

### 问题 2: 成本价仍然不正确
**检查**:
1. 确认服务器已重启
2. 确认是新创建的订单（修复后）
3. 如果是旧订单，需要运行数据迁移脚本

### 问题 3: 找不到产品时间线
**检查**:
- 确认产品已入库
- 确认使用正确的序列号或产品名称搜索
- 刷新页面重试

---

## ✅ 测试通过标准

### 新订单（修复后）
- [ ] 商户确认收货成功
- [ ] 产品出现在"我的库存"中
- [ ] 产品时间线显示"产品入库"事件
- [ ] 成本价 = 仓库批发价
- [ ] 来源显示"仓库调货"

### 历史数据（运行脚本后）
- [ ] 脚本成功执行
- [ ] 显示更新的记录数量
- [ ] 产品时间线中的成本价已更新
- [ ] 成本价 = 批发价

---

## 📝 测试结果记录

### 测试信息
- 测试日期：__________
- 测试人员：__________
- 服务器版本：__________

### 方案 A：现有产品测试
| 项目 | 结果 | 备注 |
|------|------|------|
| 产品序列号 | 350032738439198 | |
| 修复前成本价 | €______ | |
| 仓库批发价 | €______ | |
| 是否需要迁移 | ⬜ 是 ⬜ 否 | |
| 迁移脚本执行 | ⬜ 成功 ⬜ 失败 ⬜ 未执行 | |
| 修复后成本价 | €______ | |
| 验证结果 | ⬜ 通过 ⬜ 失败 | |

### 方案 B：新订单测试
| 项目 | 结果 | 备注 |
|------|------|------|
| 订单号 | __________ | |
| 产品名称 | __________ | |
| 仓库批发价 | €______ | |
| 序列号（如有） | __________ | |
| 确认收货 | ⬜ 成功 ⬜ 失败 | |
| 产品入库 | ⬜ 成功 ⬜ 失败 | |
| 成本价显示 | €______ | |
| 成本价正确 | ⬜ 是 ⬜ 否 | |
| 验证结果 | ⬜ 通过 ⬜ 失败 | |

---

## 🎉 完成
如果所有测试通过，仓库调货成本价问题已完全修复！

## 📌 重要提示
1. 修复只影响新的订单，历史数据需要运行迁移脚本
2. 确保仓库产品的批发价设置正确
3. 成本价影响利润计算，修复后利润数据会更准确
