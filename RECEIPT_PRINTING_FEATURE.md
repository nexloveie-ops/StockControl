# 销售小票打印功能

## 功能概述
在销售业务结账确认支付后，系统会自动生成80mm热敏打印机格式的销售小票，并调用默认打印机打印。

## 实现细节

### 1. 前端实现 (merchant.html)

#### 打印触发
- 在 `completeSale()` 函数中，销售成功后自动调用 `printReceipt()` 函数
- 打印失败不会影响销售流程

#### 打印内容
小票包含以下信息：
- **公司信息**
  - 公司名称
  - 地址
  - 电话
  - 邮箱
  - VAT号码

- **订单信息**
  - 订单号
  - 日期时间
  - 收银员
  - 客户电话（如果有）

- **商品明细**
  - 商品名称
  - 数量 x 单价
  - 小计
  - 序列号（如果有）

- **支付信息**
  - 小计金额
  - 支付方式
  - 混合支付明细（如果适用）
  - 总计金额

- **页脚**
  - 感谢语
  - 联系方式

#### 打印格式
- 纸张宽度：80mm
- 字体：Courier New (等宽字体)
- 字号：12px (正文), 16px (标题)
- 布局：居中对齐（标题），左右对齐（明细）
- 分隔线：虚线

### 2. 后端实现 (app.js)

#### 新增API
```
GET /api/users/profile?username={username}
```

**功能**: 获取用户的完整信息，包括公司信息

**参数**:
- `username`: 用户名（必填）

**返回**:
```json
{
  "success": true,
  "data": {
    "username": "merchant_001",
    "email": "merchant@example.com",
    "companyInfo": {
      "companyName": "3C Product Store",
      "address": {
        "street": "123 Main St",
        "city": "Dublin",
        "postalCode": "D01 ABC1",
        "country": "Ireland"
      },
      "contactPhone": "+353 1 234 5678",
      "contactEmail": "info@3cstore.ie",
      "vatNumber": "IE1234567X"
    },
    ...
  }
}
```

### 3. 打印流程

1. **销售完成** → 调用 `printReceipt()`
2. **获取公司信息** → 调用 `/api/users/profile`
3. **生成HTML** → 创建80mm格式的小票HTML
4. **打开打印窗口** → `window.open()`
5. **自动打印** → `window.print()` (延迟500ms)
6. **打印后关闭** → `window.onafterprint` (延迟1000ms)

### 4. 用户体验

#### 自动打印
- 小票窗口打开后自动触发打印对话框
- 用户可以选择打印机或取消

#### 手动控制
- 如果自动打印失败，窗口显示"打印"和"关闭"按钮
- 用户可以手动点击打印或关闭窗口

#### 打印后
- 打印完成后自动关闭小票窗口
- 主窗口继续正常操作

## 使用方法

### 1. 配置公司信息

管理员需要为每个商户配置公司信息：

```javascript
// 在用户管理中设置
{
  companyInfo: {
    companyName: "您的公司名称",
    address: {
      street: "街道地址",
      city: "城市",
      postalCode: "邮编",
      country: "国家"
    },
    contactPhone: "联系电话",
    contactEmail: "联系邮箱",
    vatNumber: "VAT号码"
  }
}
```

### 2. 销售流程

1. 添加商品到购物车
2. 点击"结账"
3. 选择支付方式
4. 输入客户电话（可选）
5. 点击"确认支付"
6. **自动弹出打印对话框**
7. 选择打印机并打印
8. 完成销售

### 3. 打印机设置

#### 推荐打印机
- 80mm热敏打印机
- 支持ESC/POS指令
- USB或网络连接

#### 浏览器设置
- Chrome: 设置 → 打印 → 选择默认打印机
- Edge: 设置 → 打印 → 选择默认打印机
- Firefox: 文件 → 打印设置 → 选择默认打印机

#### 打印设置建议
- 纸张大小：80mm (自定义)
- 边距：最小或无边距
- 缩放：100%
- 背景图形：关闭

## 测试步骤

### 1. 准备测试数据
```javascript
// 确保用户有公司信息
const user = {
  username: "merchant_001",
  companyInfo: {
    companyName: "测试商店",
    address: {
      street: "测试街道123号",
      city: "都柏林",
      postalCode: "D01 ABC1"
    },
    contactPhone: "+353 1 234 5678",
    contactEmail: "test@store.ie",
    vatNumber: "IE1234567X"
  }
};
```

### 2. 测试打印
1. 登录商户账号
2. 进入"销售业务"
3. 添加测试商品到购物车
4. 点击"结账"
5. 选择支付方式（现金）
6. 点击"确认支付"
7. 验证打印窗口弹出
8. 检查小票内容是否正确
9. 点击打印或使用自动打印

### 3. 验证内容
- ✅ 公司信息显示正确
- ✅ 订单号生成
- ✅ 日期时间正确
- ✅ 商品明细完整
- ✅ 价格计算正确
- ✅ 支付方式显示
- ✅ 格式美观整齐

## 故障排除

### 问题1: 打印窗口被浏览器拦截
**解决**: 允许弹出窗口
- Chrome: 地址栏右侧 → 允许弹出窗口
- 或在浏览器设置中添加网站到白名单

### 问题2: 公司信息显示为默认值
**原因**: 用户未配置公司信息
**解决**: 
1. 管理员登录
2. 进入用户管理
3. 编辑用户
4. 填写公司信息
5. 保存

### 问题3: 打印格式不正确
**原因**: 打印机设置问题
**解决**:
1. 检查纸张大小设置（80mm）
2. 调整边距为最小
3. 确保缩放为100%
4. 关闭"适应页面"选项

### 问题4: 自动打印不工作
**原因**: 浏览器安全限制
**解决**: 
- 使用手动打印按钮
- 或在浏览器设置中允许自动打印

### 问题5: 打印后窗口不关闭
**原因**: 浏览器不支持 `onafterprint` 事件
**解决**: 手动点击"关闭"按钮

## 技术特点

### 1. 响应式设计
- 自适应80mm纸张宽度
- 自动调整内容布局
- 支持不同长度的商品列表

### 2. 打印优化
- 使用 `@page` 和 `@media print` CSS
- 隐藏不必要的打印元素
- 优化字体和间距

### 3. 用户体验
- 自动打印，减少操作步骤
- 打印失败不影响销售
- 提供手动打印选项

### 4. 数据安全
- 只获取必要的用户信息
- 不在小票上显示敏感数据
- 打印窗口独立，不影响主窗口

## 未来改进

### 可能的增强功能
1. **二维码**: 添加订单二维码，方便查询
2. **条形码**: 显示订单条形码
3. **促销信息**: 在页脚添加促销信息
4. **多语言**: 支持多语言小票
5. **模板定制**: 允许商户自定义小票模板
6. **电子小票**: 支持发送电子小票到邮箱
7. **打印预览**: 在打印前显示预览
8. **打印历史**: 保存打印记录，支持重新打印

## 相关文件

- `StockControl-main/public/merchant.html` - 前端实现
- `StockControl-main/app.js` - 后端API
- `StockControl-main/models/UserNew.js` - 用户模型

## 版本历史

- **v1.0.0** (2026-02-06) - 初始版本
  - 基本打印功能
  - 80mm格式支持
  - 自动打印
  - 公司信息集成
