# 快速测试：确认收货功能

## 测试地址
- 商户端: http://localhost:3000/merchant.html
- 仓管员端: http://localhost:3000/prototype-working.html

## 测试账号
- 商户: `ham` / `123456`
- 仓管员: `warehouse_manager` / `123456`

## 测试流程

### 步骤 1: 商户下单
```
1. 登录商户账号 (ham)
2. 点击"仓库订货"标签
3. 选择一个分类（如 Phones）
4. 添加产品到购物车
5. 点击"提交订单"
6. 选择配送方式
7. 确认提交
8. 记录订单号
```

### 步骤 2: 仓库确认订单
```
1. 登录仓管员账号 (warehouse_manager)
2. 进入"仓库订单管理"
3. 找到刚才的订单（待确认状态）
4. 点击"确认订单"
5. 验证: 订单状态变为"已确认"
```

### 步骤 3: 仓库发货
```
1. 在仓管员界面
2. 找到已确认的订单
3. 点击"发货"按钮
4. 选择产品序列号（设备）或输入数量（配件）
5. 点击"确认发货"
6. 验证: 订单状态变为"已发货"
7. ⚠️ 重要: 此时商户库存中还没有这些产品
```

### 步骤 4: 商户确认收货 ✅
```
1. 切换到商户账号 (ham)
2. 进入"仓库订货" → "我的订单"
3. 找到"已发货"状态的订单
4. 方式 A: 直接点击"✅ 确认收货"按钮
   或
   方式 B: 点击"查看详情"，在详情页点击"✅ 确认收货"
5. 确认对话框
6. 验证结果:
   ✅ 订单状态变为"已完成"
   ✅ 产品出现在"我的库存"中
   ✅ 序列号/IMEI 信息正确
   ✅ 价格信息正确
```

## 验证点

### 1. 订单状态流转
```
pending → confirmed → shipped → completed ✅
```

### 2. 库存转移时机
```
下单时: 仓库库存扣减（预留）
发货时: 不转移库存 ✅
确认收货时: 创建商户库存 ✅
```

### 3. 权限验证
```
尝试用其他商户账号确认收货 → 应该失败 ✅
只有订单的商户可以确认收货 ✅
```

### 4. UI 显示
```
已发货订单显示:
- 黄色警告框 ✅
- "⚠️ 请确认收货"提示 ✅
- "✅ 确认收货"按钮（绿色）✅
```

## 预期结果

### 订单列表
```
┌─────────────────────────────────────────────────────────┐
│ 订单号: WO-20260202-XXXX                                │
│ 状态: 已发货 (紫色标签)                                 │
│ 产品数量: 1 种                                          │
│ 总数量: 2 件                                            │
│ 配送方式: 🚚 物流配送                                   │
│ 总计: €250.00                                           │
│                                                         │
│ [查看详情] [✅ 确认收货]                                │
└─────────────────────────────────────────────────────────┘
```

### 订单详情（已发货状态）
```
┌─────────────────────────────────────────────────────────┐
│ 📋 订单详情                                             │
├─────────────────────────────────────────────────────────┤
│ 订单号: WO-20260202-XXXX                                │
│ 状态: 已发货                                            │
│ 下单时间: 2026-02-02 22:30:00                          │
│ 配送方式: 🚚 物流配送                                   │
├─────────────────────────────────────────────────────────┤
│ 订单明细:                                               │
│ - galaxy A53 × 2 @ €125.00 = €250.00                   │
├─────────────────────────────────────────────────────────┤
│ ⚠️ 请确认收货                                           │
│ 订单已发货，请确认收到货物后点击下方按钮。              │
│ 确认收货后，产品将自动入库到您的库存中。                │
│                                                         │
│ [✅ 确认收货]                                           │
└─────────────────────────────────────────────────────────┘
```

### 确认收货后
```
✅ 收货确认成功！产品已入库到您的库存中。

订单状态: 已完成 (绿色标签)
我的库存: 新增 2 件 galaxy A53
```

## 常见问题

### Q: 旧订单没有 shipmentDetails 怎么办？
A: 旧订单需要重新发货，或者手动添加 shipmentDetails 数据。

### Q: 确认收货后可以撤销吗？
A: 不可以。确认收货后订单状态变为 completed，库存已转移。

### Q: 商户可以拒收吗？
A: 当前版本不支持拒收功能。如需拒收，请联系仓库管理员取消订单。

### Q: 发货后多久必须确认收货？
A: 当前没有时间限制。建议收到货物后立即确认。

## 测试数据清理

如需重置测试数据：
```javascript
// 删除测试订单
await WarehouseOrder.deleteMany({ merchantId: 'ham' });

// 删除测试商户库存
await MerchantInventory.deleteMany({ merchantId: 'ham', source: 'warehouse' });

// 恢复仓库库存
// 需要手动恢复产品的 quantity 和 serialNumbers 状态
```

## 成功标准
- ✅ 发货时不转移库存
- ✅ 确认收货时才转移库存
- ✅ 只有订单商户可以确认收货
- ✅ UI 提示清晰明确
- ✅ 操作流程顺畅
