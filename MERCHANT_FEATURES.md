# 批发商中心功能说明

## 概述

批发商中心是一个完整的独立库存和销售管理系统，允许批发商从仓库订货、管理自己的库存、进行销售业务。

## 核心功能

### 1. 批发商独立库存系统

**功能描述**:
- 每个批发商拥有独立的库存系统
- 库存与仓库库存完全分离
- 支持库存状态管理（正常、库存低、缺货）

**数据模型**: `MerchantInventory`
- merchantId: 批发商ID
- productName: 产品名称
- category: 产品类别（全新设备、二手设备、配件）
- quantity: 库存数量
- costPrice: 采购成本价
- retailPrice: 零售价
- taxClassification: 税务分类
- status: 库存状态

**API端点**:
```
GET /api/merchant/inventory?merchantId=xxx
```

**前端功能**:
- 查看库存列表
- 显示产品详情（名称、类别、数量、价格）
- 库存状态标识
- 直接销售按钮

---

### 2. 仓库订货功能

**功能描述**:
- 批发商可以浏览仓库中可用的产品
- 选择产品和数量进行订货
- 订单确认后自动转移库存

**数据模型**: `MerchantOrder`
- orderNumber: 订单号（自动生成）
- merchantId: 批发商ID
- items: 订单项目列表
- totalAmount: 订单总额
- status: 订单状态（待处理、已确认、已发货等）

**API端点**:
```
GET /api/merchant/warehouse-products
POST /api/merchant/orders
POST /api/merchant/orders/:orderId/confirm
GET /api/merchant/orders
```

**订货流程**:
1. 批发商浏览仓库可用产品
2. 选择产品并输入订货数量
3. 点击"订货"按钮创建订单
4. 系统自动确认订单
5. 仓库库存减少，批发商库存增加
6. 订单记录保存

**前端功能**:
- 显示仓库可订购产品列表
- 产品分组显示（按类型和类别）
- 实时显示可用数量
- 订货数量输入
- 一键订货

---

### 3. 销售功能

**功能描述**:
- 从批发商自己的库存中销售产品
- 支持现金和刷卡支付
- 自动计算税额
- 实时更新库存

**API端点**:
```
POST /api/merchant/sell
```

**销售流程**:
1. 在"我的库存"页面点击"销售"按钮
2. 输入销售数量
3. 选择支付方式（现金/刷卡）
4. 确认销售信息
5. 系统自动：
   - 减少库存数量
   - 计算税额
   - 记录销售数据
   - 更新库存状态

**税额计算**:
- **VAT 23%**: 销项税 - 进项税
- **Service VAT 13.5%**: 金额 × 13.5/113.5
- **Margin VAT**: (销售额 - 成本) × 23/123

**前端功能**:
- 库存列表中的销售按钮
- 销售数量输入
- 支付方式选择
- 销售确认对话框
- 实时库存更新

---

### 4. 销售记录查询

**功能描述**:
- 查看历史销售记录
- 显示销售详情和税额
- 支持按日期筛选

**API端点**:
```
GET /api/merchant/sales?merchantId=xxx
```

**显示信息**:
- 销售日期
- 产品名称和类别
- 销售数量
- 销售额和成本
- 税额
- 支付方式

---

### 5. 税务报表

**功能描述**:
- 生成指定日期范围的税务报表
- 按税务分类统计
- 显示日销售明细
- 计算应缴税额

**API端点**:
```
GET /api/merchant/tax-report?merchantId=xxx&startDate=xxx&endDate=xxx
```

**报表内容**:
- 日销售汇总（销售额、现金收入、刷卡收入）
- 税务计算明细（按VAT 23%、Service VAT、Margin VAT分类）
- 总应缴税额
- 计算说明

---

## 权限控制

### 角色定义

**批发商户 (merchant)**:
- 测试账号: `merchant_vip` / `merchant123`
- 只能访问: `/merchant.html`
- 不能访问: 仓库管理页面、管理员页面

**仓库管理员 (warehouse_staff)**:
- 测试账号: `warehouse1` / `warehouse123`
- 只能访问: 仓库管理相关页面
- 不能访问: 批发商页面

**管理员 (admin)**:
- 测试账号: `admin` / `admin123`
- 可以访问: 所有页面

### 权限检查机制

1. **登录时设置角色**
   ```javascript
   localStorage.setItem('userRole', user.role);
   ```

2. **页面加载时检查权限**
   ```javascript
   // auth-guard.js 自动执行
   window.addEventListener('DOMContentLoaded', checkPagePermission);
   ```

3. **无权限自动跳转**
   - 批发商尝试访问仓库页面 → 跳转到 merchant.html
   - 仓库管理员尝试访问批发商页面 → 跳转到 prototype.html

---

## 数据流程

### 订货流程

```
仓库库存 (Product3C)
    ↓ 批发商订货
批发商订单 (MerchantOrder)
    ↓ 订单确认
批发商库存 (MerchantInventory)
    ↓ 批发商销售
销售记录 (测试数据)
```

### 库存转移

```
1. 批发商创建订单
   - 选择仓库产品
   - 指定订货数量
   
2. 系统验证
   - 检查产品是否存在
   - 检查库存是否充足
   - 验证订货数量
   
3. 创建订单记录
   - 生成订单号
   - 保存订单信息
   
4. 确认订单
   - 减少仓库库存
   - 增加批发商库存
   - 更新订单状态
```

---

## 测试指南

### 1. 测试批发商库存

1. 使用 `merchant_vip` 登录
2. 进入"我的库存"页面
3. 初始状态应该是空的
4. 提示前往"仓库订货"采购产品

### 2. 测试仓库订货

1. 切换到"仓库订货"页面
2. 查看仓库可用产品列表
3. 选择一个产品，输入订货数量
4. 点击"订货"按钮
5. 确认订单信息
6. 订货成功后，返回"我的库存"查看

### 3. 测试销售功能

1. 在"我的库存"页面
2. 找到有库存的产品
3. 点击"销售"按钮
4. 输入销售数量
5. 选择支付方式（确定=刷卡，取消=现金）
6. 确认销售信息
7. 销售成功后，库存数量自动减少

### 4. 测试权限控制

1. 使用批发商账号登录
2. 尝试访问 `http://localhost:8080/inventory.html`
3. 应该被阻止并跳转回 merchant.html
4. 使用仓库管理员账号登录
5. 尝试访问 `http://localhost:8080/merchant.html`
6. 应该被阻止并跳转回 prototype.html

---

## 技术实现

### 后端技术栈
- Node.js + Express
- MongoDB + Mongoose
- RESTful API

### 前端技术栈
- 原生 JavaScript
- HTML5 + CSS3
- Fetch API

### 数据模型
- MerchantInventory - 批发商库存
- MerchantOrder - 批发商订单
- Product3C - 仓库产品（已有）

### 权限控制
- auth-guard.js - 权限控制核心
- localStorage - 角色存储
- 页面加载时自动检查

---

## 已知限制

1. **测试数据**
   - 当前使用固定的 merchantId: 'merchant_001'
   - 实际应该从登录session获取

2. **订单管理**
   - 订单创建后自动确认
   - 未实现订单取消功能
   - 未实现订单历史查询

3. **库存管理**
   - 未实现库存调整功能
   - 未实现库存盘点功能
   - 未实现库存预警通知

4. **销售记录**
   - 销售记录未持久化到数据库
   - 仅用于税务报表计算
   - 未实现销售退货功能

---

## 后续优化建议

### 1. 功能增强
- [ ] 实现订单管理（查询、取消、修改）
- [ ] 添加库存调整功能
- [ ] 实现库存预警通知
- [ ] 添加销售退货功能
- [ ] 实现批量订货功能

### 2. 用户体验
- [ ] 添加加载动画
- [ ] 优化错误提示
- [ ] 添加操作确认对话框
- [ ] 实现数据分页
- [ ] 添加搜索和筛选功能

### 3. 数据管理
- [ ] 销售记录持久化
- [ ] 订单状态流转管理
- [ ] 库存变动日志
- [ ] 数据导出功能

### 4. 安全性
- [ ] 后端API权限验证
- [ ] 用户token验证
- [ ] 操作日志记录
- [ ] 数据加密传输

---

## 更新日志

### 2026-01-29
- ✅ 创建批发商库存数据模型
- ✅ 创建批发商订单数据模型
- ✅ 实现仓库订货API
- ✅ 实现批发商销售API
- ✅ 实现前端库存管理界面
- ✅ 实现前端订货功能
- ✅ 实现前端销售功能
- ✅ 实现权限控制系统
- ✅ 提交到GitHub

---

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues
- 项目文档
- 开发团队

---

**注意**: 本系统为原型演示版本，部分功能仍在开发中。请在测试环境中使用。
