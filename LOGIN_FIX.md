# ğŸ”§ ç™»å½•åŠŸèƒ½ä¿®å¤å®Œæˆ

## ğŸ“‹ é—®é¢˜æè¿°

**é—®é¢˜**: æ–°æ³¨å†Œçš„ç”¨æˆ·æ— æ³•é€šè¿‡ç™»å½•é¡µé¢ç™»å½•

**åŸå› **: 
1. ç™»å½•é¡µé¢ä½¿ç”¨ç¡¬ç¼–ç çš„ç”¨æˆ·åˆ—è¡¨è¿›è¡ŒéªŒè¯ï¼Œè€Œä¸æ˜¯è°ƒç”¨åç«¯API
2. åç«¯æ²¡æœ‰ç™»å½•è®¤è¯API
3. è§’è‰²ç³»ç»Ÿä¸ç»Ÿä¸€ï¼ˆauth-guard.jsä¸UserNewæ¨¡å‹çš„è§’è‰²å®šä¹‰ä¸ä¸€è‡´ï¼‰

---

## âœ… ä¿®å¤å†…å®¹

### 1. æ·»åŠ åç«¯ç™»å½•API

**æ–‡ä»¶**: `app.js`

**æ–°å¢APIç«¯ç‚¹**: `POST /api/auth/login`

**åŠŸèƒ½**:
- âœ… æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
- âœ… å¯†ç éªŒè¯ï¼ˆä½¿ç”¨bcryptåŠ å¯†æ¯”å¯¹ï¼‰
- âœ… æ£€æŸ¥è´¦æˆ·æ˜¯å¦æ¿€æ´»
- âœ… æ›´æ–°æœ€åç™»å½•æ—¶é—´å’Œç™»å½•æ¬¡æ•°
- âœ… è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«æ•æ„Ÿæ•°æ®ï¼‰

**APIè¯·æ±‚æ ¼å¼**:
```json
POST /api/auth/login
Content-Type: application/json

{
  "username": "test_user",  // å¯ä»¥æ˜¯ç”¨æˆ·åæˆ–é‚®ç®±
  "password": "123456"
}
```

**APIå“åº”æ ¼å¼**:
```json
// æˆåŠŸ
{
  "success": true,
  "data": {
    "user": {
      "_id": "...",
      "username": "test_user",
      "email": "test_user@example.com",
      "role": "retail_user",
      "profile": {...},
      "retailInfo": {...},
      "isActive": true,
      "lastLoginAt": "2026-02-03T...",
      "loginCount": 5
    },
    "message": "ç™»å½•æˆåŠŸ"
  }
}

// å¤±è´¥
{
  "success": false,
  "error": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
}
```

**é”™è¯¯å¤„ç†**:
- âŒ ç”¨æˆ·åå’Œå¯†ç ä¸ºç©º â†’ 400 Bad Request
- âŒ ç”¨æˆ·ä¸å­˜åœ¨ â†’ 401 Unauthorized
- âŒ å¯†ç é”™è¯¯ â†’ 401 Unauthorized
- âŒ è´¦æˆ·å·²åœç”¨ â†’ 403 Forbidden
- âŒ æœåŠ¡å™¨é”™è¯¯ â†’ 500 Internal Server Error

---

### 2. æ›´æ–°å‰ç«¯ç™»å½•é¡µé¢

**æ–‡ä»¶**: `public/login.html`

**ä¿®æ”¹å†…å®¹**:
- âœ… ç§»é™¤ç¡¬ç¼–ç çš„ç”¨æˆ·åˆ—è¡¨éªŒè¯
- âœ… è°ƒç”¨åç«¯ `/api/auth/login` API
- âœ… ä¿å­˜å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
- âœ… æ ¹æ®ç”¨æˆ·è§’è‰²è·³è½¬åˆ°å¯¹åº”é¡µé¢

**ä¿å­˜åˆ°localStorageçš„æ•°æ®**:
```javascript
localStorage.setItem('username', user.username);
localStorage.setItem('userRole', user.role);
localStorage.setItem('userId', user._id);
localStorage.setItem('userEmail', user.email);
localStorage.setItem('loginTime', new Date().toISOString());
localStorage.setItem('userInfo', JSON.stringify(user));
```

---

### 3. æ›´æ–°æƒé™æ§åˆ¶ç³»ç»Ÿ

**æ–‡ä»¶**: `public/auth-guard.js`

**ä¿®æ”¹å†…å®¹**:

#### è§’è‰²å®šä¹‰æ›´æ–°
```javascript
// æ—§çš„è§’è‰²å®šä¹‰
const USER_ROLES = {
  WAREHOUSE_STAFF: 'warehouse_staff',
  MERCHANT: 'merchant',
  ADMIN: 'admin'
};

// æ–°çš„è§’è‰²å®šä¹‰ï¼ˆå…¼å®¹æ–°æ—§ç³»ç»Ÿï¼‰
const USER_ROLES = {
  ADMIN: 'admin',                        // ç®¡ç†å‘˜
  WAREHOUSE_MANAGER: 'warehouse_manager', // ä»“åº“ç®¡ç†å‘˜ï¼ˆæ–°ï¼‰
  WAREHOUSE_STAFF: 'warehouse_staff',    // ä»“åº“ç®¡ç†å‘˜ï¼ˆæ—§ï¼‰
  RETAIL_USER: 'retail_user',            // æ™®é€šç”¨æˆ·ï¼ˆæ–°ï¼‰
  MERCHANT: 'merchant'                   // æ‰¹å‘å•†æˆ·ï¼ˆæ—§ï¼‰
};
```

#### é¡µé¢æƒé™æ˜ å°„æ›´æ–°
- âœ… æ·»åŠ  `warehouse_manager` è§’è‰²æƒé™
- âœ… æ·»åŠ  `retail_user` è§’è‰²æƒé™
- âœ… æ·»åŠ  `/prototype-working.html` é¡µé¢æƒé™

#### è§’è‰²ä¸»é¡µæ˜ å°„æ›´æ–°
```javascript
const ROLE_HOME_PAGES = {
  'admin': '/admin.html',
  'warehouse_manager': '/prototype-working.html',
  'warehouse_staff': '/prototype-working.html',
  'retail_user': '/merchant.html',
  'merchant': '/merchant.html'
};
```

#### ç™»å‡ºåŠŸèƒ½æ›´æ–°
- âœ… æ¸…é™¤æ›´å¤šçš„ç”¨æˆ·ä¿¡æ¯ï¼ˆuserId, userEmail, userInfoï¼‰

---

## ğŸ¯ è§’è‰²ç³»ç»Ÿè¯´æ˜

### è§’è‰²ç±»å‹

| è§’è‰²ä»£ç  | è§’è‰²åç§° | ä¸»é¡µ | æƒé™ |
|---------|---------|------|------|
| `admin` | ç®¡ç†å‘˜ | `/admin.html` | æ‰€æœ‰æƒé™ |
| `warehouse_manager` | ä»“åº“ç®¡ç†å‘˜ | `/prototype-working.html` | äº§å“ã€åº“å­˜ã€é‡‡è´­ç®¡ç† |
| `retail_user` | æ™®é€šç”¨æˆ· | `/merchant.html` | é”€å”®ã€æŸ¥çœ‹åº“å­˜ |

### æ—§è§’è‰²å…¼å®¹

| æ—§è§’è‰²ä»£ç  | æ–°è§’è‰²ä»£ç  | è¯´æ˜ |
|-----------|-----------|------|
| `warehouse_staff` | `warehouse_manager` | ä»“åº“ç®¡ç†å‘˜ |
| `merchant` | `retail_user` | æ™®é€šç”¨æˆ·/å•†æˆ· |

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1: æ–°æ³¨å†Œç”¨æˆ·ç™»å½•

#### æ­¥éª¤
```
1. è®¿é—® http://localhost:3000/admin.html
2. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•
3. ç‚¹å‡» "ğŸ‘¥ ç”¨æˆ·ç®¡ç†"
4. ç‚¹å‡» "â• æ·»åŠ ç”¨æˆ·"
5. åˆ›å»ºæ–°ç”¨æˆ·:
   - ç”¨æˆ·å: test_login
   - é‚®ç®±: test_login@example.com
   - å¯†ç : 123456
   - è§’è‰²: æ™®é€šç”¨æˆ·
6. ä¿å­˜æˆåŠŸåï¼Œé€€å‡ºç™»å½•
7. è®¿é—® http://localhost:3000/login.html
8. ä½¿ç”¨æ–°ç”¨æˆ·ç™»å½•:
   - ç”¨æˆ·å: test_login
   - å¯†ç : 123456
9. ç‚¹å‡»"ç™»å½•"
```

#### é¢„æœŸç»“æœ
- âœ… ç™»å½•æˆåŠŸ
- âœ… è‡ªåŠ¨è·³è½¬åˆ° `/merchant.html`ï¼ˆæ™®é€šç”¨æˆ·ä¸»é¡µï¼‰
- âœ… é¡µé¢æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯

---

### æµ‹è¯•2: ä½¿ç”¨é‚®ç®±ç™»å½•

#### æ­¥éª¤
```
1. è®¿é—® http://localhost:3000/login.html
2. ä½¿ç”¨é‚®ç®±ç™»å½•:
   - ç”¨æˆ·å: test_login@example.com
   - å¯†ç : 123456
3. ç‚¹å‡»"ç™»å½•"
```

#### é¢„æœŸç»“æœ
- âœ… ç™»å½•æˆåŠŸ
- âœ… è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”ä¸»é¡µ

---

### æµ‹è¯•3: é”™è¯¯å¯†ç 

#### æ­¥éª¤
```
1. è®¿é—® http://localhost:3000/login.html
2. è¾“å…¥é”™è¯¯å¯†ç :
   - ç”¨æˆ·å: test_login
   - å¯†ç : wrong_password
3. ç‚¹å‡»"ç™»å½•"
```

#### é¢„æœŸç»“æœ
- âŒ ç™»å½•å¤±è´¥
- âŒ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼š"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
- âŒ ä¸è·³è½¬é¡µé¢

---

### æµ‹è¯•4: åœç”¨ç”¨æˆ·ç™»å½•

#### æ­¥éª¤
```
1. ç®¡ç†å‘˜åœç”¨ç”¨æˆ· test_login
2. è®¿é—® http://localhost:3000/login.html
3. ä½¿ç”¨åœç”¨çš„ç”¨æˆ·ç™»å½•:
   - ç”¨æˆ·å: test_login
   - å¯†ç : 123456
4. ç‚¹å‡»"ç™»å½•"
```

#### é¢„æœŸç»“æœ
- âŒ ç™»å½•å¤±è´¥
- âŒ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼š"è´¦æˆ·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
- âŒ ä¸è·³è½¬é¡µé¢

---

### æµ‹è¯•5: ä¸åŒè§’è‰²ç™»å½•è·³è½¬

#### æµ‹è¯•ç®¡ç†å‘˜
```
ç”¨æˆ·å: admin (æˆ–ç®¡ç†å‘˜ç”¨æˆ·)
å¯†ç : (ç®¡ç†å‘˜å¯†ç )
é¢„æœŸè·³è½¬: /admin.html
```

#### æµ‹è¯•ä»“åº“ç®¡ç†å‘˜
```
ç”¨æˆ·å: warehouse_test
å¯†ç : (ä»“ç®¡å‘˜å¯†ç )
é¢„æœŸè·³è½¬: /prototype-working.html
```

#### æµ‹è¯•æ™®é€šç”¨æˆ·
```
ç”¨æˆ·å: retail_test
å¯†ç : (æ™®é€šç”¨æˆ·å¯†ç )
é¢„æœŸè·³è½¬: /merchant.html
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ç™»å½•APIè¯·æ±‚

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰:
```
1. åˆ‡æ¢åˆ° "Network" æ ‡ç­¾
2. ç­›é€‰ "Fetch/XHR"
3. å°è¯•ç™»å½•
4. æŸ¥çœ‹ "/api/auth/login" è¯·æ±‚
5. æ£€æŸ¥è¯·æ±‚å’Œå“åº”æ•°æ®
```

### 2. æŸ¥çœ‹localStorage

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12 â†’ Consoleï¼‰è¾“å…¥:
```javascript
// æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨çš„æ•°æ®
console.log('username:', localStorage.getItem('username'));
console.log('userRole:', localStorage.getItem('userRole'));
console.log('userId:', localStorage.getItem('userId'));
console.log('userEmail:', localStorage.getItem('userEmail'));
console.log('userInfo:', JSON.parse(localStorage.getItem('userInfo')));
```

### 3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

åœ¨è¿è¡ŒæœåŠ¡å™¨çš„ç»ˆç«¯ä¸­æŸ¥çœ‹:
```
- ç™»å½•è¯·æ±‚æ—¥å¿—
- æ•°æ®åº“æŸ¥è¯¢æ—¥å¿—
- é”™è¯¯ä¿¡æ¯
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¯†ç å®‰å…¨
- âœ… å¯†ç ä½¿ç”¨bcryptåŠ å¯†å­˜å‚¨
- âœ… ç™»å½•æ—¶ä½¿ç”¨comparePasswordæ–¹æ³•éªŒè¯
- âœ… å¯†ç ä¸ä¼šåœ¨APIå“åº”ä¸­è¿”å›

### 2. è´¦æˆ·çŠ¶æ€
- âœ… åªæœ‰æ¿€æ´»çš„è´¦æˆ·ï¼ˆisActive=trueï¼‰æ‰èƒ½ç™»å½•
- âœ… åœç”¨çš„è´¦æˆ·ä¼šæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯

### 3. ç™»å½•ä¿¡æ¯
- âœ… ç™»å½•æˆåŠŸåæ›´æ–°lastLoginAtå’ŒloginCount
- âœ… å¯ä»¥ç”¨äºç»Ÿè®¡ç”¨æˆ·æ´»è·ƒåº¦

### 4. è§’è‰²å…¼å®¹æ€§
- âœ… æ”¯æŒæ–°æ—§è§’è‰²ç³»ç»Ÿ
- âœ… æ—§çš„æµ‹è¯•è´¦å·ä»ç„¶å¯ä»¥ä½¿ç”¨

---

## ğŸ“Š APIæµ‹è¯•ç¤ºä¾‹

### ä½¿ç”¨curlæµ‹è¯•ç™»å½•API

```bash
# æˆåŠŸç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test_login","password":"123456"}'

# ä½¿ç”¨é‚®ç®±ç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test_login@example.com","password":"123456"}'

# é”™è¯¯å¯†ç 
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test_login","password":"wrong"}'
```

---

## âœ… ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `app.js` - æ·»åŠ ç™»å½•API
2. âœ… `public/login.html` - æ›´æ–°ç™»å½•é€»è¾‘
3. âœ… `public/auth-guard.js` - æ›´æ–°è§’è‰²ç³»ç»Ÿ

### æ–°å¢åŠŸèƒ½
1. âœ… åç«¯ç™»å½•è®¤è¯API
2. âœ… æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
3. âœ… å¯†ç åŠ å¯†éªŒè¯
4. âœ… è´¦æˆ·çŠ¶æ€æ£€æŸ¥
5. âœ… ç™»å½•ä¿¡æ¯è®°å½•
6. âœ… è§’è‰²ç³»ç»Ÿç»Ÿä¸€

### å…¼å®¹æ€§
1. âœ… æ”¯æŒæ–°æ³¨å†Œçš„ç”¨æˆ·ç™»å½•
2. âœ… å…¼å®¹æ—§çš„æµ‹è¯•è´¦å·
3. âœ… å…¼å®¹æ–°æ—§è§’è‰²ç³»ç»Ÿ

---

## ğŸ¯ ä¸‹ä¸€æ­¥

ç°åœ¨å¯ä»¥æµ‹è¯•ç™»å½•åŠŸèƒ½äº†ï¼š

1. **åˆ›å»ºæ–°ç”¨æˆ·** - åœ¨ç”¨æˆ·ç®¡ç†é¡µé¢åˆ›å»ºæ–°ç”¨æˆ·
2. **æµ‹è¯•ç™»å½•** - ä½¿ç”¨æ–°ç”¨æˆ·ç™»å½•
3. **éªŒè¯è·³è½¬** - ç¡®è®¤è·³è½¬åˆ°æ­£ç¡®çš„ä¸»é¡µ
4. **æµ‹è¯•æƒé™** - ç¡®è®¤ç”¨æˆ·åªèƒ½è®¿é—®æœ‰æƒé™çš„é¡µé¢

---

**ä¿®å¤æ—¶é—´**: 2026-02-03
**ç‰ˆæœ¬**: 1.0
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆï¼Œå¯ä»¥æµ‹è¯•

**æœåŠ¡å™¨**: éœ€è¦é‡å¯ä»¥åŠ è½½æ–°çš„API
**æµ‹è¯•åœ°å€**: http://localhost:3000/login.html
