# 供货商/客户管理功能快速测试指南

## 测试前准备

### 1. 启动服务器
```bash
cd StockControl-main
node app-new.js
```

### 2. 确认数据库连接
- 确保 MongoDB Atlas 已连接
- 查看控制台输出：`✅ MongoDB 连接成功`

### 3. 打开管理界面
- 浏览器访问：`http://localhost:3000/prototype-working.html`
- 或直接访问：`http://localhost:3000/`

## 功能测试步骤

### 测试 1: 供货商管理

#### 1.1 查看供货商列表
1. 点击顶部"👥 供货商/客户管理"标签页
2. 默认显示"📦 供货商管理"子标签
3. 应该看到供货商列表（如果数据库中有供货商数据）

**预期结果：**
- 显示供货商表格，包含：代码、名称、联系人、电话、邮箱、付款条件
- 每行有三个按钮：📋 查看发票、✏️ 编辑、🗑️ 删除

#### 1.2 搜索供货商
1. 在搜索框输入供货商名称或联系人
2. 点击"🔍 搜索"按钮

**预期结果：**
- 列表更新，只显示匹配的供货商
- 如果没有匹配结果，显示"暂无供货商"

#### 1.3 查看供货商发票
1. 点击任意供货商的"📋 查看发票"按钮
2. 弹出模态框显示该供货商的所有采购发票

**预期结果：**
- 模态框标题：`📋 [供货商名称] - 采购发票记录`
- 显示发票表格：发票编号、日期、小计、税额、总金额、付款状态、状态
- 如果没有发票，显示"暂无采购发票记录"

#### 1.4 删除供货商
1. 点击任意供货商的"🗑️ 删除"按钮
2. 确认删除对话框

**预期结果：**
- 弹出确认对话框：`确定要删除供货商"[名称]"吗？`
- 点击确定后，显示"✅ 供货商删除成功"
- 列表自动刷新，该供货商不再显示

### 测试 2: 客户管理

#### 2.1 切换到客户管理
1. 点击"🛒 客户管理"子标签按钮

**预期结果：**
- 子标签按钮高亮显示
- 显示客户列表（如果数据库中有客户数据）
- 如果没有客户，显示"暂无客户"提示

#### 2.2 查看客户列表
**预期结果：**
- 显示客户表格，包含：代码、名称、类型、联系人、电话、邮箱
- 类型显示为"企业"或"个人"
- 每行有三个按钮：📋 查看发票、✏️ 编辑、🗑️ 删除

#### 2.3 搜索客户
1. 在搜索框输入客户名称或联系人
2. 点击"🔍 搜索"按钮

**预期结果：**
- 列表更新，只显示匹配的客户

#### 2.4 查看客户发票
1. 点击任意客户的"📋 查看发票"按钮

**预期结果：**
- 模态框标题：`📋 [客户名称] - 销售发票记录`
- 显示销售发票表格
- 注意：如果系统中还没有销售发票数据，会显示"暂无销售发票记录"

#### 2.5 删除客户
1. 点击任意客户的"🗑️ 删除"按钮
2. 确认删除

**预期结果：**
- 显示"✅ 客户删除成功"
- 列表自动刷新

### 测试 3: 产品追溯

#### 3.1 切换到产品追溯
1. 点击"🔍 产品追溯"子标签按钮

**预期结果：**
- 显示蓝色提示框："🔍 产品追溯查询"
- 显示搜索输入框和"🔍 查询追溯"按钮
- 显示空状态提示："请输入查询条件"

#### 3.2 按产品名称搜索
1. 在搜索框输入产品名称（例如："iPhone"）
2. 点击"🔍 查询追溯"按钮

**预期结果：**
- 显示"正在查询产品追溯信息..."加载提示
- 显示找到的产品列表（卡片形式）
  - 产品名称、SKU、条码、颜色
  - 当前库存数量
- 显示历史记录时间线
  - 采购记录（绿色标记）
  - 销售记录（橙色标记）
  - 每条记录显示：日期、供货商/客户、发票编号、数量、价格、税率

#### 3.3 按条码搜索
1. 输入产品条码
2. 点击查询

**预期结果：**
- 显示匹配的产品和历史记录

#### 3.4 按序列号搜索
1. 输入 IMEI 或 SN 号码
2. 点击查询

**预期结果：**
- 显示包含该序列号的产品
- 历史记录中显示该序列号的流转记录

#### 3.5 无结果搜索
1. 输入不存在的产品信息
2. 点击查询

**预期结果：**
- 显示"未找到匹配的产品"
- 提示"请尝试其他搜索条件"

## API 测试（可选）

### 使用 curl 或 Postman 测试

#### 1. 获取供货商列表
```bash
curl http://localhost:3000/api/admin/suppliers
```

#### 2. 搜索供货商
```bash
curl "http://localhost:3000/api/admin/suppliers?search=test"
```

#### 3. 获取供货商发票
```bash
curl http://localhost:3000/api/admin/suppliers/[supplierId]/invoices
```

#### 4. 获取客户列表
```bash
curl http://localhost:3000/api/admin/customers
```

#### 5. 获取客户发票
```bash
curl http://localhost:3000/api/admin/customers/[customerId]/invoices
```

#### 6. 产品追溯查询
```bash
curl "http://localhost:3000/api/admin/products/tracking?search=iPhone"
```

## 常见问题排查

### 问题 1: 页面显示"数据库未连接"
**解决方案：**
- 检查 `.env` 文件中的 `MONGODB_URI` 配置
- 确认 MongoDB Atlas 网络访问权限
- 重启服务器

### 问题 2: 供货商/客户列表为空
**原因：**
- 数据库中可能没有供货商/客户数据

**解决方案：**
- 运行种子数据脚本：`node scripts/seed-data.js`
- 或手动添加供货商/客户（功能开发中）

### 问题 3: 查看发票时显示"暂无发票记录"
**原因：**
- 该供货商/客户确实没有关联的发票
- 或者发票数据中的 supplier/customer 字段没有正确关联

**解决方案：**
- 检查数据库中的 PurchaseInvoice 和 SalesInvoice 集合
- 确认 supplier/customer 字段是否正确引用

### 问题 4: 产品追溯无结果
**原因：**
- 产品可能没有关联到任何发票
- 搜索条件不匹配

**解决方案：**
- 尝试不同的搜索关键词
- 检查产品是否已通过采购入库流程创建

### 问题 5: 点击编辑或添加按钮显示"功能开发中"
**原因：**
- 添加/编辑模态框尚未实现

**解决方案：**
- 这是正常的，该功能在待开发列表中
- 当前可以通过 API 或数据库直接操作

## 浏览器控制台调试

### 查看调试日志
1. 按 F12 打开浏览器开发者工具
2. 切换到 Console 标签
3. 所有操作都会输出调试日志，格式：`[时间] 消息`

### 常见日志示例
```
[14:30:15] 切换到标签页: partners
[14:30:15] 切换到子标签页: suppliers
[14:30:15] 开始加载供货商列表
[14:30:16] 供货商API响应: 5 个供货商
```

### 查看网络请求
1. 切换到 Network 标签
2. 执行操作（如搜索、查看发票）
3. 查看 API 请求和响应
4. 检查状态码（200 = 成功，500 = 服务器错误，503 = 数据库未连接）

## 测试数据建议

### 创建测试供货商
如果需要手动创建测试数据，可以使用 MongoDB Compass 或命令行：

```javascript
// 在 MongoDB 中插入测试供货商
db.suppliernews.insertOne({
  name: "测试供货商",
  code: "TEST001",
  contact: {
    person: "张三",
    phone: "123-456-7890",
    email: "test@example.com"
  },
  financial: {
    paymentTerms: "net30"
  },
  isActive: true,
  createdBy: ObjectId("..."), // 使用实际的用户ID
  createdAt: new Date(),
  updatedAt: new Date()
});
```

### 创建测试客户
```javascript
db.customers.insertOne({
  name: "测试客户",
  code: "CUST001",
  type: "business",
  contact: {
    person: "李四",
    phone: "098-765-4321",
    email: "customer@example.com"
  },
  isActive: true,
  createdBy: ObjectId("..."),
  createdAt: new Date(),
  updatedAt: new Date()
});
```

## 成功标准

测试通过的标准：
- ✅ 能够查看供货商列表
- ✅ 能够搜索供货商
- ✅ 能够查看供货商的采购发票
- ✅ 能够删除供货商
- ✅ 能够查看客户列表
- ✅ 能够搜索客户
- ✅ 能够查看客户的销售发票
- ✅ 能够删除客户
- ✅ 能够按产品名称/条码/序列号进行追溯查询
- ✅ 产品追溯显示完整的历史记录时间线
- ✅ 所有操作都有适当的加载提示和错误处理

## 下一步
完成测试后，可以开始实现：
1. 添加供货商模态框
2. 编辑供货商模态框
3. 添加客户模态框
4. 编辑客户模态框
