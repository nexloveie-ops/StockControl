# ✅ 序列号颜色功能实现

## 🎯 需求描述

**用户需求**:
> "识别的产品列表 显示出来了。每个imei或者sn号后面 要有颜色框"

为每个设备的序列号（IMEI/SN）添加对应的颜色输入框，支持为同一产品的不同设备指定不同颜色。

---

## ✨ 功能说明

### 1. 设备类产品的序列号+颜色输入

对于设备类产品（全新设备、二手设备），每个序列号后面都有一个颜色输入框：

```
┌─────────────────────────────────────┐
│ SN/IMEI 1: [123456789012345] [深空黑] │
│ SN/IMEI 2: [123456789012346] [金色]   │
│ SN/IMEI 3: [123456789012347] [银色]   │
└─────────────────────────────────────┘
```

### 2. 应用场景

#### 场景A: 发票识别入库
1. 上传发票图片
2. AI识别产品信息
3. 在识别结果中，每个设备的序列号后面显示颜色输入框
4. 为每个序列号填写对应的颜色
5. 确认入库

#### 场景B: 手动录入入库
1. 选择"手动录入入库"模式
2. 添加产品，选择"全新设备"或"二手设备"
3. 设置数量（例如：3）
4. 自动生成3个序列号输入框，每个后面跟一个颜色输入框
5. 填写序列号和对应的颜色
6. 确认入库

---

## 🔧 技术实现

### 修改的函数

#### 1. 发票识别功能

**generateRecognizedIdentifierInputs(product, index)**
- 为设备类产品生成序列号+颜色输入框
- 每个序列号输入框（130px）后面跟一个颜色输入框（70px）
- 使用flexbox布局，间距4px

```javascript
// 设备产品：生成多个序列号输入框，每个后面跟一个颜色输入框
for (let i = 0; i < quantity; i++) {
  const serialNumber = product.serialNumbers?.[i] || '';
  const color = product.serialNumberColors?.[i] || product.color || '';
  inputs += `
    <div style="margin-bottom: 6px; display: flex; gap: 4px; align-items: center;">
      <input type="text" value="${serialNumber}" 
             placeholder="SN/IMEI ${i + 1}"
             style="width: 130px; ..."
             onchange="updateRecognizedSerialNumber(${index}, ${i}, this.value)">
      <input type="text" value="${color}" 
             placeholder="颜色"
             style="width: 70px; ..."
             onchange="updateRecognizedSerialColor(${index}, ${i}, this.value)">
    </div>
  `;
}
```

**updateRecognizedSerialColor(productIndex, serialIndex, value)**
- 新增函数，用于更新序列号对应的颜色
- 保存到 `product.serialNumberColors` 数组

**confirmRecognizedReceiving()**
- 提交时，为每个序列号设置对应的颜色
- 使用 `map` 函数的 `snIndex` 参数获取颜色

```javascript
return product.serialNumbers.filter(sn => sn && sn.trim()).map((serialNumber, snIndex) => ({
  ...baseProduct,
  quantity: 1,
  serialNumber: serialNumber,
  color: product.serialNumberColors?.[snIndex] || product.color || '',
  totalPrice: baseProduct.unitPrice
}));
```

#### 2. 手动录入功能

**updateManualProductRow(index)**
- 为设备类产品生成序列号+颜色输入框
- 布局和样式与发票识别功能一致

**updateManualSerialColor(productIndex, serialIndex, value)**
- 新增函数，用于更新手动录入的序列号颜色
- 保存到 `product.serialNumberColors` 数组

**confirmManualReceiving()**
- 提交时，为每个序列号设置对应的颜色
- 与发票识别功能使用相同的逻辑

---

## 📊 数据结构

### 产品对象结构

```javascript
{
  name: "iPhone 15 Pro Max 256GB",
  productType: "全新设备",
  quantity: 3,
  color: "深空黑",  // 产品的默认颜色
  serialNumbers: [
    "123456789012345",
    "123456789012346",
    "123456789012347"
  ],
  serialNumberColors: [  // 新增：每个序列号对应的颜色
    "深空黑",
    "金色",
    "银色"
  ]
}
```

### 提交到后端的数据

设备类产品会被拆分为多个单独的产品记录，每个记录包含一个序列号和对应的颜色：

```javascript
[
  {
    name: "iPhone 15 Pro Max 256GB",
    quantity: 1,
    serialNumber: "123456789012345",
    color: "深空黑",
    ...
  },
  {
    name: "iPhone 15 Pro Max 256GB",
    quantity: 1,
    serialNumber: "123456789012346",
    color: "金色",
    ...
  },
  {
    name: "iPhone 15 Pro Max 256GB",
    quantity: 1,
    serialNumber: "123456789012347",
    color: "银色",
    ...
  }
]
```

---

## 🎨 UI设计

### 输入框布局

```
┌──────────────────────────────────────────────┐
│ 条码/序列号                                   │
├──────────────────────────────────────────────┤
│ ┌────────────────┐ ┌──────────┐             │
│ │ SN/IMEI 1      │ │ 颜色     │             │
│ └────────────────┘ └──────────┘             │
│                                              │
│ ┌────────────────┐ ┌──────────┐             │
│ │ SN/IMEI 2      │ │ 颜色     │             │
│ └────────────────┘ └──────────┘             │
│                                              │
│ ┌────────────────┐ ┌──────────┐             │
│ │ SN/IMEI 3      │ │ 颜色     │             │
│ └────────────────┘ └──────────┘             │
└──────────────────────────────────────────────┘
```

### 样式规格

- **序列号输入框**: 130px 宽
- **颜色输入框**: 70px 宽
- **间距**: 4px
- **行间距**: 6px
- **字体大小**: 12px
- **边框**: 1px solid #e2e8f0
- **圆角**: 4px

---

## 🧪 测试场景

### 测试1: 发票识别 - 单个设备

1. 上传包含1个设备的发票
2. 识别完成后，查看产品列表
3. 验证：
   - ✅ 显示1个序列号输入框
   - ✅ 序列号输入框后面有1个颜色输入框
4. 填写序列号：123456789012345
5. 填写颜色：深空黑
6. 确认入库
7. 验证：产品记录包含正确的序列号和颜色

### 测试2: 发票识别 - 多个设备

1. 上传包含3个相同设备的发票
2. 识别完成后，查看产品列表
3. 验证：
   - ✅ 显示3个序列号输入框
   - ✅ 每个序列号输入框后面都有颜色输入框
4. 填写序列号和颜色：
   - SN1: 123456789012345, 颜色: 深空黑
   - SN2: 123456789012346, 颜色: 金色
   - SN3: 123456789012347, 颜色: 银色
5. 确认入库
6. 验证：创建了3个产品记录，每个记录的颜色正确

### 测试3: 手动录入 - 动态数量

1. 选择"手动录入入库"
2. 添加产品，选择"全新设备"
3. 设置数量为1
4. 验证：显示1个序列号+颜色输入框
5. 修改数量为3
6. 验证：自动更新为3个序列号+颜色输入框
7. 填写所有序列号和颜色
8. 确认入库
9. 验证：创建了3个产品记录，颜色正确

### 测试4: 配件类产品

1. 添加配件类产品（例如：手机配件）
2. 验证：
   - ✅ 只显示1个条码输入框
   - ✅ 没有颜色输入框（配件使用产品的默认颜色）

### 测试5: 颜色继承

1. 添加设备类产品
2. 在产品的"颜色"列填写：深空黑
3. 设置数量为2
4. 验证：
   - ✅ 2个颜色输入框都预填充为"深空黑"
5. 修改第2个颜色为"金色"
6. 确认入库
7. 验证：
   - 第1个设备颜色：深空黑
   - 第2个设备颜色：金色

---

## 📝 使用说明

### 发票识别入库

1. 上传发票图片
2. 等待AI识别
3. 在产品列表中找到设备类产品
4. 为每个序列号填写对应的颜色：
   - 如果所有设备颜色相同，可以先在"颜色"列填写默认颜色
   - 颜色输入框会自动预填充默认颜色
   - 如果某个设备颜色不同，直接修改对应的颜色输入框
5. 确认入库

### 手动录入入库

1. 选择"手动录入入库"
2. 添加产品，选择设备类分类
3. 设置数量
4. 填写序列号和颜色：
   - 序列号是必填项
   - 颜色是可选项，但建议填写
5. 确认入库

---

## ⚠️ 注意事项

### 1. 颜色输入框的优先级

- 序列号颜色输入框的值 > 产品默认颜色
- 如果序列号颜色输入框为空，使用产品默认颜色
- 如果产品默认颜色也为空，颜色字段为空字符串

### 2. 数据验证

- 序列号是必填项（设备类产品）
- 颜色是可选项
- 序列号数量必须与产品数量一致

### 3. 配件类产品

- 配件类产品不显示序列号输入框
- 配件类产品只显示条码输入框
- 配件类产品使用产品的默认颜色

### 4. 颜色格式

- 颜色输入框接受任意文本
- 建议使用标准颜色名称：深空黑、金色、银色、蓝色等
- 也可以使用英文：Space Black, Gold, Silver, Blue等

---

## 🔗 相关文件

- `StockControl-main/public/admin.html` - 管理员页面（已修改）
- `ADMIN_INVOICE_RECOGNITION_COMPLETE.md` - 发票识别功能文档
- `ADMIN_PURCHASE_ORDER_DONE.md` - 采购订单功能文档

---

## ✅ 完成状态

- ✅ 发票识别：序列号+颜色输入框
- ✅ 手动录入：序列号+颜色输入框
- ✅ 数据提交：包含每个序列号的颜色
- ✅ 颜色继承：从产品默认颜色继承
- ✅ 动态更新：数量变化时自动更新输入框
- ✅ UI布局：美观的flexbox布局

---

**完成时间**: 2026-02-03
**版本**: 1.0
**状态**: ✅ 功能完整，准备测试
