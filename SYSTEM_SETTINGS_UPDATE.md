# ✅ 系统设置功能更新 - 设备成色和税率管理

## 更新时间
2026-02-02

## 更新内容

根据用户需求，为系统设置页面添加了设备成色和税率的完整管理功能（增删改）。

---

## 🆕 新增功能

### 1. 设备成色管理 ✅

现在可以完整管理设备成色：

#### 功能列表
- ✅ 查看所有设备成色
- ✅ 添加新成色
- ✅ 编辑现有成色
- ✅ 删除成色（带保护机制）

#### 成色字段
- **成色代码**: 唯一标识符（建议大写+下划线，如：BRAND_NEW）
- **显示名称**: 用户看到的名称
- **描述**: 成色的详细说明
- **排序权重**: 控制显示顺序（数字越小越靠前）
- **状态**: 启用/禁用

#### 删除保护
- 删除前检查是否有产品使用该成色
- 如果有产品使用，显示产品数量并阻止删除
- 确保数据完整性

#### 预设成色
系统已初始化三种常用成色：
- BRAND_NEW (全新)
- PRE_OWNED (二手)
- REFURBISHED (翻新)

### 2. 税率管理 ✅

现在可以完整管理税率：

#### 功能列表
- ✅ 查看所有税率
- ✅ 添加新税率
- ✅ 编辑现有税率
- ✅ 删除税率（带保护机制）

#### 税率字段
- **税率代码**: 唯一标识符（建议格式：VAT XX%）
- **显示名称**: 用户看到的名称
- **税率**: 百分比数值（0-100）
- **描述**: 税率的详细说明
- **适用范围**: 适用的产品类型说明
- **排序权重**: 控制显示顺序（数字越小越靠前）
- **状态**: 启用/禁用

#### 删除保护
- 删除前检查是否有产品使用该税率
- 删除前检查是否有分类使用该税率
- 如果有使用，显示数量并阻止删除
- 双重保护确保数据完整性

#### 预设税率
系统已初始化三种爱尔兰标准税率：
- VAT 23% (标准税率)
- VAT 13.5% (减免税率)
- VAT 0% (免税)

---

## 📁 新增文件

### 数据模型
1. `models/ProductCondition.js` - 设备成色数据模型
2. `models/VatRate.js` - 税率数据模型

### 控制器
1. `controllers/admin/conditionController.js` - 成色管理控制器
2. `controllers/admin/vatRateController.js` - 税率管理控制器

### 脚本
1. `scripts/init-system-settings.js` - 初始化系统设置数据

### 文档
1. `SYSTEM_SETTINGS_UPDATE.md` - 本文档

---

## 🔧 修改的文件

### 后端
1. `routes/admin.js` - 添加成色和税率路由
   - GET/POST/PUT/DELETE `/api/admin/conditions`
   - GET/POST/PUT/DELETE `/api/admin/vat-rates`

### 前端
1. `public/admin-system-settings.html` - 更新页面
   - 添加成色管理表格和模态框
   - 添加税率管理表格和模态框
   - 添加完整的JavaScript管理功能

---

## 🎯 API端点

### 设备成色API
```
GET    /api/admin/conditions       - 获取所有成色
POST   /api/admin/conditions       - 创建新成色
PUT    /api/admin/conditions/:id   - 更新成色
DELETE /api/admin/conditions/:id   - 删除成色
```

### 税率API
```
GET    /api/admin/vat-rates        - 获取所有税率
POST   /api/admin/vat-rates        - 创建新税率
PUT    /api/admin/vat-rates/:id    - 更新税率
DELETE /api/admin/vat-rates/:id    - 删除税率
```

---

## 🚀 使用方法

### 访问系统设置
1. 登录管理员账号 (admin/admin123)
2. 访问 http://localhost:3000/admin-system-settings.html
3. 点击对应标签页

### 管理设备成色

#### 添加成色
1. 点击"设备成色"标签
2. 点击"+ 添加成色"按钮
3. 填写成色信息：
   - 成色代码: LIKE_NEW
   - 显示名称: 准新
   - 描述: 几乎全新的产品
   - 排序权重: 2
4. 点击"保存"

#### 编辑成色
1. 在成色列表中找到要编辑的成色
2. 点击"编辑"按钮
3. 修改需要更改的字段
4. 点击"保存"

#### 删除成色
1. 在成色列表中找到要删除的成色
2. 点击"删除"按钮
3. 确认删除操作
4. 如果有产品使用该成色，会提示无法删除

### 管理税率

#### 添加税率
1. 点击"税率设置"标签
2. 点击"+ 添加税率"按钮
3. 填写税率信息：
   - 税率代码: VAT 9%
   - 显示名称: VAT 9%
   - 税率: 9
   - 描述: 特殊减免税率
   - 适用范围: 适用于特定商品
   - 排序权重: 4
4. 点击"保存"

#### 编辑税率
1. 在税率列表中找到要编辑的税率
2. 点击"编辑"按钮
3. 修改需要更改的字段
4. 点击"保存"

#### 删除税率
1. 在税率列表中找到要删除的税率
2. 点击"删除"按钮
3. 确认删除操作
4. 如果有产品或分类使用该税率，会提示无法删除

---

## 🔒 删除保护机制

### 设备成色删除保护
```javascript
// 检查是否有产品使用此成色
const productCount = await ProductNew.countDocuments({ 
  condition: condition.code,
  isActive: true 
});

if (productCount > 0) {
  return error: `无法删除成色，还有 ${productCount} 个产品使用此成色`
}
```

### 税率删除保护
```javascript
// 检查是否有产品使用此税率
const productCount = await ProductNew.countDocuments({ 
  vatRate: vatRate.code,
  isActive: true 
});

// 检查是否有分类使用此税率
const categoryCount = await ProductCategory.countDocuments({ 
  defaultVatRate: vatRate.code,
  isActive: true 
});

if (productCount > 0 || categoryCount > 0) {
  return error: 无法删除
}
```

---

## 📊 数据初始化

系统已自动初始化基础数据，运行以下命令可重新初始化：

```bash
cd StockControl-main
node scripts/init-system-settings.js
```

初始化内容：
- 3种设备成色（BRAND_NEW, PRE_OWNED, REFURBISHED）
- 3种税率（VAT 23%, VAT 13.5%, VAT 0%）

---

## ⚠️ 注意事项

### 1. 成色代码命名规范
- 建议使用大写字母和下划线
- 例如：BRAND_NEW, PRE_OWNED, LIKE_NEW
- 避免使用空格和特殊字符

### 2. 税率代码命名规范
- 建议使用 "VAT XX%" 格式
- 例如：VAT 23%, VAT 13.5%, VAT 0%
- 保持一致性便于识别

### 3. 删除前的准备
- 删除成色前，确保没有产品使用该成色
- 删除税率前，确保没有产品或分类使用该税率
- 可以先将产品/分类移动到其他成色/税率

### 4. 税率设置的合规性
- 税率设置涉及财务合规
- 修改前请咨询税务顾问
- 确保符合当地税法要求

### 5. 排序权重
- 成色：数字越小越靠前（1, 2, 3...）
- 税率：数字越小越靠前（1, 2, 3...）
- 可以使用负数或小数

---

## 🧪 测试步骤

### 1. 测试成色管理
```
1. 访问系统设置页面
2. 点击"设备成色"标签
3. 验证显示3个预设成色
4. 添加新成色 "准新"
5. 编辑新添加的成色
6. 尝试删除（如果有产品使用，应该被阻止）
7. 删除无产品使用的成色
```

### 2. 测试税率管理
```
1. 点击"税率设置"标签
2. 验证显示3个预设税率
3. 添加新税率 "VAT 9%"
4. 编辑新添加的税率
5. 尝试删除（如果有产品或分类使用，应该被阻止）
6. 删除无使用的税率
```

### 3. 测试删除保护
```
1. 尝试删除有产品使用的成色
2. 验证提示错误信息
3. 尝试删除有产品使用的税率
4. 验证提示错误信息
5. 尝试删除有分类使用的税率
6. 验证提示错误信息
```

---

## 🎉 功能对比

### 更新前
| 功能 | 产品分类 | 设备成色 | 税率设置 |
|------|---------|---------|---------|
| 查看 | ✅ | ✅ | ✅ |
| 添加 | ✅ | ❌ | ❌ |
| 编辑 | ✅ | ❌ | ❌ |
| 删除 | ✅ | ❌ | ❌ |

### 更新后
| 功能 | 产品分类 | 设备成色 | 税率设置 |
|------|---------|---------|---------|
| 查看 | ✅ | ✅ | ✅ |
| 添加 | ✅ | ✅ | ✅ |
| 编辑 | ✅ | ✅ | ✅ |
| 删除 | ✅ | ✅ | ✅ |

---

## 📝 相关文档

- [系统设置功能说明](ADMIN_SYSTEM_SETTINGS_FEATURE.md)
- [快速测试指南](QUICK_TEST_SYSTEM_SETTINGS.md)

---

## ✅ 完成清单

- [x] 创建设备成色数据模型
- [x] 创建税率数据模型
- [x] 创建成色管理控制器
- [x] 创建税率管理控制器
- [x] 添加API路由
- [x] 更新前端页面
- [x] 添加模态框
- [x] 实现JavaScript管理功能
- [x] 添加删除保护机制
- [x] 创建初始化脚本
- [x] 初始化基础数据
- [x] 测试所有功能
- [x] 编写文档

---

**状态**: ✅ 已完成
**版本**: v2.0.0
**更新时间**: 2026-02-02
**服务器进程**: 6
