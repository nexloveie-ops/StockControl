# 快速测试：库存编辑状态 & 时间线退款记录

## 🚀 开始测试

### 前提条件
1. 重启服务器（因为修改了 app.js）
   ```bash
   # 停止服务器 (Ctrl + C)
   node app.js
   ```

2. 刷新浏览器
   - 按 `Ctrl + Shift + R` 强制刷新

---

## 测试1: 修改产品状态 ⚙️

### 步骤
1. 登录 merchant.html
   - 用户名: `murrayranelagh`
   - 密码: `password123`

2. 进入"我的库存"

3. 搜索产品
   - 输入序列号: `1113333`
   - 点击搜索

4. 编辑产品
   - 点击"✏️ 编辑"按钮
   - 找到"状态"下拉框（在成色下面）
   - 当前应该显示: `✅ Active (正常)`

5. 修改状态
   - 选择: `⚠️ Damaged (损坏)`
   - 点击"💾 保存修改"

6. 验证修改
   - 应该看到提示: "✅ 产品信息已更新"
   - 再次搜索 `1113333`
   - 点击编辑，确认状态是 `Damaged`

### 预期结果
- ✅ 编辑模态框有"状态"下拉框
- ✅ 下拉框有5个选项（Active, Damaged, Repairing, Reserved, Returned）
- ✅ 保存成功
- ✅ 状态已更新

---

## 测试2: 查看时间线退款记录 📊

### 步骤
1. 搜索已退款的产品
   - 输入序列号: `111999`（之前退款的 iPhone 11）
   - 点击搜索

2. 打开时间线
   - 点击"📊 时间线"按钮

3. 查看时间线内容
   - 应该看到多条记录，按时间倒序排列

### 预期结果

应该看到以下记录（从新到旧）：

#### 1. ↩️ 产品退款（红色边框）
- 标题: "产品退款"
- 描述: "产品已退款并退回库存"
- 详情:
  - 退款金额: €XXX.XX
  - 退款原因: （如果有）
  - 退回成色: 二手 / Pre-Owned
  - 客户电话: （如果有）

#### 2. 💰 产品销售（蓝色边框）
- 标题: "产品销售"
- 描述: "产品已售出"
- 详情:
  - 销售价格: €XXX.XX
  - 数量: 1
  - 支付方式: 现金/刷卡
  - 客户电话: （如果有）

#### 3. 📥 产品入库（绿色边框）
- 标题: "产品入库"
- 描述: "产品入库到商户库存"
- 详情:
  - 来源: 手动入库/仓库调货/商户调货
  - 成本价: €XXX.XX
  - 零售价: €XXX.XX
  - 数量: 1

### 视觉检查
- ✅ 退款记录是红色边框
- ✅ 销售记录是蓝色边框
- ✅ 入库记录是绿色边框
- ✅ 时间线左侧有彩色圆点
- ✅ 记录按时间倒序排列（最新的在上面）

---

## 测试3: 测试其他产品的时间线 📋

### 步骤
1. 搜索其他产品（没有退款记录的）
   - 例如: `1113333`

2. 打开时间线
   - 点击"📊 时间线"按钮

3. 查看时间线
   - 应该只看到入库记录
   - 如果产品被销售过，应该看到销售记录
   - 如果产品被调货过，应该看到调货记录

### 预期结果
- ✅ 没有退款记录的产品不显示退款
- ✅ 时间线正确显示所有历史事件
- ✅ 每个事件都有正确的颜色和图标

---

## 测试4: 状态选项完整性 🔍

### 步骤
1. 编辑任意产品

2. 点击"状态"下拉框

3. 检查所有选项

### 预期结果
应该看到5个选项：
- ✅ Active (正常)
- ⚠️ Damaged (损坏)
- 🔧 Repairing (维修中)
- 📌 Reserved (预留)
- ↩️ Returned (退货)

---

## 故障排除 🔧

### 问题1: 编辑模态框没有"状态"字段
**解决方案:**
- 刷新浏览器 (Ctrl + Shift + R)
- 清除浏览器缓存

### 问题2: 保存状态失败
**解决方案:**
- 检查服务器是否重启
- 查看浏览器控制台错误信息
- 查看服务器日志

### 问题3: 时间线没有退款记录
**可能原因:**
- 产品没有退款记录
- 销售记录的 status 不是 'refunded'
- 销售记录没有 refundDate 字段

**验证方法:**
```javascript
// 在浏览器控制台运行
fetch('/api/merchant/sales')
  .then(r => r.json())
  .then(d => console.log(d.data.filter(s => s.status === 'refunded')))
```

### 问题4: 时间线颜色不对
**解决方案:**
- 刷新浏览器 (Ctrl + Shift + R)
- 检查 merchant.html 第7693行的代码

---

## 成功标准 ✅

### 状态修改功能
- [x] 编辑模态框显示状态下拉框
- [x] 状态下拉框有5个选项
- [x] 可以修改状态并保存
- [x] 修改后状态正确显示

### 时间线退款记录
- [x] 时间线显示退款记录
- [x] 退款记录是红色边框
- [x] 退款记录显示正确的详情
- [x] 时间线按时间倒序排列
- [x] 销售和退款记录都显示

---

## 下一步

如果测试通过，可以：
1. 测试其他状态选项（Repairing, Reserved, Returned）
2. 测试多次销售和退款的产品
3. 测试调货产品的时间线
4. 测试不同商户的数据隔离

如果测试失败，请提供：
1. 具体的错误信息
2. 浏览器控制台的错误日志
3. 服务器日志
4. 操作步骤
