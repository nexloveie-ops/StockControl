# 维修业务功能快速测试指南

## 测试日期
2026-02-02

## 测试前准备

### 1. 确认服务器运行
- 服务器地址: http://localhost:3000
- 服务器状态: ✅ 运行中（进程 16）

### 2. 登录账号
- 商户账号: `merchant_001`
- 密码: `merchant123`

---

## 测试场景 A：自己维修流程

### 步骤 1：创建维修订单（自己维修）

1. 登录商户账号
2. 点击 **"维修业务"** 标签页
3. 点击 **"+ 新增维修订单"** 按钮
4. 填写表单：

**客户信息**（蓝色区域）
- 客户电话: `0851234567` ✅ 必填
- 客户姓名: `张三`

**设备信息**（黄色区域）
- 设备名称: `iPhone 13 Pro` ✅ 必填
- IMEI: `123456789012345`
- 序列号(SN): `ABC123XYZ`

**维修信息**（粉色区域）
- 问题描述: `屏幕破裂，需要更换屏幕` ✅ 必填
- 备注: `客户要求尽快修复`
- 维修地点: **留空**（表示自己维修）
- 预计完成时间: `2026-02-05`
- 维修费用: `150.00`

5. 点击 **"✅ 创建订单"** 按钮

**预期结果**：
- ✅ 弹出提示：维修订单创建成功！状态: 待维修
- ✅ 订单出现在维修记录表格中
- ✅ 状态显示为 **"待维修"**（橙色标签）
- ✅ 维修地点显示为 **"自己维修"**（绿色文字）

### 步骤 2：完成维修

1. 在维修记录表格中找到刚创建的订单
2. 点击 **"完成"** 按钮
3. 确认操作

**预期结果**：
- ✅ 弹出提示：状态已更新为: 已完成
- ✅ 状态变为 **"已完成"**（青色标签）
- ✅ 操作按钮变为 **"待销售"**

### 步骤 3：标记为等待销售

1. 点击 **"待销售"** 按钮
2. 确认操作

**预期结果**：
- ✅ 弹出提示：状态已更新为: 等待销售
- ✅ 状态变为 **"等待销售"**（粉色标签）
- ✅ 操作按钮变为 **"✓ 可销售"**

### 步骤 4：在销售业务中销售

1. 切换到 **"销售业务"** 标签页
2. 查看分类列表

**预期结果**：
- ✅ 看到 **"🔧 维修订单"** 分类卡片（橙色渐变）
- ✅ 显示 "1 个待销售订单"

3. 点击 **"维修订单"** 卡片
4. 查看维修订单列表

**预期结果**：
- ✅ 显示设备名称：iPhone 13 Pro
- ✅ 显示客户信息：张三 (0851234567)
- ✅ 显示 IMEI/SN
- ✅ 显示问题描述
- ✅ 显示维修费用：€150.00
- ✅ 显示建议售价：€195.00（150 × 1.3）

5. 点击 **"+ 加入购物车"** 按钮

**预期结果**：
- ✅ 弹出提示：iPhone 13 Pro 维修订单已添加到购物车
- ✅ 购物车显示 1 件商品
- ✅ 购物车总额：€195.00

6. 点击 **"🛒 查看购物车"** 按钮
7. 查看购物车内容

**预期结果**：
- ✅ 商品名称：iPhone 13 Pro（维修服务）
- ✅ 单价：€195.00
- ✅ 数量：1
- ✅ 税率：Service VAT 13.5%
- ✅ 小计：€195.00

8. 选择支付方式：**现金**
9. 点击 **"💰 完成支付"** 按钮

**预期结果**：
- ✅ 弹出提示：销售完成！
- ✅ 购物车清空
- ✅ 返回分类列表

10. 切换回 **"维修业务"** 标签页
11. 查看维修记录

**预期结果**：
- ✅ 订单状态变为 **"已销售"**（灰色标签）
- ✅ 不再显示操作按钮

---

## 测试场景 B：外送维修流程

### 步骤 1：创建维修订单（外送维修）

1. 在 **"维修业务"** 标签页
2. 点击 **"+ 新增维修订单"** 按钮
3. 填写表单：

**客户信息**
- 客户电话: `0851234568`
- 客户姓名: `李四`

**设备信息**
- 设备名称: `Samsung Galaxy S21`
- IMEI: `987654321098765`
- 序列号(SN): `XYZ789ABC`

**维修信息**
- 问题描述: `电池老化，需要更换电池`
- 备注: `客户要求使用原装电池`
- 维修地点: `ABC Repair Shop` ✅ **填写地点表示外送维修**
- 预计完成时间: `2026-02-06`
- 维修费用: `80.00`

4. 点击 **"✅ 创建订单"** 按钮

**预期结果**：
- ✅ 弹出提示：维修订单创建成功！状态: 已送出
- ✅ 订单出现在维修记录表格中
- ✅ 状态显示为 **"已送出"**（紫色标签）
- ✅ 维修地点显示为 **"ABC Repair Shop"**

### 步骤 2：标记为已取回

1. 在维修记录表格中找到订单
2. 点击 **"已取回"** 按钮
3. 确认操作

**预期结果**：
- ✅ 弹出提示：状态已更新为: 已取回
- ✅ 状态变为 **"已取回"**（绿色标签）
- ✅ 操作按钮变为 **"待销售"**

### 步骤 3：标记为等待销售

1. 点击 **"待销售"** 按钮
2. 确认操作

**预期结果**：
- ✅ 状态变为 **"等待销售"**（粉色标签）

### 步骤 4：在销售业务中销售

1. 切换到 **"销售业务"** 标签页
2. 点击 **"🔧 维修订单"** 卡片
3. 查看维修订单列表

**预期结果**：
- ✅ 显示 Samsung Galaxy S21
- ✅ 维修费用：€80.00
- ✅ 建议售价：€104.00（80 × 1.3）

4. 点击 **"+ 加入购物车"**
5. 选择支付方式：**刷卡**
6. 点击 **"💰 完成支付"**

**预期结果**：
- ✅ 销售完成
- ✅ 订单状态变为 **"已销售"**

---

## 测试场景 C：状态筛选功能

### 测试步骤

1. 在 **"维修业务"** 标签页
2. 点击不同的状态筛选按钮：

- **全部**（蓝色）：显示所有维修记录
- **待维修**（橙色）：只显示待维修的订单
- **已送出**（紫色）：只显示已送出的订单
- **已取回**（绿色）：只显示已取回的订单
- **已完成**（青色）：只显示已完成的订单
- **等待销售**（粉色）：只显示等待销售的订单

**预期结果**：
- ✅ 点击按钮后，按钮高亮显示（不透明度 1）
- ✅ 其他按钮变暗（不透明度 0.6）
- ✅ 表格只显示对应状态的订单
- ✅ 如果没有记录，显示"暂无维修记录"

---

## 测试场景 D：删除维修订单

### 测试步骤

1. 创建一个新的维修订单（任意信息）
2. 在维修记录表格中找到订单
3. 点击 **"删除"** 按钮（红色）
4. 确认删除

**预期结果**：
- ✅ 弹出确认对话框
- ✅ 确认后弹出提示：维修订单已删除
- ✅ 订单从列表中消失

**注意**：已销售的订单不显示删除按钮

---

## 测试场景 E：混合支付维修订单

### 测试步骤

1. 创建并完成一个维修订单（费用 €100）
2. 标记为等待销售
3. 在销售业务中加入购物车（建议售价 €130）
4. 选择支付方式：**混合支付**
5. 输入：
   - 现金金额：€50.00
   - 刷卡金额：€80.00
6. 点击 **"💰 完成支付"**

**预期结果**：
- ✅ 销售完成
- ✅ 销售记录中显示混合支付详情

---

## 测试场景 F：税额计算验证

### 维修服务税率：Service VAT 13.5%

**计算公式**：税额 = 销售额 × 13.5 / 113.5

### 示例 1
- 维修费用：€150.00
- 建议售价：€195.00
- 税额：€195.00 × 13.5 / 113.5 = €23.21

### 示例 2
- 维修费用：€80.00
- 建议售价：€104.00
- 税额：€104.00 × 13.5 / 113.5 = €12.37

### 验证步骤

1. 完成一笔维修订单销售
2. 切换到 **"销售记录查询"** 标签页
3. 点击 **"查询"** 按钮
4. 展开销售记录，查看商品详情

**预期结果**：
- ✅ 税务分类显示：Service VAT 13.5%
- ✅ 税额计算正确

---

## 测试场景 G：销售记录查询

### 测试步骤

1. 完成几笔维修订单销售
2. 切换到 **"销售记录查询"** 标签页
3. 选择日期范围
4. 点击 **"查询"** 按钮

**预期结果**：
- ✅ 显示销售记录列表
- ✅ 维修订单显示为"维修服务"
- ✅ 显示客户信息
- ✅ 显示支付方式
- ✅ 显示总额和利润
- ✅ 可以展开查看商品详情

---

## 功能检查清单

### 维修订单创建
- ✅ 必填字段验证（客户电话、设备名称、问题描述）
- ✅ 自己维修模式（维修地点留空）
- ✅ 外送维修模式（填写维修地点）
- ✅ 初始状态正确（pending 或 sent_out）

### 状态管理
- ✅ 待维修 → 已完成 → 等待销售
- ✅ 已送出 → 已取回 → 等待销售
- ✅ 等待销售 → 已销售（通过销售业务）
- ✅ 状态标签颜色正确

### 销售集成
- ✅ 维修订单分类卡片显示
- ✅ 待销售订单数量统计
- ✅ 维修订单列表显示
- ✅ 建议售价计算（费用 × 1.3）
- ✅ 加入购物车功能
- ✅ 税率固定为 Service VAT 13.5%
- ✅ 销售后状态更新

### 数据管理
- ✅ 维修记录列表显示
- ✅ 状态筛选功能
- ✅ 订单删除功能
- ✅ 销售记录查询

### 用户体验
- ✅ 表单验证和错误提示
- ✅ 操作成功提示
- ✅ 按钮状态和可用性
- ✅ 数据实时更新

---

## 常见问题排查

### 问题 1：维修订单不显示在销售业务中
**检查**：
- 订单状态是否为 "ready_for_sale"、"completed" 或 "retrieved"
- 刷新页面重新加载数据

### 问题 2：无法创建维修订单
**检查**：
- 必填字段是否都已填写
- 客户电话格式是否正确
- 维修费用是否为有效数字

### 问题 3：状态更新失败
**检查**：
- 网络连接是否正常
- 服务器是否运行
- 浏览器控制台是否有错误信息

### 问题 4：税额计算不正确
**检查**：
- 税务分类是否为 SERVICE_VAT_13_5
- 计算公式：税额 = 销售额 × 13.5 / 113.5

---

## API 端点测试

### 创建维修订单
```bash
POST http://localhost:3000/api/merchant/repairs
Content-Type: application/json

{
  "merchantId": "merchant_001",
  "customerPhone": "0851234567",
  "deviceName": "iPhone 13",
  "problemDescription": "屏幕破裂",
  "repairCost": 150
}
```

### 获取维修记录
```bash
GET http://localhost:3000/api/merchant/repairs?merchantId=merchant_001
```

### 获取待销售订单
```bash
GET http://localhost:3000/api/merchant/repairs/ready-for-sale?merchantId=merchant_001
```

### 更新订单状态
```bash
PUT http://localhost:3000/api/merchant/repairs/{repairId}/status
Content-Type: application/json

{
  "status": "completed"
}
```

### 删除订单
```bash
DELETE http://localhost:3000/api/merchant/repairs/{repairId}
```

---

## 总结

维修业务功能已完整实现，包括：

✅ **完整的维修流程**
- 自己维修和外送维修两种模式
- 清晰的状态流转
- 完善的操作按钮

✅ **销售业务集成**
- 维修订单作为独立分类
- 自动计算建议售价
- 固定税率处理

✅ **数据管理**
- 维修记录查询
- 状态筛选
- 订单删除

✅ **用户体验**
- 直观的界面设计
- 清晰的状态标识
- 及时的操作反馈

**开始测试**：http://localhost:3000
**登录账号**：merchant_001 / merchant123

祝测试顺利！🎉
