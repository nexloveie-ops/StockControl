# 测试：多库存记录调货修复

## 🎯 测试目标
验证配件产品有多条库存记录时，调货申请能否正常提交

## 📋 测试场景
- 产品：Phone Case, iPhone 13 - Clear
- 库存记录：3 条（每条 quantity: 1）
- 请求数量：2 件
- 预期结果：成功创建调货申请

## 🧪 测试步骤

### 步骤 1: 清除购物车
1. 登录 MurrayRanelagh 账号
2. 如果购物车有产品，点击"清空清单"

### 步骤 2: 添加产品到购物车
1. 进入"群组库存"
2. 选择店铺：MurrayDundrum
3. 选择包含 Phone Case 的分类
4. 找到 Phone Case 产品
5. 点击"🎨 选择型号和颜色"
6. 选择：iPhone 13 - Clear
7. 输入数量：2
8. 点击确定
9. ✅ 验证：显示"已添加 2 件 Phone Case 到调货清单"

### 步骤 3: 检查购物车
1. 查看右侧购物车
2. ✅ 验证：
   - 产品名称：Phone Case 或 iPhone Clear Case
   - 数量：2
   - 价格正确显示

### 步骤 4: 提交调货申请
1. 点击"提交调货申请"按钮
2. ✅ 应该弹出调货确认对话框
3. 查看对话框内容：
   - 交易类型（内部调拨或公司间销售）
   - 调出方：MurrayDundrum
   - 调入方：MurrayRanelagh
   - 产品清单
   - 总金额

### 步骤 5: 确认提交
1. 点击"确认调货"或"确认购买"按钮
2. ✅ 应该显示成功消息：
   - "内部调拨申请已提交！" 或
   - "公司间销售订单已创建！"
3. ✅ 显示调货单号
4. ✅ 购物车中的产品被移除

### 步骤 6: 验证调货记录（调入方）
1. 保持 MurrayRanelagh 登录
2. 进入"调货管理"标签
3. 点击"我的申请"子标签
4. ✅ 应该看到刚才创建的调货申请
5. 查看详情：
   - 状态：待审批
   - 产品数量：2 件（可能显示为 2 个项目）

### 步骤 7: 验证调货记录（调出方）
1. 登录 MurrayDundrum 账号
2. 进入"调货管理" → "待审批"
3. ✅ 应该看到来自 MurrayRanelagh 的调货申请
4. 点击查看详情
5. ✅ 验证产品信息正确

### 步骤 8: 审批调货
1. 在 MurrayDundrum 账号中
2. 点击"批准"按钮
3. ✅ 应该显示"已批准调货申请"
4. 状态变为"已批准"

### 步骤 9: 确认收货
1. 登录 MurrayRanelagh 账号
2. 进入"调货管理" → "我的申请"
3. 找到状态为"已批准"的申请
4. 点击"确认收货"
5. 如果是公司间销售，设置批发价和零售价
6. 点击确认
7. ✅ 应该显示"收货确认成功"

### 步骤 10: 验证库存变化
**MurrayDundrum（调出方）**：
1. 进入"我的库存"
2. 搜索：iPhone Clear Case 或 Phone Case
3. ✅ 验证：库存减少 2 件（从 3 → 1）

**MurrayRanelagh（调入方）**：
1. 进入"我的库存"
2. 搜索：iPhone Clear Case 或 Phone Case
3. ✅ 验证：新增 2 件库存

## 🐛 可能的错误和解决方案

### 错误 1: "库存不足"
**原因**：服务器未重启或代码未更新
**解决**：
1. 确认服务器已重启
2. 检查 app.js 是否包含新的多库存记录逻辑

### 错误 2: "调货记录不存在"
**原因**：数据库连接问题
**解决**：
1. 检查 MongoDB 连接
2. 查看服务器日志

### 错误 3: 购物车显示数量不对
**原因**：浏览器缓存
**解决**：
1. 清除浏览器缓存（Ctrl+F5）
2. 确认页面版本是 v2.1.4

## ✅ 测试通过标准
- [ ] 可以添加 2 件到购物车
- [ ] 提交调货申请成功
- [ ] 显示调货单号
- [ ] 调货记录正确显示
- [ ] 审批流程正常
- [ ] 确认收货成功
- [ ] 库存正确扣减和增加

## 📝 测试结果记录
- 测试日期：__________
- 测试人员：__________
- 产品名称：__________
- 请求数量：______ 件
- 调货单号：__________
- 测试结果：⬜ 通过 ⬜ 失败

### 详细结果
| 步骤 | 结果 | 备注 |
|------|------|------|
| 添加到购物车 | ⬜ 成功 ⬜ 失败 | |
| 提交调货申请 | ⬜ 成功 ⬜ 失败 | |
| 调货记录创建 | ⬜ 成功 ⬜ 失败 | |
| 审批流程 | ⬜ 成功 ⬜ 失败 | |
| 确认收货 | ⬜ 成功 ⬜ 失败 | |
| 库存扣减 | ⬜ 正确 ⬜ 错误 | |
| 库存增加 | ⬜ 正确 ⬜ 错误 | |

## 🎉 完成
如果所有测试通过，多库存记录调货功能已完全修复！

## 📌 技术说明
修复后的逻辑：
1. 前端传递第一条记录的 ID 和总数量
2. 后端检查单条记录是否足够
3. 如果不足，查找同产品的其他记录
4. 从多条记录中分配数量（先进先出）
5. 为每条使用的记录创建独立的调货项目
6. 完成时分别从各条记录扣减库存
