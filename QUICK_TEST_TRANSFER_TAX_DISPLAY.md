# 快速测试：调货确认对话框税务显示

## 测试目标

验证调货确认对话框能够正确显示每个产品的税务分类，并根据税务分类计算VAT。

## 前提条件

✅ 服务器运行中：http://localhost:3000
✅ 测试账号：
- MurrayRanelagh (Murray Electronics Limited)
- MurrayDundrum (Murray Electronics Limited)

✅ 测试产品：
- 序列号 111222：iPhone 12 128GB AB Grade (Margin VAT)
- 序列号 222333：iPhone 14 (VAT 23%)

## 测试步骤

### 测试1: Margin VAT产品单独调货

**目的**：验证Margin VAT产品的税务显示和估算说明

1. **登录**
   ```
   用户名: MurrayDundrum
   密码: 123456
   ```

2. **进入群组库存**
   - 点击"群组库存"

3. **添加Margin VAT产品**
   - 找到序列号 111222 的产品（iPhone 12 128GB AB Grade）
   - 确认税务分类显示为"Margin VAT"
   - 点击"添加到调货清单"

4. **查看购物车**
   - 点击右上角购物车图标
   - 确认产品已添加
   - 批发价应该显示 €235.00

5. **提交调货申请**
   - 点击"提交调货申请"
   - 等待确认对话框出现

6. **验证确认对话框**

   **产品列表应该显示**：
   ```
   ┌──────────────────────────┬────────────┬──────────┬────┬────────┬────────┐
   │ 产品名称                 │ 序列号     │ 税务分类 │ 数量│ 批发价 │ 小计   │
   ├──────────────────────────┼────────────┼──────────┼────┼────────┼────────┤
   │ iPhone 12 128GB AB Grade │ 111222     │ Margin   │ 1  │ €235.00│ €235.00│
   │                          │            │ (橙色)   │    │        │        │
   └──────────────────────────┴────────────┴──────────┴────┴────────┴────────┘
   ```

   **金额汇总应该显示**：
   ```
   小计: €235.00
   VAT: €13.21  (估算值，约为 235 × 0.3 × 0.23 / 1.23)
   
   ⚠️ 包含Margin VAT产品，VAT为估算值，实际金额将根据差价计算
   
   总计 (估算): €248.21
   ```

   **检查点**：
   - ✅ 税务分类列显示"Margin"标签（橙色）
   - ✅ VAT金额约为 €13.21（不是 €54.05）
   - ✅ 显示黄色警告框
   - ✅ 总计标题显示"总计 (估算)"

7. **取消对话框**
   - 点击"取消"按钮
   - 不实际提交调货

### 测试2: VAT 23%产品单独调货

**目的**：验证标准VAT产品的准确计算

1. **清空购物车**
   - 点击购物车
   - 移除所有产品

2. **添加VAT 23%产品**
   - 找到序列号 222333 的产品（iPhone 14）
   - 确认税务分类显示为"VAT_23"
   - 点击"添加到调货清单"

3. **提交调货申请**
   - 点击"提交调货申请"
   - 等待确认对话框出现

4. **验证确认对话框**

   **产品列表应该显示**：
   ```
   ┌──────────────┬────────────┬──────────┬────┬────────┬────────┐
   │ 产品名称     │ 序列号     │ 税务分类 │ 数量│ 批发价 │ 小计   │
   ├──────────────┼────────────┼──────────┼────┼────────┼────────┤
   │ iPhone 14    │ 222333     │  23%     │ 1  │ €600.00│ €600.00│
   │              │            │ (蓝色)   │    │        │        │
   └──────────────┴────────────┴──────────┴────┴────────┴────────┘
   ```

   **金额汇总应该显示**：
   ```
   小计: €600.00
   VAT: €138.00  (准确值，600 × 0.23)
   
   总计: €738.00
   ```

   **检查点**：
   - ✅ 税务分类列显示"23%"标签（蓝色）
   - ✅ VAT金额为 €138.00（准确）
   - ✅ 不显示警告框
   - ✅ 总计标题显示"总计"（不显示"估算"）

5. **取消对话框**
   - 点击"取消"按钮

### 测试3: 混合税率产品调货

**目的**：验证多种税率混合时的显示

1. **清空购物车**
   - 移除所有产品

2. **添加多个产品**
   - 添加序列号 222333（VAT 23%）
   - 添加序列号 111222（Margin VAT）

3. **提交调货申请**
   - 点击"提交调货申请"
   - 等待确认对话框出现

4. **验证确认对话框**

   **产品列表应该显示**：
   ```
   ┌──────────────────────────┬────────────┬──────────┬────┬────────┬────────┐
   │ 产品名称                 │ 序列号     │ 税务分类 │ 数量│ 批发价 │ 小计   │
   ├──────────────────────────┼────────────┼──────────┼────┼────────┼────────┤
   │ iPhone 14                │ 222333     │  23%     │ 1  │ €600.00│ €600.00│
   │                          │            │ (蓝色)   │    │        │        │
   ├──────────────────────────┼────────────┼──────────┼────┼────────┼────────┤
   │ iPhone 12 128GB AB Grade │ 111222     │ Margin   │ 1  │ €235.00│ €235.00│
   │                          │            │ (橙色)   │    │        │        │
   └──────────────────────────┴────────────┴──────────┴────┴────────┴────────┘
   ```

   **金额汇总应该显示**：
   ```
   小计: €835.00
   VAT (混合税率): €151.21
   
   ⚠️ 包含Margin VAT产品，VAT为估算值，实际金额将根据差价计算
   
   总计 (估算): €986.21
   ```

   **检查点**：
   - ✅ 每个产品显示对应的税务分类标签（不同颜色）
   - ✅ VAT行显示"VAT (混合税率)"
   - ✅ VAT金额约为 €151.21（138.00 + 13.21）
   - ✅ 显示黄色警告框
   - ✅ 总计标题显示"总计 (估算)"

5. **取消对话框**
   - 点击"取消"按钮

### 测试4: 内部调拨（同公司）

**目的**：验证内部调拨不显示税务信息

1. **清空购物车**
   - 移除所有产品

2. **添加产品**
   - 添加任意产品

3. **选择同公司商户**
   - 确保调出方和调入方都属于"Murray Electronics Limited"
   - 例如：MurrayRanelagh → MurrayDundrum

4. **提交调货申请**
   - 点击"提交调货申请"
   - 等待确认对话框出现

5. **验证确认对话框**

   **产品列表应该显示**：
   ```
   ┌──────────────┬────────────┬────┬────────┬────────┐
   │ 产品名称     │ 序列号     │ 数量│ 成本价 │ 小计   │
   ├──────────────┼────────────┼────┼────────┼────────┤
   │ iPhone 14    │ 222333     │ 1  │ €500.00│ €500.00│
   └──────────────┴────────────┴────┴────────┴────────┘
   ```
   注意：没有"税务分类"列

   **金额汇总应该显示**：
   ```
   小计: €500.00
   
   总计: €500.00
   ```
   注意：没有VAT行

   **检查点**：
   - ✅ 不显示税务分类列
   - ✅ 不显示VAT行
   - ✅ 使用成本价（不是批发价）
   - ✅ 总计 = 小计

6. **取消对话框**
   - 点击"取消"按钮

## 预期结果总结

### ✅ 修复前的问题

**问题**：所有产品都按23% VAT计算
```
iPhone 12 128GB AB Grade (Margin VAT)
小计: €235.00
VAT (23%): €54.05  ❌ 错误！
总计: €289.05
```

### ✅ 修复后的效果

**Margin VAT产品**：
```
iPhone 12 128GB AB Grade
税务分类: Margin (橙色标签)
小计: €235.00
VAT: €13.21  ✅ 正确！使用估算差价计算
⚠️ 包含Margin VAT产品，VAT为估算值
总计 (估算): €248.21
```

**VAT 23%产品**：
```
iPhone 14
税务分类: 23% (蓝色标签)
小计: €600.00
VAT: €138.00  ✅ 正确！
总计: €738.00
```

**混合税率**：
```
产品1: iPhone 14 (23%)
产品2: iPhone 12 (Margin)
小计: €835.00
VAT (混合税率): €151.21  ✅ 正确！
⚠️ 包含Margin VAT产品，VAT为估算值
总计 (估算): €986.21
```

## 常见问题

### Q1: 为什么Margin VAT是估算值？

**A**: 在确认对话框阶段，我们还没有完成调货，无法获取准确的成本价来计算差价。因此使用简化估算：
- 假设差价约为售价的30%
- 实际VAT在调货完成时准确计算

### Q2: 估算值准确吗？

**A**: 估算值仅供参考，实际金额可能有差异：
- 如果实际差价高于30%，VAT会更高
- 如果实际差价低于30%，VAT会更低
- 完成调货后会生成准确的Invoice

### Q3: 为什么要显示税务分类？

**A**: 让用户清楚了解：
- 每个产品使用什么税率
- VAT是如何计算的
- 哪些是估算值，哪些是准确值

### Q4: 内部调拨为什么不显示税务？

**A**: 内部调拨不涉及销售：
- 使用成本价转移
- 不产生销售记录
- 不需要计算VAT

## 技术说明

### 税务分类颜色

- **VAT 23%**: 蓝色 (#3b82f6)
- **Margin VAT**: 橙色 (#f59e0b)
- **VAT 13.5%**: 紫色 (#6366f1)
- **VAT 0%**: 绿色 (#10b981)

### VAT计算公式

**VAT 23%**:
```javascript
VAT = subtotal × 0.23
```

**Margin VAT (估算)**:
```javascript
estimatedMargin = subtotal × 0.3
VAT = estimatedMargin × 0.23 / 1.23
```

**VAT 13.5%**:
```javascript
VAT = subtotal × 0.135
```

**VAT 0%**:
```javascript
VAT = 0
```

## 相关文档

- `FIX_TRANSFER_CONFIRMATION_TAX_DISPLAY.md` - 详细修复说明
- `FIX_INVOICE_TAX_CLASSIFICATION_USAGE.md` - Invoice税务分类
- `TRANSFER_PDF_INVOICE_FORMAT.md` - Invoice PDF格式

---
**测试日期**: 2026-02-05
**状态**: ✅ 准备测试
**服务器**: http://localhost:3000
